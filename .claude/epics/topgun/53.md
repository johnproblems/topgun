---
name: Implement ApiOrganizationScope middleware
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:39:08Z
github: https://github.com/johnproblems/topgun/issues/161
depends_on: [52]
parallel: false
conflicts_with: []
---

# Task: Implement ApiOrganizationScope middleware

## Description

Create a robust Laravel middleware that automatically scopes all API requests to the authenticated user's current organization context, preventing cross-tenant data access and ensuring complete data isolation in the multi-tenant Coolify Enterprise environment. This middleware is a critical security component that enforces organization boundaries at the HTTP layer, working in conjunction with Sanctum token organization context (Task 52).

**Why this is critical:** In a multi-tenant system, organization scoping must be enforced at every layer. Without this middleware, a compromised or misconfigured API token could potentially access data from other organizations, creating a catastrophic security vulnerability. This middleware provides defense-in-depth by ensuring that even if application code forgets to scope queries, the organization context is always enforced at the request level.

The middleware performs the following functions:

1. **Organization Context Extraction** - Reads organization ID from Sanctum token, request header, or subdomain
2. **Organization Loading** - Retrieves and caches the organization model for the current request
3. **Global Scope Application** - Sets organization context for Eloquent global scopes across all models
4. **Request Validation** - Ensures organization ID in route parameters matches token organization
5. **Error Handling** - Returns appropriate 403 responses for organization mismatch or missing context
6. **Performance Optimization** - Implements caching to minimize database queries
7. **Audit Logging** - Records organization context for security auditing and debugging

**Integration with existing Coolify architecture:**
- Works seamlessly with existing `organizationId` middleware pattern
- Extends Laravel Sanctum authentication (already in use)
- Integrates with existing Organization model and relationships
- Compatible with existing Livewire components that use organization context
- Supports both API (Sanctum) and web (session) authentication

**Key features:**
- Automatic organization scoping for all API requests
- Multiple organization detection methods (token, header, subdomain)
- Protection against organization parameter tampering
- Request lifecycle organization context management
- Comprehensive error responses with security-appropriate messages
- Performance-optimized with minimal overhead (< 5ms per request)

## Acceptance Criteria

- [ ] Middleware created in `app/Http/Middleware/ApiOrganizationScope.php`
- [ ] Middleware automatically extracts organization ID from Sanctum token
- [ ] Middleware supports organization ID extraction from `X-Organization-ID` header (optional fallback)
- [ ] Middleware validates organization ID in route parameters matches token organization
- [ ] Middleware sets organization context in shared container for request lifecycle
- [ ] Middleware returns 403 Forbidden for organization mismatch scenarios
- [ ] Middleware returns 400 Bad Request when organization context cannot be determined
- [ ] Middleware integrates with Eloquent global scopes for automatic query scoping
- [ ] Middleware handles unauthenticated requests gracefully (delegates to auth middleware)
- [ ] Middleware caches organization models to minimize database queries
- [ ] Middleware logs organization context changes for security auditing
- [ ] Performance overhead is < 5ms per request (measured with profiling)
- [ ] Middleware registered in `app/Http/Kernel.php` for API routes
- [ ] Middleware bypasses for public API endpoints (health check, status)
- [ ] Comprehensive error messages without leaking sensitive information

## Technical Details

### File Paths

**Middleware:**
- `/home/topgun/topgun/app/Http/Middleware/ApiOrganizationScope.php` (new)

**Kernel Registration:**
- `/home/topgun/topgun/app/Http/Kernel.php` (modify - add middleware to API group)

**Helper/Utility:**
- `/home/topgun/topgun/app/Support/OrganizationContext.php` (new - organization context manager)

**Models:**
- `/home/topgun/topgun/app/Models/Organization.php` (existing - reference for relationships)
- `/home/topgun/topgun/app/Models/User.php` (existing - organization relationships)

**Tests:**
- `/home/topgun/topgun/tests/Unit/Middleware/ApiOrganizationScopeTest.php` (new)
- `/home/topgun/topgun/tests/Feature/Api/OrganizationScopingTest.php` (new)

### Middleware Implementation

**File:** `app/Http/Middleware/ApiOrganizationScope.php`

```php
<?php

namespace App\Http\Middleware;

use App\Models\Organization;
use App\Support\OrganizationContext;
use Closure;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\Log;
use Symfony\Component\HttpFoundation\Response;

class ApiOrganizationScope
{
    public function __construct(
        private OrganizationContext $organizationContext
    ) {}

    /**
     * Handle an incoming request and set organization scope
     *
     * @param Request $request
     * @param Closure $next
     * @return Response
     */
    public function handle(Request $request, Closure $next): Response
    {
        // Skip for unauthenticated requests (let auth middleware handle)
        if (!$request->user()) {
            return $next($request);
        }

        // Extract organization ID from multiple sources
        $organizationId = $this->extractOrganizationId($request);

        if (!$organizationId) {
            Log::warning('API request without organization context', [
                'user_id' => $request->user()->id,
                'path' => $request->path(),
                'method' => $request->method(),
            ]);

            return response()->json([
                'error' => 'Organization context required',
                'message' => 'This request requires an organization context. Ensure your API token includes organization scope.',
            ], 400);
        }

        // Load organization with caching
        $organization = $this->loadOrganization($organizationId);

        if (!$organization) {
            Log::error('Organization not found for API request', [
                'organization_id' => $organizationId,
                'user_id' => $request->user()->id,
            ]);

            return response()->json([
                'error' => 'Organization not found',
                'message' => 'The specified organization does not exist or has been deleted.',
            ], 404);
        }

        // Verify user has access to this organization
        if (!$this->userCanAccessOrganization($request->user(), $organization)) {
            Log::warning('Unauthorized organization access attempt', [
                'user_id' => $request->user()->id,
                'organization_id' => $organization->id,
                'path' => $request->path(),
            ]);

            return response()->json([
                'error' => 'Forbidden',
                'message' => 'You do not have permission to access this organization.',
            ], 403);
        }

        // Validate route parameter organization matches token organization
        if ($request->route('organization')) {
            $routeOrgId = $request->route('organization') instanceof Organization
                ? $request->route('organization')->id
                : $request->route('organization');

            if ($routeOrgId != $organization->id) {
                Log::warning('Organization ID mismatch in API request', [
                    'token_org_id' => $organization->id,
                    'route_org_id' => $routeOrgId,
                    'user_id' => $request->user()->id,
                ]);

                return response()->json([
                    'error' => 'Organization mismatch',
                    'message' => 'The organization in the request does not match your token scope.',
                ], 403);
            }
        }

        // Set organization context for request lifecycle
        $this->organizationContext->set($organization);

        // Add organization to request attributes for easy access
        $request->attributes->set('organization', $organization);

        // Add organization ID header to response
        $response = $next($request);

        if ($response instanceof Response) {
            $response->headers->set('X-Organization-ID', (string) $organization->id);
        }

        return $response;
    }

    /**
     * Extract organization ID from various sources
     *
     * Priority: Sanctum token > X-Organization-ID header > subdomain
     *
     * @param Request $request
     * @return int|null
     */
    private function extractOrganizationId(Request $request): ?int
    {
        // 1. From Sanctum token (highest priority)
        $token = $request->user()->currentAccessToken();

        if ($token && isset($token->organization_id)) {
            return (int) $token->organization_id;
        }

        // 2. From custom header (for organization switching)
        if ($request->hasHeader('X-Organization-ID')) {
            $headerOrgId = $request->header('X-Organization-ID');

            if (is_numeric($headerOrgId)) {
                return (int) $headerOrgId;
            }
        }

        // 3. From user's default organization (fallback)
        if ($request->user()->default_organization_id) {
            return $request->user()->default_organization_id;
        }

        // 4. From user's first organization (last resort)
        $firstOrg = $request->user()->organizations()->first();

        if ($firstOrg) {
            return $firstOrg->id;
        }

        return null;
    }

    /**
     * Load organization with caching
     *
     * @param int $organizationId
     * @return Organization|null
     */
    private function loadOrganization(int $organizationId): ?Organization
    {
        $cacheKey = "organization:{$organizationId}";

        return Cache::remember($cacheKey, now()->addMinutes(10), function () use ($organizationId) {
            return Organization::with(['parent', 'whiteLabelConfig'])->find($organizationId);
        });
    }

    /**
     * Verify user has access to organization
     *
     * @param \App\Models\User $user
     * @param Organization $organization
     * @return bool
     */
    private function userCanAccessOrganization($user, Organization $organization): bool
    {
        // Check if user is directly attached to organization
        if ($user->organizations()->where('organizations.id', $organization->id)->exists()) {
            return true;
        }

        // Check if user is attached to parent organization (hierarchical access)
        if ($organization->parent_id) {
            $parentOrg = $this->loadOrganization($organization->parent_id);

            if ($parentOrg && $user->organizations()->where('organizations.id', $parentOrg->id)->exists()) {
                return true;
            }
        }

        return false;
    }

    /**
     * Terminate middleware (cleanup after response sent)
     *
     * @param Request $request
     * @param Response $response
     * @return void
     */
    public function terminate(Request $request, Response $response): void
    {
        // Clear organization context after request
        $this->organizationContext->clear();
    }
}
```

### Organization Context Manager

**File:** `app/Support/OrganizationContext.php`

```php
<?php

namespace App\Support;

use App\Models\Organization;

/**
 * Manages organization context throughout request lifecycle
 */
class OrganizationContext
{
    private ?Organization $currentOrganization = null;

    /**
     * Set current organization context
     *
     * @param Organization $organization
     * @return void
     */
    public function set(Organization $organization): void
    {
        $this->currentOrganization = $organization;

        // Set for Eloquent global scopes (if using scope pattern)
        Organization::setCurrentOrganization($organization);
    }

    /**
     * Get current organization
     *
     * @return Organization|null
     */
    public function get(): ?Organization
    {
        return $this->currentOrganization;
    }

    /**
     * Get current organization ID
     *
     * @return int|null
     */
    public function getId(): ?int
    {
        return $this->currentOrganization?->id;
    }

    /**
     * Check if organization context is set
     *
     * @return bool
     */
    public function has(): bool
    {
        return $this->currentOrganization !== null;
    }

    /**
     * Clear organization context
     *
     * @return void
     */
    public function clear(): void
    {
        $this->currentOrganization = null;

        // Clear Eloquent global scope context
        Organization::clearCurrentOrganization();
    }

    /**
     * Execute callback with specific organization context
     *
     * @param Organization $organization
     * @param callable $callback
     * @return mixed
     */
    public function withOrganization(Organization $organization, callable $callback): mixed
    {
        $previous = $this->currentOrganization;

        try {
            $this->set($organization);

            return $callback($organization);
        } finally {
            if ($previous) {
                $this->set($previous);
            } else {
                $this->clear();
            }
        }
    }
}
```

### Kernel Registration

**File:** `app/Http/Kernel.php` (modification)

```php
<?php

namespace App\Http;

use Illuminate\Foundation\Http\Kernel as HttpKernel;

class Kernel extends HttpKernel
{
    /**
     * The application's route middleware groups.
     *
     * @var array<string, array<int, class-string|string>>
     */
    protected $middlewareGroups = [
        'api' => [
            \Laravel\Sanctum\Http\Middleware\EnsureFrontendRequestsAreStateful::class,
            \Illuminate\Routing\Middleware\ThrottleRequests::class.':api',
            \Illuminate\Routing\Middleware\SubstituteBindings::class,
            \App\Http\Middleware\ApiOrganizationScope::class, // Add here
        ],
    ];

    /**
     * The application's route middleware.
     *
     * @var array<string, class-string|string>
     */
    protected $routeMiddleware = [
        // Existing middleware...
        'api.organization.scope' => \App\Http\Middleware\ApiOrganizationScope::class,
    ];
}
```

### Organization Model Enhancement

**File:** `app/Models/Organization.php` (modification)

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Database\Eloquent\Relations\BelongsToMany;

class Organization extends Model
{
    private static ?Organization $currentOrganization = null;

    /**
     * Set current organization for global scoping
     *
     * @param Organization $organization
     * @return void
     */
    public static function setCurrentOrganization(Organization $organization): void
    {
        self::$currentOrganization = $organization;
    }

    /**
     * Get current organization context
     *
     * @return Organization|null
     */
    public static function getCurrentOrganization(): ?Organization
    {
        return self::$currentOrganization;
    }

    /**
     * Clear current organization context
     *
     * @return void
     */
    public static function clearCurrentOrganization(): void
    {
        self::$currentOrganization = null;
    }

    /**
     * Check if organization context is set
     *
     * @return bool
     */
    public static function hasCurrentOrganization(): bool
    {
        return self::$currentOrganization !== null;
    }

    // Existing relationships...
    public function parent(): BelongsTo
    {
        return $this->belongsTo(Organization::class, 'parent_organization_id');
    }

    public function children(): HasMany
    {
        return $this->hasMany(Organization::class, 'parent_organization_id');
    }

    public function users(): BelongsToMany
    {
        return $this->belongsToMany(User::class, 'organization_users')
            ->withPivot(['role', 'permissions'])
            ->withTimestamps();
    }

    public function whiteLabelConfig(): \Illuminate\Database\Eloquent\Relations\HasOne
    {
        return $this->hasOne(WhiteLabelConfig::class);
    }
}
```

### Service Provider Registration

**File:** `app/Providers/AppServiceProvider.php` (modification)

```php
public function register(): void
{
    // Register OrganizationContext as singleton
    $this->app->singleton(\App\Support\OrganizationContext::class);
}
```

### Helper Function

**File:** `bootstrap/helpers/organization.php` (new)

```php
<?php

use App\Models\Organization;
use App\Support\OrganizationContext;

if (!function_exists('current_organization')) {
    /**
     * Get current organization from context
     *
     * @return Organization|null
     */
    function current_organization(): ?Organization
    {
        return app(OrganizationContext::class)->get();
    }
}

if (!function_exists('current_organization_id')) {
    /**
     * Get current organization ID from context
     *
     * @return int|null
     */
    function current_organization_id(): ?int
    {
        return app(OrganizationContext::class)->getId();
    }
}

if (!function_exists('with_organization')) {
    /**
     * Execute callback with specific organization context
     *
     * @param Organization $organization
     * @param callable $callback
     * @return mixed
     */
    function with_organization(Organization $organization, callable $callback): mixed
    {
        return app(OrganizationContext::class)->withOrganization($organization, $callback);
    }
}
```

### Example Usage in Controllers

```php
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Models\Application;
use Illuminate\Http\JsonResponse;

class ApplicationController extends Controller
{
    /**
     * List applications for current organization
     *
     * @return JsonResponse
     */
    public function index(): JsonResponse
    {
        // Organization context automatically available
        $organization = current_organization();

        // All queries automatically scoped if using global scopes
        $applications = Application::where('organization_id', $organization->id)
            ->with(['servers', 'environment'])
            ->paginate(20);

        return response()->json([
            'data' => $applications,
            'organization' => [
                'id' => $organization->id,
                'name' => $organization->name,
            ],
        ]);
    }

    /**
     * Show specific application
     *
     * @param Application $application
     * @return JsonResponse
     */
    public function show(Application $application): JsonResponse
    {
        // Middleware already validated organization context
        // Application belongs to current organization
        return response()->json([
            'data' => $application->load(['servers', 'deployments']),
        ]);
    }
}
```

## Implementation Approach

### Step 1: Create OrganizationContext Manager
1. Create `app/Support/OrganizationContext.php` singleton
2. Implement `set()`, `get()`, `clear()`, `withOrganization()` methods
3. Add static methods to Organization model for global scope integration
4. Register as singleton in AppServiceProvider

### Step 2: Create Middleware
1. Create `app/Http/Middleware/ApiOrganizationScope.php`
2. Implement `handle()` method with organization extraction logic
3. Add validation for route parameter organization matching
4. Implement caching for organization loading
5. Add comprehensive error responses

### Step 3: Register Middleware
1. Add to `api` middleware group in `app/Http/Kernel.php`
2. Add as named middleware for selective application
3. Update API route definitions if needed

### Step 4: Enhance Organization Model
1. Add static methods for organization context management
2. Ensure relationships are properly defined
3. Add caching for organization queries

### Step 5: Create Helper Functions
1. Create `bootstrap/helpers/organization.php` with helper functions
2. Register in composer autoload if not already
3. Document helper function usage

### Step 6: Update API Routes
1. Review existing API routes for organization dependencies
2. Add middleware to route groups or individual routes
3. Test with organization-scoped requests

### Step 7: Add Error Handling
1. Customize error responses for production vs development
2. Add logging for security events
3. Implement rate limiting for failed organization access attempts

### Step 8: Testing
1. Write unit tests for middleware logic
2. Write integration tests for API requests
3. Test organization mismatch scenarios
4. Test caching behavior
5. Performance benchmark with profiling

## Test Strategy

### Unit Tests

**File:** `tests/Unit/Middleware/ApiOrganizationScopeTest.php`

```php
<?php

use App\Http\Middleware\ApiOrganizationScope;
use App\Models\Organization;
use App\Models\User;
use App\Support\OrganizationContext;
use Illuminate\Http\Request;
use Laravel\Sanctum\PersonalAccessToken;

beforeEach(function () {
    $this->middleware = new ApiOrganizationScope(new OrganizationContext());
});

it('extracts organization ID from Sanctum token', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $user->organizations()->attach($organization, ['role' => 'admin']);

    $token = PersonalAccessToken::factory()->create([
        'tokenable_id' => $user->id,
        'tokenable_type' => User::class,
        'organization_id' => $organization->id,
    ]);

    $request = Request::create('/api/applications', 'GET');
    $request->setUserResolver(fn() => $user);

    $this->actingAs($user, 'sanctum');

    $response = $this->middleware->handle($request, fn($req) => response()->json(['success' => true]));

    expect($response->status())->toBe(200);
    expect(current_organization()->id)->toBe($organization->id);
});

it('returns 403 when user does not have access to organization', function () {
    $organization1 = Organization::factory()->create();
    $organization2 = Organization::factory()->create();

    $user = User::factory()->create();
    $user->organizations()->attach($organization1, ['role' => 'admin']);

    $token = PersonalAccessToken::factory()->create([
        'tokenable_id' => $user->id,
        'tokenable_type' => User::class,
        'organization_id' => $organization2->id, // Different organization
    ]);

    $request = Request::create('/api/applications', 'GET');
    $request->setUserResolver(fn() => $user);

    $response = $this->middleware->handle($request, fn($req) => response()->json(['success' => true]));

    expect($response->status())->toBe(403);
    expect($response->getData()->error)->toBe('Forbidden');
});

it('validates route parameter organization matches token organization', function () {
    $organization1 = Organization::factory()->create();
    $organization2 = Organization::factory()->create();

    $user = User::factory()->create();
    $user->organizations()->attach($organization1, ['role' => 'admin']);

    $token = PersonalAccessToken::factory()->create([
        'tokenable_id' => $user->id,
        'tokenable_type' => User::class,
        'organization_id' => $organization1->id,
    ]);

    $request = Request::create("/api/organizations/{$organization2->id}/applications", 'GET');
    $request->setRouteResolver(fn() => new \Illuminate\Routing\Route('GET', '', []));
    $request->route()->setParameter('organization', $organization2);
    $request->setUserResolver(fn() => $user);

    $response = $this->middleware->handle($request, fn($req) => response()->json(['success' => true]));

    expect($response->status())->toBe(403);
    expect($response->getData()->error)->toBe('Organization mismatch');
});

it('returns 400 when organization context cannot be determined', function () {
    $user = User::factory()->create();
    // User has no organizations

    $request = Request::create('/api/applications', 'GET');
    $request->setUserResolver(fn() => $user);

    $response = $this->middleware->handle($request, fn($req) => response()->json(['success' => true]));

    expect($response->status())->toBe(400);
    expect($response->getData()->error)->toBe('Organization context required');
});

it('caches organization to minimize database queries', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $user->organizations()->attach($organization, ['role' => 'admin']);

    $token = PersonalAccessToken::factory()->create([
        'tokenable_id' => $user->id,
        'tokenable_type' => User::class,
        'organization_id' => $organization->id,
    ]);

    $request1 = Request::create('/api/applications', 'GET');
    $request1->setUserResolver(fn() => $user);

    $request2 = Request::create('/api/servers', 'GET');
    $request2->setUserResolver(fn() => $user);

    \DB::enableQueryLog();

    $this->middleware->handle($request1, fn($req) => response()->json([]));
    $queryCount1 = count(\DB::getQueryLog());

    \DB::flushQueryLog();

    $this->middleware->handle($request2, fn($req) => response()->json([]));
    $queryCount2 = count(\DB::getQueryLog());

    // Second request should use cached organization
    expect($queryCount2)->toBeLessThan($queryCount1);
});

it('clears organization context in terminate method', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $user->organizations()->attach($organization, ['role' => 'admin']);

    $context = app(OrganizationContext::class);
    $context->set($organization);

    expect($context->has())->toBeTrue();

    $request = Request::create('/api/applications', 'GET');
    $response = response()->json([]);

    $this->middleware->terminate($request, $response);

    expect($context->has())->toBeFalse();
});
```

### Integration Tests

**File:** `tests/Feature/Api/OrganizationScopingTest.php`

```php
<?php

use App\Models\Application;
use App\Models\Organization;
use App\Models\User;
use Laravel\Sanctum\Sanctum;

it('scopes API requests to organization from token', function () {
    $organization1 = Organization::factory()->create();
    $organization2 = Organization::factory()->create();

    $user = User::factory()->create();
    $user->organizations()->attach($organization1, ['role' => 'admin']);

    Application::factory()->count(3)->create(['organization_id' => $organization1->id]);
    Application::factory()->count(2)->create(['organization_id' => $organization2->id]);

    $token = $user->createToken('test', ['*'], $organization1->id);

    $response = $this->withToken($token->plainTextToken)
        ->getJson('/api/applications');

    $response->assertOk()
        ->assertJsonCount(3, 'data');
});

it('returns organization ID in response header', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $user->organizations()->attach($organization, ['role' => 'admin']);

    $token = $user->createToken('test', ['*'], $organization->id);

    $response = $this->withToken($token->plainTextToken)
        ->getJson('/api/applications');

    $response->assertOk()
        ->assertHeader('X-Organization-ID', (string) $organization->id);
});

it('prevents cross-organization access via route parameter tampering', function () {
    $organization1 = Organization::factory()->create();
    $organization2 = Organization::factory()->create();

    $user = User::factory()->create();
    $user->organizations()->attach($organization1, ['role' => 'admin']);

    $application = Application::factory()->create(['organization_id' => $organization2->id]);

    $token = $user->createToken('test', ['*'], $organization1->id);

    $response = $this->withToken($token->plainTextToken)
        ->getJson("/api/organizations/{$organization2->id}/applications");

    $response->assertForbidden()
        ->assertJson(['error' => 'Organization mismatch']);
});

it('allows hierarchical organization access', function () {
    $parentOrg = Organization::factory()->create();
    $childOrg = Organization::factory()->create(['parent_organization_id' => $parentOrg->id]);

    $user = User::factory()->create();
    $user->organizations()->attach($parentOrg, ['role' => 'admin']);

    Application::factory()->create(['organization_id' => $childOrg->id]);

    $token = $user->createToken('test', ['*'], $parentOrg->id);

    $response = $this->withToken($token->plainTextToken)
        ->getJson("/api/organizations/{$childOrg->id}/applications");

    $response->assertOk();
});

it('supports organization switching via X-Organization-ID header', function () {
    $organization1 = Organization::factory()->create();
    $organization2 = Organization::factory()->create();

    $user = User::factory()->create();
    $user->organizations()->attach($organization1, ['role' => 'admin']);
    $user->organizations()->attach($organization2, ['role' => 'member']);

    Application::factory()->count(2)->create(['organization_id' => $organization1->id]);
    Application::factory()->count(3)->create(['organization_id' => $organization2->id]);

    Sanctum::actingAs($user);

    $response = $this->withHeaders(['X-Organization-ID' => $organization2->id])
        ->getJson('/api/applications');

    $response->assertOk()
        ->assertJsonCount(3, 'data');
});
```

### Performance Tests

```php
it('has minimal performance overhead', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $user->organizations()->attach($organization, ['role' => 'admin']);

    $token = $user->createToken('test', ['*'], $organization->id);

    $startTime = microtime(true);

    for ($i = 0; $i < 100; $i++) {
        $this->withToken($token->plainTextToken)
            ->getJson('/api/applications');
    }

    $endTime = microtime(true);
    $avgTime = ($endTime - $startTime) / 100 * 1000; // Convert to milliseconds

    expect($avgTime)->toBeLessThan(200); // Average request < 200ms (including middleware overhead)
});
```

## Definition of Done

- [ ] ApiOrganizationScope middleware created in `app/Http/Middleware/`
- [ ] OrganizationContext manager created in `app/Support/`
- [ ] Middleware registered in `app/Http/Kernel.php` API middleware group
- [ ] Organization model enhanced with static context methods
- [ ] Helper functions created for organization context access
- [ ] Middleware extracts organization from Sanctum token correctly
- [ ] Middleware supports X-Organization-ID header for organization switching
- [ ] Middleware validates route parameter organization matches token
- [ ] Middleware returns appropriate error responses (400, 403, 404)
- [ ] Middleware implements caching for organization lookups
- [ ] Middleware logs security events (unauthorized access, mismatches)
- [ ] Middleware sets organization context in shared container
- [ ] Middleware clears context in terminate method
- [ ] Performance overhead measured at < 5ms per request
- [ ] Unit tests written and passing (>90% coverage)
- [ ] Integration tests written for all scenarios
- [ ] Performance benchmarks completed
- [ ] Code follows Laravel 12 and Coolify standards
- [ ] Laravel Pint formatting applied (`./vendor/bin/pint`)
- [ ] PHPStan level 5 passing with zero errors
- [ ] Documentation added (PHPDoc blocks, inline comments)
- [ ] Manual testing completed with various organization scenarios
- [ ] Code reviewed and approved

## Related Tasks

- **Depends on:** Task 52 (Extend Laravel Sanctum tokens with organization context)
- **Enables:** Task 54 (Tiered rate limiting middleware - uses organization context)
- **Enables:** Task 56 (Enterprise API endpoints - rely on organization scoping)
- **Integrates with:** Task 61 (API tests - validate organization scoping)
- **Used by:** All API endpoints that require organization context
