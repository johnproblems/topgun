---
name: Add organization resource quota enforcement
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:38:47Z
github: https://github.com/johnproblems/topgun/issues/138
depends_on: [26]
parallel: false
conflicts_with: []
---

# Task: Add organization resource quota enforcement

## Description

Implement real-time quota validation and enforcement system that prevents organizations from exceeding their licensed resource limits. This critical service ensures fair resource distribution across the multi-tenant platform, prevents resource abuse, and enforces the business model defined in enterprise license tiers.

**The Multi-Tenant Resource Challenge:**

In a multi-tenant platform like Coolify Enterprise, resource management is complex:
1. **Top Branch organizations** can provision unlimited infrastructure
2. **Master Branch organizations** have tier-based quotas (Starter: 5 servers, Pro: 20 servers, Enterprise: unlimited)
3. **Sub-Users** inherit parent quotas with optional sub-limits
4. **End Users** are restricted to specific resources assigned to them

Without quota enforcement, a single organization could monopolize server resources, degrading performance for all tenants. Worse, organizations could bypass licensing restrictions, undermining the business model and causing infrastructure cost overruns.

**The Solution:**

OrganizationQuotaService provides real-time quota validation at every resource operation checkpoint:
- **Before deployment**: Check CPU, memory, disk quotas
- **Before provisioning**: Validate server count, cloud spend limits
- **Before database creation**: Check database instance quotas
- **Before build**: Verify build queue capacity limits

The service integrates deeply with enterprise licensing (Task 1-2) to enforce feature flags and usage limits, ensuring technical controls match business agreements. It also integrates with capacity management (Task 26) to track current resource utilization and calculate available quota in real-time.

**Key Capabilities:**

1. **Hierarchical Quota Inheritance**: Sub-organizations inherit parent quotas with optional stricter limits
2. **Real-Time Validation**: Check quotas before resource-consuming operations
3. **Granular Resource Types**: Servers, applications, databases, build slots, storage, bandwidth
4. **License Integration**: Quota limits derived from EnterpriseLicense feature flags
5. **Usage Tracking**: Real-time consumption calculated from organization_resource_usage table
6. **Grace Periods**: Temporary quota overages allowed with warning notifications
7. **Quota Alerts**: Notify admins at 80%, 90%, 100% thresholds
8. **Audit Logging**: Record quota violations for compliance and debugging

**Integration Architecture:**

**Enforced By:**
- ApplicationDeploymentJob → Check CPU/memory quotas before deployment
- TerraformDeploymentJob → Check server count quotas before provisioning
- CreateDatabaseAction → Check database quotas before creation
- ServerController::store() → Check server quotas on manual addition

**Integrates With:**
- **Task 26 (CapacityManager)**: Query current resource usage for quota calculation
- **EnterpriseLicense (Tasks 1-2)**: Retrieve quota limits from license feature flags
- **SystemResourceMonitor (Task 25)**: Real-time resource consumption data
- **NotificationService**: Alert admins when quotas are approaching limits

**Why This Task is Critical:**

Quota enforcement is the technical manifestation of the business model. Without it:
- **Revenue leakage**: Organizations use more resources than they pay for
- **Infrastructure overruns**: Unconstrained resource consumption causes cost explosions
- **Platform instability**: Resource monopolization degrades performance for all tenants
- **Compliance violations**: SLA guarantees become impossible without quota controls

Effective quota enforcement ensures sustainable operations, fair resource distribution, predictable costs, and alignment between technical reality and business agreements. It's the difference between a platform that scales profitably and one that collapses under its own success.

## Acceptance Criteria

- [ ] OrganizationQuotaService created with comprehensive quota validation methods
- [ ] Validates server count quotas against EnterpriseLicense limits
- [ ] Validates CPU/memory quotas for deployment operations
- [ ] Validates storage quotas (disk space) for applications and databases
- [ ] Validates build slot quotas (concurrent build limit)
- [ ] Validates bandwidth quotas (monthly transfer limits)
- [ ] Validates database instance quotas (PostgreSQL, MySQL, MongoDB, Redis counts)
- [ ] Hierarchical quota inheritance from parent organizations
- [ ] Real-time quota calculation using organization_resource_usage table
- [ ] Grace period support (allow temporary overages with warnings)
- [ ] Quota threshold alerts at 80%, 90%, 100% usage
- [ ] Integration with EnterpriseLicense for quota limit retrieval
- [ ] Integration with CapacityManager for current usage data
- [ ] Middleware for API endpoints to enforce quotas before resource operations
- [ ] Artisan command to recalculate quotas: `php artisan quotas:recalculate {organization?}`
- [ ] Quota violation audit logging for compliance
- [ ] User-friendly error messages when quotas are exceeded
- [ ] Dashboard integration showing quota usage and limits

## Technical Details

### File Paths

**Service Layer:**
- `/home/topgun/topgun/app/Services/Enterprise/OrganizationQuotaService.php` (new)
- `/home/topgun/topgun/app/Contracts/OrganizationQuotaServiceInterface.php` (new)

**Middleware:**
- `/home/topgun/topgun/app/Http/Middleware/EnforceResourceQuotas.php` (new)

**Actions:**
- `/home/topgun/topgun/app/Actions/Enterprise/ValidateDeploymentQuota.php` (new)
- `/home/topgun/topgun/app/Actions/Enterprise/CalculateOrganizationUsage.php` (new)

**Artisan Commands:**
- `/home/topgun/topgun/app/Console/Commands/RecalculateQuotas.php` (new)

**Exceptions:**
- `/home/topgun/topgun/app/Exceptions/QuotaExceededException.php` (new)
- `/home/topgun/topgun/app/Exceptions/QuotaValidationException.php` (new)

**Models (enhancements):**
- `/home/topgun/topgun/app/Models/Organization.php` (add quota accessor methods)
- `/home/topgun/topgun/app/Models/Enterprise/EnterpriseLicense.php` (add quota limit accessors)

**Database:**
- `/home/topgun/topgun/database/migrations/2025_XX_XX_add_quota_tracking_to_resource_usage.php` (new)

### Database Schema Enhancement

Enhance `organization_resource_usage` table with quota tracking:

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::table('organization_resource_usage', function (Blueprint $table) {
            // Current usage counters (existing columns enhanced)
            $table->integer('server_count')->default(0)->after('organization_id');
            $table->integer('application_count')->default(0);
            $table->integer('database_count')->default(0);
            $table->integer('active_build_slots')->default(0);

            // Resource consumption metrics
            $table->decimal('total_cpu_cores', 10, 2)->default(0)->comment('Total allocated CPU cores');
            $table->decimal('total_memory_gb', 10, 2)->default(0)->comment('Total allocated memory in GB');
            $table->decimal('total_storage_gb', 10, 2)->default(0)->comment('Total allocated storage in GB');
            $table->decimal('bandwidth_gb_month', 12, 2)->default(0)->comment('Bandwidth usage this month in GB');

            // License-derived quota limits (denormalized for performance)
            $table->integer('quota_servers')->nullable()->comment('Server count limit from license');
            $table->integer('quota_applications')->nullable();
            $table->integer('quota_databases')->nullable();
            $table->integer('quota_build_slots')->nullable();
            $table->decimal('quota_cpu_cores', 10, 2)->nullable();
            $table->decimal('quota_memory_gb', 10, 2)->nullable();
            $table->decimal('quota_storage_gb', 10, 2)->nullable();
            $table->decimal('quota_bandwidth_gb_month', 12, 2)->nullable();

            // Quota enforcement metadata
            $table->timestamp('last_calculated_at')->nullable()->comment('Last quota calculation timestamp');
            $table->timestamp('quota_exceeded_at')->nullable()->comment('Timestamp when quota was first exceeded');
            $table->json('quota_violations')->nullable()->comment('Array of current quota violations');
            $table->boolean('grace_period_active')->default(false);
            $table->timestamp('grace_period_expires_at')->nullable();

            // Indexes for performance
            $table->index(['organization_id', 'last_calculated_at']);
            $table->index(['quota_exceeded_at']);
            $table->index(['grace_period_active', 'grace_period_expires_at']);
        });

        // Add quota tracking to organizations table
        Schema::table('organizations', function (Blueprint $table) {
            $table->boolean('quota_enforcement_enabled')->default(true)->after('parent_id');
            $table->json('quota_overrides')->nullable()->comment('Admin-defined quota overrides');
        });
    }

    public function down(): void
    {
        Schema::table('organization_resource_usage', function (Blueprint $table) {
            $table->dropColumn([
                'server_count',
                'application_count',
                'database_count',
                'active_build_slots',
                'total_cpu_cores',
                'total_memory_gb',
                'total_storage_gb',
                'bandwidth_gb_month',
                'quota_servers',
                'quota_applications',
                'quota_databases',
                'quota_build_slots',
                'quota_cpu_cores',
                'quota_memory_gb',
                'quota_storage_gb',
                'quota_bandwidth_gb_month',
                'last_calculated_at',
                'quota_exceeded_at',
                'quota_violations',
                'grace_period_active',
                'grace_period_expires_at',
            ]);
        });

        Schema::table('organizations', function (Blueprint $table) {
            $table->dropColumn(['quota_enforcement_enabled', 'quota_overrides']);
        });
    }
};
```

### OrganizationQuotaService Implementation

**File:** `app/Services/Enterprise/OrganizationQuotaService.php`

```php
<?php

namespace App\Services\Enterprise;

use App\Contracts\OrganizationQuotaServiceInterface;
use App\Exceptions\QuotaExceededException;
use App\Models\Organization;
use App\Models\OrganizationResourceUsage;
use App\Models\EnterpriseLicense;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Cache;

class OrganizationQuotaService implements OrganizationQuotaServiceInterface
{
    private const CACHE_TTL = 300; // 5 minutes
    private const GRACE_PERIOD_DAYS = 7;

    /**
     * Validate server quota before adding new server
     *
     * @param Organization $organization
     * @param int $additionalServers Number of servers to add
     * @return void
     * @throws QuotaExceededException
     */
    public function validateServerQuota(Organization $organization, int $additionalServers = 1): void
    {
        if (!$this->isQuotaEnforcementEnabled($organization)) {
            return;
        }

        $usage = $this->getOrganizationUsage($organization);
        $limits = $this->getOrganizationQuotaLimits($organization);

        $currentCount = $usage->server_count ?? 0;
        $quotaLimit = $limits['servers'] ?? PHP_INT_MAX;

        if ($currentCount + $additionalServers > $quotaLimit) {
            if (!$this->isGracePeriodActive($usage)) {
                throw QuotaExceededException::servers(
                    $currentCount,
                    $quotaLimit,
                    $organization
                );
            }

            // Grace period active - log warning
            Log::warning('Server quota exceeded but grace period active', [
                'organization_id' => $organization->id,
                'current' => $currentCount,
                'limit' => $quotaLimit,
                'grace_period_expires' => $usage->grace_period_expires_at,
            ]);
        }
    }

    /**
     * Validate deployment resource quotas (CPU, memory)
     *
     * @param Organization $organization
     * @param float $cpuCores
     * @param float $memoryGb
     * @return void
     * @throws QuotaExceededException
     */
    public function validateDeploymentQuota(
        Organization $organization,
        float $cpuCores,
        float $memoryGb
    ): void {
        if (!$this->isQuotaEnforcementEnabled($organization)) {
            return;
        }

        $usage = $this->getOrganizationUsage($organization);
        $limits = $this->getOrganizationQuotaLimits($organization);

        // CPU validation
        $currentCpu = $usage->total_cpu_cores ?? 0;
        $cpuLimit = $limits['cpu_cores'] ?? PHP_INT_MAX;

        if ($currentCpu + $cpuCores > $cpuLimit) {
            if (!$this->isGracePeriodActive($usage)) {
                throw QuotaExceededException::cpu(
                    $currentCpu,
                    $cpuLimit,
                    $organization
                );
            }
        }

        // Memory validation
        $currentMemory = $usage->total_memory_gb ?? 0;
        $memoryLimit = $limits['memory_gb'] ?? PHP_INT_MAX;

        if ($currentMemory + $memoryGb > $memoryLimit) {
            if (!$this->isGracePeriodActive($usage)) {
                throw QuotaExceededException::memory(
                    $currentMemory,
                    $memoryLimit,
                    $organization
                );
            }
        }
    }

    /**
     * Validate storage quota
     *
     * @param Organization $organization
     * @param float $storageGb
     * @return void
     * @throws QuotaExceededException
     */
    public function validateStorageQuota(Organization $organization, float $storageGb): void
    {
        if (!$this->isQuotaEnforcementEnabled($organization)) {
            return;
        }

        $usage = $this->getOrganizationUsage($organization);
        $limits = $this->getOrganizationQuotaLimits($organization);

        $currentStorage = $usage->total_storage_gb ?? 0;
        $storageLimit = $limits['storage_gb'] ?? PHP_INT_MAX;

        if ($currentStorage + $storageGb > $storageLimit) {
            if (!$this->isGracePeriodActive($usage)) {
                throw QuotaExceededException::storage(
                    $currentStorage,
                    $storageLimit,
                    $organization
                );
            }
        }
    }

    /**
     * Validate database quota
     *
     * @param Organization $organization
     * @param int $additionalDatabases
     * @return void
     * @throws QuotaExceededException
     */
    public function validateDatabaseQuota(Organization $organization, int $additionalDatabases = 1): void
    {
        if (!$this->isQuotaEnforcementEnabled($organization)) {
            return;
        }

        $usage = $this->getOrganizationUsage($organization);
        $limits = $this->getOrganizationQuotaLimits($organization);

        $currentCount = $usage->database_count ?? 0;
        $quotaLimit = $limits['databases'] ?? PHP_INT_MAX;

        if ($currentCount + $additionalDatabases > $quotaLimit) {
            if (!$this->isGracePeriodActive($usage)) {
                throw QuotaExceededException::databases(
                    $currentCount,
                    $quotaLimit,
                    $organization
                );
            }
        }
    }

    /**
     * Validate build slot quota
     *
     * @param Organization $organization
     * @param int $additionalSlots
     * @return void
     * @throws QuotaExceededException
     */
    public function validateBuildSlotQuota(Organization $organization, int $additionalSlots = 1): void
    {
        if (!$this->isQuotaEnforcementEnabled($organization)) {
            return;
        }

        $usage = $this->getOrganizationUsage($organization);
        $limits = $this->getOrganizationQuotaLimits($organization);

        $currentSlots = $usage->active_build_slots ?? 0;
        $quotaLimit = $limits['build_slots'] ?? PHP_INT_MAX;

        if ($currentSlots + $additionalSlots > $quotaLimit) {
            throw QuotaExceededException::buildSlots(
                $currentSlots,
                $quotaLimit,
                $organization
            );
        }
    }

    /**
     * Get organization quota limits from license
     *
     * @param Organization $organization
     * @return array
     */
    public function getOrganizationQuotaLimits(Organization $organization): array
    {
        $cacheKey = "quota_limits:{$organization->id}";

        return Cache::remember($cacheKey, self::CACHE_TTL, function () use ($organization) {
            $license = $organization->enterpriseLicense;

            if (!$license) {
                // No license = default free tier quotas
                return $this->getDefaultQuotas();
            }

            // Check for admin overrides
            if ($organization->quota_overrides) {
                $overrides = json_decode($organization->quota_overrides, true);
                return array_merge($this->getLicenseQuotas($license), $overrides);
            }

            return $this->getLicenseQuotas($license);
        });
    }

    /**
     * Extract quota limits from enterprise license
     *
     * @param EnterpriseLicense $license
     * @return array
     */
    protected function getLicenseQuotas(EnterpriseLicense $license): array
    {
        $limits = $license->limits ?? [];

        return [
            'servers' => $limits['max_servers'] ?? 5,
            'applications' => $limits['max_applications'] ?? 10,
            'databases' => $limits['max_databases'] ?? 5,
            'build_slots' => $limits['max_concurrent_builds'] ?? 2,
            'cpu_cores' => $limits['max_cpu_cores'] ?? 8,
            'memory_gb' => $limits['max_memory_gb'] ?? 16,
            'storage_gb' => $limits['max_storage_gb'] ?? 100,
            'bandwidth_gb_month' => $limits['max_bandwidth_gb_month'] ?? 1000,
        ];
    }

    /**
     * Get default free tier quotas
     *
     * @return array
     */
    protected function getDefaultQuotas(): array
    {
        return [
            'servers' => 1,
            'applications' => 3,
            'databases' => 1,
            'build_slots' => 1,
            'cpu_cores' => 2,
            'memory_gb' => 4,
            'storage_gb' => 20,
            'bandwidth_gb_month' => 100,
        ];
    }

    /**
     * Calculate and update current resource usage
     *
     * @param Organization $organization
     * @return OrganizationResourceUsage
     */
    public function calculateCurrentUsage(Organization $organization): OrganizationResourceUsage
    {
        $usage = DB::transaction(function () use ($organization) {
            $usage = OrganizationResourceUsage::firstOrCreate(
                ['organization_id' => $organization->id]
            );

            // Count resources
            $usage->server_count = $organization->servers()->count();
            $usage->application_count = $organization->applications()->count();
            $usage->database_count = $organization->databases()->count();
            $usage->active_build_slots = $organization->activeBuilds()->count();

            // Calculate resource totals from servers
            $resourceTotals = $organization->servers()
                ->selectRaw('
                    SUM(cpu_cores) as total_cpu,
                    SUM(memory_gb) as total_memory,
                    SUM(storage_gb) as total_storage
                ')
                ->first();

            $usage->total_cpu_cores = $resourceTotals->total_cpu ?? 0;
            $usage->total_memory_gb = $resourceTotals->total_memory ?? 0;
            $usage->total_storage_gb = $resourceTotals->total_storage ?? 0;

            // Calculate bandwidth for current month
            $usage->bandwidth_gb_month = $this->calculateMonthlyBandwidth($organization);

            // Update quota limits from license
            $limits = $this->getOrganizationQuotaLimits($organization);
            $usage->quota_servers = $limits['servers'];
            $usage->quota_applications = $limits['applications'];
            $usage->quota_databases = $limits['databases'];
            $usage->quota_build_slots = $limits['build_slots'];
            $usage->quota_cpu_cores = $limits['cpu_cores'];
            $usage->quota_memory_gb = $limits['memory_gb'];
            $usage->quota_storage_gb = $limits['storage_gb'];
            $usage->quota_bandwidth_gb_month = $limits['bandwidth_gb_month'];

            // Check for violations
            $violations = $this->checkQuotaViolations($usage);
            $usage->quota_violations = $violations ? json_encode($violations) : null;

            if (count($violations) > 0 && !$usage->quota_exceeded_at) {
                $usage->quota_exceeded_at = now();
                $usage->grace_period_active = true;
                $usage->grace_period_expires_at = now()->addDays(self::GRACE_PERIOD_DAYS);
            }

            if (count($violations) === 0) {
                $usage->quota_exceeded_at = null;
                $usage->grace_period_active = false;
                $usage->grace_period_expires_at = null;
            }

            $usage->last_calculated_at = now();
            $usage->save();

            return $usage;
        });

        // Trigger alerts if needed
        $this->checkQuotaAlerts($organization, $usage);

        // Clear cache
        Cache::forget("organization_usage:{$organization->id}");

        return $usage;
    }

    /**
     * Check for quota violations
     *
     * @param OrganizationResourceUsage $usage
     * @return array
     */
    protected function checkQuotaViolations(OrganizationResourceUsage $usage): array
    {
        $violations = [];

        if ($usage->server_count > $usage->quota_servers) {
            $violations[] = [
                'type' => 'servers',
                'current' => $usage->server_count,
                'limit' => $usage->quota_servers,
                'overage' => $usage->server_count - $usage->quota_servers,
            ];
        }

        if ($usage->application_count > $usage->quota_applications) {
            $violations[] = [
                'type' => 'applications',
                'current' => $usage->application_count,
                'limit' => $usage->quota_applications,
                'overage' => $usage->application_count - $usage->quota_applications,
            ];
        }

        if ($usage->total_cpu_cores > $usage->quota_cpu_cores) {
            $violations[] = [
                'type' => 'cpu_cores',
                'current' => $usage->total_cpu_cores,
                'limit' => $usage->quota_cpu_cores,
                'overage' => $usage->total_cpu_cores - $usage->quota_cpu_cores,
            ];
        }

        if ($usage->total_memory_gb > $usage->quota_memory_gb) {
            $violations[] = [
                'type' => 'memory_gb',
                'current' => $usage->total_memory_gb,
                'limit' => $usage->quota_memory_gb,
                'overage' => $usage->total_memory_gb - $usage->quota_memory_gb,
            ];
        }

        if ($usage->total_storage_gb > $usage->quota_storage_gb) {
            $violations[] = [
                'type' => 'storage_gb',
                'current' => $usage->total_storage_gb,
                'limit' => $usage->quota_storage_gb,
                'overage' => $usage->total_storage_gb - $usage->quota_storage_gb,
            ];
        }

        return $violations;
    }

    /**
     * Check if grace period is active
     *
     * @param OrganizationResourceUsage $usage
     * @return bool
     */
    protected function isGracePeriodActive(OrganizationResourceUsage $usage): bool
    {
        return $usage->grace_period_active
            && $usage->grace_period_expires_at
            && $usage->grace_period_expires_at->isFuture();
    }

    /**
     * Check if quota enforcement is enabled for organization
     *
     * @param Organization $organization
     * @return bool
     */
    protected function isQuotaEnforcementEnabled(Organization $organization): bool
    {
        // Top-level organizations (no parent) typically have unlimited quotas
        if (!$organization->parent_id) {
            return false;
        }

        return $organization->quota_enforcement_enabled ?? true;
    }

    /**
     * Get cached organization usage
     *
     * @param Organization $organization
     * @return OrganizationResourceUsage
     */
    protected function getOrganizationUsage(Organization $organization): OrganizationResourceUsage
    {
        $cacheKey = "organization_usage:{$organization->id}";

        return Cache::remember($cacheKey, self::CACHE_TTL, function () use ($organization) {
            return OrganizationResourceUsage::firstOrCreate(
                ['organization_id' => $organization->id]
            );
        });
    }

    /**
     * Calculate monthly bandwidth usage
     *
     * @param Organization $organization
     * @return float
     */
    protected function calculateMonthlyBandwidth(Organization $organization): float
    {
        // Query server_resource_metrics for current month's bandwidth
        $startOfMonth = now()->startOfMonth();

        $bandwidth = DB::table('server_resource_metrics')
            ->join('servers', 'servers.id', '=', 'server_resource_metrics.server_id')
            ->where('servers.organization_id', $organization->id)
            ->where('server_resource_metrics.created_at', '>=', $startOfMonth)
            ->sum('server_resource_metrics.network_tx_gb');

        return (float) $bandwidth;
    }

    /**
     * Check quota thresholds and trigger alerts
     *
     * @param Organization $organization
     * @param OrganizationResourceUsage $usage
     * @return void
     */
    protected function checkQuotaAlerts(Organization $organization, OrganizationResourceUsage $usage): void
    {
        $alertThresholds = [80, 90, 100];

        // Check server quota
        $serverUsagePercent = ($usage->server_count / max($usage->quota_servers, 1)) * 100;

        foreach ($alertThresholds as $threshold) {
            if ($serverUsagePercent >= $threshold) {
                $this->triggerQuotaAlert($organization, 'servers', $threshold, $usage);
                break;
            }
        }

        // Check CPU quota
        $cpuUsagePercent = ($usage->total_cpu_cores / max($usage->quota_cpu_cores, 1)) * 100;

        foreach ($alertThresholds as $threshold) {
            if ($cpuUsagePercent >= $threshold) {
                $this->triggerQuotaAlert($organization, 'cpu', $threshold, $usage);
                break;
            }
        }

        // Similar checks for memory, storage, etc.
    }

    /**
     * Trigger quota alert notification
     *
     * @param Organization $organization
     * @param string $resourceType
     * @param int $threshold
     * @param OrganizationResourceUsage $usage
     * @return void
     */
    protected function triggerQuotaAlert(
        Organization $organization,
        string $resourceType,
        int $threshold,
        OrganizationResourceUsage $usage
    ): void {
        // Check if alert already sent recently
        $alertKey = "quota_alert:{$organization->id}:{$resourceType}:{$threshold}";

        if (Cache::has($alertKey)) {
            return; // Alert already sent
        }

        Log::warning("Quota threshold reached", [
            'organization_id' => $organization->id,
            'resource_type' => $resourceType,
            'threshold' => $threshold,
            'usage' => $usage->toArray(),
        ]);

        // Send notification to organization admins
        // NotificationService::send(new QuotaThresholdReached($organization, $resourceType, $threshold));

        // Cache alert to prevent spam (1 hour)
        Cache::put($alertKey, true, 3600);
    }

    /**
     * Get quota usage summary for organization
     *
     * @param Organization $organization
     * @return array
     */
    public function getQuotaUsageSummary(Organization $organization): array
    {
        $usage = $this->getOrganizationUsage($organization);
        $limits = $this->getOrganizationQuotaLimits($organization);

        return [
            'servers' => [
                'current' => $usage->server_count,
                'limit' => $limits['servers'],
                'percentage' => $this->calculatePercentage($usage->server_count, $limits['servers']),
            ],
            'applications' => [
                'current' => $usage->application_count,
                'limit' => $limits['applications'],
                'percentage' => $this->calculatePercentage($usage->application_count, $limits['applications']),
            ],
            'databases' => [
                'current' => $usage->database_count,
                'limit' => $limits['databases'],
                'percentage' => $this->calculatePercentage($usage->database_count, $limits['databases']),
            ],
            'cpu_cores' => [
                'current' => $usage->total_cpu_cores,
                'limit' => $limits['cpu_cores'],
                'percentage' => $this->calculatePercentage($usage->total_cpu_cores, $limits['cpu_cores']),
            ],
            'memory_gb' => [
                'current' => $usage->total_memory_gb,
                'limit' => $limits['memory_gb'],
                'percentage' => $this->calculatePercentage($usage->total_memory_gb, $limits['memory_gb']),
            ],
            'storage_gb' => [
                'current' => $usage->total_storage_gb,
                'limit' => $limits['storage_gb'],
                'percentage' => $this->calculatePercentage($usage->total_storage_gb, $limits['storage_gb']),
            ],
            'violations' => $usage->quota_violations ? json_decode($usage->quota_violations, true) : [],
            'grace_period_active' => $usage->grace_period_active,
            'grace_period_expires_at' => $usage->grace_period_expires_at,
        ];
    }

    /**
     * Calculate percentage usage
     *
     * @param float $current
     * @param float $limit
     * @return float
     */
    protected function calculatePercentage(float $current, float $limit): float
    {
        if ($limit <= 0) {
            return 0;
        }

        return round(($current / $limit) * 100, 2);
    }
}
```

### Service Interface

**File:** `app/Contracts/OrganizationQuotaServiceInterface.php`

```php
<?php

namespace App\Contracts;

use App\Models\Organization;
use App\Models\OrganizationResourceUsage;

interface OrganizationQuotaServiceInterface
{
    /**
     * Validate server quota before adding servers
     *
     * @param Organization $organization
     * @param int $additionalServers
     * @return void
     * @throws \App\Exceptions\QuotaExceededException
     */
    public function validateServerQuota(Organization $organization, int $additionalServers = 1): void;

    /**
     * Validate deployment resource quotas
     *
     * @param Organization $organization
     * @param float $cpuCores
     * @param float $memoryGb
     * @return void
     * @throws \App\Exceptions\QuotaExceededException
     */
    public function validateDeploymentQuota(Organization $organization, float $cpuCores, float $memoryGb): void;

    /**
     * Validate storage quota
     *
     * @param Organization $organization
     * @param float $storageGb
     * @return void
     * @throws \App\Exceptions\QuotaExceededException
     */
    public function validateStorageQuota(Organization $organization, float $storageGb): void;

    /**
     * Validate database quota
     *
     * @param Organization $organization
     * @param int $additionalDatabases
     * @return void
     * @throws \App\Exceptions\QuotaExceededException
     */
    public function validateDatabaseQuota(Organization $organization, int $additionalDatabases = 1): void;

    /**
     * Get organization quota limits
     *
     * @param Organization $organization
     * @return array
     */
    public function getOrganizationQuotaLimits(Organization $organization): array;

    /**
     * Calculate and update current resource usage
     *
     * @param Organization $organization
     * @return OrganizationResourceUsage
     */
    public function calculateCurrentUsage(Organization $organization): OrganizationResourceUsage;

    /**
     * Get quota usage summary
     *
     * @param Organization $organization
     * @return array
     */
    public function getQuotaUsageSummary(Organization $organization): array;
}
```

### Custom Exceptions

**File:** `app/Exceptions/QuotaExceededException.php`

```php
<?php

namespace App\Exceptions;

use App\Models\Organization;
use Exception;

class QuotaExceededException extends Exception
{
    public function __construct(
        public string $resourceType,
        public float $current,
        public float $limit,
        public Organization $organization
    ) {
        $message = "Quota exceeded for {$resourceType}: current usage {$current}, limit {$limit}";
        parent::__construct($message);
    }

    public static function servers(float $current, float $limit, Organization $organization): self
    {
        return new self('servers', $current, $limit, $organization);
    }

    public static function cpu(float $current, float $limit, Organization $organization): self
    {
        return new self('CPU cores', $current, $limit, $organization);
    }

    public static function memory(float $current, float $limit, Organization $organization): self
    {
        return new self('memory (GB)', $current, $limit, $organization);
    }

    public static function storage(float $current, float $limit, Organization $organization): self
    {
        return new self('storage (GB)', $current, $limit, $organization);
    }

    public static function databases(float $current, float $limit, Organization $organization): self
    {
        return new self('databases', $current, $limit, $organization);
    }

    public static function buildSlots(float $current, float $limit, Organization $organization): self
    {
        return new self('concurrent build slots', $current, $limit, $organization);
    }

    /**
     * Render the exception for JSON response
     *
     * @return array
     */
    public function render(): array
    {
        return [
            'error' => 'Quota Exceeded',
            'message' => $this->getMessage(),
            'resource_type' => $this->resourceType,
            'current_usage' => $this->current,
            'quota_limit' => $this->limit,
            'organization_id' => $this->organization->id,
            'upgrade_url' => route('enterprise.license.upgrade', $this->organization),
        ];
    }
}
```

### Middleware for API Quota Enforcement

**File:** `app/Http/Middleware/EnforceResourceQuotas.php`

```php
<?php

namespace App\Http\Middleware;

use App\Contracts\OrganizationQuotaServiceInterface;
use Closure;
use Illuminate\Http\Request;

class EnforceResourceQuotas
{
    public function __construct(
        private OrganizationQuotaServiceInterface $quotaService
    ) {
    }

    /**
     * Handle an incoming request
     *
     * @param Request $request
     * @param Closure $next
     * @return mixed
     */
    public function handle(Request $request, Closure $next): mixed
    {
        $organization = $request->user()?->currentOrganization;

        if (!$organization) {
            return $next($request);
        }

        // Recalculate usage if stale (older than 5 minutes)
        $usage = $organization->resourceUsage;

        if (!$usage || $usage->last_calculated_at < now()->subMinutes(5)) {
            $this->quotaService->calculateCurrentUsage($organization);
        }

        return $next($request);
    }
}
```

### Artisan Command

**File:** `app/Console/Commands/RecalculateQuotas.php`

```php
<?php

namespace App\Console\Commands;

use App\Contracts\OrganizationQuotaServiceInterface;
use App\Models\Organization;
use Illuminate\Console\Command;

class RecalculateQuotas extends Command
{
    protected $signature = 'quotas:recalculate
                            {organization? : Organization ID or slug}
                            {--all : Recalculate for all organizations}';

    protected $description = 'Recalculate resource quotas for organizations';

    public function handle(OrganizationQuotaServiceInterface $quotaService): int
    {
        if ($this->option('all')) {
            return $this->recalculateAll($quotaService);
        }

        $organizationIdOrSlug = $this->argument('organization');

        if (!$organizationIdOrSlug) {
            $this->error('Please provide organization ID/slug or use --all flag');
            return self::FAILURE;
        }

        return $this->recalculateSingle($organizationIdOrSlug, $quotaService);
    }

    protected function recalculateSingle(string $idOrSlug, OrganizationQuotaServiceInterface $quotaService): int
    {
        $organization = Organization::where('id', $idOrSlug)
            ->orWhere('slug', $idOrSlug)
            ->first();

        if (!$organization) {
            $this->error("Organization not found: {$idOrSlug}");
            return self::FAILURE;
        }

        $this->info("Recalculating quotas for: {$organization->name}");

        $usage = $quotaService->calculateCurrentUsage($organization);

        $this->table(
            ['Resource', 'Current', 'Limit', 'Usage %'],
            [
                ['Servers', $usage->server_count, $usage->quota_servers, $this->percentage($usage->server_count, $usage->quota_servers)],
                ['CPU Cores', $usage->total_cpu_cores, $usage->quota_cpu_cores, $this->percentage($usage->total_cpu_cores, $usage->quota_cpu_cores)],
                ['Memory (GB)', $usage->total_memory_gb, $usage->quota_memory_gb, $this->percentage($usage->total_memory_gb, $usage->quota_memory_gb)],
                ['Storage (GB)', $usage->total_storage_gb, $usage->quota_storage_gb, $this->percentage($usage->total_storage_gb, $usage->quota_storage_gb)],
            ]
        );

        if ($usage->quota_violations) {
            $this->warn('⚠ Quota violations detected:');
            $violations = json_decode($usage->quota_violations, true);
            foreach ($violations as $violation) {
                $this->error("  - {$violation['type']}: {$violation['overage']} over limit");
            }
        }

        return self::SUCCESS;
    }

    protected function recalculateAll(OrganizationQuotaServiceInterface $quotaService): int
    {
        $organizations = Organization::has('enterpriseLicense')->get();

        $this->info("Recalculating quotas for {$organizations->count()} organizations...");

        $progressBar = $this->output->createProgressBar($organizations->count());

        foreach ($organizations as $organization) {
            $quotaService->calculateCurrentUsage($organization);
            $progressBar->advance();
        }

        $progressBar->finish();
        $this->newLine(2);
        $this->info('✓ Quota recalculation complete');

        return self::SUCCESS;
    }

    protected function percentage(float $current, float $limit): string
    {
        if ($limit <= 0) {
            return 'N/A';
        }

        return round(($current / $limit) * 100, 1) . '%';
    }
}
```

## Implementation Approach

### Step 1: Create Database Migration
1. Create migration for quota tracking columns
2. Add columns to `organization_resource_usage` table
3. Add quota enforcement flags to `organizations` table
4. Run migration: `php artisan migrate`

### Step 2: Create Service Interface and Implementation
1. Create `OrganizationQuotaServiceInterface` in `app/Contracts/`
2. Implement `OrganizationQuotaService` in `app/Services/Enterprise/`
3. Register service in `EnterpriseServiceProvider`

### Step 3: Implement Core Validation Methods
1. Add `validateServerQuota()` method
2. Add `validateDeploymentQuota()` for CPU/memory
3. Add `validateStorageQuota()` method
4. Add `validateDatabaseQuota()` method
5. Add `validateBuildSlotQuota()` method

### Step 4: Implement Usage Calculation
1. Create `calculateCurrentUsage()` method
2. Query servers, applications, databases for counts
3. Aggregate CPU, memory, storage from server metrics
4. Calculate bandwidth from `server_resource_metrics`
5. Store calculated values in `organization_resource_usage`

### Step 5: Create Custom Exceptions
1. Create `QuotaExceededException` class
2. Add static factory methods for each resource type
3. Implement `render()` method for JSON responses
4. Create `QuotaValidationException` for validation errors

### Step 6: Integrate with License System
1. Add `getOrganizationQuotaLimits()` method
2. Extract quota limits from `EnterpriseLicense`
3. Support admin quota overrides from `organizations.quota_overrides`
4. Cache quota limits for performance

### Step 7: Implement Grace Period Logic
1. Add `isGracePeriodActive()` check
2. Set grace period on first quota violation
3. Allow operations during grace period with warnings
4. Expire grace period after configured days

### Step 8: Create Middleware
1. Create `EnforceResourceQuotas` middleware
2. Recalculate usage if stale (> 5 minutes old)
3. Register in `app/Http/Kernel.php`
4. Apply to API routes

### Step 9: Integrate with Deployment Pipeline
1. Modify `ApplicationDeploymentJob` to validate quotas
2. Add quota check before deployment starts
3. Throw `QuotaExceededException` if limit exceeded
4. Log quota validation results

### Step 10: Create Artisan Command
1. Create `RecalculateQuotas` command
2. Support single organization recalculation
3. Support bulk recalculation with --all flag
4. Display quota usage table after calculation

### Step 11: Implement Quota Alerts
1. Add `checkQuotaAlerts()` method
2. Check 80%, 90%, 100% thresholds
3. Trigger notifications to organization admins
4. Cache alerts to prevent spam

### Step 12: Testing
1. Unit test quota validation methods
2. Test grace period logic
3. Test hierarchical quota inheritance
4. Integration test with deployment pipeline
5. Test quota recalculation accuracy

## Test Strategy

### Unit Tests

**File:** `tests/Unit/Services/OrganizationQuotaServiceTest.php`

```php
<?php

use App\Services\Enterprise\OrganizationQuotaService;
use App\Models\Organization;
use App\Models\EnterpriseLicense;
use App\Models\OrganizationResourceUsage;
use App\Exceptions\QuotaExceededException;
use Illuminate\Support\Facades\Cache;

beforeEach(function () {
    Cache::flush();
    $this->service = app(OrganizationQuotaService::class);
});

it('validates server quota successfully when under limit', function () {
    $org = Organization::factory()->create(['quota_enforcement_enabled' => true]);
    $license = EnterpriseLicense::factory()->create([
        'organization_id' => $org->id,
        'limits' => ['max_servers' => 10],
    ]);

    OrganizationResourceUsage::create([
        'organization_id' => $org->id,
        'server_count' => 5,
        'quota_servers' => 10,
    ]);

    // Should not throw exception
    $this->service->validateServerQuota($org, 3);
    expect(true)->toBeTrue();
});

it('throws exception when server quota exceeded', function () {
    $org = Organization::factory()->create(['quota_enforcement_enabled' => true]);
    EnterpriseLicense::factory()->create([
        'organization_id' => $org->id,
        'limits' => ['max_servers' => 5],
    ]);

    OrganizationResourceUsage::create([
        'organization_id' => $org->id,
        'server_count' => 5,
        'quota_servers' => 5,
    ]);

    $this->service->validateServerQuota($org, 1);
})->throws(QuotaExceededException::class);

it('allows quota overage during grace period', function () {
    $org = Organization::factory()->create(['quota_enforcement_enabled' => true]);
    EnterpriseLicense::factory()->create([
        'organization_id' => $org->id,
        'limits' => ['max_servers' => 5],
    ]);

    OrganizationResourceUsage::create([
        'organization_id' => $org->id,
        'server_count' => 6,
        'quota_servers' => 5,
        'grace_period_active' => true,
        'grace_period_expires_at' => now()->addDays(3),
    ]);

    // Should not throw during grace period
    $this->service->validateServerQuota($org, 1);
    expect(true)->toBeTrue();
});

it('calculates current usage accurately', function () {
    $org = Organization::factory()->create();

    // Create resources
    Server::factory(3)->create(['organization_id' => $org->id, 'cpu_cores' => 4, 'memory_gb' => 8]);
    Application::factory(5)->create(['organization_id' => $org->id]);
    Database::factory(2)->create(['organization_id' => $org->id]);

    $usage = $this->service->calculateCurrentUsage($org);

    expect($usage->server_count)->toBe(3);
    expect($usage->application_count)->toBe(5);
    expect($usage->database_count)->toBe(2);
    expect($usage->total_cpu_cores)->toBe(12.0); // 3 servers * 4 cores
    expect($usage->total_memory_gb)->toBe(24.0); // 3 servers * 8 GB
});

it('detects quota violations', function () {
    $org = Organization::factory()->create();
    EnterpriseLicense::factory()->create([
        'organization_id' => $org->id,
        'limits' => [
            'max_servers' => 5,
            'max_cpu_cores' => 10,
        ],
    ]);

    // Exceed limits
    Server::factory(7)->create(['organization_id' => $org->id, 'cpu_cores' => 4]);

    $usage = $this->service->calculateCurrentUsage($org);
    $violations = json_decode($usage->quota_violations, true);

    expect($violations)->toHaveCount(2);
    expect($violations[0]['type'])->toBe('servers');
    expect($violations[1]['type'])->toBe('cpu_cores');
});

it('respects admin quota overrides', function () {
    $org = Organization::factory()->create([
        'quota_overrides' => json_encode(['servers' => 100])
    ]);
    EnterpriseLicense::factory()->create([
        'organization_id' => $org->id,
        'limits' => ['max_servers' => 10],
    ]);

    $limits = $this->service->getOrganizationQuotaLimits($org);

    expect($limits['servers'])->toBe(100); // Override value
});

it('skips enforcement for top-level organizations', function () {
    $org = Organization::factory()->create(['parent_id' => null]);

    OrganizationResourceUsage::create([
        'organization_id' => $org->id,
        'server_count' => 1000,
        'quota_servers' => 1,
    ]);

    // Should not throw for top-level org
    $this->service->validateServerQuota($org, 100);
    expect(true)->toBeTrue();
});
```

### Integration Tests

**File:** `tests/Feature/QuotaEnforcementIntegrationTest.php`

```php
<?php

use App\Jobs\ApplicationDeploymentJob;
use App\Models\Organization;
use App\Models\Application;
use App\Exceptions\QuotaExceededException;

it('prevents deployment when CPU quota exceeded', function () {
    $org = Organization::factory()->create(['quota_enforcement_enabled' => true]);
    EnterpriseLicense::factory()->create([
        'organization_id' => $org->id,
        'limits' => ['max_cpu_cores' => 8],
    ]);

    // Use 7 CPU cores
    Server::factory()->create(['organization_id' => $org->id, 'cpu_cores' => 7]);

    $app = Application::factory()->create(['organization_id' => $org->id]);

    // Attempt deployment requiring 4 cores (total 11 > limit 8)
    expect(fn() => ApplicationDeploymentJob::dispatch($app, cpuCores: 4))
        ->toThrow(QuotaExceededException::class);
});

it('recalculates quotas via artisan command', function () {
    $org = Organization::factory()->create();
    Server::factory(3)->create(['organization_id' => $org->id]);

    $this->artisan('quotas:recalculate', ['organization' => $org->id])
        ->assertSuccessful()
        ->expectsOutputToContain('Servers');

    $usage = $org->resourceUsage;
    expect($usage->server_count)->toBe(3);
});

it('displays quota usage in API response', function () {
    $org = Organization::factory()->create();
    $user = User::factory()->create();
    $org->users()->attach($user);

    EnterpriseLicense::factory()->create([
        'organization_id' => $org->id,
        'limits' => ['max_servers' => 10],
    ]);

    $this->actingAs($user)
        ->getJson("/api/organizations/{$org->id}/quota-usage")
        ->assertOk()
        ->assertJsonStructure([
            'servers' => ['current', 'limit', 'percentage'],
            'cpu_cores' => ['current', 'limit', 'percentage'],
        ]);
});
```

## Definition of Done

- [ ] OrganizationResourceUsage table enhanced with quota tracking columns
- [ ] Organizations table enhanced with quota_enforcement_enabled flag
- [ ] Database migration created and run successfully
- [ ] OrganizationQuotaServiceInterface created
- [ ] OrganizationQuotaService implemented with all validation methods
- [ ] Service registered in EnterpriseServiceProvider
- [ ] QuotaExceededException custom exception created
- [ ] validateServerQuota() method implemented
- [ ] validateDeploymentQuota() method implemented
- [ ] validateStorageQuota() method implemented
- [ ] validateDatabaseQuota() method implemented
- [ ] validateBuildSlotQuota() method implemented
- [ ] calculateCurrentUsage() method implemented
- [ ] getOrganizationQuotaLimits() method implemented
- [ ] Grace period logic implemented
- [ ] Quota violation detection implemented
- [ ] Quota threshold alerts implemented (80%, 90%, 100%)
- [ ] EnforceResourceQuotas middleware created
- [ ] Middleware registered and applied to routes
- [ ] RecalculateQuotas Artisan command created
- [ ] Integration with ApplicationDeploymentJob
- [ ] Integration with TerraformDeploymentJob
- [ ] Integration with ServerController
- [ ] Integration with EnterpriseLicense for quota limits
- [ ] Admin quota override support implemented
- [ ] Hierarchical quota inheritance implemented
- [ ] Quota usage API endpoint created
- [ ] Unit tests written (12+ tests, >90% coverage)
- [ ] Integration tests written (6+ tests)
- [ ] Edge case tests (grace period, overrides, top-level orgs)
- [ ] Documentation updated with quota configuration guide
- [ ] Code follows Laravel 12 and Coolify patterns
- [ ] PHPStan level 5 passing
- [ ] Laravel Pint formatting applied
- [ ] Code reviewed and approved
- [ ] Manual testing with various quota scenarios
- [ ] Performance verified (validation < 50ms)

## Related Tasks

- **Depends on:** Task 26 (CapacityManager service for usage data)
- **Integrates with:** Tasks 1-2 (EnterpriseLicense for quota limits)
- **Integrates with:** Task 25 (SystemResourceMonitor for metrics)
- **Enforced in:** Task 18 (TerraformDeploymentJob)
- **Enforced in:** Task 32-35 (Enhanced deployment strategies)
- **Used by:** Task 29 (ResourceDashboard.vue displays quotas)
- **Alerts via:** Email/notification system (future task)
