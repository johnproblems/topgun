---
name: Set up CI/CD quality gates
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:39:32Z
github: https://github.com/johnproblems/topgun/issues/188
depends_on: [76, 77, 78, 79, 80]
parallel: false
conflicts_with: []
---

# Task: Set up CI/CD quality gates

## Description

Establish a comprehensive continuous integration and continuous deployment (CI/CD) pipeline with automated quality gates to ensure code quality, security, and reliability across the Coolify Enterprise codebase. This task creates a multi-layered validation system that prevents regressions, enforces coding standards, and maintains the high quality bar required for enterprise software.

The CI/CD quality gate system acts as the final guardian of code quality, automatically running on every pull request and deployment. It validates that all code changes meet strict quality criteria before merging into the main branch or deploying to production environments. This system is critical for maintaining the enterprise transformation project's integrity as multiple developers work across white-label features, Terraform integration, resource monitoring, and payment processing.

**Why This Task Is Critical:**

Quality gates prevent production incidents by catching issues early in the development cycle. They enforce consistency across the large codebase, ensure security vulnerabilities are detected before deployment, validate that tests provide adequate coverage, and maintain architectural integrity through static analysis. Without automated quality gates, the complexity of the enterprise transformation would lead to undetected bugs, security vulnerabilities, and technical debt accumulation.

**Core Capabilities:**

1. **Test Coverage Enforcement** - Require 90%+ code coverage for PHP (Pest) and JavaScript (Vitest), with per-directory minimums
2. **Static Analysis Validation** - Enforce PHPStan level 5+ with zero errors, detecting type inconsistencies and potential bugs
3. **Security Scanning** - Automated vulnerability detection in dependencies (Composer, NPM) and custom code
4. **Code Quality Metrics** - Code complexity analysis, duplication detection, and architectural validation
5. **Database Migration Safety** - Validate migrations are reversible, performant, and non-breaking
6. **Performance Benchmarks** - Automated performance regression detection for critical paths
7. **Multi-Environment Testing** - Test against PostgreSQL 15+, Redis 7+, and multiple PHP versions
8. **Deployment Automation** - Automated deployments to staging/production with rollback capability

**Integration Points:**

- **GitHub Actions** - Primary CI/CD platform with workflow automation
- **Pest & PHPUnit** - PHP testing framework with coverage reporting
- **Vitest** - JavaScript/Vue.js testing framework
- **PHPStan** - Static analysis tool for PHP type checking
- **Laravel Pint** - Code style enforcement
- **Snyk/GitHub Security** - Dependency vulnerability scanning
- **SonarQube** (optional) - Advanced code quality metrics
- **Existing Test Infrastructure** - Tasks 76-80 created comprehensive test suites

## Acceptance Criteria

- [ ] GitHub Actions workflow created for all pull requests
- [ ] Test coverage requirement: 90%+ for PHP code with coverage report
- [ ] Test coverage requirement: 85%+ for Vue.js/JavaScript code
- [ ] PHPStan level 5 enforcement with zero errors allowed
- [ ] Laravel Pint code style validation on all PHP files
- [ ] Security vulnerability scanning for Composer dependencies
- [ ] Security vulnerability scanning for NPM dependencies
- [ ] Database migration safety checks (rollback validation, no data loss)
- [ ] Performance regression testing for critical API endpoints
- [ ] Multi-database testing (PostgreSQL 15+, Redis 7+)
- [ ] Browser test execution via Dusk on Selenium Grid
- [ ] Deployment automation to staging environment on main branch
- [ ] Manual approval gate for production deployments
- [ ] Automatic rollback on failed deployment health checks
- [ ] Pull request status checks block merge if quality gates fail

## Technical Details

### File Paths

**GitHub Actions Workflows:**
- `/home/topgun/topgun/.github/workflows/ci.yml` - Main CI workflow
- `/home/topgun/topgun/.github/workflows/deploy-staging.yml` - Staging deployment
- `/home/topgun/topgun/.github/workflows/deploy-production.yml` - Production deployment
- `/home/topgun/topgun/.github/workflows/security-scan.yml` - Security scanning

**Configuration Files:**
- `/home/topgun/topgun/phpstan.neon` - PHPStan configuration (existing, enhance)
- `/home/topgun/topgun/pint.json` - Laravel Pint configuration (existing)
- `/home/topgun/topgun/phpunit.xml` - PHPUnit configuration (existing, enhance coverage thresholds)
- `/home/topgun/topgun/vitest.config.js` - Vitest configuration with coverage
- `/home/topgun/topgun/sonar-project.properties` - SonarQube configuration (optional)

**Scripts:**
- `/home/topgun/topgun/scripts/ci/test-coverage.sh` - Coverage validation script
- `/home/topgun/topgun/scripts/ci/migration-check.sh` - Migration safety validation
- `/home/topgun/topgun/scripts/ci/performance-benchmark.sh` - Performance testing
- `/home/topgun/topgun/scripts/ci/deploy.sh` - Deployment automation script

### GitHub Actions CI Workflow

**File:** `.github/workflows/ci.yml`

```yaml
name: Continuous Integration

on:
  pull_request:
    branches: [main, v4.x]
  push:
    branches: [main, v4.x]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-quality:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, redis, bcmath
          coverage: xdebug
          tools: composer:v2

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install PHP dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: Install NPM dependencies
        run: npm ci

      - name: Run Laravel Pint (Code Style)
        run: ./vendor/bin/pint --test

      - name: Run PHPStan (Static Analysis)
        run: ./vendor/bin/pint analyse --level=5 --memory-limit=2G

      - name: Run ESLint (JavaScript)
        run: npm run lint

      - name: Check for uncommitted Pint changes
        run: |
          git diff --exit-code || (echo "Code style violations detected. Run './vendor/bin/pint' locally." && exit 1)

  unit-tests:
    name: Unit Tests (PHP)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: coolify_test
          POSTGRES_USER: coolify
          POSTGRES_PASSWORD: password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, redis, bcmath
          coverage: xdebug

      - name: Install dependencies
        run: composer install --prefer-dist --no-interaction

      - name: Copy environment file
        run: cp .env.testing .env

      - name: Generate application key
        run: php artisan key:generate --env=testing

      - name: Run database migrations
        run: php artisan migrate --env=testing --force

      - name: Run unit tests with coverage
        run: ./vendor/bin/pest --coverage --min=90 --coverage-clover=coverage.xml --coverage-html=coverage-html

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: Archive coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-html/
          retention-days: 7

  integration-tests:
    name: Integration Tests (Full Workflows)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: coolify_test
          POSTGRES_USER: coolify
          POSTGRES_PASSWORD: password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, redis, bcmath

      - name: Install dependencies
        run: composer install --prefer-dist --no-interaction

      - name: Copy environment file
        run: cp .env.testing .env

      - name: Generate application key
        run: php artisan key:generate --env=testing

      - name: Run database migrations
        run: php artisan migrate --env=testing --force

      - name: Seed test database
        run: php artisan db:seed --class=TestDataSeeder --env=testing

      - name: Run integration tests
        run: ./vendor/bin/pest --testsuite=Feature --parallel

  browser-tests:
    name: Browser Tests (Dusk)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: coolify_test
          POSTGRES_USER: coolify
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, redis, bcmath

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install dependencies
        run: composer install --prefer-dist --no-interaction

      - name: Install NPM dependencies and build
        run: |
          npm ci
          npm run build

      - name: Copy environment file
        run: cp .env.dusk .env

      - name: Generate application key
        run: php artisan key:generate

      - name: Run migrations
        run: php artisan migrate --force

      - name: Start Laravel server
        run: php artisan serve --env=testing &

      - name: Run Dusk tests
        run: php artisan dusk --env=testing

      - name: Upload Dusk screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: dusk-screenshots
          path: tests/Browser/screenshots/
          retention-days: 7

      - name: Upload Dusk console logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: dusk-console-logs
          path: tests/Browser/console/
          retention-days: 7

  javascript-tests:
    name: JavaScript/Vue Tests (Vitest)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Vitest with coverage
        run: npm run test:coverage -- --run --coverage.enabled --coverage.reporter=lcov --coverage.reporter=text

      - name: Check coverage threshold
        run: npm run test:coverage -- --run --coverage.enabled --coverage.lines=85 --coverage.functions=85 --coverage.branches=80

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: javascript
          name: codecov-javascript

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Composer security audit
        run: composer audit --no-dev --format=json

      - name: Run NPM security audit
        run: npm audit --audit-level=moderate

      - name: Run Snyk security scan
        uses: snyk/actions/php@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: GitHub Security Scanning
        uses: github/codeql-action/analyze@v3
        with:
          languages: javascript, php

  migration-safety:
    name: Database Migration Safety Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: coolify_test
          POSTGRES_USER: coolify
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo_pgsql

      - name: Install dependencies
        run: composer install --prefer-dist --no-interaction

      - name: Copy environment file
        run: cp .env.testing .env

      - name: Generate application key
        run: php artisan key:generate

      - name: Test migrations (up)
        run: php artisan migrate --force

      - name: Test migrations (down)
        run: php artisan migrate:rollback --step=5 --force

      - name: Test fresh migrations
        run: php artisan migrate:fresh --force --seed

      - name: Check for migration conflicts
        run: php artisan migrate:status

  performance-tests:
    name: Performance Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: coolify_test
          POSTGRES_USER: coolify
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, redis, bcmath

      - name: Install dependencies
        run: composer install --prefer-dist --no-interaction

      - name: Copy environment file
        run: cp .env.testing .env

      - name: Generate application key
        run: php artisan key:generate

      - name: Run migrations and seed
        run: |
          php artisan migrate --force
          php artisan db:seed --class=PerformanceTestSeeder

      - name: Run performance benchmarks
        run: ./vendor/bin/pest --group=performance --parallel

      - name: Compare with baseline
        run: |
          php artisan benchmark:compare --baseline=main --threshold=10

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: storage/benchmarks/
          retention-days: 30

  all-checks:
    name: All Quality Gates Passed
    runs-on: ubuntu-latest
    needs:
      - code-quality
      - unit-tests
      - integration-tests
      - browser-tests
      - javascript-tests
      - security-scan
      - migration-safety
      - performance-tests

    steps:
      - name: All checks passed
        run: echo "All quality gates passed successfully!"
```

### Staging Deployment Workflow

**File:** `.github/workflows/deploy-staging.yml`

```yaml
name: Deploy to Staging

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: staging
      url: https://staging.coolify-enterprise.dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, redis

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-interaction --optimize-autoloader --no-dev

      - name: Install NPM dependencies and build
        run: |
          npm ci
          npm run build

      - name: Deploy to staging server via SSH
        uses: easingthemes/ssh-deploy@v5
        with:
          SSH_PRIVATE_KEY: ${{ secrets.STAGING_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.STAGING_HOST }}
          REMOTE_USER: ${{ secrets.STAGING_USER }}
          TARGET: /var/www/coolify-staging
          EXCLUDE: |
            /node_modules/
            /storage/
            /.git/
            /.github/

      - name: Run post-deployment commands
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /var/www/coolify-staging
            php artisan down
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan queue:restart
            php artisan up

      - name: Run smoke tests
        run: |
          curl -f https://staging.coolify-enterprise.dev/health || exit 1
          curl -f https://staging.coolify-enterprise.dev/api/v1/status || exit 1

      - name: Notify deployment success
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "âœ… Staging deployment successful: ${{ github.sha }}"
            }

      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /var/www/coolify-staging
            git checkout HEAD~1
            composer install --no-dev
            php artisan migrate:rollback --force

      - name: Notify deployment failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "âŒ Staging deployment failed: ${{ github.sha }}"
            }
```

### Production Deployment Workflow

**File:** `.github/workflows/deploy-production.yml`

```yaml
name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production

jobs:
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: production
      url: https://coolify-enterprise.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Verify tag format
        run: |
          if [[ ! "${{ github.ref }}" =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid tag format. Must be v*.*.* (semver)"
            exit 1
          fi

      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, redis

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-interaction --optimize-autoloader --no-dev

      - name: Install NPM dependencies and build
        run: |
          npm ci
          npm run build

      - name: Create deployment backup
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /var/www/coolify-production
            tar -czf /backups/coolify-$(date +%Y%m%d-%H%M%S).tar.gz .
            pg_dump coolify_production > /backups/coolify-db-$(date +%Y%m%d-%H%M%S).sql

      - name: Deploy to production servers
        uses: easingthemes/ssh-deploy@v5
        with:
          SSH_PRIVATE_KEY: ${{ secrets.PRODUCTION_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.PRODUCTION_HOST }}
          REMOTE_USER: ${{ secrets.PRODUCTION_USER }}
          TARGET: /var/www/coolify-production
          EXCLUDE: |
            /node_modules/
            /storage/
            /.git/

      - name: Run database migrations
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /var/www/coolify-production
            php artisan down --message="Deploying new version" --retry=60
            php artisan migrate --force

      - name: Optimize application
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /var/www/coolify-production
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan queue:restart
            php artisan horizon:terminate

      - name: Warm caches
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /var/www/coolify-production
            php artisan cache:warm
            php artisan branding:cache-warm

      - name: Bring application up
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /var/www/coolify-production
            php artisan up

      - name: Run production smoke tests
        run: |
          sleep 10
          curl -f https://coolify-enterprise.com/health || exit 1
          curl -f https://coolify-enterprise.com/api/v1/status || exit 1

      - name: Monitor error rates
        run: |
          # Check error rate for 5 minutes
          for i in {1..10}; do
            ERROR_RATE=$(curl -s https://coolify-enterprise.com/metrics/errors | jq '.rate')
            if (( $(echo "$ERROR_RATE > 0.05" | bc -l) )); then
              echo "Error rate too high: $ERROR_RATE"
              exit 1
            fi
            sleep 30
          done

      - name: Notify successful deployment
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "âœ… Production deployment successful: ${{ github.ref_name }}"
            }

      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /var/www/coolify-production
            php artisan down
            # Restore from latest backup
            LATEST_BACKUP=$(ls -t /backups/coolify-*.tar.gz | head -1)
            tar -xzf $LATEST_BACKUP -C /var/www/coolify-production
            # Restore database
            LATEST_DB=$(ls -t /backups/coolify-db-*.sql | head -1)
            psql coolify_production < $LATEST_DB
            php artisan config:cache
            php artisan up

      - name: Notify deployment failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "âŒ Production deployment FAILED and was rolled back: ${{ github.ref_name }}"
            }
```

### PHPStan Configuration Enhancement

**File:** `phpstan.neon`

```neon
parameters:
    level: 5
    paths:
        - app
        - bootstrap
        - config
        - database
        - routes
    excludePaths:
        - vendor
        - storage
        - node_modules
        - bootstrap/cache

    # Enterprise-specific rules
    ignoreErrors:
        # Allow dynamic properties for legacy models (gradually remove)
        - '#Access to an undefined property App\\Models#'

    # Type coverage
    reportUnmatchedIgnoredErrors: true
    checkMissingIterableValueType: true
    checkGenericClassInNonGenericObjectType: false

    # Custom rules for enterprise code
    customRulesetUsed: true

    # Performance
    parallel:
        processTimeout: 300.0
        maximumNumberOfProcesses: 4

    # Baseline for gradual adoption
    baseline: phpstan-baseline.neon
```

### Vitest Configuration with Coverage

**File:** `vitest.config.js`

```javascript
import { defineConfig } from 'vitest/config'
import vue from '@vitejs/plugin-vue'
import { fileURLToPath } from 'url'

export default defineConfig({
  plugins: [vue()],
  test: {
    globals: true,
    environment: 'jsdom',
    coverage: {
      provider: 'v8',
      reporter: ['text', 'lcov', 'html'],
      include: ['resources/js/**/*.{js,ts,vue}'],
      exclude: [
        'node_modules/',
        'resources/js/**/*.spec.{js,ts}',
        'resources/js/**/*.test.{js,ts}',
      ],
      thresholds: {
        lines: 85,
        functions: 85,
        branches: 80,
        statements: 85,
      },
    },
  },
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./resources/js', import.meta.url)),
    },
  },
})
```

### Test Coverage Validation Script

**File:** `scripts/ci/test-coverage.sh`

```bash
#!/bin/bash

set -e

echo "ðŸ§ª Running PHP test coverage analysis..."

# Run Pest with coverage
./vendor/bin/pest --coverage --min=90 --coverage-clover=coverage.xml

# Extract coverage percentage
COVERAGE=$(grep -oP 'Lines:\s+\K[\d\.]+' coverage.xml | head -1)

echo "ðŸ“Š PHP Coverage: $COVERAGE%"

if (( $(echo "$COVERAGE < 90" | bc -l) )); then
  echo "âŒ Coverage below 90% threshold: $COVERAGE%"
  exit 1
fi

echo "âœ… PHP coverage meets 90% threshold"

# Run JavaScript coverage
echo "ðŸ§ª Running JavaScript test coverage..."
npm run test:coverage -- --run --coverage.enabled

# Check JavaScript thresholds (handled by Vitest config)
echo "âœ… JavaScript coverage validated"

echo "âœ… All coverage thresholds met"
```

### Migration Safety Check Script

**File:** `scripts/ci/migration-check.sh`

```bash
#!/bin/bash

set -e

echo "ðŸ” Checking database migrations for safety..."

# Copy test environment
cp .env.testing .env

# Generate key
php artisan key:generate

# Test migrations up
echo "Testing migrations (up)..."
php artisan migrate --force

# Test migrations down (last 5)
echo "Testing migrations (down)..."
php artisan migrate:rollback --step=5 --force

# Test fresh migrations
echo "Testing fresh migrations with seed..."
php artisan migrate:fresh --force --seed

# Check for migration conflicts
echo "Checking migration status..."
php artisan migrate:status

# Validate no down() methods are empty
echo "Validating rollback methods..."
EMPTY_DOWN=$(grep -r "public function down" database/migrations/ -A 2 | grep -c "{}" || true)

if [ "$EMPTY_DOWN" -gt 0 ]; then
  echo "âŒ Found $EMPTY_DOWN migrations with empty down() methods"
  exit 1
fi

echo "âœ… All migration safety checks passed"
```

### Performance Benchmark Script

**File:** `scripts/ci/performance-benchmark.sh`

```bash
#!/bin/bash

set -e

echo "âš¡ Running performance benchmarks..."

# Setup environment
cp .env.testing .env
php artisan key:generate
php artisan migrate --force --seed

# Run performance test group
./vendor/bin/pest --group=performance --parallel

# Extract benchmark results
RESULTS_FILE="storage/benchmarks/latest.json"

if [ ! -f "$RESULTS_FILE" ]; then
  echo "âš ï¸ No benchmark results found, skipping comparison"
  exit 0
fi

# Compare with baseline (main branch)
git fetch origin main

BASELINE_FILE="storage/benchmarks/baseline.json"

if [ ! -f "$BASELINE_FILE" ]; then
  echo "âš ï¸ No baseline found, saving current as baseline"
  cp "$RESULTS_FILE" "$BASELINE_FILE"
  exit 0
fi

# Calculate performance regression
REGRESSION=$(php artisan benchmark:compare --baseline="$BASELINE_FILE" --current="$RESULTS_FILE" --threshold=10)

if [ $? -ne 0 ]; then
  echo "âŒ Performance regression detected: $REGRESSION"
  exit 1
fi

echo "âœ… Performance benchmarks passed"
```

## Implementation Approach

### Step 1: Create GitHub Actions Workflows
1. Create `.github/workflows/ci.yml` with all quality gate jobs
2. Create `.github/workflows/deploy-staging.yml` for automatic staging deployments
3. Create `.github/workflows/deploy-production.yml` for manual production deployments
4. Create `.github/workflows/security-scan.yml` for scheduled security scans

### Step 2: Enhance Testing Configuration
1. Update `phpunit.xml` with coverage thresholds (90% minimum)
2. Create `vitest.config.js` with JavaScript coverage thresholds (85% minimum)
3. Update `phpstan.neon` to enforce level 5 with zero errors
4. Create baseline file for gradual PHPStan adoption

### Step 3: Create CI Helper Scripts
1. Create `scripts/ci/test-coverage.sh` for coverage validation
2. Create `scripts/ci/migration-check.sh` for migration safety
3. Create `scripts/ci/performance-benchmark.sh` for regression testing
4. Create `scripts/ci/deploy.sh` for deployment automation

### Step 4: Configure Branch Protection
1. Enable required status checks on `main` branch
2. Require passing CI before merge
3. Require code review approvals (1+ reviewers)
4. Enable automatic deletion of merged branches

### Step 5: Set Up Deployment Environments
1. Configure GitHub Environments (staging, production)
2. Add environment secrets (SSH keys, API tokens)
3. Set up environment protection rules (manual approval for production)
4. Configure environment-specific variables

### Step 6: Add Security Scanning
1. Enable GitHub Security Scanning (CodeQL)
2. Configure Snyk for dependency scanning
3. Add `composer audit` and `npm audit` to CI
4. Set up automated security alerts

### Step 7: Configure Monitoring & Notifications
1. Set up Slack/Discord webhooks for deployment notifications
2. Configure GitHub Actions failure notifications
3. Add performance monitoring dashboards
4. Set up error tracking integration (Sentry/Bugsnag)

### Step 8: Testing & Validation
1. Test CI workflow on feature branch
2. Validate all quality gates with intentional failures
3. Test staging deployment end-to-end
4. Test production deployment rollback mechanism

## Test Strategy

### CI/CD Pipeline Testing

**Validate Quality Gates:**

```bash
# Test coverage enforcement
./vendor/bin/pest --coverage --min=90

# Test PHPStan level 5
./vendor/bin/phpstan analyse --level=5

# Test code style
./vendor/bin/pint --test

# Test JavaScript coverage
npm run test:coverage -- --run --coverage.enabled
```

**Simulate Failures:**

```php
// Create intentional test failure
it('fails intentionally to test CI', function () {
    expect(true)->toBeFalse(); // Should fail
});

// Create intentional coverage gap
class UncoveredClass {
    public function uncoveredMethod() {
        // No tests for this method
    }
}

// Create intentional PHPStan error
function typeMismatch(): string {
    return 123; // Type error
}
```

**Deployment Testing:**

```bash
# Test staging deployment locally
./scripts/ci/deploy.sh staging

# Test migration safety
./scripts/ci/migration-check.sh

# Test rollback mechanism
git checkout HEAD~1
./scripts/ci/deploy.sh staging --rollback
```

### Integration Tests for CI Scripts

**File:** `tests/Feature/CI/CIScriptsTest.php`

```php
<?php

use Illuminate\Support\Facades\Artisan;
use Symfony\Component\Process\Process;

it('validates test coverage script works', function () {
    $process = new Process(['bash', 'scripts/ci/test-coverage.sh']);
    $process->run();

    expect($process->isSuccessful())->toBeTrue()
        ->and($process->getOutput())->toContain('Coverage:');
});

it('validates migration check script works', function () {
    $process = new Process(['bash', 'scripts/ci/migration-check.sh']);
    $process->run();

    expect($process->isSuccessful())->toBeTrue()
        ->and($process->getOutput())->toContain('migration safety checks passed');
});

it('validates performance benchmark script works', function () {
    $process = new Process(['bash', 'scripts/ci/performance-benchmark.sh']);
    $process->run();

    expect($process->isSuccessful())->toBeTrue();
});
```

### Performance Benchmarks

**File:** `tests/Performance/ApiPerformanceTest.php`

```php
<?php

use function Pest\Laravel\get;

it('validates API response time under 200ms', function () {
    $start = microtime(true);

    get('/api/v1/organizations')
        ->assertOk();

    $duration = (microtime(true) - $start) * 1000;

    expect($duration)->toBeLessThan(200);
})->group('performance');

it('validates database query count under threshold', function () {
    DB::enableQueryLog();

    get('/api/v1/servers')
        ->assertOk();

    $queries = count(DB::getQueryLog());

    expect($queries)->toBeLessThan(10);
})->group('performance');
```

## Definition of Done

- [ ] GitHub Actions CI workflow created and active
- [ ] All quality gate jobs configured (linting, tests, security, migrations)
- [ ] PHPStan level 5 enforced with zero errors
- [ ] Test coverage minimum 90% for PHP enforced
- [ ] Test coverage minimum 85% for JavaScript enforced
- [ ] Laravel Pint code style checks passing
- [ ] Composer security audit integrated
- [ ] NPM security audit integrated
- [ ] Snyk security scanning configured
- [ ] CodeQL security scanning enabled
- [ ] Migration safety checks implemented
- [ ] Performance regression tests implemented
- [ ] Multi-database testing (PostgreSQL, Redis) working
- [ ] Browser tests (Dusk) running in CI
- [ ] Staging deployment workflow created
- [ ] Production deployment workflow created with manual approval
- [ ] Rollback mechanism tested and working
- [ ] Branch protection rules configured
- [ ] Required status checks enabled on main branch
- [ ] Deployment environment secrets configured
- [ ] Slack/Discord deployment notifications working
- [ ] CI helper scripts created and tested
- [ ] All scripts have proper error handling
- [ ] Coverage reports uploaded to Codecov
- [ ] Performance benchmarks baselined
- [ ] Documentation updated with CI/CD procedures
- [ ] Team trained on CI/CD workflows
- [ ] At least 3 successful deployments to staging
- [ ] At least 1 successful production deployment test

## Related Tasks

- **Depends on:** Task 76 (Unit tests for enterprise services)
- **Depends on:** Task 77 (Integration tests for workflows)
- **Depends on:** Task 78 (API tests with organization scoping)
- **Depends on:** Task 79 (Dusk browser tests for Vue.js)
- **Depends on:** Task 80 (Performance tests for multi-tenant operations)
- **Enables:** Task 89 (Multi-environment deployment automation)
- **Enables:** Task 90 (Database migration automation with validation)
- **Integrates with:** All previous tasks (validates code quality across entire codebase)
