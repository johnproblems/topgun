---
name: Write administrator guide for organization and license management
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:39:36Z
github: https://github.com/johnproblems/topgun/issues/192
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Write Administrator Guide for Organization and License Management

## Description

Create a comprehensive administrator guide documenting the enterprise organization hierarchy system and license management workflows. This guide serves as the primary reference for system administrators, organization admins, and support staff who manage the multi-tenant Coolify Enterprise platform. It covers the complete organizational structure from Top Branch down to End Users, explains license types and feature flags, provides step-by-step procedures for common administrative tasks, and includes troubleshooting guidance for typical scenarios.

The guide addresses the unique challenges of managing a hierarchical multi-tenant system where organizations have parent-child relationships, users belong to multiple organizations with different roles, and license-based feature access controls organizational capabilities. Unlike standard Coolify documentation which focuses on application deployment, this guide explains the enterprise-specific administrative layer that enables white-label reselling, organizational isolation, and tiered feature access.

**Key Topics Covered:**

1. **Organization Hierarchy Concepts** - Understanding Top Branch, Master Branch, Sub-User, and End User organization types
2. **User Role System** - Organization roles (owner, admin, member, viewer) vs global permissions
3. **License Management** - License types (Starter, Professional, Enterprise, White-Label), activation, validation, feature flags
4. **Administrative Workflows** - Organization creation, user invitations, role assignments, license upgrades
5. **Resource Management** - Quotas, usage tracking, capacity planning per organization
6. **White-Label Configuration** - Enabling white-label features, branding setup, custom domains
7. **Troubleshooting** - Common issues (license validation failures, permission errors, resource quota exceeded)
8. **Best Practices** - Security recommendations, organizational structure design, license tier selection

**Target Audience:**

- **Platform Administrators** - Manage the entire Coolify Enterprise instance
- **Top Branch Admins** - Manage their organization hierarchy and reseller network
- **Master Branch Admins** - Manage sub-users and end-user organizations
- **Support Staff** - Troubleshoot user issues and assist with administrative tasks

**Integration with Existing Documentation:**

This guide complements the existing Coolify documentation (`.cursor/rules/` directory) by focusing specifically on enterprise multi-tenant administration. It references but doesn't duplicate core deployment workflows, instead concentrating on organizational management, licensing, and hierarchical access control that are unique to the enterprise transformation.

**Why This Task Is Important:**

Without clear documentation, administrators struggle to understand the hierarchical model, leading to misconfigured organizations, incorrect license assignments, and permission issues. A comprehensive guide reduces support burden by empowering admins to self-serve, ensures consistent organizational setup across customers, and accelerates onboarding of new administrators. For white-label resellers, this guide is critical for understanding how to manage their customer organizations and apply branding configurations effectively.

The guide also serves as a training resource for new support staff, reducing ramp-up time from weeks to days by providing clear procedures for common tasks. It establishes best practices that prevent security issues like cross-organization data leakage or privilege escalation through role misconfiguration.

## Acceptance Criteria

- [ ] Document covers all four organization types with clear definitions and use cases
- [ ] Explains organization hierarchy relationships (parent-child) with visual diagrams
- [ ] Documents all user roles (owner, admin, member, viewer) with permission matrices
- [ ] Details all license types with feature comparison table
- [ ] Provides step-by-step procedures for 15+ common administrative tasks
- [ ] Includes troubleshooting section with 10+ common issues and resolutions
- [ ] Contains security best practices section with 8+ recommendations
- [ ] Includes CLI command reference for administrative operations
- [ ] Provides API examples for programmatic organization management
- [ ] Contains real-world example scenarios with detailed walkthroughs
- [ ] Includes screenshots and diagrams for complex workflows
- [ ] Cross-references related Coolify documentation appropriately
- [ ] Written in clear, professional language accessible to non-technical admins
- [ ] Structured with table of contents and searchable headings
- [ ] Includes code examples for automation scripts
- [ ] Contains glossary of enterprise-specific terminology
- [ ] Provides quick reference cards for common tasks
- [ ] Includes version compatibility matrix (Laravel, Coolify versions)

## Technical Details

### File Paths

**Documentation:**
- `/home/topgun/topgun/docs/enterprise/admin-guide.md` (new - primary guide)
- `/home/topgun/topgun/docs/enterprise/organization-hierarchy.md` (new - hierarchy deep dive)
- `/home/topgun/topgun/docs/enterprise/license-management.md` (new - licensing deep dive)
- `/home/topgun/topgun/docs/enterprise/troubleshooting.md` (new - troubleshooting reference)

**Supporting Assets:**
- `/home/topgun/topgun/docs/enterprise/diagrams/org-hierarchy.svg` (organization structure diagram)
- `/home/topgun/topgun/docs/enterprise/diagrams/license-flow.svg` (license validation flowchart)
- `/home/topgun/topgun/docs/enterprise/screenshots/` (UI screenshots for procedures)

**Code Examples:**
- `/home/topgun/topgun/docs/enterprise/examples/create-organization.sh` (CLI scripts)
- `/home/topgun/topgun/docs/enterprise/examples/api-organization-management.php` (API examples)

### Documentation Structure

**Main Guide:** `docs/enterprise/admin-guide.md`

```markdown
# Coolify Enterprise Administration Guide

## Table of Contents

1. Introduction
   - About Coolify Enterprise
   - Target Audience
   - Prerequisites
   - Documentation Conventions

2. Organization Hierarchy System
   - Understanding Organization Types
   - Hierarchy Relationships
   - Data Isolation and Scoping
   - Organizational Best Practices

3. User Management
   - User Roles and Permissions
   - Inviting Users to Organizations
   - Managing User Access
   - Role-Based Access Control (RBAC)

4. License Management
   - License Types Overview
   - License Activation Process
   - Feature Flags Explained
   - License Upgrades and Downgrades
   - License Validation Troubleshooting

5. Administrative Workflows
   - Creating Organizations
   - Configuring Organizational Settings
   - Managing Resource Quotas
   - Monitoring Organization Usage
   - Enabling White-Label Features

6. Security and Compliance
   - Security Best Practices
   - Audit Logging
   - Data Privacy Considerations
   - Compliance Requirements

7. Troubleshooting
   - Common Issues and Solutions
   - Error Message Reference
   - Support Escalation Process

8. Appendices
   - Glossary
   - API Reference
   - CLI Command Reference
   - Quick Reference Cards

## Chapter 1: Introduction

### About Coolify Enterprise

Coolify Enterprise transforms the open-source Coolify platform into a multi-tenant, hierarchical deployment system designed for white-label resellers, managed service providers, and enterprise organizations. Unlike standard Coolify which manages servers and applications for a single organization, Coolify Enterprise supports complex organizational hierarchies where Top Branch organizations can create Master Branch children, who in turn manage Sub-Users and End Users.

**Key Enterprise Features:**

- **Hierarchical Organizations**: Four-tier structure (Top Branch → Master Branch → Sub-User → End User)
- **License-Based Feature Control**: Starter, Professional, Enterprise, and White-Label tiers
- **White-Label Branding**: Complete UI customization with custom logos, colors, and domains
- **Resource Quotas**: Per-organization limits on servers, applications, deployments
- **Role-Based Access Control**: Organization-scoped roles with granular permissions
- **Terraform Integration**: Automated infrastructure provisioning across cloud providers
- **Advanced Deployment Strategies**: Rolling updates, blue-green, canary deployments

### Target Audience

This guide is intended for:

- **Platform Administrators** - Responsible for the entire Coolify Enterprise installation
- **Top Branch Administrators** - Managing reseller networks and white-label configurations
- **Master Branch Administrators** - Managing customer organizations and resource allocation
- **Support Staff** - Assisting users with organizational and licensing issues

### Prerequisites

Before using this guide, you should have:

- Access to Coolify Enterprise with administrative privileges
- Basic understanding of Laravel/PHP web applications
- Familiarity with Docker and container orchestration
- Knowledge of organizational hierarchy concepts
- Understanding of role-based access control (RBAC)

### Documentation Conventions

**Code Blocks:**
```bash
# Shell commands prefixed with $
$ php artisan organization:create --type=master_branch

# Output shown without prefix
Organization created successfully: ID 42
```

**UI Elements:**
- Menu items and buttons shown in **bold**: Click **Settings** → **Organizations**
- Field names shown in *italics*: Enter organization name in the *Organization Name* field
- Keyboard shortcuts shown in `code`: Press `Ctrl+S` to save

**Notes and Warnings:**

> **Note:** Informational callouts appear in blockquotes with Note prefix

> **Warning:** Critical information that could cause data loss or security issues

> **Tip:** Helpful suggestions and best practices

## Chapter 2: Organization Hierarchy System

### Understanding Organization Types

Coolify Enterprise implements a four-tier organizational hierarchy designed to support white-label resellers and multi-level customer relationships. Each tier has specific capabilities and restrictions:

#### 1. Top Branch Organization

**Definition:** The highest level in the organizational hierarchy, typically representing a white-label reseller, managed service provider, or large enterprise.

**Capabilities:**
- Create and manage Master Branch child organizations
- Configure global settings inherited by children
- Apply white-label branding visible to all descendants
- Allocate resource quotas to child organizations
- Manage organization-wide billing and subscriptions
- Access consolidated usage reports across all descendants

**Restrictions:**
- Cannot have a parent organization
- Requires Enterprise or White-Label license tier
- Limited to one Top Branch per Coolify Enterprise instance

**Use Cases:**
- White-label reseller selling Coolify under their own brand
- Managed service provider managing multiple customer organizations
- Large enterprise with multiple departments or subsidiaries

**Example Configuration:**
```php
// Creating a Top Branch organization
Organization::create([
    'name' => 'Acme Cloud Platform',
    'type' => 'top_branch',
    'parent_organization_id' => null,
    'slug' => 'acme-cloud',
    'settings' => [
        'white_label_enabled' => true,
        'can_create_children' => true,
        'max_child_organizations' => 100,
    ],
]);
```

#### 2. Master Branch Organization

**Definition:** Mid-level organizations created by Top Branch, representing individual customers or business units.

**Capabilities:**
- Create Sub-User and End User child organizations
- Manage their own users and permissions
- Configure organization-specific settings
- View usage reports for their hierarchy
- Allocate resources to child organizations
- Inherit white-label branding from parent

**Restrictions:**
- Must have a Top Branch parent
- Cannot modify parent's white-label configuration
- Resource quotas limited by parent allocation
- Requires Professional, Enterprise, or White-Label license

**Use Cases:**
- Customer of a white-label reseller
- Department within a large enterprise
- Business unit with independent management

**Example Configuration:**
```php
Organization::create([
    'name' => 'TechCorp Solutions',
    'type' => 'master_branch',
    'parent_organization_id' => $topBranchId,
    'slug' => 'techcorp',
    'settings' => [
        'inherit_branding' => true,
        'can_create_children' => true,
        'max_child_organizations' => 25,
    ],
]);
```

#### 3. Sub-User Organization

**Definition:** Organizations created by Master Branch for delegated management, typically representing teams or projects.

**Capabilities:**
- Manage applications and servers within allocated resources
- Invite users with limited roles
- View organization-specific dashboards
- Create End User child organizations (if permitted)
- Configure application-level settings

**Restrictions:**
- Cannot create additional Sub-User siblings
- Limited administrative capabilities
- Must operate within parent's resource quotas
- Requires Starter or higher license tier

**Use Cases:**
- Development team within a customer organization
- Project-specific resource allocation
- Geographic regional subdivision

#### 4. End User Organization

**Definition:** Leaf-level organizations with no children, representing individual users or smallest organizational units.

**Capabilities:**
- Deploy and manage applications
- Configure application settings
- Monitor application performance
- Manage team members (if licensed)

**Restrictions:**
- Cannot create child organizations
- Minimal administrative features
- Operates within strict resource quotas
- Starter license sufficient for basic usage

**Use Cases:**
- Individual developer or small team
- Single project or application
- Trial/evaluation accounts

### Hierarchy Relationships

**Parent-Child Data Flow:**

```
Top Branch (Acme Cloud Platform)
│
├─ Master Branch (TechCorp Solutions) [inherits branding]
│  │
│  ├─ Sub-User (Engineering Team) [inherits quotas]
│  │  │
│  │  └─ End User (DevOps Project) [isolated resources]
│  │
│  └─ Sub-User (Marketing Team)
│
└─ Master Branch (StartupXYZ) [separate hierarchy]
   │
   └─ End User (Production Environment)
```

**Key Principles:**

1. **Inheritance:** Children inherit branding, settings, and quota limits from parents
2. **Isolation:** Resources are scoped to organization hierarchy, preventing cross-contamination
3. **Aggregation:** Parent organizations see aggregated usage from all descendants
4. **Delegation:** Parents can delegate specific permissions to children

### Data Isolation and Scoping

Every database query in Coolify Enterprise is automatically scoped to the user's organizational context using Laravel global scopes:

**Automatic Scoping Example:**
```php
// User belongs to organization ID 42
Auth::user()->currentOrganization; // Organization #42

// All queries automatically scoped
Server::all(); // Returns only servers owned by org #42
Application::all(); // Returns only apps owned by org #42

// Manual scope override (admin only)
Server::withoutGlobalScope(OrganizationScope::class)->get(); // All servers
```

**Cross-Organization Access:**

- **Prohibited by Default:** Users cannot access resources from other organizations
- **Parent Access:** Parents can view (read-only) descendant resources
- **Admin Override:** Platform admins can bypass scoping for support tasks

**Security Implementation:**

```php
// Middleware ensures organization context
class EnsureOrganizationContext
{
    public function handle($request, Closure $next)
    {
        if (!auth()->user()->currentOrganization) {
            return redirect()->route('organization.select');
        }

        // Set global organization context
        app()->instance('current_organization', auth()->user()->currentOrganization);

        return $next($request);
    }
}
```

### Organizational Best Practices

#### 1. Structure Design

**Flat vs Hierarchical:**
- **Flat:** Single Top Branch with many Master Branch children (simpler, less overhead)
- **Hierarchical:** Deep nesting for complex business structures (more control, more complexity)

**Recommendation:** Start flat, add hierarchy only when organizational separation is required

#### 2. Naming Conventions

- **Slugs:** Use URL-friendly identifiers (`acme-cloud`, not `Acme Cloud Platform`)
- **Display Names:** Use full business names for clarity
- **Consistency:** Maintain naming patterns across hierarchy levels

**Example:**
```
Top Branch: acme-cloud (Acme Cloud Platform)
├─ Master: acme-techcorp (TechCorp Solutions)
│  └─ Sub-User: acme-techcorp-eng (Engineering Team)
└─ Master: acme-startupxyz (StartupXYZ)
```

#### 3. Resource Allocation

**Quota Planning:**
- **Top Branch:** Allocate 80% of total resources to children, reserve 20% for overhead
- **Master Branch:** Distribute quotas based on customer tier/contract
- **Sub-User:** Provide just enough for team needs, avoid over-provisioning

**Monitoring:**
- Set up alerts at 75% quota utilization
- Review usage weekly for optimization opportunities
- Plan capacity increases before hitting limits

## Chapter 3: User Management

### User Roles and Permissions

Coolify Enterprise implements **organization-scoped roles** where a single user can have different roles across multiple organizations.

**Role Hierarchy (highest to lowest privilege):**

1. **Owner** - Full control, cannot be removed by others
2. **Admin** - Nearly full control, can manage users and settings
3. **Member** - Standard access, can deploy applications
4. **Viewer** - Read-only access, cannot make changes

**Permission Matrix:**

| Action | Owner | Admin | Member | Viewer |
|--------|-------|-------|--------|--------|
| View resources | ✅ | ✅ | ✅ | ✅ |
| Deploy applications | ✅ | ✅ | ✅ | ❌ |
| Manage servers | ✅ | ✅ | ⚠️ Limited | ❌ |
| Invite users | ✅ | ✅ | ❌ | ❌ |
| Modify settings | ✅ | ✅ | ❌ | ❌ |
| Manage billing | ✅ | ⚠️ View only | ❌ | ❌ |
| Delete organization | ✅ | ❌ | ❌ | ❌ |
| Manage white-label | ✅ | ✅ | ❌ | ❌ |
| Create child orgs | ✅ | ✅ | ❌ | ❌ |

**Role Assignment Examples:**

```php
// User has different roles in different organizations
$user->organizations->map(fn($org) => [
    'organization' => $org->name,
    'role' => $org->pivot->role,
]);

// Output:
[
    ['organization' => 'Acme Cloud Platform', 'role' => 'owner'],
    ['organization' => 'TechCorp Solutions', 'role' => 'admin'],
    ['organization' => 'Engineering Team', 'role' => 'member'],
]
```

### Inviting Users to Organizations

**Invitation Workflow:**

1. Admin generates invitation link or email
2. User receives invitation with organization context
3. User accepts invitation (creates account if needed)
4. System assigns specified role in organization
5. User can now access organization resources

**Via UI:**

1. Navigate to **Settings** → **Organizations** → **[Organization Name]** → **Team**
2. Click **Invite User**
3. Enter email address
4. Select role from dropdown
5. Optionally add custom message
6. Click **Send Invitation**

**Via Artisan Command:**

```bash
$ php artisan organization:invite \
    --organization=acme-cloud \
    --email=john@example.com \
    --role=admin \
    --message="Welcome to Acme Cloud Platform"

Invitation sent successfully to john@example.com
Invitation link: https://coolify.acme.com/invite/a1b2c3d4
```

**Via API:**

```php
POST /api/v1/organizations/{organization}/invitations
Content-Type: application/json
Authorization: Bearer {api_token}

{
    "email": "john@example.com",
    "role": "admin",
    "message": "Welcome to Acme Cloud Platform",
    "expires_in_days": 7
}

// Response
{
    "success": true,
    "invitation": {
        "id": 123,
        "email": "john@example.com",
        "role": "admin",
        "token": "a1b2c3d4e5f6",
        "expires_at": "2025-01-20T12:00:00Z",
        "invitation_url": "https://coolify.acme.com/invite/a1b2c3d4"
    }
}
```

### Managing User Access

**Changing User Roles:**

```bash
# Via Artisan
$ php artisan organization:change-role \
    --organization=acme-cloud \
    --user=john@example.com \
    --role=member

Role updated successfully
```

**Removing Users:**

```bash
# Via Artisan
$ php artisan organization:remove-user \
    --organization=acme-cloud \
    --user=john@example.com \
    --confirm

User john@example.com removed from organization 'Acme Cloud Platform'
```

**Via API:**

```php
// Update role
PUT /api/v1/organizations/{organization}/users/{user}
{
    "role": "member"
}

// Remove user
DELETE /api/v1/organizations/{organization}/users/{user}
```

### Role-Based Access Control (RBAC)

**Laravel Policy Implementation:**

```php
// OrganizationPolicy.php
public function update(User $user, Organization $organization): bool
{
    return $user->hasRoleInOrganization($organization, ['owner', 'admin']);
}

public function delete(User $user, Organization $organization): bool
{
    return $user->hasRoleInOrganization($organization, 'owner');
}

// Usage in controllers
$this->authorize('update', $organization);
```

**Blade Directives:**

```blade
@can('update', $organization)
    <button>Edit Organization</button>
@endcan

@canany(['owner', 'admin'], $organization)
    <a href="{{ route('organization.settings', $organization) }}">Settings</a>
@endcanany
```

## Chapter 4: License Management

### License Types Overview

Coolify Enterprise offers four license tiers with progressively more features:

**1. Starter License**

**Target Audience:** Individual developers, small teams, evaluation users

**Key Features:**
- 1 organization
- Up to 5 servers
- Up to 10 applications
- 50 deployments/month
- Standard deployment strategies
- Email support

**Restrictions:**
- ❌ No white-label branding
- ❌ No child organizations
- ❌ No Terraform provisioning
- ❌ No advanced deployment strategies
- ❌ No priority support

**Pricing:** $29/month

---

**2. Professional License**

**Target Audience:** Growing businesses, professional development teams

**Key Features:**
- 5 organizations
- Up to 25 servers
- Up to 100 applications
- Unlimited deployments
- Rolling updates strategy
- Advanced monitoring
- Ticket support (24-hour SLA)

**Restrictions:**
- ❌ Limited white-label (logo only)
- ❌ No reseller capabilities
- ⚠️ Limited child organizations (up to 5)

**Pricing:** $99/month

---

**3. Enterprise License**

**Target Audience:** Large enterprises, ISVs, managed service providers

**Key Features:**
- Unlimited organizations
- Unlimited servers
- Unlimited applications
- Unlimited deployments
- All deployment strategies (rolling, blue-green, canary)
- Terraform infrastructure provisioning
- Advanced capacity management
- Priority support (4-hour SLA)
- Dedicated account manager

**Restrictions:**
- ⚠️ Partial white-label (cannot remove Coolify attribution)
- ⚠️ Custom domains require additional configuration

**Pricing:** $499/month

---

**4. White-Label License**

**Target Audience:** White-label resellers, platform providers

**Key Features:**
- Everything in Enterprise, plus:
- ✅ Complete white-label branding
- ✅ Remove all Coolify branding
- ✅ Custom domain with SSL
- ✅ Reseller capabilities
- ✅ Multi-level organization hierarchy
- ✅ Branded email templates
- ✅ Custom favicon and logo
- ✅ Custom color scheme
- ✅ White-label API documentation
- 24/7 priority support (1-hour SLA)

**Pricing:** Custom (starts at $1,499/month)

### License Activation Process

**Step 1: Obtain License Key**

Purchase license from Coolify Enterprise portal or sales team. Receive:
- License key (format: `CLFY-XXXX-XXXX-XXXX-XXXX`)
- Organization ID
- Activation instructions

**Step 2: Activate via UI**

1. Navigate to **Settings** → **License**
2. Click **Activate License**
3. Enter license key in *License Key* field
4. Optionally enter domain for domain-locked licenses
5. Click **Activate**

System validates license with Coolify licensing server and enables features.

**Step 3: Activate via Artisan**

```bash
$ php artisan license:activate \
    --key=CLFY-XXXX-XXXX-XXXX-XXXX \
    --domain=coolify.acme.com

Validating license key...
✓ License valid
✓ License activated successfully

License Details:
- Type: White-Label
- Organizations: Unlimited
- Servers: Unlimited
- Expires: 2026-01-01
- Features: white_label, terraform, advanced_deployments, priority_support
```

**Step 4: Verify Activation**

```bash
$ php artisan license:status

License Status:
✓ Active
Type: White-Label
Organization: Acme Cloud Platform
Expires: 2026-01-01 (342 days remaining)

Enabled Features:
✓ white_label
✓ terraform_provisioning
✓ advanced_deployments
✓ capacity_management
✓ priority_support
✓ reseller_capabilities
```

### Feature Flags Explained

License validation controls feature access through boolean feature flags stored in `enterprise_licenses.feature_flags` JSONB column.

**Core Feature Flags:**

```php
'feature_flags' => [
    // Organization features
    'white_label' => true,                  // Complete UI customization
    'child_organizations' => true,          // Can create sub-organizations
    'reseller' => true,                     // Reseller capabilities

    // Infrastructure features
    'terraform_provisioning' => true,       // Auto infrastructure provisioning
    'capacity_management' => true,          // Intelligent server selection
    'advanced_monitoring' => true,          // Real-time metrics dashboards

    // Deployment features
    'rolling_updates' => true,              // Rolling deployment strategy
    'blue_green' => true,                   // Blue-green strategy
    'canary' => true,                       // Canary strategy
    'auto_rollback' => true,                // Automatic rollback on failure

    // Resource limits
    'max_organizations' => -1,              // -1 = unlimited
    'max_servers' => -1,
    'max_applications' => -1,
    'max_deployments_per_month' => -1,

    // Support features
    'priority_support' => true,             // Priority support queue
    'dedicated_account_manager' => true,    // Dedicated AM
]
```

**Runtime Feature Checks:**

```php
// In controllers
if (!auth()->user()->currentOrganization->hasFeature('white_label')) {
    abort(403, 'White-label feature not available in your license tier');
}

// In Blade templates
@if($organization->hasFeature('terraform_provisioning'))
    <a href="{{ route('terraform.provision') }}">Provision Infrastructure</a>
@endif

// In services
public function provisionInfrastructure(Organization $org, array $config)
{
    $this->ensureFeatureEnabled($org, 'terraform_provisioning');

    // ... provisioning logic
}
```

### License Upgrades and Downgrades

**Upgrade Process:**

1. **Purchase Higher Tier:** Contact sales or upgrade via portal
2. **Receive New License Key:** New key with upgraded features
3. **Activate New License:** Follow activation process
4. **Old License Auto-Deactivated:** Previous license invalidated
5. **Features Enabled:** New features immediately available

**Example Upgrade (Professional → Enterprise):**

```bash
$ php artisan license:upgrade \
    --new-key=CLFY-ENT-XXXX-XXXX-XXXX \
    --confirm

Validating new license...
✓ New license valid: Enterprise tier

Upgrade Summary:
From: Professional (expires 2025-06-01)
To: Enterprise (expires 2026-01-01)

New Features:
✓ Terraform provisioning
✓ Advanced capacity management
✓ Blue-green deployments
✓ Canary deployments
✓ Priority support (4-hour SLA)

Proceed with upgrade? [yes/no]: yes

✓ License upgraded successfully
✓ New features enabled
✓ Old license deactivated
```

**Downgrade Process:**

1. **Warning:** Features will be disabled, resources may exceed new limits
2. **Resource Audit:** Review current usage vs new tier limits
3. **Reduce Resources:** Delete/transfer resources to comply with new limits
4. **Activate Lower Tier:** Follow standard activation

**Downgrade Example (Enterprise → Professional):**

```bash
$ php artisan license:downgrade \
    --new-key=CLFY-PRO-XXXX-XXXX-XXXX \
    --force

⚠️ WARNING: Downgrade will disable features and enforce new limits

Current Usage:
- Organizations: 8 (new limit: 5)
- Servers: 30 (new limit: 25)
- Terraform deployments: 5 (feature will be disabled)

Disabled Features After Downgrade:
✗ Terraform provisioning
✗ Blue-green deployments
✗ Canary deployments
✗ Advanced capacity management

Required Actions:
1. Reduce organizations from 8 to 5 (delete 3)
2. Reduce servers from 30 to 25 (delete 5)
3. Terraform deployments will be preserved but read-only

Proceed? This action cannot be undone. [yes/no]: no

Downgrade cancelled.
```

### License Validation Troubleshooting

**Issue 1: License Validation Failed**

**Symptoms:**
- Error: "License validation failed: Invalid license key"
- Features disabled after working previously

**Causes:**
- Incorrect license key entry (typo)
- License expired
- Domain mismatch (for domain-locked licenses)
- Licensing server unreachable

**Resolution:**

```bash
# Check license status
$ php artisan license:status

License Status:
✗ Invalid
Error: License key format invalid

# Verify license key format
# Correct format: CLFY-XXXX-XXXX-XXXX-XXXX (20 characters, 5 groups)

# Re-activate with correct key
$ php artisan license:activate --key=CLFY-ABCD-1234-EFGH-5678

# If domain-locked, specify domain
$ php artisan license:activate \
    --key=CLFY-ABCD-1234-EFGH-5678 \
    --domain=coolify.acme.com
```

**Issue 2: Feature Not Available**

**Symptoms:**
- UI elements hidden or disabled
- 403 Forbidden errors when accessing features
- Message: "Feature not available in your license tier"

**Resolution:**

```bash
# Check current license features
$ php artisan license:features

Enabled Features (Professional Tier):
✓ rolling_updates
✓ advanced_monitoring
✓ child_organizations (limit: 5)

Disabled Features:
✗ white_label (requires Enterprise or White-Label tier)
✗ terraform_provisioning (requires Enterprise or White-Label tier)
✗ blue_green (requires Enterprise or White-Label tier)

# Upgrade to enable desired features
$ php artisan license:upgrade --new-key=CLFY-ENT-XXXX-XXXX-XXXX
```

**Issue 3: License Expired**

**Symptoms:**
- Error: "License expired on YYYY-MM-DD"
- All enterprise features disabled
- Platform reverts to basic Coolify functionality

**Resolution:**

```bash
# Check expiration
$ php artisan license:status

License Status:
✗ Expired
Expired on: 2024-12-31 (35 days ago)

# Renew license (contact sales or purchase renewal)
# Activate renewed license
$ php artisan license:activate --key=CLFY-RENEWED-KEY-HERE

# Verify renewal
$ php artisan license:status

License Status:
✓ Active
Expires: 2026-01-01 (365 days remaining)
```

**Issue 4: Resource Quota Exceeded**

**Symptoms:**
- Error: "Organization quota exceeded: Cannot create more servers"
- Cannot create new resources despite having available infrastructure
- License shows limits exceeded

**Resolution:**

```bash
# Check current usage vs limits
$ php artisan license:usage

License Usage (Professional Tier):
Organizations: 5/5 (100%) ⚠️
Servers: 23/25 (92%)
Applications: 87/100 (87%)
Deployments this month: 342/∞

# Option 1: Delete unused resources
$ php artisan organization:delete --id=8 --confirm

# Option 2: Upgrade to higher tier
$ php artisan license:upgrade --new-key=CLFY-ENT-KEY

# Option 3: Request limit increase (Enterprise tier only)
# Contact support for custom quota adjustment
```

## Chapter 5: Administrative Workflows

### Workflow 1: Creating a New Top Branch Organization

**Scenario:** Set up a new white-label reseller with complete branding control.

**Prerequisites:**
- White-Label license activated
- Admin access to platform
- Branding assets prepared (logo, colors, domain)

**Step-by-Step:**

1. **Create Organization via Artisan**

```bash
$ php artisan organization:create \
    --type=top_branch \
    --name="Acme Cloud Platform" \
    --slug=acme-cloud \
    --owner-email=admin@acme.com

✓ Organization created successfully
Organization ID: 42
Organization Slug: acme-cloud
Owner: admin@acme.com (invitation sent)
```

2. **Activate License for Organization**

```bash
$ php artisan license:activate \
    --organization=42 \
    --key=CLFY-WL-XXXX-XXXX-XXXX \
    --domain=coolify.acme.com

✓ License activated for organization 'Acme Cloud Platform'
Features enabled: white_label, reseller, terraform, all deployment strategies
```

3. **Configure White-Label Branding**

```bash
# Upload logo
$ php artisan branding:upload-logo \
    --organization=42 \
    --logo=/path/to/acme-logo.png \
    --type=primary

✓ Logo uploaded and optimized
Generated favicon sizes: 16x16, 32x32, 180x180, 192x192, 512x512

# Set color scheme
$ php artisan branding:set-colors \
    --organization=42 \
    --primary="#1E40AF" \
    --secondary="#10B981" \
    --accent="#F59E0B"

✓ Color scheme updated
✓ CSS compiled and cached

# Set platform name
$ php artisan branding:set-platform-name \
    --organization=42 \
    --name="Acme Cloud Platform"

✓ Platform name updated
✓ Email templates regenerated
```

4. **Configure Custom Domain**

```bash
# Set custom domain
$ php artisan domain:configure \
    --organization=42 \
    --domain=coolify.acme.com \
    --verify

⏳ Verifying DNS configuration...
✓ DNS A record found: 203.0.113.10
✓ Domain ownership verified

⏳ Provisioning SSL certificate...
✓ Let's Encrypt certificate issued
✓ Certificate installed

✓ Custom domain configured successfully
Access platform at: https://coolify.acme.com
```

5. **Verify Configuration**

```bash
$ php artisan organization:show --id=42

Organization Details:
Name: Acme Cloud Platform
Type: Top Branch
Slug: acme-cloud
Domain: https://coolify.acme.com

License:
Type: White-Label
Status: Active
Expires: 2026-01-01

Branding:
✓ Custom logo configured
✓ Color scheme applied
✓ Favicon generated (all sizes)
✓ Custom domain active
✓ SSL certificate valid

Features:
✓ White-label branding
✓ Reseller capabilities
✓ Terraform provisioning
✓ All deployment strategies
✓ Priority support

Resource Quotas:
Organizations: 0/unlimited
Servers: 0/unlimited
Applications: 0/unlimited
```

6. **Access White-Labeled Platform**

Visit https://coolify.acme.com to see fully branded platform with:
- Acme logo in header
- Acme color scheme throughout UI
- "Acme Cloud Platform" as platform name
- No Coolify branding visible
- Custom favicon in browser tab

### Workflow 2: Creating Master Branch Organization for Customer

**Scenario:** Top Branch admin (Acme Cloud) creates customer organization.

**Step-by-Step:**

1. **Create Master Branch Organization**

```bash
$ php artisan organization:create \
    --type=master_branch \
    --parent=42 \
    --name="TechCorp Solutions" \
    --slug=techcorp \
    --owner-email=admin@techcorp.com

✓ Organization created successfully
Organization ID: 43
Parent: Acme Cloud Platform (ID: 42)
Owner: admin@techcorp.com (invitation sent)

Inherited Settings:
✓ Branding from parent
✓ White-label configuration
✓ Platform name: Acme Cloud Platform
```

2. **Assign License**

```bash
$ php artisan license:assign \
    --organization=43 \
    --type=enterprise \
    --duration=12months \
    --auto-renew

✓ Enterprise license assigned to TechCorp Solutions
Expires: 2026-01-15
Features: terraform, advanced_deployments, capacity_management

Resource Quotas Allocated:
Organizations: 0/25
Servers: 0/100
Applications: 0/500
```

3. **Set Resource Quotas**

```bash
$ php artisan organization:set-quota \
    --organization=43 \
    --servers=100 \
    --applications=500 \
    --child-organizations=25

✓ Resource quotas updated for TechCorp Solutions

Quota Summary:
Max Servers: 100
Max Applications: 500
Max Child Organizations: 25
Max Deployments/Month: Unlimited
```

4. **Notify Customer**

```bash
$ php artisan organization:send-welcome-email \
    --organization=43 \
    --template=master-branch-welcome

✓ Welcome email sent to admin@techcorp.com

Email includes:
- Login instructions
- Organization details
- License information
- Resource quotas
- Getting started guide
- Support contact information
```

### Workflow 3: Managing User Roles Across Organizations

**Scenario:** User needs different access levels in multiple organizations.

**Current State:**
- john@example.com is Owner of his personal organization
- Needs to be Admin in TechCorp Solutions
- Needs to be Member in Engineering Team

**Step-by-Step:**

1. **Invite to TechCorp Solutions as Admin**

```bash
$ php artisan organization:invite \
    --organization=43 \
    --email=john@example.com \
    --role=admin

✓ Invitation sent to john@example.com
User will have 'admin' role in TechCorp Solutions
```

2. **User Accepts Invitation**

User clicks invitation link, system assigns admin role in organization 43.

3. **Invite to Engineering Team as Member**

```bash
$ php artisan organization:invite \
    --organization=45 \
    --email=john@example.com \
    --role=member

✓ Invitation sent to john@example.com
User will have 'member' role in Engineering Team
```

4. **Verify User's Multi-Org Access**

```bash
$ php artisan user:organizations --email=john@example.com

User: john@example.com

Organizations:
1. Personal Org (ID: 40) - Role: owner
2. TechCorp Solutions (ID: 43) - Role: admin
3. Engineering Team (ID: 45) - Role: member

Default Organization: Personal Org (ID: 40)
```

5. **User Switches Organization Context**

```bash
# Via CLI (for testing)
$ php artisan user:switch-organization \
    --user=john@example.com \
    --organization=43

✓ Switched to organization: TechCorp Solutions
Current role: admin
```

In UI, user selects organization from dropdown in header:
- Click **Organization Dropdown** → Select **TechCorp Solutions**
- UI updates to show TechCorp resources
- Permissions reflect admin role

### Workflow 4: Provisioning Infrastructure with Terraform

**Scenario:** Provision AWS EC2 instances for new customer deployment.

**Prerequisites:**
- Enterprise or White-Label license
- AWS credentials configured
- Terraform feature enabled

**Step-by-Step:**

1. **Add Cloud Provider Credentials**

```bash
$ php artisan cloud:add-credentials \
    --provider=aws \
    --organization=43 \
    --access-key=AKIAIOSFODNN7EXAMPLE \
    --secret-key=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY \
    --region=us-east-1 \
    --name="AWS Production Account"

✓ AWS credentials saved and encrypted
Credential ID: 12
Validation: ✓ Passed
```

2. **Create Terraform Deployment Configuration**

```bash
$ php artisan terraform:create-deployment \
    --organization=43 \
    --credential=12 \
    --template=aws-ec2 \
    --name="Production Server Cluster" \
    --config='{"instance_type":"t3.medium","instance_count":3,"region":"us-east-1"}'

✓ Terraform deployment created
Deployment ID: 100
Template: aws-ec2
Status: pending
```

3. **Execute Terraform Provisioning**

```bash
$ php artisan terraform:provision --deployment=100

⏳ Initializing Terraform...
✓ Terraform initialized

⏳ Planning infrastructure changes...
✓ Plan complete: 5 resources to add, 0 to change, 0 to destroy

Resources to create:
- aws_vpc.main
- aws_subnet.public
- aws_security_group.ssh
- aws_instance.server[0]
- aws_instance.server[1]
- aws_instance.server[2]

Proceed with apply? [yes/no]: yes

⏳ Provisioning infrastructure...
✓ aws_vpc.main created (12s)
✓ aws_subnet.public created (8s)
✓ aws_security_group.ssh created (5s)
✓ aws_instance.server[0] created (45s)
✓ aws_instance.server[1] created (43s)
✓ aws_instance.server[2] created (44s)

✓ Infrastructure provisioning complete (2m 15s)

Outputs:
server_ips: ["54.1.2.3", "54.1.2.4", "54.1.2.5"]
vpc_id: vpc-0abc123
```

4. **Auto-Register Servers in Coolify**

```bash
$ php artisan terraform:register-servers --deployment=100

⏳ Registering servers from Terraform outputs...
✓ Server 1 registered (54.1.2.3) - ID: 200
✓ Server 2 registered (54.1.2.4) - ID: 201
✓ Server 3 registered (54.1.2.5) - ID: 202

⏳ Installing Docker on servers...
✓ Docker installed on 54.1.2.3
✓ Docker installed on 54.1.2.4
✓ Docker installed on 54.1.2.5

⏳ Verifying server connectivity...
✓ All servers reachable and ready

✓ Server registration complete
Servers ready for application deployments
```

5. **Verify Infrastructure**

```bash
$ php artisan terraform:show-deployment --id=100

Terraform Deployment Details:
ID: 100
Name: Production Server Cluster
Status: completed
Provider: AWS
Region: us-east-1

Infrastructure:
✓ 3 EC2 instances (t3.medium)
✓ 1 VPC
✓ 1 subnet
✓ 1 security group

Registered Servers:
1. server-200 (54.1.2.3) - Status: ready
2. server-201 (54.1.2.4) - Status: ready
3. server-202 (54.1.2.5) - Status: ready

Total Cost: ~$75/month (estimate)
```

### Workflow 5: Monitoring and Managing Resource Quotas

**Scenario:** Organization approaching resource limits, need to monitor and adjust.

**Step-by-Step:**

1. **Check Current Usage**

```bash
$ php artisan organization:usage --id=43

Organization: TechCorp Solutions (ID: 43)
License: Enterprise

Resource Usage:
Servers: 87/100 (87%) ⚠️
Applications: 423/500 (85%)
Child Organizations: 18/25 (72%)
Deployments (this month): 1,234/unlimited

Storage: 487GB/1TB (48%)
Bandwidth: 2.3TB/10TB (23%)

⚠️ Warning: Approaching server limit
Recommendation: Upgrade to higher tier or delete unused servers
```

2. **Identify Underutilized Servers**

```bash
$ php artisan server:analyze-usage \
    --organization=43 \
    --threshold=20 \
    --days=30

Underutilized Servers (< 20% average CPU over 30 days):

Server ID | Name | Avg CPU | Avg Memory | Last Deploy | Recommendation
----------|------|---------|------------|-------------|---------------
205 | staging-old | 5% | 12% | 45 days ago | Delete
207 | test-server-3 | 8% | 15% | 60 days ago | Delete
212 | backup-srv | 3% | 8% | 90 days ago | Delete
218 | dev-temp | 12% | 18% | 30 days ago | Consider deletion

Total underutilized: 4 servers
Potential savings: ~$120/month
```

3. **Clean Up Unused Resources**

```bash
# Delete staging server (no recent deployments)
$ php artisan server:delete --id=205 --confirm

⚠️ Warning: This will delete server 'staging-old' and all associated resources

Server Details:
ID: 205
Name: staging-old
IP: 54.1.2.10
Applications: 2 (both inactive)
Last deployment: 45 days ago

Proceed? [yes/no]: yes

✓ Applications backed up
✓ Server deleted
✓ Resources freed

Updated Usage:
Servers: 86/100 (86%)
```

4. **Set Up Usage Alerts**

```bash
$ php artisan organization:configure-alerts \
    --organization=43 \
    --alert-at=90 \
    --notify-email=admin@techcorp.com,ops@techcorp.com

✓ Usage alerts configured

Alert Rules:
- Trigger: 90% of any resource quota
- Notify: admin@techcorp.com, ops@techcorp.com
- Frequency: Daily digest
- Channels: Email, Slack (if configured)
```

5. **Request Quota Increase (Enterprise Only)**

```bash
$ php artisan organization:request-quota-increase \
    --organization=43 \
    --servers=150 \
    --reason="Expanding production capacity for new product launch"

✓ Quota increase request submitted
Request ID: QI-1234

Request Details:
Organization: TechCorp Solutions
Current Limit: 100 servers
Requested: 150 servers
Reason: Expanding production capacity for new product launch
Status: Pending approval

Estimated approval time: 24-48 hours (Enterprise SLA)
You will be notified at admin@techcorp.com when approved.
```

## Chapter 6: Security and Compliance

### Security Best Practices

#### 1. Credential Management

**DO:**
- ✅ Rotate cloud provider credentials every 90 days
- ✅ Use separate credentials for each environment (dev, staging, prod)
- ✅ Encrypt all stored credentials with Laravel encryption
- ✅ Audit credential access logs regularly
- ✅ Revoke credentials immediately when team members leave

**DON'T:**
- ❌ Share credentials across multiple organizations
- ❌ Store credentials in plaintext configuration files
- ❌ Commit credentials to version control
- ❌ Use root/admin cloud account credentials
- ❌ Grant excessive permissions (follow least privilege)

**Implementation:**

```bash
# Rotate AWS credentials
$ php artisan cloud:rotate-credentials \
    --credential=12 \
    --new-access-key=AKIAIOSFODNN7NEWKEY \
    --new-secret-key=wJalrXUtnFEMI/K7MDENG/bPxRfiNEWKEY

✓ Credentials rotated successfully
✓ Old credentials revoked
✓ All dependent resources updated

# Audit credential usage
$ php artisan cloud:audit-credentials --credential=12

Credential Audit Report:
Credential ID: 12
Provider: AWS
Last Rotated: 2024-12-15 (45 days ago) ⚠️
Access Count (30 days): 234

Recent Access:
- 2025-01-15 14:32 - Terraform provisioning (user: john@techcorp.com)
- 2025-01-15 10:15 - Terraform provisioning (user: jane@techcorp.com)
- 2025-01-14 16:45 - Server registration (system)

⚠️ Recommendation: Rotate credentials (> 30 days old)
```

#### 2. Role-Based Access Control

**Principle of Least Privilege:**

- Grant minimum permissions required for job function
- Use viewer role for non-technical stakeholders
- Limit owner role to 1-2 trusted individuals
- Review and audit roles quarterly

**Role Assignment Matrix:**

| User Type | Recommended Role | Rationale |
|-----------|------------------|-----------|
| CEO/Business Owner | Viewer | Needs visibility, not technical access |
| CTO/VP Engineering | Owner | Full control for technical leadership |
| Engineering Manager | Admin | Manage team and resources |
| Senior Developer | Member | Deploy and manage applications |
| Junior Developer | Member | Deploy under supervision |
| DevOps Engineer | Admin | Manage infrastructure |
| Support Staff | Viewer | Read-only for troubleshooting |
| Contractor | Member (temporary) | Limited access, revoke on completion |

**Example:**

```bash
# Assign appropriate roles
$ php artisan organization:bulk-assign-roles \
    --organization=43 \
    --roles='[
        {"email":"ceo@techcorp.com","role":"viewer"},
        {"email":"cto@techcorp.com","role":"owner"},
        {"email":"manager@techcorp.com","role":"admin"},
        {"email":"dev1@techcorp.com","role":"member"},
        {"email":"dev2@techcorp.com","role":"member"}
    ]'

✓ Roles assigned successfully

Summary:
Owners: 1 (cto@techcorp.com)
Admins: 1 (manager@techcorp.com)
Members: 2 (dev1@, dev2@)
Viewers: 1 (ceo@techcorp.com)
```

#### 3. Network Security

**Firewall Rules:**

```bash
# Configure organization firewall policies
$ php artisan organization:set-firewall-policy \
    --organization=43 \
    --policy='[
        {"port":22,"source":"203.0.113.0/24","description":"SSH from office"},
        {"port":443,"source":"0.0.0.0/0","description":"HTTPS public"},
        {"port":80,"source":"0.0.0.0/0","description":"HTTP public"}
    ]'

✓ Firewall policy updated
Applied to: 86 servers

Security Rules:
✓ SSH restricted to office network (203.0.113.0/24)
✓ HTTPS open to public
✓ HTTP open to public
✓ All other ports blocked
```

**VPN Recommendations:**

- Use VPN for SSH access to production servers
- Implement 2FA for VPN authentication
- Audit VPN access logs weekly

#### 4. Audit Logging

**Enable Comprehensive Logging:**

```bash
$ php artisan organization:enable-audit-logging \
    --organization=43 \
    --events=all \
    --retention=90days

✓ Audit logging enabled

Logged Events:
✓ User authentication
✓ Role changes
✓ Resource creation/deletion
✓ Configuration changes
✓ License modifications
✓ Deployment activities
✓ API access

Retention: 90 days
Storage: database + S3 archive
```

**Review Logs:**

```bash
$ php artisan organization:audit-log \
    --organization=43 \
    --since=7days \
    --filter=security

Security Audit Log (Last 7 Days):

2025-01-15 14:32:15 - User Login
User: john@techcorp.com
IP: 203.0.113.45
Status: Success

2025-01-15 10:15:42 - Role Changed
Actor: admin@techcorp.com
Target: contractor@external.com
Old Role: admin
New Role: member
Reason: Contract completed

2025-01-14 16:45:03 - API Key Created
Actor: devops@techcorp.com
Scope: read:servers, write:deployments
Expires: 2025-04-15

⚠️ 2025-01-13 22:15:30 - Failed Login Attempt
User: unknown@example.com
IP: 192.0.2.100
Reason: Invalid password (3 attempts)
Action: IP temporarily blocked
```

#### 5. Data Encryption

**Encryption at Rest:**

- All cloud provider credentials encrypted with AES-256
- Terraform state files encrypted before database storage
- SSH private keys encrypted with organization-specific keys
- Database encryption enabled (Laravel encryption)

**Encryption in Transit:**

- HTTPS enforced for all web traffic
- SSH with key-based authentication only
- API communication over TLS 1.3
- Inter-service communication encrypted

**Key Management:**

```bash
# Rotate encryption keys
$ php artisan key:rotate --graceful

⏳ Generating new encryption key...
✓ New key generated

⏳ Re-encrypting sensitive data with new key...
✓ Credentials re-encrypted (45 records)
✓ State files re-encrypted (123 records)
✓ SSH keys re-encrypted (67 records)

✓ Key rotation complete
Old key: Securely archived for 30 days (emergency decryption)
New key: Active
```

#### 6. Incident Response

**Security Incident Workflow:**

1. **Detection** - Automated alerts, user reports, monitoring
2. **Containment** - Isolate affected resources, revoke compromised credentials
3. **Investigation** - Review logs, determine scope and impact
4. **Remediation** - Patch vulnerabilities, restore from backups
5. **Prevention** - Update policies, implement controls

**Emergency Commands:**

```bash
# Lock down organization (emergency)
$ php artisan organization:emergency-lockdown --id=43

⚠️ EMERGENCY LOCKDOWN ACTIVATED

Actions Taken:
✓ All user sessions terminated
✓ API keys suspended
✓ Cloud provider credentials rotated
✓ SSH access disabled
✓ Deployments blocked
✓ Notifications sent to all admins

Organization Status: LOCKED
Unlock command: php artisan organization:unlock --id=43 --confirm

# Revoke compromised credentials
$ php artisan cloud:revoke-credentials --id=12 --emergency

⚠️ EMERGENCY CREDENTIAL REVOCATION

✓ AWS credentials revoked at provider
✓ All active sessions terminated
✓ Terraform deployments paused
✓ Incident logged

Generate new credentials and update:
$ php artisan cloud:rotate-credentials --credential=12
```

### Compliance Requirements

#### GDPR Compliance (EU Customers)

**Data Subject Rights:**

```bash
# Export user data (GDPR data portability)
$ php artisan gdpr:export-user-data \
    --email=john@example.com \
    --format=json

✓ User data exported

Exported Data:
- Profile information
- Organization memberships
- Deployment history
- Audit logs
- API usage statistics

Output: /tmp/gdpr-export-john-20250115.json
```

**Right to Erasure:**

```bash
# Delete user account (GDPR right to be forgotten)
$ php artisan gdpr:delete-user \
    --email=john@example.com \
    --anonymize-logs

⚠️ This will permanently delete user account

User: john@example.com
Organizations: 3
Resources: 12 applications, 5 servers
Logs: 1,234 entries

Action:
✓ User account deleted
✓ Personal data removed
✓ Logs anonymized (replaced with UUID)
✓ Organization memberships transferred to admin

Deletion certificate: GDPR-DEL-20250115-A1B2C3
```

#### SOC 2 Compliance

**Required Controls:**

1. **Access Control** - RBAC with quarterly reviews
2. **Audit Logging** - 90-day retention minimum
3. **Encryption** - Data at rest and in transit
4. **Change Management** - Approval workflow for infrastructure changes
5. **Incident Response** - Documented procedures and annual drills

**Compliance Reporting:**

```bash
$ php artisan compliance:generate-report \
    --standard=soc2 \
    --period=2024-Q4

✓ SOC 2 Compliance Report Generated

Report Period: 2024 Q4 (Oct-Dec)
Organization: All organizations

Controls Status:
✓ CC6.1 - Logical Access (98% compliant)
✓ CC6.2 - Audit Logging (100% compliant)
✓ CC6.3 - Encryption (100% compliant)
⚠️ CC6.6 - Vulnerability Management (85% compliant)
✓ CC7.2 - Change Management (95% compliant)

Findings:
- 3 servers missing security patches (CC6.6)
- 2 role reviews overdue (CC6.1)

Report: /tmp/soc2-report-2024Q4.pdf
```

## Chapter 7: Troubleshooting

### Common Issues and Solutions

#### Issue 1: "Permission Denied" Errors

**Symptoms:**
- HTTP 403 Forbidden errors
- Message: "This action is unauthorized"
- UI elements hidden or disabled

**Causes:**
- Insufficient role in organization
- Feature not available in license tier
- Organization context not set

**Diagnostic Steps:**

```bash
# Check user's role in organization
$ php artisan user:check-permission \
    --email=john@example.com \
    --organization=43 \
    --action=update_settings

Permission Check:
User: john@example.com
Organization: TechCorp Solutions (ID: 43)
Role: member
Action: update_settings

Result: ✗ DENIED
Required Roles: owner, admin
User Role: member

Resolution: Upgrade user to admin role or request admin to perform action
```

**Resolution:**

```bash
# Option 1: Upgrade user role
$ php artisan organization:change-role \
    --organization=43 \
    --user=john@example.com \
    --role=admin

# Option 2: Check license tier
$ php artisan license:features --organization=43

Enabled Features:
✓ rolling_updates
✗ blue_green (requires Enterprise tier)

# Upgrade license if needed
$ php artisan license:upgrade --organization=43 --new-key=CLFY-ENT-KEY
```

#### Issue 2: Terraform Provisioning Failures

**Symptoms:**
- Terraform deployment stuck in "applying" status
- Error: "Terraform execution failed"
- Resources partially created

**Diagnostic Steps:**

```bash
# Check deployment status
$ php artisan terraform:show-deployment --id=100

Deployment Status:
ID: 100
Status: failed
Stage: apply
Error: Error creating EC2 instance: UnauthorizedOperation

Last Output:
aws_vpc.main: Creating...
aws_vpc.main: Creation complete [id=vpc-0abc123]
aws_instance.server[0]: Creating...
Error: creating EC2 Instance: UnauthorizedOperation: You are not authorized to perform this operation

# Check cloud credentials
$ php artisan cloud:test-credentials --id=12

Testing AWS Credentials (ID: 12)...
✗ Authentication failed
Error: The security token included in the request is invalid

Diagnosis: Credentials expired or revoked
```

**Resolution:**

```bash
# Update/rotate credentials
$ php artisan cloud:update-credentials \
    --id=12 \
    --access-key=AKIAIOSFODNN7NEWKEY \
    --secret-key=wJalrXUtnFEMI/K7MDENG/bPxRfiNEWKEY

✓ Credentials updated and validated

# Retry failed deployment
$ php artisan terraform:retry-deployment --id=100

⏳ Retrying deployment 100...
✓ Using updated credentials
✓ Resuming from last successful state

⏳ Provisioning remaining resources...
✓ aws_instance.server[0] created
✓ aws_instance.server[1] created

✓ Deployment completed successfully
```

#### Issue 3: Resource Quota Exceeded

**Symptoms:**
- Cannot create new servers/applications
- Error: "Organization quota exceeded"
- Resources exist but new ones can't be created

**Diagnostic Steps:**

```bash
# Check quota status
$ php artisan organization:quota-status --id=43

Quota Status:
Organization: TechCorp Solutions
License: Professional

Resources:
Servers: 25/25 (100%) ✗ QUOTA EXCEEDED
Applications: 87/100 (87%)
Deployments (month): 342/unlimited

Blocked Actions:
- Create new server
- Provision infrastructure via Terraform
```

**Resolution Options:**

**Option 1: Delete Unused Resources**

```bash
# Find and delete unused servers
$ php artisan server:cleanup-unused \
    --organization=43 \
    --inactive-days=60 \
    --dry-run

Unused Servers Found:
- Server 205: staging-old (last used 65 days ago)
- Server 207: test-srv-temp (last used 90 days ago)

Run without --dry-run to delete.

$ php artisan server:cleanup-unused \
    --organization=43 \
    --inactive-days=60

✓ 2 servers deleted
✓ Quota freed: 2 server slots
Current usage: 23/25 (92%)
```

**Option 2: Upgrade License Tier**

```bash
$ php artisan license:upgrade \
    --organization=43 \
    --new-key=CLFY-ENT-XXXX-XXXX-XXXX

✓ License upgraded to Enterprise
New Limits:
Servers: 23/100 (23%)
Applications: 87/500 (17%)
```

**Option 3: Request Temporary Quota Increase**

```bash
$ php artisan organization:request-quota-increase \
    --organization=43 \
    --servers=35 \
    --reason="Temporary increase for holiday traffic scaling" \
    --duration=30days

✓ Quota increase request submitted
Approval time: 24-48 hours (Professional SLA)
```

#### Issue 4: White-Label Branding Not Applied

**Symptoms:**
- Custom logo not showing
- Default Coolify colors displayed
- Branding appears on some pages but not others

**Diagnostic Steps:**

```bash
# Check branding configuration
$ php artisan branding:status --organization=42

Branding Status:
Organization: Acme Cloud Platform
License: White-Label

Configuration:
✓ Logo uploaded (primary_logo_url: /storage/branding/42/logo.png)
✓ Colors configured (primary: #1E40AF)
✓ Favicon generated (all sizes)
✗ CSS compilation: FAILED

Error: SASS compilation error - unknown variable $primary-color

Diagnosis: CSS compilation failed, falling back to default styles
```

**Resolution:**

```bash
# Recompile CSS
$ php artisan branding:recompile-css --organization=42

⏳ Compiling organization CSS...
✓ SASS variables loaded
✓ CSS compiled successfully
✓ Minified and cached

✓ Branding CSS ready
Cache key: branding:42:css
Size: 45KB

# Clear browser cache instruction
Browser Cache: Users must clear cache or hard refresh (Ctrl+Shift+R)

# Verify branding
$ php artisan branding:test --organization=42

✓ Logo accessible at /storage/branding/42/logo.png
✓ CSS accessible at /branding/42/styles.css
✓ Favicon accessible at /storage/branding/42/favicons/favicon-32x32.png
✓ All branding assets loading correctly
```

#### Issue 5: Organization Hierarchy Confusion

**Symptoms:**
- Users can't see expected resources
- Resources appearing in wrong organization
- Parent-child relationships unclear

**Diagnostic Steps:**

```bash
# Visualize hierarchy
$ php artisan organization:show-hierarchy --root=42

Organization Hierarchy:

Acme Cloud Platform (ID: 42) [Top Branch]
├── TechCorp Solutions (ID: 43) [Master Branch]
│   ├── Engineering Team (ID: 45) [Sub-User]
│   │   └── DevOps Project (ID: 47) [End User]
│   └── Marketing Team (ID: 46) [Sub-User]
└── StartupXYZ (ID: 44) [Master Branch]
    └── Production Env (ID: 48) [End User]

Current User: john@example.com
Accessible Organizations:
- Engineering Team (ID: 45) - Role: admin ← CURRENT
- DevOps Project (ID: 47) - Role: member

# Check resource visibility
$ php artisan organization:check-resource-access \
    --user=john@example.com \
    --resource-type=server \
    --resource-id=205

Resource Access Check:
Resource: Server 205 (production-server-1)
Owner Organization: TechCorp Solutions (ID: 43)
User Organization: Engineering Team (ID: 45)

Result: ✗ NO ACCESS
Reason: Resource belongs to parent organization

Resolution: User must switch to TechCorp Solutions org (if they have access)
```

**Resolution:**

```bash
# Add user to parent organization if needed
$ php artisan organization:invite \
    --organization=43 \
    --email=john@example.com \
    --role=member

# User switches to correct organization
$ php artisan user:switch-organization \
    --user=john@example.com \
    --organization=43

✓ Switched to TechCorp Solutions
✓ Resources now visible
```

## Appendices

### Appendix A: Glossary

**Terms:**

- **Top Branch** - Highest-level organization type, typically white-label reseller
- **Master Branch** - Customer organization created by Top Branch
- **Sub-User** - Team or project organization within Master Branch
- **End User** - Leaf-level organization with no children
- **License Tier** - Feature and quota level (Starter, Professional, Enterprise, White-Label)
- **Feature Flag** - Boolean toggle controlling access to specific features
- **Organization Scoping** - Automatic filtering of queries by organization context
- **Resource Quota** - Maximum number of resources (servers, apps) allowed
- **White-Label** - Completely custom branding removing all Coolify references
- **RBAC** - Role-Based Access Control, permission system based on user roles

### Appendix B: API Quick Reference

**Authentication:**

```bash
# Create API token
POST /api/v1/auth/tokens
{
    "email": "admin@acme.com",
    "password": "secret",
    "organization_id": 42,
    "abilities": ["*"]
}

# Response
{
    "token": "1|abc123def456...",
    "expires_at": "2025-02-15T12:00:00Z"
}

# Use token in requests
curl -H "Authorization: Bearer 1|abc123def456..." \
     https://api.coolify.acme.com/api/v1/organizations
```

**Common Endpoints:**

```bash
# List organizations
GET /api/v1/organizations

# Create organization
POST /api/v1/organizations
{
    "name": "New Org",
    "type": "master_branch",
    "parent_organization_id": 42
}

# Activate license
POST /api/v1/organizations/{id}/license/activate
{
    "license_key": "CLFY-XXXX-XXXX-XXXX-XXXX",
    "domain": "coolify.example.com"
}

# Invite user
POST /api/v1/organizations/{id}/invitations
{
    "email": "user@example.com",
    "role": "admin"
}

# Provision infrastructure
POST /api/v1/terraform/deployments
{
    "organization_id": 42,
    "cloud_provider_credential_id": 12,
    "template": "aws-ec2",
    "config": {
        "instance_type": "t3.medium",
        "instance_count": 2,
        "region": "us-east-1"
    }
}
```

### Appendix C: CLI Command Reference

**Organization Management:**

```bash
# Create organization
php artisan organization:create --type=top_branch --name="Acme" --slug=acme --owner-email=admin@acme.com

# List organizations
php artisan organization:list --type=master_branch --parent=42

# Show hierarchy
php artisan organization:show-hierarchy --root=42

# Delete organization
php artisan organization:delete --id=43 --confirm
```

**License Management:**

```bash
# Activate license
php artisan license:activate --key=CLFY-KEY --domain=coolify.acme.com

# Check status
php artisan license:status --organization=42

# List features
php artisan license:features --organization=42

# Upgrade
php artisan license:upgrade --organization=42 --new-key=CLFY-NEW-KEY
```

**User Management:**

```bash
# Invite user
php artisan organization:invite --organization=42 --email=user@example.com --role=admin

# Change role
php artisan organization:change-role --organization=42 --user=user@example.com --role=member

# Remove user
php artisan organization:remove-user --organization=42 --user=user@example.com --confirm

# List user's organizations
php artisan user:organizations --email=user@example.com
```

**Branding:**

```bash
# Upload logo
php artisan branding:upload-logo --organization=42 --logo=/path/to/logo.png --type=primary

# Set colors
php artisan branding:set-colors --organization=42 --primary="#1E40AF" --secondary="#10B981"

# Recompile CSS
php artisan branding:recompile-css --organization=42

# Generate favicons
php artisan branding:generate-favicons --organization=42
```

**Terraform:**

```bash
# Add cloud credentials
php artisan cloud:add-credentials --provider=aws --organization=42 --access-key=KEY --secret-key=SECRET

# Create deployment
php artisan terraform:create-deployment --organization=42 --credential=12 --template=aws-ec2

# Provision infrastructure
php artisan terraform:provision --deployment=100

# Show deployment
php artisan terraform:show-deployment --id=100

# Destroy infrastructure
php artisan terraform:destroy --deployment=100 --confirm
```

### Appendix D: Quick Reference Cards

**Administrator Daily Tasks:**

```
┌─────────────────────────────────────┐
│ Daily Administrator Checklist       │
├─────────────────────────────────────┤
│ □ Review usage alerts               │
│ □ Check license expirations         │
│ □ Review security audit logs        │
│ □ Approve pending requests          │
│ □ Monitor resource utilization      │
│ □ Respond to support tickets        │
└─────────────────────────────────────┘
```

**Emergency Response:**

```
┌────────────────────────────────────────────┐
│ Security Incident Response                 │
├────────────────────────────────────────────┤
│ 1. Lock organization:                      │
│    php artisan organization:emergency-     │
│    lockdown --id=ORG_ID                    │
│                                            │
│ 2. Revoke credentials:                     │
│    php artisan cloud:revoke-credentials    │
│    --id=CRED_ID --emergency                │
│                                            │
│ 3. Review audit logs:                      │
│    php artisan organization:audit-log      │
│    --organization=ORG_ID --since=24hours   │
│                                            │
│ 4. Notify stakeholders                     │
│ 5. Investigate and remediate               │
│ 6. Unlock when resolved:                   │
│    php artisan organization:unlock         │
│    --id=ORG_ID --confirm                   │
└────────────────────────────────────────────┘
```

**Common Troubleshooting:**

```
┌────────────────────────────────────────────┐
│ Issue: Permission Denied                   │
│ ─────────────────────────────────────────  │
│ Check: user:check-permission               │
│ Fix: organization:change-role              │
├────────────────────────────────────────────┤
│ Issue: Quota Exceeded                      │
│ ─────────────────────────────────────────  │
│ Check: organization:quota-status           │
│ Fix: server:cleanup-unused OR              │
│      license:upgrade                       │
├────────────────────────────────────────────┤
│ Issue: Terraform Failed                    │
│ ─────────────────────────────────────────  │
│ Check: terraform:show-deployment           │
│ Fix: cloud:test-credentials →              │
│      cloud:update-credentials →            │
│      terraform:retry-deployment            │
└────────────────────────────────────────────┘
```

---

## Document Version

- **Version:** 1.0
- **Last Updated:** January 15, 2025
- **Compatibility:** Coolify Enterprise v4.0+, Laravel 12+
- **Authors:** Coolify Enterprise Team
- **Support:** enterprise-support@coolify.io
