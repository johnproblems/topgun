---
name: Build DeploymentManager.vue with deployment strategy configuration
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:38:56Z
github: https://github.com/johnproblems/topgun/issues/148
depends_on: [32]
parallel: true
conflicts_with: []
---

# Task: Build DeploymentManager.vue with deployment strategy configuration

## Description

Create a comprehensive Vue.js 3 component for configuring and managing advanced deployment strategies in the Coolify Enterprise platform. This component serves as the primary user interface for selecting, configuring, and monitoring deployment strategies (rolling updates, blue-green deployments, canary releases) with real-time capacity validation and infrastructure provisioning integration.

**DeploymentManager.vue** is a critical component in the Enhanced Deployment Pipeline system, providing administrators and developers with an intuitive interface to:
1. **Select deployment strategies** based on application requirements and risk tolerance
2. **Configure strategy parameters** (batch sizes, health check intervals, rollback triggers)
3. **Validate infrastructure capacity** before deployment execution
4. **Monitor deployment progress** with real-time status updates via WebSockets
5. **Manage rollback procedures** when deployments fail or health checks don't pass
6. **Integrate with Terraform** for automatic infrastructure provisioning when capacity is insufficient

This component integrates deeply with the backend EnhancedDeploymentService (Task 32) to execute sophisticated deployment workflows that minimize downtime and reduce deployment risk. It provides visual feedback throughout the deployment lifecycle, from pre-deployment validation through completion or rollback.

**Integration with Enterprise Architecture:**
- **Backend Integration:** Communicates with `EnhancedDeploymentService` via Inertia.js forms and API calls
- **Capacity Management:** Uses `CapacityManager` service to validate server resources before deployment
- **Infrastructure Provisioning:** Triggers Terraform provisioning if insufficient capacity is detected
- **Real-time Updates:** Receives deployment progress via Laravel Reverb WebSocket channels
- **Resource Monitoring:** Displays live server metrics during deployment from `SystemResourceMonitor`
- **Organization Context:** Enforces organization-scoped access and resource quotas

**Why this task is important:** Modern enterprise deployments require zero-downtime strategies and automated rollback capabilities to maintain service reliability. Manual deployment configuration is error-prone and doesn't adapt to changing infrastructure conditions. DeploymentManager.vue provides a user-friendly interface that makes advanced deployment strategies accessible to all users while ensuring deployments respect capacity constraints and organizational policies. This component transforms complex deployment orchestration into a guided, validated workflow that reduces human error and improves deployment success rates.

**Key Features:**
- Visual strategy selection with interactive diagrams showing deployment flow
- Real-time capacity validation preventing over-commitment of resources
- Pre-deployment health checks to validate server readiness
- Live deployment progress tracking with step-by-step status updates
- Automatic rollback on health check failures with configurable thresholds
- Integration with Terraform for just-in-time infrastructure provisioning
- Historical deployment tracking with success/failure metrics
- Multi-application deployment orchestration for complex services

## Acceptance Criteria

- [ ] Component renders with three main sections: strategy selection, configuration, and monitoring
- [ ] Strategy selector displays three deployment strategies: rolling, blue-green, canary
- [ ] Each strategy includes visual diagram explaining deployment flow
- [ ] Configuration panel adapts to selected strategy showing relevant parameters
- [ ] Rolling update configuration: batch size, delay between batches, max parallel deployments
- [ ] Blue-green configuration: target environment selection, health check URL, switch delay
- [ ] Canary configuration: traffic percentage, canary duration, success metrics threshold
- [ ] Real-time capacity validation displays before "Deploy" button is enabled
- [ ] Capacity validation shows: current server load, required resources, available capacity
- [ ] Warning message displayed if capacity is insufficient with "Provision Infrastructure" option
- [ ] Integration with TerraformService for automatic server provisioning
- [ ] Deployment progress section displays real-time status updates via WebSocket
- [ ] Progress tracking shows: current step, completed steps, remaining steps, estimated time
- [ ] Health check monitoring displays pass/fail status for each deployment batch
- [ ] Automatic rollback trigger on configurable failure thresholds
- [ ] Manual rollback button available during and after deployment
- [ ] Deployment history table showing last 10 deployments with status and duration
- [ ] Error handling for network failures, timeout errors, and API errors
- [ ] Loading states for all async operations (capacity check, deployment trigger, rollback)
- [ ] Responsive design working on desktop, tablet (strategy selection simplified on mobile)
- [ ] Accessibility compliance (ARIA labels, keyboard navigation, screen reader support)
- [ ] Dark mode support matching Coolify's existing theme system
- [ ] Organization-scoped deployment operations preventing cross-tenant access

## Technical Details

### File Paths

**Vue Component:**
- `/home/topgun/topgun/resources/js/Components/Enterprise/Deployment/DeploymentManager.vue`

**Sub-Components (to be created):**
- `/home/topgun/topgun/resources/js/Components/Enterprise/Deployment/StrategySelector.vue` (Task 40)
- `/home/topgun/topgun/resources/js/Components/Enterprise/Deployment/DeploymentProgress.vue` (created in this task)
- `/home/topgun/topgun/resources/js/Components/Enterprise/Deployment/CapacityValidation.vue` (created in this task)
- `/home/topgun/topgun/resources/js/Components/Enterprise/Deployment/DeploymentHistory.vue` (created in this task)

**Backend Integration:**
- `/home/topgun/topgun/app/Services/Enterprise/EnhancedDeploymentService.php` (Task 32)
- `/home/topgun/topgun/app/Http/Controllers/Enterprise/DeploymentController.php` (enhance existing)
- `/home/topgun/topgun/app/Jobs/DeploymentStrategyJob.php` (new background job)

**Routes:**
- `/home/topgun/topgun/routes/web.php` - Inertia route for component
- `/home/topgun/topgun/routes/api.php` - API endpoints for status checks

**WebSocket Channels:**
- `/home/topgun/topgun/routes/channels.php` - Private channel for deployment updates

### Component Architecture

**DeploymentManager.vue** - Main container component
```vue
<script setup>
import { ref, computed, onMounted, onUnmounted } from 'vue'
import { useForm, usePage } from '@inertiajs/vue3'
import { router } from '@inertiajs/vue3'
import Echo from 'laravel-echo'

import StrategySelector from './StrategySelector.vue'
import DeploymentProgress from './DeploymentProgress.vue'
import CapacityValidation from './CapacityValidation.vue'
import DeploymentHistory from './DeploymentHistory.vue'

const props = defineProps({
  application: Object,
  organization: Object,
  servers: Array,
  currentDeployment: Object,
  deploymentHistory: Array,
  strategies: Array,
})

const emit = defineEmits(['deployment-started', 'deployment-completed', 'deployment-failed'])

// Component State
const selectedStrategy = ref('rolling')
const capacityValidation = ref(null)
const isValidatingCapacity = ref(false)
const deploymentStatus = ref(props.currentDeployment?.status || 'idle')
const deploymentProgress = ref(null)
const showProvisioningModal = ref(false)

// Form for deployment configuration
const form = useForm({
  application_id: props.application.id,
  strategy: 'rolling',
  config: {
    // Rolling update defaults
    batch_size: 1,
    batch_delay: 30, // seconds
    max_parallel: 2,
    health_check_url: '/health',
    health_check_timeout: 30,
    rollback_on_failure: true,
    failure_threshold: 0.5, // 50% failure rate triggers rollback
  },
})

// Computed Properties
const isDeploying = computed(() => {
  return ['pending', 'in_progress', 'health_checking'].includes(deploymentStatus.value)
})

const canDeploy = computed(() => {
  return !isDeploying.value &&
         capacityValidation.value?.sufficient &&
         !form.processing
})

const capacityInsufficient = computed(() => {
  return capacityValidation.value &&
         !capacityValidation.value.sufficient &&
         !isDeploying.value
})

// Strategy Configuration Templates
const strategyDefaults = {
  rolling: {
    batch_size: 1,
    batch_delay: 30,
    max_parallel: 2,
    health_check_url: '/health',
    health_check_timeout: 30,
    rollback_on_failure: true,
    failure_threshold: 0.5,
  },
  'blue-green': {
    target_environment: 'green',
    health_check_url: '/health',
    health_check_timeout: 60,
    switch_delay: 0, // immediate switch after health checks pass
    keep_old_environment: true, // for easy rollback
    rollback_on_failure: true,
  },
  canary: {
    canary_percentage: 10,
    canary_duration: 300, // 5 minutes
    success_metric: 'error_rate',
    success_threshold: 0.05, // 5% error rate max
    health_check_url: '/health',
    health_check_interval: 30,
    rollback_on_failure: true,
    promote_on_success: true,
  },
}

// Methods
const handleStrategyChange = (strategy) => {
  selectedStrategy.value = strategy
  form.strategy = strategy
  form.config = { ...strategyDefaults[strategy] }
  validateCapacity()
}

const validateCapacity = async () => {
  isValidatingCapacity.value = true

  try {
    const response = await axios.post(route('api.deployments.validate-capacity'), {
      application_id: props.application.id,
      strategy: form.strategy,
      config: form.config,
    })

    capacityValidation.value = response.data
  } catch (error) {
    console.error('Capacity validation failed:', error)
    capacityValidation.value = {
      sufficient: false,
      error: error.response?.data?.message || 'Capacity validation failed',
    }
  } finally {
    isValidatingCapacity.value = false
  }
}

const handleDeploy = () => {
  if (!canDeploy.value) return

  form.post(route('enterprise.deployments.create', {
    organization: props.organization.id,
    application: props.application.id,
  }), {
    onSuccess: (response) => {
      deploymentStatus.value = 'pending'
      emit('deployment-started', response)
    },
    onError: (errors) => {
      console.error('Deployment failed:', errors)
    },
  })
}

const handleRollback = async () => {
  if (!props.currentDeployment) return

  try {
    await axios.post(route('api.deployments.rollback', {
      deployment: props.currentDeployment.id,
    }))

    deploymentStatus.value = 'rolling_back'
  } catch (error) {
    console.error('Rollback failed:', error)
  }
}

const handleProvisionInfrastructure = () => {
  showProvisioningModal.value = true
}

const triggerProvisioning = async (providerConfig) => {
  try {
    await axios.post(route('api.terraform.provision'), {
      organization_id: props.organization.id,
      ...providerConfig,
    })

    showProvisioningModal.value = false
    // Poll for provisioning completion
    pollProvisioningStatus()
  } catch (error) {
    console.error('Provisioning failed:', error)
  }
}

const pollProvisioningStatus = () => {
  const interval = setInterval(async () => {
    try {
      const response = await axios.get(route('api.terraform.status', {
        organization: props.organization.id,
      }))

      if (response.data.status === 'completed') {
        clearInterval(interval)
        validateCapacity() // Re-validate with new servers
      } else if (response.data.status === 'failed') {
        clearInterval(interval)
        console.error('Provisioning failed')
      }
    } catch (error) {
      clearInterval(interval)
      console.error('Failed to poll provisioning status:', error)
    }
  }, 5000) // Poll every 5 seconds
}

// WebSocket Integration
let echoChannel = null

const subscribeToDeploymentUpdates = () => {
  const echo = usePage().props.echo

  echoChannel = echo.private(`organization.${props.organization.id}.deployments`)
    .listen('.deployment.updated', (event) => {
      if (event.application_id === props.application.id) {
        deploymentStatus.value = event.status
        deploymentProgress.value = event.progress

        if (event.status === 'completed') {
          emit('deployment-completed', event)
        } else if (event.status === 'failed' || event.status === 'rolled_back') {
          emit('deployment-failed', event)
        }
      }
    })
}

const unsubscribeFromDeploymentUpdates = () => {
  if (echoChannel) {
    echoChannel.stopListening('.deployment.updated')
    echoChannel = null
  }
}

// Lifecycle Hooks
onMounted(() => {
  validateCapacity()
  subscribeToDeploymentUpdates()
})

onUnmounted(() => {
  unsubscribeFromDeploymentUpdates()
})
</script>

<template>
  <div class="deployment-manager">
    <!-- Page Header -->
    <div class="manager-header">
      <div class="header-content">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">
          Deploy {{ application.name }}
        </h1>
        <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
          Configure and execute advanced deployment strategies
        </p>
      </div>

      <!-- Quick Actions -->
      <div class="header-actions">
        <button
          v-if="isDeploying"
          @click="handleRollback"
          class="btn btn-danger"
          type="button"
        >
          Rollback Deployment
        </button>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="manager-grid">
      <!-- Left Column: Strategy Selection & Configuration -->
      <div class="strategy-column">
        <!-- Strategy Selector -->
        <section class="card">
          <h2 class="card-title">Select Deployment Strategy</h2>
          <StrategySelector
            :selected-strategy="selectedStrategy"
            :strategies="strategies"
            @strategy-selected="handleStrategyChange"
          />
        </section>

        <!-- Strategy Configuration -->
        <section class="card mt-6">
          <h2 class="card-title">Configuration</h2>

          <!-- Rolling Update Config -->
          <div v-if="selectedStrategy === 'rolling'" class="config-form">
            <div class="form-group">
              <label for="batch_size">Batch Size</label>
              <input
                id="batch_size"
                v-model.number="form.config.batch_size"
                type="number"
                min="1"
                class="form-input"
                @input="validateCapacity"
              />
              <p class="form-hint">Number of servers to deploy simultaneously</p>
            </div>

            <div class="form-group">
              <label for="batch_delay">Batch Delay (seconds)</label>
              <input
                id="batch_delay"
                v-model.number="form.config.batch_delay"
                type="number"
                min="0"
                class="form-input"
              />
              <p class="form-hint">Wait time between batches</p>
            </div>

            <div class="form-group">
              <label for="max_parallel">Max Parallel Deployments</label>
              <input
                id="max_parallel"
                v-model.number="form.config.max_parallel"
                type="number"
                min="1"
                class="form-input"
              />
            </div>

            <div class="form-group">
              <label for="health_check_url">Health Check URL</label>
              <input
                id="health_check_url"
                v-model="form.config.health_check_url"
                type="text"
                class="form-input"
                placeholder="/health"
              />
            </div>

            <div class="form-group">
              <label class="flex items-center">
                <input
                  v-model="form.config.rollback_on_failure"
                  type="checkbox"
                  class="form-checkbox"
                />
                <span class="ml-2">Automatic rollback on failure</span>
              </label>
            </div>

            <div v-if="form.config.rollback_on_failure" class="form-group">
              <label for="failure_threshold">Failure Threshold (%)</label>
              <input
                id="failure_threshold"
                v-model.number="form.config.failure_threshold"
                type="number"
                min="0"
                max="1"
                step="0.1"
                class="form-input"
              />
              <p class="form-hint">Rollback if this percentage of deployments fail</p>
            </div>
          </div>

          <!-- Blue-Green Config -->
          <div v-else-if="selectedStrategy === 'blue-green'" class="config-form">
            <div class="form-group">
              <label for="target_environment">Target Environment</label>
              <select
                id="target_environment"
                v-model="form.config.target_environment"
                class="form-select"
              >
                <option value="green">Green (New Version)</option>
                <option value="blue">Blue (Current Version)</option>
              </select>
            </div>

            <div class="form-group">
              <label for="health_check_url">Health Check URL</label>
              <input
                id="health_check_url"
                v-model="form.config.health_check_url"
                type="text"
                class="form-input"
              />
            </div>

            <div class="form-group">
              <label for="switch_delay">Switch Delay (seconds)</label>
              <input
                id="switch_delay"
                v-model.number="form.config.switch_delay"
                type="number"
                min="0"
                class="form-input"
              />
              <p class="form-hint">Wait time before switching traffic</p>
            </div>

            <div class="form-group">
              <label class="flex items-center">
                <input
                  v-model="form.config.keep_old_environment"
                  type="checkbox"
                  class="form-checkbox"
                />
                <span class="ml-2">Keep old environment for rollback</span>
              </label>
            </div>
          </div>

          <!-- Canary Config -->
          <div v-else-if="selectedStrategy === 'canary'" class="config-form">
            <div class="form-group">
              <label for="canary_percentage">Canary Traffic Percentage (%)</label>
              <input
                id="canary_percentage"
                v-model.number="form.config.canary_percentage"
                type="number"
                min="1"
                max="100"
                class="form-input"
              />
              <p class="form-hint">Percentage of traffic to route to canary version</p>
            </div>

            <div class="form-group">
              <label for="canary_duration">Canary Duration (seconds)</label>
              <input
                id="canary_duration"
                v-model.number="form.config.canary_duration"
                type="number"
                min="60"
                class="form-input"
              />
              <p class="form-hint">How long to run canary before promoting</p>
            </div>

            <div class="form-group">
              <label for="success_threshold">Success Threshold</label>
              <input
                id="success_threshold"
                v-model.number="form.config.success_threshold"
                type="number"
                min="0"
                max="1"
                step="0.01"
                class="form-input"
              />
              <p class="form-hint">Maximum error rate to consider canary successful</p>
            </div>

            <div class="form-group">
              <label class="flex items-center">
                <input
                  v-model="form.config.promote_on_success"
                  type="checkbox"
                  class="form-checkbox"
                />
                <span class="ml-2">Automatically promote on success</span>
              </label>
            </div>
          </div>
        </section>
      </div>

      <!-- Right Column: Capacity & Deployment Status -->
      <div class="status-column">
        <!-- Capacity Validation -->
        <section class="card">
          <h2 class="card-title">Capacity Validation</h2>
          <CapacityValidation
            :validation="capacityValidation"
            :is-loading="isValidatingCapacity"
            @provision-infrastructure="handleProvisionInfrastructure"
          />

          <!-- Deploy Button -->
          <div class="mt-6">
            <button
              :disabled="!canDeploy"
              :class="{
                'btn-primary': canDeploy,
                'btn-disabled': !canDeploy,
              }"
              class="btn w-full"
              type="button"
              @click="handleDeploy"
            >
              <span v-if="form.processing" class="flex items-center justify-center">
                <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Starting Deployment...
              </span>
              <span v-else>
                Deploy with {{ selectedStrategy.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()) }}
              </span>
            </button>

            <p v-if="capacityInsufficient" class="mt-2 text-sm text-amber-600 dark:text-amber-400">
              Insufficient capacity. Provision additional infrastructure to proceed.
            </p>
          </div>
        </section>

        <!-- Deployment Progress -->
        <section v-if="isDeploying || deploymentProgress" class="card mt-6">
          <h2 class="card-title">Deployment Progress</h2>
          <DeploymentProgress
            :status="deploymentStatus"
            :progress="deploymentProgress"
          />
        </section>

        <!-- Deployment History -->
        <section class="card mt-6">
          <h2 class="card-title">Recent Deployments</h2>
          <DeploymentHistory :deployments="deploymentHistory" />
        </section>
      </div>
    </div>

    <!-- Infrastructure Provisioning Modal -->
    <TerraformProvisioningModal
      v-if="showProvisioningModal"
      :organization="organization"
      @provision="triggerProvisioning"
      @cancel="showProvisioningModal = false"
    />
  </div>
</template>

<style scoped>
.deployment-manager {
  @apply max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8;
}

.manager-header {
  @apply flex items-start justify-between mb-8;
}

.header-content h1 {
  @apply text-2xl font-bold text-gray-900 dark:text-gray-100;
}

.header-actions {
  @apply flex gap-3;
}

.manager-grid {
  @apply grid grid-cols-1 lg:grid-cols-3 gap-6;
}

.strategy-column {
  @apply lg:col-span-2;
}

.status-column {
  @apply lg:col-span-1;
}

.card {
  @apply bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6;
}

.card-title {
  @apply text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4;
}

.config-form {
  @apply space-y-4;
}

.form-group {
  @apply space-y-1;
}

.form-group label {
  @apply block text-sm font-medium text-gray-700 dark:text-gray-300;
}

.form-input,
.form-select {
  @apply mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm;
}

.form-hint {
  @apply text-xs text-gray-500 dark:text-gray-400 mt-1;
}

.form-checkbox {
  @apply rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500;
}

.btn {
  @apply px-4 py-2 rounded-md font-medium transition-colors duration-150;
}

.btn-primary {
  @apply bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2;
}

.btn-danger {
  @apply bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2;
}

.btn-disabled {
  @apply bg-gray-300 dark:bg-gray-600 text-gray-500 dark:text-gray-400 cursor-not-allowed;
}
</style>
```

### Sub-Component: DeploymentProgress.vue

**File:** `resources/js/Components/Enterprise/Deployment/DeploymentProgress.vue`

```vue
<script setup>
import { computed } from 'vue'

const props = defineProps({
  status: String,
  progress: Object,
})

const statusColor = computed(() => {
  const colors = {
    pending: 'text-gray-600',
    in_progress: 'text-blue-600',
    health_checking: 'text-yellow-600',
    completed: 'text-green-600',
    failed: 'text-red-600',
    rolling_back: 'text-orange-600',
    rolled_back: 'text-orange-600',
  }
  return colors[props.status] || 'text-gray-600'
})

const progressPercentage = computed(() => {
  if (!props.progress) return 0
  return (props.progress.completed_steps / props.progress.total_steps) * 100
})
</script>

<template>
  <div class="deployment-progress">
    <!-- Status Badge -->
    <div class="flex items-center justify-between mb-4">
      <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
        Status
      </span>
      <span :class="statusColor" class="text-sm font-semibold uppercase">
        {{ status.replace('_', ' ') }}
      </span>
    </div>

    <!-- Progress Bar -->
    <div class="progress-bar-container">
      <div class="progress-bar-bg">
        <div
          class="progress-bar-fill"
          :style="{ width: `${progressPercentage}%` }"
        ></div>
      </div>
      <span class="progress-percentage">{{ Math.round(progressPercentage) }}%</span>
    </div>

    <!-- Step Details -->
    <div v-if="progress" class="mt-4 space-y-2">
      <div class="flex justify-between text-sm">
        <span class="text-gray-600 dark:text-gray-400">Steps Completed</span>
        <span class="font-medium">{{ progress.completed_steps }} / {{ progress.total_steps }}</span>
      </div>

      <div v-if="progress.current_step" class="text-sm text-gray-600 dark:text-gray-400">
        Current: {{ progress.current_step }}
      </div>

      <div v-if="progress.estimated_time_remaining" class="flex justify-between text-sm">
        <span class="text-gray-600 dark:text-gray-400">Est. Time Remaining</span>
        <span class="font-medium">{{ progress.estimated_time_remaining }}s</span>
      </div>
    </div>

    <!-- Health Checks -->
    <div v-if="progress?.health_checks" class="mt-4">
      <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
        Health Checks
      </h4>
      <div class="space-y-1">
        <div
          v-for="(check, index) in progress.health_checks"
          :key="index"
          class="flex items-center justify-between text-sm"
        >
          <span class="text-gray-600 dark:text-gray-400">{{ check.server }}</span>
          <span
            :class="{
              'text-green-600': check.status === 'passed',
              'text-red-600': check.status === 'failed',
              'text-yellow-600': check.status === 'pending',
            }"
            class="font-medium"
          >
            {{ check.status }}
          </span>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div v-if="progress?.error" class="mt-4 p-3 bg-red-50 dark:bg-red-900/20 rounded-md">
      <p class="text-sm text-red-800 dark:text-red-200">
        {{ progress.error }}
      </p>
    </div>
  </div>
</template>

<style scoped>
.progress-bar-container {
  @apply relative;
}

.progress-bar-bg {
  @apply w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden;
}

.progress-bar-fill {
  @apply h-full bg-blue-600 transition-all duration-300;
}

.progress-percentage {
  @apply absolute right-0 top-4 text-xs text-gray-500 dark:text-gray-400;
}
</style>
```

### Sub-Component: CapacityValidation.vue

**File:** `resources/js/Components/Enterprise/Deployment/CapacityValidation.vue`

```vue
<script setup>
import { computed } from 'vue'

const props = defineProps({
  validation: Object,
  isLoading: Boolean,
})

const emit = defineEmits(['provision-infrastructure'])

const capacityStatus = computed(() => {
  if (!props.validation) return 'unknown'
  return props.validation.sufficient ? 'sufficient' : 'insufficient'
})

const statusColor = computed(() => {
  const colors = {
    sufficient: 'text-green-600',
    insufficient: 'text-red-600',
    unknown: 'text-gray-600',
  }
  return colors[capacityStatus.value]
})
</script>

<template>
  <div class="capacity-validation">
    <!-- Loading State -->
    <div v-if="isLoading" class="flex items-center justify-center py-8">
      <svg class="animate-spin h-8 w-8 text-blue-600" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span class="ml-3 text-sm text-gray-600 dark:text-gray-400">Validating capacity...</span>
    </div>

    <!-- Validation Results -->
    <div v-else-if="validation" class="validation-results">
      <!-- Status Badge -->
      <div class="flex items-center justify-between mb-4">
        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
          Capacity Status
        </span>
        <span :class="statusColor" class="text-sm font-semibold uppercase">
          {{ capacityStatus }}
        </span>
      </div>

      <!-- Resource Metrics -->
      <div class="space-y-3">
        <div v-if="validation.cpu" class="metric">
          <div class="metric-header">
            <span class="metric-label">CPU</span>
            <span class="metric-value">{{ validation.cpu.available }}% available</span>
          </div>
          <div class="metric-bar">
            <div
              class="metric-bar-fill"
              :class="{ 'bg-red-500': validation.cpu.available < 20, 'bg-green-500': validation.cpu.available >= 20 }"
              :style="{ width: `${validation.cpu.available}%` }"
            ></div>
          </div>
        </div>

        <div v-if="validation.memory" class="metric">
          <div class="metric-header">
            <span class="metric-label">Memory</span>
            <span class="metric-value">{{ validation.memory.available_gb }} GB available</span>
          </div>
          <div class="metric-bar">
            <div
              class="metric-bar-fill"
              :class="{ 'bg-red-500': validation.memory.percentage < 20, 'bg-green-500': validation.memory.percentage >= 20 }"
              :style="{ width: `${validation.memory.percentage}%` }"
            ></div>
          </div>
        </div>

        <div v-if="validation.disk" class="metric">
          <div class="metric-header">
            <span class="metric-label">Disk</span>
            <span class="metric-value">{{ validation.disk.available_gb }} GB available</span>
          </div>
          <div class="metric-bar">
            <div
              class="metric-bar-fill"
              :class="{ 'bg-red-500': validation.disk.percentage < 20, 'bg-green-500': validation.disk.percentage >= 20 }"
              :style="{ width: `${validation.disk.percentage}%` }"
            ></div>
          </div>
        </div>
      </div>

      <!-- Recommendations -->
      <div v-if="validation.recommendations" class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-md">
        <p class="text-sm text-blue-800 dark:text-blue-200">
          {{ validation.recommendations }}
        </p>
      </div>

      <!-- Provisioning Option -->
      <div v-if="!validation.sufficient" class="mt-4">
        <button
          @click="emit('provision-infrastructure')"
          class="btn btn-secondary w-full"
          type="button"
        >
          Provision Additional Infrastructure
        </button>
      </div>
    </div>

    <!-- Error State -->
    <div v-else class="text-center py-8 text-gray-500 dark:text-gray-400">
      Capacity validation unavailable
    </div>
  </div>
</template>

<style scoped>
.metric {
  @apply space-y-1;
}

.metric-header {
  @apply flex justify-between items-center;
}

.metric-label {
  @apply text-sm font-medium text-gray-700 dark:text-gray-300;
}

.metric-value {
  @apply text-sm text-gray-600 dark:text-gray-400;
}

.metric-bar {
  @apply w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden;
}

.metric-bar-fill {
  @apply h-full transition-all duration-300;
}

.btn-secondary {
  @apply bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600;
}
</style>
```

### Sub-Component: DeploymentHistory.vue

**File:** `resources/js/Components/Enterprise/Deployment/DeploymentHistory.vue`

```vue
<script setup>
import { computed } from 'vue'

const props = defineProps({
  deployments: Array,
})

const formatDuration = (seconds) => {
  const minutes = Math.floor(seconds / 60)
  const secs = seconds % 60
  return `${minutes}m ${secs}s`
}

const formatDate = (dateString) => {
  const date = new Date(dateString)
  return date.toLocaleString()
}
</script>

<template>
  <div class="deployment-history">
    <div v-if="deployments && deployments.length > 0" class="space-y-2">
      <div
        v-for="deployment in deployments"
        :key="deployment.id"
        class="history-item"
      >
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span
              :class="{
                'bg-green-100 text-green-800': deployment.status === 'completed',
                'bg-red-100 text-red-800': deployment.status === 'failed',
                'bg-gray-100 text-gray-800': deployment.status === 'rolled_back',
              }"
              class="status-badge"
            >
              {{ deployment.status }}
            </span>
            <span class="text-sm text-gray-600 dark:text-gray-400">
              {{ deployment.strategy }}
            </span>
          </div>
          <span class="text-xs text-gray-500 dark:text-gray-400">
            {{ formatDuration(deployment.duration) }}
          </span>
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
          {{ formatDate(deployment.created_at) }}
        </p>
      </div>
    </div>

    <div v-else class="text-center py-8 text-gray-500 dark:text-gray-400">
      No deployment history
    </div>
  </div>
</template>

<style scoped>
.history-item {
  @apply p-3 bg-gray-50 dark:bg-gray-700/50 rounded-md;
}

.status-badge {
  @apply px-2 py-1 text-xs font-medium rounded;
}
</style>
```

### Backend Controller Enhancement

**File:** `app/Http/Controllers/Enterprise/DeploymentController.php`

```php
<?php

namespace App\Http\Controllers\Enterprise;

use App\Contracts\EnhancedDeploymentServiceInterface;
use App\Contracts\CapacityManagerInterface;
use App\Http\Controllers\Controller;
use App\Models\Application;
use App\Models\Organization;
use Illuminate\Http\Request;
use Inertia\Inertia;

class DeploymentController extends Controller
{
    public function __construct(
        private EnhancedDeploymentServiceInterface $deploymentService,
        private CapacityManagerInterface $capacityManager
    ) {}

    /**
     * Show deployment manager interface
     */
    public function show(Organization $organization, Application $application)
    {
        $this->authorize('deploy', $application);

        $currentDeployment = $application->deployments()
            ->whereIn('status', ['pending', 'in_progress', 'health_checking'])
            ->latest()
            ->first();

        $deploymentHistory = $application->deployments()
            ->whereIn('status', ['completed', 'failed', 'rolled_back'])
            ->latest()
            ->limit(10)
            ->get();

        return Inertia::render('Enterprise/Deployment/Manager', [
            'application' => $application->load('servers'),
            'organization' => $organization,
            'servers' => $application->destination->servers,
            'currentDeployment' => $currentDeployment,
            'deploymentHistory' => $deploymentHistory,
            'strategies' => [
                ['value' => 'rolling', 'label' => 'Rolling Update', 'description' => 'Deploy gradually in batches'],
                ['value' => 'blue-green', 'label' => 'Blue-Green', 'description' => 'Deploy to new environment, then switch'],
                ['value' => 'canary', 'label' => 'Canary Release', 'description' => 'Route small percentage to new version'],
            ],
        ]);
    }

    /**
     * Create new deployment with strategy
     */
    public function create(Request $request, Organization $organization, Application $application)
    {
        $this->authorize('deploy', $application);

        $validated = $request->validate([
            'strategy' => 'required|in:rolling,blue-green,canary',
            'config' => 'required|array',
        ]);

        $deployment = $this->deploymentService->deployWithStrategy(
            $application,
            $validated['strategy'],
            $validated['config']
        );

        return redirect()->back()->with('success', 'Deployment started successfully');
    }

    /**
     * Validate deployment capacity
     */
    public function validateCapacity(Request $request)
    {
        $validated = $request->validate([
            'application_id' => 'required|exists:applications,id',
            'strategy' => 'required|in:rolling,blue-green,canary',
            'config' => 'required|array',
        ]);

        $application = Application::findOrFail($validated['application_id']);
        $this->authorize('view', $application);

        $servers = $application->destination->servers;

        $validation = $this->capacityManager->validateDeploymentCapacity(
            $servers,
            $application,
            $validated['strategy'],
            $validated['config']
        );

        return response()->json($validation);
    }

    /**
     * Rollback deployment
     */
    public function rollback(Request $request, int $deploymentId)
    {
        $deployment = \App\Models\Deployment::findOrFail($deploymentId);
        $this->authorize('deploy', $deployment->application);

        $this->deploymentService->rollback($deployment);

        return response()->json(['message' => 'Rollback initiated']);
    }
}
```

### Routes

**File:** `routes/web.php`

```php
// Deployment Manager Routes
Route::middleware(['auth', 'organization'])->group(function () {
    Route::get('/enterprise/organizations/{organization}/applications/{application}/deploy',
        [DeploymentController::class, 'show'])
        ->name('enterprise.deployments.show');

    Route::post('/enterprise/organizations/{organization}/applications/{application}/deploy',
        [DeploymentController::class, 'create'])
        ->name('enterprise.deployments.create');
});
```

**File:** `routes/api.php`

```php
// API endpoints for deployment operations
Route::middleware(['auth:sanctum', 'organization'])->group(function () {
    Route::post('/api/deployments/validate-capacity',
        [DeploymentController::class, 'validateCapacity'])
        ->name('api.deployments.validate-capacity');

    Route::post('/api/deployments/{deployment}/rollback',
        [DeploymentController::class, 'rollback'])
        ->name('api.deployments.rollback');
});
```

### WebSocket Channel

**File:** `routes/channels.php`

```php
// Private channel for organization deployment updates
Broadcast::channel('organization.{organizationId}.deployments', function ($user, $organizationId) {
    return $user->organizations()->where('id', $organizationId)->exists();
});
```

## Implementation Approach

### Step 1: Create Component Structure
1. Create main `DeploymentManager.vue` component file
2. Create sub-components: `DeploymentProgress.vue`, `CapacityValidation.vue`, `DeploymentHistory.vue`
3. Set up component props, emits, and reactive state

### Step 2: Implement Strategy Selection
1. Integrate with `StrategySelector.vue` component (Task 40)
2. Add strategy change handler with configuration templates
3. Implement strategy-specific configuration forms

### Step 3: Build Capacity Validation
1. Create `validateCapacity()` method with API call
2. Display capacity metrics (CPU, memory, disk)
3. Add "Provision Infrastructure" option for insufficient capacity
4. Integrate with Terraform provisioning API

### Step 4: Implement Deployment Execution
1. Create deployment form with Inertia.js useForm()
2. Add pre-deployment validation checks
3. Implement `handleDeploy()` method with error handling
4. Add loading states and disabled button logic

### Step 5: Add Real-Time Progress Tracking
1. Subscribe to Laravel Reverb WebSocket channel
2. Update deployment status from broadcasted events
3. Display progress percentage and step details
4. Show health check results for each deployment batch

### Step 6: Implement Rollback Functionality
1. Add rollback button with confirmation modal
2. Create `handleRollback()` method with API call
3. Update UI to reflect rollback status
4. Display rollback completion message

### Step 7: Build Deployment History Display
1. Fetch last 10 deployments from backend
2. Display status, strategy, duration, and timestamp
3. Add color-coded status badges
4. Format dates and durations for readability

### Step 8: Enhance Backend Controller
1. Create/enhance `DeploymentController` with methods
2. Implement capacity validation endpoint
3. Add deployment creation endpoint with strategy parameter
4. Implement rollback endpoint with authorization

### Step 9: Add Routes and Channels
1. Register web routes for Inertia.js pages
2. Register API routes for AJAX operations
3. Define private WebSocket channel for deployment updates
4. Add route authorization with policies

### Step 10: Testing and Refinement
1. Unit test component methods
2. Integration test full deployment workflow
3. Browser test with Dusk for UI interactions
4. Performance test with large server counts

## Test Strategy

### Unit Tests (Vitest)

**File:** `resources/js/Components/Enterprise/Deployment/__tests__/DeploymentManager.spec.js`

```javascript
import { mount } from '@vue/test-utils'
import { createInertiaApp } from '@inertiajs/vue3'
import DeploymentManager from '../DeploymentManager.vue'

describe('DeploymentManager.vue', () => {
  it('renders with initial state', () => {
    const wrapper = mount(DeploymentManager, {
      props: {
        application: { id: 1, name: 'Test App' },
        organization: { id: 1 },
        servers: [],
        currentDeployment: null,
        deploymentHistory: [],
        strategies: [],
      },
    })

    expect(wrapper.find('.deployment-manager').exists()).toBe(true)
  })

  it('selects rolling strategy by default', () => {
    const wrapper = mount(DeploymentManager, {
      props: {
        application: { id: 1 },
        organization: { id: 1 },
        servers: [],
        strategies: [],
      },
    })

    expect(wrapper.vm.selectedStrategy).toBe('rolling')
  })

  it('updates configuration when strategy changes', async () => {
    const wrapper = mount(DeploymentManager, {
      props: {
        application: { id: 1 },
        organization: { id: 1 },
        servers: [],
        strategies: [],
      },
    })

    await wrapper.vm.handleStrategyChange('blue-green')

    expect(wrapper.vm.selectedStrategy).toBe('blue-green')
    expect(wrapper.vm.form.config).toHaveProperty('target_environment')
  })

  it('disables deploy button when capacity insufficient', async () => {
    const wrapper = mount(DeploymentManager, {
      props: {
        application: { id: 1 },
        organization: { id: 1 },
        servers: [],
        strategies: [],
      },
    })

    wrapper.vm.capacityValidation = { sufficient: false }
    await wrapper.vm.$nextTick()

    expect(wrapper.vm.canDeploy).toBe(false)
  })

  it('calls handleDeploy on button click when capacity sufficient', async () => {
    const wrapper = mount(DeploymentManager, {
      props: {
        application: { id: 1 },
        organization: { id: 1 },
        servers: [],
        strategies: [],
      },
    })

    const handleDeploySpy = vi.spyOn(wrapper.vm, 'handleDeploy')
    wrapper.vm.capacityValidation = { sufficient: true }
    await wrapper.vm.$nextTick()

    await wrapper.find('.btn-primary').trigger('click')

    expect(handleDeploySpy).toHaveBeenCalled()
  })
})
```

### Integration Tests (Pest)

**File:** `tests/Feature/Enterprise/DeploymentManagerTest.php`

```php
<?php

use App\Models\Application;
use App\Models\Organization;
use App\Models\User;
use App\Models\Server;

it('renders deployment manager page', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'admin']);

    $application = Application::factory()->create([
        'organization_id' => $organization->id,
    ]);

    $this->actingAs($user)
        ->get(route('enterprise.deployments.show', [
            'organization' => $organization,
            'application' => $application,
        ]))
        ->assertOk()
        ->assertInertia(fn ($page) => $page
            ->component('Enterprise/Deployment/Manager')
            ->has('application')
            ->has('strategies', 3)
        );
});

it('creates deployment with rolling strategy', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'admin']);

    $application = Application::factory()->create([
        'organization_id' => $organization->id,
    ]);

    $this->actingAs($user)
        ->post(route('enterprise.deployments.create', [
            'organization' => $organization,
            'application' => $application,
        ]), [
            'strategy' => 'rolling',
            'config' => [
                'batch_size' => 2,
                'batch_delay' => 30,
            ],
        ])
        ->assertRedirect()
        ->assertSessionHas('success');

    $this->assertDatabaseHas('deployments', [
        'application_id' => $application->id,
        'strategy' => 'rolling',
    ]);
});

it('validates capacity before deployment', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'admin']);

    $application = Application::factory()->create([
        'organization_id' => $organization->id,
    ]);

    Server::factory()->create([
        'destination_id' => $application->destination_id,
    ]);

    $this->actingAs($user)
        ->postJson(route('api.deployments.validate-capacity'), [
            'application_id' => $application->id,
            'strategy' => 'rolling',
            'config' => ['batch_size' => 1],
        ])
        ->assertOk()
        ->assertJsonStructure([
            'sufficient',
            'cpu',
            'memory',
            'disk',
        ]);
});

it('triggers rollback for failed deployment', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'admin']);

    $application = Application::factory()->create([
        'organization_id' => $organization->id,
    ]);

    $deployment = \App\Models\Deployment::factory()->create([
        'application_id' => $application->id,
        'status' => 'failed',
    ]);

    $this->actingAs($user)
        ->postJson(route('api.deployments.rollback', ['deployment' => $deployment->id]))
        ->assertOk()
        ->assertJson(['message' => 'Rollback initiated']);
});
```

### Browser Tests (Dusk)

**File:** `tests/Browser/Enterprise/DeploymentManagerTest.php`

```php
<?php

use Laravel\Dusk\Browser;
use App\Models\Application;
use App\Models\Organization;
use App\Models\User;

it('allows user to select deployment strategy and configure', function () {
    $this->browse(function (Browser $browser) {
        $organization = Organization::factory()->create();
        $user = User::factory()->create();
        $organization->users()->attach($user, ['role' => 'admin']);

        $application = Application::factory()->create([
            'organization_id' => $organization->id,
        ]);

        $browser->loginAs($user)
            ->visit("/enterprise/organizations/{$organization->id}/applications/{$application->id}/deploy")
            ->waitForText('Deploy ' . $application->name)
            ->click('@strategy-blue-green')
            ->waitFor('@config-target-environment')
            ->select('@config-target-environment', 'green')
            ->type('@config-health-check-url', '/api/health')
            ->assertVisible('@btn-deploy');
    });
});

it('displays capacity validation results', function () {
    $this->browse(function (Browser $browser) {
        // Setup...

        $browser->loginAs($user)
            ->visit("/enterprise/organizations/{$organization->id}/applications/{$application->id}/deploy")
            ->waitForText('Capacity Validation')
            ->pause(2000) // Wait for capacity validation API call
            ->assertSee('CPU')
            ->assertSee('Memory')
            ->assertSee('Disk');
    });
});
```

## Definition of Done

- [ ] DeploymentManager.vue component created with Composition API
- [ ] DeploymentProgress.vue sub-component created
- [ ] CapacityValidation.vue sub-component created
- [ ] DeploymentHistory.vue sub-component created
- [ ] Strategy selection implemented with visual feedback
- [ ] Rolling update configuration form implemented
- [ ] Blue-green configuration form implemented
- [ ] Canary configuration form implemented
- [ ] Real-time capacity validation implemented with API integration
- [ ] Deploy button with validation and loading states
- [ ] Infrastructure provisioning integration (Terraform modal trigger)
- [ ] WebSocket subscription for real-time deployment updates
- [ ] Deployment progress tracking with percentage and step details
- [ ] Health check monitoring display
- [ ] Rollback functionality with confirmation
- [ ] Deployment history table with last 10 deployments
- [ ] DeploymentController enhanced with show, create, validateCapacity, rollback methods
- [ ] API routes registered for capacity validation and rollback
- [ ] WebSocket channel registered for deployment updates
- [ ] Unit tests written for component logic (10+ tests, >85% coverage)
- [ ] Integration tests written for controller endpoints (5+ tests)
- [ ] Browser tests written for UI workflows (3+ tests)
- [ ] Responsive design working on desktop and tablet
- [ ] Dark mode support matching Coolify theme
- [ ] Accessibility compliance (ARIA labels, keyboard navigation)
- [ ] Code follows Vue.js 3 and Laravel 12 best practices
- [ ] Laravel Pint formatting applied to PHP code
- [ ] PHPStan level 5 passing for controller
- [ ] No console errors or warnings in browser
- [ ] Documentation added to component props and methods
- [ ] Manual testing completed with all three strategies
- [ ] Code reviewed and approved

## Related Tasks

- **Depends on:** Task 32 (EnhancedDeploymentService must exist with deployWithStrategy method)
- **Integrates with:** Task 26 (CapacityManager for capacity validation)
- **Integrates with:** Task 40 (StrategySelector.vue for visual strategy selection)
- **Integrates with:** Task 20 (TerraformManager.vue for infrastructure provisioning)
- **Integrates with:** Task 31 (WebSocket broadcasting for real-time updates)
- **Integrates with:** Task 29 (ResourceDashboard.vue for server metrics)
- **Used by:** Application deployment workflows throughout the platform
