---
name: Create database schema for cloud_provider_credentials and terraform_deployments tables
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:38:30Z
github: https://github.com/johnproblems/topgun/issues/122
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Create database schema for cloud_provider_credentials and terraform_deployments tables

## Description

Design and implement Laravel migrations for managing encrypted cloud provider credentials and tracking Terraform infrastructure deployments. This establishes the foundational data layer for the Terraform integration system, enabling organizations to securely store cloud API keys and maintain detailed deployment state across multiple cloud providers.

### Integration Context

These tables integrate with Coolify's existing server management infrastructure by:
- Linking to the `organizations` table for multi-tenant isolation
- Connecting to the `servers` table for post-provisioning server registration
- Storing encrypted credentials using Laravel's built-in encryption
- Tracking Terraform state files for infrastructure lifecycle management

### Cloud Provider Support

The schema supports multiple cloud providers:
- **AWS**: Access Key ID, Secret Access Key, Region, VPC configuration
- **DigitalOcean**: API Token, Region, SSH Key fingerprints
- **Hetzner Cloud**: API Token, Location, Network configuration
- **GCP**: Service Account JSON, Project ID, Zone/Region
- **Azure**: Subscription ID, Tenant ID, Client credentials

### Security Considerations

- Credentials encrypted at rest using Laravel encryption (AES-256-CBC)
- Separate encryption key rotation for Terraform state files
- Organization-scoped access with foreign key constraints
- Audit trail for credential creation, updates, and usage
- Automatic credential validation before use

## Acceptance Criteria

- [ ] Migration creates `cloud_provider_credentials` table with encrypted credentials column
- [ ] Migration creates `terraform_deployments` table with state tracking columns
- [ ] Foreign keys properly link to `organizations` and `servers` tables
- [ ] Appropriate indexes added for organization-scoped queries
- [ ] JSON columns use proper PostgreSQL JSONB type for performance
- [ ] Timestamp columns include `created_at`, `updated_at`, and deployment-specific timestamps
- [ ] Soft deletes implemented for both tables to prevent accidental data loss
- [ ] Database constraints ensure data integrity (NOT NULL, CHECK constraints)
- [ ] Migration includes rollback method for safe down migrations
- [ ] Schema matches Coolify's existing naming conventions and patterns
- [ ] Comments added to complex columns explaining their purpose
- [ ] Test data seeds created for development and testing environments

## Technical Details

### Database Schema

#### `cloud_provider_credentials` Table

```php
Schema::create('cloud_provider_credentials', function (Blueprint $table) {
    $table->id();
    $table->string('uuid')->unique()->index();
    $table->foreignId('organization_id')
        ->constrained('organizations')
        ->cascadeOnDelete();

    // Provider information
    $table->string('name'); // User-friendly name
    $table->string('provider'); // aws, digitalocean, hetzner, gcp, azure
    $table->text('description')->nullable();

    // Encrypted credentials - Laravel encrypted cast
    $table->text('credentials'); // JSON encrypted: API keys, tokens, etc.

    // Metadata
    $table->jsonb('metadata')->nullable(); // Provider-specific configuration
    $table->timestamp('last_validated_at')->nullable();
    $table->boolean('is_active')->default(true);
    $table->string('validation_status')->default('pending'); // pending, valid, invalid
    $table->text('validation_error')->nullable();

    $table->timestamps();
    $table->softDeletes();

    // Indexes
    $table->index(['organization_id', 'provider']);
    $table->index(['organization_id', 'is_active']);
});
```

**Column Details:**
- `credentials` (TEXT): Encrypted JSON containing provider-specific API keys
  - AWS: `{"access_key_id": "...", "secret_access_key": "...", "region": "us-east-1"}`
  - DigitalOcean: `{"api_token": "...", "region": "nyc3"}`
  - Hetzner: `{"api_token": "...", "location": "nbg1"}`
- `metadata` (JSONB): Additional provider configuration (VPC IDs, SSH keys, network settings)
- `validation_status`: Tracks whether credentials are currently valid
- `last_validated_at`: Timestamp of last successful API validation

#### `terraform_deployments` Table

```php
Schema::create('terraform_deployments', function (Blueprint $table) {
    $table->id();
    $table->string('uuid')->unique()->index();
    $table->foreignId('organization_id')
        ->constrained('organizations')
        ->cascadeOnDelete();
    $table->foreignId('cloud_provider_credential_id')
        ->constrained('cloud_provider_credentials')
        ->cascadeOnDelete();
    $table->foreignId('server_id')
        ->nullable()
        ->constrained('servers')
        ->nullOnDelete();

    // Deployment information
    $table->string('name'); // Deployment name
    $table->string('provider'); // aws, digitalocean, hetzner
    $table->string('region')->nullable();
    $table->string('status'); // pending, planning, applying, completed, failed, destroying, destroyed

    // Infrastructure configuration
    $table->jsonb('infrastructure_config'); // VM size, OS, networking config
    $table->text('terraform_version')->nullable(); // e.g., "1.5.7"

    // State management
    $table->text('state_file')->nullable(); // Encrypted Terraform state JSON
    $table->string('state_file_checksum')->nullable(); // For integrity verification
    $table->timestamp('state_last_updated_at')->nullable();

    // Terraform outputs
    $table->jsonb('outputs')->nullable(); // IP addresses, instance IDs, etc.
    $table->text('plan_output')->nullable(); // Terraform plan text output
    $table->text('apply_output')->nullable(); // Terraform apply text output

    // Tracking and debugging
    $table->text('error_message')->nullable();
    $table->jsonb('resource_identifiers')->nullable(); // Cloud resource IDs for cleanup
    $table->integer('retry_count')->default(0);
    $table->timestamp('started_at')->nullable();
    $table->timestamp('completed_at')->nullable();
    $table->timestamp('destroyed_at')->nullable();

    $table->timestamps();
    $table->softDeletes();

    // Indexes
    $table->index(['organization_id', 'status']);
    $table->index(['server_id']);
    $table->index(['cloud_provider_credential_id']);
});
```

**Column Details:**
- `state_file` (TEXT): Encrypted Terraform state file (JSON)
- `infrastructure_config` (JSONB): Deployment parameters
  - AWS: `{"instance_type": "t3.medium", "ami": "ami-xxx", "vpc_id": "vpc-xxx"}`
  - DigitalOcean: `{"size": "s-2vcpu-4gb", "image": "ubuntu-22-04-x64"}`
- `outputs` (JSONB): Parsed Terraform outputs after apply
  - `{"server_ip": "1.2.3.4", "instance_id": "i-xxx", "ssh_key_id": "12345"}`
- `resource_identifiers` (JSONB): Cloud provider resource IDs for emergency cleanup
- `status` values: pending → planning → applying → completed (or failed at any stage)

### Implementation Approach

1. **Create Migration File**
   ```bash
   php artisan make:migration create_terraform_infrastructure_tables
   ```

2. **Implement Up Migration**
   - Create `cloud_provider_credentials` table first (no dependencies)
   - Create `terraform_deployments` table with foreign keys
   - Add indexes for organization-scoped queries
   - Add check constraints for status enums

3. **Implement Down Migration**
   - Drop `terraform_deployments` first (has foreign keys)
   - Drop `cloud_provider_credentials` second
   - Ensure safe rollback without orphaned data

4. **Add Database Comments** (PostgreSQL specific)
   ```php
   DB::statement("COMMENT ON COLUMN cloud_provider_credentials.credentials IS 'Encrypted JSON containing provider API keys and tokens'");
   DB::statement("COMMENT ON COLUMN terraform_deployments.state_file IS 'Encrypted Terraform state file - DO NOT EXPOSE'");
   ```

5. **Create Factory for Testing**
   ```bash
   php artisan make:factory CloudProviderCredentialFactory
   php artisan make:factory TerraformDeploymentFactory
   ```

### Test Strategy

**Unit Tests** (`tests/Unit/Migrations/TerraformInfrastructureTest.php`):
```php
it('creates cloud_provider_credentials table with correct schema', function () {
    Schema::hasTable('cloud_provider_credentials')->assertTrue();
    Schema::hasColumn('cloud_provider_credentials', 'credentials')->assertTrue();
    Schema::hasColumn('cloud_provider_credentials', 'organization_id')->assertTrue();
});

it('creates terraform_deployments table with foreign keys', function () {
    // Test foreign key constraints exist
    $foreignKeys = DB::select("SELECT * FROM information_schema.table_constraints
        WHERE constraint_type = 'FOREIGN KEY'
        AND table_name = 'terraform_deployments'");

    expect($foreignKeys)->toHaveCount(3); // organization, credential, server
});

it('adds proper indexes for performance', function () {
    $indexes = DB::select("SELECT indexname FROM pg_indexes
        WHERE tablename = 'cloud_provider_credentials'");

    expect($indexes)->toContain('cloud_provider_credentials_organization_id_provider_index');
});
```

**Integration Tests**:
```php
it('enforces organization isolation via foreign key', function () {
    $org1 = Organization::factory()->create();
    $org2 = Organization::factory()->create();

    $credential = CloudProviderCredential::factory()->create(['organization_id' => $org1->id]);

    // Attempt to create deployment for different organization should fail
    expect(fn() => TerraformDeployment::create([
        'organization_id' => $org2->id,
        'cloud_provider_credential_id' => $credential->id,
        'status' => 'pending',
    ]))->toThrow(QueryException::class);
});
```

## Definition of Done

- [ ] Migration file created and follows Laravel conventions
- [ ] Both tables created with all required columns and correct data types
- [ ] Foreign key constraints properly reference parent tables
- [ ] Indexes added for all organization_id columns (multi-tenant queries)
- [ ] JSONB columns used for flexible JSON storage (PostgreSQL specific)
- [ ] Soft deletes enabled on both tables
- [ ] UUID columns added for external API references
- [ ] Migration successfully runs `php artisan migrate`
- [ ] Migration successfully rolls back `php artisan migrate:rollback`
- [ ] Factories created for both models with realistic test data
- [ ] Unit tests verify table structure and constraints
- [ ] Integration tests verify foreign key enforcement
- [ ] Database seed data created for development environment
- [ ] Schema documented in this task file
- [ ] Code reviewed and follows PSR-12 standards
- [ ] No PHPStan errors (level 5+)
