---
name: Extend email templates with dynamic variable injection
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:38:28Z
github: https://github.com/johnproblems/topgun/issues/119
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Extend email templates with dynamic variable injection (platform_name, logo_url, colors)

## Description

Extend Laravel's Mail system to dynamically inject white-label branding variables into all email templates, ensuring that every email sent by the platform reflects the organization's custom branding. This task transforms generic Coolify emails into fully branded communications that maintain the white-label illusion across all touchpoints—from welcome emails and password resets to deployment notifications and system alerts.

Email communication is a critical brand touchpoint that's often overlooked in white-label systems. Without branded emails, users receive notifications from "Coolify" with Coolify branding, immediately breaking the white-label experience. Recipients see the platform name, logo, and colors of the underlying system rather than the organization they belong to. This inconsistency undermines trust, creates confusion, and makes the white-label solution feel incomplete and unprofessional.

**The Problem:**

Current Coolify email templates are hardcoded with:
- "Coolify" as the platform name in subjects and body text
- Coolify logos and brand colors
- Generic layouts that don't respect organization preferences
- No mechanism to inject organization-specific branding variables

**The Solution:**

This task implements a comprehensive email branding system that:

1. **Dynamic Variable Injection**: Automatically injects organization-specific variables into every email (platform_name, logo_url, primary_color, secondary_color, support_email, etc.)
2. **Template Inheritance**: Creates a base branded email layout that all notifications extend
3. **Mailable Trait**: Provides a reusable trait for automatic organization context detection
4. **Blade Component System**: Builds reusable branded email components (headers, footers, buttons, alerts)
5. **Multi-Format Support**: Generates both HTML and plain-text versions with proper branding
6. **Cache Integration**: Caches compiled templates per organization for performance
7. **Fallback Mechanism**: Gracefully falls back to default branding if organization context unavailable

**Key Capabilities:**

- **Automatic Organization Detection**: Detects organization context from authenticated user, resource owner, or explicit parameter
- **Consistent Branding**: Ensures all emails match the organization's white-label configuration
- **Template Variables**: Provides rich set of variables available in all email templates
- **Component Library**: Pre-built email components (buttons, cards, alerts) with organization branding
- **Live Preview**: Integration with BrandingPreview component for email visualization
- **Testing Support**: Mail::fake() compatible with branded template testing

**Example Transformation:**

**Before (Generic Coolify Email):**
```
Subject: Welcome to Coolify
---
Coolify Logo
Welcome to Coolify!
Your deployment platform is ready.
© 2024 Coolify
```

**After (Branded Organization Email):**
```
Subject: Welcome to Acme Platform
---
Acme Logo (in Acme colors)
Welcome to Acme Platform!
Your deployment platform is ready.
© 2024 Acme Corporation
```

**Integration Points:**

- **WhiteLabelService**: Fetches organization branding configuration
- **DynamicAssetController**: Serves organization logos for email embedding
- **BrandingPreview**: Shows email preview with applied branding
- **Laravel Mail**: Extends Mailable class with branding capabilities
- **Blade Templates**: Uses Blade components for modular email construction

**Why This Task is Critical:**

Email is often the first and most frequent touchpoint users have with the platform. Branded emails complete the white-label transformation by ensuring every communication reinforces the organization's brand rather than revealing the underlying Coolify infrastructure. This maintains the professional illusion, builds trust, and ensures regulatory compliance for organizations that require all communications to reflect their corporate brand.

Without this task, organizations would need to manually customize every email template—an error-prone, maintenance-heavy approach that breaks with every Coolify update. The dynamic injection system makes branding automatic, consistent, and maintainable.

## Acceptance Criteria

- [ ] BrandedMailable trait created for automatic organization context detection
- [ ] Base email layout (branded-email.blade.php) with dynamic variable injection
- [ ] Email variables available in all templates: platform_name, logo_url, primary_color, secondary_color, accent_color, support_email, support_url, company_address
- [ ] Branded email components created: email-button, email-header, email-footer, email-alert, email-card
- [ ] All existing Coolify notifications extended with branded templates
- [ ] Plain-text email versions generated with branding
- [ ] Organization logo embedded using CID attachment for reliable display
- [ ] Inline CSS generated from organization colors for email client compatibility
- [ ] Fallback branding when organization context unavailable
- [ ] Cache compiled email templates per organization for performance
- [ ] Helper method for manual organization context setting: withOrganization($org)
- [ ] Email preview functionality in BrandingManager UI
- [ ] Testing trait EmailBrandingTestingTrait for Mail::fake() testing

## Technical Details

### File Paths

**Traits:**
- `/home/topgun/topgun/app/Mail/Concerns/BrandedMailable.php` (new)

**Base Layout:**
- `/home/topgun/topgun/resources/views/emails/layouts/branded.blade.php` (new)

**Blade Components:**
- `/home/topgun/topgun/resources/views/components/email/button.blade.php` (new)
- `/home/topgun/topgun/resources/views/components/email/header.blade.php` (new)
- `/home/topgun/topgun/resources/views/components/email/footer.blade.php` (new)
- `/home/topgun/topgun/resources/views/components/email/alert.blade.php` (new)
- `/home/topgun/topgun/resources/views/components/email/card.blade.php` (new)

**Enhanced Notifications:**
- `/home/topgun/topgun/app/Notifications/*` (modify existing)
- `/home/topgun/topgun/resources/views/emails/notifications/*` (modify existing)

**Service Enhancement:**
- `/home/topgun/topgun/app/Services/Enterprise/WhiteLabelService.php` (add email methods)

**Testing:**
- `/home/topgun/topgun/tests/Traits/EmailBrandingTestingTrait.php` (new)

### BrandedMailable Trait

**File:** `app/Mail/Concerns/BrandedMailable.php`

```php
<?php

namespace App\Mail\Concerns;

use App\Models\Organization;
use App\Services\Enterprise\WhiteLabelService;
use Illuminate\Support\Facades\Cache;

trait BrandedMailable
{
    protected ?Organization $organization = null;
    protected array $brandingVars = [];

    /**
     * Set the organization context for branding
     *
     * @param Organization $organization
     * @return $this
     */
    public function withOrganization(Organization $organization): static
    {
        $this->organization = $organization;
        return $this;
    }

    /**
     * Build the message with branding variables
     *
     * @return $this
     */
    protected function applyBranding(): static
    {
        $organization = $this->resolveOrganization();

        if (!$organization) {
            $this->applyDefaultBranding();
            return $this;
        }

        $this->brandingVars = $this->getBrandingVariables($organization);

        // Set email subject with platform name
        if (!$this->subject) {
            $this->subject = str_replace('Coolify', $this->brandingVars['platform_name'], $this->subject ?? '');
        }

        // Add branding variables to view data
        $this->with($this->brandingVars);

        // Attach logo as embedded image if available
        if ($this->brandingVars['logo_path']) {
            $this->attach($this->brandingVars['logo_path'], [
                'as' => 'logo.png',
                'mime' => 'image/png',
            ]);
        }

        return $this;
    }

    /**
     * Resolve organization from various contexts
     *
     * @return Organization|null
     */
    protected function resolveOrganization(): ?Organization
    {
        // 1. Explicit organization set via withOrganization()
        if ($this->organization) {
            return $this->organization;
        }

        // 2. From authenticated user
        if (auth()->check() && auth()->user()->currentOrganization) {
            return auth()->user()->currentOrganization;
        }

        // 3. From model being referenced (if available)
        if (isset($this->model) && method_exists($this->model, 'organization')) {
            return $this->model->organization;
        }

        // 4. From user being notified
        if (isset($this->user) && method_exists($this->user, 'currentOrganization')) {
            return $this->user->currentOrganization;
        }

        return null;
    }

    /**
     * Get branding variables for organization
     *
     * @param Organization $organization
     * @return array
     */
    protected function getBrandingVariables(Organization $organization): array
    {
        $cacheKey = "email_branding:{$organization->id}";

        return Cache::remember($cacheKey, 3600, function () use ($organization) {
            $whiteLabelService = app(WhiteLabelService::class);
            $config = $organization->whiteLabelConfig;

            return [
                // Platform identity
                'platform_name' => $config?->platform_name ?? $organization->name,
                'platform_url' => $config?->custom_domain ? "https://{$config->custom_domain}" : config('app.url'),

                // Logos
                'logo_url' => $config?->primary_logo_url ?? asset('images/default-logo.png'),
                'logo_path' => $config?->primary_logo_path ? storage_path("app/public/{$config->primary_logo_path}") : null,

                // Colors
                'primary_color' => $config?->primary_color ?? '#3b82f6',
                'secondary_color' => $config?->secondary_color ?? '#10b981',
                'accent_color' => $config?->accent_color ?? '#f59e0b',
                'text_color' => $config?->text_color ?? '#1f2937',
                'background_color' => $config?->background_color ?? '#ffffff',

                // Contact
                'support_email' => $organization->support_email ?? config('mail.support_address'),
                'support_url' => $config?->custom_domain ? "https://{$config->custom_domain}/support" : route('support'),

                // Company info
                'company_name' => $organization->legal_name ?? $organization->name,
                'company_address' => $organization->address ?? '',

                // Inline styles for email clients
                'button_style' => $this->generateButtonStyle($config),
                'header_style' => $this->generateHeaderStyle($config),
            ];
        });
    }

    /**
     * Apply default Coolify branding as fallback
     *
     * @return void
     */
    protected function applyDefaultBranding(): void
    {
        $this->brandingVars = [
            'platform_name' => 'Coolify',
            'platform_url' => config('app.url'),
            'logo_url' => asset('images/coolify-logo.png'),
            'logo_path' => null,
            'primary_color' => '#3b82f6',
            'secondary_color' => '#10b981',
            'accent_color' => '#f59e0b',
            'text_color' => '#1f2937',
            'background_color' => '#ffffff',
            'support_email' => config('mail.support_address'),
            'support_url' => route('support'),
            'company_name' => 'Coolify',
            'company_address' => '',
            'button_style' => '',
            'header_style' => '',
        ];

        $this->with($this->brandingVars);
    }

    /**
     * Generate inline button styles for email clients
     *
     * @param mixed $config
     * @return string
     */
    protected function generateButtonStyle($config): string
    {
        $primaryColor = $config?->primary_color ?? '#3b82f6';

        return "background-color: {$primaryColor}; color: #ffffff; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block; font-weight: 600;";
    }

    /**
     * Generate inline header styles for email clients
     *
     * @param mixed $config
     * @return string
     */
    protected function generateHeaderStyle($config): string
    {
        $primaryColor = $config?->primary_color ?? '#3b82f6';

        return "background-color: {$primaryColor}; padding: 20px; text-align: center;";
    }

    /**
     * Clear branding cache for organization
     *
     * @param Organization $organization
     * @return void
     */
    public static function clearBrandingCache(Organization $organization): void
    {
        Cache::forget("email_branding:{$organization->id}");
    }
}
```

### Base Email Layout

**File:** `resources/views/emails/layouts/branded.blade.php`

```blade
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>{{ $subject ?? $platform_name }}</title>

    <style>
        /* Reset styles for email clients */
        body, table, td, a {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100% !important;
            height: 100% !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f3f4f6;
        }

        table {
            border-collapse: collapse !important;
        }

        img {
            outline: none;
            text-decoration: none;
            border: none;
            -ms-interpolation-mode: bicubic;
            max-width: 100%;
            height: auto;
        }

        /* Container */
        .email-container {
            max-width: 600px;
            margin: 0 auto;
            background-color: {{ $background_color ?? '#ffffff' }};
        }

        /* Header */
        .email-header {
            background-color: {{ $primary_color ?? '#3b82f6' }};
            padding: 30px 20px;
            text-align: center;
        }

        .email-header img {
            max-height: 50px;
            width: auto;
        }

        /* Body */
        .email-body {
            padding: 40px 30px;
            color: {{ $text_color ?? '#1f2937' }};
            line-height: 1.6;
        }

        .email-body h1 {
            color: {{ $text_color ?? '#1f2937' }};
            font-size: 24px;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .email-body p {
            margin: 16px 0;
            font-size: 16px;
        }

        /* Button */
        .email-button {
            background-color: {{ $primary_color ?? '#3b82f6' }};
            color: #ffffff;
            padding: 14px 28px;
            text-decoration: none;
            border-radius: 6px;
            display: inline-block;
            font-weight: 600;
            margin: 20px 0;
        }

        .email-button:hover {
            opacity: 0.9;
        }

        /* Footer */
        .email-footer {
            background-color: #f9fafb;
            padding: 30px 20px;
            text-align: center;
            border-top: 1px solid #e5e7eb;
            font-size: 14px;
            color: #6b7280;
        }

        .email-footer a {
            color: {{ $primary_color ?? '#3b82f6' }};
            text-decoration: none;
        }

        /* Responsive */
        @media only screen and (max-width: 600px) {
            .email-body {
                padding: 20px 15px;
            }

            .email-body h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <table role="presentation" width="100%" cellspacing="0" cellpadding="0" border="0">
        <tr>
            <td align="center" style="padding: 20px 0;">
                <table class="email-container" role="presentation" width="600" cellspacing="0" cellpadding="0" border="0">
                    <!-- Header -->
                    <tr>
                        <td class="email-header">
                            @if($logo_url)
                                <img src="{{ $logo_url }}" alt="{{ $platform_name }} Logo">
                            @else
                                <h2 style="color: #ffffff; margin: 0;">{{ $platform_name }}</h2>
                            @endif
                        </td>
                    </tr>

                    <!-- Body Content -->
                    <tr>
                        <td class="email-body">
                            @yield('content')
                        </td>
                    </tr>

                    <!-- Footer -->
                    <tr>
                        <td class="email-footer">
                            @yield('footer')

                            <p style="margin: 10px 0 0;">
                                &copy; {{ date('Y') }} {{ $company_name ?? $platform_name }}. All rights reserved.
                            </p>

                            @if($company_address)
                                <p style="margin: 5px 0;">{{ $company_address }}</p>
                            @endif

                            <p style="margin: 10px 0 0;">
                                <a href="{{ $platform_url }}">{{ $platform_name }}</a>
                                @if($support_email)
                                    &nbsp;|&nbsp;
                                    <a href="mailto:{{ $support_email }}">Support</a>
                                @endif
                            </p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>
```

### Blade Email Components

**File:** `resources/views/components/email/button.blade.php`

```blade
@props(['url', 'color' => 'primary'])

<?php
$style = match($color) {
    'primary' => "background-color: {$primary_color}; color: #ffffff;",
    'secondary' => "background-color: {$secondary_color}; color: #ffffff;",
    'danger' => "background-color: #ef4444; color: #ffffff;",
    default => "background-color: {$primary_color}; color: #ffffff;",
};
?>

<table role="presentation" cellspacing="0" cellpadding="0" border="0">
    <tr>
        <td style="border-radius: 6px; background-color: {{ $primary_color }};">
            <a href="{{ $url }}" target="_blank" style="{{ $style }} padding: 14px 28px; text-decoration: none; border-radius: 6px; display: inline-block; font-weight: 600;">
                {{ $slot }}
            </a>
        </td>
    </tr>
</table>
```

**File:** `resources/views/components/email/alert.blade.php`

```blade
@props(['type' => 'info'])

<?php
$styles = match($type) {
    'success' => 'background-color: #d1fae5; border-left: 4px solid #10b981; color: #065f46;',
    'warning' => 'background-color: #fef3c7; border-left: 4px solid #f59e0b; color: #92400e;',
    'danger' => 'background-color: #fee2e2; border-left: 4px solid #ef4444; color: #991b1b;',
    default => "background-color: #dbeafe; border-left: 4px solid {$primary_color}; color: #1e40af;",
};
?>

<table role="presentation" width="100%" cellspacing="0" cellpadding="0" border="0" style="margin: 20px 0;">
    <tr>
        <td style="{{ $styles }} padding: 16px; border-radius: 6px;">
            {{ $slot }}
        </td>
    </tr>
</table>
```

### Example: Enhanced Welcome Email

**File:** `resources/views/emails/auth/welcome.blade.php`

```blade
@extends('emails.layouts.branded')

@section('content')
    <h1>Welcome to {{ $platform_name }}!</h1>

    <p>Hi {{ $user->name }},</p>

    <p>
        Thank you for joining {{ $platform_name }}. We're excited to have you on board!
        Your account has been successfully created and you can now start deploying your applications.
    </p>

    <x-email.button :url="$platform_url . '/dashboard'">
        Go to Dashboard
    </x-email.button>

    <x-email.alert type="info">
        <strong>Getting Started:</strong> Check out our documentation to learn how to deploy your first application.
    </x-email.alert>

    <p>
        If you have any questions or need assistance, our support team is here to help.
        Just reply to this email or visit our <a href="{{ $support_url }}" style="color: {{ $primary_color }};">support center</a>.
    </p>

    <p>
        Best regards,<br>
        The {{ $platform_name }} Team
    </p>
@endsection

@section('footer')
    <p style="margin: 0;">
        This email was sent because an account was created with this email address.
    </p>
@endsection
```

### Example: Enhanced Notification Mailable

**File:** `app/Mail/DeploymentSuccessful.php`

```php
<?php

namespace App\Mail;

use App\Mail\Concerns\BrandedMailable;
use App\Models\Application;
use Illuminate\Bus\Queueable;
use Illuminate\Mail\Mailable;
use Illuminate\Queue\SerializesModels;

class DeploymentSuccessful extends Mailable
{
    use Queueable, SerializesModels, BrandedMailable;

    public function __construct(
        public Application $application
    ) {
        // Organization will be auto-resolved from application
    }

    public function build()
    {
        $this->applyBranding();

        return $this
            ->subject("Deployment Successful - {$this->application->name}")
            ->markdown('emails.deployments.successful');
    }
}
```

**File:** `resources/views/emails/deployments/successful.blade.php`

```blade
@extends('emails.layouts.branded')

@section('content')
    <h1>Deployment Successful!</h1>

    <p>
        Your application <strong>{{ $application->name }}</strong> has been successfully deployed.
    </p>

    <x-email.alert type="success">
        Deployment completed in {{ $deployment->duration }} seconds
    </x-email.alert>

    <table role="presentation" width="100%" cellspacing="0" cellpadding="0" border="0" style="margin: 20px 0; background-color: #f9fafb; border-radius: 6px; overflow: hidden;">
        <tr>
            <td style="padding: 20px;">
                <p style="margin: 0 0 10px; font-weight: 600; color: {{ $text_color }};">Deployment Details:</p>
                <p style="margin: 5px 0;"><strong>Application:</strong> {{ $application->name }}</p>
                <p style="margin: 5px 0;"><strong>Environment:</strong> {{ $application->environment }}</p>
                <p style="margin: 5px 0;"><strong>Commit:</strong> {{ $deployment->commit_sha }}</p>
                <p style="margin: 5px 0;"><strong>Branch:</strong> {{ $deployment->branch }}</p>
            </td>
        </tr>
    </table>

    <x-email.button :url="$application->url">
        View Application
    </x-email.button>

    <p style="margin-top: 30px; font-size: 14px; color: #6b7280;">
        If you notice any issues with this deployment, you can roll back to a previous version from your dashboard.
    </p>
@endsection
```

### WhiteLabelService Enhancement

Add email-specific methods to `WhiteLabelService`:

```php
/**
 * Get email branding variables for organization
 *
 * @param Organization $organization
 * @return array
 */
public function getEmailBrandingVars(Organization $organization): array
{
    $config = $organization->whiteLabelConfig;

    return [
        'platform_name' => $config?->platform_name ?? $organization->name,
        'logo_url' => $config?->primary_logo_url ?? asset('images/default-logo.png'),
        'primary_color' => $config?->primary_color ?? '#3b82f6',
        'secondary_color' => $config?->secondary_color ?? '#10b981',
        // ... other variables
    ];
}

/**
 * Generate inline CSS for email clients
 *
 * @param Organization $organization
 * @return string
 */
public function generateEmailCSS(Organization $organization): string
{
    $config = $organization->whiteLabelConfig;

    return <<<CSS
        .email-button {
            background-color: {$config->primary_color};
            color: #ffffff;
            padding: 14px 28px;
            text-decoration: none;
            border-radius: 6px;
            display: inline-block;
            font-weight: 600;
        }
        /* ... more styles */
    CSS;
}
```

## Implementation Approach

### Step 1: Create BrandedMailable Trait
1. Create `app/Mail/Concerns/BrandedMailable.php`
2. Implement organization resolution logic
3. Add branding variable generation
4. Implement cache layer for performance
5. Add logo attachment functionality

### Step 2: Build Base Email Layout
1. Create `resources/views/emails/layouts/branded.blade.php`
2. Design responsive email structure
3. Add dynamic color injection
4. Implement header/footer sections
5. Ensure email client compatibility

### Step 3: Create Blade Email Components
1. Build email-button component with color variants
2. Create email-alert component (success, warning, danger, info)
3. Build email-card component for content grouping
4. Create email-header and email-footer components
5. Test components across email clients

### Step 4: Enhance Existing Notifications
1. Identify all existing Mailable classes
2. Add BrandedMailable trait to each
3. Update templates to use branded layout
4. Replace hardcoded "Coolify" references with variables
5. Test each notification type

### Step 5: Implement Plain-Text Versions
1. Create plain-text counterparts for all HTML emails
2. Ensure branding variables work in plain-text
3. Test plain-text rendering
4. Add automatic plain-text generation from HTML

### Step 6: Add WhiteLabelService Methods
1. Implement getEmailBrandingVars() method
2. Add generateEmailCSS() for inline styles
3. Create email preview functionality
4. Add cache invalidation on branding updates

### Step 7: Testing Infrastructure
1. Create EmailBrandingTestingTrait
2. Add Mail::fake() compatible testing helpers
3. Test variable injection accuracy
4. Verify organization resolution logic
5. Test fallback branding

### Step 8: Integration with BrandingManager
1. Add email preview tab to BrandingManager UI
2. Show sample emails with current branding
3. Allow live preview of email templates
4. Display both HTML and plain-text versions

## Test Strategy

### Unit Tests

**File:** `tests/Unit/Mail/BrandedMailableTest.php`

```php
<?php

use App\Mail\Concerns\BrandedMailable;
use App\Models\Organization;
use App\Models\WhiteLabelConfig;
use Illuminate\Mail\Mailable;

it('resolves organization from authenticated user', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $user->update(['current_organization_id' => $organization->id]);

    $this->actingAs($user);

    $mailable = new class extends Mailable {
        use BrandedMailable;

        public function build() {
            $this->applyBranding();
            return $this;
        }
    };

    $mailable->build();

    expect($mailable->organization)->toBe($organization);
});

it('generates branding variables from organization config', function () {
    $organization = Organization::factory()->create();
    WhiteLabelConfig::factory()->create([
        'organization_id' => $organization->id,
        'platform_name' => 'Acme Platform',
        'primary_color' => '#ff0000',
    ]);

    $mailable = new class extends Mailable {
        use BrandedMailable;

        public function build() {
            $this->applyBranding();
            return $this;
        }
    };

    $mailable->withOrganization($organization)->build();

    expect($mailable->brandingVars['platform_name'])->toBe('Acme Platform');
    expect($mailable->brandingVars['primary_color'])->toBe('#ff0000');
});

it('falls back to default branding when no organization', function () {
    $mailable = new class extends Mailable {
        use BrandedMailable;

        public function build() {
            $this->applyBranding();
            return $this;
        }
    };

    $mailable->build();

    expect($mailable->brandingVars['platform_name'])->toBe('Coolify');
});

it('caches branding variables for performance', function () {
    $organization = Organization::factory()->create();
    WhiteLabelConfig::factory()->create([
        'organization_id' => $organization->id,
        'platform_name' => 'Test Platform',
    ]);

    $mailable1 = new class extends Mailable {
        use BrandedMailable;

        public function build() {
            $this->applyBranding();
            return $this;
        }
    };

    $mailable2 = new class extends Mailable {
        use BrandedMailable;

        public function build() {
            $this->applyBranding();
            return $this;
        }
    };

    $mailable1->withOrganization($organization)->build();
    $mailable2->withOrganization($organization)->build();

    // Second call should hit cache (verify via Cache spy)
    expect(Cache::has("email_branding:{$organization->id}"))->toBeTrue();
});
```

### Integration Tests

**File:** `tests/Feature/Mail/BrandedEmailTest.php`

```php
<?php

use App\Mail\DeploymentSuccessful;
use App\Models\Application;
use App\Models\Organization;
use App\Models\User;
use App\Models\WhiteLabelConfig;
use Illuminate\Support\Facades\Mail;

it('sends branded welcome email', function () {
    Mail::fake();

    $organization = Organization::factory()->create();
    WhiteLabelConfig::factory()->create([
        'organization_id' => $organization->id,
        'platform_name' => 'Acme Cloud',
        'primary_color' => '#ff6600',
    ]);

    $user = User::factory()->create([
        'current_organization_id' => $organization->id,
    ]);

    Mail::to($user)->send(new WelcomeEmail($user));

    Mail::assertSent(WelcomeEmail::class, function ($mail) use ($user) {
        return $mail->hasTo($user->email) &&
               $mail->brandingVars['platform_name'] === 'Acme Cloud' &&
               $mail->brandingVars['primary_color'] === '#ff6600';
    });
});

it('injects organization variables into email template', function () {
    $organization = Organization::factory()->create();
    $config = WhiteLabelConfig::factory()->create([
        'organization_id' => $organization->id,
        'platform_name' => 'Custom Platform',
        'primary_color' => '#00ff00',
    ]);

    $application = Application::factory()->create([
        'organization_id' => $organization->id,
    ]);

    $mailable = new DeploymentSuccessful($application);
    $rendered = $mailable->render();

    expect($rendered)->toContain('Custom Platform');
    expect($rendered)->toContain('#00ff00');
});

it('uses default branding for system emails', function () {
    Mail::fake();

    $user = User::factory()->create();

    Mail::to($user)->send(new PasswordResetEmail($user));

    Mail::assertSent(PasswordResetEmail::class, function ($mail) {
        return $mail->brandingVars['platform_name'] === 'Coolify';
    });
});
```

### Email Client Testing

Test rendered emails across multiple email clients:

```php
it('renders correctly in major email clients', function () {
    // Use a service like Litmus or Email on Acid
    // Or manually test in Gmail, Outlook, Apple Mail, etc.

    $organization = Organization::factory()->create();
    $mailable = new DeploymentSuccessful($application);
    $html = $mailable->withOrganization($organization)->render();

    // Verify inline styles are present
    expect($html)->toContain('style=');

    // Verify no external stylesheets (not supported in email)
    expect($html)->not->toContain('<link rel="stylesheet"');
});
```

## Definition of Done

- [ ] BrandedMailable trait created and tested
- [ ] Organization resolution logic working (auth, model, explicit)
- [ ] Base branded email layout created
- [ ] Responsive email design working on mobile and desktop
- [ ] Blade email components created (button, alert, card, header, footer)
- [ ] All existing Coolify notifications extended with branding
- [ ] Plain-text email versions generated
- [ ] Organization logo embedded using CID attachment
- [ ] Inline CSS generated for email client compatibility
- [ ] Branding variables cached for performance
- [ ] Cache invalidation on branding updates
- [ ] Fallback branding for system emails
- [ ] WhiteLabelService email methods implemented
- [ ] Email preview in BrandingManager UI
- [ ] EmailBrandingTestingTrait created
- [ ] Unit tests written (10+ tests, >90% coverage)
- [ ] Integration tests written (8+ tests)
- [ ] Manual email client testing completed
- [ ] Documentation updated with usage examples
- [ ] Code follows Laravel Mail best practices
- [ ] PHPStan level 5 passing
- [ ] Laravel Pint formatting applied
- [ ] Code reviewed and approved
- [ ] No rendering issues in Gmail, Outlook, Apple Mail
- [ ] Both HTML and plain-text versions tested
- [ ] Performance verified (cached templates < 50ms lookup)

## Related Tasks

- **Uses:** Task 2 (DynamicAssetController serves email logos)
- **Cached by:** Task 3 (Redis caching for compiled templates)
- **Shows logos from:** Task 4 (LogoUploader uploaded logos in emails)
- **Integrates with:** Task 5 (BrandingManager email preview)
- **Uses colors from:** Task 6 (ThemeCustomizer selected colors)
- **Shows in preview:** Task 8 (BrandingPreview email visualization)
- **Triggered by:** Task 10 (BrandingCacheWarmerJob clears email cache)
