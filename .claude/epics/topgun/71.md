---
name: Add domain management tests with registrar API mocking
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:39:23Z
github: https://github.com/johnproblems/topgun/issues/178
depends_on: [64, 65, 66, 67, 68]
parallel: false
conflicts_with: []
---

# Task: Add domain management tests with registrar API mocking

## Description

Implement comprehensive test coverage for the domain management system, including unit tests for all domain services, integration tests for complete workflows, and registrar API mocking infrastructure. This task ensures the domain management system (Tasks 64-70) is production-ready by validating domain registration, DNS management, SSL provisioning, and ownership verification workflows through automated testing.

Domain management involves complex interactions with external registrar APIs (Namecheap, Route53, Cloudflare), DNS propagation verification, Let's Encrypt certificate provisioning, and asynchronous job execution. Testing these integrations without reliable mocks would result in:

1. **Slow tests**: Real API calls add 5-10 seconds per test
2. **Flaky tests**: Network issues and rate limits cause intermittent failures
3. **Cost concerns**: Many registrar APIs charge per request or have strict quotas
4. **Environment pollution**: Test domain registrations create real DNS records
5. **Unreliable CI/CD**: External dependencies break automated pipelines

**The Solution:**

This task creates a robust testing framework with:

- **Registrar API Mocking**: HTTP client mocking for all registrar integrations (Namecheap, Route53, Cloudflare)
- **Testing Traits**: Reusable test helpers for domain creation, DNS record management, SSL provisioning
- **Factory Integration**: Extended factories for realistic test data generation
- **Event Testing**: Validation of domain lifecycle events (registered, renewed, transferred, deleted)
- **Job Testing**: Asynchronous job execution with queue mocking
- **Error Simulation**: Realistic API error responses for robust error handling validation
- **Performance Benchmarks**: Response time assertions to ensure SLA compliance

**Integration Points:**

- **DomainRegistrarService (Task 66)**: Test all domain operations (register, renew, transfer, check availability)
- **DnsManagementService (Task 67)**: Test DNS record creation, updates, deletion, propagation checks
- **SSL Certificate Provisioning (Task 68)**: Test Let's Encrypt integration, ACME challenges, certificate renewal
- **Domain Ownership Verification (Task 69)**: Test DNS TXT verification and file upload methods
- **Vue.js Components (Task 70)**: Browser tests for domain management UI
- **Background Jobs**: Test async domain registration, DNS propagation monitoring, SSL renewal

**Why This Task Is Critical:**

Domain management directly impacts application availabilityâ€”incorrect DNS records cause outages, failed SSL renewals break HTTPS, and domain registration errors prevent application deployment. Comprehensive test coverage ensures these critical operations work reliably across all supported registrars and edge cases (API failures, rate limits, invalid configurations, DNS conflicts).

Without this testing infrastructure, domain management bugs would surface in production, causing customer-facing outages and support escalations. Automated tests provide confidence that domain operations work correctly before deployment, reducing risk and enabling rapid iteration on domain features.

## Acceptance Criteria

- [ ] DomainTestingTrait created with domain workflow helpers
- [ ] Registrar API HTTP mocking infrastructure implemented for all providers
- [ ] Unit tests for DomainRegistrarService covering all registrars (Namecheap, Route53, Cloudflare)
- [ ] Unit tests for DnsManagementService covering all record types (A, AAAA, CNAME, MX, TXT, SRV)
- [ ] Unit tests for SSL certificate provisioning service
- [ ] Unit tests for domain ownership verification methods
- [ ] Integration tests for complete domain registration workflow
- [ ] Integration tests for DNS record management workflow
- [ ] Integration tests for SSL certificate provisioning workflow
- [ ] Job tests for asynchronous domain operations
- [ ] Event tests for domain lifecycle events
- [ ] API endpoint tests with organization scoping validation
- [ ] Browser tests (Dusk) for domain management UI components
- [ ] Error simulation tests for all registrar API failure scenarios
- [ ] Rate limiting and retry logic validation tests
- [ ] Performance benchmark tests (domain operations < 5 seconds)
- [ ] Test coverage >90% for domain-related code
- [ ] All tests passing without external API dependencies

## Technical Details

### File Paths

**Testing Traits:**
- `/home/topgun/topgun/tests/Traits/DomainTestingTrait.php` (new)

**Unit Tests:**
- `/home/topgun/topgun/tests/Unit/Services/DomainRegistrarServiceTest.php` (new)
- `/home/topgun/topgun/tests/Unit/Services/DnsManagementServiceTest.php` (new)
- `/home/topgun/topgun/tests/Unit/Services/SslProvisioningServiceTest.php` (new)
- `/home/topgun/topgun/tests/Unit/Services/DomainOwnershipVerificationServiceTest.php` (new)

**Integration Tests:**
- `/home/topgun/topgun/tests/Feature/Enterprise/DomainRegistrationWorkflowTest.php` (new)
- `/home/topgun/topgun/tests/Feature/Enterprise/DnsManagementWorkflowTest.php` (new)
- `/home/topgun/topgun/tests/Feature/Enterprise/SslProvisioningWorkflowTest.php` (new)
- `/home/topgun/topgun/tests/Feature/Enterprise/DomainOwnershipVerificationTest.php` (new)

**Job Tests:**
- `/home/topgun/topgun/tests/Unit/Jobs/RegisterDomainJobTest.php` (new)
- `/home/topgun/topgun/tests/Unit/Jobs/CheckDnsPropagationJobTest.php` (new)
- `/home/topgun/topgun/tests/Unit/Jobs/RenewSslCertificateJobTest.php` (new)

**Browser Tests:**
- `/home/topgun/topgun/tests/Browser/Enterprise/DomainManagementTest.php` (new)

**API Tests:**
- `/home/topgun/topgun/tests/Feature/Api/DomainManagementApiTest.php` (new)

**Mock Infrastructure:**
- `/home/topgun/topgun/tests/Mocks/RegistrarApiMock.php` (new)
- `/home/topgun/topgun/tests/Fixtures/RegistrarResponses.php` (new)

### DomainTestingTrait Implementation

**File:** `tests/Traits/DomainTestingTrait.php`

```php
<?php

namespace Tests\Traits;

use App\Models\Organization;
use App\Models\OrganizationDomain;
use App\Models\DnsRecord;
use App\Models\SslCertificate;
use Illuminate\Support\Facades\Http;

trait DomainTestingTrait
{
    /**
     * Create a test domain for organization
     *
     * @param Organization|null $organization
     * @param array $attributes
     * @return OrganizationDomain
     */
    protected function createTestDomain(?Organization $organization = null, array $attributes = []): OrganizationDomain
    {
        $organization = $organization ?? Organization::factory()->create();

        return OrganizationDomain::factory()->create(array_merge([
            'organization_id' => $organization->id,
            'domain' => $this->generateTestDomainName(),
            'registrar' => 'namecheap',
            'status' => 'active',
        ], $attributes));
    }

    /**
     * Create multiple test domains
     *
     * @param Organization $organization
     * @param int $count
     * @return \Illuminate\Support\Collection
     */
    protected function createTestDomains(Organization $organization, int $count = 3): \Illuminate\Support\Collection
    {
        return OrganizationDomain::factory()
            ->count($count)
            ->create(['organization_id' => $organization->id]);
    }

    /**
     * Generate unique test domain name
     *
     * @return string
     */
    protected function generateTestDomainName(): string
    {
        return 'test-' . uniqid() . '.example.com';
    }

    /**
     * Create DNS records for domain
     *
     * @param OrganizationDomain $domain
     * @param int $count
     * @return \Illuminate\Support\Collection
     */
    protected function createDnsRecords(OrganizationDomain $domain, int $count = 5): \Illuminate\Support\Collection
    {
        return DnsRecord::factory()
            ->count($count)
            ->create(['organization_domain_id' => $domain->id]);
    }

    /**
     * Mock Namecheap API responses
     *
     * @param array $responses
     * @return void
     */
    protected function mockNamecheapApi(array $responses = []): void
    {
        $defaultResponses = [
            'check' => $this->namecheapCheckResponse(available: true),
            'register' => $this->namecheapRegisterResponse(success: true),
            'renew' => $this->namecheapRenewResponse(success: true),
            'getInfo' => $this->namecheapDomainInfoResponse(),
            'setDns' => $this->namecheapSetDnsResponse(success: true),
        ];

        $responses = array_merge($defaultResponses, $responses);

        Http::fake([
            'api.namecheap.com/xml.response*namecheap.domains.check*' =>
                Http::response($responses['check'], 200),
            'api.namecheap.com/xml.response*namecheap.domains.create*' =>
                Http::response($responses['register'], 200),
            'api.namecheap.com/xml.response*namecheap.domains.renew*' =>
                Http::response($responses['renew'], 200),
            'api.namecheap.com/xml.response*namecheap.domains.getInfo*' =>
                Http::response($responses['getInfo'], 200),
            'api.namecheap.com/xml.response*namecheap.domains.dns.setHosts*' =>
                Http::response($responses['setDns'], 200),
        ]);
    }

    /**
     * Mock Route53 API responses
     *
     * @param array $responses
     * @return void
     */
    protected function mockRoute53Api(array $responses = []): void
    {
        $defaultResponses = [
            'checkDomainAvailability' => $this->route53CheckResponse(available: true),
            'registerDomain' => $this->route53RegisterResponse(success: true),
            'renewDomain' => $this->route53RenewResponse(success: true),
            'getDomainDetail' => $this->route53DomainDetailResponse(),
            'changeResourceRecordSets' => $this->route53ChangeRecordSetsResponse(success: true),
        ];

        $responses = array_merge($defaultResponses, $responses);

        Http::fake([
            'route53domains.*.amazonaws.com/*' => function ($request) use ($responses) {
                $action = $request->header('X-Amz-Target')[0] ?? '';

                return match (true) {
                    str_contains($action, 'CheckDomainAvailability') =>
                        Http::response($responses['checkDomainAvailability'], 200),
                    str_contains($action, 'RegisterDomain') =>
                        Http::response($responses['registerDomain'], 200),
                    str_contains($action, 'RenewDomain') =>
                        Http::response($responses['renewDomain'], 200),
                    str_contains($action, 'GetDomainDetail') =>
                        Http::response($responses['getDomainDetail'], 200),
                    default => Http::response(['error' => 'Unknown action'], 400),
                };
            },
        ]);
    }

    /**
     * Mock Cloudflare API responses
     *
     * @param array $responses
     * @return void
     */
    protected function mockCloudflareApi(array $responses = []): void
    {
        $defaultResponses = [
            'listZones' => $this->cloudflareListZonesResponse(),
            'createZone' => $this->cloudflareCreateZoneResponse(success: true),
            'getDnsRecords' => $this->cloudflareGetDnsRecordsResponse(),
            'createDnsRecord' => $this->cloudflareCreateDnsRecordResponse(success: true),
            'updateDnsRecord' => $this->cloudflareUpdateDnsRecordResponse(success: true),
            'deleteDnsRecord' => $this->cloudflareDeleteDnsRecordResponse(success: true),
        ];

        $responses = array_merge($defaultResponses, $responses);

        Http::fake([
            'api.cloudflare.com/client/v4/zones' =>
                Http::response($responses['listZones'], 200),
            'api.cloudflare.com/client/v4/zones/*/dns_records' =>
                Http::response($responses['getDnsRecords'], 200),
            'api.cloudflare.com/client/v4/zones/*/dns_records/*' =>
                function ($request) use ($responses) {
                    return match ($request->method()) {
                        'POST' => Http::response($responses['createDnsRecord'], 200),
                        'PUT', 'PATCH' => Http::response($responses['updateDnsRecord'], 200),
                        'DELETE' => Http::response($responses['deleteDnsRecord'], 200),
                        default => Http::response(['error' => 'Method not allowed'], 405),
                    };
                },
        ]);
    }

    /**
     * Mock Let's Encrypt ACME challenge
     *
     * @param bool $success
     * @return void
     */
    protected function mockLetsEncryptChallenge(bool $success = true): void
    {
        Http::fake([
            'acme-v02.api.letsencrypt.org/*' => Http::response([
                'status' => $success ? 'valid' : 'invalid',
                'challenges' => [
                    [
                        'type' => 'http-01',
                        'status' => $success ? 'valid' : 'pending',
                        'url' => 'https://acme-v02.api.letsencrypt.org/challenge/123',
                        'token' => 'test-token-123',
                    ],
                ],
            ], 200),
        ]);
    }

    /**
     * Create SSL certificate for domain
     *
     * @param OrganizationDomain $domain
     * @param array $attributes
     * @return SslCertificate
     */
    protected function createSslCertificate(OrganizationDomain $domain, array $attributes = []): SslCertificate
    {
        return SslCertificate::factory()->create(array_merge([
            'organization_domain_id' => $domain->id,
            'issuer' => 'Let\'s Encrypt',
            'status' => 'active',
            'valid_from' => now(),
            'valid_until' => now()->addDays(90),
        ], $attributes));
    }

    /**
     * Assert DNS record exists
     *
     * @param OrganizationDomain $domain
     * @param string $type
     * @param string $name
     * @param string $value
     * @return void
     */
    protected function assertDnsRecordExists(
        OrganizationDomain $domain,
        string $type,
        string $name,
        string $value
    ): void {
        $this->assertDatabaseHas('dns_records', [
            'organization_domain_id' => $domain->id,
            'type' => $type,
            'name' => $name,
            'value' => $value,
        ]);
    }

    /**
     * Assert domain has active SSL certificate
     *
     * @param OrganizationDomain $domain
     * @return void
     */
    protected function assertHasActiveSslCertificate(OrganizationDomain $domain): void
    {
        $this->assertTrue(
            $domain->sslCertificates()
                ->where('status', 'active')
                ->where('valid_until', '>', now())
                ->exists(),
            "Domain {$domain->domain} does not have an active SSL certificate"
        );
    }

    // Private helper methods for mock responses

    private function namecheapCheckResponse(bool $available): string
    {
        $status = $available ? 'true' : 'false';
        return <<<XML
<?xml version="1.0" encoding="utf-8"?>
<ApiResponse Status="OK">
  <CommandResponse Type="namecheap.domains.check">
    <DomainCheckResult Domain="example.com" Available="{$status}" />
  </CommandResponse>
</ApiResponse>
XML;
    }

    private function namecheapRegisterResponse(bool $success): string
    {
        $status = $success ? 'OK' : 'ERROR';
        return <<<XML
<?xml version="1.0" encoding="utf-8"?>
<ApiResponse Status="{$status}">
  <CommandResponse Type="namecheap.domains.create">
    <DomainCreateResult Domain="example.com" Registered="true" ChargedAmount="10.87" DomainID="12345" OrderID="67890" TransactionID="111213" />
  </CommandResponse>
</ApiResponse>
XML;
    }

    private function namecheapRenewResponse(bool $success): string
    {
        $status = $success ? 'OK' : 'ERROR';
        return <<<XML
<?xml version="1.0" encoding="utf-8"?>
<ApiResponse Status="{$status}">
  <CommandResponse Type="namecheap.domains.renew">
    <DomainRenewResult DomainName="example.com" DomainID="12345" Renewed="true" ChargedAmount="10.87" />
  </CommandResponse>
</ApiResponse>
XML;
    }

    private function namecheapDomainInfoResponse(): string
    {
        return <<<XML
<?xml version="1.0" encoding="utf-8"?>
<ApiResponse Status="OK">
  <CommandResponse Type="namecheap.domains.getInfo">
    <DomainGetInfoResult Status="Ok" ID="12345" DomainName="example.com" OwnerName="Test User" IsOwner="true">
      <DomainDetails>
        <CreatedDate>2024-01-01</CreatedDate>
        <ExpiredDate>2025-01-01</ExpiredDate>
        <NumYears>1</NumYears>
      </DomainDetails>
    </DomainGetInfoResult>
  </CommandResponse>
</ApiResponse>
XML;
    }

    private function namecheapSetDnsResponse(bool $success): string
    {
        $status = $success ? 'OK' : 'ERROR';
        return <<<XML
<?xml version="1.0" encoding="utf-8"?>
<ApiResponse Status="{$status}">
  <CommandResponse Type="namecheap.domains.dns.setHosts">
    <DomainDNSSetHostsResult Domain="example.com" IsSuccess="true" />
  </CommandResponse>
</ApiResponse>
XML;
    }

    private function route53CheckResponse(bool $available): array
    {
        return [
            'Availability' => $available ? 'AVAILABLE' : 'UNAVAILABLE',
        ];
    }

    private function route53RegisterResponse(bool $success): array
    {
        return [
            'OperationId' => 'op-12345',
        ];
    }

    private function route53RenewResponse(bool $success): array
    {
        return [
            'OperationId' => 'op-67890',
        ];
    }

    private function route53DomainDetailResponse(): array
    {
        return [
            'DomainName' => 'example.com',
            'AdminContact' => [
                'FirstName' => 'Test',
                'LastName' => 'User',
                'Email' => 'test@example.com',
            ],
            'RegistrantContact' => [
                'FirstName' => 'Test',
                'LastName' => 'User',
                'Email' => 'test@example.com',
            ],
            'TechContact' => [
                'FirstName' => 'Test',
                'LastName' => 'User',
                'Email' => 'test@example.com',
            ],
            'CreationDate' => '2024-01-01T00:00:00Z',
            'ExpirationDate' => '2025-01-01T00:00:00Z',
            'Nameservers' => [
                ['Name' => 'ns1.example.com'],
                ['Name' => 'ns2.example.com'],
            ],
        ];
    }

    private function route53ChangeRecordSetsResponse(bool $success): array
    {
        return [
            'ChangeInfo' => [
                'Id' => '/change/C12345',
                'Status' => $success ? 'INSYNC' : 'PENDING',
                'SubmittedAt' => now()->toIso8601String(),
            ],
        ];
    }

    private function cloudflareListZonesResponse(): array
    {
        return [
            'success' => true,
            'result' => [
                [
                    'id' => 'zone-123',
                    'name' => 'example.com',
                    'status' => 'active',
                    'name_servers' => ['ns1.cloudflare.com', 'ns2.cloudflare.com'],
                ],
            ],
        ];
    }

    private function cloudflareCreateZoneResponse(bool $success): array
    {
        return [
            'success' => $success,
            'result' => [
                'id' => 'zone-' . uniqid(),
                'name' => 'example.com',
                'status' => 'active',
            ],
        ];
    }

    private function cloudflareGetDnsRecordsResponse(): array
    {
        return [
            'success' => true,
            'result' => [
                [
                    'id' => 'record-123',
                    'type' => 'A',
                    'name' => 'example.com',
                    'content' => '192.0.2.1',
                    'ttl' => 3600,
                ],
            ],
        ];
    }

    private function cloudflareCreateDnsRecordResponse(bool $success): array
    {
        return [
            'success' => $success,
            'result' => [
                'id' => 'record-' . uniqid(),
                'type' => 'A',
                'name' => 'example.com',
                'content' => '192.0.2.1',
                'ttl' => 3600,
            ],
        ];
    }

    private function cloudflareUpdateDnsRecordResponse(bool $success): array
    {
        return $this->cloudflareCreateDnsRecordResponse($success);
    }

    private function cloudflareDeleteDnsRecordResponse(bool $success): array
    {
        return [
            'success' => $success,
            'result' => ['id' => 'record-123'],
        ];
    }
}
```

### Unit Tests: DomainRegistrarService

**File:** `tests/Unit/Services/DomainRegistrarServiceTest.php`

```php
<?php

namespace Tests\Unit\Services;

use App\Services\Enterprise\DomainRegistrarService;
use App\Models\Organization;
use App\Models\OrganizationDomain;
use Tests\TestCase;
use Tests\Traits\DomainTestingTrait;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\Http;

class DomainRegistrarServiceTest extends TestCase
{
    use RefreshDatabase, DomainTestingTrait;

    private DomainRegistrarService $service;
    private Organization $organization;

    protected function setUp(): void
    {
        parent::setUp();
        $this->service = app(DomainRegistrarService::class);
        $this->organization = Organization::factory()->create();
    }

    /** @test */
    public function it_checks_domain_availability_via_namecheap()
    {
        $this->mockNamecheapApi([
            'check' => $this->namecheapCheckResponse(available: true),
        ]);

        $result = $this->service->checkAvailability('example.com', 'namecheap');

        expect($result)->toBeTrue();
    }

    /** @test */
    public function it_detects_unavailable_domains_via_namecheap()
    {
        $this->mockNamecheapApi([
            'check' => $this->namecheapCheckResponse(available: false),
        ]);

        $result = $this->service->checkAvailability('example.com', 'namecheap');

        expect($result)->toBeFalse();
    }

    /** @test */
    public function it_registers_domain_via_namecheap()
    {
        $this->mockNamecheapApi();

        $domain = $this->service->registerDomain(
            $this->organization,
            'example.com',
            'namecheap',
            [
                'registrant' => [
                    'first_name' => 'John',
                    'last_name' => 'Doe',
                    'email' => 'john@example.com',
                ],
                'years' => 1,
            ]
        );

        expect($domain)
            ->toBeInstanceOf(OrganizationDomain::class)
            ->organization_id->toBe($this->organization->id)
            ->domain->toBe('example.com')
            ->registrar->toBe('namecheap')
            ->status->toBe('active');

        $this->assertDatabaseHas('organization_domains', [
            'domain' => 'example.com',
            'organization_id' => $this->organization->id,
        ]);
    }

    /** @test */
    public function it_renews_domain_via_namecheap()
    {
        $this->mockNamecheapApi();

        $domain = $this->createTestDomain($this->organization, [
            'registrar' => 'namecheap',
            'expires_at' => now()->addDays(30),
        ]);

        $result = $this->service->renewDomain($domain, years: 1);

        expect($result)->toBeTrue();

        $domain->refresh();
        expect($domain->expires_at->greaterThan(now()->addDays(30)))->toBeTrue();
    }

    /** @test */
    public function it_transfers_domain_via_namecheap()
    {
        $this->mockNamecheapApi();

        $result = $this->service->transferDomain(
            $this->organization,
            'example.com',
            'namecheap',
            authCode: 'ABC123XYZ'
        );

        expect($result)
            ->toBeInstanceOf(OrganizationDomain::class)
            ->status->toBe('transferring');
    }

    /** @test */
    public function it_checks_domain_availability_via_route53()
    {
        $this->mockRoute53Api([
            'checkDomainAvailability' => $this->route53CheckResponse(available: true),
        ]);

        $result = $this->service->checkAvailability('example.com', 'route53');

        expect($result)->toBeTrue();
    }

    /** @test */
    public function it_registers_domain_via_route53()
    {
        $this->mockRoute53Api();

        $domain = $this->service->registerDomain(
            $this->organization,
            'example.com',
            'route53',
            [
                'registrant' => [
                    'first_name' => 'Jane',
                    'last_name' => 'Smith',
                    'email' => 'jane@example.com',
                ],
                'years' => 1,
            ]
        );

        expect($domain)
            ->toBeInstanceOf(OrganizationDomain::class)
            ->registrar->toBe('route53');
    }

    /** @test */
    public function it_handles_registrar_api_errors_gracefully()
    {
        Http::fake([
            'api.namecheap.com/*' => Http::response([
                'error' => 'API authentication failed',
            ], 401),
        ]);

        $this->expectException(\App\Exceptions\DomainRegistrarException::class);

        $this->service->checkAvailability('example.com', 'namecheap');
    }

    /** @test */
    public function it_retries_on_transient_failures()
    {
        Http::fake([
            'api.namecheap.com/*' => Http::sequence()
                ->push(['error' => 'Timeout'], 500)
                ->push(['error' => 'Timeout'], 500)
                ->push($this->namecheapCheckResponse(available: true), 200),
        ]);

        $result = $this->service->checkAvailability('example.com', 'namecheap');

        expect($result)->toBeTrue();
        Http::assertSentCount(3);
    }

    /** @test */
    public function it_validates_registrant_information()
    {
        $this->expectException(\Illuminate\Validation\ValidationException::class);

        $this->service->registerDomain(
            $this->organization,
            'example.com',
            'namecheap',
            [
                'registrant' => [
                    // Missing required fields
                    'email' => 'invalid-email',
                ],
            ]
        );
    }

    /** @test */
    public function it_gets_domain_information_via_namecheap()
    {
        $this->mockNamecheapApi();

        $domain = $this->createTestDomain($this->organization, [
            'registrar' => 'namecheap',
        ]);

        $info = $this->service->getDomainInfo($domain);

        expect($info)
            ->toHaveKeys(['created_at', 'expires_at', 'status'])
            ->status->toBe('Ok');
    }

    /** @test */
    public function it_supports_multiple_registrars()
    {
        $supportedRegistrars = $this->service->getSupportedRegistrars();

        expect($supportedRegistrars)
            ->toContain('namecheap')
            ->toContain('route53')
            ->toContain('cloudflare');
    }
}
```

### Unit Tests: DnsManagementService

**File:** `tests/Unit/Services/DnsManagementServiceTest.php`

```php
<?php

namespace Tests\Unit\Services;

use App\Services\Enterprise\DnsManagementService;
use App\Models\OrganizationDomain;
use App\Models\DnsRecord;
use Tests\TestCase;
use Tests\Traits\DomainTestingTrait;
use Illuminate\Foundation\Testing\RefreshDatabase;

class DnsManagementServiceTest extends TestCase
{
    use RefreshDatabase, DomainTestingTrait;

    private DnsManagementService $service;
    private OrganizationDomain $domain;

    protected function setUp(): void
    {
        parent::setUp();
        $this->service = app(DnsManagementService::class);
        $this->domain = $this->createTestDomain();
    }

    /** @test */
    public function it_creates_a_record()
    {
        $this->mockCloudflareApi();

        $record = $this->service->createRecord($this->domain, [
            'type' => 'A',
            'name' => '@',
            'value' => '192.0.2.1',
            'ttl' => 3600,
        ]);

        expect($record)
            ->toBeInstanceOf(DnsRecord::class)
            ->type->toBe('A')
            ->value->toBe('192.0.2.1');

        $this->assertDnsRecordExists($this->domain, 'A', '@', '192.0.2.1');
    }

    /** @test */
    public function it_creates_cname_record()
    {
        $this->mockCloudflareApi();

        $record = $this->service->createRecord($this->domain, [
            'type' => 'CNAME',
            'name' => 'www',
            'value' => 'example.com',
            'ttl' => 3600,
        ]);

        expect($record->type)->toBe('CNAME');
        $this->assertDnsRecordExists($this->domain, 'CNAME', 'www', 'example.com');
    }

    /** @test */
    public function it_creates_mx_record()
    {
        $this->mockCloudflareApi();

        $record = $this->service->createRecord($this->domain, [
            'type' => 'MX',
            'name' => '@',
            'value' => 'mail.example.com',
            'priority' => 10,
            'ttl' => 3600,
        ]);

        expect($record)
            ->type->toBe('MX')
            ->priority->toBe(10);
    }

    /** @test */
    public function it_creates_txt_record()
    {
        $this->mockCloudflareApi();

        $record = $this->service->createRecord($this->domain, [
            'type' => 'TXT',
            'name' => '@',
            'value' => 'v=spf1 include:_spf.example.com ~all',
            'ttl' => 3600,
        ]);

        expect($record->type)->toBe('TXT');
    }

    /** @test */
    public function it_creates_srv_record()
    {
        $this->mockCloudflareApi();

        $record = $this->service->createRecord($this->domain, [
            'type' => 'SRV',
            'name' => '_service._tcp',
            'value' => 'target.example.com',
            'priority' => 10,
            'weight' => 5,
            'port' => 8080,
            'ttl' => 3600,
        ]);

        expect($record)
            ->type->toBe('SRV')
            ->priority->toBe(10)
            ->weight->toBe(5)
            ->port->toBe(8080);
    }

    /** @test */
    public function it_updates_dns_record()
    {
        $this->mockCloudflareApi();

        $record = DnsRecord::factory()->create([
            'organization_domain_id' => $this->domain->id,
            'type' => 'A',
            'value' => '192.0.2.1',
        ]);

        $updated = $this->service->updateRecord($record, [
            'value' => '192.0.2.2',
        ]);

        expect($updated->value)->toBe('192.0.2.2');
    }

    /** @test */
    public function it_deletes_dns_record()
    {
        $this->mockCloudflareApi();

        $record = DnsRecord::factory()->create([
            'organization_domain_id' => $this->domain->id,
        ]);

        $result = $this->service->deleteRecord($record);

        expect($result)->toBeTrue();
        $this->assertDatabaseMissing('dns_records', ['id' => $record->id]);
    }

    /** @test */
    public function it_validates_dns_record_data()
    {
        $this->expectException(\Illuminate\Validation\ValidationException::class);

        $this->service->createRecord($this->domain, [
            'type' => 'A',
            'name' => '@',
            'value' => 'invalid-ip-address',
        ]);
    }

    /** @test */
    public function it_checks_dns_propagation()
    {
        $record = DnsRecord::factory()->create([
            'organization_domain_id' => $this->domain->id,
            'type' => 'A',
            'name' => '@',
            'value' => '192.0.2.1',
        ]);

        // Mock DNS lookup
        $this->mock(\App\Services\Enterprise\DnsLookupService::class)
            ->shouldReceive('lookup')
            ->with($this->domain->domain, 'A')
            ->andReturn(['192.0.2.1']);

        $result = $this->service->checkPropagation($record);

        expect($result)->toBeTrue();
    }

    /** @test */
    public function it_detects_dns_conflicts()
    {
        DnsRecord::factory()->create([
            'organization_domain_id' => $this->domain->id,
            'type' => 'A',
            'name' => '@',
            'value' => '192.0.2.1',
        ]);

        $conflicts = $this->service->checkConflicts($this->domain, [
            'type' => 'A',
            'name' => '@',
            'value' => '192.0.2.2',
        ]);

        expect($conflicts)->toHaveCount(1);
    }

    /** @test */
    public function it_bulk_creates_dns_records()
    {
        $this->mockCloudflareApi();

        $records = $this->service->bulkCreateRecords($this->domain, [
            ['type' => 'A', 'name' => '@', 'value' => '192.0.2.1'],
            ['type' => 'A', 'name' => 'www', 'value' => '192.0.2.1'],
            ['type' => 'MX', 'name' => '@', 'value' => 'mail.example.com', 'priority' => 10],
        ]);

        expect($records)->toHaveCount(3);
    }

    /** @test */
    public function it_gets_all_records_for_domain()
    {
        $this->createDnsRecords($this->domain, count: 5);

        $records = $this->service->getRecords($this->domain);

        expect($records)->toHaveCount(5);
    }

    /** @test */
    public function it_filters_records_by_type()
    {
        DnsRecord::factory()->create([
            'organization_domain_id' => $this->domain->id,
            'type' => 'A',
        ]);

        DnsRecord::factory()->create([
            'organization_domain_id' => $this->domain->id,
            'type' => 'CNAME',
        ]);

        $aRecords = $this->service->getRecordsByType($this->domain, 'A');

        expect($aRecords)->toHaveCount(1)
            ->first()->type->toBe('A');
    }
}
```

### Integration Tests: Domain Registration Workflow

**File:** `tests/Feature/Enterprise/DomainRegistrationWorkflowTest.php`

```php
<?php

namespace Tests\Feature\Enterprise;

use App\Models\Organization;
use App\Models\User;
use App\Jobs\Enterprise\RegisterDomainJob;
use Tests\TestCase;
use Tests\Traits\DomainTestingTrait;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\Queue;

class DomainRegistrationWorkflowTest extends TestCase
{
    use RefreshDatabase, DomainTestingTrait;

    private Organization $organization;
    private User $user;

    protected function setUp(): void
    {
        parent::setUp();

        $this->organization = Organization::factory()->create();
        $this->user = User::factory()->create();
        $this->organization->users()->attach($this->user, ['role' => 'admin']);
    }

    /** @test */
    public function it_completes_full_domain_registration_workflow()
    {
        $this->mockNamecheapApi();
        Queue::fake();

        // Step 1: Check availability
        $response = $this->actingAs($this->user)
            ->postJson("/api/v1/organizations/{$this->organization->id}/domains/check", [
                'domain' => 'example.com',
                'registrar' => 'namecheap',
            ]);

        $response->assertOk()
            ->assertJson(['available' => true]);

        // Step 2: Register domain
        $response = $this->actingAs($this->user)
            ->postJson("/api/v1/organizations/{$this->organization->id}/domains", [
                'domain' => 'example.com',
                'registrar' => 'namecheap',
                'registrant' => [
                    'first_name' => 'John',
                    'last_name' => 'Doe',
                    'email' => 'john@example.com',
                    'address' => '123 Main St',
                    'city' => 'Anytown',
                    'state' => 'CA',
                    'postal_code' => '12345',
                    'country' => 'US',
                    'phone' => '+1.5555555555',
                ],
                'years' => 1,
                'auto_renew' => true,
            ]);

        $response->assertCreated()
            ->assertJsonStructure([
                'id',
                'domain',
                'registrar',
                'status',
                'created_at',
            ]);

        // Verify job was dispatched
        Queue::assertPushed(RegisterDomainJob::class);

        // Verify database record
        $this->assertDatabaseHas('organization_domains', [
            'organization_id' => $this->organization->id,
            'domain' => 'example.com',
            'registrar' => 'namecheap',
        ]);
    }

    /** @test */
    public function it_prevents_duplicate_domain_registration()
    {
        $this->createTestDomain($this->organization, [
            'domain' => 'example.com',
        ]);

        $response = $this->actingAs($this->user)
            ->postJson("/api/v1/organizations/{$this->organization->id}/domains", [
                'domain' => 'example.com',
                'registrar' => 'namecheap',
                'registrant' => [/* valid data */],
            ]);

        $response->assertStatus(409)
            ->assertJson(['message' => 'Domain already registered']);
    }

    /** @test */
    public function it_enforces_organization_scoping()
    {
        $otherOrganization = Organization::factory()->create();

        $response = $this->actingAs($this->user)
            ->postJson("/api/v1/organizations/{$otherOrganization->id}/domains", [
                'domain' => 'example.com',
                'registrar' => 'namecheap',
            ]);

        $response->assertForbidden();
    }

    /** @test */
    public function it_validates_domain_name_format()
    {
        $response = $this->actingAs($this->user)
            ->postJson("/api/v1/organizations/{$this->organization->id}/domains", [
                'domain' => 'invalid domain name',
                'registrar' => 'namecheap',
            ]);

        $response->assertStatus(422)
            ->assertJsonValidationErrors(['domain']);
    }

    /** @test */
    public function it_handles_registrar_errors_gracefully()
    {
        $this->mockNamecheapApi([
            'register' => $this->namecheapRegisterResponse(success: false),
        ]);

        $response = $this->actingAs($this->user)
            ->postJson("/api/v1/organizations/{$this->organization->id}/domains", [
                'domain' => 'example.com',
                'registrar' => 'namecheap',
                'registrant' => [/* valid data */],
            ]);

        $response->assertStatus(500)
            ->assertJson(['message' => 'Domain registration failed']);
    }

    /** @test */
    public function it_renews_domain_successfully()
    {
        $this->mockNamecheapApi();

        $domain = $this->createTestDomain($this->organization, [
            'registrar' => 'namecheap',
            'expires_at' => now()->addDays(30),
        ]);

        $response = $this->actingAs($this->user)
            ->postJson("/api/v1/organizations/{$this->organization->id}/domains/{$domain->id}/renew", [
                'years' => 1,
            ]);

        $response->assertOk();

        $domain->refresh();
        expect($domain->expires_at->greaterThan(now()->addDays(30)))->toBeTrue();
    }

    /** @test */
    public function it_transfers_domain_with_auth_code()
    {
        $this->mockNamecheapApi();
        Queue::fake();

        $response = $this->actingAs($this->user)
            ->postJson("/api/v1/organizations/{$this->organization->id}/domains/transfer", [
                'domain' => 'example.com',
                'registrar' => 'namecheap',
                'auth_code' => 'ABC123XYZ',
            ]);

        $response->assertCreated()
            ->assertJson(['status' => 'transferring']);

        Queue::assertPushed(RegisterDomainJob::class);
    }

    /** @test */
    public function it_lists_organization_domains()
    {
        $this->createTestDomains($this->organization, count: 3);

        $response = $this->actingAs($this->user)
            ->getJson("/api/v1/organizations/{$this->organization->id}/domains");

        $response->assertOk()
            ->assertJsonCount(3, 'data');
    }

    /** @test */
    public function it_shows_domain_details()
    {
        $domain = $this->createTestDomain($this->organization);

        $response = $this->actingAs($this->user)
            ->getJson("/api/v1/organizations/{$this->organization->id}/domains/{$domain->id}");

        $response->assertOk()
            ->assertJson([
                'id' => $domain->id,
                'domain' => $domain->domain,
                'registrar' => $domain->registrar,
            ]);
    }

    /** @test */
    public function it_deletes_domain()
    {
        $domain = $this->createTestDomain($this->organization);

        $response = $this->actingAs($this->user)
            ->deleteJson("/api/v1/organizations/{$this->organization->id}/domains/{$domain->id}");

        $response->assertNoContent();

        $this->assertSoftDeleted('organization_domains', ['id' => $domain->id]);
    }
}
```

### Job Tests: RegisterDomainJob

**File:** `tests/Unit/Jobs/RegisterDomainJobTest.php`

```php
<?php

namespace Tests\Unit\Jobs;

use App\Jobs\Enterprise\RegisterDomainJob;
use App\Models\OrganizationDomain;
use App\Services\Enterprise\DomainRegistrarService;
use Tests\TestCase;
use Tests\Traits\DomainTestingTrait;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\Queue;

class RegisterDomainJobTest extends TestCase
{
    use RefreshDatabase, DomainTestingTrait;

    /** @test */
    public function it_dispatches_to_correct_queue()
    {
        Queue::fake();

        $domain = $this->createTestDomain();

        RegisterDomainJob::dispatch($domain);

        Queue::assertPushedOn('domain-management', RegisterDomainJob::class);
    }

    /** @test */
    public function it_registers_domain_successfully()
    {
        $this->mockNamecheapApi();

        $domain = OrganizationDomain::factory()->create([
            'status' => 'pending',
        ]);

        $job = new RegisterDomainJob($domain);
        $job->handle(app(DomainRegistrarService::class));

        $domain->refresh();
        expect($domain->status)->toBe('active');
    }

    /** @test */
    public function it_handles_registration_failures()
    {
        $this->mockNamecheapApi([
            'register' => $this->namecheapRegisterResponse(success: false),
        ]);

        $domain = OrganizationDomain::factory()->create([
            'status' => 'pending',
        ]);

        $job = new RegisterDomainJob($domain);

        $this->expectException(\App\Exceptions\DomainRegistrarException::class);

        $job->handle(app(DomainRegistrarService::class));

        $domain->refresh();
        expect($domain->status)->toBe('failed');
    }

    /** @test */
    public function it_retries_on_transient_failures()
    {
        $job = new RegisterDomainJob($this->createTestDomain());

        expect($job->tries)->toBe(3);
        expect($job->backoff)->toBe(60);
    }

    /** @test */
    public function it_has_correct_horizon_tags()
    {
        $domain = $this->createTestDomain();
        $job = new RegisterDomainJob($domain);

        $tags = $job->tags();

        expect($tags)
            ->toContain('domain-management')
            ->toContain("organization:{$domain->organization_id}");
    }
}
```

### Browser Tests: Domain Management UI

**File:** `tests/Browser/Enterprise/DomainManagementTest.php`

```php
<?php

namespace Tests\Browser\Enterprise;

use App\Models\Organization;
use App\Models\User;
use Laravel\Dusk\Browser;
use Tests\DuskTestCase;
use Tests\Traits\DomainTestingTrait;

class DomainManagementTest extends DuskTestCase
{
    use DomainTestingTrait;

    /** @test */
    public function it_allows_checking_domain_availability()
    {
        $this->mockNamecheapApi();

        $organization = Organization::factory()->create();
        $user = User::factory()->create();
        $organization->users()->attach($user, ['role' => 'admin']);

        $this->browse(function (Browser $browser) use ($user, $organization) {
            $browser->loginAs($user)
                ->visit("/organizations/{$organization->id}/domains")
                ->type('domain_search', 'example.com')
                ->click('@check-availability-button')
                ->waitForText('Available')
                ->assertSee('example.com is available');
        });
    }

    /** @test */
    public function it_registers_domain_via_ui()
    {
        $this->mockNamecheapApi();

        $organization = Organization::factory()->create();
        $user = User::factory()->create();
        $organization->users()->attach($user, ['role' => 'admin']);

        $this->browse(function (Browser $browser) use ($user, $organization) {
            $browser->loginAs($user)
                ->visit("/organizations/{$organization->id}/domains")
                ->click('@register-domain-button')
                ->type('domain', 'example.com')
                ->select('registrar', 'namecheap')
                ->type('registrant[first_name]', 'John')
                ->type('registrant[last_name]', 'Doe')
                ->type('registrant[email]', 'john@example.com')
                ->click('@submit-registration')
                ->waitForText('Domain registration initiated')
                ->assertSee('example.com');
        });
    }

    /** @test */
    public function it_manages_dns_records()
    {
        $this->mockCloudflareApi();

        $organization = Organization::factory()->create();
        $user = User::factory()->create();
        $organization->users()->attach($user, ['role' => 'admin']);
        $domain = $this->createTestDomain($organization);

        $this->browse(function (Browser $browser) use ($user, $organization, $domain) {
            $browser->loginAs($user)
                ->visit("/organizations/{$organization->id}/domains/{$domain->id}/dns")
                ->click('@add-dns-record')
                ->select('type', 'A')
                ->type('name', '@')
                ->type('value', '192.0.2.1')
                ->type('ttl', '3600')
                ->click('@save-dns-record')
                ->waitForText('DNS record created')
                ->assertSee('192.0.2.1');
        });
    }

    /** @test */
    public function it_provisions_ssl_certificate()
    {
        $this->mockLetsEncryptChallenge();

        $organization = Organization::factory()->create();
        $user = User::factory()->create();
        $organization->users()->attach($user, ['role' => 'admin']);
        $domain = $this->createTestDomain($organization);

        $this->browse(function (Browser $browser) use ($user, $organization, $domain) {
            $browser->loginAs($user)
                ->visit("/organizations/{$organization->id}/domains/{$domain->id}")
                ->click('@provision-ssl-button')
                ->waitForText('SSL certificate provisioned')
                ->assertSee('Let\'s Encrypt');
        });
    }
}
```

## Implementation Approach

### Step 1: Create Testing Infrastructure
1. Create `DomainTestingTrait` with helper methods
2. Implement registrar API mock generators (Namecheap, Route53, Cloudflare)
3. Create response fixtures for all API scenarios
4. Set up HTTP client mocking

### Step 2: Write Unit Tests - DomainRegistrarService
1. Test domain availability checking for all registrars
2. Test domain registration workflow
3. Test domain renewal and transfer operations
4. Test error handling and retry logic
5. Test registrar-specific features

### Step 3: Write Unit Tests - DnsManagementService
1. Test DNS record creation for all types (A, AAAA, CNAME, MX, TXT, SRV)
2. Test DNS record updates and deletion
3. Test DNS propagation checking
4. Test conflict detection
5. Test bulk operations

### Step 4: Write Integration Tests
1. Test complete domain registration workflow
2. Test DNS management workflow
3. Test SSL provisioning workflow
4. Test organization scoping enforcement
5. Test authorization and permissions

### Step 5: Write Job Tests
1. Test RegisterDomainJob execution
2. Test CheckDnsPropagationJob
3. Test RenewSslCertificateJob
4. Test job retry logic
5. Test Horizon tags and queue assignment

### Step 6: Write Browser Tests
1. Test domain search and availability UI
2. Test domain registration form
3. Test DNS record management interface
4. Test SSL certificate provisioning UI
5. Test error states and loading indicators

### Step 7: API Testing
1. Test all domain API endpoints
2. Test organization scoping
3. Test rate limiting enforcement
4. Test authentication and authorization
5. Test pagination and filtering

### Step 8: Performance and Error Testing
1. Test response times for all operations
2. Test error scenarios (network failures, API errors)
3. Test rate limit handling
4. Test concurrent operations
5. Test large-scale operations

### Step 9: Coverage Analysis
1. Run PHPUnit coverage report
2. Identify untested code paths
3. Add tests for edge cases
4. Verify >90% coverage target
5. Document remaining gaps

## Test Strategy

### Unit Tests Coverage
- **DomainRegistrarService**: 15+ tests, >95% coverage
- **DnsManagementService**: 15+ tests, >95% coverage
- **SslProvisioningService**: 10+ tests, >90% coverage
- **OwnershipVerificationService**: 8+ tests, >90% coverage

### Integration Tests Coverage
- **Domain Registration**: 10+ tests covering full workflow
- **DNS Management**: 10+ tests covering CRUD operations
- **SSL Provisioning**: 8+ tests covering certificate lifecycle
- **API Endpoints**: 20+ tests covering all endpoints

### Job Tests Coverage
- **RegisterDomainJob**: 6+ tests
- **CheckDnsPropagationJob**: 5+ tests
- **RenewSslCertificateJob**: 5+ tests

### Browser Tests Coverage
- **Domain Management UI**: 8+ tests covering critical user journeys

### Performance Benchmarks
- Domain availability check: < 2 seconds
- Domain registration: < 5 seconds (async)
- DNS record creation: < 3 seconds
- SSL provisioning: < 30 seconds (async)

## Definition of Done

- [ ] DomainTestingTrait created with comprehensive helpers
- [ ] Registrar API mocking infrastructure complete
- [ ] HTTP response fixtures created for all scenarios
- [ ] DomainRegistrarService unit tests (15+ tests, >95% coverage)
- [ ] DnsManagementService unit tests (15+ tests, >95% coverage)
- [ ] SslProvisioningService unit tests (10+ tests, >90% coverage)
- [ ] OwnershipVerificationService unit tests (8+ tests, >90% coverage)
- [ ] Domain registration integration tests (10+ tests)
- [ ] DNS management integration tests (10+ tests)
- [ ] SSL provisioning integration tests (8+ tests)
- [ ] RegisterDomainJob tests (6+ tests)
- [ ] CheckDnsPropagationJob tests (5+ tests)
- [ ] RenewSslCertificateJob tests (5+ tests)
- [ ] API endpoint tests (20+ tests)
- [ ] Browser tests for domain management UI (8+ tests)
- [ ] Error simulation tests for all failure scenarios
- [ ] Performance benchmark tests passing
- [ ] Overall test coverage >90% for domain features
- [ ] All tests passing without external API dependencies
- [ ] PHPStan level 5 passing with zero errors
- [ ] Laravel Pint formatting applied
- [ ] Test documentation updated
- [ ] Code reviewed and approved

## Related Tasks

- **Depends on:** Task 64 (Namecheap API integration)
- **Depends on:** Task 65 (Route53 API integration)
- **Depends on:** Task 66 (DomainRegistrarService implementation)
- **Depends on:** Task 67 (DnsManagementService implementation)
- **Depends on:** Task 68 (SSL certificate provisioning)
- **Validates:** Task 69 (Domain ownership verification)
- **Validates:** Task 70 (Domain management UI components)
- **Integrates with:** Task 72 (OrganizationTestingTrait)
