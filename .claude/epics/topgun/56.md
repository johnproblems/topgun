---
name: Create new API endpoints for enterprise features
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:39:10Z
github: https://github.com/johnproblems/topgun/issues/164
depends_on: [52, 53]
parallel: false
conflicts_with: []
---

# Task: Create new API endpoints for enterprise features

## Description

Build a comprehensive RESTful API layer for all enterprise features introduced in the Coolify Enterprise Transformation project. This task creates organization-scoped, rate-limited, secure API endpoints that enable programmatic management of organizations, infrastructure provisioning, resource monitoring, white-label branding, payment subscriptions, and domain management—essentially providing API-first access to every enterprise capability.

Modern SaaS platforms require robust APIs for automation, integration, and third-party tool connectivity. This task transforms Coolify Enterprise from a UI-centric platform into an API-first system where every enterprise feature is accessible programmatically with the same security, authorization, and organization scoping guarantees as the web interface.

**Core Capabilities:**

1. **Organization Management API** - CRUD operations for organizations, users, invitations, and hierarchy relationships
2. **Infrastructure API** - Terraform provisioning, cloud provider credentials, server registration
3. **Resource Monitoring API** - Real-time metrics, historical data, capacity planning queries
4. **White-Label Branding API** - Logo upload, color customization, CSS retrieval, favicon management
5. **Payment & Subscription API** - Subscription management, payment methods, billing history, usage queries
6. **Domain Management API** - Domain registration, DNS records, SSL certificates, domain verification
7. **License Management API** - License validation, feature flag queries, usage limit checks

**Architecture Principles:**

- **Organization Scoping:** All endpoints automatically scoped to authenticated user's organization context via middleware
- **Sanctum Token Auth:** Bearer token authentication with scoped abilities (e.g., `organization:read`, `servers:write`)
- **Rate Limiting:** Tier-based limits enforced per organization (Starter: 100/min, Pro: 500/min, Enterprise: 2000/min)
- **Versioning:** API versioned at route level (`/api/v1/...`) for future compatibility
- **RESTful Design:** Standard HTTP verbs (GET, POST, PUT, PATCH, DELETE) with predictable resource URLs
- **Eloquent Resources:** Consistent JSON response formatting with resource transformers
- **Comprehensive Docs:** OpenAPI 3.0 specification with examples for every endpoint
- **Error Standards:** RFC 7807 Problem Details for HTTP APIs error format

**Integration Points:**

- **Depends on Task 52:** Sanctum token enhancements with organization context
- **Depends on Task 53:** ApiOrganizationScope middleware for automatic scoping
- **Used by Task 54:** Rate limiting applies to all endpoints defined here
- **Documented in Task 57:** OpenAPI spec generation includes these endpoints
- **Tested in Task 61:** API tests validate organization scoping and permissions

**Why This Task is Critical:**

APIs are the connective tissue of modern infrastructure. Without comprehensive API access, users are locked into the web UI and cannot:
- Automate infrastructure provisioning via CI/CD pipelines
- Integrate billing data with internal accounting systems
- Build custom dashboards with resource monitoring metrics
- Manage white-label branding programmatically across organizations
- Implement GitOps workflows for infrastructure-as-code

This task unlocks automation, integration, and programmatic control—essential for enterprise adoption. It also establishes patterns for future API development, ensuring consistency and quality across all Coolify Enterprise endpoints.

**Key Features:**

- **90+ API endpoints** covering all enterprise features
- **Organization-scoped responses** preventing cross-tenant data leakage
- **Comprehensive validation** with FormRequest classes for all input
- **Eloquent API Resources** for consistent response formatting
- **Policy-based authorization** matching web UI permissions
- **Pagination support** for large result sets
- **Filtering, sorting, searching** on collection endpoints
- **Rate limit headers** in all responses
- **CORS configuration** for web client integration
- **API documentation** auto-generated from route definitions

## Acceptance Criteria

- [ ] Organization management endpoints implemented (10 endpoints: list, create, show, update, delete, users, invite, remove user, hierarchy, switch)
- [ ] Infrastructure API endpoints implemented (12 endpoints: provision, destroy, status, credentials CRUD, servers list/show, cloud providers list)
- [ ] Resource monitoring endpoints implemented (8 endpoints: metrics, historical data, capacity scores, organization usage, quota status)
- [ ] White-label branding endpoints implemented (8 endpoints: config CRUD, logo upload/delete, CSS retrieval, favicon generation)
- [ ] Payment & subscription endpoints implemented (10 endpoints: subscriptions CRUD, payment methods CRUD, billing history, usage, invoices)
- [ ] Domain management endpoints implemented (12 endpoints: domains CRUD, DNS records CRUD, SSL certificates, verification status)
- [ ] License management endpoints implemented (6 endpoints: validate, features list, usage status, quota check)
- [ ] All endpoints organization-scoped via middleware (no cross-tenant access possible)
- [ ] All endpoints require authentication (Sanctum token validation)
- [ ] All endpoints use FormRequest validation classes
- [ ] All endpoints return responses via Eloquent API Resources
- [ ] All endpoints enforce policy-based authorization
- [ ] All collection endpoints support pagination (default 15 items per page)
- [ ] All collection endpoints support filtering and sorting
- [ ] Rate limit headers included in all responses
- [ ] CORS properly configured for cross-origin requests
- [ ] Error responses follow RFC 7807 standard format
- [ ] Success responses include consistent metadata (pagination, timestamps)
- [ ] 400/422 validation errors include field-specific messages

## Technical Details

### File Paths

**API Controllers:**
- `/home/topgun/topgun/app/Http/Controllers/Api/V1/OrganizationController.php` (new)
- `/home/topgun/topgun/app/Http/Controllers/Api/V1/InfrastructureController.php` (new)
- `/home/topgun/topgun/app/Http/Controllers/Api/V1/ResourceMonitoringController.php` (new)
- `/home/topgun/topgun/app/Http/Controllers/Api/V1/WhiteLabelController.php` (new)
- `/home/topgun/topgun/app/Http/Controllers/Api/V1/SubscriptionController.php` (new)
- `/home/topgun/topgun/app/Http/Controllers/Api/V1/DomainController.php` (new)
- `/home/topgun/topgun/app/Http/Controllers/Api/V1/LicenseController.php` (new)

**FormRequest Validation:**
- `/home/topgun/topgun/app/Http/Requests/Api/V1/Organization/CreateOrganizationRequest.php` (new)
- `/home/topgun/topgun/app/Http/Requests/Api/V1/Organization/UpdateOrganizationRequest.php` (new)
- `/home/topgun/topgun/app/Http/Requests/Api/V1/Infrastructure/ProvisionServerRequest.php` (new)
- `/home/topgun/topgun/app/Http/Requests/Api/V1/WhiteLabel/UpdateBrandingRequest.php` (new)
- `/home/topgun/topgun/app/Http/Requests/Api/V1/Subscription/CreateSubscriptionRequest.php` (new)
- `/home/topgun/topgun/app/Http/Requests/Api/V1/Domain/RegisterDomainRequest.php` (new)
- (Additional FormRequests for each endpoint with input)

**API Resources:**
- `/home/topgun/topgun/app/Http/Resources/V1/OrganizationResource.php` (new)
- `/home/topgun/topgun/app/Http/Resources/V1/OrganizationCollection.php` (new)
- `/home/topgun/topgun/app/Http/Resources/V1/ServerResource.php` (new)
- `/home/topgun/topgun/app/Http/Resources/V1/MetricResource.php` (new)
- `/home/topgun/topgun/app/Http/Resources/V1/WhiteLabelConfigResource.php` (new)
- `/home/topgun/topgun/app/Http/Resources/V1/SubscriptionResource.php` (new)
- `/home/topgun/topgun/app/Http/Resources/V1/DomainResource.php` (new)
- `/home/topgun/topgun/app/Http/Resources/V1/LicenseResource.php` (new)

**Routes:**
- `/home/topgun/topgun/routes/api.php` (modify - add all v1 routes)

**Middleware:**
- `/home/topgun/topgun/app/Http/Middleware/ApiOrganizationScope.php` (use from Task 53)
- `/home/topgun/topgun/app/Http/Middleware/ApiRateLimiter.php` (use from Task 54)

**Policies:**
- `/home/topgun/topgun/app/Policies/OrganizationPolicy.php` (enhance existing)
- `/home/topgun/topgun/app/Policies/ServerPolicy.php` (enhance existing)
- `/home/topgun/topgun/app/Policies/SubscriptionPolicy.php` (new)
- `/home/topgun/topgun/app/Policies/DomainPolicy.php` (new)

### API Route Structure

**File:** `routes/api.php`

```php
<?php

use Illuminate\Support\Facades\Route;
use App\Http\Controllers\Api\V1\OrganizationController;
use App\Http\Controllers\Api\V1\InfrastructureController;
use App\Http\Controllers\Api\V1\ResourceMonitoringController;
use App\Http\Controllers\Api\V1\WhiteLabelController;
use App\Http\Controllers\Api\V1\SubscriptionController;
use App\Http\Controllers\Api\V1\DomainController;
use App\Http\Controllers\Api\V1\LicenseController;

/*
|--------------------------------------------------------------------------
| API Routes - Version 1
|--------------------------------------------------------------------------
*/

Route::prefix('v1')->middleware(['auth:sanctum', 'api.organization.scope'])->group(function () {

    // Organization Management
    Route::prefix('organizations')->group(function () {
        Route::get('/', [OrganizationController::class, 'index']); // List accessible organizations
        Route::post('/', [OrganizationController::class, 'store']); // Create organization
        Route::get('/{organization}', [OrganizationController::class, 'show']); // Get organization details
        Route::put('/{organization}', [OrganizationController::class, 'update']); // Update organization
        Route::delete('/{organization}', [OrganizationController::class, 'destroy']); // Delete organization

        // Organization Users
        Route::get('/{organization}/users', [OrganizationController::class, 'users']); // List users
        Route::post('/{organization}/users', [OrganizationController::class, 'inviteUser']); // Invite user
        Route::delete('/{organization}/users/{user}', [OrganizationController::class, 'removeUser']); // Remove user

        // Organization Hierarchy
        Route::get('/{organization}/hierarchy', [OrganizationController::class, 'hierarchy']); // Get hierarchy tree
        Route::post('/switch', [OrganizationController::class, 'switchContext']); // Switch active organization
    });

    // Infrastructure Management
    Route::prefix('infrastructure')->group(function () {
        // Cloud Provider Credentials
        Route::get('/credentials', [InfrastructureController::class, 'listCredentials']);
        Route::post('/credentials', [InfrastructureController::class, 'storeCredentials']);
        Route::get('/credentials/{credential}', [InfrastructureController::class, 'showCredential']);
        Route::put('/credentials/{credential}', [InfrastructureController::class, 'updateCredential']);
        Route::delete('/credentials/{credential}', [InfrastructureController::class, 'deleteCredential']);

        // Server Provisioning
        Route::post('/provision', [InfrastructureController::class, 'provisionServer']); // Start Terraform provisioning
        Route::get('/deployments', [InfrastructureController::class, 'listDeployments']); // List Terraform deployments
        Route::get('/deployments/{deployment}', [InfrastructureController::class, 'showDeployment']); // Get deployment status
        Route::delete('/deployments/{deployment}', [InfrastructureController::class, 'destroyDeployment']); // Terraform destroy

        // Servers
        Route::get('/servers', [InfrastructureController::class, 'listServers']); // List registered servers
        Route::get('/servers/{server}', [InfrastructureController::class, 'showServer']); // Get server details

        // Cloud Providers
        Route::get('/providers', [InfrastructureController::class, 'listProviders']); // List supported providers
    });

    // Resource Monitoring
    Route::prefix('monitoring')->group(function () {
        Route::get('/metrics', [ResourceMonitoringController::class, 'currentMetrics']); // Current metrics for all servers
        Route::get('/metrics/{server}', [ResourceMonitoringController::class, 'serverMetrics']); // Metrics for specific server
        Route::get('/metrics/{server}/history', [ResourceMonitoringController::class, 'historicalMetrics']); // Time-series data
        Route::get('/capacity', [ResourceMonitoringController::class, 'capacityScores']); // Server capacity scores
        Route::get('/usage', [ResourceMonitoringController::class, 'organizationUsage']); // Organization resource usage
        Route::get('/quota', [ResourceMonitoringController::class, 'quotaStatus']); // License quota status
        Route::get('/trends', [ResourceMonitoringController::class, 'resourceTrends']); // Resource usage trends
        Route::get('/alerts', [ResourceMonitoringController::class, 'resourceAlerts']); // Capacity alerts
    });

    // White-Label Branding
    Route::prefix('branding')->group(function () {
        Route::get('/config', [WhiteLabelController::class, 'getConfig']); // Get branding configuration
        Route::put('/config', [WhiteLabelController::class, 'updateConfig']); // Update branding configuration
        Route::post('/logo', [WhiteLabelController::class, 'uploadLogo']); // Upload logo (multipart/form-data)
        Route::delete('/logo/{type}', [WhiteLabelController::class, 'deleteLogo']); // Delete logo (primary/favicon/email)
        Route::get('/css', [WhiteLabelController::class, 'getCompiledCSS']); // Get compiled CSS
        Route::post('/favicon/generate', [WhiteLabelController::class, 'generateFavicons']); // Regenerate favicons
        Route::get('/preview', [WhiteLabelController::class, 'previewBranding']); // Get preview data
        Route::delete('/cache', [WhiteLabelController::class, 'clearCache']); // Clear branding cache
    });

    // Payment & Subscriptions
    Route::prefix('subscriptions')->group(function () {
        Route::get('/', [SubscriptionController::class, 'index']); // List subscriptions
        Route::post('/', [SubscriptionController::class, 'store']); // Create subscription
        Route::get('/{subscription}', [SubscriptionController::class, 'show']); // Get subscription details
        Route::put('/{subscription}', [SubscriptionController::class, 'update']); // Update subscription (upgrade/downgrade)
        Route::delete('/{subscription}', [SubscriptionController::class, 'cancel']); // Cancel subscription
        Route::post('/{subscription}/pause', [SubscriptionController::class, 'pause']); // Pause subscription
        Route::post('/{subscription}/resume', [SubscriptionController::class, 'resume']); // Resume subscription

        // Payment Methods
        Route::get('/{subscription}/payment-methods', [SubscriptionController::class, 'paymentMethods']); // List payment methods
        Route::post('/{subscription}/payment-methods', [SubscriptionController::class, 'addPaymentMethod']); // Add payment method
        Route::delete('/payment-methods/{paymentMethod}', [SubscriptionController::class, 'removePaymentMethod']); // Remove payment method

        // Billing
        Route::get('/billing/history', [SubscriptionController::class, 'billingHistory']); // Payment transaction history
        Route::get('/billing/usage', [SubscriptionController::class, 'usageData']); // Usage-based billing data
        Route::get('/billing/invoices', [SubscriptionController::class, 'invoices']); // List invoices
        Route::get('/billing/invoices/{invoice}', [SubscriptionController::class, 'downloadInvoice']); // Download invoice PDF
    });

    // Domain Management
    Route::prefix('domains')->group(function () {
        Route::get('/', [DomainController::class, 'index']); // List domains
        Route::post('/', [DomainController::class, 'store']); // Register/add domain
        Route::get('/{domain}', [DomainController::class, 'show']); // Get domain details
        Route::put('/{domain}', [DomainController::class, 'update']); // Update domain configuration
        Route::delete('/{domain}', [DomainController::class, 'destroy']); // Delete domain

        // Domain Availability
        Route::post('/check-availability', [DomainController::class, 'checkAvailability']); // Check domain availability

        // DNS Records
        Route::get('/{domain}/dns', [DomainController::class, 'listDnsRecords']); // List DNS records
        Route::post('/{domain}/dns', [DomainController::class, 'createDnsRecord']); // Create DNS record
        Route::put('/{domain}/dns/{record}', [DomainController::class, 'updateDnsRecord']); // Update DNS record
        Route::delete('/{domain}/dns/{record}', [DomainController::class, 'deleteDnsRecord']); // Delete DNS record

        // SSL Certificates
        Route::get('/{domain}/ssl', [DomainController::class, 'sslStatus']); // Get SSL certificate status
        Route::post('/{domain}/ssl', [DomainController::class, 'provisionSSL']); // Provision SSL certificate

        // Domain Verification
        Route::post('/{domain}/verify', [DomainController::class, 'verifyOwnership']); // Start verification
        Route::get('/{domain}/verification-status', [DomainController::class, 'verificationStatus']); // Check verification status
    });

    // License Management
    Route::prefix('license')->group(function () {
        Route::get('/validate', [LicenseController::class, 'validate']); // Validate current license
        Route::get('/features', [LicenseController::class, 'features']); // List enabled features
        Route::get('/usage', [LicenseController::class, 'usage']); // Current usage vs limits
        Route::get('/quota/{resource}', [LicenseController::class, 'checkQuota']); // Check specific resource quota
        Route::get('/details', [LicenseController::class, 'details']); // Full license details
        Route::post('/refresh', [LicenseController::class, 'refresh']); // Refresh license from server
    });
});
```

### Example Controller Implementation

**File:** `app/Http/Controllers/Api/V1/OrganizationController.php`

```php
<?php

namespace App\Http\Controllers\Api\V1;

use App\Http\Controllers\Controller;
use App\Http\Requests\Api\V1\Organization\CreateOrganizationRequest;
use App\Http\Requests\Api\V1\Organization\UpdateOrganizationRequest;
use App\Http\Requests\Api\V1\Organization\InviteUserRequest;
use App\Http\Resources\V1\OrganizationResource;
use App\Http\Resources\V1\OrganizationCollection;
use App\Http\Resources\V1\UserResource;
use App\Models\Organization;
use App\Models\User;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Gate;

class OrganizationController extends Controller
{
    /**
     * List all organizations accessible to the authenticated user
     *
     * @param Request $request
     * @return OrganizationCollection
     */
    public function index(Request $request): OrganizationCollection
    {
        $query = Organization::query()
            ->whereHas('users', function ($q) use ($request) {
                $q->where('user_id', $request->user()->id);
            })
            ->with(['parent', 'children', 'users']);

        // Apply filters
        if ($request->has('parent_id')) {
            $query->where('parent_id', $request->input('parent_id'));
        }

        if ($request->has('search')) {
            $query->where('name', 'like', '%' . $request->input('search') . '%');
        }

        // Apply sorting
        $sortBy = $request->input('sort_by', 'created_at');
        $sortOrder = $request->input('sort_order', 'desc');
        $query->orderBy($sortBy, $sortOrder);

        // Paginate
        $perPage = $request->input('per_page', 15);
        $organizations = $query->paginate($perPage);

        return new OrganizationCollection($organizations);
    }

    /**
     * Create a new organization
     *
     * @param CreateOrganizationRequest $request
     * @return OrganizationResource
     */
    public function store(CreateOrganizationRequest $request): OrganizationResource
    {
        $this->authorize('create', Organization::class);

        $organization = Organization::create([
            'name' => $request->input('name'),
            'slug' => $request->input('slug'),
            'parent_id' => $request->input('parent_id'),
            'description' => $request->input('description'),
        ]);

        // Attach authenticated user as admin
        $organization->users()->attach($request->user()->id, [
            'role' => 'admin',
        ]);

        return new OrganizationResource($organization->load(['parent', 'users']));
    }

    /**
     * Get organization details
     *
     * @param Organization $organization
     * @return OrganizationResource
     */
    public function show(Organization $organization): OrganizationResource
    {
        $this->authorize('view', $organization);

        return new OrganizationResource(
            $organization->load(['parent', 'children', 'users', 'whiteLabelConfig', 'license'])
        );
    }

    /**
     * Update organization
     *
     * @param UpdateOrganizationRequest $request
     * @param Organization $organization
     * @return OrganizationResource
     */
    public function update(UpdateOrganizationRequest $request, Organization $organization): OrganizationResource
    {
        $this->authorize('update', $organization);

        $organization->update($request->validated());

        return new OrganizationResource($organization->load(['parent', 'users']));
    }

    /**
     * Delete organization
     *
     * @param Organization $organization
     * @return JsonResponse
     */
    public function destroy(Organization $organization): JsonResponse
    {
        $this->authorize('delete', $organization);

        // Soft delete
        $organization->delete();

        return response()->json([
            'message' => 'Organization deleted successfully',
        ], 200);
    }

    /**
     * List organization users
     *
     * @param Organization $organization
     * @return \Illuminate\Http\Resources\Json\AnonymousResourceCollection
     */
    public function users(Organization $organization)
    {
        $this->authorize('view', $organization);

        $users = $organization->users()
            ->withPivot('role', 'created_at')
            ->paginate(15);

        return UserResource::collection($users);
    }

    /**
     * Invite user to organization
     *
     * @param InviteUserRequest $request
     * @param Organization $organization
     * @return JsonResponse
     */
    public function inviteUser(InviteUserRequest $request, Organization $organization): JsonResponse
    {
        $this->authorize('update', $organization);

        $user = User::where('email', $request->input('email'))->first();

        if (!$user) {
            // Create invitation (implemented elsewhere)
            return response()->json([
                'message' => 'Invitation sent',
            ], 201);
        }

        $organization->users()->attach($user->id, [
            'role' => $request->input('role', 'member'),
        ]);

        return response()->json([
            'message' => 'User added to organization',
            'user' => new UserResource($user),
        ], 201);
    }

    /**
     * Remove user from organization
     *
     * @param Organization $organization
     * @param User $user
     * @return JsonResponse
     */
    public function removeUser(Organization $organization, User $user): JsonResponse
    {
        $this->authorize('update', $organization);

        $organization->users()->detach($user->id);

        return response()->json([
            'message' => 'User removed from organization',
        ], 200);
    }

    /**
     * Get organization hierarchy tree
     *
     * @param Organization $organization
     * @return JsonResponse
     */
    public function hierarchy(Organization $organization): JsonResponse
    {
        $this->authorize('view', $organization);

        $tree = $this->buildHierarchyTree($organization);

        return response()->json([
            'data' => $tree,
        ]);
    }

    /**
     * Switch active organization context
     *
     * @param Request $request
     * @return JsonResponse
     */
    public function switchContext(Request $request): JsonResponse
    {
        $request->validate([
            'organization_id' => 'required|exists:organizations,id',
        ]);

        $organizationId = $request->input('organization_id');

        // Verify user has access
        $hasAccess = $request->user()
            ->organizations()
            ->where('organization_id', $organizationId)
            ->exists();

        if (!$hasAccess) {
            return response()->json([
                'message' => 'You do not have access to this organization',
            ], 403);
        }

        // Update user's current organization context (session or token metadata)
        $request->user()->update(['current_organization_id' => $organizationId]);

        return response()->json([
            'message' => 'Organization context switched',
            'organization_id' => $organizationId,
        ]);
    }

    /**
     * Build hierarchical tree structure
     *
     * @param Organization $organization
     * @return array
     */
    private function buildHierarchyTree(Organization $organization): array
    {
        return [
            'id' => $organization->id,
            'name' => $organization->name,
            'slug' => $organization->slug,
            'children' => $organization->children->map(fn($child) => $this->buildHierarchyTree($child)),
        ];
    }
}
```

### Example FormRequest Validation

**File:** `app/Http/Requests/Api/V1/Organization/CreateOrganizationRequest.php`

```php
<?php

namespace App\Http\Requests\Api\V1\Organization;

use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Validation\Rule;

class CreateOrganizationRequest extends FormRequest
{
    /**
     * Determine if the user is authorized to make this request
     */
    public function authorize(): bool
    {
        // Authorization handled in controller via Gate
        return true;
    }

    /**
     * Get the validation rules that apply to the request
     *
     * @return array<string, \Illuminate\Contracts\Validation\ValidationRule|array<mixed>|string>
     */
    public function rules(): array
    {
        return [
            'name' => 'required|string|max:255',
            'slug' => [
                'required',
                'string',
                'max:255',
                'regex:/^[a-z0-9-]+$/',
                Rule::unique('organizations', 'slug'),
            ],
            'parent_id' => 'nullable|exists:organizations,id',
            'description' => 'nullable|string|max:1000',
        ];
    }

    /**
     * Get custom error messages for validation rules
     *
     * @return array<string, string>
     */
    public function messages(): array
    {
        return [
            'name.required' => 'Organization name is required',
            'slug.required' => 'Organization slug is required',
            'slug.regex' => 'Slug must contain only lowercase letters, numbers, and hyphens',
            'slug.unique' => 'This slug is already taken',
            'parent_id.exists' => 'Parent organization does not exist',
        ];
    }
}
```

### Example API Resource

**File:** `app/Http/Resources/V1/OrganizationResource.php`

```php
<?php

namespace App\Http\Resources\V1;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class OrganizationResource extends JsonResource
{
    /**
     * Transform the resource into an array
     *
     * @return array<string, mixed>
     */
    public function toArray(Request $request): array
    {
        return [
            'id' => $this->id,
            'name' => $this->name,
            'slug' => $this->slug,
            'description' => $this->description,
            'parent_id' => $this->parent_id,
            'created_at' => $this->created_at?->toIso8601String(),
            'updated_at' => $this->updated_at?->toIso8601String(),

            // Relationships
            'parent' => new OrganizationResource($this->whenLoaded('parent')),
            'children' => OrganizationResource::collection($this->whenLoaded('children')),
            'users' => UserResource::collection($this->whenLoaded('users')),
            'white_label_config' => new WhiteLabelConfigResource($this->whenLoaded('whiteLabelConfig')),
            'license' => new LicenseResource($this->whenLoaded('license')),

            // Computed attributes
            'users_count' => $this->when($this->relationLoaded('users'), fn() => $this->users->count()),
            'servers_count' => $this->when($this->relationLoaded('servers'), fn() => $this->servers->count()),

            // Links
            'links' => [
                'self' => route('api.v1.organizations.show', $this->id),
                'users' => route('api.v1.organizations.users', $this->id),
                'hierarchy' => route('api.v1.organizations.hierarchy', $this->id),
            ],
        ];
    }
}
```

**File:** `app/Http/Resources/V1/OrganizationCollection.php`

```php
<?php

namespace App\Http\Resources\V1;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\ResourceCollection;

class OrganizationCollection extends ResourceCollection
{
    /**
     * Transform the resource collection into an array
     *
     * @return array<string, mixed>
     */
    public function toArray(Request $request): array
    {
        return [
            'data' => $this->collection,
            'meta' => [
                'total' => $this->total(),
                'count' => $this->count(),
                'per_page' => $this->perPage(),
                'current_page' => $this->currentPage(),
                'total_pages' => $this->lastPage(),
            ],
            'links' => [
                'first' => $this->url(1),
                'last' => $this->url($this->lastPage()),
                'prev' => $this->previousPageUrl(),
                'next' => $this->nextPageUrl(),
            ],
        ];
    }
}
```

### Example Infrastructure Controller

**File:** `app/Http/Controllers/Api/V1/InfrastructureController.php`

```php
<?php

namespace App\Http\Controllers\Api\V1;

use App\Http\Controllers\Controller;
use App\Http\Requests\Api\V1\Infrastructure\ProvisionServerRequest;
use App\Http\Resources\V1\ServerResource;
use App\Http\Resources\V1\TerraformDeploymentResource;
use App\Services\Enterprise\TerraformService;
use App\Models\CloudProviderCredential;
use App\Models\Server;
use App\Models\TerraformDeployment;
use App\Jobs\Enterprise\TerraformDeploymentJob;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;

class InfrastructureController extends Controller
{
    public function __construct(
        private TerraformService $terraformService
    ) {}

    /**
     * Provision new server via Terraform
     *
     * @param ProvisionServerRequest $request
     * @return JsonResponse
     */
    public function provisionServer(ProvisionServerRequest $request): JsonResponse
    {
        $this->authorize('create', Server::class);

        $credential = CloudProviderCredential::findOrFail($request->input('credential_id'));

        // Create deployment record
        $deployment = TerraformDeployment::create([
            'organization_id' => auth()->user()->currentOrganization->id,
            'cloud_provider_credential_id' => $credential->id,
            'provider' => $credential->provider,
            'region' => $request->input('region'),
            'instance_type' => $request->input('instance_type'),
            'configuration' => $request->input('configuration', []),
            'status' => 'pending',
        ]);

        // Dispatch async provisioning job
        TerraformDeploymentJob::dispatch($deployment);

        return response()->json([
            'message' => 'Server provisioning started',
            'deployment' => new TerraformDeploymentResource($deployment),
        ], 202);
    }

    /**
     * List servers
     *
     * @param Request $request
     * @return \Illuminate\Http\Resources\Json\AnonymousResourceCollection
     */
    public function listServers(Request $request)
    {
        $this->authorize('viewAny', Server::class);

        $query = Server::query()
            ->where('organization_id', auth()->user()->currentOrganization->id)
            ->with(['terraformDeployment']);

        // Apply filters
        if ($request->has('status')) {
            $query->where('status', $request->input('status'));
        }

        if ($request->has('provider')) {
            $query->whereHas('terraformDeployment', function ($q) use ($request) {
                $q->where('provider', $request->input('provider'));
            });
        }

        $servers = $query->paginate($request->input('per_page', 15));

        return ServerResource::collection($servers);
    }

    /**
     * Get server details
     *
     * @param Server $server
     * @return ServerResource
     */
    public function showServer(Server $server): ServerResource
    {
        $this->authorize('view', $server);

        return new ServerResource($server->load(['terraformDeployment', 'metrics']));
    }

    /**
     * List supported cloud providers
     *
     * @return JsonResponse
     */
    public function listProviders(): JsonResponse
    {
        return response()->json([
            'data' => [
                ['id' => 'aws', 'name' => 'Amazon Web Services', 'regions' => ['us-east-1', 'us-west-2', 'eu-west-1']],
                ['id' => 'digitalocean', 'name' => 'DigitalOcean', 'regions' => ['nyc1', 'nyc3', 'sfo3', 'lon1']],
                ['id' => 'hetzner', 'name' => 'Hetzner Cloud', 'regions' => ['nbg1', 'fsn1', 'hel1']],
                ['id' => 'gcp', 'name' => 'Google Cloud Platform', 'regions' => ['us-central1', 'us-east1', 'europe-west1']],
                ['id' => 'azure', 'name' => 'Microsoft Azure', 'regions' => ['eastus', 'westus', 'westeurope']],
            ],
        ]);
    }
}
```

### Error Response Format (RFC 7807)

All error responses follow the RFC 7807 Problem Details standard:

```json
{
  "type": "https://api.coolify-enterprise.com/errors/validation-failed",
  "title": "Validation Failed",
  "status": 422,
  "detail": "The given data was invalid.",
  "instance": "/api/v1/organizations",
  "errors": {
    "name": [
      "The name field is required."
    ],
    "slug": [
      "The slug has already been taken."
    ]
  },
  "trace_id": "abc123def456"
}
```

### Success Response Format

All success responses include consistent metadata:

```json
{
  "data": {
    "id": 1,
    "name": "Acme Corp",
    "slug": "acme-corp",
    "created_at": "2025-01-15T10:30:00Z",
    "updated_at": "2025-01-15T10:30:00Z"
  },
  "meta": {
    "timestamp": "2025-01-15T10:30:00Z",
    "version": "v1"
  }
}
```

### Rate Limit Headers

All API responses include rate limit headers:

```
X-RateLimit-Limit: 500
X-RateLimit-Remaining: 499
X-RateLimit-Reset: 1642248600
```

## Implementation Approach

### Step 1: Route Definition
1. Add all API routes to `routes/api.php`
2. Group routes by resource domain (organizations, infrastructure, etc.)
3. Apply middleware: `auth:sanctum`, `api.organization.scope`
4. Define route names for resource generation

### Step 2: Create Controllers
1. Create 7 main API controllers in `app/Http/Controllers/Api/V1/`
2. Implement CRUD methods for each resource
3. Add authorization checks using policies
4. Return responses via API Resources

### Step 3: Create FormRequest Validation Classes
1. Create FormRequest for each endpoint with input
2. Define validation rules with custom error messages
3. Use Rule classes for complex validation (unique, exists, etc.)
4. Document expected input formats

### Step 4: Create API Resources
1. Create Resource classes for single entities
2. Create Collection classes for paginated lists
3. Include relationships via `whenLoaded()`
4. Add computed attributes and links

### Step 5: Implement Policies
1. Enhance existing OrganizationPolicy and ServerPolicy
2. Create new policies for Subscription, Domain
3. Ensure organization-scoped authorization
4. Test policy enforcement

### Step 6: Add Error Handling
1. Create custom exception handler for API errors
2. Format errors per RFC 7807 standard
3. Include validation errors with field details
4. Add trace IDs for debugging

### Step 7: CORS Configuration
1. Configure CORS in `config/cors.php`
2. Allow necessary origins for web clients
3. Set allowed methods and headers
4. Test cross-origin requests

### Step 8: Testing
1. Write feature tests for all endpoints
2. Test organization scoping (no cross-tenant access)
3. Test authorization (policies enforce permissions)
4. Test validation (invalid input rejected)
5. Test pagination, filtering, sorting
6. Test rate limiting integration

## Test Strategy

### Feature Tests

**File:** `tests/Feature/Api/V1/OrganizationApiTest.php`

```php
<?php

use App\Models\Organization;
use App\Models\User;
use Laravel\Sanctum\Sanctum;

it('lists organizations for authenticated user', function () {
    $user = User::factory()->create();
    $org1 = Organization::factory()->create();
    $org2 = Organization::factory()->create();
    $org3 = Organization::factory()->create(); // Not accessible

    $org1->users()->attach($user, ['role' => 'admin']);
    $org2->users()->attach($user, ['role' => 'member']);

    Sanctum::actingAs($user, ['organization:read']);

    $response = $this->getJson('/api/v1/organizations');

    $response->assertOk()
        ->assertJsonCount(2, 'data')
        ->assertJsonFragment(['id' => $org1->id])
        ->assertJsonFragment(['id' => $org2->id])
        ->assertJsonMissing(['id' => $org3->id]);
});

it('creates organization with valid data', function () {
    $user = User::factory()->create();

    Sanctum::actingAs($user, ['organization:write']);

    $response = $this->postJson('/api/v1/organizations', [
        'name' => 'New Organization',
        'slug' => 'new-org',
        'description' => 'Test organization',
    ]);

    $response->assertCreated()
        ->assertJsonFragment(['name' => 'New Organization'])
        ->assertJsonFragment(['slug' => 'new-org']);

    $this->assertDatabaseHas('organizations', [
        'name' => 'New Organization',
        'slug' => 'new-org',
    ]);
});

it('validates organization creation input', function () {
    $user = User::factory()->create();

    Sanctum::actingAs($user, ['organization:write']);

    $response = $this->postJson('/api/v1/organizations', [
        'name' => '', // Invalid: required
        'slug' => 'INVALID SLUG', // Invalid: format
    ]);

    $response->assertStatus(422)
        ->assertJsonValidationErrors(['name', 'slug']);
});

it('prevents cross-tenant access to organizations', function () {
    $user1 = User::factory()->create();
    $user2 = User::factory()->create();

    $org1 = Organization::factory()->create();
    $org1->users()->attach($user1, ['role' => 'admin']);

    Sanctum::actingAs($user2, ['organization:read']);

    $response = $this->getJson("/api/v1/organizations/{$org1->id}");

    $response->assertForbidden();
});

it('enforces authorization policies', function () {
    $user = User::factory()->create();
    $org = Organization::factory()->create();
    $org->users()->attach($user, ['role' => 'member']); // Not admin

    Sanctum::actingAs($user, ['organization:delete']);

    $response = $this->deleteJson("/api/v1/organizations/{$org->id}");

    $response->assertForbidden();
});

it('supports pagination with meta data', function () {
    $user = User::factory()->create();

    $orgs = Organization::factory(25)->create();
    foreach ($orgs as $org) {
        $org->users()->attach($user, ['role' => 'member']);
    }

    Sanctum::actingAs($user, ['organization:read']);

    $response = $this->getJson('/api/v1/organizations?per_page=10');

    $response->assertOk()
        ->assertJsonCount(10, 'data')
        ->assertJsonStructure([
            'data',
            'meta' => ['total', 'current_page', 'total_pages'],
            'links' => ['first', 'last', 'prev', 'next'],
        ]);
});

it('supports filtering and sorting', function () {
    $user = User::factory()->create();

    $org1 = Organization::factory()->create(['name' => 'Alpha Corp']);
    $org2 = Organization::factory()->create(['name' => 'Beta Corp']);
    $org3 = Organization::factory()->create(['name' => 'Gamma Corp']);

    foreach ([$org1, $org2, $org3] as $org) {
        $org->users()->attach($user, ['role' => 'member']);
    }

    Sanctum::actingAs($user, ['organization:read']);

    $response = $this->getJson('/api/v1/organizations?search=Beta&sort_by=name&sort_order=asc');

    $response->assertOk()
        ->assertJsonCount(1, 'data')
        ->assertJsonFragment(['name' => 'Beta Corp']);
});
```

**File:** `tests/Feature/Api/V1/InfrastructureApiTest.php`

```php
<?php

use App\Models\Organization;
use App\Models\User;
use App\Models\CloudProviderCredential;
use App\Models\TerraformDeployment;
use App\Jobs\Enterprise\TerraformDeploymentJob;
use Illuminate\Support\Facades\Queue;
use Laravel\Sanctum\Sanctum;

it('provisions server via API', function () {
    Queue::fake();

    $user = User::factory()->create();
    $org = Organization::factory()->create();
    $org->users()->attach($user, ['role' => 'admin']);

    $credential = CloudProviderCredential::factory()->create([
        'organization_id' => $org->id,
        'provider' => 'digitalocean',
    ]);

    Sanctum::actingAs($user, ['infrastructure:write']);

    $response = $this->postJson('/api/v1/infrastructure/provision', [
        'credential_id' => $credential->id,
        'region' => 'nyc3',
        'instance_type' => 's-1vcpu-1gb',
        'configuration' => [
            'hostname' => 'api-server-1',
        ],
    ]);

    $response->assertStatus(202)
        ->assertJsonStructure([
            'message',
            'deployment' => ['id', 'status', 'provider'],
        ]);

    Queue::assertPushed(TerraformDeploymentJob::class);
});

it('lists servers with filtering', function () {
    $user = User::factory()->create();
    $org = Organization::factory()->create();
    $org->users()->attach($user, ['role' => 'admin']);

    // Create servers (implementation depends on Server factory)

    Sanctum::actingAs($user, ['infrastructure:read']);

    $response = $this->getJson('/api/v1/infrastructure/servers?status=active');

    $response->assertOk()
        ->assertJsonStructure(['data', 'meta', 'links']);
});
```

### Authorization Tests

**File:** `tests/Feature/Api/V1/ApiAuthorizationTest.php`

```php
<?php

it('requires authentication for all endpoints', function () {
    $response = $this->getJson('/api/v1/organizations');

    $response->assertUnauthorized();
});

it('validates token abilities', function () {
    $user = User::factory()->create();

    // Token with read-only ability
    Sanctum::actingAs($user, ['organization:read']);

    $response = $this->postJson('/api/v1/organizations', [
        'name' => 'Test',
        'slug' => 'test',
    ]);

    $response->assertForbidden();
});

it('enforces organization scoping on all endpoints', function () {
    // Test that middleware correctly scopes all queries
    // Implementation specific to organization scoping logic
});
```

## Definition of Done

- [ ] All 66+ API endpoints implemented across 7 controllers
- [ ] OrganizationController with 10 endpoints complete
- [ ] InfrastructureController with 12 endpoints complete
- [ ] ResourceMonitoringController with 8 endpoints complete
- [ ] WhiteLabelController with 8 endpoints complete
- [ ] SubscriptionController with 13 endpoints complete
- [ ] DomainController with 12 endpoints complete
- [ ] LicenseController with 6 endpoints complete
- [ ] All routes registered in routes/api.php with v1 prefix
- [ ] All endpoints require Sanctum authentication
- [ ] All endpoints use ApiOrganizationScope middleware
- [ ] FormRequest validation classes created for all input endpoints (20+ classes)
- [ ] API Resources created for all response types (15+ Resource classes)
- [ ] OrganizationResource with relationships and links
- [ ] ServerResource with metrics and deployment data
- [ ] WhiteLabelConfigResource with branding data
- [ ] SubscriptionResource with payment and usage data
- [ ] DomainResource with DNS and SSL data
- [ ] Collection resources with pagination metadata
- [ ] Error responses follow RFC 7807 format
- [ ] Success responses include consistent metadata
- [ ] Rate limit headers included in all responses
- [ ] CORS configured for API access
- [ ] Policies enforce organization-scoped authorization
- [ ] Pagination implemented on all collection endpoints
- [ ] Filtering and sorting supported on collection endpoints
- [ ] Feature tests written for all endpoints (60+ tests)
- [ ] Authorization tests verify cross-tenant isolation
- [ ] Validation tests ensure input sanitization
- [ ] Documentation comments added to all controllers and methods
- [ ] Code follows Laravel API best practices
- [ ] PHPStan level 5 passing
- [ ] Laravel Pint formatting applied
- [ ] No N+1 query issues (eager loading implemented)
- [ ] API tested with Postman/Insomnia collections
- [ ] Manual testing completed for critical workflows

## Related Tasks

- **Depends on:** Task 52 (Sanctum token enhancements with organization context)
- **Depends on:** Task 53 (ApiOrganizationScope middleware for automatic scoping)
- **Used by:** Task 54 (Rate limiting middleware applies to these endpoints)
- **Used by:** Task 55 (Rate limit headers added to responses)
- **Documented in:** Task 57 (OpenAPI spec includes all endpoints)
- **UI for:** Task 59 (ApiKeyManager.vue creates tokens for these endpoints)
- **Monitored by:** Task 60 (ApiUsageMonitoring.vue tracks usage)
- **Tested in:** Task 61 (API tests validate all endpoints)
