---
name: Implement subscription lifecycle management
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:39:04Z
github: https://github.com/johnproblems/topgun/issues/156
depends_on: [46]
parallel: false
conflicts_with: []
---

# Task: Implement subscription lifecycle management

## Description

Implement a comprehensive subscription lifecycle management system that handles the complete journey of organization subscriptions—from initial creation through active use, plan changes, pausing/resuming, and final cancellation. This system manages subscriptions across multiple payment gateways (Stripe, PayPal), enforces business rules, handles pro-rated billing, tracks subscription state transitions, and ensures seamless integration with organization features, license management, and usage tracking.

**What Subscription Lifecycle Management Encompasses:**

The subscription lifecycle represents all possible states and transitions an organization's subscription can experience throughout its lifetime. A robust lifecycle management system ensures consistent behavior across all payment gateways, enforces business rules during transitions, and maintains data integrity throughout the subscription's life.

**Core Lifecycle States:**

1. **Creation** → New subscription initiated with payment gateway
2. **Active** → Subscription is running and organization has full access
3. **Trialing** → Trial period active (if configured)
4. **Past Due** → Payment failed but grace period active
5. **Paused** → Temporarily suspended by organization
6. **Canceled** → Marked for cancellation (may run until period end)
7. **Expired** → Fully terminated, no further billing

**Why This Task Is Critical:**

Subscriptions are the revenue backbone of the Coolify Enterprise platform. Without proper lifecycle management:
- Payment failures silently revoke critical services, frustrating customers
- Plan changes create billing inconsistencies and customer disputes
- Failed cancellations lead to unwanted charges and refund requests
- Lack of pause/resume forces full cancellations for temporary needs
- Missing pro-ration creates revenue leakage or overcharging
- Poor state tracking causes access control failures (users with paid plans locked out or vice versa)

This implementation ensures **predictable, reliable subscription behavior** that builds customer trust, reduces support burden, and maximizes revenue retention through flexible subscription management.

**Integration Architecture:**

**Payment Gateway Integration (Task 46):**
- Uses `PaymentService` as unified interface to Stripe and PayPal
- Handles gateway-specific subscription creation flows
- Translates gateway webhooks to internal state transitions
- Manages gateway subscription IDs for future operations

**License Management (Tasks 1-2):**
- Automatically provisions/updates `EnterpriseLicense` based on subscription tier
- Syncs feature flags when subscription plan changes
- Revokes license features when subscription expires or is paused
- Enforces usage limits based on active subscription

**Organization Management:**
- Links subscriptions to organizations via `organization_subscriptions` table
- Enforces one active subscription per organization rule
- Cascades subscription cancellation when organization is deleted
- Tracks subscription history for billing and support

**Usage Tracking & Billing (Task 49):**
- Feeds current subscription tier to usage-based billing calculations
- Enables overage billing for metered features (API calls, server hours)
- Triggers invoice generation based on subscription billing cycle
- Supports pro-rated billing when plans change mid-cycle

**Frontend Components (Task 50):**
- `SubscriptionManager.vue` displays current subscription and plan change UI
- `PaymentMethodManager.vue` handles payment method updates that affect subscriptions
- `BillingDashboard.vue` shows subscription timeline and upcoming charges
- Real-time subscription status updates via WebSocket

**Core Features:**

1. **Create Subscription**
   - Support multiple plan tiers (Starter, Professional, Enterprise)
   - Optional trial periods (7, 14, or 30 days)
   - Automatic license provisioning based on plan features
   - Gateway-specific subscription creation (Stripe vs PayPal)
   - Email confirmation with subscription details

2. **Update Subscription (Plan Changes)**
   - Upgrade/downgrade between plan tiers
   - Pro-rated billing calculations (credit for unused time on old plan)
   - Immediate feature access on upgrades
   - Grace period for downgrades (features remain until period end)
   - Automatic license feature flag updates

3. **Pause Subscription**
   - Temporary suspension without cancellation
   - Stop billing during pause period
   - Retain data and settings during pause
   - Optional scheduled auto-resume
   - Email notification when paused/resumed

4. **Resume Subscription**
   - Restart billing from pause state
   - Restore full feature access
   - Update next billing date based on pause duration
   - Re-activate payment method

5. **Cancel Subscription**
   - Immediate cancellation (stop billing now, revoke access)
   - End-of-period cancellation (run until current period ends)
   - Cancel gateway subscription to prevent future charges
   - Data retention policy enforcement (30-day grace before deletion)
   - Email confirmation with data export link

6. **Handle Subscription Events**
   - Payment failures (retry logic with grace period)
   - Subscription renewals (automatic license extension)
   - Trial expiration (convert to paid or cancel)
   - Expired payment methods (alert user, enter past_due state)

7. **State Transition Rules**
   - Prevent invalid state transitions (e.g., can't pause an already canceled subscription)
   - Enforce business rules (must have valid payment method to resume)
   - Atomic database updates for state changes
   - Audit logging for compliance

**Example User Flows:**

**Flow 1: New Subscription**
1. User selects "Professional" plan with 14-day trial
2. System creates Stripe subscription with trial period
3. System creates `organization_subscriptions` record with status="trialing"
4. System provisions `EnterpriseLicense` with Professional tier features
5. Webhook confirms subscription creation
6. User receives welcome email with trial end date

**Flow 2: Upgrade Plan**
1. User on "Starter" plan clicks "Upgrade to Professional"
2. System calculates pro-rated credit for unused Starter days
3. System calls `PaymentService->updateSubscription()` with new plan
4. Stripe applies credit and charges pro-rated Professional amount
5. System updates `organization_subscriptions.plan_id` and license features
6. User immediately gains Professional features

**Flow 3: Pause Subscription**
1. User clicks "Pause Subscription" (business travel for 2 months)
2. System calls `PaymentService->pauseSubscription()`
3. Stripe pauses billing, retains payment method
4. System updates subscription status to "paused"
5. System revokes license features (organization enters read-only mode)
6. User receives confirmation email

**Flow 4: Cancel Subscription**
1. User clicks "Cancel Subscription" → chooses "End of billing period"
2. System updates subscription: `cancel_at_period_end = true`, `canceled_at = now()`
3. System schedules cancellation job for period end date
4. User retains full access until period ends
5. On period end: system revokes license, deletes servers (optional), sends data export
6. Subscription enters "expired" state

## Acceptance Criteria

- [ ] SubscriptionLifecycleService created implementing comprehensive lifecycle methods
- [ ] Create subscription: supports all plan tiers (Starter, Pro, Enterprise) with trial periods
- [ ] Update subscription: handles upgrades/downgrades with pro-rated billing
- [ ] Pause subscription: stops billing, retains data, allows scheduled auto-resume
- [ ] Resume subscription: restarts billing, restores features, updates billing cycle
- [ ] Cancel subscription: supports immediate and end-of-period cancellation modes
- [ ] State transitions validated: prevents invalid transitions (e.g., resume expired subscription)
- [ ] Gateway integration: works correctly with both Stripe and PayPal backends
- [ ] License synchronization: automatically provisions/updates EnterpriseLicense on subscription changes
- [ ] Payment method validation: requires valid payment method for resume, rejects expired cards
- [ ] Pro-ration calculations: accurate billing adjustments for mid-cycle plan changes
- [ ] Trial period handling: converts to paid on success, cancels on failure
- [ ] Webhook handling: processes gateway subscription events (renewed, past_due, canceled)
- [ ] Email notifications: sends appropriate emails for all lifecycle events
- [ ] Audit logging: records all subscription state changes with timestamps and user IDs
- [ ] Error handling: graceful failures with rollback for atomic operations
- [ ] Database constraints: enforces one active subscription per organization
- [ ] Grace periods: configurable grace period (3-7 days) for past_due subscriptions before cancellation

## Technical Details

### File Paths

**Service Layer:**
- `/home/topgun/topgun/app/Services/Enterprise/SubscriptionLifecycleService.php` (new)
- `/home/topgun/topgun/app/Contracts/SubscriptionLifecycleServiceInterface.php` (new)

**Event Handlers:**
- `/home/topgun/topgun/app/Listeners/Enterprise/SyncLicenseOnSubscriptionChange.php` (new)
- `/home/topgun/topgun/app/Listeners/Enterprise/SendSubscriptionNotifications.php` (new)

**Jobs:**
- `/home/topgun/topgun/app/Jobs/Enterprise/ProcessSubscriptionCancellation.php` (new)
- `/home/topgun/topgun/app/Jobs/Enterprise/HandleSubscriptionRenewal.php` (new)

**Events:**
- `/home/topgun/topgun/app/Events/Enterprise/SubscriptionCreated.php` (new)
- `/home/topgun/topgun/app/Events/Enterprise/SubscriptionUpdated.php` (new)
- `/home/topgun/topgun/app/Events/Enterprise/SubscriptionPaused.php` (new)
- `/home/topgun/topgun/app/Events/Enterprise/SubscriptionResumed.php` (new)
- `/home/topgun/topgun/app/Events/Enterprise/SubscriptionCanceled.php` (new)

**Models:**
- `/home/topgun/topgun/app/Models/Enterprise/OrganizationSubscription.php` (enhance existing from Task 42)

**Controllers:**
- `/home/topgun/topgun/app/Http/Controllers/Enterprise/SubscriptionController.php` (enhance)

**Policies:**
- `/home/topgun/topgun/app/Policies/Enterprise/SubscriptionPolicy.php` (new)

### Database Schema Reference

**Existing Schema (Task 42):**

```sql
-- From Task 42: Database schema for subscriptions
CREATE TABLE organization_subscriptions (
    id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    organization_id BIGINT UNSIGNED NOT NULL,
    subscription_plan_id BIGINT UNSIGNED NOT NULL,

    -- Gateway identifiers
    gateway VARCHAR(50) NOT NULL, -- 'stripe', 'paypal'
    gateway_subscription_id VARCHAR(255) NOT NULL, -- External subscription ID
    gateway_customer_id VARCHAR(255) NOT NULL,

    -- Status and lifecycle
    status VARCHAR(50) NOT NULL DEFAULT 'active', -- active, trialing, past_due, paused, canceled, expired
    trial_ends_at TIMESTAMP NULL,
    current_period_start TIMESTAMP NOT NULL,
    current_period_end TIMESTAMP NOT NULL,

    -- Cancellation tracking
    cancel_at_period_end BOOLEAN DEFAULT FALSE,
    canceled_at TIMESTAMP NULL,
    ended_at TIMESTAMP NULL,

    -- Pause tracking (new columns for this task)
    paused_at TIMESTAMP NULL,
    pause_collection_behavior VARCHAR(50) NULL, -- 'keep_as_draft', 'mark_uncollectible', 'void'
    resume_at TIMESTAMP NULL, -- Scheduled auto-resume

    -- Billing
    billing_cycle_anchor TIMESTAMP NULL,

    -- Metadata
    metadata JSON NULL,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (organization_id) REFERENCES organizations(id) ON DELETE CASCADE,
    FOREIGN KEY (subscription_plan_id) REFERENCES subscription_plans(id),

    UNIQUE KEY unique_active_subscription (organization_id, status),
    INDEX idx_status (status),
    INDEX idx_gateway_subscription (gateway, gateway_subscription_id),
    INDEX idx_current_period_end (current_period_end)
);
```

### SubscriptionLifecycleService Implementation

**File:** `app/Services/Enterprise/SubscriptionLifecycleService.php`

```php
<?php

namespace App\Services\Enterprise;

use App\Contracts\SubscriptionLifecycleServiceInterface;
use App\Contracts\PaymentServiceInterface;
use App\Models\Organization;
use App\Models\Enterprise\OrganizationSubscription;
use App\Models\Enterprise\SubscriptionPlan;
use App\Models\Enterprise\EnterpriseLicense;
use App\Events\Enterprise\SubscriptionCreated;
use App\Events\Enterprise\SubscriptionUpdated;
use App\Events\Enterprise\SubscriptionPaused;
use App\Events\Enterprise\SubscriptionResumed;
use App\Events\Enterprise\SubscriptionCanceled;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Carbon\Carbon;

class SubscriptionLifecycleService implements SubscriptionLifecycleServiceInterface
{
    // Valid subscription status values
    public const STATUS_ACTIVE = 'active';
    public const STATUS_TRIALING = 'trialing';
    public const STATUS_PAST_DUE = 'past_due';
    public const STATUS_PAUSED = 'paused';
    public const STATUS_CANCELED = 'canceled';
    public const STATUS_EXPIRED = 'expired';

    // Grace period for past_due subscriptions before auto-cancellation
    public const GRACE_PERIOD_DAYS = 7;

    public function __construct(
        private PaymentServiceInterface $paymentService
    ) {
    }

    /**
     * Create a new subscription for an organization
     *
     * @param Organization $organization
     * @param SubscriptionPlan $plan
     * @param string $paymentMethodId Gateway payment method ID
     * @param array $options Additional options (trial_days, metadata, etc.)
     * @return OrganizationSubscription
     * @throws \Exception
     */
    public function createSubscription(
        Organization $organization,
        SubscriptionPlan $plan,
        string $paymentMethodId,
        array $options = []
    ): OrganizationSubscription {
        // Validate no active subscription exists
        $this->ensureNoActiveSubscription($organization);

        DB::beginTransaction();

        try {
            // Create subscription with payment gateway
            $gatewaySubscription = $this->paymentService->createSubscription(
                $organization,
                $plan,
                $paymentMethodId,
                $options
            );

            // Calculate trial end date
            $trialEndsAt = isset($options['trial_days'])
                ? now()->addDays($options['trial_days'])
                : null;

            // Determine initial status
            $status = $trialEndsAt ? self::STATUS_TRIALING : self::STATUS_ACTIVE;

            // Create local subscription record
            $subscription = OrganizationSubscription::create([
                'organization_id' => $organization->id,
                'subscription_plan_id' => $plan->id,
                'gateway' => $gatewaySubscription['gateway'],
                'gateway_subscription_id' => $gatewaySubscription['subscription_id'],
                'gateway_customer_id' => $gatewaySubscription['customer_id'],
                'status' => $status,
                'trial_ends_at' => $trialEndsAt,
                'current_period_start' => $gatewaySubscription['current_period_start'],
                'current_period_end' => $gatewaySubscription['current_period_end'],
                'billing_cycle_anchor' => $gatewaySubscription['billing_cycle_anchor'],
                'metadata' => $options['metadata'] ?? null,
            ]);

            // Provision enterprise license with plan features
            $this->provisionLicense($organization, $plan);

            DB::commit();

            // Dispatch event for notifications and logging
            event(new SubscriptionCreated($subscription));

            Log::info('Subscription created successfully', [
                'subscription_id' => $subscription->id,
                'organization_id' => $organization->id,
                'plan_id' => $plan->id,
                'status' => $status,
                'trial_ends_at' => $trialEndsAt,
            ]);

            return $subscription->fresh();
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Failed to create subscription', [
                'organization_id' => $organization->id,
                'plan_id' => $plan->id,
                'error' => $e->getMessage(),
            ]);

            throw $e;
        }
    }

    /**
     * Update subscription to a different plan (upgrade/downgrade)
     *
     * @param OrganizationSubscription $subscription
     * @param SubscriptionPlan $newPlan
     * @param array $options Options like proration_behavior
     * @return OrganizationSubscription
     * @throws \Exception
     */
    public function updateSubscription(
        OrganizationSubscription $subscription,
        SubscriptionPlan $newPlan,
        array $options = []
    ): OrganizationSubscription {
        // Validate subscription is in updatable state
        $this->validateStateTransition($subscription, 'update');

        DB::beginTransaction();

        try {
            $oldPlan = $subscription->subscriptionPlan;

            // Update subscription with payment gateway
            $gatewayUpdate = $this->paymentService->updateSubscription(
                $subscription->gateway_subscription_id,
                $newPlan,
                $options
            );

            // Update local subscription record
            $subscription->update([
                'subscription_plan_id' => $newPlan->id,
                'current_period_start' => $gatewayUpdate['current_period_start'],
                'current_period_end' => $gatewayUpdate['current_period_end'],
            ]);

            // Update enterprise license with new plan features
            $this->updateLicense($subscription->organization, $newPlan);

            DB::commit();

            // Dispatch event
            event(new SubscriptionUpdated($subscription, $oldPlan, $newPlan));

            Log::info('Subscription updated successfully', [
                'subscription_id' => $subscription->id,
                'old_plan_id' => $oldPlan->id,
                'new_plan_id' => $newPlan->id,
                'proration' => $gatewayUpdate['proration_amount'] ?? null,
            ]);

            return $subscription->fresh();
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Failed to update subscription', [
                'subscription_id' => $subscription->id,
                'new_plan_id' => $newPlan->id,
                'error' => $e->getMessage(),
            ]);

            throw $e;
        }
    }

    /**
     * Pause a subscription temporarily
     *
     * @param OrganizationSubscription $subscription
     * @param array $options pause_collection_behavior, resume_at
     * @return OrganizationSubscription
     * @throws \Exception
     */
    public function pauseSubscription(
        OrganizationSubscription $subscription,
        array $options = []
    ): OrganizationSubscription {
        // Validate subscription can be paused
        $this->validateStateTransition($subscription, 'pause');

        DB::beginTransaction();

        try {
            // Pause subscription with payment gateway
            $this->paymentService->pauseSubscription(
                $subscription->gateway_subscription_id,
                $options
            );

            // Update local subscription record
            $subscription->update([
                'status' => self::STATUS_PAUSED,
                'paused_at' => now(),
                'pause_collection_behavior' => $options['pause_collection_behavior'] ?? 'void',
                'resume_at' => isset($options['resume_at']) ? Carbon::parse($options['resume_at']) : null,
            ]);

            // Suspend license features (organization enters read-only mode)
            $this->suspendLicense($subscription->organization);

            DB::commit();

            // Dispatch event
            event(new SubscriptionPaused($subscription));

            Log::info('Subscription paused successfully', [
                'subscription_id' => $subscription->id,
                'resume_at' => $subscription->resume_at,
            ]);

            return $subscription->fresh();
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Failed to pause subscription', [
                'subscription_id' => $subscription->id,
                'error' => $e->getMessage(),
            ]);

            throw $e;
        }
    }

    /**
     * Resume a paused subscription
     *
     * @param OrganizationSubscription $subscription
     * @return OrganizationSubscription
     * @throws \Exception
     */
    public function resumeSubscription(OrganizationSubscription $subscription): OrganizationSubscription
    {
        // Validate subscription can be resumed
        $this->validateStateTransition($subscription, 'resume');

        DB::beginTransaction();

        try {
            // Resume subscription with payment gateway
            $gatewayResume = $this->paymentService->resumeSubscription(
                $subscription->gateway_subscription_id
            );

            // Update local subscription record
            $subscription->update([
                'status' => self::STATUS_ACTIVE,
                'paused_at' => null,
                'pause_collection_behavior' => null,
                'resume_at' => null,
                'current_period_start' => $gatewayResume['current_period_start'],
                'current_period_end' => $gatewayResume['current_period_end'],
            ]);

            // Restore license features
            $this->restoreLicense($subscription->organization, $subscription->subscriptionPlan);

            DB::commit();

            // Dispatch event
            event(new SubscriptionResumed($subscription));

            Log::info('Subscription resumed successfully', [
                'subscription_id' => $subscription->id,
            ]);

            return $subscription->fresh();
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Failed to resume subscription', [
                'subscription_id' => $subscription->id,
                'error' => $e->getMessage(),
            ]);

            throw $e;
        }
    }

    /**
     * Cancel a subscription
     *
     * @param OrganizationSubscription $subscription
     * @param bool $immediate If true, cancel immediately; if false, cancel at period end
     * @return OrganizationSubscription
     * @throws \Exception
     */
    public function cancelSubscription(
        OrganizationSubscription $subscription,
        bool $immediate = false
    ): OrganizationSubscription {
        // Validate subscription can be canceled
        $this->validateStateTransition($subscription, 'cancel');

        DB::beginTransaction();

        try {
            // Cancel subscription with payment gateway
            $this->paymentService->cancelSubscription(
                $subscription->gateway_subscription_id,
                $immediate
            );

            if ($immediate) {
                // Immediate cancellation
                $subscription->update([
                    'status' => self::STATUS_EXPIRED,
                    'canceled_at' => now(),
                    'ended_at' => now(),
                    'cancel_at_period_end' => false,
                ]);

                // Revoke license immediately
                $this->revokeLicense($subscription->organization);
            } else {
                // End-of-period cancellation
                $subscription->update([
                    'status' => self::STATUS_CANCELED,
                    'canceled_at' => now(),
                    'cancel_at_period_end' => true,
                ]);

                // License remains active until period ends
            }

            DB::commit();

            // Dispatch event
            event(new SubscriptionCanceled($subscription, $immediate));

            Log::info('Subscription canceled successfully', [
                'subscription_id' => $subscription->id,
                'immediate' => $immediate,
                'ended_at' => $subscription->ended_at,
            ]);

            return $subscription->fresh();
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Failed to cancel subscription', [
                'subscription_id' => $subscription->id,
                'immediate' => $immediate,
                'error' => $e->getMessage(),
            ]);

            throw $e;
        }
    }

    /**
     * Handle subscription renewal (webhook)
     *
     * @param OrganizationSubscription $subscription
     * @param array $renewalData Data from payment gateway webhook
     * @return OrganizationSubscription
     */
    public function handleRenewal(
        OrganizationSubscription $subscription,
        array $renewalData
    ): OrganizationSubscription {
        DB::beginTransaction();

        try {
            $subscription->update([
                'status' => self::STATUS_ACTIVE,
                'current_period_start' => Carbon::createFromTimestamp($renewalData['period_start']),
                'current_period_end' => Carbon::createFromTimestamp($renewalData['period_end']),
            ]);

            // Extend license validity
            $this->extendLicense($subscription->organization, $subscription->subscriptionPlan);

            DB::commit();

            Log::info('Subscription renewed successfully', [
                'subscription_id' => $subscription->id,
                'period_end' => $subscription->current_period_end,
            ]);

            return $subscription->fresh();
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Failed to handle subscription renewal', [
                'subscription_id' => $subscription->id,
                'error' => $e->getMessage(),
            ]);

            throw $e;
        }
    }

    /**
     * Handle payment failure (move to past_due)
     *
     * @param OrganizationSubscription $subscription
     * @return OrganizationSubscription
     */
    public function handlePaymentFailure(OrganizationSubscription $subscription): OrganizationSubscription
    {
        $subscription->update([
            'status' => self::STATUS_PAST_DUE,
        ]);

        Log::warning('Subscription payment failed', [
            'subscription_id' => $subscription->id,
            'grace_period_ends' => now()->addDays(self::GRACE_PERIOD_DAYS),
        ]);

        // Schedule auto-cancellation after grace period
        // ProcessSubscriptionCancellation::dispatch($subscription)
        //     ->delay(now()->addDays(self::GRACE_PERIOD_DAYS));

        return $subscription->fresh();
    }

    /**
     * Validate state transition is allowed
     *
     * @param OrganizationSubscription $subscription
     * @param string $action Action to validate (pause, resume, cancel, update)
     * @return void
     * @throws \Exception
     */
    protected function validateStateTransition(OrganizationSubscription $subscription, string $action): void
    {
        $currentStatus = $subscription->status;

        $allowedTransitions = [
            'pause' => [self::STATUS_ACTIVE, self::STATUS_TRIALING],
            'resume' => [self::STATUS_PAUSED],
            'cancel' => [self::STATUS_ACTIVE, self::STATUS_TRIALING, self::STATUS_PAUSED, self::STATUS_PAST_DUE],
            'update' => [self::STATUS_ACTIVE, self::STATUS_TRIALING],
        ];

        if (!isset($allowedTransitions[$action]) || !in_array($currentStatus, $allowedTransitions[$action])) {
            throw new \Exception(
                "Cannot {$action} subscription in status: {$currentStatus}. Allowed statuses: " .
                implode(', ', $allowedTransitions[$action] ?? [])
            );
        }
    }

    /**
     * Ensure organization has no active subscription
     *
     * @param Organization $organization
     * @return void
     * @throws \Exception
     */
    protected function ensureNoActiveSubscription(Organization $organization): void
    {
        $activeSubscription = $organization->subscriptions()
            ->whereIn('status', [self::STATUS_ACTIVE, self::STATUS_TRIALING, self::STATUS_PAUSED])
            ->first();

        if ($activeSubscription) {
            throw new \Exception(
                "Organization already has an active subscription (ID: {$activeSubscription->id}, Status: {$activeSubscription->status})"
            );
        }
    }

    /**
     * Provision enterprise license for organization
     *
     * @param Organization $organization
     * @param SubscriptionPlan $plan
     * @return void
     */
    protected function provisionLicense(Organization $organization, SubscriptionPlan $plan): void
    {
        $license = $organization->enterpriseLicense()->firstOrNew([
            'organization_id' => $organization->id,
        ]);

        $license->fill([
            'license_key' => $license->license_key ?? $this->generateLicenseKey(),
            'plan_tier' => $plan->tier,
            'max_users' => $plan->features['max_users'] ?? null,
            'max_servers' => $plan->features['max_servers'] ?? null,
            'max_applications' => $plan->features['max_applications'] ?? null,
            'feature_flags' => $plan->features,
            'expires_at' => now()->addMonth(), // Initial expiration
            'is_active' => true,
        ]);

        $license->save();

        Log::info('License provisioned', [
            'organization_id' => $organization->id,
            'license_id' => $license->id,
            'plan_tier' => $plan->tier,
        ]);
    }

    /**
     * Update enterprise license with new plan features
     *
     * @param Organization $organization
     * @param SubscriptionPlan $plan
     * @return void
     */
    protected function updateLicense(Organization $organization, SubscriptionPlan $plan): void
    {
        $license = $organization->enterpriseLicense;

        if (!$license) {
            // Fallback: provision if missing
            $this->provisionLicense($organization, $plan);
            return;
        }

        $license->update([
            'plan_tier' => $plan->tier,
            'max_users' => $plan->features['max_users'] ?? null,
            'max_servers' => $plan->features['max_servers'] ?? null,
            'max_applications' => $plan->features['max_applications'] ?? null,
            'feature_flags' => $plan->features,
        ]);

        Log::info('License updated', [
            'organization_id' => $organization->id,
            'license_id' => $license->id,
            'new_plan_tier' => $plan->tier,
        ]);
    }

    /**
     * Suspend license features
     *
     * @param Organization $organization
     * @return void
     */
    protected function suspendLicense(Organization $organization): void
    {
        $license = $organization->enterpriseLicense;

        if ($license) {
            $license->update(['is_active' => false]);

            Log::info('License suspended', [
                'organization_id' => $organization->id,
                'license_id' => $license->id,
            ]);
        }
    }

    /**
     * Restore license features
     *
     * @param Organization $organization
     * @param SubscriptionPlan $plan
     * @return void
     */
    protected function restoreLicense(Organization $organization, SubscriptionPlan $plan): void
    {
        $license = $organization->enterpriseLicense;

        if ($license) {
            $license->update([
                'is_active' => true,
                'expires_at' => now()->addMonth(),
            ]);

            Log::info('License restored', [
                'organization_id' => $organization->id,
                'license_id' => $license->id,
            ]);
        }
    }

    /**
     * Extend license validity on renewal
     *
     * @param Organization $organization
     * @param SubscriptionPlan $plan
     * @return void
     */
    protected function extendLicense(Organization $organization, SubscriptionPlan $plan): void
    {
        $license = $organization->enterpriseLicense;

        if ($license) {
            $license->update([
                'expires_at' => now()->addMonth(),
            ]);

            Log::info('License extended', [
                'organization_id' => $organization->id,
                'license_id' => $license->id,
                'new_expiration' => $license->expires_at,
            ]);
        }
    }

    /**
     * Revoke license features on cancellation
     *
     * @param Organization $organization
     * @return void
     */
    protected function revokeLicense(Organization $organization): void
    {
        $license = $organization->enterpriseLicense;

        if ($license) {
            $license->update([
                'is_active' => false,
                'expires_at' => now(),
            ]);

            Log::info('License revoked', [
                'organization_id' => $organization->id,
                'license_id' => $license->id,
            ]);
        }
    }

    /**
     * Generate unique license key
     *
     * @return string
     */
    protected function generateLicenseKey(): string
    {
        return 'CLFENT-' . strtoupper(bin2hex(random_bytes(12)));
    }
}
```

### Service Interface

**File:** `app/Contracts/SubscriptionLifecycleServiceInterface.php`

```php
<?php

namespace App\Contracts;

use App\Models\Organization;
use App\Models\Enterprise\OrganizationSubscription;
use App\Models\Enterprise\SubscriptionPlan;

interface SubscriptionLifecycleServiceInterface
{
    /**
     * Create a new subscription
     *
     * @param Organization $organization
     * @param SubscriptionPlan $plan
     * @param string $paymentMethodId
     * @param array $options
     * @return OrganizationSubscription
     */
    public function createSubscription(
        Organization $organization,
        SubscriptionPlan $plan,
        string $paymentMethodId,
        array $options = []
    ): OrganizationSubscription;

    /**
     * Update subscription to a different plan
     *
     * @param OrganizationSubscription $subscription
     * @param SubscriptionPlan $newPlan
     * @param array $options
     * @return OrganizationSubscription
     */
    public function updateSubscription(
        OrganizationSubscription $subscription,
        SubscriptionPlan $newPlan,
        array $options = []
    ): OrganizationSubscription;

    /**
     * Pause a subscription
     *
     * @param OrganizationSubscription $subscription
     * @param array $options
     * @return OrganizationSubscription
     */
    public function pauseSubscription(
        OrganizationSubscription $subscription,
        array $options = []
    ): OrganizationSubscription;

    /**
     * Resume a paused subscription
     *
     * @param OrganizationSubscription $subscription
     * @return OrganizationSubscription
     */
    public function resumeSubscription(OrganizationSubscription $subscription): OrganizationSubscription;

    /**
     * Cancel a subscription
     *
     * @param OrganizationSubscription $subscription
     * @param bool $immediate
     * @return OrganizationSubscription
     */
    public function cancelSubscription(
        OrganizationSubscription $subscription,
        bool $immediate = false
    ): OrganizationSubscription;

    /**
     * Handle subscription renewal
     *
     * @param OrganizationSubscription $subscription
     * @param array $renewalData
     * @return OrganizationSubscription
     */
    public function handleRenewal(
        OrganizationSubscription $subscription,
        array $renewalData
    ): OrganizationSubscription;

    /**
     * Handle payment failure
     *
     * @param OrganizationSubscription $subscription
     * @return OrganizationSubscription
     */
    public function handlePaymentFailure(OrganizationSubscription $subscription): OrganizationSubscription;
}
```

### Controller Enhancement

**File:** `app/Http/Controllers/Enterprise/SubscriptionController.php`

```php
<?php

namespace App\Http\Controllers\Enterprise;

use App\Http\Controllers\Controller;
use App\Contracts\SubscriptionLifecycleServiceInterface;
use App\Models\Organization;
use App\Models\Enterprise\OrganizationSubscription;
use App\Models\Enterprise\SubscriptionPlan;
use Illuminate\Http\Request;
use Illuminate\Foundation\Auth\Access\AuthorizesRequests;
use Inertia\Inertia;

class SubscriptionController extends Controller
{
    use AuthorizesRequests;

    public function __construct(
        private SubscriptionLifecycleServiceInterface $subscriptionService
    ) {
    }

    /**
     * Create a new subscription
     *
     * @param Request $request
     * @param Organization $organization
     * @return \Illuminate\Http\RedirectResponse
     */
    public function create(Request $request, Organization $organization)
    {
        $this->authorize('manageSubscription', $organization);

        $validated = $request->validate([
            'plan_id' => 'required|exists:subscription_plans,id',
            'payment_method_id' => 'required|string',
            'trial_days' => 'nullable|integer|min:0|max:30',
        ]);

        $plan = SubscriptionPlan::findOrFail($validated['plan_id']);

        try {
            $subscription = $this->subscriptionService->createSubscription(
                $organization,
                $plan,
                $validated['payment_method_id'],
                [
                    'trial_days' => $validated['trial_days'] ?? 0,
                ]
            );

            return back()->with('success', 'Subscription created successfully');
        } catch (\Exception $e) {
            return back()->with('error', 'Failed to create subscription: ' . $e->getMessage());
        }
    }

    /**
     * Update subscription plan
     *
     * @param Request $request
     * @param Organization $organization
     * @param OrganizationSubscription $subscription
     * @return \Illuminate\Http\RedirectResponse
     */
    public function update(Request $request, Organization $organization, OrganizationSubscription $subscription)
    {
        $this->authorize('manageSubscription', $organization);

        $validated = $request->validate([
            'plan_id' => 'required|exists:subscription_plans,id',
            'proration_behavior' => 'nullable|in:create_prorations,none,always_invoice',
        ]);

        $newPlan = SubscriptionPlan::findOrFail($validated['plan_id']);

        try {
            $subscription = $this->subscriptionService->updateSubscription(
                $subscription,
                $newPlan,
                ['proration_behavior' => $validated['proration_behavior'] ?? 'create_prorations']
            );

            return back()->with('success', 'Subscription updated successfully');
        } catch (\Exception $e) {
            return back()->with('error', 'Failed to update subscription: ' . $e->getMessage());
        }
    }

    /**
     * Pause subscription
     *
     * @param Request $request
     * @param Organization $organization
     * @param OrganizationSubscription $subscription
     * @return \Illuminate\Http\RedirectResponse
     */
    public function pause(Request $request, Organization $organization, OrganizationSubscription $subscription)
    {
        $this->authorize('manageSubscription', $organization);

        $validated = $request->validate([
            'resume_at' => 'nullable|date|after:today',
        ]);

        try {
            $subscription = $this->subscriptionService->pauseSubscription(
                $subscription,
                ['resume_at' => $validated['resume_at'] ?? null]
            );

            return back()->with('success', 'Subscription paused successfully');
        } catch (\Exception $e) {
            return back()->with('error', 'Failed to pause subscription: ' . $e->getMessage());
        }
    }

    /**
     * Resume paused subscription
     *
     * @param Organization $organization
     * @param OrganizationSubscription $subscription
     * @return \Illuminate\Http\RedirectResponse
     */
    public function resume(Organization $organization, OrganizationSubscription $subscription)
    {
        $this->authorize('manageSubscription', $organization);

        try {
            $subscription = $this->subscriptionService->resumeSubscription($subscription);

            return back()->with('success', 'Subscription resumed successfully');
        } catch (\Exception $e) {
            return back()->with('error', 'Failed to resume subscription: ' . $e->getMessage());
        }
    }

    /**
     * Cancel subscription
     *
     * @param Request $request
     * @param Organization $organization
     * @param OrganizationSubscription $subscription
     * @return \Illuminate\Http\RedirectResponse
     */
    public function cancel(Request $request, Organization $organization, OrganizationSubscription $subscription)
    {
        $this->authorize('manageSubscription', $organization);

        $validated = $request->validate([
            'immediate' => 'nullable|boolean',
        ]);

        try {
            $subscription = $this->subscriptionService->cancelSubscription(
                $subscription,
                $validated['immediate'] ?? false
            );

            $message = $validated['immediate'] ?? false
                ? 'Subscription canceled immediately'
                : 'Subscription will cancel at the end of the billing period';

            return back()->with('success', $message);
        } catch (\Exception $e) {
            return back()->with('error', 'Failed to cancel subscription: ' . $e->getMessage());
        }
    }
}
```

### Events

**File:** `app/Events/Enterprise/SubscriptionCreated.php`

```php
<?php

namespace App\Events\Enterprise;

use App\Models\Enterprise\OrganizationSubscription;
use Illuminate\Foundation\Events\Dispatchable;
use Illuminate\Queue\SerializesModels;

class SubscriptionCreated
{
    use Dispatchable, SerializesModels;

    public function __construct(
        public OrganizationSubscription $subscription
    ) {
    }
}
```

**Similar events:** `SubscriptionUpdated`, `SubscriptionPaused`, `SubscriptionResumed`, `SubscriptionCanceled`

### Routes

**File:** `routes/web.php`

```php
// Subscription management routes
Route::middleware(['auth', 'organization'])->group(function () {
    Route::prefix('enterprise/organizations/{organization}/subscriptions')->group(function () {
        Route::post('/', [SubscriptionController::class, 'create'])
            ->name('enterprise.subscriptions.create');

        Route::patch('/{subscription}', [SubscriptionController::class, 'update'])
            ->name('enterprise.subscriptions.update');

        Route::post('/{subscription}/pause', [SubscriptionController::class, 'pause'])
            ->name('enterprise.subscriptions.pause');

        Route::post('/{subscription}/resume', [SubscriptionController::class, 'resume'])
            ->name('enterprise.subscriptions.resume');

        Route::delete('/{subscription}', [SubscriptionController::class, 'cancel'])
            ->name('enterprise.subscriptions.cancel');
    });
});
```

## Implementation Approach

### Step 1: Create Service Interface and Implementation
1. Create `SubscriptionLifecycleServiceInterface` in `app/Contracts/`
2. Implement `SubscriptionLifecycleService` in `app/Services/Enterprise/`
3. Register service in `EnterpriseServiceProvider`

### Step 2: Implement Core Lifecycle Methods
1. Implement `createSubscription()` with trial period support
2. Implement `updateSubscription()` with pro-ration
3. Implement `pauseSubscription()` with scheduled resume
4. Implement `resumeSubscription()` with billing restart
5. Implement `cancelSubscription()` with immediate/end-of-period modes

### Step 3: Add State Validation
1. Create `validateStateTransition()` method
2. Define allowed state transitions matrix
3. Add validation to all lifecycle methods
4. Throw descriptive exceptions for invalid transitions

### Step 4: License Integration
1. Implement `provisionLicense()` on subscription creation
2. Implement `updateLicense()` on plan changes
3. Implement `suspendLicense()` on pause
4. Implement `restoreLicense()` on resume
5. Implement `revokeLicense()` on cancellation

### Step 5: Create Events and Listeners
1. Create subscription lifecycle events
2. Create `SyncLicenseOnSubscriptionChange` listener
3. Create `SendSubscriptionNotifications` listener
4. Register in `EventServiceProvider`

### Step 6: Controller Integration
1. Enhance `SubscriptionController` with lifecycle endpoints
2. Add authorization via `SubscriptionPolicy`
3. Add request validation
4. Implement error handling with user-friendly messages

### Step 7: Background Jobs
1. Create `ProcessSubscriptionCancellation` for delayed cancellations
2. Create `HandleSubscriptionRenewal` for renewal processing
3. Schedule jobs appropriately

### Step 8: Testing
1. Unit test all lifecycle methods
2. Test state transitions
3. Test license synchronization
4. Integration test complete user flows
5. Test error scenarios and rollbacks

## Test Strategy

### Unit Tests

**File:** `tests/Unit/Enterprise/SubscriptionLifecycleServiceTest.php`

```php
<?php

use App\Services\Enterprise\SubscriptionLifecycleService;
use App\Models\Organization;
use App\Models\Enterprise\SubscriptionPlan;
use App\Models\Enterprise\OrganizationSubscription;
use App\Contracts\PaymentServiceInterface;
use Illuminate\Support\Facades\Event;

beforeEach(function () {
    $this->paymentService = Mockery::mock(PaymentServiceInterface::class);
    $this->service = new SubscriptionLifecycleService($this->paymentService);
});

it('creates subscription with trial period', function () {
    Event::fake();

    $organization = Organization::factory()->create();
    $plan = SubscriptionPlan::factory()->create(['tier' => 'professional']);

    $this->paymentService->shouldReceive('createSubscription')
        ->once()
        ->andReturn([
            'gateway' => 'stripe',
            'subscription_id' => 'sub_test123',
            'customer_id' => 'cus_test123',
            'current_period_start' => now(),
            'current_period_end' => now()->addMonth(),
            'billing_cycle_anchor' => now(),
        ]);

    $subscription = $this->service->createSubscription(
        $organization,
        $plan,
        'pm_test_card',
        ['trial_days' => 14]
    );

    expect($subscription->status)->toBe('trialing');
    expect($subscription->trial_ends_at)->not->toBeNull();
    expect($subscription->organization_id)->toBe($organization->id);

    // Verify license was provisioned
    expect($organization->fresh()->enterpriseLicense)->not->toBeNull();
});

it('updates subscription with plan change', function () {
    $subscription = OrganizationSubscription::factory()->create(['status' => 'active']);
    $newPlan = SubscriptionPlan::factory()->create(['tier' => 'enterprise']);

    $this->paymentService->shouldReceive('updateSubscription')
        ->once()
        ->andReturn([
            'current_period_start' => now(),
            'current_period_end' => now()->addMonth(),
            'proration_amount' => 500,
        ]);

    $updatedSubscription = $this->service->updateSubscription($subscription, $newPlan);

    expect($updatedSubscription->subscription_plan_id)->toBe($newPlan->id);
});

it('pauses active subscription', function () {
    $subscription = OrganizationSubscription::factory()->create(['status' => 'active']);

    $this->paymentService->shouldReceive('pauseSubscription')->once();

    $pausedSubscription = $this->service->pauseSubscription($subscription);

    expect($pausedSubscription->status)->toBe('paused');
    expect($pausedSubscription->paused_at)->not->toBeNull();
});

it('resumes paused subscription', function () {
    $subscription = OrganizationSubscription::factory()->create(['status' => 'paused']);

    $this->paymentService->shouldReceive('resumeSubscription')
        ->once()
        ->andReturn([
            'current_period_start' => now(),
            'current_period_end' => now()->addMonth(),
        ]);

    $resumedSubscription = $this->service->resumeSubscription($subscription);

    expect($resumedSubscription->status)->toBe('active');
    expect($resumedSubscription->paused_at)->toBeNull();
});

it('cancels subscription immediately', function () {
    $subscription = OrganizationSubscription::factory()->create(['status' => 'active']);

    $this->paymentService->shouldReceive('cancelSubscription')->once();

    $canceledSubscription = $this->service->cancelSubscription($subscription, immediate: true);

    expect($canceledSubscription->status)->toBe('expired');
    expect($canceledSubscription->ended_at)->not->toBeNull();
});

it('prevents invalid state transitions', function () {
    $subscription = OrganizationSubscription::factory()->create(['status' => 'expired']);

    expect(fn() => $this->service->resumeSubscription($subscription))
        ->toThrow(\Exception::class, 'Cannot resume subscription in status: expired');
});

it('prevents creating duplicate active subscriptions', function () {
    $organization = Organization::factory()->create();
    OrganizationSubscription::factory()->create([
        'organization_id' => $organization->id,
        'status' => 'active',
    ]);

    $plan = SubscriptionPlan::factory()->create();

    expect(fn() => $this->service->createSubscription($organization, $plan, 'pm_test'))
        ->toThrow(\Exception::class, 'Organization already has an active subscription');
});
```

### Integration Tests

**File:** `tests/Feature/Enterprise/SubscriptionLifecycleTest.php`

```php
<?php

use App\Models\Organization;
use App\Models\User;
use App\Models\Enterprise\SubscriptionPlan;
use App\Models\Enterprise\OrganizationSubscription;
use Illuminate\Support\Facades\Queue;

it('creates subscription via controller', function () {
    Queue::fake();

    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'owner']);

    $plan = SubscriptionPlan::factory()->create();

    $this->actingAs($user)
        ->post(route('enterprise.subscriptions.create', $organization), [
            'plan_id' => $plan->id,
            'payment_method_id' => 'pm_test_card',
            'trial_days' => 14,
        ])
        ->assertRedirect()
        ->assertSessionHas('success');

    expect($organization->fresh()->subscriptions)->toHaveCount(1);
});

it('updates subscription plan', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'owner']);

    $subscription = OrganizationSubscription::factory()->create([
        'organization_id' => $organization->id,
        'status' => 'active',
    ]);

    $newPlan = SubscriptionPlan::factory()->create();

    $this->actingAs($user)
        ->patch(route('enterprise.subscriptions.update', [$organization, $subscription]), [
            'plan_id' => $newPlan->id,
        ])
        ->assertRedirect()
        ->assertSessionHas('success');

    expect($subscription->fresh()->subscription_plan_id)->toBe($newPlan->id);
});

it('pauses and resumes subscription', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'owner']);

    $subscription = OrganizationSubscription::factory()->create([
        'organization_id' => $organization->id,
        'status' => 'active',
    ]);

    // Pause
    $this->actingAs($user)
        ->post(route('enterprise.subscriptions.pause', [$organization, $subscription]))
        ->assertSessionHas('success');

    expect($subscription->fresh()->status)->toBe('paused');

    // Resume
    $this->actingAs($user)
        ->post(route('enterprise.subscriptions.resume', [$organization, $subscription]))
        ->assertSessionHas('success');

    expect($subscription->fresh()->status)->toBe('active');
});
```

## Definition of Done

- [ ] SubscriptionLifecycleServiceInterface created
- [ ] SubscriptionLifecycleService implemented with all core methods
- [ ] Service registered in EnterpriseServiceProvider
- [ ] createSubscription() supports all plan tiers with trial periods
- [ ] updateSubscription() handles plan changes with pro-ration
- [ ] pauseSubscription() stops billing and allows scheduled resume
- [ ] resumeSubscription() restarts billing and restores features
- [ ] cancelSubscription() supports both immediate and end-of-period modes
- [ ] State transition validation implemented and tested
- [ ] License synchronization works for all lifecycle events
- [ ] Payment method validation implemented
- [ ] Pro-ration calculations integrated with payment service
- [ ] Trial period handling implemented
- [ ] Webhook handlers integrated (renewal, payment_failed)
- [ ] Events created for all lifecycle transitions
- [ ] Event listeners created (license sync, notifications)
- [ ] SubscriptionController enhanced with lifecycle endpoints
- [ ] SubscriptionPolicy created with authorization rules
- [ ] Routes registered for all lifecycle operations
- [ ] Unit tests written (15+ tests, >90% coverage)
- [ ] Integration tests written (10+ tests)
- [ ] Error handling tested with rollback verification
- [ ] Documentation updated with API examples
- [ ] Code follows Laravel best practices
- [ ] PHPStan level 5 passing
- [ ] Laravel Pint formatting applied
- [ ] Code reviewed and approved

## Related Tasks

- **Depends on:** Task 46 (PaymentService gateway integration)
- **Integrates with:** Tasks 1-2 (EnterpriseLicense management)
- **Used by:** Task 50 (SubscriptionManager.vue UI)
- **Feeds into:** Task 49 (Usage-based billing calculations)
- **Triggered by:** Webhooks from Task 47 (Webhook handling system)
