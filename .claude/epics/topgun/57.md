---
name: Enhance OpenAPI specification with organization scoping examples
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:39:11Z
github: https://github.com/johnproblems/topgun/issues/165
depends_on: [56]
parallel: false
conflicts_with: []
---

# Task: Enhance OpenAPI specification with organization scoping examples

## Description

Enhance Coolify's existing OpenAPI (Swagger) specification to include comprehensive documentation for organization-scoped API endpoints, demonstrating how the multi-tenant architecture works through practical examples, authentication patterns, and clear organization context explanations. This task transforms the API documentation from a basic endpoint reference into an enterprise-ready developer guide that teaches API consumers how to work with Coolify's hierarchical organization system, rate limiting, and scoped access patterns.

**The Documentation Challenge:**

Coolify's transformation into an enterprise multi-tenant platform introduces significant complexity for API consumers:

1. **Organization Context**: Every API request operates within an organization context, but this isn't obvious from standard OpenAPI specs
2. **Hierarchical Relationships**: Organizations have parent-child relationships affecting resource access and visibility
3. **Scoped Tokens**: Sanctum tokens are bound to specific organizations with ability-based permissions
4. **Rate Limiting**: Different organization tiers have different rate limits (Starter: 100/min, Pro: 500/min, Enterprise: 2000/min)
5. **Resource Isolation**: Resources (servers, applications, deployments) are strictly isolated by organization_id

Without clear documentation and examples, developers will struggle to:
- Understand which organization context they're operating in
- Know how to switch between organizations they belong to
- Properly scope API tokens for multi-organization access
- Handle rate limit responses correctly
- Understand resource visibility across organization hierarchies

**What This Task Delivers:**

A comprehensive OpenAPI specification enhancement that includes:

1. **Organization Context Documentation**: Clear explanations of how organization scoping works in every endpoint
2. **Authentication Examples**: Real-world examples showing token generation, organization selection, and permission scoping
3. **Request/Response Examples**: Practical examples demonstrating organization context in headers, query parameters, and response bodies
4. **Rate Limiting Documentation**: Detailed rate limit headers, tier-based limits, and error response examples
5. **Error Scenarios**: Comprehensive error response documentation for common organization-related issues
6. **Schema Enhancements**: Updated models showing organization relationships and metadata
7. **Interactive Examples**: Swagger UI-ready examples that developers can execute directly from documentation

**Key Features:**

- Organization-scoped endpoint documentation for all enterprise features (Terraform, capacity management, white-label)
- Authentication flow documentation with organization context selection
- Rate limiting examples with tier-based response headers
- Multi-organization token examples showing ability scoping
- Hierarchical resource access examples (parent org seeing child org resources)
- Error response documentation for organization context issues
- Schema definitions for all organization-related models
- Tag organization for logical endpoint grouping

**Integration Points:**

- **Task 52 (Sanctum Organization Context)**: Documents the token-organization binding mechanism
- **Task 53 (ApiOrganizationScope Middleware)**: Documents automatic organization scoping behavior
- **Task 54 (Rate Limiting)**: Documents tier-based rate limiting with response headers
- **Task 56 (API Endpoints)**: Documents all new organization, infrastructure, and monitoring endpoints
- **Task 58 (Swagger UI)**: Provides specification for interactive API explorer

**Why This Task Is Critical:**

API documentation is the first touchpoint for developers integrating with Coolify Enterprise. Poor documentation leads to:
- Extended integration times (days → weeks)
- Support burden from confused developers
- Implementation errors and security mistakes
- Negative developer experience and platform abandonment

Excellent API documentation reduces integration time by 70-80%, decreases support requests by 60%, and significantly improves developer satisfaction. For an enterprise product, comprehensive API documentation isn't optional—it's the foundation of developer success and platform adoption. This task ensures every developer can quickly understand, correctly implement, and successfully integrate with Coolify's multi-tenant API architecture.

## Acceptance Criteria

- [ ] OpenAPI specification file enhanced with organization context documentation
- [ ] All organization-scoped endpoints documented with organization context examples
- [ ] Authentication section includes organization token scoping examples
- [ ] Rate limiting documentation with tier-based limits and response headers
- [ ] Schema definitions for Organization, OrganizationUser, EnterpriseLicense models
- [ ] Request examples showing organization_id in various positions (header, query, path)
- [ ] Response examples showing organization metadata and relationships
- [ ] Error response documentation for all organization-related errors (401, 403, 404, 429)
- [ ] Multi-organization access examples demonstrating token abilities
- [ ] Hierarchical resource access examples (parent accessing child resources)
- [ ] Interactive Swagger UI examples that execute successfully
- [ ] Tag organization for logical endpoint grouping (Organizations, Infrastructure, Monitoring, etc.)
- [ ] Security scheme documentation for Sanctum tokens with organization scoping
- [ ] Webhook documentation for organization-scoped events
- [ ] API versioning documentation

## Technical Details

### File Paths

**OpenAPI Specification:**
- `/home/topgun/topgun/storage/api-docs/api-docs.json` (generated by L5-Swagger)
- `/home/topgun/topgun/app/Http/Controllers/Api/` (controllers with OpenAPI annotations)

**Configuration:**
- `/home/topgun/topgun/config/l5-swagger.php` (L5-Swagger configuration)

**API Controllers (to be annotated):**
- `/home/topgun/topgun/app/Http/Controllers/Api/V1/OrganizationController.php`
- `/home/topgun/topgun/app/Http/Controllers/Api/V1/TerraformController.php`
- `/home/topgun/topgun/app/Http/Controllers/Api/V1/ResourceMonitoringController.php`
- `/home/topgun/topgun/app/Http/Controllers/Api/V1/WhiteLabelController.php`

### OpenAPI Specification Structure

**File:** `storage/api-docs/api-docs.json` (generated from annotations)

```json
{
  "openapi": "3.0.0",
  "info": {
    "title": "Coolify Enterprise API",
    "version": "1.0.0",
    "description": "Multi-tenant cloud deployment and infrastructure management platform with organization-scoped access control, Terraform provisioning, and enterprise features.",
    "contact": {
      "name": "Coolify API Support",
      "url": "https://coolify.io/support",
      "email": "api@coolify.io"
    },
    "license": {
      "name": "MIT",
      "url": "https://opensource.org/licenses/MIT"
    }
  },
  "servers": [
    {
      "url": "https://api.coolify.io/v1",
      "description": "Production API"
    },
    {
      "url": "https://staging.coolify.io/v1",
      "description": "Staging API"
    },
    {
      "url": "http://localhost:8000/api/v1",
      "description": "Local Development"
    }
  ],
  "tags": [
    {
      "name": "Organizations",
      "description": "Organization management, hierarchy, and user membership"
    },
    {
      "name": "Authentication",
      "description": "Token generation, organization context selection, and permission scoping"
    },
    {
      "name": "Infrastructure",
      "description": "Terraform provisioning, cloud provider credentials, and server management"
    },
    {
      "name": "Monitoring",
      "description": "Resource metrics, capacity planning, and organization usage tracking"
    },
    {
      "name": "White Label",
      "description": "Branding configuration, theme customization, and asset generation"
    },
    {
      "name": "Applications",
      "description": "Application deployment, management, and configuration"
    },
    {
      "name": "Webhooks",
      "description": "Organization-scoped webhook management and event delivery"
    }
  ],
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "Sanctum Token",
        "description": "Laravel Sanctum token with organization scoping. Tokens are bound to specific organizations and include ability-based permissions. Include in Authorization header: `Bearer {token}`"
      }
    },
    "schemas": {
      "Organization": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "example": 42,
            "description": "Unique organization identifier"
          },
          "uuid": {
            "type": "string",
            "format": "uuid",
            "example": "550e8400-e29b-41d4-a716-446655440000",
            "description": "UUID for external references"
          },
          "name": {
            "type": "string",
            "example": "Acme Corporation",
            "description": "Organization display name"
          },
          "slug": {
            "type": "string",
            "example": "acme-corp",
            "description": "URL-friendly organization identifier"
          },
          "parent_organization_id": {
            "type": "integer",
            "nullable": true,
            "example": 10,
            "description": "Parent organization ID for hierarchical structures (null for top-level organizations)"
          },
          "type": {
            "type": "string",
            "enum": ["top_branch", "master_branch", "sub_user", "end_user"],
            "example": "master_branch",
            "description": "Organization hierarchy level"
          },
          "metadata": {
            "type": "object",
            "nullable": true,
            "example": {"industry": "technology", "employee_count": 250},
            "description": "Custom metadata key-value pairs"
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "example": "2024-01-15T10:30:00Z"
          },
          "updated_at": {
            "type": "string",
            "format": "date-time",
            "example": "2024-10-05T14:22:00Z"
          },
          "parent": {
            "$ref": "#/components/schemas/Organization",
            "description": "Parent organization (if hierarchical)"
          },
          "children": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/Organization"
            },
            "description": "Child organizations (if hierarchical)"
          },
          "license": {
            "$ref": "#/components/schemas/EnterpriseLicense",
            "description": "Active enterprise license"
          }
        },
        "required": ["id", "uuid", "name", "slug", "type"]
      },
      "EnterpriseLicense": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "example": 15
          },
          "organization_id": {
            "type": "integer",
            "example": 42
          },
          "license_key": {
            "type": "string",
            "example": "CKFY-ENT-XXXX-XXXX-XXXX"
          },
          "tier": {
            "type": "string",
            "enum": ["starter", "professional", "enterprise", "custom"],
            "example": "professional"
          },
          "features": {
            "type": "object",
            "example": {
              "white_label": true,
              "terraform": true,
              "advanced_monitoring": true,
              "sso": false
            }
          },
          "limits": {
            "type": "object",
            "example": {
              "max_servers": 50,
              "max_applications": 500,
              "max_users": 25,
              "api_rate_limit": 500
            }
          },
          "valid_until": {
            "type": "string",
            "format": "date-time",
            "example": "2025-12-31T23:59:59Z"
          },
          "is_active": {
            "type": "boolean",
            "example": true
          }
        }
      },
      "RateLimitError": {
        "type": "object",
        "properties": {
          "message": {
            "type": "string",
            "example": "Rate limit exceeded. Please retry after 45 seconds."
          },
          "status": {
            "type": "integer",
            "example": 429
          },
          "retry_after": {
            "type": "integer",
            "example": 45,
            "description": "Seconds until rate limit resets"
          },
          "limit": {
            "type": "integer",
            "example": 500,
            "description": "Requests allowed per minute for your organization tier"
          },
          "remaining": {
            "type": "integer",
            "example": 0,
            "description": "Remaining requests in current window"
          }
        }
      },
      "OrganizationContextError": {
        "type": "object",
        "properties": {
          "message": {
            "type": "string",
            "example": "No organization context found in request. Include organization_id in header or query parameter."
          },
          "status": {
            "type": "integer",
            "example": 400
          },
          "missing_context": {
            "type": "string",
            "example": "organization_id"
          }
        }
      },
      "OrganizationAccessDeniedError": {
        "type": "object",
        "properties": {
          "message": {
            "type": "string",
            "example": "You do not have access to this organization or resource."
          },
          "status": {
            "type": "integer",
            "example": 403
          },
          "organization_id": {
            "type": "integer",
            "example": 42
          },
          "required_permission": {
            "type": "string",
            "example": "organizations.view"
          }
        }
      }
    },
    "responses": {
      "RateLimitExceeded": {
        "description": "Rate limit exceeded. Retry after the specified time.",
        "headers": {
          "X-RateLimit-Limit": {
            "schema": {
              "type": "integer",
              "example": 500
            },
            "description": "Total requests allowed per minute for your tier"
          },
          "X-RateLimit-Remaining": {
            "schema": {
              "type": "integer",
              "example": 0
            },
            "description": "Remaining requests in current window"
          },
          "X-RateLimit-Reset": {
            "schema": {
              "type": "integer",
              "example": 1709645400
            },
            "description": "Unix timestamp when rate limit resets"
          },
          "Retry-After": {
            "schema": {
              "type": "integer",
              "example": 45
            },
            "description": "Seconds to wait before retrying"
          }
        },
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/RateLimitError"
            }
          }
        }
      },
      "OrganizationContextMissing": {
        "description": "Organization context not provided in request",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/OrganizationContextError"
            }
          }
        }
      },
      "OrganizationAccessDenied": {
        "description": "Access denied to organization or resource",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/OrganizationAccessDeniedError"
            }
          }
        }
      }
    },
    "parameters": {
      "OrganizationIdHeader": {
        "name": "X-Organization-ID",
        "in": "header",
        "required": true,
        "schema": {
          "type": "integer",
          "example": 42
        },
        "description": "Organization context for the request. All resources will be scoped to this organization."
      },
      "OrganizationIdQuery": {
        "name": "organization_id",
        "in": "query",
        "required": false,
        "schema": {
          "type": "integer",
          "example": 42
        },
        "description": "Alternative way to specify organization context via query parameter"
      },
      "OrganizationIdPath": {
        "name": "organization",
        "in": "path",
        "required": true,
        "schema": {
          "type": "integer",
          "example": 42
        },
        "description": "Organization ID from URL path"
      }
    },
    "examples": {
      "ListOrganizationsExample": {
        "summary": "List organizations accessible to authenticated user",
        "value": {
          "data": [
            {
              "id": 42,
              "uuid": "550e8400-e29b-41d4-a716-446655440000",
              "name": "Acme Corporation",
              "slug": "acme-corp",
              "type": "master_branch",
              "parent_organization_id": 10,
              "created_at": "2024-01-15T10:30:00Z",
              "license": {
                "tier": "professional",
                "valid_until": "2025-12-31T23:59:59Z"
              }
            },
            {
              "id": 43,
              "uuid": "660f9511-f3ac-52e5-b827-557766551111",
              "name": "Acme Development Team",
              "slug": "acme-dev",
              "type": "sub_user",
              "parent_organization_id": 42,
              "created_at": "2024-02-20T14:15:00Z"
            }
          ],
          "meta": {
            "total": 2,
            "per_page": 20,
            "current_page": 1
          }
        }
      },
      "GetOrganizationExample": {
        "summary": "Get single organization with relationships",
        "value": {
          "data": {
            "id": 42,
            "uuid": "550e8400-e29b-41d4-a716-446655440000",
            "name": "Acme Corporation",
            "slug": "acme-corp",
            "type": "master_branch",
            "parent_organization_id": 10,
            "metadata": {
              "industry": "technology",
              "employee_count": 250
            },
            "created_at": "2024-01-15T10:30:00Z",
            "parent": {
              "id": 10,
              "name": "Acme Global",
              "slug": "acme-global",
              "type": "top_branch"
            },
            "children": [
              {
                "id": 43,
                "name": "Acme Development Team",
                "slug": "acme-dev",
                "type": "sub_user"
              },
              {
                "id": 44,
                "name": "Acme QA Team",
                "slug": "acme-qa",
                "type": "sub_user"
              }
            ],
            "license": {
              "tier": "professional",
              "features": {
                "white_label": true,
                "terraform": true,
                "advanced_monitoring": true
              },
              "limits": {
                "max_servers": 50,
                "max_applications": 500,
                "api_rate_limit": 500
              },
              "valid_until": "2025-12-31T23:59:59Z"
            }
          }
        }
      },
      "CreateTokenWithOrganizationScopingExample": {
        "summary": "Create API token with organization-specific abilities",
        "value": {
          "data": {
            "token": "42|vQZxP8K9j2mN1rL4sD6fG8hJ0kM3nP5qR7tV9wX2yA4cE6gI8oU0",
            "abilities": [
              "organizations:42:view",
              "organizations:42:update",
              "servers:42:*",
              "applications:42:*"
            ],
            "organization_id": 42,
            "organization_name": "Acme Corporation",
            "expires_at": "2025-10-05T14:30:00Z",
            "created_at": "2024-10-05T14:30:00Z"
          }
        }
      },
      "RateLimitHeadersExample": {
        "summary": "Response headers for rate-limited request",
        "value": {
          "X-RateLimit-Limit": "500",
          "X-RateLimit-Remaining": "487",
          "X-RateLimit-Reset": "1709645460"
        }
      }
    }
  },
  "security": [
    {
      "bearerAuth": []
    }
  ]
}
```

### Controller Annotation Examples

**File:** `app/Http/Controllers/Api/V1/OrganizationController.php`

```php
<?php

namespace App\Http\Controllers\Api\V1;

use App\Http\Controllers\Controller;
use App\Models\Organization;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use OpenApi\Annotations as OA;

/**
 * @OA\Info(
 *     title="Coolify Enterprise API",
 *     version="1.0.0",
 *     description="Multi-tenant cloud deployment and infrastructure management platform",
 *     @OA\Contact(
 *         name="Coolify API Support",
 *         email="api@coolify.io"
 *     )
 * )
 *
 * @OA\Server(
 *     url="https://api.coolify.io/v1",
 *     description="Production API"
 * )
 *
 * @OA\SecurityScheme(
 *     securityScheme="bearerAuth",
 *     type="http",
 *     scheme="bearer",
 *     bearerFormat="Sanctum Token",
 *     description="Laravel Sanctum token with organization scoping"
 * )
 *
 * @OA\Tag(
 *     name="Organizations",
 *     description="Organization management with hierarchical multi-tenancy support"
 * )
 */
class OrganizationController extends Controller
{
    /**
     * List all organizations accessible to the authenticated user
     *
     * Returns organizations where the user has membership, including organizations
     * in the hierarchy (parent and child organizations based on permissions).
     *
     * @OA\Get(
     *     path="/organizations",
     *     summary="List organizations",
     *     description="Get all organizations accessible to the authenticated user. Includes hierarchical relationships and license information.",
     *     operationId="listOrganizations",
     *     tags={"Organizations"},
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         ref="#/components/parameters/OrganizationIdQuery",
     *         description="Optional: Filter by specific organization"
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="List of organizations",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(
     *                 property="data",
     *                 type="array",
     *                 @OA\Items(ref="#/components/schemas/Organization")
     *             ),
     *             @OA\Property(
     *                 property="meta",
     *                 type="object",
     *                 @OA\Property(property="total", type="integer", example=25),
     *                 @OA\Property(property="per_page", type="integer", example=20),
     *                 @OA\Property(property="current_page", type="integer", example=1)
     *             )
     *         ),
     *         @OA\Header(
     *             header="X-RateLimit-Limit",
     *             description="Total requests allowed per minute",
     *             @OA\Schema(type="integer", example=500)
     *         ),
     *         @OA\Header(
     *             header="X-RateLimit-Remaining",
     *             description="Remaining requests in current window",
     *             @OA\Schema(type="integer", example=487)
     *         )
     *     ),
     *     @OA\Response(
     *         response=401,
     *         description="Unauthenticated - Invalid or missing token",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="Unauthenticated.")
     *         )
     *     ),
     *     @OA\Response(
     *         response=429,
     *         ref="#/components/responses/RateLimitExceeded"
     *     )
     * )
     */
    public function index(Request $request): JsonResponse
    {
        $organizations = $request->user()
            ->organizations()
            ->with(['parent', 'children', 'license'])
            ->paginate(20);

        return response()->json($organizations);
    }

    /**
     * Get a specific organization by ID
     *
     * @OA\Get(
     *     path="/organizations/{organization}",
     *     summary="Get organization",
     *     description="Retrieve detailed information about a specific organization, including hierarchical relationships, license details, and user membership.",
     *     operationId="getOrganization",
     *     tags={"Organizations"},
     *     security={{"bearerAuth": {}}},
     *     @OA\Parameter(
     *         ref="#/components/parameters/OrganizationIdPath"
     *     ),
     *     @OA\Parameter(
     *         name="include",
     *         in="query",
     *         description="Include related resources (comma-separated: parent,children,license,users)",
     *         @OA\Schema(type="string", example="parent,children,license")
     *     ),
     *     @OA\Response(
     *         response=200,
     *         description="Organization details",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(
     *                 property="data",
     *                 ref="#/components/schemas/Organization"
     *             )
     *         ),
     *         @OA\Header(
     *             header="X-RateLimit-Limit",
     *             @OA\Schema(type="integer", example=500)
     *         ),
     *         @OA\Header(
     *             header="X-RateLimit-Remaining",
     *             @OA\Schema(type="integer", example=486)
     *         )
     *     ),
     *     @OA\Response(
     *         response=403,
     *         ref="#/components/responses/OrganizationAccessDenied"
     *     ),
     *     @OA\Response(
     *         response=404,
     *         description="Organization not found",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="Organization not found.")
     *         )
     *     ),
     *     @OA\Response(
     *         response=429,
     *         ref="#/components/responses/RateLimitExceeded"
     *     )
     * )
     */
    public function show(Organization $organization): JsonResponse
    {
        $this->authorize('view', $organization);

        $includes = request()->input('include', '');
        $relations = array_filter(explode(',', $includes));

        $organization->load($relations);

        return response()->json(['data' => $organization]);
    }

    /**
     * Create a new organization
     *
     * @OA\Post(
     *     path="/organizations",
     *     summary="Create organization",
     *     description="Create a new organization. Requires appropriate permissions. Newly created organizations inherit license from parent if hierarchical.",
     *     operationId="createOrganization",
     *     tags={"Organizations"},
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"name", "slug"},
     *             @OA\Property(property="name", type="string", example="Acme Development Team"),
     *             @OA\Property(property="slug", type="string", example="acme-dev"),
     *             @OA\Property(property="parent_organization_id", type="integer", nullable=true, example=42),
     *             @OA\Property(property="type", type="string", enum={"top_branch", "master_branch", "sub_user", "end_user"}, example="sub_user"),
     *             @OA\Property(
     *                 property="metadata",
     *                 type="object",
     *                 nullable=true,
     *                 example={"department": "engineering", "cost_center": "R&D"}
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=201,
     *         description="Organization created successfully",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="data", ref="#/components/schemas/Organization"),
     *             @OA\Property(property="message", type="string", example="Organization created successfully")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Validation error",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="Validation failed"),
     *             @OA\Property(
     *                 property="errors",
     *                 type="object",
     *                 @OA\Property(property="slug", type="array", @OA\Items(type="string", example="Slug already exists"))
     *             )
     *         )
     *     ),
     *     @OA\Response(
     *         response=403,
     *         description="Insufficient permissions to create organization",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="You do not have permission to create organizations")
     *         )
     *     ),
     *     @OA\Response(
     *         response=429,
     *         ref="#/components/responses/RateLimitExceeded"
     *     )
     * )
     */
    public function store(Request $request): JsonResponse
    {
        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'slug' => 'required|string|unique:organizations,slug',
            'parent_organization_id' => 'nullable|exists:organizations,id',
            'type' => 'required|in:top_branch,master_branch,sub_user,end_user',
            'metadata' => 'nullable|array',
        ]);

        $organization = Organization::create($validated);

        return response()->json([
            'data' => $organization,
            'message' => 'Organization created successfully',
        ], 201);
    }
}
```

**File:** `app/Http/Controllers/Api/V1/AuthenticationController.php`

```php
<?php

namespace App\Http\Controllers\Api\V1;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use OpenApi\Annotations as OA;

/**
 * @OA\Tag(
 *     name="Authentication",
 *     description="Token generation and organization context management"
 * )
 */
class AuthenticationController extends Controller
{
    /**
     * Generate an API token with organization-specific abilities
     *
     * @OA\Post(
     *     path="/auth/tokens",
     *     summary="Generate API token",
     *     description="Create a new API token with organization-scoped abilities. Tokens are bound to specific organizations and include permission-based abilities for fine-grained access control.",
     *     operationId="generateToken",
     *     tags={"Authentication"},
     *     security={{"bearerAuth": {}}},
     *     @OA\RequestBody(
     *         required=true,
     *         @OA\JsonContent(
     *             required={"organization_id", "token_name"},
     *             @OA\Property(property="organization_id", type="integer", example=42, description="Organization to scope the token to"),
     *             @OA\Property(property="token_name", type="string", example="CI/CD Pipeline Token"),
     *             @OA\Property(
     *                 property="abilities",
     *                 type="array",
     *                 description="Token abilities using pattern: resource:organization_id:action",
     *                 @OA\Items(type="string"),
     *                 example={"organizations:42:view", "servers:42:*", "applications:42:deploy"}
     *             ),
     *             @OA\Property(property="expires_at", type="string", format="date-time", nullable=true, example="2025-12-31T23:59:59Z")
     *         )
     *     ),
     *     @OA\Response(
     *         response=201,
     *         description="Token created successfully",
     *         @OA\JsonContent(
     *             type="object",
     *             @OA\Property(property="token", type="string", example="42|vQZxP8K9j2mN1rL4sD6fG8hJ0kM3nP5qR7tV9wX2yA4cE6gI8oU0"),
     *             @OA\Property(
     *                 property="abilities",
     *                 type="array",
     *                 @OA\Items(type="string"),
     *                 example={"organizations:42:view", "servers:42:*", "applications:42:deploy"}
     *             ),
     *             @OA\Property(property="organization_id", type="integer", example=42),
     *             @OA\Property(property="organization_name", type="string", example="Acme Corporation"),
     *             @OA\Property(property="expires_at", type="string", format="date-time", example="2025-12-31T23:59:59Z"),
     *             @OA\Property(property="created_at", type="string", format="date-time", example="2024-10-05T14:30:00Z")
     *         )
     *     ),
     *     @OA\Response(
     *         response=400,
     *         description="Validation error or invalid organization",
     *         @OA\JsonContent(
     *             @OA\Property(property="message", type="string", example="Invalid organization or insufficient permissions")
     *         )
     *     ),
     *     @OA\Response(
     *         response=429,
     *         ref="#/components/responses/RateLimitExceeded"
     *     )
     * )
     */
    public function generateToken(Request $request): JsonResponse
    {
        // Implementation here
    }
}
```

### Configuration File Enhancement

**File:** `config/l5-swagger.php`

```php
<?php

return [
    'default' => 'default',
    'documentations' => [
        'default' => [
            'api' => [
                'title' => 'Coolify Enterprise API',
            ],
            'routes' => [
                'api' => 'api/documentation',
            ],
            'paths' => [
                'use_absolute_path' => env('L5_SWAGGER_USE_ABSOLUTE_PATH', true),
                'docs_json' => 'api-docs.json',
                'docs_yaml' => 'api-docs.yaml',
                'format_to_use_for_docs' => env('L5_FORMAT_TO_USE_FOR_DOCS', 'json'),
                'annotations' => [
                    base_path('app/Http/Controllers/Api'),
                ],
            ],
        ],
    ],
    'defaults' => [
        'routes' => [
            'docs' => 'docs',
            'oauth2_callback' => 'api/oauth2-callback',
            'middleware' => [
                'api' => ['throttle:60,1'],
                'asset' => [],
                'docs' => [],
                'oauth2_callback' => [],
            ],
            'group_options' => [],
        ],
        'paths' => [
            'docs' => storage_path('api-docs'),
            'views' => base_path('resources/views/vendor/l5-swagger'),
            'base' => env('L5_SWAGGER_BASE_PATH', null),
            'swagger_ui_assets_path' => env('L5_SWAGGER_UI_ASSETS_PATH', 'vendor/swagger-api/swagger-ui/dist/'),
            'excludes' => [],
        ],
        'scanOptions' => [
            'analyser' => null,
            'analysis' => null,
            'processors' => [],
            'pattern' => null,
            'exclude' => [],
        ],
        'securityDefinitions' => [
            'securitySchemes' => [
                'bearerAuth' => [
                    'type' => 'http',
                    'scheme' => 'bearer',
                    'bearerFormat' => 'Sanctum Token',
                    'description' => 'Laravel Sanctum token with organization scoping',
                ],
            ],
            'security' => [
                ['bearerAuth' => []],
            ],
        ],
        'generate_always' => env('L5_SWAGGER_GENERATE_ALWAYS', false),
        'generate_yaml_copy' => env('L5_SWAGGER_GENERATE_YAML_COPY', false),
        'proxy' => false,
        'additional_config_url' => null,
        'operations_sort' => env('L5_SWAGGER_OPERATIONS_SORT', null),
        'validator_url' => null,
        'ui' => [
            'display' => [
                'dark_mode' => env('L5_SWAGGER_UI_DARK_MODE', false),
                'doc_expansion' => env('L5_SWAGGER_UI_DOC_EXPANSION', 'none'),
                'filter' => env('L5_SWAGGER_UI_FILTERS', true),
            ],
            'authorization' => [
                'persist_authorization' => env('L5_SWAGGER_UI_PERSIST_AUTHORIZATION', false),
            ],
        ],
        'constants' => [
            'L5_SWAGGER_CONST_HOST' => env('L5_SWAGGER_CONST_HOST', 'https://api.coolify.io'),
        ],
    ],
];
```

## Implementation Approach

### Step 1: Install L5-Swagger Package
```bash
composer require darkaonline/l5-swagger
php artisan vendor:publish --provider="L5Swagger\L5SwaggerServiceProvider"
```

### Step 2: Configure OpenAPI Base Structure
1. Update `config/l5-swagger.php` with Coolify Enterprise details
2. Set API base URL, version, and contact information
3. Configure security schemes for Sanctum tokens
4. Define global tags for endpoint organization

### Step 3: Add Schema Definitions
1. Define Organization schema with all properties and relationships
2. Define EnterpriseLicense schema with tier and feature information
3. Define error response schemas (RateLimitError, OrganizationContextError, etc.)
4. Define common parameter schemas (OrganizationIdHeader, OrganizationIdQuery, etc.)

### Step 4: Annotate Organization Endpoints
1. Add OpenAPI annotations to OrganizationController methods
2. Document request parameters, body schemas, and response formats
3. Include organization scoping examples in descriptions
4. Add rate limiting response documentation

### Step 5: Annotate Authentication Endpoints
1. Document token generation with organization scoping
2. Include ability pattern examples (resource:org_id:action)
3. Show multi-organization token examples
4. Document token expiration and renewal

### Step 6: Annotate Infrastructure Endpoints
1. Document Terraform provisioning endpoints (Task 56)
2. Include cloud provider credential examples
3. Show organization-scoped infrastructure requests
4. Document deployment status and output retrieval

### Step 7: Annotate Monitoring Endpoints
1. Document resource metrics endpoints
2. Include capacity planning examples
3. Show organization usage aggregation
4. Document real-time WebSocket event subscriptions

### Step 8: Add Common Response Examples
1. Create reusable response examples for common scenarios
2. Include rate limiting header examples
3. Show organization hierarchy in response examples
4. Document error responses for all failure modes

### Step 9: Generate OpenAPI Specification
```bash
php artisan l5-swagger:generate
```

### Step 10: Test with Swagger UI
1. Access `/api/documentation` endpoint
2. Test authentication with real tokens
3. Execute example requests from Swagger UI
4. Verify organization scoping works correctly
5. Validate rate limiting headers appear

## Test Strategy

### Documentation Validation Tests

**File:** `tests/Feature/Api/OpenApiSpecificationTest.php`

```php
<?php

use Illuminate\Support\Facades\File;

it('generates valid OpenAPI specification', function () {
    $this->artisan('l5-swagger:generate')
        ->assertSuccessful();

    $specPath = storage_path('api-docs/api-docs.json');

    expect(File::exists($specPath))->toBeTrue();

    $spec = json_decode(File::get($specPath), true);

    expect($spec)->toHaveKeys(['openapi', 'info', 'paths', 'components']);
    expect($spec['openapi'])->toBe('3.0.0');
});

it('includes organization scoping in schema definitions', function () {
    $specPath = storage_path('api-docs/api-docs.json');
    $spec = json_decode(File::get($specPath), true);

    expect($spec['components']['schemas'])->toHaveKey('Organization');
    expect($spec['components']['schemas']['Organization']['properties'])
        ->toHaveKeys(['id', 'name', 'slug', 'parent_organization_id', 'type']);
});

it('documents rate limiting responses', function () {
    $specPath = storage_path('api-docs/api-docs.json');
    $spec = json_decode(File::get($specPath), true);

    expect($spec['components']['responses'])->toHaveKey('RateLimitExceeded');

    $rateLimitResponse = $spec['components']['responses']['RateLimitExceeded'];

    expect($rateLimitResponse['headers'])->toHaveKeys([
        'X-RateLimit-Limit',
        'X-RateLimit-Remaining',
        'X-RateLimit-Reset',
    ]);
});

it('includes organization context parameters', function () {
    $specPath = storage_path('api-docs/api-docs.json');
    $spec = json_decode(File::get($specPath), true);

    expect($spec['components']['parameters'])->toHaveKeys([
        'OrganizationIdHeader',
        'OrganizationIdQuery',
        'OrganizationIdPath',
    ]);
});

it('documents authentication with organization scoping', function () {
    $specPath = storage_path('api-docs/api-docs.json');
    $spec = json_decode(File::get($specPath), true);

    expect($spec['components']['securitySchemes'])->toHaveKey('bearerAuth');

    $bearerAuth = $spec['components']['securitySchemes']['bearerAuth'];

    expect($bearerAuth['description'])->toContain('organization');
});
```

### API Documentation Endpoint Tests

**File:** `tests/Feature/Api/SwaggerUITest.php`

```php
<?php

it('serves OpenAPI documentation at /api/documentation', function () {
    $response = $this->get('/api/documentation');

    $response->assertOk();
    $response->assertSee('Coolify Enterprise API');
    $response->assertSee('swagger-ui');
});

it('serves OpenAPI JSON specification', function () {
    $response = $this->get('/docs/api-docs.json');

    $response->assertOk();
    $response->assertHeader('Content-Type', 'application/json');

    $spec = $response->json();

    expect($spec)->toHaveKey('openapi');
    expect($spec['info']['title'])->toBe('Coolify Enterprise API');
});

it('includes organization endpoints in documentation', function () {
    $response = $this->get('/docs/api-docs.json');
    $spec = $response->json();

    expect($spec['paths'])->toHaveKey('/organizations');
    expect($spec['paths'])->toHaveKey('/organizations/{organization}');
});
```

### Interactive Example Tests

**File:** `tests/Feature/Api/OpenApiExampleExecutionTest.php`

```php
<?php

use App\Models\User;
use App\Models\Organization;
use Laravel\Sanctum\Sanctum;

it('executes organization list example from OpenAPI spec', function () {
    $user = User::factory()->create();
    $organization = Organization::factory()->create();
    $organization->users()->attach($user, ['role' => 'admin']);

    Sanctum::actingAs($user, ['organizations:*:view']);

    $response = $this->getJson('/api/v1/organizations');

    $response->assertOk();
    $response->assertJsonStructure([
        'data' => [
            '*' => ['id', 'name', 'slug', 'type', 'created_at'],
        ],
        'meta' => ['total', 'per_page', 'current_page'],
    ]);
});

it('executes token generation example from OpenAPI spec', function () {
    $user = User::factory()->create();
    $organization = Organization::factory()->create();
    $organization->users()->attach($user, ['role' => 'admin']);

    Sanctum::actingAs($user);

    $response = $this->postJson('/api/v1/auth/tokens', [
        'organization_id' => $organization->id,
        'token_name' => 'Test Token',
        'abilities' => ["organizations:{$organization->id}:view"],
    ]);

    $response->assertCreated();
    $response->assertJsonStructure([
        'token',
        'abilities',
        'organization_id',
        'organization_name',
    ]);
});
```

## Definition of Done

- [ ] L5-Swagger package installed and configured
- [ ] OpenAPI base structure defined (info, servers, tags, security)
- [ ] Organization schema defined with all properties and relationships
- [ ] EnterpriseLicense schema defined with tier and feature information
- [ ] Error response schemas defined (RateLimitError, OrganizationContextError, etc.)
- [ ] Common parameter schemas defined (OrganizationIdHeader, etc.)
- [ ] OrganizationController fully annotated with OpenAPI comments
- [ ] AuthenticationController annotated with token generation examples
- [ ] Infrastructure endpoints annotated (Terraform, capacity, etc.)
- [ ] Monitoring endpoints annotated (metrics, usage, etc.)
- [ ] White-label endpoints annotated (branding, themes, etc.)
- [ ] Rate limiting responses documented with headers
- [ ] Organization scoping examples included in all endpoints
- [ ] Multi-organization token examples documented
- [ ] Hierarchical access examples documented
- [ ] Error responses documented for all failure scenarios
- [ ] Request/response examples provided for all endpoints
- [ ] OpenAPI specification generates without errors
- [ ] Swagger UI accessible at `/api/documentation`
- [ ] Interactive examples execute successfully
- [ ] Documentation validation tests passing
- [ ] API endpoint tests verify OpenAPI compliance
- [ ] Code follows OpenAPI 3.0 specification standards
- [ ] Laravel Pint formatting applied to controller annotations
- [ ] PHPStan level 5 passing
- [ ] Documentation reviewed by technical writer
- [ ] Examples tested by external developer
- [ ] Deployed to staging and production

## Related Tasks

- **Depends on:** Task 56 (API endpoints for organization, infrastructure, monitoring)
- **Depends on:** Task 52 (Sanctum organization context for authentication examples)
- **Depends on:** Task 53 (ApiOrganizationScope middleware for scoping documentation)
- **Depends on:** Task 54 (Rate limiting for response header documentation)
- **Used by:** Task 58 (Swagger UI for interactive API explorer)
- **Integrates with:** Task 59 (ApiKeyManager.vue for token generation examples)
