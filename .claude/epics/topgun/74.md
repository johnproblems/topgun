---
name: Create TerraformTestingTrait with mock provisioning
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:39:26Z
github: https://github.com/johnproblems/topgun/issues/181
depends_on: [14]
parallel: true
conflicts_with: []
---

# Task: Create TerraformTestingTrait with mock provisioning

## Description

Create a comprehensive testing trait that provides helper methods for mocking Terraform operations across all enterprise test suites. This trait is a critical testing infrastructure component that enables fast, deterministic testing of Terraform-dependent features without requiring actual Terraform binary execution or cloud provider API calls.

The `TerraformTestingTrait` abstracts the complexity of mocking Terraform CLI operations, process execution, state file management, and cloud provider responses. It provides a fluent, intuitive API for test authors to simulate infrastructure provisioning scenarios, error conditions, and edge cases with minimal boilerplate code.

**Core Responsibilities:**

1. **Mock Process Execution**: Simulate Terraform CLI commands (`init`, `plan`, `apply`, `destroy`) using Laravel's Process facade
2. **Fake State Files**: Generate realistic Terraform state files with configurable resources, outputs, and metadata
3. **Simulate Deployment Lifecycle**: Create helper methods for full provisioning workflows from pending → applying → completed
4. **Error Scenario Testing**: Provide methods for simulating common failure modes (timeout, authentication, network errors)
5. **Output Parsing**: Generate mock Terraform JSON output for testing output extraction logic
6. **Credential Mocking**: Create factory methods for CloudProviderCredential instances with test data

**Integration Points:**

- **TerraformService Testing**: Primary consumer for unit tests of TerraformService methods
- **TerraformDeploymentJob Testing**: Used in job tests to simulate async provisioning
- **Integration Tests**: Enables full workflow testing without external dependencies
- **Browser Tests**: Allows Dusk tests to simulate provisioning without real infrastructure

**Why This Task Is Critical:**

Testing infrastructure provisioning without mocking is impractical—it requires real cloud accounts, costs money, takes minutes per test, and introduces flakiness from network issues and API rate limits. This trait makes Terraform testing fast (milliseconds), free, deterministic, and reliable. It enables comprehensive test coverage of complex provisioning workflows, error handling, and edge cases that would be impossible to test against real infrastructure. Without this trait, developers cannot confidently refactor or enhance Terraform integration, risking production bugs and infrastructure failures.

## Acceptance Criteria

- [ ] TerraformTestingTrait trait created with comprehensive helper methods
- [ ] `mockTerraformBinary()` method for simulating Terraform CLI availability and version detection
- [ ] `fakeSuccessfulProvisioning()` method for complete happy-path provisioning workflow
- [ ] `fakeFailedProvisioning()` method with configurable error types (authentication, timeout, resource conflict)
- [ ] `generateMockStateFile()` method for creating realistic Terraform state JSON
- [ ] `generateMockOutputs()` method for creating Terraform output JSON
- [ ] `mockTerraformInit()` for simulating initialization phase
- [ ] `mockTerraformPlan()` for simulating plan phase with resource counts
- [ ] `mockTerraformApply()` for simulating apply phase with progress
- [ ] `mockTerraformDestroy()` for simulating infrastructure destruction
- [ ] `createTestDeployment()` factory method for TerraformDeployment instances
- [ ] `createTestCredential()` factory method for CloudProviderCredential instances
- [ ] Support for multiple cloud providers (AWS, DigitalOcean, Hetzner)
- [ ] Documentation with usage examples for each helper method
- [ ] Integration with Laravel Process facade mocking

## Technical Details

### File Paths

**Testing Trait:**
- `/home/topgun/topgun/tests/Traits/TerraformTestingTrait.php` (new)

**Documentation:**
- `/home/topgun/topgun/tests/README.md` (update with trait usage examples)

**Example Test Files:**
- `/home/topgun/topgun/tests/Feature/Enterprise/TerraformProvisioningTest.php` (usage example)
- `/home/topgun/topgun/tests/Unit/Services/TerraformServiceTest.php` (usage example)

### TerraformTestingTrait Implementation

**File:** `tests/Traits/TerraformTestingTrait.php`

```php
<?php

namespace Tests\Traits;

use App\Models\CloudProviderCredential;
use App\Models\TerraformDeployment;
use App\Models\Organization;
use Illuminate\Support\Facades\Process;
use Illuminate\Support\Facades\Storage;

trait TerraformTestingTrait
{
    /**
     * Mock Terraform binary availability and version
     *
     * @param string $version Terraform version to simulate
     * @return void
     */
    protected function mockTerraformBinary(string $version = '1.5.7'): void
    {
        Process::fake([
            'terraform version*' => Process::result(json_encode([
                'terraform_version' => $version,
                'platform' => 'linux_amd64',
                'provider_selections' => [],
                'terraform_outdated' => false,
            ])),
        ]);
    }

    /**
     * Mock a complete successful Terraform provisioning workflow
     *
     * @param array $outputs Terraform outputs to return
     * @param int $resourceCount Number of resources to provision
     * @return void
     */
    protected function fakeSuccessfulProvisioning(array $outputs = [], int $resourceCount = 3): void
    {
        $this->mockTerraformBinary();

        Process::fake([
            // Terraform version check
            'terraform version*' => Process::result(json_encode([
                'terraform_version' => '1.5.7',
            ])),

            // Terraform init
            'terraform init*' => Process::result(
                "Terraform initialized successfully!\n\n" .
                "Terraform has been successfully initialized!\n" .
                "You may now begin working with Terraform."
            ),

            // Terraform plan
            'terraform plan*' => Process::result(
                "Terraform will perform the following actions:\n\n" .
                "Plan: {$resourceCount} to add, 0 to change, 0 to destroy.\n\n" .
                "Changes to Outputs:\n" .
                "  + server_ip = \"1.2.3.4\"\n"
            ),

            // Terraform apply
            'terraform apply*' => Process::result(
                "Apply complete! Resources: {$resourceCount} added, 0 changed, 0 destroyed.\n\n" .
                "Outputs:\n\n" .
                "server_ip = \"1.2.3.4\"\n"
            ),

            // Terraform output (JSON)
            'terraform output*' => Process::result(json_encode($this->generateMockOutputs($outputs))),
        ]);
    }

    /**
     * Mock a failed Terraform provisioning
     *
     * @param string $errorType Type of error: 'authentication', 'timeout', 'resource_conflict', 'validation'
     * @param string $phase Which phase fails: 'init', 'plan', 'apply'
     * @return void
     */
    protected function fakeFailedProvisioning(string $errorType = 'authentication', string $phase = 'apply'): void
    {
        $this->mockTerraformBinary();

        $errorMessages = [
            'authentication' => 'Error: Invalid credentials. Authentication failed with cloud provider.',
            'timeout' => 'Error: Timeout waiting for resource to become ready.',
            'resource_conflict' => 'Error: Resource already exists with the same name.',
            'validation' => 'Error: Invalid configuration. Missing required parameter.',
        ];

        $errorMessage = $errorMessages[$errorType] ?? 'Error: Unknown error occurred.';

        $fakeResponses = [
            'terraform version*' => Process::result(json_encode(['terraform_version' => '1.5.7'])),
            'terraform init*' => $phase === 'init'
                ? Process::result($errorMessage, 1)
                : Process::result('Terraform initialized successfully!'),
            'terraform plan*' => $phase === 'plan'
                ? Process::result($errorMessage, 1)
                : Process::result('Plan: 3 to add, 0 to change, 0 to destroy.'),
            'terraform apply*' => $phase === 'apply'
                ? Process::result($errorMessage, 1)
                : Process::result('Apply complete!'),
        ];

        Process::fake($fakeResponses);
    }

    /**
     * Generate a realistic Terraform state file
     *
     * @param array $resources Resources to include in state
     * @param array $outputs Outputs to include in state
     * @return string JSON-encoded state file
     */
    protected function generateMockStateFile(array $resources = [], array $outputs = []): string
    {
        // Default resources if none provided
        if (empty($resources)) {
            $resources = [
                [
                    'mode' => 'managed',
                    'type' => 'aws_instance',
                    'name' => 'server',
                    'provider' => 'provider["registry.terraform.io/hashicorp/aws"]',
                    'instances' => [
                        [
                            'attributes' => [
                                'id' => 'i-' . bin2hex(random_bytes(8)),
                                'public_ip' => '1.2.3.4',
                                'private_ip' => '10.0.1.100',
                                'instance_type' => 't3.medium',
                                'ami' => 'ami-12345678',
                                'availability_zone' => 'us-east-1a',
                            ],
                        ],
                    ],
                ],
            ];
        }

        // Default outputs if none provided
        if (empty($outputs)) {
            $outputs = [
                'server_ip' => [
                    'value' => '1.2.3.4',
                    'type' => 'string',
                ],
                'instance_id' => [
                    'value' => 'i-' . bin2hex(random_bytes(8)),
                    'type' => 'string',
                ],
            ];
        }

        $stateFile = [
            'version' => 4,
            'terraform_version' => '1.5.7',
            'serial' => 1,
            'lineage' => bin2hex(random_bytes(16)),
            'resources' => $resources,
            'outputs' => $outputs,
        ];

        return json_encode($stateFile, JSON_PRETTY_PRINT);
    }

    /**
     * Generate mock Terraform outputs in the format returned by `terraform output -json`
     *
     * @param array $outputs Key-value pairs of outputs
     * @return array Formatted output structure
     */
    protected function generateMockOutputs(array $outputs = []): array
    {
        // Default outputs if none provided
        if (empty($outputs)) {
            $outputs = [
                'server_ip' => '1.2.3.4',
                'instance_id' => 'i-' . bin2hex(random_bytes(8)),
                'ssh_key_name' => 'coolify-server-key',
            ];
        }

        $formatted = [];

        foreach ($outputs as $key => $value) {
            $formatted[$key] = [
                'value' => $value,
                'type' => is_array($value) ? 'list' : 'string',
                'sensitive' => false,
            ];
        }

        return $formatted;
    }

    /**
     * Mock Terraform init command
     *
     * @param bool $success Whether init should succeed
     * @return void
     */
    protected function mockTerraformInit(bool $success = true): void
    {
        if ($success) {
            Process::fake([
                'terraform init*' => Process::result(
                    "Initializing the backend...\n" .
                    "Initializing provider plugins...\n" .
                    "Terraform has been successfully initialized!\n"
                ),
            ]);
        } else {
            Process::fake([
                'terraform init*' => Process::result(
                    "Error: Failed to install provider\n" .
                    "Could not retrieve provider schema from registry.",
                    1
                ),
            ]);
        }
    }

    /**
     * Mock Terraform plan command
     *
     * @param int $toAdd Number of resources to add
     * @param int $toChange Number of resources to change
     * @param int $toDestroy Number of resources to destroy
     * @return void
     */
    protected function mockTerraformPlan(int $toAdd = 3, int $toChange = 0, int $toDestroy = 0): void
    {
        Process::fake([
            'terraform plan*' => Process::result(
                "Terraform will perform the following actions:\n\n" .
                "Plan: {$toAdd} to add, {$toChange} to change, {$toDestroy} to destroy.\n\n" .
                "Saved the plan to: tfplan"
            ),
        ]);
    }

    /**
     * Mock Terraform apply command
     *
     * @param int $resourceCount Number of resources applied
     * @param bool $success Whether apply should succeed
     * @return void
     */
    protected function mockTerraformApply(int $resourceCount = 3, bool $success = true): void
    {
        if ($success) {
            Process::fake([
                'terraform apply*' => Process::result(
                    "aws_instance.server: Creating...\n" .
                    "aws_instance.server: Creation complete after 30s [id=i-12345]\n\n" .
                    "Apply complete! Resources: {$resourceCount} added, 0 changed, 0 destroyed.\n"
                ),
            ]);
        } else {
            Process::fake([
                'terraform apply*' => Process::result(
                    "Error: Error launching source instance: InvalidKeyPair.NotFound\n" .
                    "The key pair 'coolify-key' does not exist.",
                    1
                ),
            ]);
        }
    }

    /**
     * Mock Terraform destroy command
     *
     * @param int $resourceCount Number of resources to destroy
     * @param bool $success Whether destroy should succeed
     * @return void
     */
    protected function mockTerraformDestroy(int $resourceCount = 3, bool $success = true): void
    {
        if ($success) {
            Process::fake([
                'terraform destroy*' => Process::result(
                    "aws_instance.server: Destroying... [id=i-12345]\n" .
                    "aws_instance.server: Destruction complete after 10s\n\n" .
                    "Destroy complete! Resources: {$resourceCount} destroyed.\n"
                ),
            ]);
        } else {
            Process::fake([
                'terraform destroy*' => Process::result(
                    "Error: error deleting EC2 Instance (i-12345): IncorrectInstanceState\n" .
                    "The instance 'i-12345' is not in a state from which it can be deleted.",
                    1
                ),
            ]);
        }
    }

    /**
     * Create a test TerraformDeployment instance
     *
     * @param array $attributes Custom attributes to override
     * @param Organization|null $organization Organization to associate with
     * @return TerraformDeployment
     */
    protected function createTestDeployment(array $attributes = [], ?Organization $organization = null): TerraformDeployment
    {
        $organization = $organization ?? Organization::factory()->create();

        $credential = CloudProviderCredential::factory()->aws()->create([
            'organization_id' => $organization->id,
        ]);

        $defaultAttributes = [
            'organization_id' => $organization->id,
            'cloud_provider_credential_id' => $credential->id,
            'provider' => 'aws',
            'region' => 'us-east-1',
            'status' => 'pending',
            'infrastructure_config' => [
                'instance_type' => 't3.medium',
                'ami' => 'ami-12345678',
                'name' => 'Test Server',
            ],
        ];

        return TerraformDeployment::factory()->create(array_merge($defaultAttributes, $attributes));
    }

    /**
     * Create a test CloudProviderCredential instance
     *
     * @param string $provider Cloud provider (aws, digitalocean, hetzner)
     * @param array $attributes Custom attributes to override
     * @param Organization|null $organization Organization to associate with
     * @return CloudProviderCredential
     */
    protected function createTestCredential(
        string $provider = 'aws',
        array $attributes = [],
        ?Organization $organization = null
    ): CloudProviderCredential {
        $organization = $organization ?? Organization::factory()->create();

        $credentials = match ($provider) {
            'aws' => [
                'access_key_id' => 'AKIA' . strtoupper(bin2hex(random_bytes(8))),
                'secret_access_key' => bin2hex(random_bytes(20)),
                'region' => 'us-east-1',
            ],
            'digitalocean' => [
                'api_token' => bin2hex(random_bytes(32)),
            ],
            'hetzner' => [
                'api_token' => bin2hex(random_bytes(32)),
            ],
            default => [],
        };

        $defaultAttributes = [
            'organization_id' => $organization->id,
            'provider' => $provider,
            'name' => ucfirst($provider) . ' Test Credentials',
            'credentials' => $credentials,
        ];

        return CloudProviderCredential::factory()->create(array_merge($defaultAttributes, $attributes));
    }

    /**
     * Setup storage fake for Terraform workspace files
     *
     * @return void
     */
    protected function setupTerraformStorage(): void
    {
        Storage::fake('local');

        // Create necessary directories
        Storage::disk('local')->makeDirectory('terraform/workspaces');
        Storage::disk('local')->makeDirectory('terraform/templates');
        Storage::disk('local')->makeDirectory('terraform/states');
    }

    /**
     * Mock a complete Terraform template directory for a provider
     *
     * @param string $provider Provider name (aws, digitalocean, hetzner)
     * @return void
     */
    protected function mockTerraformTemplates(string $provider = 'aws'): void
    {
        $this->setupTerraformStorage();

        $templateContent = match ($provider) {
            'aws' => $this->getAwsTemplate(),
            'digitalocean' => $this->getDigitalOceanTemplate(),
            'hetzner' => $this->getHetznerTemplate(),
            default => '',
        };

        Storage::disk('local')->put(
            "terraform/templates/{$provider}/main.tf",
            $templateContent
        );

        Storage::disk('local')->put(
            "terraform/templates/{$provider}/variables.tf",
            $this->getVariablesTemplate()
        );

        Storage::disk('local')->put(
            "terraform/templates/{$provider}/outputs.tf",
            $this->getOutputsTemplate()
        );
    }

    /**
     * Get AWS Terraform template content
     *
     * @return string
     */
    private function getAwsTemplate(): string
    {
        return <<<'HCL'
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region     = var.aws_region
  access_key = var.aws_access_key_id
  secret_key = var.aws_secret_access_key
}

resource "aws_instance" "server" {
  ami           = var.ami
  instance_type = var.instance_type

  tags = {
    Name = var.server_name
  }
}
HCL;
    }

    /**
     * Get DigitalOcean Terraform template content
     *
     * @return string
     */
    private function getDigitalOceanTemplate(): string
    {
        return <<<'HCL'
terraform {
  required_providers {
    digitalocean = {
      source  = "digitalocean/digitalocean"
      version = "~> 2.0"
    }
  }
}

provider "digitalocean" {
  token = var.do_token
}

resource "digitalocean_droplet" "server" {
  image  = var.image
  name   = var.server_name
  region = var.region
  size   = var.size
}
HCL;
    }

    /**
     * Get Hetzner Terraform template content
     *
     * @return string
     */
    private function getHetznerTemplate(): string
    {
        return <<<'HCL'
terraform {
  required_providers {
    hcloud = {
      source  = "hetznercloud/hcloud"
      version = "~> 1.0"
    }
  }
}

provider "hcloud" {
  token = var.hcloud_token
}

resource "hcloud_server" "server" {
  name        = var.server_name
  server_type = var.server_type
  image       = var.image
  location    = var.location
}
HCL;
    }

    /**
     * Get variables template
     *
     * @return string
     */
    private function getVariablesTemplate(): string
    {
        return <<<'HCL'
variable "server_name" {
  description = "Server name"
  type        = string
}

variable "instance_type" {
  description = "Instance type"
  type        = string
  default     = "t3.medium"
}
HCL;
    }

    /**
     * Get outputs template
     *
     * @return string
     */
    private function getOutputsTemplate(): string
    {
        return <<<'HCL'
output "server_ip" {
  description = "Server public IP address"
  value       = aws_instance.server.public_ip
}

output "instance_id" {
  description = "Instance ID"
  value       = aws_instance.server.id
}
HCL;
    }

    /**
     * Simulate a complete provisioning lifecycle
     *
     * @param TerraformDeployment $deployment Deployment to update
     * @param array $outputs Final outputs
     * @return TerraformDeployment
     */
    protected function simulateProvisioningLifecycle(
        TerraformDeployment $deployment,
        array $outputs = []
    ): TerraformDeployment {
        // Initialize
        $deployment->update(['status' => 'initializing', 'started_at' => now()]);
        sleep(0.1); // Simulate processing time

        // Planning
        $deployment->update([
            'status' => 'planning',
            'plan_output' => 'Plan: 3 to add, 0 to change, 0 to destroy.',
        ]);
        sleep(0.1);

        // Applying
        $deployment->update(['status' => 'applying']);
        sleep(0.1);

        // Complete
        $stateFile = $this->generateMockStateFile([], $outputs);

        $deployment->update([
            'status' => 'completed',
            'outputs' => $this->extractOutputValues($outputs),
            'state_file' => encrypt($stateFile),
            'completed_at' => now(),
        ]);

        return $deployment->fresh();
    }

    /**
     * Extract output values from Terraform output format
     *
     * @param array $outputs Terraform outputs
     * @return array Simple key-value pairs
     */
    private function extractOutputValues(array $outputs): array
    {
        $values = [];

        foreach ($outputs as $key => $output) {
            $values[$key] = is_array($output) && isset($output['value'])
                ? $output['value']
                : $output;
        }

        return $values;
    }

    /**
     * Assert deployment has expected status
     *
     * @param TerraformDeployment $deployment
     * @param string $expectedStatus
     * @return void
     */
    protected function assertDeploymentStatus(TerraformDeployment $deployment, string $expectedStatus): void
    {
        $deployment->refresh();

        expect($deployment->status)->toBe($expectedStatus);
    }

    /**
     * Assert deployment has outputs
     *
     * @param TerraformDeployment $deployment
     * @param array $expectedOutputs Expected output keys
     * @return void
     */
    protected function assertDeploymentHasOutputs(TerraformDeployment $deployment, array $expectedOutputs): void
    {
        $deployment->refresh();

        expect($deployment->outputs)
            ->toBeArray()
            ->toHaveKeys($expectedOutputs);
    }
}
```

### Usage Examples

**File:** `tests/Feature/Enterprise/TerraformProvisioningTest.php` (example)

```php
<?php

use App\Services\Enterprise\TerraformService;
use Tests\Traits\TerraformTestingTrait;

uses(TerraformTestingTrait::class);

it('provisions infrastructure successfully', function () {
    // Setup: Mock successful provisioning
    $this->fakeSuccessfulProvisioning([
        'server_ip' => '1.2.3.4',
        'instance_id' => 'i-12345',
    ]);

    $this->mockTerraformTemplates('aws');

    // Create test credential
    $credential = $this->createTestCredential('aws');

    $config = [
        'name' => 'Production Server',
        'instance_type' => 't3.medium',
        'ami' => 'ami-12345678',
        'region' => 'us-east-1',
    ];

    // Execute
    $service = app(TerraformService::class);
    $deployment = $service->provisionInfrastructure($credential, $config);

    // Assert
    $this->assertDeploymentStatus($deployment, 'completed');
    $this->assertDeploymentHasOutputs($deployment, ['server_ip', 'instance_id']);

    expect($deployment->outputs['server_ip'])->toBe('1.2.3.4');
});

it('handles provisioning failures gracefully', function () {
    // Mock authentication failure during apply
    $this->fakeFailedProvisioning('authentication', 'apply');
    $this->mockTerraformTemplates('aws');

    $credential = $this->createTestCredential('aws');
    $config = ['name' => 'Test Server', 'instance_type' => 't3.small'];

    $service = app(TerraformService::class);

    expect(fn () => $service->provisionInfrastructure($credential, $config))
        ->toThrow(\App\Exceptions\TerraformException::class);
});

it('simulates complete deployment lifecycle', function () {
    $deployment = $this->createTestDeployment([
        'status' => 'pending',
    ]);

    $updatedDeployment = $this->simulateProvisioningLifecycle($deployment, [
        'server_ip' => '5.6.7.8',
    ]);

    expect($updatedDeployment->status)->toBe('completed')
        ->and($updatedDeployment->outputs)->toHaveKey('server_ip');
});
```

**File:** `tests/Unit/Services/TerraformServiceTest.php` (example)

```php
<?php

use App\Services\Enterprise\TerraformService;
use Tests\Traits\TerraformTestingTrait;

uses(TerraformTestingTrait::class);

beforeEach(function () {
    $this->setupTerraformStorage();
    $this->service = app(TerraformService::class);
});

it('validates terraform templates successfully', function () {
    $this->mockTerraformBinary();

    Process::fake([
        'terraform validate*' => Process::result(json_encode([
            'valid' => true,
            'diagnostics' => [],
        ])),
    ]);

    $this->mockTerraformTemplates('aws');
    $templatePath = storage_path('app/terraform/templates/aws/main.tf');

    $result = $this->service->validateTemplate($templatePath);

    expect($result)
        ->toHaveKey('valid')
        ->and($result['valid'])->toBeTrue();
});

it('generates state file correctly', function () {
    $stateFile = $this->generateMockStateFile();
    $decoded = json_decode($stateFile, true);

    expect($decoded)
        ->toHaveKeys(['version', 'terraform_version', 'resources', 'outputs'])
        ->and($decoded['version'])->toBe(4);
});

it('extracts outputs from state correctly', function () {
    $deployment = $this->createTestDeployment([
        'state_file' => encrypt($this->generateMockStateFile()),
    ]);

    $outputs = $this->service->extractOutputs($deployment);

    expect($outputs)
        ->toBeArray()
        ->toHaveKeys(['server_ip', 'instance_id']);
});
```

## Implementation Approach

### Step 1: Create Trait File
1. Create `tests/Traits/TerraformTestingTrait.php`
2. Define namespace and basic structure
3. Add PHPDoc documentation for all methods

### Step 2: Implement Process Mocking Methods
1. Add `mockTerraformBinary()` for version detection
2. Add `mockTerraformInit()` for initialization
3. Add `mockTerraformPlan()` for planning phase
4. Add `mockTerraformApply()` for apply phase
5. Add `mockTerraformDestroy()` for destruction

### Step 3: Implement Workflow Helper Methods
1. Add `fakeSuccessfulProvisioning()` for happy path
2. Add `fakeFailedProvisioning()` with error type parameter
3. Add `simulateProvisioningLifecycle()` for full workflow

### Step 4: Implement State File Generation
1. Add `generateMockStateFile()` with realistic structure
2. Add `generateMockOutputs()` for output JSON
3. Include support for multiple resource types (EC2, Droplet, Server)

### Step 5: Implement Factory Methods
1. Add `createTestDeployment()` for TerraformDeployment instances
2. Add `createTestCredential()` for CloudProviderCredential instances
3. Support multiple providers (AWS, DigitalOcean, Hetzner)

### Step 6: Add Template Mocking
1. Add `setupTerraformStorage()` for storage fake
2. Add `mockTerraformTemplates()` for template files
3. Create template content for each provider (AWS, DO, Hetzner)

### Step 7: Add Assertion Helpers
1. Add `assertDeploymentStatus()` for status checking
2. Add `assertDeploymentHasOutputs()` for output validation
3. Add convenience methods for common assertions

### Step 8: Write Tests for the Trait
1. Create `tests/Unit/Traits/TerraformTestingTraitTest.php`
2. Test each helper method independently
3. Verify Process facade mocking works correctly
4. Test factory methods create valid instances

### Step 9: Documentation
1. Add usage examples to `tests/README.md`
2. Document each method with detailed PHPDoc blocks
3. Create code snippets for common use cases

### Step 10: Integration
1. Update existing Terraform tests to use trait
2. Verify all TerraformService tests use trait methods
3. Ensure no tests execute real Terraform commands

## Test Strategy

### Unit Tests for the Trait Itself

**File:** `tests/Unit/Traits/TerraformTestingTraitTest.php`

```php
<?php

use Tests\Traits\TerraformTestingTrait;
use Illuminate\Support\Facades\Process;

uses(TerraformTestingTrait::class);

it('mocks terraform binary version correctly', function () {
    $this->mockTerraformBinary('1.6.0');

    Process::fake([
        'terraform version*' => Process::result(json_encode(['terraform_version' => '1.6.0'])),
    ]);

    $process = Process::run('terraform version -json');

    expect($process->successful())->toBeTrue();

    $output = json_decode($process->output(), true);
    expect($output['terraform_version'])->toBe('1.6.0');
});

it('generates valid state file structure', function () {
    $stateFile = $this->generateMockStateFile();
    $decoded = json_decode($stateFile, true);

    expect($decoded)
        ->toHaveKeys(['version', 'terraform_version', 'resources', 'outputs'])
        ->and($decoded['version'])->toBe(4)
        ->and($decoded['resources'])->toBeArray()
        ->and($decoded['outputs'])->toBeArray();
});

it('generates mock outputs in correct format', function () {
    $outputs = $this->generateMockOutputs([
        'server_ip' => '1.2.3.4',
        'instance_id' => 'i-abc123',
    ]);

    expect($outputs)
        ->toHaveKey('server_ip')
        ->toHaveKey('instance_id');

    expect($outputs['server_ip'])
        ->toHaveKeys(['value', 'type', 'sensitive'])
        ->and($outputs['server_ip']['value'])->toBe('1.2.3.4');
});

it('creates test deployment with correct associations', function () {
    $organization = Organization::factory()->create();
    $deployment = $this->createTestDeployment([], $organization);

    expect($deployment)
        ->toBeInstanceOf(TerraformDeployment::class)
        ->organization_id->toBe($organization->id)
        ->cloudProviderCredential->not->toBeNull();
});

it('creates test credential for each provider', function () {
    $awsCredential = $this->createTestCredential('aws');
    $doCredential = $this->createTestCredential('digitalocean');
    $hetznerCredential = $this->createTestCredential('hetzner');

    expect($awsCredential->provider)->toBe('aws')
        ->and($awsCredential->credentials)->toHaveKeys(['access_key_id', 'secret_access_key', 'region']);

    expect($doCredential->provider)->toBe('digitalocean')
        ->and($doCredential->credentials)->toHaveKey('api_token');

    expect($hetznerCredential->provider)->toBe('hetzner')
        ->and($hetznerCredential->credentials)->toHaveKey('api_token');
});

it('fakes successful provisioning workflow', function () {
    $this->fakeSuccessfulProvisioning(['server_ip' => '10.0.0.1']);

    // Verify init succeeds
    $initProcess = Process::run('terraform init');
    expect($initProcess->successful())->toBeTrue();

    // Verify plan succeeds
    $planProcess = Process::run('terraform plan');
    expect($planProcess->successful())->toBeTrue();
    expect($planProcess->output())->toContain('Plan: 3 to add');

    // Verify apply succeeds
    $applyProcess = Process::run('terraform apply');
    expect($applyProcess->successful())->toBeTrue();
});

it('fakes failed provisioning with different error types', function () {
    $this->fakeFailedProvisioning('authentication', 'apply');

    $applyProcess = Process::run('terraform apply');

    expect($applyProcess->failed())->toBeTrue();
    expect($applyProcess->output())->toContain('Invalid credentials');
});

it('simulates complete provisioning lifecycle', function () {
    $deployment = $this->createTestDeployment(['status' => 'pending']);

    $updated = $this->simulateProvisioningLifecycle($deployment, [
        'server_ip' => '192.168.1.100',
    ]);

    expect($updated->status)->toBe('completed')
        ->and($updated->started_at)->not->toBeNull()
        ->and($updated->completed_at)->not->toBeNull()
        ->and($updated->outputs)->toHaveKey('server_ip');
});

it('mocks terraform templates for providers', function () {
    $this->mockTerraformTemplates('aws');

    Storage::disk('local')->assertExists('terraform/templates/aws/main.tf');
    Storage::disk('local')->assertExists('terraform/templates/aws/variables.tf');
    Storage::disk('local')->assertExists('terraform/templates/aws/outputs.tf');

    $mainContent = Storage::disk('local')->get('terraform/templates/aws/main.tf');
    expect($mainContent)->toContain('aws_instance');
});
```

### Integration Test Examples

**File:** `tests/Feature/TerraformServiceIntegrationTest.php`

```php
<?php

use App\Services\Enterprise\TerraformService;
use Tests\Traits\TerraformTestingTrait;

uses(TerraformTestingTrait::class);

it('integrates with TerraformService for full workflow', function () {
    $this->fakeSuccessfulProvisioning(['server_ip' => '5.6.7.8']);
    $this->mockTerraformTemplates('aws');

    $credential = $this->createTestCredential('aws');
    $service = app(TerraformService::class);

    $deployment = $service->provisionInfrastructure($credential, [
        'name' => 'Integration Test Server',
        'instance_type' => 't3.small',
        'region' => 'us-east-1',
    ]);

    expect($deployment->status)->toBe('completed')
        ->and($deployment->outputs)->toHaveKey('server_ip');
});

it('handles state file encryption and decryption', function () {
    $deployment = $this->createTestDeployment([
        'state_file' => encrypt($this->generateMockStateFile()),
    ]);

    $service = app(TerraformService::class);
    $outputs = $service->extractOutputs($deployment);

    expect($outputs)->toBeArray()->not->toBeEmpty();
});
```

## Definition of Done

- [ ] TerraformTestingTrait created in `tests/Traits/`
- [ ] `mockTerraformBinary()` method implemented
- [ ] `fakeSuccessfulProvisioning()` method implemented
- [ ] `fakeFailedProvisioning()` method with error types implemented
- [ ] `generateMockStateFile()` method implemented
- [ ] `generateMockOutputs()` method implemented
- [ ] `mockTerraformInit/Plan/Apply/Destroy()` methods implemented
- [ ] `createTestDeployment()` factory method implemented
- [ ] `createTestCredential()` factory method with multi-provider support
- [ ] `setupTerraformStorage()` method implemented
- [ ] `mockTerraformTemplates()` method with provider templates
- [ ] `simulateProvisioningLifecycle()` method implemented
- [ ] Assertion helper methods implemented
- [ ] Template content for AWS, DigitalOcean, Hetzner included
- [ ] Unit tests for trait methods written (>95% coverage)
- [ ] Integration test examples created
- [ ] PHPDoc blocks complete for all methods
- [ ] Usage examples documented in tests/README.md
- [ ] Existing TerraformService tests updated to use trait
- [ ] All tests passing (verified no real Terraform execution)
- [ ] Code follows PSR-12 standards
- [ ] Laravel Pint formatting applied
- [ ] PHPStan level 5 passing
- [ ] Code reviewed and approved
- [ ] No test executes real Terraform commands or cloud API calls

## Related Tasks

- **Depends on:** Task 14 (TerraformService implementation)
- **Used by:** Task 76 (Unit tests for enterprise services)
- **Used by:** Task 77 (Integration tests for workflows)
- **Used by:** Task 18 (TerraformDeploymentJob tests)
- **Similar patterns:** Task 72 (OrganizationTestingTrait), Task 73 (LicenseTestingTrait)
