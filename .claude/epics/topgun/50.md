---
name: Build SubscriptionManager.vue, PaymentMethodManager.vue, and BillingDashboard.vue
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:39:06Z
github: https://github.com/johnproblems/topgun/issues/158
depends_on: [46]
parallel: true
conflicts_with: []
---

# Task: Build SubscriptionManager.vue, PaymentMethodManager.vue, and BillingDashboard.vue

## Description

Create comprehensive Vue.js 3 components for subscription management, payment method management, and billing visualization as part of the enterprise payment processing system. These components provide organization administrators with complete control over subscription plans, payment methods, billing history, and usage-based cost tracking.

This task delivers the frontend interface for the payment processing infrastructure established in previous tasks. The components integrate with the PaymentService (Task 46), subscription lifecycle management (Task 48), and usage-based billing calculations (Task 49) to create a unified billing experience.

**Three Core Components:**

1. **SubscriptionManager.vue** - Plan selection, subscription upgrades/downgrades, cancellation, and renewal management with visual plan comparison tables and feature matrices.

2. **PaymentMethodManager.vue** - Credit card management, ACH bank account configuration, payment method verification, and default payment method selection with secure PCI-compliant forms.

3. **BillingDashboard.vue** - Real-time usage metrics visualization, invoice history, cost breakdowns, payment transaction logs, and usage forecasting with interactive charts.

**Integration Points:**
- Backend: `app/Http/Controllers/Enterprise/SubscriptionController.php`, `PaymentMethodController.php`, `BillingController.php`
- Services: `PaymentService`, `SubscriptionLifecycleService`, `UsageBillingCalculator`
- Models: `OrganizationSubscription`, `PaymentMethod`, `PaymentTransaction`, `OrganizationResourceUsage`
- Payment Gateways: Stripe.js, PayPal JavaScript SDK for secure payment collection
- Real-time Updates: Laravel Reverb WebSocket channels for live billing updates

**Why This Task is Important:** Professional billing interfaces are critical for enterprise SaaS platforms. Organizations expect transparent pricing, flexible subscription management, and detailed usage visibility. These components provide the user-facing interface for revenue generation, enabling organizations to easily subscribe to plans, manage payment methods, and understand their costs. Poor billing UX leads to churn, support tickets, and revenue loss. Well-designed billing components build trust, reduce support overhead, and maximize lifetime value.

**Key Features:**
- Visual plan comparison with feature matrices and recommended plans
- Secure payment method collection with PCI-compliant tokenization
- Real-time usage metrics with cost forecasting
- Invoice generation and download in PDF format
- Payment retry management for failed transactions
- Subscription pause and resume functionality
- Usage-based overage alerts and notifications
- Multi-currency support with automatic conversion
- Tax calculation integration with Stripe Tax or TaxJar
- Prorated billing calculations for mid-cycle upgrades
- Cancellation flow with retention incentives
- Payment method verification with micro-deposits (ACH)

## Acceptance Criteria

### SubscriptionManager.vue
- [ ] Plan comparison table displays all available plans with features, pricing, and limits
- [ ] Current subscription status clearly displayed with renewal date and next billing amount
- [ ] Upgrade/downgrade flow with prorated billing calculation preview
- [ ] Cancellation flow with confirmation modal and cancellation reason collection
- [ ] Subscription pause/resume functionality with date range selection
- [ ] Recommended plan highlighting based on current usage patterns
- [ ] Feature comparison tooltips explaining each plan feature
- [ ] Subscription history timeline showing all plan changes

### PaymentMethodManager.vue
- [ ] Add payment method with Stripe Elements or PayPal SDK integration
- [ ] Credit card form with real-time validation (Luhn check, expiration, CVV)
- [ ] ACH bank account form with account/routing validation
- [ ] Display all saved payment methods with last 4 digits and expiration
- [ ] Set default payment method with confirmation
- [ ] Delete payment method with confirmation and dependent subscription check
- [ ] Payment method verification flow for ACH micro-deposits
- [ ] PCI compliance with tokenized payment collection (no sensitive data stored)
- [ ] Error handling for invalid cards, expired cards, insufficient funds

### BillingDashboard.vue
- [ ] Current billing period usage displayed with percentage of quota
- [ ] Usage metrics chart with ApexCharts (CPU hours, memory GB-hours, storage GB)
- [ ] Invoice list with date, amount, status, and PDF download
- [ ] Payment transaction log with timestamps, amounts, methods, and statuses
- [ ] Current month estimated cost calculation based on usage
- [ ] Usage forecasting with projected end-of-month cost
- [ ] Cost breakdown by resource type (compute, storage, network, support)
- [ ] Payment retry management for failed transactions
- [ ] Tax and fee breakdown on invoices
- [ ] Multi-currency display with organization's selected currency

### General Requirements
- [ ] All components use Vue 3 Composition API with TypeScript
- [ ] Integration with Inertia.js for form submissions and page navigation
- [ ] Real-time updates via Laravel Reverb WebSocket channels
- [ ] Responsive design working on mobile, tablet, desktop
- [ ] Accessibility compliance (ARIA labels, keyboard navigation, screen reader support)
- [ ] Loading states with skeleton loaders for async operations
- [ ] Error handling with user-friendly error messages
- [ ] Success notifications with toast/banner components
- [ ] Dark mode support following Coolify's design system
- [ ] Comprehensive unit tests with Vitest (>90% coverage)
- [ ] Integration tests with mocked payment gateway responses

## Technical Details

### Component Locations

**Files:**
- `/home/topgun/topgun/resources/js/Components/Enterprise/Billing/SubscriptionManager.vue`
- `/home/topgun/topgun/resources/js/Components/Enterprise/Billing/PaymentMethodManager.vue`
- `/home/topgun/topgun/resources/js/Components/Enterprise/Billing/BillingDashboard.vue`
- `/home/topgun/topgun/resources/js/Components/Enterprise/Billing/PlanComparisonTable.vue` (sub-component)
- `/home/topgun/topgun/resources/js/Components/Enterprise/Billing/PaymentMethodCard.vue` (sub-component)
- `/home/topgun/topgun/resources/js/Components/Enterprise/Billing/UsageChart.vue` (sub-component)
- `/home/topgun/topgun/resources/js/Components/Enterprise/Billing/InvoiceList.vue` (sub-component)

### SubscriptionManager.vue Implementation

**File:** `resources/js/Components/Enterprise/Billing/SubscriptionManager.vue`

```vue
<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { useForm, usePage } from '@inertiajs/vue3'
import PlanComparisonTable from './PlanComparisonTable.vue'
import { Plan, Subscription, Organization } from '@/types/billing'

interface Props {
  organization: Organization
  currentSubscription?: Subscription
  availablePlans: Plan[]
}

const props = defineProps<Props>()
const emit = defineEmits(['subscription-updated', 'subscription-cancelled'])

const showCancelModal = ref(false)
const showUpgradeModal = ref(false)
const selectedPlan = ref<Plan | null>(null)
const cancellationReason = ref('')
const isProcessing = ref(false)

const currentPlan = computed(() => {
  if (!props.currentSubscription) return null
  return props.availablePlans.find(p => p.id === props.currentSubscription.plan_id)
})

const isUpgrade = computed(() => {
  if (!selectedPlan.value || !currentPlan.value) return false
  return selectedPlan.value.price_monthly > currentPlan.value.price_monthly
})

const proratedAmount = computed(() => {
  if (!selectedPlan.value || !props.currentSubscription) return 0

  // Calculate prorated amount for mid-cycle changes
  const daysRemaining = Math.ceil(
    (new Date(props.currentSubscription.current_period_end).getTime() - Date.now())
    / (1000 * 60 * 60 * 24)
  )
  const daysInPeriod = 30 // Assuming monthly billing
  const proratedRatio = daysRemaining / daysInPeriod

  const currentMonthlyPrice = currentPlan.value?.price_monthly || 0
  const newMonthlyPrice = selectedPlan.value.price_monthly
  const priceDifference = newMonthlyPrice - currentMonthlyPrice

  return Math.max(0, priceDifference * proratedRatio)
})

const upgradeForm = useForm({
  plan_id: null as number | null,
  payment_method_id: props.currentSubscription?.payment_method_id,
})

const cancelForm = useForm({
  cancellation_reason: '',
  immediate: false,
})

const resumeForm = useForm({})

// Select plan for upgrade/downgrade
const selectPlan = (plan: Plan) => {
  if (plan.id === props.currentSubscription?.plan_id) {
    return // Already on this plan
  }

  selectedPlan.value = plan
  showUpgradeModal.value = true
}

// Confirm subscription change
const confirmSubscriptionChange = () => {
  if (!selectedPlan.value) return

  isProcessing.value = true
  upgradeForm.plan_id = selectedPlan.value.id

  upgradeForm.post(route('enterprise.subscriptions.change', {
    organization: props.organization.id
  }), {
    onSuccess: (response) => {
      showUpgradeModal.value = false
      emit('subscription-updated', response.subscription)
      isProcessing.value = false
    },
    onError: (errors) => {
      isProcessing.value = false
      console.error('Subscription change failed:', errors)
    },
  })
}

// Cancel subscription
const cancelSubscription = () => {
  isProcessing.value = true
  cancelForm.cancellation_reason = cancellationReason.value

  cancelForm.post(route('enterprise.subscriptions.cancel', {
    organization: props.organization.id
  }), {
    onSuccess: (response) => {
      showCancelModal.value = false
      emit('subscription-cancelled', response.subscription)
      isProcessing.value = false
    },
    onError: (errors) => {
      isProcessing.value = false
      console.error('Cancellation failed:', errors)
    },
  })
}

// Resume cancelled subscription
const resumeSubscription = () => {
  isProcessing.value = true

  resumeForm.post(route('enterprise.subscriptions.resume', {
    organization: props.organization.id
  }), {
    onSuccess: (response) => {
      emit('subscription-updated', response.subscription)
      isProcessing.value = false
    },
    onError: (errors) => {
      isProcessing.value = false
      console.error('Resume failed:', errors)
    },
  })
}

// Format currency
const formatCurrency = (amount: number) => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
  }).format(amount)
}

// Format date
const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  })
}
</script>

<template>
  <div class="subscription-manager">
    <!-- Current Subscription Status -->
    <div v-if="currentSubscription" class="current-subscription-card">
      <div class="flex justify-between items-start">
        <div>
          <h3 class="text-xl font-semibold">{{ currentPlan?.name || 'Unknown Plan' }}</h3>
          <p class="text-gray-600 dark:text-gray-400 mt-1">
            {{ formatCurrency(currentPlan?.price_monthly || 0) }} / month
          </p>
        </div>

        <div class="subscription-status">
          <span
            class="status-badge"
            :class="{
              'status-active': currentSubscription.status === 'active',
              'status-cancelled': currentSubscription.status === 'cancelled',
              'status-paused': currentSubscription.status === 'paused',
            }"
          >
            {{ currentSubscription.status.toUpperCase() }}
          </span>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="info-item">
          <p class="text-sm text-gray-500 dark:text-gray-400">Renewal Date</p>
          <p class="font-medium">{{ formatDate(currentSubscription.current_period_end) }}</p>
        </div>

        <div class="info-item">
          <p class="text-sm text-gray-500 dark:text-gray-400">Next Billing Amount</p>
          <p class="font-medium">{{ formatCurrency(currentPlan?.price_monthly || 0) }}</p>
        </div>

        <div class="info-item">
          <p class="text-sm text-gray-500 dark:text-gray-400">Payment Method</p>
          <p class="font-medium">•••• {{ currentSubscription.payment_method?.last4 || 'N/A' }}</p>
        </div>
      </div>

      <!-- Subscription Actions -->
      <div class="mt-6 flex gap-3">
        <button
          v-if="currentSubscription.status === 'cancelled'"
          @click="resumeSubscription"
          :disabled="isProcessing"
          class="btn btn-primary"
        >
          Resume Subscription
        </button>

        <button
          v-else
          @click="showCancelModal = true"
          :disabled="isProcessing"
          class="btn btn-danger"
        >
          Cancel Subscription
        </button>
      </div>
    </div>

    <!-- No Subscription Prompt -->
    <div v-else class="no-subscription-prompt">
      <svg class="w-16 h-16 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
      </svg>
      <h3 class="mt-4 text-lg font-semibold">No Active Subscription</h3>
      <p class="mt-2 text-gray-600 dark:text-gray-400">
        Select a plan below to get started with {{ organization.name }}
      </p>
    </div>

    <!-- Plan Comparison -->
    <div class="mt-8">
      <h2 class="text-2xl font-bold mb-6">Available Plans</h2>

      <PlanComparisonTable
        :plans="availablePlans"
        :current-plan-id="currentSubscription?.plan_id"
        @select-plan="selectPlan"
      />
    </div>

    <!-- Upgrade/Downgrade Modal -->
    <transition name="modal">
      <div v-if="showUpgradeModal" class="modal-overlay" @click.self="showUpgradeModal = false">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="text-xl font-semibold">
              {{ isUpgrade ? 'Upgrade' : 'Downgrade' }} Subscription
            </h3>
            <button @click="showUpgradeModal = false" class="close-btn">&times;</button>
          </div>

          <div class="modal-body">
            <div class="plan-change-summary">
              <div class="flex justify-between items-center mb-4">
                <div>
                  <p class="text-sm text-gray-500">Current Plan</p>
                  <p class="font-semibold">{{ currentPlan?.name }}</p>
                  <p class="text-sm">{{ formatCurrency(currentPlan?.price_monthly || 0) }}/mo</p>
                </div>

                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                </svg>

                <div>
                  <p class="text-sm text-gray-500">New Plan</p>
                  <p class="font-semibold">{{ selectedPlan?.name }}</p>
                  <p class="text-sm">{{ formatCurrency(selectedPlan?.price_monthly || 0) }}/mo</p>
                </div>
              </div>

              <div class="prorated-amount-card" v-if="currentSubscription && proratedAmount > 0">
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  Prorated charge for remaining billing period:
                </p>
                <p class="text-2xl font-bold mt-1">
                  {{ formatCurrency(proratedAmount) }}
                </p>
                <p class="text-xs text-gray-500 mt-1">
                  This amount will be charged immediately. Your next full billing cycle starts on {{ formatDate(currentSubscription.current_period_end) }}.
                </p>
              </div>

              <div class="feature-comparison mt-6">
                <h4 class="font-semibold mb-3">What's Changing:</h4>
                <ul class="space-y-2">
                  <li v-for="(value, feature) in selectedPlan?.features" :key="feature" class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span>{{ feature }}: {{ value }}</span>
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button @click="showUpgradeModal = false" class="btn btn-secondary" :disabled="isProcessing">
              Cancel
            </button>
            <button @click="confirmSubscriptionChange" class="btn btn-primary" :disabled="isProcessing">
              <span v-if="isProcessing">Processing...</span>
              <span v-else>Confirm {{ isUpgrade ? 'Upgrade' : 'Downgrade' }}</span>
            </button>
          </div>
        </div>
      </div>
    </transition>

    <!-- Cancellation Modal -->
    <transition name="modal">
      <div v-if="showCancelModal" class="modal-overlay" @click.self="showCancelModal = false">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="text-xl font-semibold text-red-600">Cancel Subscription</h3>
            <button @click="showCancelModal = false" class="close-btn">&times;</button>
          </div>

          <div class="modal-body">
            <div class="cancellation-warning">
              <svg class="w-12 h-12 text-yellow-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <p class="mt-4 text-center">
                Are you sure you want to cancel your subscription? You'll lose access to all premium features.
              </p>
            </div>

            <div class="mt-6">
              <label class="block text-sm font-medium mb-2">
                Why are you cancelling? (Optional)
              </label>
              <textarea
                v-model="cancellationReason"
                rows="4"
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500"
                placeholder="Help us improve by sharing your feedback..."
              ></textarea>
            </div>

            <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
              <p class="text-sm text-blue-800 dark:text-blue-200">
                Your subscription will remain active until {{ formatDate(currentSubscription?.current_period_end || '') }}.
                After that, you'll be downgraded to the Free plan.
              </p>
            </div>
          </div>

          <div class="modal-footer">
            <button @click="showCancelModal = false" class="btn btn-secondary" :disabled="isProcessing">
              Keep Subscription
            </button>
            <button @click="cancelSubscription" class="btn btn-danger" :disabled="isProcessing">
              <span v-if="isProcessing">Processing...</span>
              <span v-else>Confirm Cancellation</span>
            </button>
          </div>
        </div>
      </div>
    </transition>
  </div>
</template>

<style scoped>
.subscription-manager {
  @apply max-w-6xl mx-auto p-6;
}

.current-subscription-card {
  @apply bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6;
}

.status-badge {
  @apply px-3 py-1 rounded-full text-sm font-medium;
}

.status-active {
  @apply bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200;
}

.status-cancelled {
  @apply bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200;
}

.status-paused {
  @apply bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200;
}

.no-subscription-prompt {
  @apply text-center py-12 bg-gray-50 dark:bg-gray-800 rounded-lg;
}

.modal-overlay {
  @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4;
}

.modal-content {
  @apply bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto;
}

.modal-header {
  @apply flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700;
}

.modal-body {
  @apply p-6;
}

.modal-footer {
  @apply flex justify-end gap-3 p-6 border-t border-gray-200 dark:border-gray-700;
}

.close-btn {
  @apply text-gray-400 hover:text-gray-600 text-2xl leading-none;
}

.prorated-amount-card {
  @apply bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg;
}

.modal-enter-active,
.modal-leave-active {
  @apply transition-opacity duration-300;
}

.modal-enter-from,
.modal-leave-to {
  @apply opacity-0;
}
</style>
```

### PaymentMethodManager.vue Implementation

**File:** `resources/js/Components/Enterprise/Billing/PaymentMethodManager.vue`

```vue
<script setup lang="ts">
import { ref, onMounted, computed } from 'vue'
import { useForm } from '@inertiajs/vue3'
import { loadStripe, Stripe, StripeElements, StripeCardElement } from '@stripe/stripe-js'
import PaymentMethodCard from './PaymentMethodCard.vue'
import type { PaymentMethod, Organization } from '@/types/billing'

interface Props {
  organization: Organization
  paymentMethods: PaymentMethod[]
  stripePublishableKey: string
}

const props = defineProps<Props>()
const emit = defineEmits(['payment-method-added', 'payment-method-deleted', 'default-updated'])

const stripe = ref<Stripe | null>(null)
const cardElement = ref<StripeCardElement | null>(null)
const elements = ref<StripeElements | null>(null)

const showAddCardModal = ref(false)
const showDeleteModal = ref(false)
const methodToDelete = ref<PaymentMethod | null>(null)
const isProcessing = ref(false)
const cardError = ref('')

const addCardForm = useForm({
  payment_method_token: '',
  is_default: false,
})

const deleteForm = useForm({})

const defaultPaymentMethod = computed(() => {
  return props.paymentMethods.find(pm => pm.is_default)
})

// Initialize Stripe
onMounted(async () => {
  try {
    stripe.value = await loadStripe(props.stripePublishableKey)

    if (stripe.value) {
      elements.value = stripe.value.elements()
      cardElement.value = elements.value.create('card', {
        style: {
          base: {
            fontSize: '16px',
            color: '#32325d',
            fontFamily: '"Inter", sans-serif',
            '::placeholder': {
              color: '#aab7c4',
            },
          },
          invalid: {
            color: '#fa755a',
            iconColor: '#fa755a',
          },
        },
      })
    }
  } catch (error) {
    console.error('Failed to load Stripe:', error)
    cardError.value = 'Failed to load payment form. Please refresh the page.'
  }
})

// Mount Stripe card element
const mountCardElement = () => {
  if (cardElement.value && stripe.value) {
    const cardContainer = document.getElementById('card-element')
    if (cardContainer) {
      cardElement.value.mount(cardContainer)

      cardElement.value.on('change', (event) => {
        cardError.value = event.error ? event.error.message : ''
      })
    }
  }
}

// Open add card modal
const openAddCardModal = () => {
  showAddCardModal.value = true
  setTimeout(() => mountCardElement(), 100)
}

// Add payment method
const addPaymentMethod = async () => {
  if (!stripe.value || !cardElement.value) {
    cardError.value = 'Payment system not initialized'
    return
  }

  isProcessing.value = true
  cardError.value = ''

  try {
    // Create payment method with Stripe
    const { error, paymentMethod } = await stripe.value.createPaymentMethod({
      type: 'card',
      card: cardElement.value,
    })

    if (error) {
      cardError.value = error.message || 'Failed to add payment method'
      isProcessing.value = false
      return
    }

    // Submit to backend
    addCardForm.payment_method_token = paymentMethod!.id

    addCardForm.post(route('enterprise.payment-methods.store', {
      organization: props.organization.id
    }), {
      onSuccess: (response) => {
        showAddCardModal.value = false
        emit('payment-method-added', response.payment_method)
        cardElement.value?.clear()
        isProcessing.value = false
      },
      onError: (errors) => {
        cardError.value = errors.payment_method_token || 'Failed to save payment method'
        isProcessing.value = false
      },
    })
  } catch (error) {
    cardError.value = 'An unexpected error occurred'
    isProcessing.value = false
  }
}

// Delete payment method
const confirmDeletePaymentMethod = (method: PaymentMethod) => {
  methodToDelete.value = method
  showDeleteModal.value = true
}

const deletePaymentMethod = () => {
  if (!methodToDelete.value) return

  isProcessing.value = true

  deleteForm.delete(route('enterprise.payment-methods.destroy', {
    organization: props.organization.id,
    paymentMethod: methodToDelete.value.id
  }), {
    onSuccess: (response) => {
      showDeleteModal.value = false
      methodToDelete.value = null
      emit('payment-method-deleted', response.payment_method_id)
      isProcessing.value = false
    },
    onError: (errors) => {
      isProcessing.value = false
      console.error('Delete failed:', errors)
    },
  })
}

// Set default payment method
const setDefaultPaymentMethod = (method: PaymentMethod) => {
  isProcessing.value = true

  const form = useForm({})

  form.post(route('enterprise.payment-methods.set-default', {
    organization: props.organization.id,
    paymentMethod: method.id
  }), {
    onSuccess: (response) => {
      emit('default-updated', method.id)
      isProcessing.value = false
    },
    onError: (errors) => {
      isProcessing.value = false
      console.error('Set default failed:', errors)
    },
  })
}

// Format card brand
const formatCardBrand = (brand: string) => {
  const brands: Record<string, string> = {
    'visa': 'Visa',
    'mastercard': 'Mastercard',
    'amex': 'American Express',
    'discover': 'Discover',
  }
  return brands[brand] || brand
}
</script>

<template>
  <div class="payment-method-manager">
    <div class="header">
      <h2 class="text-2xl font-bold">Payment Methods</h2>
      <button @click="openAddCardModal" class="btn btn-primary">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Add Payment Method
      </button>
    </div>

    <!-- Payment Methods List -->
    <div v-if="paymentMethods.length > 0" class="payment-methods-grid">
      <PaymentMethodCard
        v-for="method in paymentMethods"
        :key="method.id"
        :payment-method="method"
        :is-default="method.id === defaultPaymentMethod?.id"
        @set-default="setDefaultPaymentMethod(method)"
        @delete="confirmDeletePaymentMethod(method)"
      />
    </div>

    <!-- No Payment Methods -->
    <div v-else class="no-payment-methods">
      <svg class="w-16 h-16 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
      </svg>
      <h3 class="mt-4 text-lg font-semibold">No Payment Methods</h3>
      <p class="mt-2 text-gray-600 dark:text-gray-400">
        Add a payment method to enable subscriptions
      </p>
    </div>

    <!-- Add Card Modal -->
    <transition name="modal">
      <div v-if="showAddCardModal" class="modal-overlay" @click.self="showAddCardModal = false">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="text-xl font-semibold">Add Payment Method</h3>
            <button @click="showAddCardModal = false" class="close-btn">&times;</button>
          </div>

          <div class="modal-body">
            <div class="card-form">
              <label class="block text-sm font-medium mb-2">
                Card Details
              </label>

              <div id="card-element" class="card-element"></div>

              <p v-if="cardError" class="text-red-600 text-sm mt-2">
                {{ cardError }}
              </p>

              <div class="mt-4">
                <label class="flex items-center gap-2">
                  <input
                    type="checkbox"
                    v-model="addCardForm.is_default"
                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  <span class="text-sm">Set as default payment method</span>
                </label>
              </div>

              <div class="security-notice mt-4">
                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                <p class="text-xs text-gray-600 dark:text-gray-400">
                  Your payment information is encrypted and securely processed by Stripe. We never store your full card details.
                </p>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button @click="showAddCardModal = false" class="btn btn-secondary" :disabled="isProcessing">
              Cancel
            </button>
            <button @click="addPaymentMethod" class="btn btn-primary" :disabled="isProcessing">
              <span v-if="isProcessing">Processing...</span>
              <span v-else>Add Payment Method</span>
            </button>
          </div>
        </div>
      </div>
    </transition>

    <!-- Delete Confirmation Modal -->
    <transition name="modal">
      <div v-if="showDeleteModal" class="modal-overlay" @click.self="showDeleteModal = false">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="text-xl font-semibold text-red-600">Delete Payment Method</h3>
            <button @click="showDeleteModal = false" class="close-btn">&times;</button>
          </div>

          <div class="modal-body">
            <p class="text-center">
              Are you sure you want to delete this payment method?
            </p>
            <div v-if="methodToDelete" class="mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
              <p class="font-medium">
                {{ formatCardBrand(methodToDelete.card_brand) }} •••• {{ methodToDelete.last4 }}
              </p>
              <p class="text-sm text-gray-600 dark:text-gray-400">
                Expires {{ methodToDelete.exp_month }}/{{ methodToDelete.exp_year }}
              </p>
            </div>
          </div>

          <div class="modal-footer">
            <button @click="showDeleteModal = false" class="btn btn-secondary" :disabled="isProcessing">
              Cancel
            </button>
            <button @click="deletePaymentMethod" class="btn btn-danger" :disabled="isProcessing">
              <span v-if="isProcessing">Deleting...</span>
              <span v-else>Delete</span>
            </button>
          </div>
        </div>
      </div>
    </transition>
  </div>
</template>

<style scoped>
.payment-method-manager {
  @apply max-w-6xl mx-auto p-6;
}

.header {
  @apply flex justify-between items-center mb-6;
}

.payment-methods-grid {
  @apply grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4;
}

.no-payment-methods {
  @apply text-center py-12 bg-gray-50 dark:bg-gray-800 rounded-lg;
}

.card-element {
  @apply p-3 border border-gray-300 dark:border-gray-600 rounded-md;
}

.security-notice {
  @apply flex items-start gap-2 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg;
}

.modal-overlay {
  @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4;
}

.modal-content {
  @apply bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-lg w-full;
}

.modal-header {
  @apply flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700;
}

.modal-body {
  @apply p-6;
}

.modal-footer {
  @apply flex justify-end gap-3 p-6 border-t border-gray-200 dark:border-gray-700;
}

.close-btn {
  @apply text-gray-400 hover:text-gray-600 text-2xl leading-none;
}
</style>
```

### BillingDashboard.vue Implementation

**File:** `resources/js/Components/Enterprise/Billing/BillingDashboard.vue`

```vue
<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { usePage } from '@inertiajs/vue3'
import UsageChart from './UsageChart.vue'
import InvoiceList from './InvoiceList.vue'
import type { Organization, Invoice, UsageMetrics, Transaction } from '@/types/billing'

interface Props {
  organization: Organization
  currentUsage: UsageMetrics
  invoices: Invoice[]
  transactions: Transaction[]
  estimatedCost: number
}

const props = defineProps<Props>()

const selectedPeriod = ref<'current' | 'last' | 'all'>('current')
const usageData = ref(props.currentUsage)

const usagePercentages = computed(() => {
  const license = props.organization.license
  if (!license) return {}

  return {
    cpu: (usageData.value.cpu_hours / (license.max_cpu_cores * 730)) * 100,
    memory: (usageData.value.memory_gb_hours / (license.max_memory_gb * 730)) * 100,
    storage: (usageData.value.storage_gb / license.max_storage_gb) * 100,
  }
})

const isOverQuota = computed(() => {
  return Object.values(usagePercentages.value).some(p => p > 100)
})

const formatCurrency = (amount: number) => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
  }).format(amount)
}

const formatNumber = (num: number, decimals: number = 2) => {
  return num.toFixed(decimals)
}
</script>

<template>
  <div class="billing-dashboard">
    <!-- Cost Summary Cards -->
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-icon bg-blue-100 dark:bg-blue-900">
          <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="card-content">
          <p class="card-label">Estimated Cost (Current Month)</p>
          <p class="card-value">{{ formatCurrency(estimatedCost) }}</p>
        </div>
      </div>

      <div class="summary-card">
        <div class="card-icon bg-green-100 dark:bg-green-900">
          <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
          </svg>
        </div>
        <div class="card-content">
          <p class="card-label">CPU Usage</p>
          <p class="card-value">{{ formatNumber(currentUsage.cpu_hours) }} hours</p>
          <div class="progress-bar mt-2">
            <div class="progress-fill" :style="{ width: `${Math.min(100, usagePercentages.cpu)}%` }"></div>
          </div>
          <p class="text-xs text-gray-500 mt-1">{{ formatNumber(usagePercentages.cpu) }}% of quota</p>
        </div>
      </div>

      <div class="summary-card">
        <div class="card-icon bg-purple-100 dark:bg-purple-900">
          <svg class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
          </svg>
        </div>
        <div class="card-content">
          <p class="card-label">Memory Usage</p>
          <p class="card-value">{{ formatNumber(currentUsage.memory_gb_hours) }} GB-hours</p>
          <div class="progress-bar mt-2">
            <div class="progress-fill" :style="{ width: `${Math.min(100, usagePercentages.memory)}%` }"></div>
          </div>
          <p class="text-xs text-gray-500 mt-1">{{ formatNumber(usagePercentages.memory) }}% of quota</p>
        </div>
      </div>

      <div class="summary-card">
        <div class="card-icon bg-orange-100 dark:bg-orange-900">
          <svg class="w-6 h-6 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
          </svg>
        </div>
        <div class="card-content">
          <p class="card-label">Storage Usage</p>
          <p class="card-value">{{ formatNumber(currentUsage.storage_gb) }} GB</p>
          <div class="progress-bar mt-2">
            <div class="progress-fill" :style="{ width: `${Math.min(100, usagePercentages.storage)}%` }"></div>
          </div>
          <p class="text-xs text-gray-500 mt-1">{{ formatNumber(usagePercentages.storage) }}% of quota</p>
        </div>
      </div>
    </div>

    <!-- Over Quota Warning -->
    <div v-if="isOverQuota" class="over-quota-warning">
      <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <div>
        <p class="font-semibold">Resource Quota Exceeded</p>
        <p class="text-sm">You've exceeded your plan's resource limits. Overage charges may apply. Consider upgrading your plan.</p>
      </div>
    </div>

    <!-- Usage Chart -->
    <div class="chart-section">
      <h3 class="text-xl font-semibold mb-4">Usage Trends</h3>
      <UsageChart :usage-data="currentUsage" />
    </div>

    <!-- Invoices -->
    <div class="invoices-section">
      <h3 class="text-xl font-semibold mb-4">Invoices</h3>
      <InvoiceList :invoices="invoices" />
    </div>

    <!-- Transactions -->
    <div class="transactions-section">
      <h3 class="text-xl font-semibold mb-4">Recent Transactions</h3>
      <div class="transactions-table">
        <table class="w-full">
          <thead>
            <tr class="border-b border-gray-200 dark:border-gray-700">
              <th class="text-left py-3 px-4">Date</th>
              <th class="text-left py-3 px-4">Description</th>
              <th class="text-left py-3 px-4">Method</th>
              <th class="text-right py-3 px-4">Amount</th>
              <th class="text-center py-3 px-4">Status</th>
            </tr>
          </thead>
          <tbody>
            <tr
              v-for="transaction in transactions"
              :key="transaction.id"
              class="border-b border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700"
            >
              <td class="py-3 px-4">{{ new Date(transaction.created_at).toLocaleDateString() }}</td>
              <td class="py-3 px-4">{{ transaction.description }}</td>
              <td class="py-3 px-4">•••• {{ transaction.payment_method?.last4 || 'N/A' }}</td>
              <td class="py-3 px-4 text-right font-medium">{{ formatCurrency(transaction.amount) }}</td>
              <td class="py-3 px-4 text-center">
                <span
                  class="status-badge"
                  :class="{
                    'status-success': transaction.status === 'succeeded',
                    'status-pending': transaction.status === 'pending',
                    'status-failed': transaction.status === 'failed',
                  }"
                >
                  {{ transaction.status }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</template>

<style scoped>
.billing-dashboard {
  @apply max-w-7xl mx-auto p-6 space-y-8;
}

.summary-cards {
  @apply grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6;
}

.summary-card {
  @apply bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6;
}

.card-icon {
  @apply w-12 h-12 rounded-lg flex items-center justify-center mb-4;
}

.card-label {
  @apply text-sm text-gray-600 dark:text-gray-400 mb-1;
}

.card-value {
  @apply text-2xl font-bold text-gray-900 dark:text-gray-100;
}

.progress-bar {
  @apply w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden;
}

.progress-fill {
  @apply h-full bg-blue-600 dark:bg-blue-500 transition-all duration-300;
}

.over-quota-warning {
  @apply flex items-start gap-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg;
}

.chart-section,
.invoices-section,
.transactions-section {
  @apply bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6;
}

.transactions-table {
  @apply overflow-x-auto;
}

.status-badge {
  @apply px-3 py-1 rounded-full text-xs font-medium;
}

.status-success {
  @apply bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200;
}

.status-pending {
  @apply bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200;
}

.status-failed {
  @apply bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200;
}
</style>
```

### Backend Controllers

**File:** `app/Http/Controllers/Enterprise/SubscriptionController.php`

```php
<?php

namespace App\Http\Controllers\Enterprise;

use App\Http\Controllers\Controller;
use App\Services\Enterprise\PaymentService;
use App\Models\Organization;
use Illuminate\Http\Request;
use Inertia\Inertia;

class SubscriptionController extends Controller
{
    use AuthorizesRequests;

    public function __construct(
        private PaymentService $paymentService
    ) {}

    public function index(Organization $organization)
    {
        $this->authorize('view', $organization);

        $currentSubscription = $organization->subscription;
        $availablePlans = $this->paymentService->getAvailablePlans();

        return Inertia::render('Enterprise/Billing/SubscriptionPage', [
            'organization' => $organization,
            'currentSubscription' => $currentSubscription,
            'availablePlans' => $availablePlans,
        ]);
    }

    public function change(Request $request, Organization $organization)
    {
        $this->authorize('update', $organization);

        $request->validate([
            'plan_id' => 'required|exists:subscription_plans,id',
            'payment_method_id' => 'nullable|exists:payment_methods,id',
        ]);

        $subscription = $this->paymentService->changeSubscription(
            $organization,
            $request->input('plan_id'),
            $request->input('payment_method_id')
        );

        return back()->with([
            'success' => 'Subscription updated successfully',
            'subscription' => $subscription,
        ]);
    }

    public function cancel(Request $request, Organization $organization)
    {
        $this->authorize('update', $organization);

        $request->validate([
            'cancellation_reason' => 'nullable|string|max:500',
            'immediate' => 'boolean',
        ]);

        $subscription = $this->paymentService->cancelSubscription(
            $organization,
            $request->input('immediate', false),
            $request->input('cancellation_reason')
        );

        return back()->with([
            'success' => 'Subscription cancelled successfully',
            'subscription' => $subscription,
        ]);
    }

    public function resume(Organization $organization)
    {
        $this->authorize('update', $organization);

        $subscription = $this->paymentService->resumeSubscription($organization);

        return back()->with([
            'success' => 'Subscription resumed successfully',
            'subscription' => $subscription,
        ]);
    }
}
```

**File:** `app/Http/Controllers/Enterprise/PaymentMethodController.php`

```php
<?php

namespace App\Http\Controllers\Enterprise;

use App\Http\Controllers\Controller;
use App\Services\Enterprise\PaymentService;
use App\Models\Organization;
use Illuminate\Http\Request;
use Illuminate\Foundation\Auth\Access\AuthorizesRequests;

class PaymentMethodController extends Controller
{
    use AuthorizesRequests;

    public function __construct(
        private PaymentService $paymentService
    ) {}

    public function store(Request $request, Organization $organization)
    {
        $this->authorize('update', $organization);

        $request->validate([
            'payment_method_token' => 'required|string',
            'is_default' => 'boolean',
        ]);

        $paymentMethod = $this->paymentService->addPaymentMethod(
            $organization,
            $request->input('payment_method_token'),
            $request->boolean('is_default')
        );

        return back()->with([
            'success' => 'Payment method added successfully',
            'payment_method' => $paymentMethod,
        ]);
    }

    public function destroy(Organization $organization, int $paymentMethodId)
    {
        $this->authorize('update', $organization);

        $this->paymentService->deletePaymentMethod($organization, $paymentMethodId);

        return back()->with([
            'success' => 'Payment method deleted successfully',
            'payment_method_id' => $paymentMethodId,
        ]);
    }

    public function setDefault(Organization $organization, int $paymentMethodId)
    {
        $this->authorize('update', $organization);

        $this->paymentService->setDefaultPaymentMethod($organization, $paymentMethodId);

        return back()->with('success', 'Default payment method updated');
    }
}
```

### Routes

**File:** `routes/web.php`

```php
// Subscription management routes
Route::middleware(['auth', 'organization'])->prefix('enterprise')->group(function () {
    Route::get('/organizations/{organization}/subscriptions',
        [SubscriptionController::class, 'index'])
        ->name('enterprise.subscriptions.index');

    Route::post('/organizations/{organization}/subscriptions/change',
        [SubscriptionController::class, 'change'])
        ->name('enterprise.subscriptions.change');

    Route::post('/organizations/{organization}/subscriptions/cancel',
        [SubscriptionController::class, 'cancel'])
        ->name('enterprise.subscriptions.cancel');

    Route::post('/organizations/{organization}/subscriptions/resume',
        [SubscriptionController::class, 'resume'])
        ->name('enterprise.subscriptions.resume');

    // Payment methods
    Route::post('/organizations/{organization}/payment-methods',
        [PaymentMethodController::class, 'store'])
        ->name('enterprise.payment-methods.store');

    Route::delete('/organizations/{organization}/payment-methods/{paymentMethod}',
        [PaymentMethodController::class, 'destroy'])
        ->name('enterprise.payment-methods.destroy');

    Route::post('/organizations/{organization}/payment-methods/{paymentMethod}/set-default',
        [PaymentMethodController::class, 'setDefault'])
        ->name('enterprise.payment-methods.set-default');

    // Billing dashboard
    Route::get('/organizations/{organization}/billing',
        [BillingController::class, 'index'])
        ->name('enterprise.billing.index');
});
```

## Implementation Approach

### Step 1: Install Frontend Dependencies
```bash
npm install @stripe/stripe-js apexcharts vue3-apexcharts
```

### Step 2: Create TypeScript Type Definitions
Create `resources/js/types/billing.d.ts` with interfaces for Plan, Subscription, PaymentMethod, Invoice, Transaction, etc.

### Step 3: Build Sub-Components First
1. Create `PlanComparisonTable.vue` - Reusable plan comparison table
2. Create `PaymentMethodCard.vue` - Individual payment method display card
3. Create `UsageChart.vue` - ApexCharts wrapper for usage visualization
4. Create `InvoiceList.vue` - Invoice table with download functionality

### Step 4: Implement SubscriptionManager.vue
1. Create component structure with props and reactive state
2. Implement plan selection with upgrade/downgrade logic
3. Add prorated billing calculation
4. Create cancellation flow with reason collection
5. Add subscription pause/resume functionality

### Step 5: Implement PaymentMethodManager.vue
1. Integrate Stripe.js Elements for secure card collection
2. Create payment method display grid
3. Implement add/delete/set-default actions
4. Add PCI compliance security notices

### Step 6: Implement BillingDashboard.vue
1. Create usage summary cards with progress bars
2. Integrate ApexCharts for usage trends visualization
3. Build invoice table with PDF download
4. Add transaction log with status badges
5. Implement cost forecasting calculations

### Step 7: Create Backend Controllers
1. Implement SubscriptionController with change/cancel/resume endpoints
2. Implement PaymentMethodController with CRUD operations
3. Implement BillingController for dashboard data aggregation
4. Add authorization checks with policies

### Step 8: Register Routes
Add all necessary routes in `routes/web.php` with middleware protection

### Step 9: Testing
1. Unit test all Vue components with Vitest
2. Integration test backend endpoints with Pest
3. Browser test complete billing workflows with Dusk

### Step 10: Documentation and Polish
1. Add JSDoc comments to Vue components
2. Create user guide for subscription management
3. Add loading states and error handling
4. Implement dark mode support

## Test Strategy

### Unit Tests (Vitest)

**File:** `resources/js/Components/Enterprise/Billing/__tests__/SubscriptionManager.spec.ts`

```typescript
import { mount } from '@vue/test-utils'
import { describe, it, expect, vi } from 'vitest'
import SubscriptionManager from '../SubscriptionManager.vue'

describe('SubscriptionManager.vue', () => {
  const mockOrganization = {
    id: 1,
    name: 'Test Organization',
  }

  const mockPlans = [
    { id: 1, name: 'Starter', price_monthly: 29, features: { users: 5, storage: 50 } },
    { id: 2, name: 'Pro', price_monthly: 99, features: { users: 20, storage: 200 } },
  ]

  it('renders current subscription status', () => {
    const currentSubscription = {
      id: 1,
      plan_id: 1,
      status: 'active',
      current_period_end: '2025-11-06',
    }

    const wrapper = mount(SubscriptionManager, {
      props: {
        organization: mockOrganization,
        currentSubscription,
        availablePlans: mockPlans,
      },
    })

    expect(wrapper.text()).toContain('Starter')
    expect(wrapper.text()).toContain('ACTIVE')
  })

  it('calculates prorated amount for upgrades', async () => {
    const currentSubscription = {
      id: 1,
      plan_id: 1,
      status: 'active',
      current_period_end: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString(), // 15 days from now
    }

    const wrapper = mount(SubscriptionManager, {
      props: {
        organization: mockOrganization,
        currentSubscription,
        availablePlans: mockPlans,
      },
    })

    // Select upgrade plan
    await wrapper.vm.selectPlan(mockPlans[1])

    // Prorated amount should be approximately (99 - 29) * (15/30) = $35
    expect(wrapper.vm.proratedAmount).toBeGreaterThan(30)
    expect(wrapper.vm.proratedAmount).toBeLessThan(40)
  })

  it('opens cancellation modal', async () => {
    const wrapper = mount(SubscriptionManager, {
      props: {
        organization: mockOrganization,
        currentSubscription: { id: 1, plan_id: 1, status: 'active' },
        availablePlans: mockPlans,
      },
    })

    await wrapper.find('.btn-danger').trigger('click')

    expect(wrapper.vm.showCancelModal).toBe(true)
  })

  it('emits subscription-updated event on successful change', async () => {
    const wrapper = mount(SubscriptionManager, {
      props: {
        organization: mockOrganization,
        availablePlans: mockPlans,
      },
    })

    // Mock successful subscription change
    // ... test implementation

    expect(wrapper.emitted('subscription-updated')).toBeTruthy()
  })
})
```

**File:** `resources/js/Components/Enterprise/Billing/__tests__/PaymentMethodManager.spec.ts`

```typescript
import { mount } from '@vue/test-utils'
import { describe, it, expect, vi } from 'vitest'
import PaymentMethodManager from '../PaymentMethodManager.vue'

describe('PaymentMethodManager.vue', () => {
  const mockOrganization = { id: 1, name: 'Test Org' }
  const mockPaymentMethods = [
    { id: 1, card_brand: 'visa', last4: '4242', exp_month: 12, exp_year: 2025, is_default: true },
    { id: 2, card_brand: 'mastercard', last4: '5555', exp_month: 6, exp_year: 2026, is_default: false },
  ]

  it('renders payment method list', () => {
    const wrapper = mount(PaymentMethodManager, {
      props: {
        organization: mockOrganization,
        paymentMethods: mockPaymentMethods,
        stripePublishableKey: 'pk_test_123',
      },
    })

    expect(wrapper.text()).toContain('4242')
    expect(wrapper.text()).toContain('5555')
  })

  it('opens add card modal', async () => {
    const wrapper = mount(PaymentMethodManager, {
      props: {
        organization: mockOrganization,
        paymentMethods: [],
        stripePublishableKey: 'pk_test_123',
      },
    })

    await wrapper.find('.btn-primary').trigger('click')

    expect(wrapper.vm.showAddCardModal).toBe(true)
  })

  it('validates card before submission', async () => {
    // Mock Stripe.js
    const mockStripe = {
      elements: vi.fn(() => ({
        create: vi.fn(() => ({
          mount: vi.fn(),
          on: vi.fn(),
          clear: vi.fn(),
        })),
      })),
      createPaymentMethod: vi.fn(),
    }

    // Test card validation logic
    // ...
  })
})
```

### Integration Tests (Pest)

**File:** `tests/Feature/Enterprise/SubscriptionManagementTest.php`

```php
<?php

use App\Models\Organization;
use App\Models\User;
use App\Models\SubscriptionPlan;
use App\Models\OrganizationSubscription;

it('allows upgrading subscription plan', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'admin']);

    $starterPlan = SubscriptionPlan::factory()->create(['price_monthly' => 29]);
    $proPlan = SubscriptionPlan::factory()->create(['price_monthly' => 99]);

    $subscription = OrganizationSubscription::factory()->create([
        'organization_id' => $organization->id,
        'plan_id' => $starterPlan->id,
    ]);

    $this->actingAs($user)
        ->post(route('enterprise.subscriptions.change', $organization), [
            'plan_id' => $proPlan->id,
        ])
        ->assertRedirect()
        ->assertSessionHas('success');

    $subscription->refresh();
    expect($subscription->plan_id)->toBe($proPlan->id);
});

it('calculates prorated charges correctly', function () {
    // Test prorated billing calculation
    // ...
});

it('allows cancelling subscription', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'admin']);

    $subscription = OrganizationSubscription::factory()->create([
        'organization_id' => $organization->id,
        'status' => 'active',
    ]);

    $this->actingAs($user)
        ->post(route('enterprise.subscriptions.cancel', $organization), [
            'cancellation_reason' => 'Too expensive',
            'immediate' => false,
        ])
        ->assertRedirect()
        ->assertSessionHas('success');

    $subscription->refresh();
    expect($subscription->status)->toBe('cancelled');
});

it('allows resuming cancelled subscription', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'admin']);

    $subscription = OrganizationSubscription::factory()->create([
        'organization_id' => $organization->id,
        'status' => 'cancelled',
    ]);

    $this->actingAs($user)
        ->post(route('enterprise.subscriptions.resume', $organization))
        ->assertRedirect()
        ->assertSessionHas('success');

    $subscription->refresh();
    expect($subscription->status)->toBe('active');
});
```

**File:** `tests/Feature/Enterprise/PaymentMethodManagementTest.php`

```php
<?php

use App\Models\Organization;
use App\Models\User;
use App\Models\PaymentMethod;

it('adds payment method with Stripe token', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'admin']);

    // Mock Stripe payment method creation
    $this->mock(\App\Services\Enterprise\PaymentService::class, function ($mock) {
        $mock->shouldReceive('addPaymentMethod')
            ->once()
            ->andReturn(PaymentMethod::factory()->make());
    });

    $this->actingAs($user)
        ->post(route('enterprise.payment-methods.store', $organization), [
            'payment_method_token' => 'pm_test_123',
            'is_default' => true,
        ])
        ->assertRedirect()
        ->assertSessionHas('success');
});

it('deletes payment method', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'admin']);

    $paymentMethod = PaymentMethod::factory()->create([
        'organization_id' => $organization->id,
    ]);

    $this->actingAs($user)
        ->delete(route('enterprise.payment-methods.destroy', [
            'organization' => $organization,
            'paymentMethod' => $paymentMethod->id,
        ]))
        ->assertRedirect()
        ->assertSessionHas('success');

    $this->assertDatabaseMissing('payment_methods', [
        'id' => $paymentMethod->id,
    ]);
});

it('sets default payment method', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'admin']);

    $method1 = PaymentMethod::factory()->create([
        'organization_id' => $organization->id,
        'is_default' => true,
    ]);

    $method2 = PaymentMethod::factory()->create([
        'organization_id' => $organization->id,
        'is_default' => false,
    ]);

    $this->actingAs($user)
        ->post(route('enterprise.payment-methods.set-default', [
            'organization' => $organization,
            'paymentMethod' => $method2->id,
        ]))
        ->assertRedirect()
        ->assertSessionHas('success');

    $method1->refresh();
    $method2->refresh();

    expect($method1->is_default)->toBeFalse();
    expect($method2->is_default)->toBeTrue();
});
```

### Browser Tests (Dusk)

**File:** `tests/Browser/Enterprise/BillingWorkflowTest.php`

```php
<?php

use Laravel\Dusk\Browser;

it('completes full billing workflow', function () {
    $this->browse(function (Browser $browser) {
        $browser->loginAs($user)
            ->visit('/enterprise/organizations/1/billing')
            ->waitForText('Billing Dashboard')

            // Add payment method
            ->click('@add-payment-method')
            ->waitFor('#card-element')
            ->type('#card-number', '4242424242424242')
            ->type('#card-expiry', '1225')
            ->type('#card-cvc', '123')
            ->click('@submit-payment-method')
            ->waitForText('Payment method added successfully')

            // Upgrade subscription
            ->visit('/enterprise/organizations/1/subscriptions')
            ->click('@select-pro-plan')
            ->waitFor('@upgrade-modal')
            ->assertSee('Prorated charge')
            ->click('@confirm-upgrade')
            ->waitForText('Subscription updated successfully')

            // View usage and invoices
            ->visit('/enterprise/organizations/1/billing')
            ->assertSee('Current billing period')
            ->assertSee('Invoices')
            ->screenshot('billing-dashboard');
    });
});
```

## Definition of Done

### Component Development
- [ ] SubscriptionManager.vue created with Composition API and TypeScript
- [ ] PaymentMethodManager.vue created with Stripe.js integration
- [ ] BillingDashboard.vue created with ApexCharts visualization
- [ ] All sub-components created (PlanComparisonTable, PaymentMethodCard, UsageChart, InvoiceList)
- [ ] TypeScript type definitions created in billing.d.ts
- [ ] All components use Inertia.js for form submissions

### Functionality
- [ ] Subscription upgrade/downgrade with prorated billing calculations
- [ ] Subscription cancellation with reason collection
- [ ] Subscription pause and resume functionality
- [ ] Payment method addition with Stripe Elements
- [ ] Payment method deletion with confirmation
- [ ] Default payment method selection
- [ ] Usage metrics visualization with progress bars
- [ ] Invoice list with PDF download
- [ ] Transaction log with status badges
- [ ] Cost forecasting and overage alerts

### Backend Integration
- [ ] SubscriptionController created with all endpoints
- [ ] PaymentMethodController created with CRUD operations
- [ ] BillingController created for dashboard data
- [ ] All routes registered in routes/web.php
- [ ] Authorization policies implemented
- [ ] Integration with PaymentService

### Testing
- [ ] Unit tests written for all Vue components (>90% coverage)
- [ ] Integration tests written for all backend endpoints
- [ ] Browser tests written for complete billing workflows
- [ ] Payment gateway mocking implemented for tests
- [ ] All tests passing

### Quality & Standards
- [ ] Code follows Vue 3 Composition API best practices
- [ ] TypeScript types properly defined
- [ ] PCI compliance verified (no sensitive data stored)
- [ ] Responsive design working on all screen sizes
- [ ] Dark mode support implemented
- [ ] Accessibility compliance verified (ARIA labels, keyboard navigation)
- [ ] Loading states and error handling implemented
- [ ] Laravel Pint formatting applied to PHP code
- [ ] PHPStan level 5 passing
- [ ] No console errors or warnings

### Documentation
- [ ] Component props and events documented with JSDoc
- [ ] User guide created for subscription management
- [ ] API endpoint documentation updated
- [ ] Payment integration guide created
- [ ] Code reviewed and approved

### Performance
- [ ] Initial page load < 2 seconds
- [ ] Stripe Elements load < 1 second
- [ ] Chart rendering < 500ms
- [ ] Form submissions < 1 second

## Related Tasks

- **Depends on:** Task 46 (PaymentService implementation required for backend integration)
- **Integrates with:** Task 48 (Subscription lifecycle management)
- **Integrates with:** Task 49 (Usage-based billing calculations)
- **Used by:** Organization administrators for subscription and billing management
- **Complements:** Task 42-47 (Complete payment processing infrastructure)
