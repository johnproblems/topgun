---
name: Create database schema for payment and subscription tables
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:38:58Z
github: https://github.com/johnproblems/topgun/issues/151
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Create database schema for payment and subscription tables

## Description

Design and implement comprehensive database schema for multi-gateway payment processing, subscription management, and transaction tracking. This schema supports Stripe, PayPal, and Square gateways with encrypted credential storage, webhook event logging, and usage-based billing integration.

## Technical Implementation

### Database Tables

#### 1. `organization_subscriptions`
Tracks active subscriptions for organizations with plan details and billing cycles.

```php
Schema::create('organization_subscriptions', function (Blueprint $table) {
    $table->id();
    $table->foreignId('organization_id')->constrained()->cascadeOnDelete();
    $table->string('gateway')->index(); // stripe, paypal, square
    $table->string('gateway_subscription_id')->unique()->nullable();
    $table->string('plan_name'); // starter, professional, enterprise
    $table->decimal('base_price', 10, 2);
    $table->string('billing_cycle'); // monthly, yearly
    $table->enum('status', ['trial', 'active', 'paused', 'canceled', 'expired'])->index();
    $table->timestamp('trial_ends_at')->nullable();
    $table->timestamp('current_period_start')->nullable();
    $table->timestamp('current_period_end')->nullable();
    $table->timestamp('canceled_at')->nullable();
    $table->timestamp('paused_at')->nullable();
    $table->json('metadata')->nullable(); // Custom plan features, limits
    $table->timestamps();
    $table->softDeletes();

    $table->index(['organization_id', 'status']);
    $table->index('current_period_end'); // For billing cycle queries
});
```

#### 2. `payment_methods`
Stores encrypted payment method information for recurring billing.

```php
Schema::create('payment_methods', function (Blueprint $table) {
    $table->id();
    $table->foreignId('organization_id')->constrained()->cascadeOnDelete();
    $table->string('gateway')->index(); // stripe, paypal, square
    $table->string('gateway_payment_method_id')->index();
    $table->string('type'); // card, bank_account, paypal_account
    $table->boolean('is_default')->default(false);

    // Card details (last 4 digits, brand, expiry for display)
    $table->string('card_brand')->nullable(); // visa, mastercard, amex
    $table->string('card_last_four', 4)->nullable();
    $table->string('card_exp_month', 2)->nullable();
    $table->string('card_exp_year', 4)->nullable();

    // Bank account details (for ACH)
    $table->string('bank_name')->nullable();
    $table->string('bank_account_last_four', 4)->nullable();
    $table->string('bank_account_type')->nullable(); // checking, savings

    // Billing details
    $table->string('billing_name')->nullable();
    $table->string('billing_email')->nullable();
    $table->json('billing_address')->nullable(); // street, city, state, zip, country

    $table->timestamp('verified_at')->nullable();
    $table->timestamps();
    $table->softDeletes();

    $table->index(['organization_id', 'is_default']);
    $table->unique(['gateway', 'gateway_payment_method_id']);
});
```

#### 3. `payment_transactions`
Comprehensive transaction log for all payment activities.

```php
Schema::create('payment_transactions', function (Blueprint $table) {
    $table->id();
    $table->foreignId('organization_id')->constrained()->cascadeOnDelete();
    $table->foreignId('organization_subscription_id')->nullable()->constrained()->nullOnDelete();
    $table->foreignId('payment_method_id')->nullable()->constrained()->nullOnDelete();

    $table->string('gateway')->index();
    $table->string('gateway_transaction_id')->unique()->nullable();
    $table->string('type')->index(); // subscription, one_time, refund, usage_overage

    $table->decimal('amount', 10, 2);
    $table->string('currency', 3)->default('USD');
    $table->decimal('fee', 10, 2)->default(0); // Gateway processing fee
    $table->decimal('net_amount', 10, 2); // Amount after fees

    $table->enum('status', [
        'pending', 'processing', 'succeeded',
        'failed', 'refunded', 'partially_refunded', 'disputed'
    ])->index();

    $table->text('description')->nullable();
    $table->text('failure_reason')->nullable();
    $table->string('failure_code')->nullable();

    // For refunds
    $table->foreignId('refunded_transaction_id')->nullable()->constrained('payment_transactions');
    $table->decimal('refunded_amount', 10, 2)->default(0);

    // Usage-based billing details
    $table->json('usage_details')->nullable(); // Resource usage breakdown

    $table->json('metadata')->nullable(); // Gateway-specific data
    $table->timestamp('processed_at')->nullable();
    $table->timestamps();
    $table->softDeletes();

    $table->index(['organization_id', 'status', 'created_at']);
    $table->index(['type', 'status']);
    $table->index('processed_at');
});
```

#### 4. `payment_gateway_webhooks`
Webhook event log for debugging and idempotency.

```php
Schema::create('payment_gateway_webhooks', function (Blueprint $table) {
    $table->id();
    $table->string('gateway')->index(); // stripe, paypal, square
    $table->string('gateway_event_id')->unique();
    $table->string('event_type')->index(); // customer.subscription.created, payment.succeeded, etc.

    $table->json('payload'); // Full webhook payload
    $table->string('signature')->nullable(); // HMAC signature for validation
    $table->boolean('verified')->default(false);

    $table->enum('status', ['pending', 'processing', 'processed', 'failed', 'ignored'])->index();
    $table->text('processing_error')->nullable();
    $table->integer('processing_attempts')->default(0);
    $table->timestamp('processed_at')->nullable();

    $table->timestamps();

    $table->index(['gateway', 'event_type', 'status']);
    $table->index('created_at'); // For cleanup jobs
});
```

#### 5. `payment_gateway_credentials`
Encrypted storage for gateway API keys and secrets.

```php
Schema::create('payment_gateway_credentials', function (Blueprint $table) {
    $table->id();
    $table->string('gateway')->unique(); // stripe, paypal, square
    $table->boolean('is_active')->default(true);
    $table->boolean('is_test_mode')->default(false);

    // Encrypted credentials (using Laravel encryption)
    $table->text('public_key')->nullable(); // Publishable/client key
    $table->text('secret_key'); // Secret/server key (encrypted)
    $table->text('webhook_secret'); // Webhook signing secret (encrypted)

    // PayPal specific
    $table->text('client_id')->nullable(); // PayPal OAuth client ID
    $table->text('client_secret')->nullable(); // PayPal OAuth secret (encrypted)

    // Square specific
    $table->text('application_id')->nullable(); // Square application ID
    $table->text('location_id')->nullable(); // Square location ID

    $table->json('configuration')->nullable(); // Gateway-specific settings
    $table->timestamp('credentials_verified_at')->nullable();
    $table->timestamps();

    $table->index(['gateway', 'is_active']);
});
```

#### 6. `organization_invoices`
Generated invoices for subscription billing and usage charges.

```php
Schema::create('organization_invoices', function (Blueprint $table) {
    $table->id();
    $table->foreignId('organization_id')->constrained()->cascadeOnDelete();
    $table->foreignId('organization_subscription_id')->nullable()->constrained()->nullOnDelete();

    $table->string('invoice_number')->unique();
    $table->string('gateway')->nullable();
    $table->string('gateway_invoice_id')->nullable();

    $table->decimal('subtotal', 10, 2);
    $table->decimal('tax', 10, 2)->default(0);
    $table->decimal('total', 10, 2);
    $table->string('currency', 3)->default('USD');

    $table->enum('status', ['draft', 'open', 'paid', 'void', 'uncollectible'])->index();

    $table->json('line_items'); // Breakdown of charges
    $table->json('usage_details')->nullable(); // Resource usage summary

    $table->date('period_start');
    $table->date('period_end');
    $table->date('due_date')->nullable();
    $table->timestamp('paid_at')->nullable();

    $table->timestamps();
    $table->softDeletes();

    $table->index(['organization_id', 'status', 'due_date']);
    $table->index('invoice_number');
});
```

### Encryption Strategy

**Sensitive Data Encryption:**
- Use Laravel's `encrypted` cast for `payment_gateway_credentials` secrets
- Store only tokenized/reference IDs for payment methods (never raw card data)
- Implement PCI DSS compliance by NOT storing CVV/CVC codes
- Rotate encryption keys quarterly via `php artisan key:rotate --payment-keys`

**Example Model Casting:**
```php
// app/Models/PaymentGatewayCredential.php
protected function casts(): array
{
    return [
        'secret_key' => 'encrypted',
        'webhook_secret' => 'encrypted',
        'client_secret' => 'encrypted',
        'configuration' => 'encrypted:array',
    ];
}
```

### Indexes and Performance

**Critical Indexes:**
1. `organization_subscriptions(organization_id, status)` - Organization subscription lookups
2. `payment_transactions(organization_id, status, created_at)` - Billing dashboard queries
3. `payment_gateway_webhooks(gateway, event_type, status)` - Webhook processing queues
4. `payment_methods(organization_id, is_default)` - Default payment method selection

**Partitioning Strategy (for high volume):**
- Consider time-based partitioning for `payment_transactions` (monthly partitions)
- Archive `payment_gateway_webhooks` older than 90 days to cold storage

### White-Label Integration

**Branded Payment Flows:**
- `organization_invoices.line_items` includes white-label platform name from Task 2-11
- Email notifications use `WhiteLabelService` for branded invoice templates
- Payment confirmation pages dynamically load organization branding CSS

### Compliance Considerations

**PCI DSS Requirements:**
- NEVER store full card numbers, CVV/CVC codes, or PIN data
- Store only last 4 digits and expiration date for display purposes
- Use gateway tokenization (Stripe Payment Methods, PayPal Billing Agreements)
- Implement TLS 1.2+ for all payment gateway communication
- Log all payment-related access with audit trail

**Data Retention:**
- Retain `payment_transactions` indefinitely for financial records
- Archive `payment_gateway_webhooks` after 90 days (cold storage/S3)
- Soft delete payment methods (retain for dispute resolution)

## Testing Requirements

### Migration Tests
```php
it('creates payment tables with correct schema', function () {
    expect(Schema::hasTable('organization_subscriptions'))->toBeTrue();
    expect(Schema::hasTable('payment_methods'))->toBeTrue();
    expect(Schema::hasTable('payment_transactions'))->toBeTrue();
    expect(Schema::hasTable('payment_gateway_webhooks'))->toBeTrue();
    expect(Schema::hasTable('payment_gateway_credentials'))->toBeTrue();
    expect(Schema::hasTable('organization_invoices'))->toBeTrue();
});

it('enforces foreign key constraints', function () {
    // Test cascade deletion
    $org = Organization::factory()->create();
    $subscription = OrganizationSubscription::factory()->create(['organization_id' => $org->id]);

    $org->delete();

    expect(OrganizationSubscription::find($subscription->id))->toBeNull();
});

it('encrypts sensitive gateway credentials', function () {
    $credential = PaymentGatewayCredential::create([
        'gateway' => 'stripe',
        'secret_key' => 'sk_test_secret_key',
        'webhook_secret' => 'whsec_secret',
    ]);

    // Raw database value should be encrypted
    $raw = DB::table('payment_gateway_credentials')->first();
    expect($raw->secret_key)->not()->toBe('sk_test_secret_key');

    // Model accessor should decrypt
    expect($credential->fresh()->secret_key)->toBe('sk_test_secret_key');
});
```

## Acceptance Criteria

- [ ] All 6 tables created with comprehensive field definitions
- [ ] Foreign key constraints properly configured with cascade deletes
- [ ] Sensitive credentials use Laravel encrypted casting
- [ ] Proper indexes for performance on organization and status queries
- [ ] Gateway webhook idempotency via unique `gateway_event_id`
- [ ] Soft deletes enabled on critical tables (subscriptions, transactions, invoices)
- [ ] Migration rollback tested successfully
- [ ] PCI DSS compliance verified (no raw card storage)
- [ ] Integration with existing `organizations` table validated
- [ ] Seeder created for development gateway credentials

## Technical Details

- **Size:** M (Medium complexity)
- **Estimated hours:** 8-12
- **Database:** PostgreSQL 15+ with encrypted columns
- **Testing:** Pest unit tests for schema validation and encryption

## Dependencies

- [ ] Existing `organizations` table from Task 1 (Organization Hierarchy)
- [ ] Laravel encryption key configured in `.env`
- [ ] PostgreSQL JSON column support

## Definition of Done

- [ ] Migration files created and tested (up and down)
- [ ] Model classes created with proper casts and relationships
- [ ] Factory classes for all payment models
- [ ] Seeder with test gateway credentials (Stripe test mode)
- [ ] Schema documentation added to repository wiki
- [ ] All tests passing (`php artisan test --filter=PaymentSchema`)
- [ ] PHPStan level 5 compliance
- [ ] Code reviewed and merged

## Related Tasks

- **Depends on:** None (foundational task)
- **Blocks:** Tasks 43-51 (all payment processing tasks)
- **Integrates with:** Task 25 (SystemResourceMonitor - for usage billing)
