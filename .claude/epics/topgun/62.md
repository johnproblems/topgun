---
name: Create database schema for domains and DNS records
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:39:16Z
github: https://github.com/johnproblems/topgun/issues/170
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Create database schema for domains and DNS records

## Description

Design and implement comprehensive database schema for managing custom domains and DNS records within the enterprise platform. This schema supports the domain management system that enables organizations to register, configure, and manage custom domains for their white-labeled deployments and applications.

The domain management system enables organizations to:
1. **Register and manage custom domains** for white-labeled platform branding (e.g., platform.acme.com)
2. **Configure DNS records** for application deployments with automatic propagation
3. **Manage SSL certificates** with automatic Let's Encrypt provisioning and renewal
4. **Track domain ownership verification** through DNS TXT records or file uploads
5. **Support multi-level domain hierarchies** with subdomain delegation
6. **Enable application domain binding** linking applications to specific domains/subdomains

**Integration with Enterprise Features:**

- **White-Label Branding** (Task 2-11): Organizations use custom domains for branded platform access
- **Application Deployments**: Applications bind to custom domains with automatic DNS configuration
- **SSL Certificate Management**: Automatic certificate provisioning for all domains and subdomains
- **Domain Registrar Integration** (Task 64-65): Store registrar credentials and sync domain configurations
- **DNS Management Service** (Task 67): Automated DNS record creation and updates

**Business Value:**

Professional custom domain management is essential for enterprise white-labeling. Organizations expect to access their platform at `platform.company.com` rather than `company.coolify.io`. This schema enables:
- Complete brand consistency across all customer touchpoints
- SEO benefits from branded domains
- Professional appearance for enterprise customers
- Compliance with corporate IT policies requiring company-owned domains
- Multi-region deployments with geographic DNS routing

**Technical Architecture:**

The schema follows a hierarchical domain model:
- **OrganizationDomains** - Top-level domain ownership and configuration
- **DnsRecords** - Individual DNS records (A, AAAA, CNAME, MX, TXT, etc.)
- **SslCertificates** - Certificate storage and renewal tracking
- **DomainVerifications** - Ownership verification workflow state
- **ApplicationDomainBindings** - Many-to-many relationship between applications and domains

All tables include organization_id foreign keys for multi-tenant data isolation and use soft deletes for audit trail preservation.

## Acceptance Criteria

- [ ] Migration created for organization_domains table with all required columns
- [ ] Migration created for dns_records table with polymorphic relationships
- [ ] Migration created for ssl_certificates table with automatic renewal tracking
- [ ] Migration created for domain_verifications table with verification methods
- [ ] Migration created for application_domain_bindings pivot table
- [ ] All foreign key constraints defined with proper cascade rules
- [ ] Indexes created on frequently queried columns (organization_id, domain_name, status)
- [ ] Composite indexes created for multi-column queries
- [ ] Unique constraints enforced on domain names per organization
- [ ] JSON columns used for flexible data storage (dns_config, ssl_config)
- [ ] Timestamp columns (created_at, updated_at, verified_at, expires_at) included
- [ ] Soft deletes implemented on all tables for audit trail
- [ ] Database migrations rollback successfully without errors
- [ ] Comprehensive migration tests written and passing
- [ ] Documentation includes schema diagrams and column descriptions

## Technical Details

### File Paths

**Database Migrations:**
- `/home/topgun/topgun/database/migrations/YYYY_MM_DD_HHMMSS_create_organization_domains_table.php`
- `/home/topgun/topgun/database/migrations/YYYY_MM_DD_HHMMSS_create_dns_records_table.php`
- `/home/topgun/topgun/database/migrations/YYYY_MM_DD_HHMMSS_create_ssl_certificates_table.php`
- `/home/topgun/topgun/database/migrations/YYYY_MM_DD_HHMMSS_create_domain_verifications_table.php`
- `/home/topgun/topgun/database/migrations/YYYY_MM_DD_HHMMSS_create_application_domain_bindings_table.php`

**Model Files (Created in Later Tasks):**
- `/home/topgun/topgun/app/Models/Enterprise/OrganizationDomain.php`
- `/home/topgun/topgun/app/Models/Enterprise/DnsRecord.php`
- `/home/topgun/topgun/app/Models/Enterprise/SslCertificate.php`
- `/home/topgun/topgun/app/Models/Enterprise/DomainVerification.php`

**Test Files:**
- `/home/topgun/topgun/tests/Unit/Database/DomainSchemaMigrationTest.php`

### Database Schema

#### 1. Organization Domains Table

Primary table storing top-level domain ownership and configuration.

**Migration File:** `database/migrations/YYYY_MM_DD_HHMMSS_create_organization_domains_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('organization_domains', function (Blueprint $table) {
            $table->id();
            $table->foreignId('organization_id')
                ->constrained('organizations')
                ->cascadeOnDelete();

            // Domain information
            $table->string('domain_name')->index();
            $table->string('subdomain')->nullable()->index();
            $table->string('full_domain')->virtualAs(
                "CASE WHEN subdomain IS NOT NULL
                 THEN CONCAT(subdomain, '.', domain_name)
                 ELSE domain_name END"
            )->index();

            // Domain status and type
            $table->enum('status', [
                'pending_verification',
                'verified',
                'active',
                'suspended',
                'expired',
                'error'
            ])->default('pending_verification')->index();

            $table->enum('domain_type', [
                'platform',      // Primary platform domain (platform.acme.com)
                'application',   // Application-specific domain (app.acme.com)
                'wildcard',      // Wildcard domain (*.acme.com)
                'custom'         // Custom domain for specific use
            ])->default('application');

            // Registrar information
            $table->string('registrar')->nullable(); // namecheap, route53, cloudflare, etc.
            $table->string('registrar_domain_id')->nullable(); // External registrar ID
            $table->boolean('managed_externally')->default(false); // DNS managed outside platform

            // DNS configuration
            $table->string('dns_provider')->nullable(); // cloudflare, route53, digitalocean, etc.
            $table->string('dns_zone_id')->nullable(); // External DNS zone ID
            $table->json('dns_config')->nullable(); // Provider-specific DNS settings

            // SSL/TLS configuration
            $table->boolean('ssl_enabled')->default(true);
            $table->enum('ssl_provider', [
                'letsencrypt',
                'custom',
                'cloudflare',
                'none'
            ])->default('letsencrypt');
            $table->boolean('auto_renew_ssl')->default(true);

            // Verification
            $table->string('verification_method')->nullable(); // dns_txt, file_upload, email
            $table->string('verification_token')->nullable();
            $table->timestamp('verified_at')->nullable();
            $table->timestamp('verification_expires_at')->nullable();

            // Domain expiration (for registered domains)
            $table->timestamp('registered_at')->nullable();
            $table->timestamp('expires_at')->nullable()->index();
            $table->boolean('auto_renew')->default(true);

            // Performance and security
            $table->boolean('cdn_enabled')->default(false);
            $table->string('cdn_provider')->nullable(); // cloudflare, fastly, etc.
            $table->boolean('force_https')->default(true);
            $table->boolean('hsts_enabled')->default(true);

            // Metadata
            $table->text('notes')->nullable();
            $table->json('metadata')->nullable(); // Additional flexible data
            $table->timestamp('last_checked_at')->nullable();
            $table->text('error_message')->nullable();

            $table->timestamps();
            $table->softDeletes();

            // Indexes
            $table->unique(['organization_id', 'domain_name', 'subdomain'], 'unique_org_domain');
            $table->index(['status', 'expires_at'], 'status_expiration_index');
            $table->index(['organization_id', 'domain_type'], 'org_type_index');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('organization_domains');
    }
};
```

**Column Descriptions:**

- `domain_name`: Base domain (e.g., "acme.com")
- `subdomain`: Optional subdomain (e.g., "platform" for platform.acme.com)
- `full_domain`: Virtual column combining subdomain + domain_name for easy querying
- `status`: Current domain state in verification/activation lifecycle
- `domain_type`: Purpose classification for business logic routing
- `registrar`: Domain registrar name for renewal/transfer operations
- `dns_provider`: DNS hosting service for record management
- `dns_zone_id`: External DNS zone identifier for API operations
- `dns_config`: JSON storage for provider-specific settings (nameservers, DNSSEC, etc.)
- `ssl_provider`: Certificate authority or provider
- `verification_method`: How domain ownership is verified
- `verification_token`: Unique token for ownership verification
- `verified_at`: Timestamp when ownership was confirmed
- `expires_at`: Domain registration expiration date
- `cdn_enabled`: Whether CDN is active for this domain
- `force_https`: Enforce HTTPS redirects
- `hsts_enabled`: HTTP Strict Transport Security header enabled
- `metadata`: Flexible JSON storage for future extensibility

---

#### 2. DNS Records Table

Stores individual DNS records with polymorphic relationships to resources.

**Migration File:** `database/migrations/YYYY_MM_DD_HHMMSS_create_dns_records_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('dns_records', function (Blueprint $table) {
            $table->id();
            $table->foreignId('organization_id')
                ->constrained('organizations')
                ->cascadeOnDelete();

            $table->foreignId('organization_domain_id')
                ->constrained('organization_domains')
                ->cascadeOnDelete();

            // Polymorphic relationship to resource (Application, Server, etc.)
            $table->morphs('recordable'); // recordable_id, recordable_type

            // DNS record details
            $table->enum('record_type', [
                'A',
                'AAAA',
                'CNAME',
                'MX',
                'TXT',
                'SRV',
                'CAA',
                'NS',
                'SOA',
                'PTR'
            ])->index();

            $table->string('name')->index(); // Record name/hostname
            $table->text('value'); // Record value/target
            $table->integer('ttl')->default(3600); // Time to live in seconds
            $table->integer('priority')->nullable(); // For MX, SRV records
            $table->integer('weight')->nullable(); // For SRV records
            $table->integer('port')->nullable(); // For SRV records

            // Record status
            $table->enum('status', [
                'pending',
                'active',
                'syncing',
                'error',
                'disabled'
            ])->default('pending')->index();

            // Provider sync information
            $table->string('external_record_id')->nullable(); // Provider's record ID
            $table->timestamp('last_synced_at')->nullable();
            $table->timestamp('propagation_checked_at')->nullable();
            $table->boolean('propagated')->default(false);

            // Metadata
            $table->boolean('managed_by_system')->default(true); // Auto-managed or manual
            $table->boolean('proxy_enabled')->default(false); // For Cloudflare proxy
            $table->text('notes')->nullable();
            $table->json('metadata')->nullable();
            $table->text('error_message')->nullable();

            $table->timestamps();
            $table->softDeletes();

            // Indexes
            $table->index(['organization_domain_id', 'record_type'], 'domain_type_index');
            $table->index(['organization_id', 'status'], 'org_status_index');
            $table->index(['recordable_type', 'recordable_id'], 'recordable_index');
            $table->unique(['organization_domain_id', 'record_type', 'name', 'value'], 'unique_dns_record');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('dns_records');
    }
};
```

**Column Descriptions:**

- `organization_domain_id`: Parent domain this record belongs to
- `recordable_type/recordable_id`: Polymorphic relation to Application, Server, etc.
- `record_type`: DNS record type (A, AAAA, CNAME, MX, TXT, SRV, CAA, NS, SOA, PTR)
- `name`: Record hostname (e.g., "www", "@" for root, "mail")
- `value`: Record value (IP address, domain name, text value)
- `ttl`: Time to live in seconds (default 3600 = 1 hour)
- `priority`: MX/SRV record priority (lower = higher priority)
- `weight`: SRV record load balancing weight
- `port`: SRV record service port
- `status`: Record lifecycle state
- `external_record_id`: Provider's internal record ID for updates
- `last_synced_at`: Last successful sync with DNS provider
- `propagated`: Whether record has propagated globally
- `managed_by_system`: Auto-managed vs. manually created
- `proxy_enabled`: Cloudflare proxy/CDN enabled for this record

---

#### 3. SSL Certificates Table

Stores SSL/TLS certificates with automatic renewal tracking.

**Migration File:** `database/migrations/YYYY_MM_DD_HHMMSS_create_ssl_certificates_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('ssl_certificates', function (Blueprint $table) {
            $table->id();
            $table->foreignId('organization_id')
                ->constrained('organizations')
                ->cascadeOnDelete();

            $table->foreignId('organization_domain_id')
                ->constrained('organization_domains')
                ->cascadeOnDelete();

            // Certificate details
            $table->string('certificate_name')->nullable(); // Friendly name
            $table->enum('certificate_type', [
                'letsencrypt',
                'custom',
                'wildcard',
                'self_signed'
            ])->default('letsencrypt');

            // Certificate data (encrypted)
            $table->text('certificate')->nullable(); // PEM-encoded certificate
            $table->text('private_key')->nullable(); // PEM-encoded private key (encrypted)
            $table->text('certificate_chain')->nullable(); // Intermediate certificates
            $table->text('certificate_bundle')->nullable(); // Full bundle (cert + chain)

            // Certificate metadata
            $table->string('issuer')->nullable(); // Certificate authority
            $table->string('common_name')->index(); // Primary domain
            $table->json('subject_alternative_names')->nullable(); // Additional domains
            $table->string('serial_number')->nullable();
            $table->string('fingerprint')->nullable(); // SHA256 fingerprint

            // Validity period
            $table->timestamp('issued_at')->nullable();
            $table->timestamp('expires_at')->nullable()->index();
            $table->timestamp('last_renewed_at')->nullable();
            $table->timestamp('next_renewal_attempt_at')->nullable();

            // Auto-renewal configuration
            $table->boolean('auto_renew')->default(true);
            $table->integer('renewal_days_before_expiry')->default(30);
            $table->integer('renewal_attempts')->default(0);
            $table->timestamp('last_renewal_error_at')->nullable();
            $table->text('renewal_error_message')->nullable();

            // Certificate status
            $table->enum('status', [
                'pending',
                'active',
                'renewing',
                'expired',
                'revoked',
                'error'
            ])->default('pending')->index();

            // ACME challenge data (for Let's Encrypt)
            $table->string('acme_order_url')->nullable();
            $table->json('acme_challenge_data')->nullable();
            $table->enum('acme_challenge_type', [
                'http-01',
                'dns-01',
                'tls-alpn-01'
            ])->nullable();

            // Metadata
            $table->json('metadata')->nullable();
            $table->text('notes')->nullable();

            $table->timestamps();
            $table->softDeletes();

            // Indexes
            $table->index(['organization_id', 'status'], 'org_status_index');
            $table->index(['expires_at', 'auto_renew'], 'renewal_check_index');
            $table->index(['organization_domain_id', 'status'], 'domain_status_index');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('ssl_certificates');
    }
};
```

**Column Descriptions:**

- `certificate_name`: User-friendly name for certificate
- `certificate_type`: Source/type of certificate
- `certificate`: PEM-encoded X.509 certificate
- `private_key`: Encrypted PEM-encoded private key (uses Laravel encryption)
- `certificate_chain`: Intermediate CA certificates
- `certificate_bundle`: Full bundle for easy deployment
- `issuer`: Certificate authority name
- `common_name`: Primary domain covered by certificate
- `subject_alternative_names`: JSON array of additional domains (SANs)
- `serial_number`: Certificate serial number
- `fingerprint`: SHA256 fingerprint for verification
- `issued_at`: Certificate issuance date
- `expires_at`: Certificate expiration date
- `auto_renew`: Enable automatic renewal
- `renewal_days_before_expiry`: Days before expiry to start renewal
- `renewal_attempts`: Counter for retry tracking
- `acme_order_url`: Let's Encrypt order URL for status checking
- `acme_challenge_data`: ACME challenge verification data
- `acme_challenge_type`: Challenge method (HTTP-01, DNS-01, TLS-ALPN-01)

---

#### 4. Domain Verifications Table

Tracks domain ownership verification workflow and methods.

**Migration File:** `database/migrations/YYYY_MM_DD_HHMMSS_create_domain_verifications_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('domain_verifications', function (Blueprint $table) {
            $table->id();
            $table->foreignId('organization_id')
                ->constrained('organizations')
                ->cascadeOnDelete();

            $table->foreignId('organization_domain_id')
                ->constrained('organization_domains')
                ->cascadeOnDelete();

            // Verification method
            $table->enum('verification_method', [
                'dns_txt',      // DNS TXT record verification
                'dns_cname',    // DNS CNAME record verification
                'file_upload',  // HTTP file verification
                'email',        // Email verification (admin@domain.com)
                'meta_tag',     // HTML meta tag verification
                'acme_http',    // ACME HTTP-01 challenge
                'acme_dns'      // ACME DNS-01 challenge
            ])->index();

            // Verification data
            $table->string('verification_token')->unique();
            $table->string('verification_record_name')->nullable(); // DNS record name
            $table->text('verification_record_value')->nullable(); // DNS record value
            $table->string('verification_file_path')->nullable(); // HTTP file path
            $table->text('verification_file_content')->nullable(); // HTTP file content
            $table->string('verification_meta_tag')->nullable(); // HTML meta tag

            // Verification status
            $table->enum('status', [
                'pending',
                'verifying',
                'verified',
                'failed',
                'expired'
            ])->default('pending')->index();

            // Verification attempts
            $table->integer('verification_attempts')->default(0);
            $table->timestamp('last_verification_attempt_at')->nullable();
            $table->timestamp('verified_at')->nullable();
            $table->timestamp('expires_at')->nullable()->index();

            // Error tracking
            $table->text('error_message')->nullable();
            $table->json('verification_logs')->nullable(); // Detailed verification logs

            // Challenge data (for ACME)
            $table->json('challenge_data')->nullable();

            // Metadata
            $table->string('verification_ip')->nullable(); // IP that completed verification
            $table->string('verification_user_agent')->nullable();
            $table->json('metadata')->nullable();

            $table->timestamps();
            $table->softDeletes();

            // Indexes
            $table->index(['organization_id', 'status'], 'org_status_index');
            $table->index(['organization_domain_id', 'verification_method'], 'domain_method_index');
            $table->index(['status', 'expires_at'], 'status_expiry_index');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('domain_verifications');
    }
};
```

**Column Descriptions:**

- `verification_method`: Method used to verify domain ownership
- `verification_token`: Unique random token for verification
- `verification_record_name`: DNS record name to create (e.g., "_coolify-verification")
- `verification_record_value`: DNS record value containing token
- `verification_file_path`: HTTP file path for file verification (e.g., /.well-known/coolify-verification.txt)
- `verification_file_content`: Content to serve in verification file
- `verification_meta_tag`: HTML meta tag to add to homepage
- `status`: Current verification state
- `verification_attempts`: Counter for retry tracking
- `verified_at`: Timestamp when verification succeeded
- `expires_at`: Verification expiration (typically 7 days)
- `verification_logs`: JSON array of verification attempt details
- `challenge_data`: ACME challenge-specific data
- `verification_ip`: IP address that completed verification

---

#### 5. Application Domain Bindings Table

Many-to-many pivot table linking applications to custom domains.

**Migration File:** `database/migrations/YYYY_MM_DD_HHMMSS_create_application_domain_bindings_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('application_domain_bindings', function (Blueprint $table) {
            $table->id();
            $table->foreignId('organization_id')
                ->constrained('organizations')
                ->cascadeOnDelete();

            $table->foreignId('application_id')
                ->constrained('applications')
                ->cascadeOnDelete();

            $table->foreignId('organization_domain_id')
                ->constrained('organization_domains')
                ->cascadeOnDelete();

            $table->foreignId('server_id')
                ->nullable()
                ->constrained('servers')
                ->nullOnDelete();

            // Binding configuration
            $table->string('subdomain')->nullable(); // Optional subdomain override
            $table->string('path')->default('/'); // URL path (for path-based routing)
            $table->integer('port')->nullable(); // Application port

            // Proxy configuration
            $table->enum('proxy_type', [
                'nginx',
                'traefik',
                'caddy',
                'cloudflare'
            ])->default('nginx');

            $table->json('proxy_config')->nullable(); // Proxy-specific settings

            // SSL/TLS settings
            $table->boolean('ssl_enabled')->default(true);
            $table->foreignId('ssl_certificate_id')
                ->nullable()
                ->constrained('ssl_certificates')
                ->nullOnDelete();

            $table->boolean('force_https')->default(true);
            $table->boolean('hsts_enabled')->default(true);

            // Health check configuration
            $table->string('health_check_path')->default('/');
            $table->integer('health_check_interval')->default(30); // seconds
            $table->integer('health_check_timeout')->default(5); // seconds
            $table->timestamp('last_health_check_at')->nullable();
            $table->enum('health_status', [
                'unknown',
                'healthy',
                'unhealthy',
                'degraded'
            ])->default('unknown');

            // Binding status
            $table->enum('status', [
                'pending',
                'configuring',
                'active',
                'error',
                'disabled'
            ])->default('pending')->index();

            // Traffic routing
            $table->boolean('is_primary')->default(false); // Primary domain for app
            $table->integer('traffic_weight')->default(100); // For A/B testing, canary

            // Metadata
            $table->timestamp('activated_at')->nullable();
            $table->text('error_message')->nullable();
            $table->json('metadata')->nullable();

            $table->timestamps();
            $table->softDeletes();

            // Indexes
            $table->unique(['application_id', 'organization_domain_id', 'subdomain'], 'unique_app_domain_binding');
            $table->index(['organization_id', 'status'], 'org_status_index');
            $table->index(['application_id', 'is_primary'], 'app_primary_index');
            $table->index(['health_status', 'last_health_check_at'], 'health_check_index');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('application_domain_bindings');
    }
};
```

**Column Descriptions:**

- `application_id`: Application this binding belongs to
- `organization_domain_id`: Domain being bound to application
- `server_id`: Server where application is deployed
- `subdomain`: Optional subdomain override (e.g., "api" for api.acme.com)
- `path`: URL path for path-based routing (default "/")
- `port`: Application port on server
- `proxy_type`: Reverse proxy type (nginx, traefik, caddy, cloudflare)
- `proxy_config`: JSON configuration for proxy setup
- `ssl_certificate_id`: SSL certificate for this binding
- `force_https`: Enforce HTTPS redirects
- `hsts_enabled`: HTTP Strict Transport Security
- `health_check_path`: Endpoint to check for application health
- `health_check_interval`: Seconds between health checks
- `health_status`: Current health state
- `is_primary`: Whether this is the primary domain for the application
- `traffic_weight`: Percentage of traffic (for A/B testing)
- `activated_at`: When binding became active

---

### Database Relationships Diagram

```
organizations
    └─── organization_domains (1:N)
            ├─── dns_records (1:N)
            │      └─── recordable (polymorphic: Application, Server)
            │
            ├─── ssl_certificates (1:N)
            │
            ├─── domain_verifications (1:N)
            │
            └─── application_domain_bindings (1:N)
                    ├─── applications (N:1)
                    ├─── servers (N:1)
                    └─── ssl_certificates (N:1)
```

### Indexes Strategy

**High-Priority Indexes (Query Performance):**

1. `organization_id` - Multi-tenant isolation (all tables)
2. `status` - Filtering by lifecycle state (all tables)
3. `organization_id + status` - Composite for common queries
4. `expires_at` - Renewal/expiration queries
5. `domain_name` - Domain lookups
6. `full_domain` - Full domain queries
7. `recordable_type + recordable_id` - Polymorphic lookups

**Unique Constraints:**

1. `organization_id + domain_name + subdomain` - Prevent duplicate domains
2. `organization_domain_id + record_type + name + value` - Prevent duplicate DNS records
3. `application_id + organization_domain_id + subdomain` - Prevent duplicate bindings
4. `verification_token` - Ensure unique verification tokens

## Implementation Approach

### Step 1: Create Organization Domains Migration
```bash
php artisan make:migration create_organization_domains_table
```
1. Add all columns from schema above
2. Define foreign keys with cascade rules
3. Add indexes for performance
4. Add unique constraints
5. Add virtual column for full_domain

### Step 2: Create DNS Records Migration
```bash
php artisan make:migration create_dns_records_table
```
1. Add polymorphic relationship columns
2. Define all DNS record type enums
3. Add provider sync tracking columns
4. Define unique constraint on record combination
5. Add indexes for common queries

### Step 3: Create SSL Certificates Migration
```bash
php artisan make:migration create_ssl_certificates_table
```
1. Add certificate storage columns
2. Add renewal tracking columns
3. Add ACME challenge columns
4. Define indexes for renewal queries
5. Add metadata JSON column

### Step 4: Create Domain Verifications Migration
```bash
php artisan make:migration create_domain_verifications_table
```
1. Add verification method columns
2. Add verification data columns for each method
3. Add status tracking columns
4. Add unique constraint on verification_token
5. Add indexes for verification queries

### Step 5: Create Application Domain Bindings Migration
```bash
php artisan make:migration create_application_domain_bindings_table
```
1. Add foreign keys to applications, domains, servers
2. Add proxy configuration columns
3. Add health check columns
4. Add traffic routing columns
5. Define unique constraint on app+domain+subdomain

### Step 6: Run Migrations
```bash
php artisan migrate
```
1. Verify all tables created successfully
2. Check foreign key constraints
3. Verify indexes exist
4. Test rollback functionality

### Step 7: Create Seeders for Testing
```bash
php artisan make:seeder DomainManagementSeeder
```
1. Create sample organization domains
2. Create sample DNS records
3. Create sample SSL certificates
4. Create sample domain verifications
5. Create sample application bindings

### Step 8: Write Migration Tests
1. Test table creation
2. Test foreign key constraints
3. Test unique constraints
4. Test indexes exist
5. Test rollback functionality

## Test Strategy

### Migration Tests

**File:** `tests/Unit/Database/DomainSchemaMigrationTest.php`

```php
<?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

it('creates organization_domains table with correct schema', function () {
    expect(Schema::hasTable('organization_domains'))->toBeTrue();

    expect(Schema::hasColumns('organization_domains', [
        'id',
        'organization_id',
        'domain_name',
        'subdomain',
        'full_domain',
        'status',
        'domain_type',
        'registrar',
        'dns_provider',
        'dns_zone_id',
        'dns_config',
        'ssl_enabled',
        'ssl_provider',
        'auto_renew_ssl',
        'verification_method',
        'verification_token',
        'verified_at',
        'expires_at',
        'created_at',
        'updated_at',
        'deleted_at',
    ]))->toBeTrue();
});

it('has correct foreign key constraints on organization_domains', function () {
    $foreignKeys = DB::select("
        SELECT CONSTRAINT_NAME, REFERENCED_TABLE_NAME
        FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE
        WHERE TABLE_NAME = 'organization_domains'
        AND REFERENCED_TABLE_NAME IS NOT NULL
    ");

    expect($foreignKeys)->toHaveCount(1)
        ->and($foreignKeys[0]->REFERENCED_TABLE_NAME)->toBe('organizations');
});

it('has correct indexes on organization_domains', function () {
    $indexes = DB::select("SHOW INDEXES FROM organization_domains");
    $indexNames = array_map(fn($idx) => $idx->Key_name, $indexes);

    expect($indexNames)->toContain('unique_org_domain')
        ->toContain('domain_name')
        ->toContain('status')
        ->toContain('expires_at');
});

it('creates dns_records table with correct schema', function () {
    expect(Schema::hasTable('dns_records'))->toBeTrue();

    expect(Schema::hasColumns('dns_records', [
        'id',
        'organization_id',
        'organization_domain_id',
        'recordable_type',
        'recordable_id',
        'record_type',
        'name',
        'value',
        'ttl',
        'priority',
        'status',
        'external_record_id',
        'last_synced_at',
        'propagated',
        'managed_by_system',
        'created_at',
        'updated_at',
        'deleted_at',
    ]))->toBeTrue();
});

it('has polymorphic relationship columns on dns_records', function () {
    expect(Schema::hasColumns('dns_records', [
        'recordable_type',
        'recordable_id'
    ]))->toBeTrue();
});

it('creates ssl_certificates table with correct schema', function () {
    expect(Schema::hasTable('ssl_certificates'))->toBeTrue();

    expect(Schema::hasColumns('ssl_certificates', [
        'id',
        'organization_id',
        'organization_domain_id',
        'certificate_name',
        'certificate_type',
        'certificate',
        'private_key',
        'certificate_chain',
        'issuer',
        'common_name',
        'subject_alternative_names',
        'issued_at',
        'expires_at',
        'auto_renew',
        'status',
        'acme_order_url',
        'acme_challenge_data',
        'created_at',
        'updated_at',
        'deleted_at',
    ]))->toBeTrue();
});

it('creates domain_verifications table with correct schema', function () {
    expect(Schema::hasTable('domain_verifications'))->toBeTrue();

    expect(Schema::hasColumns('domain_verifications', [
        'id',
        'organization_id',
        'organization_domain_id',
        'verification_method',
        'verification_token',
        'verification_record_name',
        'verification_record_value',
        'status',
        'verification_attempts',
        'verified_at',
        'expires_at',
        'created_at',
        'updated_at',
        'deleted_at',
    ]))->toBeTrue();
});

it('has unique constraint on verification_token', function () {
    $indexes = DB::select("SHOW INDEXES FROM domain_verifications WHERE Key_name = 'verification_token'");

    expect($indexes)->toHaveCount(1)
        ->and($indexes[0]->Non_unique)->toBe(0); // 0 = unique
});

it('creates application_domain_bindings table with correct schema', function () {
    expect(Schema::hasTable('application_domain_bindings'))->toBeTrue();

    expect(Schema::hasColumns('application_domain_bindings', [
        'id',
        'organization_id',
        'application_id',
        'organization_domain_id',
        'server_id',
        'subdomain',
        'path',
        'port',
        'proxy_type',
        'ssl_enabled',
        'ssl_certificate_id',
        'force_https',
        'health_check_path',
        'health_status',
        'status',
        'is_primary',
        'created_at',
        'updated_at',
        'deleted_at',
    ]))->toBeTrue();
});

it('has correct foreign key constraints on application_domain_bindings', function () {
    $foreignKeys = DB::select("
        SELECT CONSTRAINT_NAME, REFERENCED_TABLE_NAME
        FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE
        WHERE TABLE_NAME = 'application_domain_bindings'
        AND REFERENCED_TABLE_NAME IS NOT NULL
    ");

    $referencedTables = array_map(fn($fk) => $fk->REFERENCED_TABLE_NAME, $foreignKeys);

    expect($referencedTables)->toContain('organizations')
        ->toContain('applications')
        ->toContain('organization_domains')
        ->toContain('servers')
        ->toContain('ssl_certificates');
});

it('can rollback all domain management migrations', function () {
    // Run migrations
    $this->artisan('migrate');

    // Rollback
    $this->artisan('migrate:rollback');

    expect(Schema::hasTable('organization_domains'))->toBeFalse()
        ->and(Schema::hasTable('dns_records'))->toBeFalse()
        ->and(Schema::hasTable('ssl_certificates'))->toBeFalse()
        ->and(Schema::hasTable('domain_verifications'))->toBeFalse()
        ->and(Schema::hasTable('application_domain_bindings'))->toBeFalse();

    // Re-run migrations for subsequent tests
    $this->artisan('migrate');
});
```

### Integration Tests

**File:** `tests/Feature/Database/DomainDataIntegrityTest.php`

```php
<?php

use App\Models\Organization;
use App\Models\Application;
use App\Models\Server;
use Illuminate\Support\Facades\DB;

it('enforces unique constraint on organization domain', function () {
    $organization = Organization::factory()->create();

    DB::table('organization_domains')->insert([
        'organization_id' => $organization->id,
        'domain_name' => 'acme.com',
        'subdomain' => 'platform',
        'status' => 'pending_verification',
        'created_at' => now(),
        'updated_at' => now(),
    ]);

    // Attempt to insert duplicate
    expect(fn () => DB::table('organization_domains')->insert([
        'organization_id' => $organization->id,
        'domain_name' => 'acme.com',
        'subdomain' => 'platform',
        'status' => 'pending_verification',
        'created_at' => now(),
        'updated_at' => now(),
    ]))->toThrow(\Illuminate\Database\QueryException::class);
});

it('cascades delete from organization to domains', function () {
    $organization = Organization::factory()->create();

    $domainId = DB::table('organization_domains')->insertGetId([
        'organization_id' => $organization->id,
        'domain_name' => 'acme.com',
        'status' => 'pending_verification',
        'created_at' => now(),
        'updated_at' => now(),
    ]);

    // Delete organization
    $organization->delete();

    // Verify domain was cascade deleted
    $domain = DB::table('organization_domains')->find($domainId);
    expect($domain)->toBeNull();
});

it('cascades delete from domain to dns records', function () {
    $organization = Organization::factory()->create();

    $domainId = DB::table('organization_domains')->insertGetId([
        'organization_id' => $organization->id,
        'domain_name' => 'acme.com',
        'status' => 'verified',
        'created_at' => now(),
        'updated_at' => now(),
    ]);

    $recordId = DB::table('dns_records')->insertGetId([
        'organization_id' => $organization->id,
        'organization_domain_id' => $domainId,
        'record_type' => 'A',
        'name' => '@',
        'value' => '1.2.3.4',
        'ttl' => 3600,
        'status' => 'active',
        'created_at' => now(),
        'updated_at' => now(),
    ]);

    // Delete domain
    DB::table('organization_domains')->where('id', $domainId)->delete();

    // Verify DNS record was cascade deleted
    $record = DB::table('dns_records')->find($recordId);
    expect($record)->toBeNull();
});

it('allows null server_id on application_domain_bindings', function () {
    $organization = Organization::factory()->create();
    $application = Application::factory()->create();

    $domainId = DB::table('organization_domains')->insertGetId([
        'organization_id' => $organization->id,
        'domain_name' => 'acme.com',
        'status' => 'verified',
        'created_at' => now(),
        'updated_at' => now(),
    ]);

    // Insert binding without server_id
    $bindingId = DB::table('application_domain_bindings')->insertGetId([
        'organization_id' => $organization->id,
        'application_id' => $application->id,
        'organization_domain_id' => $domainId,
        'server_id' => null,
        'path' => '/',
        'status' => 'pending',
        'created_at' => now(),
        'updated_at' => now(),
    ]);

    expect($bindingId)->toBeGreaterThan(0);
});
```

## Definition of Done

- [ ] Migration created for organization_domains table
- [ ] Migration created for dns_records table
- [ ] Migration created for ssl_certificates table
- [ ] Migration created for domain_verifications table
- [ ] Migration created for application_domain_bindings table
- [ ] All foreign key constraints defined correctly
- [ ] All indexes created for performance optimization
- [ ] Unique constraints enforced on appropriate columns
- [ ] JSON columns defined for flexible data storage
- [ ] Soft deletes implemented on all tables
- [ ] Virtual column created for full_domain
- [ ] Polymorphic relationship columns added to dns_records
- [ ] Migration rollback tested successfully
- [ ] Unit tests written for schema validation (10+ tests)
- [ ] Integration tests written for data integrity (5+ tests)
- [ ] Migration runs without errors on fresh database
- [ ] Schema documentation complete with column descriptions
- [ ] Database diagram created showing relationships
- [ ] Code follows Laravel 12 migration best practices
- [ ] PHPStan level 5 passing on migration files
- [ ] Code reviewed and approved

## Related Tasks

- **Depends on:** None (foundation task)
- **Enables:** Task 63 (DomainRegistrarInterface and factory pattern)
- **Enables:** Task 64 (Namecheap API integration)
- **Enables:** Task 65 (Route53 Domains API integration)
- **Enables:** Task 66 (DomainRegistrarService implementation)
- **Enables:** Task 67 (DnsManagementService for automated DNS records)
- **Enables:** Task 68 (Let's Encrypt SSL certificate provisioning)
- **Enables:** Task 69 (Domain ownership verification)
- **Enables:** Task 70 (Vue.js domain management components)
