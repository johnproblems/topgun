---
name: Integrate PayPal payment gateway
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:39:01Z
github: https://github.com/johnproblems/topgun/issues/154
depends_on: [43]
parallel: false
conflicts_with: []
---

# Task: Integrate PayPal payment gateway

## Description

Implement a comprehensive PayPal payment gateway integration as the second supported payment provider in the enterprise payment processing system. This integration enables organizations to accept payments through PayPal balance, PayPal Credit, and credit/debit cards via PayPal's hosted checkout experience. The implementation follows the payment gateway factory pattern established in Task 43, providing a seamless multi-gateway payment infrastructure.

**PayPal Integration Capabilities:**

1. **Multiple Payment Methods**: Accept PayPal balance, PayPal Credit, Venmo (US), and all major credit/debit cards
2. **Subscription Management**: Create, update, pause, resume, and cancel recurring PayPal subscriptions
3. **One-Time Payments**: Process single payments for upgrades, overages, and add-ons
4. **Webhook Processing**: Handle real-time payment notifications with HMAC-SHA256 signature verification
5. **Automatic Payment Method Storage**: Save customer payment methods for future transactions
6. **Dispute Handling**: Receive and process chargeback and dispute notifications
7. **Refund Processing**: Full and partial refunds with automatic account reconciliation
8. **3D Secure Support**: PSD2 compliance for European payments

**Why PayPal Integration is Critical:**

PayPal remains the most widely adopted digital wallet globally, with over 400 million active accounts. Many organizations prefer PayPal for its:
- **Trust Factor**: Established brand recognition reduces payment friction
- **Global Reach**: Supports 200+ countries and 25+ currencies
- **Buyer Protection**: Reduces perceived risk for new customers
- **No Upfront Fees**: Pay-as-you-go pricing aligns with startup budgets
- **Quick Checkout**: One-click payments for existing PayPal users

For the white-label platform, offering PayPal alongside Stripe provides:
- **Payment Method Diversity**: Customers choose their preferred payment method
- **Geographic Coverage**: PayPal's strength in Europe complements Stripe's US dominance
- **Risk Mitigation**: Avoid vendor lock-in with multiple payment processors
- **Higher Conversion**: Studies show 20-30% lift when offering PayPal as an option

**Technical Integration Approach:**

This implementation uses **PayPal REST API v2** with the **Orders API** for one-time payments and **Subscriptions API** for recurring billing. Unlike Stripe's card tokenization approach, PayPal utilizes a redirect-based checkout flow:

1. **Checkout Initiation**: Create PayPal Order â†’ Redirect customer to PayPal-hosted checkout
2. **Customer Authorization**: Customer logs into PayPal and approves payment
3. **Return to Platform**: Customer redirected back with authorization token
4. **Payment Capture**: Backend captures authorized payment and processes order

For subscriptions, PayPal provides a similar flow but creates a Billing Agreement for recurring charges without repeated customer authentication.

**Integration Points:**

- **PaymentGatewayInterface Implementation**: `PayPalGateway` implements the standard gateway interface from Task 43
- **PaymentService Integration**: Registered in the gateway factory for automatic selection based on organization preferences
- **Webhook Controller**: Dedicated route `/webhooks/paypal` for PayPal IPN (Instant Payment Notifications)
- **Frontend Components**: Payment method selection UI includes PayPal button with branding
- **Database**: PayPal transaction IDs, subscription IDs, and webhook events stored in existing payment tables

**Webhook Event Handling:**

PayPal sends webhook notifications for 50+ event types. Critical events implemented:
- `PAYMENT.SALE.COMPLETED` - One-time payment successful
- `PAYMENT.SALE.REFUNDED` - Refund processed
- `BILLING.SUBSCRIPTION.ACTIVATED` - Subscription started
- `BILLING.SUBSCRIPTION.CANCELLED` - Subscription canceled
- `BILLING.SUBSCRIPTION.PAYMENT.FAILED` - Recurring payment failure
- `CUSTOMER.DISPUTE.CREATED` - Chargeback initiated

**Dependencies:**

- **Task 43**: `PaymentGatewayInterface` and factory pattern must be implemented first
- **Task 42**: Database schema for transactions, subscriptions, and payment methods
- **Task 50**: Frontend payment components for PayPal button integration

**Why This Task is Important:**

Single payment provider dependency is a critical business risk. PayPal integration provides redundancy, expands market reach, and increases conversion rates. Organizations operating in Europe, Latin America, or Asia-Pacific markets rely heavily on PayPal where Stripe may have limited adoption. The multi-gateway architecture positions the platform as enterprise-ready with professional payment infrastructure that scales globally.

## Acceptance Criteria

- [ ] PayPalGateway class implements PaymentGatewayInterface from Task 43
- [ ] PayPal REST API v2 client configured with sandbox and production environments
- [ ] OAuth 2.0 authentication implemented for API access (client credentials flow)
- [ ] One-time payment processing via Orders API (create, capture, refund)
- [ ] Subscription creation via Billing Plans and Subscriptions API
- [ ] Subscription management (pause, resume, cancel, update)
- [ ] Payment method tokenization (PayPal Vault API for saved payment methods)
- [ ] Webhook endpoint `/webhooks/paypal` with HMAC-SHA256 signature verification
- [ ] Handle 10+ critical PayPal webhook event types
- [ ] Error handling with PayPal-specific error codes (INSTRUMENT_DECLINED, INSUFFICIENT_FUNDS, etc.)
- [ ] Idempotency support using PayPal-Request-Id header
- [ ] Refund processing (full and partial refunds)
- [ ] Transaction logging with PayPal transaction IDs
- [ ] PayPal Smart Payment Buttons integration for frontend
- [ ] Support for PayPal balance, PayPal Credit, Venmo (US), and credit/debit cards
- [ ] Multi-currency support (25+ currencies)
- [ ] 3D Secure (SCA) compliance for European payments
- [ ] Comprehensive error messages mapped to user-friendly text

## Technical Details

### File Paths

**PayPal Gateway Implementation:**
- `/home/topgun/topgun/app/Services/Enterprise/PaymentGateways/PayPalGateway.php` (new)

**PayPal API Client:**
- `/home/topgun/topgun/app/Services/Enterprise/PaymentGateways/PayPal/PayPalApiClient.php` (new)
- `/home/topgun/topgun/app/Services/Enterprise/PaymentGateways/PayPal/PayPalWebhookHandler.php` (new)

**Webhook Controller:**
- `/home/topgun/topgun/app/Http/Controllers/Webhooks/PayPalWebhookController.php` (new)

**Configuration:**
- `/home/topgun/topgun/config/payment-gateways.php` (modify - add PayPal config)

**Routes:**
- `/home/topgun/topgun/routes/webhooks.php` (modify - add PayPal webhook route)

**Database:**
- Uses existing tables from Task 42: `payment_transactions`, `organization_subscriptions`, `payment_methods`

### PayPal Configuration

**File:** `config/payment-gateways.php` (add PayPal section)

```php
<?php

return [
    'stripe' => [
        'key' => env('STRIPE_KEY'),
        'secret' => env('STRIPE_SECRET'),
        'webhook_secret' => env('STRIPE_WEBHOOK_SECRET'),
    ],

    'paypal' => [
        'mode' => env('PAYPAL_MODE', 'sandbox'), // 'sandbox' or 'live'
        'sandbox' => [
            'client_id' => env('PAYPAL_SANDBOX_CLIENT_ID'),
            'client_secret' => env('PAYPAL_SANDBOX_CLIENT_SECRET'),
            'webhook_id' => env('PAYPAL_SANDBOX_WEBHOOK_ID'),
        ],
        'live' => [
            'client_id' => env('PAYPAL_CLIENT_ID'),
            'client_secret' => env('PAYPAL_CLIENT_SECRET'),
            'webhook_id' => env('PAYPAL_WEBHOOK_ID'),
        ],
        'currency' => env('PAYPAL_CURRENCY', 'USD'),
        'return_url' => env('APP_URL') . '/payment/paypal/success',
        'cancel_url' => env('APP_URL') . '/payment/paypal/cancel',
    ],
];
```

**Environment Variables:**

```bash
# PayPal Configuration
PAYPAL_MODE=sandbox
PAYPAL_SANDBOX_CLIENT_ID=your_sandbox_client_id
PAYPAL_SANDBOX_CLIENT_SECRET=your_sandbox_client_secret
PAYPAL_SANDBOX_WEBHOOK_ID=your_sandbox_webhook_id
PAYPAL_CLIENT_ID=your_live_client_id
PAYPAL_CLIENT_SECRET=your_live_client_secret
PAYPAL_WEBHOOK_ID=your_live_webhook_id
PAYPAL_CURRENCY=USD
```

### PayPalGateway Implementation

**File:** `app/Services/Enterprise/PaymentGateways/PayPalGateway.php`

```php
<?php

namespace App\Services\Enterprise\PaymentGateways;

use App\Contracts\PaymentGatewayInterface;
use App\Models\Organization;
use App\Models\OrganizationSubscription;
use App\Models\PaymentMethod;
use App\Models\PaymentTransaction;
use App\Services\Enterprise\PaymentGateways\PayPal\PayPalApiClient;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Str;

class PayPalGateway implements PaymentGatewayInterface
{
    public function __construct(
        private PayPalApiClient $client
    ) {}

    /**
     * Get gateway identifier
     *
     * @return string
     */
    public function getName(): string
    {
        return 'paypal';
    }

    /**
     * Process one-time payment
     *
     * @param Organization $organization
     * @param float $amount
     * @param string $currency
     * @param array $metadata
     * @return PaymentTransaction
     */
    public function processPayment(
        Organization $organization,
        float $amount,
        string $currency = 'USD',
        array $metadata = []
    ): PaymentTransaction {
        try {
            // Create PayPal Order
            $order = $this->client->createOrder([
                'intent' => 'CAPTURE',
                'purchase_units' => [
                    [
                        'reference_id' => $organization->id,
                        'description' => $metadata['description'] ?? 'Payment',
                        'amount' => [
                            'currency_code' => $currency,
                            'value' => number_format($amount, 2, '.', ''),
                        ],
                    ],
                ],
                'application_context' => [
                    'brand_name' => $organization->whiteLabelConfig?->platform_name ?? config('app.name'),
                    'return_url' => config('payment-gateways.paypal.return_url'),
                    'cancel_url' => config('payment-gateways.paypal.cancel_url'),
                    'user_action' => 'PAY_NOW',
                ],
            ]);

            // Store transaction with pending status
            $transaction = PaymentTransaction::create([
                'organization_id' => $organization->id,
                'payment_gateway' => 'paypal',
                'gateway_transaction_id' => $order['id'],
                'amount' => $amount,
                'currency' => $currency,
                'status' => 'pending',
                'metadata' => array_merge($metadata, [
                    'paypal_order_id' => $order['id'],
                    'approval_url' => $this->extractApprovalUrl($order),
                ]),
                'gateway_response' => $order,
            ]);

            Log::info('PayPal order created', [
                'organization_id' => $organization->id,
                'order_id' => $order['id'],
                'amount' => $amount,
            ]);

            return $transaction;
        } catch (\Exception $e) {
            Log::error('PayPal payment failed', [
                'organization_id' => $organization->id,
                'amount' => $amount,
                'error' => $e->getMessage(),
            ]);

            throw new \Exception('PayPal payment failed: ' . $e->getMessage());
        }
    }

    /**
     * Capture authorized PayPal payment
     *
     * @param string $orderId
     * @return PaymentTransaction
     */
    public function capturePayment(string $orderId): PaymentTransaction
    {
        try {
            $capture = $this->client->captureOrder($orderId);

            $transaction = PaymentTransaction::where('gateway_transaction_id', $orderId)->firstOrFail();

            $transaction->update([
                'status' => 'completed',
                'completed_at' => now(),
                'gateway_response' => $capture,
                'metadata' => array_merge($transaction->metadata ?? [], [
                    'capture_id' => $capture['purchase_units'][0]['payments']['captures'][0]['id'] ?? null,
                ]),
            ]);

            Log::info('PayPal payment captured', [
                'order_id' => $orderId,
                'transaction_id' => $transaction->id,
            ]);

            return $transaction;
        } catch (\Exception $e) {
            Log::error('PayPal capture failed', [
                'order_id' => $orderId,
                'error' => $e->getMessage(),
            ]);

            throw new \Exception('PayPal capture failed: ' . $e->getMessage());
        }
    }

    /**
     * Create recurring subscription
     *
     * @param Organization $organization
     * @param string $planId
     * @param PaymentMethod|null $paymentMethod
     * @param array $metadata
     * @return OrganizationSubscription
     */
    public function createSubscription(
        Organization $organization,
        string $planId,
        ?PaymentMethod $paymentMethod = null,
        array $metadata = []
    ): OrganizationSubscription {
        try {
            // Create PayPal Subscription
            $subscription = $this->client->createSubscription([
                'plan_id' => $planId,
                'custom_id' => (string) $organization->id,
                'application_context' => [
                    'brand_name' => $organization->whiteLabelConfig?->platform_name ?? config('app.name'),
                    'return_url' => config('payment-gateways.paypal.return_url'),
                    'cancel_url' => config('payment-gateways.paypal.cancel_url'),
                    'user_action' => 'SUBSCRIBE_NOW',
                ],
            ]);

            // Store subscription with pending status
            $orgSubscription = OrganizationSubscription::create([
                'organization_id' => $organization->id,
                'payment_gateway' => 'paypal',
                'gateway_subscription_id' => $subscription['id'],
                'gateway_plan_id' => $planId,
                'status' => 'pending',
                'metadata' => array_merge($metadata, [
                    'paypal_subscription_id' => $subscription['id'],
                    'approval_url' => $this->extractApprovalUrl($subscription),
                ]),
                'gateway_response' => $subscription,
            ]);

            Log::info('PayPal subscription created', [
                'organization_id' => $organization->id,
                'subscription_id' => $subscription['id'],
                'plan_id' => $planId,
            ]);

            return $orgSubscription;
        } catch (\Exception $e) {
            Log::error('PayPal subscription creation failed', [
                'organization_id' => $organization->id,
                'plan_id' => $planId,
                'error' => $e->getMessage(),
            ]);

            throw new \Exception('PayPal subscription failed: ' . $e->getMessage());
        }
    }

    /**
     * Cancel subscription
     *
     * @param OrganizationSubscription $subscription
     * @param string $reason
     * @return bool
     */
    public function cancelSubscription(OrganizationSubscription $subscription, string $reason = ''): bool
    {
        try {
            $this->client->cancelSubscription($subscription->gateway_subscription_id, $reason);

            $subscription->update([
                'status' => 'cancelled',
                'cancelled_at' => now(),
                'cancellation_reason' => $reason,
            ]);

            Log::info('PayPal subscription cancelled', [
                'subscription_id' => $subscription->id,
                'paypal_subscription_id' => $subscription->gateway_subscription_id,
                'reason' => $reason,
            ]);

            return true;
        } catch (\Exception $e) {
            Log::error('PayPal subscription cancellation failed', [
                'subscription_id' => $subscription->id,
                'error' => $e->getMessage(),
            ]);

            throw new \Exception('PayPal cancellation failed: ' . $e->getMessage());
        }
    }

    /**
     * Pause subscription
     *
     * @param OrganizationSubscription $subscription
     * @param string $reason
     * @return bool
     */
    public function pauseSubscription(OrganizationSubscription $subscription, string $reason = ''): bool
    {
        try {
            $this->client->suspendSubscription($subscription->gateway_subscription_id, $reason);

            $subscription->update([
                'status' => 'paused',
                'paused_at' => now(),
                'pause_reason' => $reason,
            ]);

            Log::info('PayPal subscription paused', [
                'subscription_id' => $subscription->id,
                'paypal_subscription_id' => $subscription->gateway_subscription_id,
            ]);

            return true;
        } catch (\Exception $e) {
            Log::error('PayPal subscription pause failed', [
                'subscription_id' => $subscription->id,
                'error' => $e->getMessage(),
            ]);

            throw new \Exception('PayPal pause failed: ' . $e->getMessage());
        }
    }

    /**
     * Resume paused subscription
     *
     * @param OrganizationSubscription $subscription
     * @return bool
     */
    public function resumeSubscription(OrganizationSubscription $subscription): bool
    {
        try {
            $this->client->activateSubscription($subscription->gateway_subscription_id);

            $subscription->update([
                'status' => 'active',
                'paused_at' => null,
                'pause_reason' => null,
            ]);

            Log::info('PayPal subscription resumed', [
                'subscription_id' => $subscription->id,
                'paypal_subscription_id' => $subscription->gateway_subscription_id,
            ]);

            return true;
        } catch (\Exception $e) {
            Log::error('PayPal subscription resume failed', [
                'subscription_id' => $subscription->id,
                'error' => $e->getMessage(),
            ]);

            throw new \Exception('PayPal resume failed: ' . $e->getMessage());
        }
    }

    /**
     * Process refund
     *
     * @param PaymentTransaction $transaction
     * @param float|null $amount
     * @param string $reason
     * @return PaymentTransaction
     */
    public function refundPayment(
        PaymentTransaction $transaction,
        ?float $amount = null,
        string $reason = ''
    ): PaymentTransaction {
        try {
            $captureId = $transaction->metadata['capture_id'] ?? null;

            if (!$captureId) {
                throw new \Exception('Capture ID not found for refund');
            }

            $refundAmount = $amount ?? $transaction->amount;

            $refund = $this->client->refundCapture($captureId, [
                'amount' => [
                    'currency_code' => $transaction->currency,
                    'value' => number_format($refundAmount, 2, '.', ''),
                ],
                'note_to_payer' => $reason,
            ]);

            $refundTransaction = PaymentTransaction::create([
                'organization_id' => $transaction->organization_id,
                'payment_gateway' => 'paypal',
                'gateway_transaction_id' => $refund['id'],
                'amount' => -$refundAmount,
                'currency' => $transaction->currency,
                'status' => 'completed',
                'type' => 'refund',
                'parent_transaction_id' => $transaction->id,
                'metadata' => [
                    'original_capture_id' => $captureId,
                    'reason' => $reason,
                ],
                'gateway_response' => $refund,
                'completed_at' => now(),
            ]);

            Log::info('PayPal refund processed', [
                'transaction_id' => $transaction->id,
                'refund_id' => $refund['id'],
                'amount' => $refundAmount,
            ]);

            return $refundTransaction;
        } catch (\Exception $e) {
            Log::error('PayPal refund failed', [
                'transaction_id' => $transaction->id,
                'error' => $e->getMessage(),
            ]);

            throw new \Exception('PayPal refund failed: ' . $e->getMessage());
        }
    }

    /**
     * Save payment method (PayPal Vault)
     *
     * @param Organization $organization
     * @param string $paymentToken
     * @param array $metadata
     * @return PaymentMethod
     */
    public function savePaymentMethod(
        Organization $organization,
        string $paymentToken,
        array $metadata = []
    ): PaymentMethod {
        try {
            // Store PayPal payment token (Vault API integration)
            $paymentMethod = PaymentMethod::create([
                'organization_id' => $organization->id,
                'payment_gateway' => 'paypal',
                'gateway_payment_method_id' => $paymentToken,
                'type' => 'paypal',
                'metadata' => $metadata,
                'is_default' => $organization->paymentMethods()->count() === 0,
            ]);

            Log::info('PayPal payment method saved', [
                'organization_id' => $organization->id,
                'payment_method_id' => $paymentMethod->id,
            ]);

            return $paymentMethod;
        } catch (\Exception $e) {
            Log::error('PayPal payment method save failed', [
                'organization_id' => $organization->id,
                'error' => $e->getMessage(),
            ]);

            throw new \Exception('Failed to save PayPal payment method: ' . $e->getMessage());
        }
    }

    /**
     * Delete payment method
     *
     * @param PaymentMethod $paymentMethod
     * @return bool
     */
    public function deletePaymentMethod(PaymentMethod $paymentMethod): bool
    {
        try {
            // PayPal Vault deletion
            $this->client->deletePaymentToken($paymentMethod->gateway_payment_method_id);

            $paymentMethod->delete();

            Log::info('PayPal payment method deleted', [
                'payment_method_id' => $paymentMethod->id,
            ]);

            return true;
        } catch (\Exception $e) {
            Log::error('PayPal payment method deletion failed', [
                'payment_method_id' => $paymentMethod->id,
                'error' => $e->getMessage(),
            ]);

            throw new \Exception('Failed to delete PayPal payment method: ' . $e->getMessage());
        }
    }

    /**
     * Extract approval URL from PayPal response
     *
     * @param array $response
     * @return string|null
     */
    private function extractApprovalUrl(array $response): ?string
    {
        foreach ($response['links'] ?? [] as $link) {
            if ($link['rel'] === 'approve') {
                return $link['href'];
            }
        }

        return null;
    }
}
```

### PayPal API Client

**File:** `app/Services/Enterprise/PaymentGateways/PayPal/PayPalApiClient.php`

```php
<?php

namespace App\Services\Enterprise\PaymentGateways\PayPal;

use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\Log;

class PayPalApiClient
{
    private string $baseUrl;
    private string $clientId;
    private string $clientSecret;

    public function __construct()
    {
        $mode = config('payment-gateways.paypal.mode', 'sandbox');
        $this->baseUrl = $mode === 'live'
            ? 'https://api-m.paypal.com'
            : 'https://api-m.sandbox.paypal.com';

        $config = config("payment-gateways.paypal.{$mode}");
        $this->clientId = $config['client_id'];
        $this->clientSecret = $config['client_secret'];
    }

    /**
     * Get OAuth 2.0 access token with caching
     *
     * @return string
     */
    private function getAccessToken(): string
    {
        return Cache::remember('paypal_access_token', 3600, function () {
            $response = Http::withBasicAuth($this->clientId, $this->clientSecret)
                ->asForm()
                ->post("{$this->baseUrl}/v1/oauth2/token", [
                    'grant_type' => 'client_credentials',
                ]);

            if (!$response->successful()) {
                throw new \Exception('PayPal authentication failed: ' . $response->body());
            }

            return $response->json()['access_token'];
        });
    }

    /**
     * Make authenticated API request
     *
     * @param string $method
     * @param string $endpoint
     * @param array $data
     * @param array $headers
     * @return array
     */
    private function request(string $method, string $endpoint, array $data = [], array $headers = []): array
    {
        $token = $this->getAccessToken();

        $response = Http::withToken($token)
            ->withHeaders(array_merge([
                'Content-Type' => 'application/json',
                'PayPal-Request-Id' => \Illuminate\Support\Str::uuid()->toString(), // Idempotency
            ], $headers))
            ->$method("{$this->baseUrl}{$endpoint}", $data);

        if (!$response->successful()) {
            Log::error('PayPal API error', [
                'endpoint' => $endpoint,
                'status' => $response->status(),
                'body' => $response->body(),
            ]);

            throw new \Exception("PayPal API error: {$response->status()} - {$response->body()}");
        }

        return $response->json();
    }

    /**
     * Create PayPal Order (one-time payment)
     *
     * @param array $data
     * @return array
     */
    public function createOrder(array $data): array
    {
        return $this->request('post', '/v2/checkout/orders', $data);
    }

    /**
     * Capture authorized order
     *
     * @param string $orderId
     * @return array
     */
    public function captureOrder(string $orderId): array
    {
        return $this->request('post', "/v2/checkout/orders/{$orderId}/capture");
    }

    /**
     * Get order details
     *
     * @param string $orderId
     * @return array
     */
    public function getOrder(string $orderId): array
    {
        return $this->request('get', "/v2/checkout/orders/{$orderId}");
    }

    /**
     * Create subscription
     *
     * @param array $data
     * @return array
     */
    public function createSubscription(array $data): array
    {
        return $this->request('post', '/v1/billing/subscriptions', $data);
    }

    /**
     * Get subscription details
     *
     * @param string $subscriptionId
     * @return array
     */
    public function getSubscription(string $subscriptionId): array
    {
        return $this->request('get', "/v1/billing/subscriptions/{$subscriptionId}");
    }

    /**
     * Cancel subscription
     *
     * @param string $subscriptionId
     * @param string $reason
     * @return array
     */
    public function cancelSubscription(string $subscriptionId, string $reason = ''): array
    {
        return $this->request('post', "/v1/billing/subscriptions/{$subscriptionId}/cancel", [
            'reason' => $reason ?: 'Customer requested cancellation',
        ]);
    }

    /**
     * Suspend subscription
     *
     * @param string $subscriptionId
     * @param string $reason
     * @return array
     */
    public function suspendSubscription(string $subscriptionId, string $reason = ''): array
    {
        return $this->request('post', "/v1/billing/subscriptions/{$subscriptionId}/suspend", [
            'reason' => $reason ?: 'Customer requested suspension',
        ]);
    }

    /**
     * Activate subscription
     *
     * @param string $subscriptionId
     * @return array
     */
    public function activateSubscription(string $subscriptionId): array
    {
        return $this->request('post', "/v1/billing/subscriptions/{$subscriptionId}/activate", [
            'reason' => 'Customer resumed subscription',
        ]);
    }

    /**
     * Refund captured payment
     *
     * @param string $captureId
     * @param array $data
     * @return array
     */
    public function refundCapture(string $captureId, array $data): array
    {
        return $this->request('post', "/v2/payments/captures/{$captureId}/refund", $data);
    }

    /**
     * Delete payment token (Vault)
     *
     * @param string $paymentTokenId
     * @return array
     */
    public function deletePaymentToken(string $paymentTokenId): array
    {
        return $this->request('delete', "/v3/vault/payment-tokens/{$paymentTokenId}");
    }
}
```

### Webhook Handler

**File:** `app/Services/Enterprise/PaymentGateways/PayPal/PayPalWebhookHandler.php`

```php
<?php

namespace App\Services\Enterprise\PaymentGateways\PayPal;

use App\Models\Organization;
use App\Models\OrganizationSubscription;
use App\Models\PaymentTransaction;
use Illuminate\Support\Facades\Log;

class PayPalWebhookHandler
{
    public function __construct(
        private PayPalApiClient $client
    ) {}

    /**
     * Handle incoming webhook event
     *
     * @param array $payload
     * @return void
     */
    public function handle(array $payload): void
    {
        $eventType = $payload['event_type'] ?? null;

        Log::info('PayPal webhook received', [
            'event_type' => $eventType,
            'event_id' => $payload['id'] ?? null,
        ]);

        match ($eventType) {
            'PAYMENT.SALE.COMPLETED' => $this->handlePaymentCompleted($payload),
            'PAYMENT.SALE.REFUNDED' => $this->handlePaymentRefunded($payload),
            'BILLING.SUBSCRIPTION.ACTIVATED' => $this->handleSubscriptionActivated($payload),
            'BILLING.SUBSCRIPTION.CANCELLED' => $this->handleSubscriptionCancelled($payload),
            'BILLING.SUBSCRIPTION.SUSPENDED' => $this->handleSubscriptionSuspended($payload),
            'BILLING.SUBSCRIPTION.PAYMENT.FAILED' => $this->handleSubscriptionPaymentFailed($payload),
            'CUSTOMER.DISPUTE.CREATED' => $this->handleDisputeCreated($payload),
            'CUSTOMER.DISPUTE.RESOLVED' => $this->handleDisputeResolved($payload),
            default => Log::warning('Unhandled PayPal webhook event', ['event_type' => $eventType]),
        };
    }

    /**
     * Handle payment completed event
     *
     * @param array $payload
     * @return void
     */
    private function handlePaymentCompleted(array $payload): void
    {
        $resource = $payload['resource'] ?? [];
        $orderId = $resource['billing_agreement_id'] ?? $resource['parent_payment'] ?? null;

        $transaction = PaymentTransaction::where('gateway_transaction_id', $orderId)->first();

        if ($transaction) {
            $transaction->update([
                'status' => 'completed',
                'completed_at' => now(),
                'gateway_response' => $resource,
            ]);

            Log::info('PayPal payment marked as completed', [
                'transaction_id' => $transaction->id,
            ]);
        }
    }

    /**
     * Handle payment refunded event
     *
     * @param array $payload
     * @return void
     */
    private function handlePaymentRefunded(array $payload): void
    {
        $resource = $payload['resource'] ?? [];
        $saleId = $resource['id'] ?? null;

        $transaction = PaymentTransaction::where('gateway_transaction_id', $saleId)->first();

        if ($transaction) {
            PaymentTransaction::create([
                'organization_id' => $transaction->organization_id,
                'payment_gateway' => 'paypal',
                'gateway_transaction_id' => $resource['id'],
                'amount' => -($resource['amount']['total'] ?? 0),
                'currency' => $resource['amount']['currency'] ?? $transaction->currency,
                'status' => 'completed',
                'type' => 'refund',
                'parent_transaction_id' => $transaction->id,
                'gateway_response' => $resource,
                'completed_at' => now(),
            ]);

            Log::info('PayPal refund recorded from webhook', [
                'transaction_id' => $transaction->id,
            ]);
        }
    }

    /**
     * Handle subscription activated event
     *
     * @param array $payload
     * @return void
     */
    private function handleSubscriptionActivated(array $payload): void
    {
        $resource = $payload['resource'] ?? [];
        $subscriptionId = $resource['id'] ?? null;

        $subscription = OrganizationSubscription::where('gateway_subscription_id', $subscriptionId)->first();

        if ($subscription) {
            $subscription->update([
                'status' => 'active',
                'activated_at' => now(),
                'gateway_response' => $resource,
            ]);

            Log::info('PayPal subscription activated', [
                'subscription_id' => $subscription->id,
            ]);
        }
    }

    /**
     * Handle subscription cancelled event
     *
     * @param array $payload
     * @return void
     */
    private function handleSubscriptionCancelled(array $payload): void
    {
        $resource = $payload['resource'] ?? [];
        $subscriptionId = $resource['id'] ?? null;

        $subscription = OrganizationSubscription::where('gateway_subscription_id', $subscriptionId)->first();

        if ($subscription) {
            $subscription->update([
                'status' => 'cancelled',
                'cancelled_at' => now(),
                'gateway_response' => $resource,
            ]);

            Log::info('PayPal subscription cancelled', [
                'subscription_id' => $subscription->id,
            ]);
        }
    }

    /**
     * Handle subscription suspended event
     *
     * @param array $payload
     * @return void
     */
    private function handleSubscriptionSuspended(array $payload): void
    {
        $resource = $payload['resource'] ?? [];
        $subscriptionId = $resource['id'] ?? null;

        $subscription = OrganizationSubscription::where('gateway_subscription_id', $subscriptionId)->first();

        if ($subscription) {
            $subscription->update([
                'status' => 'paused',
                'paused_at' => now(),
                'gateway_response' => $resource,
            ]);

            Log::info('PayPal subscription suspended', [
                'subscription_id' => $subscription->id,
            ]);
        }
    }

    /**
     * Handle subscription payment failed event
     *
     * @param array $payload
     * @return void
     */
    private function handleSubscriptionPaymentFailed(array $payload): void
    {
        $resource = $payload['resource'] ?? [];
        $subscriptionId = $resource['id'] ?? null;

        $subscription = OrganizationSubscription::where('gateway_subscription_id', $subscriptionId)->first();

        if ($subscription) {
            $subscription->update([
                'status' => 'past_due',
                'last_payment_failed_at' => now(),
                'gateway_response' => $resource,
            ]);

            // TODO: Send notification to organization about failed payment

            Log::warning('PayPal subscription payment failed', [
                'subscription_id' => $subscription->id,
            ]);
        }
    }

    /**
     * Handle dispute created event
     *
     * @param array $payload
     * @return void
     */
    private function handleDisputeCreated(array $payload): void
    {
        $resource = $payload['resource'] ?? [];

        // TODO: Create dispute record and notify organization

        Log::warning('PayPal dispute created', [
            'dispute_id' => $resource['dispute_id'] ?? null,
            'reason' => $resource['reason'] ?? 'Unknown',
        ]);
    }

    /**
     * Handle dispute resolved event
     *
     * @param array $payload
     * @return void
     */
    private function handleDisputeResolved(array $payload): void
    {
        $resource = $payload['resource'] ?? [];

        Log::info('PayPal dispute resolved', [
            'dispute_id' => $resource['dispute_id'] ?? null,
            'outcome' => $resource['dispute_outcome'] ?? 'Unknown',
        ]);
    }
}
```

### Webhook Controller

**File:** `app/Http/Controllers/Webhooks/PayPalWebhookController.php`

```php
<?php

namespace App\Http\Controllers\Webhooks;

use App\Http\Controllers\Controller;
use App\Services\Enterprise\PaymentGateways\PayPal\PayPalWebhookHandler;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class PayPalWebhookController extends Controller
{
    public function __construct(
        private PayPalWebhookHandler $webhookHandler
    ) {}

    /**
     * Handle incoming PayPal webhook
     *
     * @param Request $request
     * @return \Illuminate\Http\JsonResponse
     */
    public function handleWebhook(Request $request)
    {
        try {
            // Verify webhook signature
            if (!$this->verifyWebhookSignature($request)) {
                Log::warning('PayPal webhook signature verification failed');
                return response()->json(['error' => 'Invalid signature'], 401);
            }

            $payload = $request->all();

            // Handle the webhook event
            $this->webhookHandler->handle($payload);

            return response()->json(['status' => 'success']);
        } catch (\Exception $e) {
            Log::error('PayPal webhook processing failed', [
                'error' => $e->getMessage(),
                'payload' => $request->all(),
            ]);

            return response()->json(['error' => 'Webhook processing failed'], 500);
        }
    }

    /**
     * Verify PayPal webhook signature (HMAC-SHA256)
     *
     * @param Request $request
     * @return bool
     */
    private function verifyWebhookSignature(Request $request): bool
    {
        $transmissionId = $request->header('PAYPAL-TRANSMISSION-ID');
        $transmissionTime = $request->header('PAYPAL-TRANSMISSION-TIME');
        $transmissionSig = $request->header('PAYPAL-TRANSMISSION-SIG');
        $certUrl = $request->header('PAYPAL-CERT-URL');
        $authAlgo = $request->header('PAYPAL-AUTH-ALGO');
        $webhookId = config('payment-gateways.paypal.' . config('payment-gateways.paypal.mode') . '.webhook_id');

        if (!$transmissionId || !$transmissionTime || !$transmissionSig || !$certUrl || !$authAlgo) {
            return false;
        }

        // Construct expected signature string
        $expectedSig = $transmissionId . '|' . $transmissionTime . '|' . $webhookId . '|' . crc32($request->getContent());

        // Download PayPal certificate
        $cert = file_get_contents($certUrl);
        $publicKey = openssl_pkey_get_public($cert);

        if (!$publicKey) {
            Log::error('Failed to extract public key from PayPal certificate');
            return false;
        }

        // Verify signature
        $verified = openssl_verify(
            $expectedSig,
            base64_decode($transmissionSig),
            $publicKey,
            OPENSSL_ALGO_SHA256
        );

        openssl_free_key($publicKey);

        return $verified === 1;
    }
}
```

### Routes

**File:** `routes/webhooks.php` (add PayPal webhook route)

```php
<?php

use App\Http\Controllers\Webhooks\PayPalWebhookController;
use App\Http\Controllers\Webhooks\StripeWebhookController;
use Illuminate\Support\Facades\Route;

// Stripe webhooks
Route::post('/webhooks/stripe', [StripeWebhookController::class, 'handleWebhook'])
    ->name('webhooks.stripe');

// PayPal webhooks
Route::post('/webhooks/paypal', [PayPalWebhookController::class, 'handleWebhook'])
    ->name('webhooks.paypal');
```

### Service Provider Registration

**File:** `app/Providers/PaymentServiceProvider.php` (modify)

```php
<?php

namespace App\Providers;

use App\Contracts\PaymentGatewayInterface;
use App\Services\Enterprise\PaymentGateways\StripeGateway;
use App\Services\Enterprise\PaymentGateways\PayPalGateway;
use App\Services\Enterprise\PaymentService;
use Illuminate\Support\ServiceProvider;

class PaymentServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        // Register gateway implementations
        $this->app->bind('payment.gateway.stripe', StripeGateway::class);
        $this->app->bind('payment.gateway.paypal', PayPalGateway::class);

        // Register PaymentService with gateway factory
        $this->app->singleton(PaymentService::class, function ($app) {
            return new PaymentService([
                'stripe' => $app->make('payment.gateway.stripe'),
                'paypal' => $app->make('payment.gateway.paypal'),
            ]);
        });
    }
}
```

## Implementation Approach

### Step 1: Install PayPal SDK (Optional)
While we're using direct HTTP requests, you can optionally install PayPal SDK:
```bash
composer require paypal/rest-api-sdk-php
# OR use native HTTP client (recommended for control and debugging)
```

### Step 2: Configure PayPal Credentials
1. Create PayPal developer account at https://developer.paypal.com
2. Create sandbox and live apps to get client ID and secret
3. Add credentials to `.env` file
4. Configure webhook endpoint in PayPal dashboard

### Step 3: Implement PayPalApiClient
1. Create `PayPalApiClient` class in `app/Services/Enterprise/PaymentGateways/PayPal/`
2. Implement OAuth 2.0 authentication with token caching
3. Add methods for Orders API, Subscriptions API, Refunds API
4. Implement error handling with PayPal-specific error codes

### Step 4: Implement PayPalGateway
1. Create `PayPalGateway` class implementing `PaymentGatewayInterface`
2. Implement `processPayment()` using Orders API
3. Add `capturePayment()` method for completing PayPal orders
4. Implement `createSubscription()` using Billing Subscriptions API
5. Add subscription management methods (cancel, pause, resume)
6. Implement `refundPayment()` with full and partial refund support

### Step 5: Implement Webhook Handler
1. Create `PayPalWebhookHandler` service
2. Implement event handlers for 10+ PayPal webhook events
3. Add database updates for transactions and subscriptions
4. Create `PayPalWebhookController` with signature verification
5. Register webhook route in `routes/webhooks.php`

### Step 6: Webhook Signature Verification
1. Implement HMAC-SHA256 signature verification
2. Download PayPal certificate from header URL
3. Extract public key and verify signature
4. Log failed verification attempts

### Step 7: Frontend Integration
1. Add PayPal Smart Payment Buttons to payment forms
2. Handle PayPal redirect flow (approval â†’ return â†’ capture)
3. Update SubscriptionManager.vue to support PayPal subscriptions
4. Add PayPal-specific payment method icons and branding

### Step 8: Testing
1. Unit test PayPalGateway methods with mocked API client
2. Integration test webhook handling with sample PayPal events
3. Test payment flow end-to-end in sandbox environment
4. Test subscription lifecycle (create, pause, resume, cancel)
5. Test refund processing

### Step 9: Error Handling & Logging
1. Map PayPal error codes to user-friendly messages
2. Add comprehensive logging for all API interactions
3. Implement retry logic for transient failures
4. Add monitoring for webhook processing failures

### Step 10: Production Deployment
1. Switch PayPal mode from sandbox to live
2. Configure live webhook URL in PayPal dashboard
3. Verify webhook signature with live credentials
4. Monitor transaction processing and webhook delivery

## Test Strategy

### Unit Tests

**File:** `tests/Unit/PaymentGateways/PayPalGatewayTest.php`

```php
<?php

use App\Models\Organization;
use App\Models\OrganizationSubscription;
use App\Models\PaymentTransaction;
use App\Services\Enterprise\PaymentGateways\PayPalGateway;
use App\Services\Enterprise\PaymentGateways\PayPal\PayPalApiClient;
use Illuminate\Foundation\Testing\RefreshDatabase;

uses(RefreshDatabase::class);

beforeEach(function () {
    $this->apiClient = Mockery::mock(PayPalApiClient::class);
    $this->gateway = new PayPalGateway($this->apiClient);
    $this->organization = Organization::factory()->create();
});

it('processes one-time payment successfully', function () {
    $this->apiClient->shouldReceive('createOrder')
        ->once()
        ->andReturn([
            'id' => 'PAYPAL-ORDER-123',
            'status' => 'CREATED',
            'links' => [
                ['rel' => 'approve', 'href' => 'https://paypal.com/approve/123'],
            ],
        ]);

    $transaction = $this->gateway->processPayment($this->organization, 100.00, 'USD');

    expect($transaction)->toBeInstanceOf(PaymentTransaction::class);
    expect($transaction->payment_gateway)->toBe('paypal');
    expect($transaction->amount)->toBe(100.00);
    expect($transaction->status)->toBe('pending');
    expect($transaction->gateway_transaction_id)->toBe('PAYPAL-ORDER-123');
});

it('captures authorized payment', function () {
    $transaction = PaymentTransaction::factory()->create([
        'organization_id' => $this->organization->id,
        'payment_gateway' => 'paypal',
        'gateway_transaction_id' => 'PAYPAL-ORDER-123',
        'status' => 'pending',
    ]);

    $this->apiClient->shouldReceive('captureOrder')
        ->with('PAYPAL-ORDER-123')
        ->once()
        ->andReturn([
            'id' => 'PAYPAL-ORDER-123',
            'status' => 'COMPLETED',
            'purchase_units' => [
                [
                    'payments' => [
                        'captures' => [
                            ['id' => 'CAPTURE-123'],
                        ],
                    ],
                ],
            ],
        ]);

    $captured = $this->gateway->capturePayment('PAYPAL-ORDER-123');

    expect($captured->status)->toBe('completed');
    expect($captured->metadata['capture_id'])->toBe('CAPTURE-123');
});

it('creates subscription successfully', function () {
    $this->apiClient->shouldReceive('createSubscription')
        ->once()
        ->andReturn([
            'id' => 'PAYPAL-SUB-123',
            'status' => 'APPROVAL_PENDING',
            'links' => [
                ['rel' => 'approve', 'href' => 'https://paypal.com/subscribe/123'],
            ],
        ]);

    $subscription = $this->gateway->createSubscription(
        $this->organization,
        'PAYPAL-PLAN-456'
    );

    expect($subscription)->toBeInstanceOf(OrganizationSubscription::class);
    expect($subscription->payment_gateway)->toBe('paypal');
    expect($subscription->gateway_subscription_id)->toBe('PAYPAL-SUB-123');
    expect($subscription->status)->toBe('pending');
});

it('cancels subscription successfully', function () {
    $subscription = OrganizationSubscription::factory()->create([
        'organization_id' => $this->organization->id,
        'payment_gateway' => 'paypal',
        'gateway_subscription_id' => 'PAYPAL-SUB-123',
        'status' => 'active',
    ]);

    $this->apiClient->shouldReceive('cancelSubscription')
        ->with('PAYPAL-SUB-123', 'Customer request')
        ->once()
        ->andReturn(['status' => 'CANCELLED']);

    $result = $this->gateway->cancelSubscription($subscription, 'Customer request');

    expect($result)->toBeTrue();
    $subscription->refresh();
    expect($subscription->status)->toBe('cancelled');
    expect($subscription->cancelled_at)->not->toBeNull();
});

it('processes refund successfully', function () {
    $transaction = PaymentTransaction::factory()->create([
        'organization_id' => $this->organization->id,
        'payment_gateway' => 'paypal',
        'gateway_transaction_id' => 'PAYPAL-ORDER-123',
        'amount' => 100.00,
        'status' => 'completed',
        'metadata' => ['capture_id' => 'CAPTURE-123'],
    ]);

    $this->apiClient->shouldReceive('refundCapture')
        ->with('CAPTURE-123', Mockery::any())
        ->once()
        ->andReturn([
            'id' => 'REFUND-123',
            'status' => 'COMPLETED',
        ]);

    $refund = $this->gateway->refundPayment($transaction, 50.00, 'Partial refund');

    expect($refund)->toBeInstanceOf(PaymentTransaction::class);
    expect($refund->type)->toBe('refund');
    expect($refund->amount)->toBe(-50.00);
    expect($refund->parent_transaction_id)->toBe($transaction->id);
});
```

### Integration Tests

**File:** `tests/Feature/PaymentGateways/PayPalIntegrationTest.php`

```php
<?php

use App\Models\Organization;
use App\Services\Enterprise\PaymentGateways\PayPalGateway;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\Http;

uses(RefreshDatabase::class);

it('processes full payment flow', function () {
    Http::fake([
        '*/v1/oauth2/token' => Http::response([
            'access_token' => 'fake-token',
            'expires_in' => 3600,
        ]),
        '*/v2/checkout/orders' => Http::response([
            'id' => 'ORDER-123',
            'status' => 'CREATED',
            'links' => [
                ['rel' => 'approve', 'href' => 'https://paypal.com/approve/123'],
            ],
        ]),
        '*/v2/checkout/orders/ORDER-123/capture' => Http::response([
            'id' => 'ORDER-123',
            'status' => 'COMPLETED',
            'purchase_units' => [
                [
                    'payments' => [
                        'captures' => [
                            ['id' => 'CAPTURE-123'],
                        ],
                    ],
                ],
            ],
        ]),
    ]);

    $organization = Organization::factory()->create();
    $gateway = app(PayPalGateway::class);

    // Create order
    $transaction = $gateway->processPayment($organization, 100.00);
    expect($transaction->status)->toBe('pending');

    // Capture payment
    $captured = $gateway->capturePayment($transaction->gateway_transaction_id);
    expect($captured->status)->toBe('completed');
});
```

### Webhook Tests

**File:** `tests/Feature/Webhooks/PayPalWebhookTest.php`

```php
<?php

use App\Models\OrganizationSubscription;
use App\Models\PaymentTransaction;
use Illuminate\Foundation\Testing\RefreshDatabase;

uses(RefreshDatabase::class);

it('handles payment completed webhook', function () {
    $transaction = PaymentTransaction::factory()->create([
        'payment_gateway' => 'paypal',
        'gateway_transaction_id' => 'ORDER-123',
        'status' => 'pending',
    ]);

    $payload = [
        'event_type' => 'PAYMENT.SALE.COMPLETED',
        'resource' => [
            'id' => 'SALE-123',
            'parent_payment' => 'ORDER-123',
            'state' => 'completed',
        ],
    ];

    $this->postJson('/webhooks/paypal', $payload)
        ->assertOk();

    $transaction->refresh();
    expect($transaction->status)->toBe('completed');
});

it('handles subscription activated webhook', function () {
    $subscription = OrganizationSubscription::factory()->create([
        'payment_gateway' => 'paypal',
        'gateway_subscription_id' => 'SUB-123',
        'status' => 'pending',
    ]);

    $payload = [
        'event_type' => 'BILLING.SUBSCRIPTION.ACTIVATED',
        'resource' => [
            'id' => 'SUB-123',
            'status' => 'ACTIVE',
        ],
    ];

    $this->postJson('/webhooks/paypal', $payload)
        ->assertOk();

    $subscription->refresh();
    expect($subscription->status)->toBe('active');
});
```

## Definition of Done

- [ ] PayPalGateway class created implementing PaymentGatewayInterface
- [ ] PayPalApiClient implemented with OAuth 2.0 authentication
- [ ] Access token caching implemented (1 hour TTL)
- [ ] One-time payment processing via Orders API implemented
- [ ] Payment capture functionality implemented
- [ ] Subscription creation via Billing Subscriptions API implemented
- [ ] Subscription management (cancel, pause, resume) implemented
- [ ] Payment method tokenization (Vault API) implemented
- [ ] Refund processing (full and partial) implemented
- [ ] PayPalWebhookHandler created with event routing
- [ ] Webhook signature verification (HMAC-SHA256) implemented
- [ ] 10+ webhook event handlers implemented
- [ ] PayPalWebhookController created with signature validation
- [ ] Webhook route registered in routes/webhooks.php
- [ ] PayPal configuration added to config/payment-gateways.php
- [ ] Environment variables documented in .env.example
- [ ] PayPal gateway registered in PaymentServiceProvider
- [ ] Idempotency support using PayPal-Request-Id header
- [ ] Error handling with PayPal error code mapping
- [ ] Comprehensive logging for all API interactions
- [ ] Unit tests written (15+ tests, >90% coverage)
- [ ] Integration tests written (5+ tests)
- [ ] Webhook tests written (8+ event types)
- [ ] Sandbox testing completed successfully
- [ ] PayPal Smart Payment Buttons frontend integration
- [ ] Documentation updated with PayPal setup instructions
- [ ] Code follows Laravel 12 and Coolify standards
- [ ] PHPStan level 5 passing
- [ ] Laravel Pint formatting applied
- [ ] Code reviewed and approved
- [ ] Production deployment checklist completed

## Related Tasks

- **Depends on:** Task 43 (PaymentGatewayInterface and factory pattern)
- **Depends on:** Task 42 (Payment database schema)
- **Integrates with:** Task 46 (PaymentService multi-gateway support)
- **Integrates with:** Task 47 (Webhook handling system)
- **Integrates with:** Task 50 (Frontend payment components)
- **Complements:** Task 44 (Stripe integration - multi-gateway strategy)
