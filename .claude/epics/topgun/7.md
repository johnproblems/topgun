---
name: Implement favicon generation in multiple sizes
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:38:26Z
github: https://github.com/johnproblems/topgun/issues/117
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Implement favicon generation in multiple sizes

## Description

Implement an automated favicon generation system that creates platform favicons in all required sizes from a single uploaded logo image. This backend service handles the complex task of generating browser-compatible favicons, app icons for mobile devices, and web manifest integration—ensuring the white-labeled platform displays the organization's branding consistently across all devices and contexts.

Modern web applications require favicons in multiple formats and sizes to support:
1. **Browser tabs and bookmarks** (16x16, 32x32, 48x48)
2. **iOS/Android home screen icons** (180x180, 192x192, 512x512)
3. **Windows live tiles** (144x144, 270x270)
4. **Safari pinned tabs** (SVG or high-res PNG with mask)
5. **Web app manifests** (manifest.json with icon definitions)

This task creates a comprehensive FaviconGeneratorService that:
- Accepts a single high-resolution logo image (ideally 512x512 or larger)
- Generates all required favicon sizes automatically
- Optimizes images for web delivery (compression, format selection)
- Creates a web manifest file for PWA support
- Generates meta tags for proper HTML integration
- Stores generated favicons in organization-specific directories
- Updates the WhiteLabelConfig model with favicon paths

**Integration with White-Label System:**
- Triggered automatically when a logo is uploaded via LogoUploader.vue (Task 4)
- Used by DynamicAssetController to serve organization-specific favicons (Task 2)
- Referenced in email templates for consistent branding (Task 9)
- Displayed in BrandingPreview.vue for real-time visualization (Task 8)
- Cached using BrandingCacheService for performance (Task 3)

**Why this task is important:** Favicons are often overlooked but critical for professional branding. A generic favicon undermines the white-label experience—users see default icons in browser tabs, bookmarks, and mobile home screens. Professional favicon generation ensures the organization's brand is visible everywhere their platform appears, from browser tabs to smartphone home screens. Automated generation eliminates manual image editing, reduces human error, and ensures compliance with modern web standards across all platforms and devices.

## Acceptance Criteria

- [ ] FaviconGeneratorService created with image processing capabilities
- [ ] Generate favicons in 8 required sizes: 16x16, 32x32, 48x48, 144x144, 180x180, 192x192, 270x270, 512x512
- [ ] Support input formats: PNG, JPG, SVG
- [ ] Automatic background removal for transparent icons (PNG output)
- [ ] Automatic padding/cropping to maintain square aspect ratio
- [ ] Image optimization with compression (reduce file size by 40-60%)
- [ ] Generate favicon.ico containing 16x16, 32x32, 48x48 multi-resolution
- [ ] Generate web manifest (manifest.json) with icon definitions
- [ ] Generate Apple Touch Icon (apple-touch-icon.png) at 180x180
- [ ] Store generated files in organization-specific directory structure
- [ ] Update WhiteLabelConfig model with generated favicon paths
- [ ] Generate HTML meta tags snippet for integration
- [ ] Validation: source image must be at least 144x144 pixels
- [ ] Error handling for corrupted images, insufficient resolution, unsupported formats
- [ ] Artisan command for bulk favicon regeneration: `php artisan branding:generate-favicons {organization?}`

## Technical Details

### File Paths

**Service Layer:**
- `/home/topgun/topgun/app/Services/Enterprise/FaviconGeneratorService.php` (new)
- `/home/topgun/topgun/app/Contracts/FaviconGeneratorServiceInterface.php` (new)

**Controller Enhancement:**
- `/home/topgun/topgun/app/Http/Controllers/Enterprise/WhiteLabelController.php` (modify)

**Artisan Commands:**
- `/home/topgun/topgun/app/Console/Commands/GenerateFavicons.php` (new)

**Models:**
- `/home/topgun/topgun/app/Models/Enterprise/WhiteLabelConfig.php` (modify - add favicon columns)

**Storage:**
- `storage/app/public/branding/{organization_id}/favicons/` (favicon files)
- `storage/app/public/branding/{organization_id}/manifests/` (web manifest files)

### Database Schema Enhancement

Add favicon-related columns to `white_label_configs` table:

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::table('white_label_configs', function (Blueprint $table) {
            $table->string('favicon_16_path')->nullable()->after('email_logo_path');
            $table->string('favicon_32_path')->nullable();
            $table->string('favicon_48_path')->nullable();
            $table->string('favicon_ico_path')->nullable();
            $table->string('favicon_144_path')->nullable(); // Windows tile
            $table->string('favicon_180_path')->nullable(); // Apple touch icon
            $table->string('favicon_192_path')->nullable(); // Android
            $table->string('favicon_270_path')->nullable(); // Windows large tile
            $table->string('favicon_512_path')->nullable(); // PWA
            $table->string('manifest_path')->nullable(); // Web manifest JSON
            $table->text('favicon_meta_tags')->nullable(); // Generated HTML meta tags
        });
    }

    public function down(): void
    {
        Schema::table('white_label_configs', function (Blueprint $table) {
            $table->dropColumn([
                'favicon_16_path',
                'favicon_32_path',
                'favicon_48_path',
                'favicon_ico_path',
                'favicon_144_path',
                'favicon_180_path',
                'favicon_192_path',
                'favicon_270_path',
                'favicon_512_path',
                'manifest_path',
                'favicon_meta_tags',
            ]);
        });
    }
};
```

### FaviconGeneratorService Implementation

**File:** `app/Services/Enterprise/FaviconGeneratorService.php`

```php
<?php

namespace App\Services\Enterprise;

use App\Contracts\FaviconGeneratorServiceInterface;
use App\Models\Organization;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\Log;
use Intervention\Image\ImageManager;
use Intervention\Image\Drivers\Gd\Driver;

class FaviconGeneratorService implements FaviconGeneratorServiceInterface
{
    private const REQUIRED_SIZES = [16, 32, 48, 144, 180, 192, 270, 512];
    private const ICO_SIZES = [16, 32, 48]; // Sizes to include in favicon.ico
    private const MIN_SOURCE_SIZE = 144; // Minimum source image dimension

    public function __construct(
        private ImageManager $imageManager
    ) {
        // Use GD driver for broader compatibility
        $this->imageManager = new ImageManager(new Driver());
    }

    /**
     * Generate all favicon sizes from source image
     *
     * @param Organization $organization
     * @param string $sourcePath Absolute path to source image
     * @return array Paths to generated files
     * @throws \Exception
     */
    public function generateFavicons(Organization $organization, string $sourcePath): array
    {
        // Validate source image
        $this->validateSourceImage($sourcePath);

        // Load source image
        $sourceImage = $this->imageManager->read($sourcePath);

        // Prepare storage directory
        $faviconDir = "branding/{$organization->id}/favicons";
        Storage::disk('public')->makeDirectory($faviconDir);

        $generatedPaths = [];

        // Generate each required size
        foreach (self::REQUIRED_SIZES as $size) {
            $filename = "favicon-{$size}x{$size}.png";
            $path = "{$faviconDir}/{$filename}";

            $resized = $sourceImage->scale(width: $size, height: $size);

            // Optimize and save
            $encoded = $resized->toPng();
            Storage::disk('public')->put($path, $encoded);

            $generatedPaths["favicon_{$size}_path"] = $path;

            Log::info("Generated favicon: {$path}");
        }

        // Generate multi-resolution favicon.ico
        $icoPath = $this->generateFaviconIco($organization, $sourcePath);
        $generatedPaths['favicon_ico_path'] = $icoPath;

        // Generate Apple Touch Icon (180x180, no transparency)
        $appleTouchPath = $this->generateAppleTouchIcon($organization, $sourcePath);
        $generatedPaths['apple_touch_icon_path'] = $appleTouchPath;

        // Generate web manifest
        $manifestPath = $this->generateWebManifest($organization, $generatedPaths);
        $generatedPaths['manifest_path'] = $manifestPath;

        // Generate meta tags snippet
        $metaTags = $this->generateMetaTags($organization, $generatedPaths);
        $generatedPaths['favicon_meta_tags'] = $metaTags;

        return $generatedPaths;
    }

    /**
     * Validate source image meets requirements
     *
     * @param string $sourcePath
     * @return void
     * @throws \Exception
     */
    private function validateSourceImage(string $sourcePath): void
    {
        if (!file_exists($sourcePath)) {
            throw new \Exception("Source image not found: {$sourcePath}");
        }

        $imageInfo = getimagesize($sourcePath);

        if ($imageInfo === false) {
            throw new \Exception("Invalid image file: {$sourcePath}");
        }

        [$width, $height] = $imageInfo;

        if ($width < self::MIN_SOURCE_SIZE || $height < self::MIN_SOURCE_SIZE) {
            throw new \Exception(
                "Source image too small. Minimum size: " . self::MIN_SOURCE_SIZE . "x" . self::MIN_SOURCE_SIZE . "px"
            );
        }

        // Check supported formats
        $allowedTypes = [IMAGETYPE_PNG, IMAGETYPE_JPEG, IMAGETYPE_GIF];
        if (!in_array($imageInfo[2], $allowedTypes)) {
            throw new \Exception("Unsupported image format. Use PNG, JPG, or GIF.");
        }
    }

    /**
     * Generate favicon.ico with multiple resolutions
     *
     * @param Organization $organization
     * @param string $sourcePath
     * @return string Path to generated .ico file
     */
    private function generateFaviconIco(Organization $organization, string $sourcePath): string
    {
        $faviconDir = "branding/{$organization->id}/favicons";
        $icoPath = "{$faviconDir}/favicon.ico";

        // For simplicity, we'll use the 32x32 PNG as the .ico
        // Production implementation should use a proper ICO library like PHP-ICO
        $sourceImage = $this->imageManager->read($sourcePath);
        $resized = $sourceImage->scale(width: 32, height: 32);
        $encoded = $resized->toPng();

        Storage::disk('public')->put($icoPath, $encoded);

        Log::info("Generated favicon.ico: {$icoPath}");

        return $icoPath;
    }

    /**
     * Generate Apple Touch Icon (opaque background)
     *
     * @param Organization $organization
     * @param string $sourcePath
     * @return string Path to generated apple-touch-icon.png
     */
    private function generateAppleTouchIcon(Organization $organization, string $sourcePath): string
    {
        $faviconDir = "branding/{$organization->id}/favicons";
        $appleTouchPath = "{$faviconDir}/apple-touch-icon.png";

        $sourceImage = $this->imageManager->read($sourcePath);

        // Resize to 180x180 (Apple's recommended size)
        $resized = $sourceImage->scale(width: 180, height: 180);

        // Apple requires opaque background, so add white background if transparent
        // This is a simplified implementation
        $encoded = $resized->toPng();

        Storage::disk('public')->put($appleTouchPath, $encoded);

        Log::info("Generated Apple Touch Icon: {$appleTouchPath}");

        return $appleTouchPath;
    }

    /**
     * Generate web manifest for PWA support
     *
     * @param Organization $organization
     * @param array $generatedPaths
     * @return string Path to manifest.json
     */
    private function generateWebManifest(Organization $organization, array $generatedPaths): string
    {
        $manifestDir = "branding/{$organization->id}/manifests";
        Storage::disk('public')->makeDirectory($manifestDir);

        $manifestPath = "{$manifestDir}/manifest.json";

        $manifest = [
            'name' => $organization->whiteLabelConfig?->platform_name ?? $organization->name,
            'short_name' => $organization->name,
            'icons' => [
                [
                    'src' => Storage::url($generatedPaths['favicon_192_path']),
                    'sizes' => '192x192',
                    'type' => 'image/png',
                    'purpose' => 'any maskable',
                ],
                [
                    'src' => Storage::url($generatedPaths['favicon_512_path']),
                    'sizes' => '512x512',
                    'type' => 'image/png',
                    'purpose' => 'any maskable',
                ],
            ],
            'theme_color' => $organization->whiteLabelConfig?->primary_color ?? '#3b82f6',
            'background_color' => $organization->whiteLabelConfig?->background_color ?? '#ffffff',
            'display' => 'standalone',
            'start_url' => '/',
        ];

        Storage::disk('public')->put($manifestPath, json_encode($manifest, JSON_PRETTY_PRINT));

        Log::info("Generated web manifest: {$manifestPath}");

        return $manifestPath;
    }

    /**
     * Generate HTML meta tags for favicon integration
     *
     * @param Organization $organization
     * @param array $generatedPaths
     * @return string HTML meta tags snippet
     */
    private function generateMetaTags(Organization $organization, array $generatedPaths): string
    {
        $baseUrl = config('app.url');

        $tags = [
            // Standard favicons
            '<link rel="icon" type="image/png" sizes="16x16" href="' . Storage::url($generatedPaths['favicon_16_path']) . '">',
            '<link rel="icon" type="image/png" sizes="32x32" href="' . Storage::url($generatedPaths['favicon_32_path']) . '">',
            '<link rel="icon" type="image/png" sizes="48x48" href="' . Storage::url($generatedPaths['favicon_48_path']) . '">',

            // Legacy .ico
            '<link rel="shortcut icon" href="' . Storage::url($generatedPaths['favicon_ico_path']) . '">',

            // Apple
            '<link rel="apple-touch-icon" sizes="180x180" href="' . Storage::url($generatedPaths['apple_touch_icon_path']) . '">',

            // Android/Chrome
            '<link rel="icon" type="image/png" sizes="192x192" href="' . Storage::url($generatedPaths['favicon_192_path']) . '">',
            '<link rel="icon" type="image/png" sizes="512x512" href="' . Storage::url($generatedPaths['favicon_512_path']) . '">',

            // Web manifest
            '<link rel="manifest" href="' . Storage::url($generatedPaths['manifest_path']) . '">',

            // Windows tiles
            '<meta name="msapplication-TileImage" content="' . Storage::url($generatedPaths['favicon_144_path']) . '">',
            '<meta name="msapplication-TileColor" content="' . ($organization->whiteLabelConfig?->primary_color ?? '#3b82f6') . '">',

            // Theme color
            '<meta name="theme-color" content="' . ($organization->whiteLabelConfig?->primary_color ?? '#3b82f6') . '">',
        ];

        return implode("\n", $tags);
    }

    /**
     * Delete all generated favicons for organization
     *
     * @param Organization $organization
     * @return bool
     */
    public function deleteFavicons(Organization $organization): bool
    {
        $faviconDir = "branding/{$organization->id}/favicons";
        $manifestDir = "branding/{$organization->id}/manifests";

        Storage::disk('public')->deleteDirectory($faviconDir);
        Storage::disk('public')->deleteDirectory($manifestDir);

        Log::info("Deleted favicons for organization: {$organization->id}");

        return true;
    }

    /**
     * Get favicon URLs for organization
     *
     * @param Organization $organization
     * @return array
     */
    public function getFaviconUrls(Organization $organization): array
    {
        $config = $organization->whiteLabelConfig;

        if (!$config) {
            return [];
        }

        return [
            'favicon_16' => $config->favicon_16_path ? Storage::url($config->favicon_16_path) : null,
            'favicon_32' => $config->favicon_32_path ? Storage::url($config->favicon_32_path) : null,
            'favicon_48' => $config->favicon_48_path ? Storage::url($config->favicon_48_path) : null,
            'favicon_ico' => $config->favicon_ico_path ? Storage::url($config->favicon_ico_path) : null,
            'apple_touch_icon' => $config->favicon_180_path ? Storage::url($config->favicon_180_path) : null,
            'manifest' => $config->manifest_path ? Storage::url($config->manifest_path) : null,
        ];
    }
}
```

### Service Interface

**File:** `app/Contracts/FaviconGeneratorServiceInterface.php`

```php
<?php

namespace App\Contracts;

use App\Models\Organization;

interface FaviconGeneratorServiceInterface
{
    /**
     * Generate all favicon sizes from source image
     *
     * @param Organization $organization
     * @param string $sourcePath
     * @return array Generated file paths
     */
    public function generateFavicons(Organization $organization, string $sourcePath): array;

    /**
     * Delete all generated favicons
     *
     * @param Organization $organization
     * @return bool
     */
    public function deleteFavicons(Organization $organization): bool;

    /**
     * Get favicon URLs for organization
     *
     * @param Organization $organization
     * @return array
     */
    public function getFaviconUrls(Organization $organization): array;
}
```

### Controller Integration

Update `WhiteLabelController` to trigger favicon generation:

```php
public function uploadLogo(Request $request, Organization $organization)
{
    $this->authorize('update', $organization);

    $request->validate([
        'logo' => 'required|image|mimes:png,jpg,jpeg,svg|max:5120',
        'logo_type' => 'required|in:primary,favicon,email',
    ]);

    $logoType = $request->input('logo_type');
    $file = $request->file('logo');

    // Store logo
    $path = $file->store("branding/{$organization->id}/logos", 'public');

    // Update config
    $config = $organization->whiteLabelConfig()->firstOrCreate([]);
    $config->update([
        "{$logoType}_logo_path" => $path,
        "{$logoType}_logo_url" => Storage::url($path),
    ]);

    // Generate favicons if this is a favicon upload
    if ($logoType === 'favicon' || $logoType === 'primary') {
        try {
            $faviconService = app(FaviconGeneratorServiceInterface::class);
            $sourcePath = Storage::disk('public')->path($path);
            $generatedPaths = $faviconService->generateFavicons($organization, $sourcePath);

            // Update config with favicon paths
            $config->update($generatedPaths);

            // Clear branding cache
            Cache::forget("branding:{$organization->id}:css");

            return back()->with('success', 'Logo and favicons generated successfully');
        } catch (\Exception $e) {
            Log::error("Favicon generation failed: {$e->getMessage()}");
            return back()->with('warning', 'Logo uploaded but favicon generation failed: ' . $e->getMessage());
        }
    }

    // Clear branding cache
    Cache::forget("branding:{$organization->id}:css");

    return back()->with('success', 'Logo uploaded successfully');
}
```

### Artisan Command

**File:** `app/Console/Commands/GenerateFavicons.php`

```php
<?php

namespace App\Console\Commands;

use App\Contracts\FaviconGeneratorServiceInterface;
use App\Models\Organization;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\Storage;

class GenerateFavicons extends Command
{
    protected $signature = 'branding:generate-favicons {organization? : Organization ID or slug}';
    protected $description = 'Generate favicons for one or all organizations';

    public function handle(FaviconGeneratorServiceInterface $faviconService): int
    {
        $organizationIdOrSlug = $this->argument('organization');

        if ($organizationIdOrSlug) {
            $organization = Organization::where('id', $organizationIdOrSlug)
                ->orWhere('slug', $organizationIdOrSlug)
                ->first();

            if (!$organization) {
                $this->error("Organization not found: {$organizationIdOrSlug}");
                return self::FAILURE;
            }

            $this->generateForOrganization($organization, $faviconService);
        } else {
            $organizations = Organization::has('whiteLabelConfig')->get();

            $this->info("Generating favicons for {$organizations->count()} organizations...");

            $progressBar = $this->output->createProgressBar($organizations->count());

            foreach ($organizations as $organization) {
                $this->generateForOrganization($organization, $faviconService);
                $progressBar->advance();
            }

            $progressBar->finish();
            $this->newLine();
        }

        return self::SUCCESS;
    }

    private function generateForOrganization(Organization $organization, FaviconGeneratorServiceInterface $faviconService): void
    {
        $config = $organization->whiteLabelConfig;

        if (!$config || !$config->primary_logo_path) {
            $this->warn("Skipping {$organization->name}: No logo uploaded");
            return;
        }

        try {
            $sourcePath = Storage::disk('public')->path($config->primary_logo_path);

            if (!file_exists($sourcePath)) {
                $this->warn("Skipping {$organization->name}: Logo file not found");
                return;
            }

            $generatedPaths = $faviconService->generateFavicons($organization, $sourcePath);
            $config->update($generatedPaths);

            $this->info("Generated favicons for: {$organization->name}");
        } catch (\Exception $e) {
            $this->error("Failed for {$organization->name}: {$e->getMessage()}");
        }
    }
}
```

### Dependencies

Add Intervention Image library for image processing:

```bash
composer require intervention/image
```

## Implementation Approach

### Step 1: Install Dependencies
```bash
composer require intervention/image
```

### Step 2: Create Database Migration
1. Create migration for favicon columns in `white_label_configs` table
2. Add 11 new columns for favicon paths and meta tags
3. Run migration: `php artisan migrate`

### Step 3: Create Service Interface and Implementation
1. Create `FaviconGeneratorServiceInterface` in `app/Contracts/`
2. Implement `FaviconGeneratorService` in `app/Services/Enterprise/`
3. Register service in `EnterpriseServiceProvider`

### Step 4: Implement Core Functionality
1. Add `validateSourceImage()` method with size/format checks
2. Implement `generateFavicons()` main method
3. Add `generateFaviconIco()` for multi-resolution .ico
4. Add `generateAppleTouchIcon()` for iOS compatibility
5. Implement `generateWebManifest()` for PWA support
6. Add `generateMetaTags()` for HTML integration

### Step 5: Integrate with Controller
1. Modify `WhiteLabelController::uploadLogo()` method
2. Trigger favicon generation after logo upload
3. Update WhiteLabelConfig with generated paths
4. Add error handling and user feedback

### Step 6: Create Artisan Command
1. Create `GenerateFavicons` command
2. Support bulk regeneration for all organizations
3. Add progress bar for bulk operations
4. Include error handling and logging

### Step 7: Update WhiteLabelConfig Model
1. Add favicon path accessors
2. Add relationship methods if needed
3. Update factory for testing

### Step 8: Testing
1. Unit test FaviconGeneratorService methods
2. Test image validation logic
3. Test favicon generation for various image sizes
4. Test error handling for invalid images
5. Integration test full upload-to-generation workflow

## Test Strategy

### Unit Tests

**File:** `tests/Unit/Enterprise/FaviconGeneratorServiceTest.php`

```php
<?php

use App\Services\Enterprise\FaviconGeneratorService;
use App\Models\Organization;
use Illuminate\Support\Facades\Storage;
use Illuminate\Http\UploadedFile;

beforeEach(function () {
    Storage::fake('public');
    $this->service = app(FaviconGeneratorService::class);
});

it('validates source image dimensions', function () {
    $organization = Organization::factory()->create();

    // Create small image (too small)
    $file = UploadedFile::fake()->image('small.png', 100, 100);
    $path = $file->store('temp', 'public');

    expect(fn() => $this->service->generateFavicons(
        $organization,
        Storage::disk('public')->path($path)
    ))->toThrow(\Exception::class, 'Source image too small');
});

it('generates all required favicon sizes', function () {
    $organization = Organization::factory()->create();

    // Create valid source image
    $file = UploadedFile::fake()->image('logo.png', 512, 512);
    $path = $file->store('temp', 'public');

    $generatedPaths = $this->service->generateFavicons(
        $organization,
        Storage::disk('public')->path($path)
    );

    // Check all sizes were generated
    expect($generatedPaths)->toHaveKeys([
        'favicon_16_path',
        'favicon_32_path',
        'favicon_48_path',
        'favicon_144_path',
        'favicon_180_path',
        'favicon_192_path',
        'favicon_270_path',
        'favicon_512_path',
        'favicon_ico_path',
        'manifest_path',
        'favicon_meta_tags',
    ]);

    // Verify files exist
    Storage::disk('public')->assertExists($generatedPaths['favicon_16_path']);
    Storage::disk('public')->assertExists($generatedPaths['favicon_32_path']);
    Storage::disk('public')->assertExists($generatedPaths['favicon_512_path']);
});

it('generates web manifest with correct structure', function () {
    $organization = Organization::factory()->create();
    $file = UploadedFile::fake()->image('logo.png', 512, 512);
    $path = $file->store('temp', 'public');

    $generatedPaths = $this->service->generateFavicons(
        $organization,
        Storage::disk('public')->path($path)
    );

    $manifestContent = Storage::disk('public')->get($generatedPaths['manifest_path']);
    $manifest = json_decode($manifestContent, true);

    expect($manifest)->toHaveKeys(['name', 'short_name', 'icons', 'theme_color', 'display']);
    expect($manifest['icons'])->toHaveCount(2); // 192x192 and 512x512
});

it('generates HTML meta tags', function () {
    $organization = Organization::factory()->create();
    $file = UploadedFile::fake()->image('logo.png', 512, 512);
    $path = $file->store('temp', 'public');

    $generatedPaths = $this->service->generateFavicons(
        $organization,
        Storage::disk('public')->path($path)
    );

    $metaTags = $generatedPaths['favicon_meta_tags'];

    expect($metaTags)->toContain('<link rel="icon"');
    expect($metaTags)->toContain('apple-touch-icon');
    expect($metaTags)->toContain('manifest');
    expect($metaTags)->toContain('theme-color');
});

it('deletes all generated favicons', function () {
    $organization = Organization::factory()->create();
    $file = UploadedFile::fake()->image('logo.png', 512, 512);
    $path = $file->store('temp', 'public');

    $generatedPaths = $this->service->generateFavicons(
        $organization,
        Storage::disk('public')->path($path)
    );

    // Verify files exist
    Storage::disk('public')->assertExists($generatedPaths['favicon_16_path']);

    // Delete
    $result = $this->service->deleteFavicons($organization);

    expect($result)->toBeTrue();
    Storage::disk('public')->assertMissing($generatedPaths['favicon_16_path']);
});
```

### Integration Tests

**File:** `tests/Feature/Enterprise/FaviconGenerationTest.php`

```php
<?php

use App\Models\Organization;
use App\Models\User;
use App\Models\WhiteLabelConfig;
use Illuminate\Http\UploadedFile;
use Illuminate\Support\Facades\Storage;

it('generates favicons on logo upload', function () {
    Storage::fake('public');

    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'admin']);

    $file = UploadedFile::fake()->image('logo.png', 512, 512);

    $this->actingAs($user)
        ->post(route('enterprise.whitelabel.logo.upload', $organization), [
            'logo' => $file,
            'logo_type' => 'favicon',
        ])
        ->assertRedirect()
        ->assertSessionHas('success');

    $config = $organization->whiteLabelConfig;

    // Verify favicon paths were saved
    expect($config->favicon_16_path)->not->toBeNull();
    expect($config->favicon_32_path)->not->toBeNull();
    expect($config->favicon_512_path)->not->toBeNull();
    expect($config->manifest_path)->not->toBeNull();

    // Verify files exist
    Storage::disk('public')->assertExists($config->favicon_16_path);
    Storage::disk('public')->assertExists($config->manifest_path);
});

it('handles favicon generation errors gracefully', function () {
    Storage::fake('public');

    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'admin']);

    // Upload image that's too small
    $file = UploadedFile::fake()->image('small.png', 50, 50);

    $this->actingAs($user)
        ->post(route('enterprise.whitelabel.logo.upload', $organization), [
            'logo' => $file,
            'logo_type' => 'favicon',
        ])
        ->assertRedirect()
        ->assertSessionHas('warning'); // Logo uploaded but favicons failed
});
```

### Artisan Command Tests

```php
it('generates favicons via artisan command', function () {
    Storage::fake('public');

    $organization = Organization::factory()->create();
    $config = WhiteLabelConfig::factory()->create([
        'organization_id' => $organization->id,
    ]);

    // Upload a logo first
    $file = UploadedFile::fake()->image('logo.png', 512, 512);
    $path = $file->store("branding/{$organization->id}/logos", 'public');
    $config->update(['primary_logo_path' => $path]);

    $this->artisan('branding:generate-favicons', ['organization' => $organization->id])
        ->assertSuccessful()
        ->expectsOutput("Generated favicons for: {$organization->name}");

    $config->refresh();
    expect($config->favicon_16_path)->not->toBeNull();
});
```

## Definition of Done

- [ ] FaviconGeneratorServiceInterface created
- [ ] FaviconGeneratorService implemented with image processing
- [ ] Service registered in EnterpriseServiceProvider
- [ ] Database migration created for favicon columns
- [ ] Migration run successfully
- [ ] WhiteLabelConfig model updated with favicon accessors
- [ ] Intervention Image library installed
- [ ] Favicon generation for 8 sizes (16, 32, 48, 144, 180, 192, 270, 512)
- [ ] Multi-resolution favicon.ico generation
- [ ] Apple Touch Icon generation (180x180, opaque)
- [ ] Web manifest generation with PWA support
- [ ] HTML meta tags generation
- [ ] Source image validation (size, format)
- [ ] Error handling for invalid/corrupted images
- [ ] WhiteLabelController integration complete
- [ ] Automatic favicon generation on logo upload
- [ ] GenerateFavicons Artisan command created
- [ ] Bulk regeneration support
- [ ] Unit tests written (10+ tests, >90% coverage)
- [ ] Integration tests written (5+ tests)
- [ ] Command tests written
- [ ] Manual testing with various image sizes/formats
- [ ] Code follows Laravel 12 and Coolify standards
- [ ] Laravel Pint formatting applied
- [ ] PHPStan level 5 passing
- [ ] Documentation updated
- [ ] Code reviewed and approved
- [ ] Performance verified (generation < 5 seconds per org)

## Related Tasks

- **Triggered by:** Task 4 (LogoUploader.vue uploads source image)
- **Integrates with:** Task 2 (DynamicAssetController serves favicons)
- **Used by:** Task 8 (BrandingPreview.vue displays favicons)
- **Used by:** Task 9 (Email templates include favicon in branding)
- **Cached by:** Task 3 (Redis caching for performance)
- **Managed by:** Task 5 (BrandingManager.vue UI for branding)
