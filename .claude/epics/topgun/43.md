---
name: Implement PaymentGatewayInterface and factory pattern
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:38:59Z
github: https://github.com/johnproblems/topgun/issues/152
depends_on: [42]
parallel: false
conflicts_with: []
---

# Task: Implement PaymentGatewayInterface and factory pattern

## Description

Create a unified payment gateway abstraction with a factory pattern to support multiple payment processors (Stripe, PayPal, Square) interchangeably. This interface ensures consistent payment processing regardless of the underlying gateway while allowing gateway-specific implementations.

## Technical Implementation

### PaymentGatewayInterface Contract

```php
<?php

namespace App\Contracts;

use App\Models\Organization;
use App\Models\PaymentMethod;
use App\Models\OrganizationSubscription;

interface PaymentGatewayInterface
{
    /**
     * Initialize payment gateway with credentials
     */
    public function initialize(array $credentials): void;

    /**
     * Create a customer in the payment gateway
     */
    public function createCustomer(Organization $organization): string;

    /**
     * Create a payment method (card, bank account, etc.)
     *
     * @param string $gatewayToken Token from client-side SDK
     * @return array ['gateway_payment_method_id' => string, 'metadata' => array]
     */
    public function createPaymentMethod(string $customerId, string $gatewayToken): array;

    /**
     * Attach payment method to customer
     */
    public function attachPaymentMethod(string $customerId, string $paymentMethodId): bool;

    /**
     * Set default payment method for customer
     */
    public function setDefaultPaymentMethod(string $customerId, string $paymentMethodId): bool;

    /**
     * Create a subscription
     *
     * @param array $config ['plan_id' => string, 'trial_days' => int, 'metadata' => array]
     * @return array ['gateway_subscription_id' => string, 'status' => string, 'current_period_end' => Carbon]
     */
    public function createSubscription(string $customerId, array $config): array;

    /**
     * Update subscription (change plan, quantity, etc.)
     */
    public function updateSubscription(string $subscriptionId, array $updates): array;

    /**
     * Cancel subscription (immediate or at period end)
     */
    public function cancelSubscription(string $subscriptionId, bool $immediate = false): bool;

    /**
     * Pause subscription (if supported by gateway)
     */
    public function pauseSubscription(string $subscriptionId): bool;

    /**
     * Resume paused subscription
     */
    public function resumeSubscription(string $subscriptionId): bool;

    /**
     * Process one-time payment
     *
     * @param int $amountInCents Amount in smallest currency unit (cents)
     * @return array ['gateway_transaction_id' => string, 'status' => string, 'fee' => int]
     */
    public function processPayment(
        string $customerId,
        string $paymentMethodId,
        int $amountInCents,
        string $currency = 'USD',
        array $metadata = []
    ): array;

    /**
     * Refund a transaction (full or partial)
     */
    public function refundPayment(string $transactionId, ?int $amountInCents = null, ?string $reason = null): array;

    /**
     * Retrieve subscription details from gateway
     */
    public function getSubscription(string $subscriptionId): array;

    /**
     * Retrieve payment method details from gateway
     */
    public function getPaymentMethod(string $paymentMethodId): array;

    /**
     * Verify webhook signature for security
     */
    public function verifyWebhookSignature(string $payload, string $signature, string $secret): bool;

    /**
     * Parse webhook event into standardized format
     *
     * @return array ['event_type' => string, 'event_id' => string, 'data' => array]
     */
    public function parseWebhookEvent(string $payload): array;

    /**
     * Get client-side SDK initialization parameters
     *
     * @return array ['publishable_key' => string, 'client_id' => string, etc.]
     */
    public function getClientSdkConfig(): array;

    /**
     * Test gateway credentials validity
     */
    public function testConnection(): bool;

    /**
     * Get gateway name identifier
     */
    public function getGatewayName(): string;
}
```

### PaymentGatewayFactory Implementation

```php
<?php

namespace App\Services\Enterprise\Payment;

use App\Contracts\PaymentGatewayInterface;
use App\Models\PaymentGatewayCredential;
use App\Services\Enterprise\Payment\Gateways\StripeGateway;
use App\Services\Enterprise\Payment\Gateways\PayPalGateway;
use App\Services\Enterprise\Payment\Gateways\SquareGateway;
use InvalidArgumentException;

class PaymentGatewayFactory
{
    /**
     * Registered gateway implementations
     */
    protected static array $gateways = [
        'stripe' => StripeGateway::class,
        'paypal' => PayPalGateway::class,
        'square' => SquareGateway::class,
    ];

    /**
     * Create gateway instance from database credentials
     */
    public static function make(string $gateway): PaymentGatewayInterface
    {
        if (!isset(self::$gateways[$gateway])) {
            throw new InvalidArgumentException("Unsupported payment gateway: {$gateway}");
        }

        $credentials = PaymentGatewayCredential::where('gateway', $gateway)
            ->where('is_active', true)
            ->firstOrFail();

        $gatewayClass = self::$gateways[$gateway];
        $instance = app($gatewayClass);

        $instance->initialize([
            'public_key' => $credentials->public_key,
            'secret_key' => $credentials->secret_key,
            'webhook_secret' => $credentials->webhook_secret,
            'client_id' => $credentials->client_id,
            'client_secret' => $credentials->client_secret,
            'application_id' => $credentials->application_id,
            'location_id' => $credentials->location_id,
            'is_test_mode' => $credentials->is_test_mode,
            'configuration' => $credentials->configuration ?? [],
        ]);

        return $instance;
    }

    /**
     * Create gateway instance with custom credentials (for testing)
     */
    public static function makeWithCredentials(string $gateway, array $credentials): PaymentGatewayInterface
    {
        if (!isset(self::$gateways[$gateway])) {
            throw new InvalidArgumentException("Unsupported payment gateway: {$gateway}");
        }

        $gatewayClass = self::$gateways[$gateway];
        $instance = app($gatewayClass);
        $instance->initialize($credentials);

        return $instance;
    }

    /**
     * Get list of supported gateways
     */
    public static function supportedGateways(): array
    {
        return array_keys(self::$gateways);
    }

    /**
     * Check if gateway is supported
     */
    public static function isSupported(string $gateway): bool
    {
        return isset(self::$gateways[$gateway]);
    }

    /**
     * Register a custom gateway implementation
     */
    public static function register(string $name, string $class): void
    {
        if (!in_array(PaymentGatewayInterface::class, class_implements($class))) {
            throw new InvalidArgumentException("{$class} must implement PaymentGatewayInterface");
        }

        self::$gateways[$name] = $class;
    }
}
```

### Abstract Base Gateway Class

```php
<?php

namespace App\Services\Enterprise\Payment\Gateways;

use App\Contracts\PaymentGatewayInterface;
use Illuminate\Support\Facades\Log;

abstract class AbstractPaymentGateway implements PaymentGatewayInterface
{
    protected array $credentials = [];
    protected bool $isTestMode = false;

    public function initialize(array $credentials): void
    {
        $this->credentials = $credentials;
        $this->isTestMode = $credentials['is_test_mode'] ?? false;

        $this->validateCredentials();
        $this->configureClient();
    }

    /**
     * Validate required credentials are present
     */
    abstract protected function validateCredentials(): void;

    /**
     * Configure gateway-specific client
     */
    abstract protected function configureClient(): void;

    /**
     * Log gateway operation for debugging
     */
    protected function logOperation(string $operation, array $context = []): void
    {
        Log::channel('payment')->info("[{$this->getGatewayName()}] {$operation}", $context);
    }

    /**
     * Log gateway error
     */
    protected function logError(string $operation, \Throwable $exception, array $context = []): void
    {
        Log::channel('payment')->error(
            "[{$this->getGatewayName()}] {$operation} failed: {$exception->getMessage()}",
            array_merge($context, [
                'exception' => $exception,
                'trace' => $exception->getTraceAsString(),
            ])
        );
    }

    /**
     * Convert amount from dollars to cents
     */
    protected function dollarsToCents(float $amount): int
    {
        return (int) round($amount * 100);
    }

    /**
     * Convert amount from cents to dollars
     */
    protected function centsToDollars(int $cents): float
    {
        return round($cents / 100, 2);
    }
}
```

### Gateway Exception Hierarchy

```php
<?php

namespace App\Exceptions\Payment;

use Exception;

class PaymentGatewayException extends Exception
{
    protected array $context = [];

    public function __construct(string $message, array $context = [], ?\Throwable $previous = null)
    {
        parent::__construct($message, 0, $previous);
        $this->context = $context;
    }

    public function getContext(): array
    {
        return $this->context;
    }
}

class PaymentFailedException extends PaymentGatewayException {}
class RefundFailedException extends PaymentGatewayException {}
class SubscriptionCreationException extends PaymentGatewayException {}
class InvalidWebhookSignatureException extends PaymentGatewayException {}
class GatewayConfigurationException extends PaymentGatewayException {}
```

### Service Provider Registration

```php
<?php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;
use App\Contracts\PaymentGatewayInterface;
use App\Services\Enterprise\Payment\PaymentGatewayFactory;

class PaymentServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        // Bind gateway factory as singleton
        $this->app->singleton('payment.gateway.factory', function () {
            return new PaymentGatewayFactory();
        });

        // Allow dependency injection of gateways
        $this->app->bind(PaymentGatewayInterface::class, function ($app, $params) {
            $gateway = $params['gateway'] ?? config('payment.default_gateway');
            return PaymentGatewayFactory::make($gateway);
        });
    }

    public function boot(): void
    {
        // Register custom logging channel for payments
        config(['logging.channels.payment' => [
            'driver' => 'daily',
            'path' => storage_path('logs/payment.log'),
            'level' => env('LOG_LEVEL', 'debug'),
            'days' => 90,
        ]]);
    }
}
```

### Configuration File

```php
<?php

// config/payment.php
return [
    'default_gateway' => env('PAYMENT_DEFAULT_GATEWAY', 'stripe'),

    'currency' => env('PAYMENT_DEFAULT_CURRENCY', 'USD'),

    'gateways' => [
        'stripe' => [
            'public_key' => env('PAYMENT_STRIPE_PUBLIC_KEY'),
            'secret_key' => env('PAYMENT_STRIPE_SECRET_KEY'),
            'webhook_secret' => env('PAYMENT_STRIPE_WEBHOOK_SECRET'),
        ],
        'paypal' => [
            'client_id' => env('PAYMENT_PAYPAL_CLIENT_ID'),
            'client_secret' => env('PAYMENT_PAYPAL_CLIENT_SECRET'),
            'mode' => env('PAYMENT_PAYPAL_MODE', 'sandbox'), // sandbox or live
        ],
        'square' => [
            'application_id' => env('PAYMENT_SQUARE_APPLICATION_ID'),
            'access_token' => env('PAYMENT_SQUARE_ACCESS_TOKEN'),
            'location_id' => env('PAYMENT_SQUARE_LOCATION_ID'),
        ],
    ],

    'webhook_tolerance' => 300, // 5 minutes tolerance for webhook timestamps

    'retry' => [
        'attempts' => 3,
        'delay' => 1000, // milliseconds
    ],
];
```

## Testing Requirements

### Factory Tests

```php
use App\Services\Enterprise\Payment\PaymentGatewayFactory;
use App\Models\PaymentGatewayCredential;

it('creates stripe gateway instance', function () {
    PaymentGatewayCredential::factory()->create([
        'gateway' => 'stripe',
        'is_active' => true,
    ]);

    $gateway = PaymentGatewayFactory::make('stripe');

    expect($gateway)->toBeInstanceOf(PaymentGatewayInterface::class);
    expect($gateway->getGatewayName())->toBe('stripe');
});

it('throws exception for unsupported gateway', function () {
    PaymentGatewayFactory::make('unsupported');
})->throws(InvalidArgumentException::class);

it('allows custom gateway registration', function () {
    PaymentGatewayFactory::register('custom', CustomGateway::class);

    expect(PaymentGatewayFactory::isSupported('custom'))->toBeTrue();
});

it('lists all supported gateways', function () {
    $gateways = PaymentGatewayFactory::supportedGateways();

    expect($gateways)->toContain('stripe', 'paypal', 'square');
});
```

### Interface Compliance Tests

```php
it('stripe gateway implements all interface methods', function () {
    $gateway = app(StripeGateway::class);

    expect($gateway)->toBeInstanceOf(PaymentGatewayInterface::class);

    $methods = get_class_methods(PaymentGatewayInterface::class);
    foreach ($methods as $method) {
        expect(method_exists($gateway, $method))->toBeTrue();
    }
});
```

## Acceptance Criteria

- [ ] `PaymentGatewayInterface` created with all required methods
- [ ] `PaymentGatewayFactory` implemented with make() and registration
- [ ] `AbstractPaymentGateway` base class with common functionality
- [ ] Gateway exception hierarchy for error handling
- [ ] Service provider registered in `config/app.php`
- [ ] Configuration file with gateway credentials structure
- [ ] Payment logging channel configured
- [ ] Interface allows gateway-specific features via metadata
- [ ] Factory supports runtime gateway registration
- [ ] All methods documented with PHPDoc types

## Technical Details

- **Size:** M (Medium complexity)
- **Estimated hours:** 10-14
- **Pattern:** Factory + Strategy pattern
- **Testing:** Interface compliance tests for all gateways

## Dependencies

- [ ] Task 42 (database schema for credentials)
- [ ] Laravel service container for dependency injection
- [ ] PSR-3 logging interface

## Definition of Done

- [ ] Interface file created with all method signatures
- [ ] Factory class implemented and tested
- [ ] Abstract base class created
- [ ] Exception classes defined
- [ ] Service provider registered
- [ ] Configuration file published
- [ ] All tests passing (`php artisan test --filter=PaymentGateway`)
- [ ] PHPStan level 5 compliance
- [ ] Code reviewed and merged

## Related Tasks

- **Depends on:** Task 42 (payment schema)
- **Blocks:** Tasks 44, 45 (gateway implementations)
- **Enables:** Multi-gateway payment processing flexibility
