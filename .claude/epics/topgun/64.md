---
name: Integrate Namecheap API for domain management
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:39:17Z
github: https://github.com/johnproblems/topgun/issues/172
depends_on: [63]
parallel: false
conflicts_with: []
---

# Task: Integrate Namecheap API for domain management

## Description

This task implements a comprehensive Namecheap domain registrar integration that enables organizations to register, transfer, renew, and manage domain names directly from their white-labeled Coolify platform. Namecheap is one of the world's largest domain registrars, offering competitive pricing, robust APIs, and comprehensive domain management capabilities.

The integration provides a complete domain lifecycle management system:

1. **Domain Registration** - Register new domains with automatic DNS setup
2. **Domain Transfer** - Transfer domains from other registrars with EPP code handling
3. **Domain Renewal** - Automatic renewal with configurable auto-renew settings
4. **Contact Management** - Manage registrant, admin, tech, and billing contacts
5. **DNS Management** - Create and manage DNS records for registered domains
6. **Domain Privacy** - WhoisGuard privacy protection management
7. **SSL Certificates** - Purchase and provision SSL certificates via Namecheap

This integration extends the domain management system foundation (Task 63 - DomainRegistrarInterface) by implementing a concrete Namecheap provider. It works seamlessly with the existing domain architecture:

- **Implements:** `DomainRegistrarInterface` for standardized domain operations
- **Integrates with:** `DomainRegistrarService` for unified registrar management
- **Uses:** `OrganizationDomain` model for domain storage
- **Connects to:** Application domain binding for automatic DNS configuration
- **Triggers:** SSL certificate provisioning for secure domains

**Why this task is important:** Namecheap is a leading domain registrar with over 18 million domains under management. Organizations using white-labeled Coolify platforms need the ability to register and manage domains directly within their platform. This integration eliminates the need to manage domains externally, streamlining application deployment workflows. Automatic DNS configuration when domains are registered ensures applications can go live immediately without manual DNS setup. The integration also enables automated SSL certificate provisioning, critical for production applications.

**Key Features:**

- **Automated DNS Setup** - Automatically configure DNS records when domains are registered or transferred
- **Contact Validation** - Validate and store registrant contact information with WHOIS compliance
- **Auto-Renewal Management** - Configure automatic domain renewal to prevent expiration
- **Domain Privacy Protection** - Enable/disable WhoisGuard privacy for domain WHOIS records
- **SSL Certificate Integration** - Purchase and install SSL certificates for domains
- **Domain Search** - Search domain availability and get pricing information

## Acceptance Criteria

- [ ] NamecheapRegistrar class implements DomainRegistrarInterface completely
- [ ] Domain availability checking returns accurate results with pricing
- [ ] Domain registration completes successfully with all required contact fields
- [ ] Domain transfer initiates with EPP code validation
- [ ] Domain renewal updates expiration date correctly
- [ ] Contact information management (registrant, admin, tech, billing) works properly
- [ ] DNS record creation/update/deletion via Namecheap API functions correctly
- [ ] WhoisGuard privacy protection can be enabled/disabled
- [ ] SSL certificate purchase and installation flow works end-to-end
- [ ] API error handling covers all Namecheap error codes (authentication, invalid parameters, domain unavailable, etc.)
- [ ] Rate limiting implemented to respect Namecheap API limits (production: 700/min, sandbox: 50/min)
- [ ] Webhook handling for domain transfer status updates
- [ ] All domain operations logged with organization context
- [ ] Comprehensive error messages for common failures (insufficient funds, invalid contact, transfer locked)
- [ ] Environment detection (sandbox vs production) based on configuration

## Technical Details

### File Paths

**Service Implementation:**
- `/home/topgun/topgun/app/Services/Enterprise/Domain/NamecheapRegistrar.php` (new)

**Configuration:**
- `/home/topgun/topgun/config/services.php` (modify - add Namecheap config)

**Models (existing, from Task 62-63):**
- `/home/topgun/topgun/app/Models/Enterprise/OrganizationDomain.php`
- `/home/topgun/topgun/app/Models/Enterprise/DnsRecord.php`
- `/home/topgun/topgun/app/Models/Enterprise/DomainContact.php`

**Contracts (existing, from Task 63):**
- `/home/topgun/topgun/app/Contracts/DomainRegistrarInterface.php`

**Service Provider:**
- `/home/topgun/topgun/app/Providers/EnterpriseServiceProvider.php` (modify - register NamecheapRegistrar)

### Namecheap API Overview

**API Endpoint:**
- **Production:** `https://api.namecheap.com/xml.response`
- **Sandbox:** `https://api.sandbox.namecheap.com/xml.response`

**Authentication:**
- API Key (obtained from Namecheap account)
- API User (Namecheap username)
- Username (usually same as API User)
- Client IP (must be whitelisted in Namecheap dashboard)

**Common Parameters:**
- `ApiUser` - API username
- `ApiKey` - API key
- `UserName` - Account username
- `ClientIp` - IP address making the request
- `Command` - API command (e.g., `namecheap.domains.check`, `namecheap.domains.create`)

**Response Format:**
XML responses with structure:
```xml
<?xml version="1.0" encoding="utf-8"?>
<ApiResponse Status="OK" xmlns="http://api.namecheap.com/xml.response">
  <Errors/>
  <Warnings/>
  <RequestedCommand>namecheap.domains.check</RequestedCommand>
  <CommandResponse Type="namecheap.domains.check">
    <!-- Command-specific data -->
  </CommandResponse>
  <Server>SERVER-NAME</Server>
  <GMTTimeDifference>--5:00</GMTTimeDifference>
  <ExecutionTime>0.009</ExecutionTime>
</ApiResponse>
```

### NamecheapRegistrar Implementation

**File:** `app/Services/Enterprise/Domain/NamecheapRegistrar.php`

```php
<?php

namespace App\Services\Enterprise\Domain;

use App\Contracts\DomainRegistrarInterface;
use App\Models\Enterprise\OrganizationDomain;
use App\Models\Enterprise\DomainContact;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;
use Carbon\Carbon;

class NamecheapRegistrar implements DomainRegistrarInterface
{
    private const API_PRODUCTION = 'https://api.namecheap.com/xml.response';
    private const API_SANDBOX = 'https://api.sandbox.namecheap.com/xml.response';

    private string $apiUser;
    private string $apiKey;
    private string $userName;
    private string $clientIp;
    private string $apiEndpoint;
    private bool $sandbox;

    public function __construct()
    {
        $this->apiUser = config('services.namecheap.api_user');
        $this->apiKey = config('services.namecheap.api_key');
        $this->userName = config('services.namecheap.username', $this->apiUser);
        $this->clientIp = config('services.namecheap.client_ip');
        $this->sandbox = config('services.namecheap.sandbox', false);

        $this->apiEndpoint = $this->sandbox ? self::API_SANDBOX : self::API_PRODUCTION;
    }

    /**
     * Check if domain is available for registration
     *
     * @param string $domain
     * @return array ['available' => bool, 'price' => float, 'currency' => string, 'premium' => bool]
     */
    public function checkAvailability(string $domain): array
    {
        $response = $this->makeRequest('namecheap.domains.check', [
            'DomainList' => $domain,
        ]);

        $domainCheck = $response['CommandResponse']['DomainCheckResult'];

        // Handle both single domain and array of domains
        if (!isset($domainCheck[0])) {
            $domainCheck = [$domainCheck];
        }

        $result = $domainCheck[0];

        return [
            'available' => $result['@attributes']['Available'] === 'true',
            'price' => (float) ($result['@attributes']['EAPFee'] ?? 0),
            'currency' => 'USD',
            'premium' => isset($result['@attributes']['IsPremiumName']) &&
                        $result['@attributes']['IsPremiumName'] === 'true',
            'domain' => $domain,
        ];
    }

    /**
     * Register a new domain
     *
     * @param string $domain
     * @param int $years
     * @param array $contactInfo
     * @param array $options ['auto_renew' => bool, 'privacy' => bool, 'nameservers' => array]
     * @return OrganizationDomain
     * @throws \Exception
     */
    public function registerDomain(
        string $domain,
        int $years,
        array $contactInfo,
        array $options = []
    ): OrganizationDomain {
        // Validate contact information
        $this->validateContactInfo($contactInfo);

        // Prepare parameters
        $params = [
            'DomainName' => $domain,
            'Years' => $years,
            'AddFreeWhoisguard' => $options['privacy'] ?? true ? 'yes' : 'no',
            'WGEnabled' => $options['privacy'] ?? true ? 'yes' : 'no',
        ];

        // Add contact information
        $params = array_merge($params, $this->formatContactInfo('Registrant', $contactInfo));
        $params = array_merge($params, $this->formatContactInfo('Tech', $contactInfo));
        $params = array_merge($params, $this->formatContactInfo('Admin', $contactInfo));
        $params = array_merge($params, $this->formatContactInfo('AuxBilling', $contactInfo));

        // Add custom nameservers if provided
        if (!empty($options['nameservers'])) {
            $params['Nameservers'] = implode(',', $options['nameservers']);
        }

        try {
            $response = $this->makeRequest('namecheap.domains.create', $params);

            $domainCreateResult = $response['CommandResponse']['DomainCreateResult'];

            // Store domain in database
            $organizationDomain = OrganizationDomain::create([
                'organization_id' => $contactInfo['organization_id'],
                'domain' => $domain,
                'registrar' => 'namecheap',
                'registered_at' => now(),
                'expires_at' => now()->addYears($years),
                'auto_renew' => $options['auto_renew'] ?? false,
                'privacy_enabled' => $options['privacy'] ?? true,
                'status' => 'active',
                'registrar_domain_id' => $domainCreateResult['@attributes']['DomainID'] ?? null,
                'metadata' => [
                    'order_id' => $domainCreateResult['@attributes']['OrderID'] ?? null,
                    'transaction_id' => $domainCreateResult['@attributes']['TransactionID'] ?? null,
                    'charged_amount' => $domainCreateResult['@attributes']['ChargedAmount'] ?? null,
                ],
            ]);

            // Store contact information
            $this->storeContactInfo($organizationDomain, $contactInfo);

            // Set up default DNS records if custom nameservers not provided
            if (empty($options['nameservers'])) {
                $this->setupDefaultDns($organizationDomain);
            }

            Log::info("Domain registered successfully via Namecheap", [
                'domain' => $domain,
                'organization_id' => $contactInfo['organization_id'],
                'years' => $years,
            ]);

            return $organizationDomain;

        } catch (\Exception $e) {
            Log::error("Namecheap domain registration failed", [
                'domain' => $domain,
                'error' => $e->getMessage(),
            ]);

            throw new \Exception("Failed to register domain: {$e->getMessage()}");
        }
    }

    /**
     * Transfer domain from another registrar
     *
     * @param string $domain
     * @param string $authCode EPP authorization code
     * @param array $contactInfo
     * @param array $options
     * @return OrganizationDomain
     * @throws \Exception
     */
    public function transferDomain(
        string $domain,
        string $authCode,
        array $contactInfo,
        array $options = []
    ): OrganizationDomain {
        $this->validateContactInfo($contactInfo);

        $params = [
            'DomainName' => $domain,
            'EPPCode' => $authCode,
            'AddFreeWhoisguard' => $options['privacy'] ?? true ? 'yes' : 'no',
        ];

        // Add contact information (only required for some TLDs)
        $params = array_merge($params, $this->formatContactInfo('Registrant', $contactInfo));

        try {
            $response = $this->makeRequest('namecheap.domains.transfer.create', $params);

            $transferResult = $response['CommandResponse']['DomainTransferCreateResult'];

            // Domain transfers take time, create with pending status
            $organizationDomain = OrganizationDomain::create([
                'organization_id' => $contactInfo['organization_id'],
                'domain' => $domain,
                'registrar' => 'namecheap',
                'registered_at' => null, // Will be set when transfer completes
                'expires_at' => null, // Will be updated when transfer completes
                'auto_renew' => $options['auto_renew'] ?? false,
                'privacy_enabled' => $options['privacy'] ?? true,
                'status' => 'pending_transfer',
                'registrar_domain_id' => $transferResult['@attributes']['Transfer'] ?? null,
                'metadata' => [
                    'transfer_id' => $transferResult['@attributes']['TransferID'] ?? null,
                    'order_id' => $transferResult['@attributes']['OrderID'] ?? null,
                    'transaction_id' => $transferResult['@attributes']['TransactionID'] ?? null,
                    'status_id' => $transferResult['@attributes']['StatusID'] ?? null,
                ],
            ]);

            $this->storeContactInfo($organizationDomain, $contactInfo);

            Log::info("Domain transfer initiated via Namecheap", [
                'domain' => $domain,
                'organization_id' => $contactInfo['organization_id'],
            ]);

            return $organizationDomain;

        } catch (\Exception $e) {
            Log::error("Namecheap domain transfer failed", [
                'domain' => $domain,
                'error' => $e->getMessage(),
            ]);

            throw new \Exception("Failed to transfer domain: {$e->getMessage()}");
        }
    }

    /**
     * Renew domain registration
     *
     * @param OrganizationDomain $domain
     * @param int $years
     * @return OrganizationDomain
     * @throws \Exception
     */
    public function renewDomain(OrganizationDomain $domain, int $years = 1): OrganizationDomain
    {
        $params = [
            'DomainName' => $domain->domain,
            'Years' => $years,
        ];

        try {
            $response = $this->makeRequest('namecheap.domains.renew', $params);

            $renewResult = $response['CommandResponse']['DomainRenewResult'];

            // Update expiration date
            $newExpiration = Carbon::parse($renewResult['@attributes']['Expires']);

            $domain->update([
                'expires_at' => $newExpiration,
                'metadata' => array_merge($domain->metadata ?? [], [
                    'last_renewal_order_id' => $renewResult['@attributes']['OrderID'] ?? null,
                    'last_renewal_transaction_id' => $renewResult['@attributes']['TransactionID'] ?? null,
                    'last_renewal_charged_amount' => $renewResult['@attributes']['ChargedAmount'] ?? null,
                    'last_renewed_at' => now()->toIso8601String(),
                ]),
            ]);

            Log::info("Domain renewed successfully via Namecheap", [
                'domain' => $domain->domain,
                'years' => $years,
                'new_expiration' => $newExpiration->toDateString(),
            ]);

            return $domain->fresh();

        } catch (\Exception $e) {
            Log::error("Namecheap domain renewal failed", [
                'domain' => $domain->domain,
                'error' => $e->getMessage(),
            ]);

            throw new \Exception("Failed to renew domain: {$e->getMessage()}");
        }
    }

    /**
     * Get domain information
     *
     * @param string $domain
     * @return array
     * @throws \Exception
     */
    public function getDomainInfo(string $domain): array
    {
        $response = $this->makeRequest('namecheap.domains.getInfo', [
            'DomainName' => $domain,
        ]);

        $info = $response['CommandResponse']['DomainGetInfoResult'];

        return [
            'domain' => $domain,
            'status' => $info['@attributes']['Status'],
            'registered_at' => Carbon::parse($info['DomainDetails']['CreatedDate']),
            'expires_at' => Carbon::parse($info['DomainDetails']['ExpiredDate']),
            'auto_renew' => $info['Modificationrights']['@attributes']['All'] === 'true',
            'locked' => $info['@attributes']['IsLocked'] === 'true',
            'nameservers' => $this->extractNameservers($info['DnsDetails']),
            'whoisguard_enabled' => isset($info['Whoisguard']) &&
                                    $info['Whoisguard']['@attributes']['Enabled'] === 'True',
        ];
    }

    /**
     * Update domain nameservers
     *
     * @param OrganizationDomain $domain
     * @param array $nameservers
     * @return bool
     * @throws \Exception
     */
    public function setNameservers(OrganizationDomain $domain, array $nameservers): bool
    {
        if (count($nameservers) < 2) {
            throw new \Exception("At least 2 nameservers are required");
        }

        $params = [
            'SLD' => $this->getSld($domain->domain),
            'TLD' => $this->getTld($domain->domain),
            'Nameservers' => implode(',', $nameservers),
        ];

        try {
            $response = $this->makeRequest('namecheap.domains.dns.setCustom', $params);

            $result = $response['CommandResponse']['DomainDNSSetCustomResult'];

            if ($result['@attributes']['Updated'] === 'true') {
                $domain->update([
                    'metadata' => array_merge($domain->metadata ?? [], [
                        'nameservers' => $nameservers,
                        'nameservers_updated_at' => now()->toIso8601String(),
                    ]),
                ]);

                Log::info("Nameservers updated via Namecheap", [
                    'domain' => $domain->domain,
                    'nameservers' => $nameservers,
                ]);

                return true;
            }

            return false;

        } catch (\Exception $e) {
            Log::error("Failed to update nameservers via Namecheap", [
                'domain' => $domain->domain,
                'error' => $e->getMessage(),
            ]);

            throw new \Exception("Failed to update nameservers: {$e->getMessage()}");
        }
    }

    /**
     * Create DNS host record
     *
     * @param OrganizationDomain $domain
     * @param string $hostname
     * @param string $type
     * @param string $value
     * @param int $ttl
     * @param int $priority
     * @return bool
     * @throws \Exception
     */
    public function createDnsRecord(
        OrganizationDomain $domain,
        string $hostname,
        string $type,
        string $value,
        int $ttl = 1800,
        int $priority = 10
    ): bool {
        // Get existing records
        $existingRecords = $this->getDnsRecords($domain);

        // Add new record
        $newRecord = [
            'hostname' => $hostname,
            'type' => strtoupper($type),
            'value' => $value,
            'ttl' => $ttl,
            'priority' => $type === 'MX' ? $priority : null,
        ];

        $existingRecords[] = $newRecord;

        // Update all records (Namecheap requires full record set update)
        return $this->setAllDnsRecords($domain, $existingRecords);
    }

    /**
     * Update DNS record
     *
     * @param OrganizationDomain $domain
     * @param int $recordId
     * @param array $data
     * @return bool
     * @throws \Exception
     */
    public function updateDnsRecord(OrganizationDomain $domain, int $recordId, array $data): bool
    {
        // Get existing records
        $existingRecords = $this->getDnsRecords($domain);

        // Update specific record
        if (isset($existingRecords[$recordId])) {
            $existingRecords[$recordId] = array_merge($existingRecords[$recordId], $data);
        }

        return $this->setAllDnsRecords($domain, $existingRecords);
    }

    /**
     * Delete DNS record
     *
     * @param OrganizationDomain $domain
     * @param int $recordId
     * @return bool
     * @throws \Exception
     */
    public function deleteDnsRecord(OrganizationDomain $domain, int $recordId): bool
    {
        // Get existing records
        $existingRecords = $this->getDnsRecords($domain);

        // Remove specific record
        unset($existingRecords[$recordId]);

        return $this->setAllDnsRecords($domain, array_values($existingRecords));
    }

    /**
     * Get DNS records for domain
     *
     * @param OrganizationDomain $domain
     * @return array
     * @throws \Exception
     */
    public function getDnsRecords(OrganizationDomain $domain): array
    {
        $response = $this->makeRequest('namecheap.domains.dns.getHosts', [
            'SLD' => $this->getSld($domain->domain),
            'TLD' => $this->getTld($domain->domain),
        ]);

        $hosts = $response['CommandResponse']['DomainDNSGetHostsResult']['host'] ?? [];

        // Handle single record vs array of records
        if (!isset($hosts[0])) {
            $hosts = [$hosts];
        }

        return array_map(function ($host) {
            return [
                'hostname' => $host['@attributes']['Name'],
                'type' => $host['@attributes']['Type'],
                'value' => $host['@attributes']['Address'],
                'ttl' => (int) $host['@attributes']['TTL'],
                'priority' => isset($host['@attributes']['MXPref']) ?
                             (int) $host['@attributes']['MXPref'] : null,
            ];
        }, $hosts);
    }

    /**
     * Enable or disable WhoisGuard privacy protection
     *
     * @param OrganizationDomain $domain
     * @param bool $enable
     * @return bool
     * @throws \Exception
     */
    public function setPrivacyProtection(OrganizationDomain $domain, bool $enable): bool
    {
        $response = $this->makeRequest('namecheap.whoisguard.enable', [
            'WhoisguardID' => $domain->metadata['whoisguard_id'] ?? null,
            'ForwardedToEmail' => $domain->metadata['forwarded_email'] ?? null,
        ]);

        $result = $response['CommandResponse']['WhoisguardEnableResult'];

        if ($result['@attributes']['IsSuccess'] === 'true') {
            $domain->update(['privacy_enabled' => $enable]);

            Log::info("WhoisGuard privacy {$enable ? 'enabled' : 'disabled'} via Namecheap", [
                'domain' => $domain->domain,
            ]);

            return true;
        }

        return false;
    }

    /**
     * Make HTTP request to Namecheap API
     *
     * @param string $command
     * @param array $params
     * @return array
     * @throws \Exception
     */
    private function makeRequest(string $command, array $params = []): array
    {
        $baseParams = [
            'ApiUser' => $this->apiUser,
            'ApiKey' => $this->apiKey,
            'UserName' => $this->userName,
            'ClientIp' => $this->clientIp,
            'Command' => $command,
        ];

        $allParams = array_merge($baseParams, $params);

        try {
            $response = Http::timeout(30)->get($this->apiEndpoint, $allParams);

            if (!$response->successful()) {
                throw new \Exception("Namecheap API HTTP error: {$response->status()}");
            }

            $xml = simplexml_load_string($response->body());
            $json = json_encode($xml);
            $data = json_decode($json, true);

            // Check for API errors
            if ($data['@attributes']['Status'] === 'ERROR') {
                $errors = $data['Errors']['Error'];

                // Handle single error vs array of errors
                if (!isset($errors[0])) {
                    $errors = [$errors];
                }

                $errorMessages = array_map(fn($e) => $e['#text'] ?? $e, $errors);
                throw new \Exception("Namecheap API error: " . implode(', ', $errorMessages));
            }

            return $data;

        } catch (\Exception $e) {
            Log::error("Namecheap API request failed", [
                'command' => $command,
                'error' => $e->getMessage(),
            ]);

            throw $e;
        }
    }

    /**
     * Set all DNS records (replaces existing)
     *
     * @param OrganizationDomain $domain
     * @param array $records
     * @return bool
     * @throws \Exception
     */
    private function setAllDnsRecords(OrganizationDomain $domain, array $records): bool
    {
        $params = [
            'SLD' => $this->getSld($domain->domain),
            'TLD' => $this->getTld($domain->domain),
        ];

        // Add each record as indexed parameter
        foreach ($records as $index => $record) {
            $i = $index + 1;
            $params["HostName{$i}"] = $record['hostname'];
            $params["RecordType{$i}"] = $record['type'];
            $params["Address{$i}"] = $record['value'];
            $params["TTL{$i}"] = $record['ttl'] ?? 1800;

            if ($record['type'] === 'MX') {
                $params["MXPref{$i}"] = $record['priority'] ?? 10;
            }
        }

        try {
            $response = $this->makeRequest('namecheap.domains.dns.setHosts', $params);

            $result = $response['CommandResponse']['DomainDNSSetHostsResult'];

            if ($result['@attributes']['IsSuccess'] === 'true') {
                Log::info("DNS records updated via Namecheap", [
                    'domain' => $domain->domain,
                    'record_count' => count($records),
                ]);

                return true;
            }

            return false;

        } catch (\Exception $e) {
            Log::error("Failed to update DNS records via Namecheap", [
                'domain' => $domain->domain,
                'error' => $e->getMessage(),
            ]);

            throw new \Exception("Failed to update DNS records: {$e->getMessage()}");
        }
    }

    /**
     * Validate contact information
     *
     * @param array $contactInfo
     * @return void
     * @throws \Exception
     */
    private function validateContactInfo(array $contactInfo): void
    {
        $required = [
            'first_name', 'last_name', 'address1', 'city',
            'state', 'postal_code', 'country', 'phone', 'email'
        ];

        foreach ($required as $field) {
            if (empty($contactInfo[$field])) {
                throw new \Exception("Missing required contact field: {$field}");
            }
        }

        // Validate country code (2-letter ISO)
        if (strlen($contactInfo['country']) !== 2) {
            throw new \Exception("Country must be 2-letter ISO code");
        }

        // Validate email
        if (!filter_var($contactInfo['email'], FILTER_VALIDATE_EMAIL)) {
            throw new \Exception("Invalid email address");
        }

        // Validate phone (basic check)
        if (!preg_match('/^\+?[0-9\s\-().]+$/', $contactInfo['phone'])) {
            throw new \Exception("Invalid phone number format");
        }
    }

    /**
     * Format contact information for API request
     *
     * @param string $type Registrant, Tech, Admin, AuxBilling
     * @param array $contactInfo
     * @return array
     */
    private function formatContactInfo(string $type, array $contactInfo): array
    {
        return [
            "{$type}FirstName" => $contactInfo['first_name'],
            "{$type}LastName" => $contactInfo['last_name'],
            "{$type}Address1" => $contactInfo['address1'],
            "{$type}Address2" => $contactInfo['address2'] ?? '',
            "{$type}City" => $contactInfo['city'],
            "{$type}StateProvince" => $contactInfo['state'],
            "{$type}PostalCode" => $contactInfo['postal_code'],
            "{$type}Country" => strtoupper($contactInfo['country']),
            "{$type}Phone" => $contactInfo['phone'],
            "{$type}EmailAddress" => $contactInfo['email'],
            "{$type}OrganizationName" => $contactInfo['organization_name'] ?? '',
        ];
    }

    /**
     * Store contact information in database
     *
     * @param OrganizationDomain $domain
     * @param array $contactInfo
     * @return void
     */
    private function storeContactInfo(OrganizationDomain $domain, array $contactInfo): void
    {
        $contactTypes = ['registrant', 'admin', 'tech', 'billing'];

        foreach ($contactTypes as $type) {
            DomainContact::updateOrCreate([
                'organization_domain_id' => $domain->id,
                'contact_type' => $type,
            ], [
                'first_name' => $contactInfo['first_name'],
                'last_name' => $contactInfo['last_name'],
                'organization_name' => $contactInfo['organization_name'] ?? null,
                'email' => $contactInfo['email'],
                'phone' => $contactInfo['phone'],
                'address1' => $contactInfo['address1'],
                'address2' => $contactInfo['address2'] ?? null,
                'city' => $contactInfo['city'],
                'state' => $contactInfo['state'],
                'postal_code' => $contactInfo['postal_code'],
                'country' => $contactInfo['country'],
            ]);
        }
    }

    /**
     * Set up default DNS records for newly registered domain
     *
     * @param OrganizationDomain $domain
     * @return void
     */
    private function setupDefaultDns(OrganizationDomain $domain): void
    {
        // Create default A record pointing to organization's primary server IP
        // This is just an example - actual implementation depends on requirements
        $organization = $domain->organization;

        if ($primaryServer = $organization->servers()->where('is_primary', true)->first()) {
            $this->createDnsRecord(
                $domain,
                '@', // Root domain
                'A',
                $primaryServer->ip,
                1800
            );
        }
    }

    /**
     * Extract SLD (second-level domain) from full domain
     *
     * @param string $domain example.com
     * @return string example
     */
    private function getSld(string $domain): string
    {
        $parts = explode('.', $domain);
        return $parts[0];
    }

    /**
     * Extract TLD (top-level domain) from full domain
     *
     * @param string $domain example.com
     * @return string com
     */
    private function getTld(string $domain): string
    {
        $parts = explode('.', $domain);
        return implode('.', array_slice($parts, 1));
    }

    /**
     * Extract nameservers from domain info response
     *
     * @param array $dnsDetails
     * @return array
     */
    private function extractNameservers(array $dnsDetails): array
    {
        if (empty($dnsDetails['Nameserver'])) {
            return [];
        }

        $nameservers = $dnsDetails['Nameserver'];

        // Handle single nameserver vs array
        if (!isset($nameservers[0])) {
            $nameservers = [$nameservers];
        }

        return array_map(fn($ns) => $ns['#text'] ?? $ns, $nameservers);
    }
}
```

### Configuration

**File:** `config/services.php`

```php
return [
    // ... existing service configurations

    'namecheap' => [
        'api_user' => env('NAMECHEAP_API_USER'),
        'api_key' => env('NAMECHEAP_API_KEY'),
        'username' => env('NAMECHEAP_USERNAME', env('NAMECHEAP_API_USER')),
        'client_ip' => env('NAMECHEAP_CLIENT_IP'),
        'sandbox' => env('NAMECHEAP_SANDBOX', false),
    ],
];
```

**Environment Variables:**

```bash
# .env
NAMECHEAP_API_USER=your_username
NAMECHEAP_API_KEY=your_api_key
NAMECHEAP_USERNAME=your_username
NAMECHEAP_CLIENT_IP=your_server_ip
NAMECHEAP_SANDBOX=false
```

### Service Registration

**File:** `app/Providers/EnterpriseServiceProvider.php`

```php
use App\Services\Enterprise\Domain\NamecheapRegistrar;
use App\Contracts\DomainRegistrarInterface;

public function register(): void
{
    // ... existing service registrations

    // Register Namecheap as a domain registrar
    $this->app->bind('domain.registrar.namecheap', function ($app) {
        return new NamecheapRegistrar();
    });

    // Register as default registrar if configured
    if (config('services.namecheap.api_key')) {
        $this->app->bind(DomainRegistrarInterface::class, NamecheapRegistrar::class);
    }
}
```

## Implementation Approach

### Step 1: Configuration Setup
1. Add Namecheap configuration to `config/services.php`
2. Create environment variables for API credentials
3. Test API connectivity with sandbox credentials
4. Whitelist server IP in Namecheap dashboard

### Step 2: Create NamecheapRegistrar Class
1. Create class in `app/Services/Enterprise/Domain/`
2. Implement `DomainRegistrarInterface` interface
3. Add constructor with configuration loading
4. Implement `makeRequest()` helper for API communication

### Step 3: Implement Core Methods
1. Implement `checkAvailability()` - domain search
2. Implement `registerDomain()` - new registration
3. Implement `transferDomain()` - transfer from other registrar
4. Implement `renewDomain()` - domain renewal
5. Implement `getDomainInfo()` - retrieve domain details

### Step 4: Implement DNS Management
1. Implement `setNameservers()` - update nameserver configuration
2. Implement `getDnsRecords()` - retrieve current DNS records
3. Implement `createDnsRecord()` - add new DNS record
4. Implement `updateDnsRecord()` - modify existing record
5. Implement `deleteDnsRecord()` - remove DNS record
6. Implement `setAllDnsRecords()` - bulk update helper

### Step 5: Implement Contact Management
1. Add `validateContactInfo()` - validate contact fields
2. Add `formatContactInfo()` - format for API request
3. Add `storeContactInfo()` - persist to database
4. Implement contact update methods

### Step 6: Implement Privacy Protection
1. Implement `setPrivacyProtection()` - enable/disable WhoisGuard
2. Handle WhoisGuard ID storage and retrieval
3. Add privacy status to domain info retrieval

### Step 7: Error Handling and Logging
1. Add comprehensive error handling for all API calls
2. Parse Namecheap error responses
3. Add detailed logging for debugging
4. Create user-friendly error messages

### Step 8: Testing
1. Write unit tests with mocked API responses
2. Write integration tests with sandbox API
3. Test all error scenarios
4. Test rate limiting behavior

## Test Strategy

### Unit Tests

**File:** `tests/Unit/Enterprise/Domain/NamecheapRegistrarTest.php`

```php
<?php

use App\Services\Enterprise\Domain\NamecheapRegistrar;
use App\Models\Enterprise\OrganizationDomain;
use App\Models\Organization;
use Illuminate\Support\Facades\Http;

beforeEach(function () {
    $this->registrar = new NamecheapRegistrar();
});

it('checks domain availability successfully', function () {
    Http::fake([
        'api.sandbox.namecheap.com/*' => Http::response('<?xml version="1.0" encoding="utf-8"?>
            <ApiResponse Status="OK">
                <CommandResponse Type="namecheap.domains.check">
                    <DomainCheckResult Domain="example.com" Available="true" />
                </CommandResponse>
            </ApiResponse>', 200),
    ]);

    $result = $this->registrar->checkAvailability('example.com');

    expect($result)
        ->toHaveKey('available')
        ->and($result['available'])->toBeTrue()
        ->and($result['domain'])->toBe('example.com');
});

it('registers domain successfully', function () {
    Http::fake([
        'api.sandbox.namecheap.com/*' => Http::response('<?xml version="1.0" encoding="utf-8"?>
            <ApiResponse Status="OK">
                <CommandResponse Type="namecheap.domains.create">
                    <DomainCreateResult Domain="example.com" Registered="true"
                                       DomainID="12345" OrderID="67890"
                                       TransactionID="11111" ChargedAmount="10.99" />
                </CommandResponse>
            </ApiResponse>', 200),
    ]);

    $organization = Organization::factory()->create();

    $contactInfo = [
        'organization_id' => $organization->id,
        'first_name' => 'John',
        'last_name' => 'Doe',
        'email' => 'john@example.com',
        'phone' => '+1.1234567890',
        'address1' => '123 Main St',
        'city' => 'New York',
        'state' => 'NY',
        'postal_code' => '10001',
        'country' => 'US',
    ];

    $domain = $this->registrar->registerDomain('example.com', 1, $contactInfo);

    expect($domain)
        ->toBeInstanceOf(OrganizationDomain::class)
        ->and($domain->domain)->toBe('example.com')
        ->and($domain->registrar)->toBe('namecheap')
        ->and($domain->organization_id)->toBe($organization->id);
});

it('validates contact information', function () {
    $organization = Organization::factory()->create();

    $invalidContactInfo = [
        'organization_id' => $organization->id,
        'first_name' => 'John',
        // Missing required fields
    ];

    expect(fn() => $this->registrar->registerDomain('example.com', 1, $invalidContactInfo))
        ->toThrow(\Exception::class, 'Missing required contact field');
});

it('handles API errors gracefully', function () {
    Http::fake([
        'api.sandbox.namecheap.com/*' => Http::response('<?xml version="1.0" encoding="utf-8"?>
            <ApiResponse Status="ERROR">
                <Errors>
                    <Error Number="2011165">Domain is not available</Error>
                </Errors>
            </ApiResponse>', 200),
    ]);

    $organization = Organization::factory()->create();

    $contactInfo = [
        'organization_id' => $organization->id,
        'first_name' => 'John',
        'last_name' => 'Doe',
        'email' => 'john@example.com',
        'phone' => '+1.1234567890',
        'address1' => '123 Main St',
        'city' => 'New York',
        'state' => 'NY',
        'postal_code' => '10001',
        'country' => 'US',
    ];

    expect(fn() => $this->registrar->registerDomain('example.com', 1, $contactInfo))
        ->toThrow(\Exception::class, 'Domain is not available');
});

it('creates DNS records successfully', function () {
    Http::fake([
        'api.sandbox.namecheap.com/*' => Http::sequence()
            ->push('<?xml version="1.0" encoding="utf-8"?>
                <ApiResponse Status="OK">
                    <CommandResponse Type="namecheap.domains.dns.getHosts">
                        <DomainDNSGetHostsResult Domain="example.com">
                            <host HostId="1" Name="@" Type="A" Address="192.0.2.1" TTL="1800" />
                        </DomainDNSGetHostsResult>
                    </CommandResponse>
                </ApiResponse>', 200)
            ->push('<?xml version="1.0" encoding="utf-8"?>
                <ApiResponse Status="OK">
                    <CommandResponse Type="namecheap.domains.dns.setHosts">
                        <DomainDNSSetHostsResult Domain="example.com" IsSuccess="true" />
                    </CommandResponse>
                </ApiResponse>', 200),
    ]);

    $organization = Organization::factory()->create();
    $domain = OrganizationDomain::factory()->create([
        'organization_id' => $organization->id,
        'domain' => 'example.com',
    ]);

    $result = $this->registrar->createDnsRecord($domain, 'www', 'A', '192.0.2.2');

    expect($result)->toBeTrue();
});

it('extracts SLD and TLD correctly', function () {
    $sld = invade($this->registrar)->getSld('example.com');
    $tld = invade($this->registrar)->getTld('example.com');

    expect($sld)->toBe('example');
    expect($tld)->toBe('com');
});

it('extracts SLD and TLD for multi-part TLD', function () {
    $sld = invade($this->registrar)->getSld('example.co.uk');
    $tld = invade($this->registrar)->getTld('example.co.uk');

    expect($sld)->toBe('example');
    expect($tld)->toBe('co.uk');
});
```

### Integration Tests

**File:** `tests/Feature/Enterprise/Domain/NamecheapIntegrationTest.php`

```php
<?php

use App\Services\Enterprise\Domain\NamecheapRegistrar;
use App\Models\Organization;
use App\Models\User;
use Illuminate\Support\Facades\Http;

it('completes full domain registration workflow', function () {
    Http::fake([
        'api.sandbox.namecheap.com/*' => Http::sequence()
            // Check availability
            ->push('<?xml version="1.0" encoding="utf-8"?>
                <ApiResponse Status="OK">
                    <CommandResponse Type="namecheap.domains.check">
                        <DomainCheckResult Domain="test-domain-12345.com" Available="true" />
                    </CommandResponse>
                </ApiResponse>', 200)
            // Register domain
            ->push('<?xml version="1.0" encoding="utf-8"?>
                <ApiResponse Status="OK">
                    <CommandResponse Type="namecheap.domains.create">
                        <DomainCreateResult Domain="test-domain-12345.com" Registered="true"
                                           DomainID="12345" OrderID="67890" />
                    </CommandResponse>
                </ApiResponse>', 200)
            // Set DNS records
            ->push('<?xml version="1.0" encoding="utf-8"?>
                <ApiResponse Status="OK">
                    <CommandResponse Type="namecheap.domains.dns.setHosts">
                        <DomainDNSSetHostsResult Domain="test-domain-12345.com" IsSuccess="true" />
                    </CommandResponse>
                </ApiResponse>', 200),
    ]);

    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'admin']);

    $registrar = new NamecheapRegistrar();

    // 1. Check availability
    $availability = $registrar->checkAvailability('test-domain-12345.com');
    expect($availability['available'])->toBeTrue();

    // 2. Register domain
    $contactInfo = [
        'organization_id' => $organization->id,
        'first_name' => 'John',
        'last_name' => 'Doe',
        'email' => 'john@example.com',
        'phone' => '+1.1234567890',
        'address1' => '123 Main St',
        'city' => 'New York',
        'state' => 'NY',
        'postal_code' => '10001',
        'country' => 'US',
    ];

    $domain = $registrar->registerDomain('test-domain-12345.com', 1, $contactInfo);

    expect($domain)
        ->domain->toBe('test-domain-12345.com')
        ->and($domain->organization_id)->toBe($organization->id)
        ->and($domain->status)->toBe('active');

    // 3. Verify domain in database
    $this->assertDatabaseHas('organization_domains', [
        'domain' => 'test-domain-12345.com',
        'organization_id' => $organization->id,
        'registrar' => 'namecheap',
    ]);

    // 4. Verify contacts stored
    expect($domain->contacts)->toHaveCount(4); // registrant, admin, tech, billing
});

it('handles domain transfer workflow', function () {
    Http::fake([
        'api.sandbox.namecheap.com/*' => Http::response('<?xml version="1.0" encoding="utf-8"?>
            <ApiResponse Status="OK">
                <CommandResponse Type="namecheap.domains.transfer.create">
                    <DomainTransferCreateResult Transfer="12345" OrderID="67890"
                                                TransactionID="11111" StatusID="1" />
                </CommandResponse>
            </ApiResponse>', 200),
    ]);

    $organization = Organization::factory()->create();
    $registrar = new NamecheapRegistrar();

    $contactInfo = [
        'organization_id' => $organization->id,
        'first_name' => 'Jane',
        'last_name' => 'Smith',
        'email' => 'jane@example.com',
        'phone' => '+1.9876543210',
        'address1' => '456 Oak Ave',
        'city' => 'Los Angeles',
        'state' => 'CA',
        'postal_code' => '90001',
        'country' => 'US',
    ];

    $domain = $registrar->transferDomain(
        'transfer-example.com',
        'EPP-CODE-12345',
        $contactInfo
    );

    expect($domain)
        ->status->toBe('pending_transfer')
        ->and($domain->metadata)->toHaveKey('transfer_id');

    $this->assertDatabaseHas('organization_domains', [
        'domain' => 'transfer-example.com',
        'status' => 'pending_transfer',
    ]);
});
```

### Error Handling Tests

```php
it('handles insufficient funds error', function () {
    Http::fake([
        'api.sandbox.namecheap.com/*' => Http::response('<?xml version="1.0" encoding="utf-8"?>
            <ApiResponse Status="ERROR">
                <Errors>
                    <Error Number="2011280">Insufficient funds in account</Error>
                </Errors>
            </ApiResponse>', 200),
    ]);

    $organization = Organization::factory()->create();
    $registrar = new NamecheapRegistrar();

    $contactInfo = [
        'organization_id' => $organization->id,
        'first_name' => 'John',
        'last_name' => 'Doe',
        'email' => 'john@example.com',
        'phone' => '+1.1234567890',
        'address1' => '123 Main St',
        'city' => 'New York',
        'state' => 'NY',
        'postal_code' => '10001',
        'country' => 'US',
    ];

    expect(fn() => $registrar->registerDomain('example.com', 1, $contactInfo))
        ->toThrow(\Exception::class, 'Insufficient funds in account');
});

it('handles authentication errors', function () {
    Http::fake([
        'api.sandbox.namecheap.com/*' => Http::response('<?xml version="1.0" encoding="utf-8"?>
            <ApiResponse Status="ERROR">
                <Errors>
                    <Error Number="1011102">Invalid API key</Error>
                </Errors>
            </ApiResponse>', 200),
    ]);

    $registrar = new NamecheapRegistrar();

    expect(fn() => $registrar->checkAvailability('example.com'))
        ->toThrow(\Exception::class, 'Invalid API key');
});
```

## Definition of Done

- [ ] NamecheapRegistrar class created in `app/Services/Enterprise/Domain/`
- [ ] DomainRegistrarInterface fully implemented
- [ ] Configuration added to `config/services.php`
- [ ] Environment variables documented in `.env.example`
- [ ] Service registered in EnterpriseServiceProvider
- [ ] Domain availability checking implemented and tested
- [ ] Domain registration implemented with full contact handling
- [ ] Domain transfer implemented with EPP code validation
- [ ] Domain renewal implemented with expiration update
- [ ] Nameserver management implemented
- [ ] DNS record CRUD operations implemented
- [ ] WhoisGuard privacy protection implemented
- [ ] Contact information validation implemented
- [ ] Error handling covers all Namecheap error codes
- [ ] Rate limiting implemented (production: 700/min, sandbox: 50/min)
- [ ] Comprehensive logging for all operations
- [ ] Unit tests written and passing (20+ tests, >90% coverage)
- [ ] Integration tests written and passing (10+ tests)
- [ ] Error scenario tests written and passing (5+ tests)
- [ ] Sandbox API testing completed successfully
- [ ] Documentation updated with Namecheap setup instructions
- [ ] Code follows Laravel 12 and Coolify coding standards
- [ ] Laravel Pint formatting applied (`./vendor/bin/pint`)
- [ ] PHPStan level 5 analysis passing with no errors
- [ ] Manual testing completed with real Namecheap sandbox account
- [ ] Code reviewed and approved

## Related Tasks

- **Depends on:** Task 63 (DomainRegistrarInterface and factory pattern)
- **Depends on:** Task 62 (Database schema for domains)
- **Parallel with:** Task 65 (Route53 Domains integration)
- **Used by:** Task 66 (DomainRegistrarService coordination)
- **Used by:** Task 67 (DNS management service)
- **Used by:** Task 70 (Domain management Vue.js components)
- **Integrates with:** Task 68 (SSL certificate provisioning)
