---
name: Enhance DynamicAssetController with SASS compilation and CSS custom properties injection
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:38:20Z
github: https://github.com/johnproblems/topgun/issues/112
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Enhance DynamicAssetController with SASS compilation and CSS custom properties injection

## Description

This task enhances the existing `DynamicAssetController` to support **runtime SASS compilation** and **CSS custom properties injection** based on organization white-label configurations stored in the `white_label_configs` table. This is the core component of the white-label branding system that allows organizations to completely customize the visual appearance of their Coolify instance.

The controller will dynamically generate CSS files on-the-fly by:
1. Reading organization branding configurations from the database
2. Compiling SASS templates with organization-specific variables
3. Injecting CSS custom properties (CSS variables) for theme colors, fonts, and spacing
4. Serving the compiled CSS with appropriate caching headers
5. Supporting both light and dark mode variants

This functionality integrates with the existing Coolify architecture by:
- Extending the existing `WhiteLabelService` for configuration retrieval
- Using Laravel's response caching mechanisms
- Following Coolify's established controller patterns
- Supporting organization-scoped data access

**Why this task is important:** This is the foundation of the white-label system. Without dynamic CSS generation, organizations cannot customize their branding. This task enables the visual transformation that makes each organization's Coolify instance appear as their own branded platform rather than a generic Coolify installation.

## Acceptance Criteria

- [ ] DynamicAssetController generates valid CSS files based on organization configuration
- [ ] SASS compilation works correctly with organization-specific variables (colors, fonts, spacing)
- [ ] CSS custom properties are properly injected for both light and dark modes
- [ ] Generated CSS includes all necessary theme variables (primary color, secondary color, accent color, font families, spacing values)
- [ ] Controller responds with appropriate HTTP headers (Content-Type: text/css, Cache-Control)
- [ ] Controller handles missing or invalid organization configurations gracefully
- [ ] Generated CSS is valid and renders correctly in all modern browsers
- [ ] Performance meets requirements: < 100ms for cached responses, < 500ms for initial compilation
- [ ] Controller properly integrates with WhiteLabelService for configuration retrieval
- [ ] Error handling returns appropriate HTTP status codes (404 for missing org, 500 for compilation errors)
- [ ] Controller supports versioned CSS files for cache busting
- [ ] Generated CSS follows Coolify's existing CSS architecture and naming conventions

## Technical Details

### File Paths

**Controller:**
- `/home/topgun/topgun/app/Http/Controllers/Enterprise/DynamicAssetController.php`

**Service Layer:**
- `/home/topgun/topgun/app/Services/Enterprise/WhiteLabelService.php` (existing, to be enhanced)
- `/home/topgun/topgun/app/Contracts/WhiteLabelServiceInterface.php` (existing interface)

**SASS Templates:**
- `/home/topgun/topgun/resources/sass/enterprise/white-label-template.scss` (new)
- `/home/topgun/topgun/resources/sass/enterprise/dark-mode-template.scss` (new)

**Routes:**
- `/home/topgun/topgun/routes/web.php` - Add route: `GET /branding/{organization}/styles.css`

### Database Schema

The controller reads from the existing `white_label_configs` table:

```sql
-- Existing table structure (reference only)
CREATE TABLE white_label_configs (
    id BIGINT UNSIGNED PRIMARY KEY,
    organization_id BIGINT UNSIGNED NOT NULL,
    platform_name VARCHAR(255),
    primary_color VARCHAR(7),
    secondary_color VARCHAR(7),
    accent_color VARCHAR(7),
    logo_url VARCHAR(255),
    favicon_url VARCHAR(255),
    custom_css TEXT,
    font_family VARCHAR(255),
    -- ... additional columns
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

### Class Structure

```php
<?php

namespace App\Http\Controllers\Enterprise;

use App\Http\Controllers\Controller;
use App\Services\Enterprise\WhiteLabelService;
use Illuminate\Http\Response;
use Illuminate\Support\Facades\Log;
use ScssPhp\ScssPhp\Compiler;

class DynamicAssetController extends Controller
{
    public function __construct(
        private WhiteLabelService $whiteLabelService
    ) {}

    /**
     * Generate and serve organization-specific CSS
     *
     * @param string $organizationSlug
     * @return Response
     */
    public function styles(string $organizationSlug): Response
    {
        // 1. Retrieve organization by slug
        // 2. Get white-label configuration
        // 3. Compile SASS with organization variables
        // 4. Inject CSS custom properties
        // 5. Return response with caching headers
    }

    /**
     * Compile SASS template with organization variables
     *
     * @param array $config
     * @return string
     */
    private function compileSass(array $config): string
    {
        // Use scssphp/scssphp library
        // Load SASS template
        // Set variables from config
        // Compile and return CSS
    }

    /**
     * Generate CSS custom properties string
     *
     * @param array $config
     * @return string
     */
    private function generateCssVariables(array $config): string
    {
        // Generate :root { --var: value; } block
        // Include light mode variables
        // Include dark mode variables with prefers-color-scheme
    }

    /**
     * Get cache key for organization CSS
     *
     * @param string $organizationSlug
     * @return string
     */
    private function getCacheKey(string $organizationSlug): string
    {
        return "branding:{$organizationSlug}:css:v1";
    }
}
```

### Dependencies

**PHP Libraries:**
- `scssphp/scssphp` - SASS/SCSS compiler for PHP (already compatible with Laravel 12)
- Install via: `composer require scssphp/scssphp`

**Existing Coolify Components:**
- `WhiteLabelService` - Retrieve organization configurations
- `Organization` model - Organization lookup by slug
- Laravel's Response and Cache facades

### Configuration Requirements

**Environment Variables:**
```bash
# Add to .env
WHITE_LABEL_CACHE_TTL=3600  # 1 hour cache duration
WHITE_LABEL_SASS_DEBUG=false  # Enable SASS compilation debugging
```

**Config File:**
```php
// config/enterprise.php
return [
    'white_label' => [
        'cache_ttl' => env('WHITE_LABEL_CACHE_TTL', 3600),
        'sass_debug' => env('WHITE_LABEL_SASS_DEBUG', false),
        'default_theme' => [
            'primary_color' => '#3b82f6',
            'secondary_color' => '#8b5cf6',
            'accent_color' => '#10b981',
            'font_family' => 'Inter, sans-serif',
        ],
    ],
];
```

### SASS Template Example

```scss
// resources/sass/enterprise/white-label-template.scss
:root {
    // Colors - will be replaced with organization values
    --color-primary: #{$primary_color};
    --color-secondary: #{$secondary_color};
    --color-accent: #{$accent_color};

    // Typography
    --font-family-primary: #{$font_family};

    // Derived colors (lighter/darker variants)
    --color-primary-light: lighten($primary_color, 10%);
    --color-primary-dark: darken($primary_color, 10%);
}

// Component styles using variables
.btn-primary {
    background-color: var(--color-primary);
    &:hover {
        background-color: var(--color-primary-dark);
    }
}
```

## Implementation Approach

### Step 1: Install SASS Compiler
```bash
composer require scssphp/scssphp
```

### Step 2: Create SASS Templates
1. Create `resources/sass/enterprise/` directory
2. Create `white-label-template.scss` with Coolify theme variables
3. Create `dark-mode-template.scss` for dark mode overrides
4. Define SASS variables that will be replaced with organization values

### Step 3: Enhance WhiteLabelService
1. Add method `getOrganizationThemeVariables(Organization $org): array`
2. Return associative array of SASS variables from white_label_configs
3. Include fallback to default theme if config is incomplete

### Step 4: Create DynamicAssetController
1. Create controller in `app/Http/Controllers/Enterprise/`
2. Implement `styles()` method with organization slug parameter
3. Add SASS compilation using scssphp
4. Add CSS variables generation method
5. Add proper error handling (404, 500)
6. Add response headers (Content-Type, Cache-Control, ETag)

### Step 5: Register Routes
```php
// routes/web.php
Route::get('/branding/{organization:slug}/styles.css',
    [DynamicAssetController::class, 'styles']
)->name('enterprise.branding.styles');
```

### Step 6: Add Response Caching
1. Calculate ETag based on config hash
2. Support `If-None-Match` header for 304 responses
3. Add `Cache-Control: public, max-age=3600` header
4. Add `Vary: Accept-Encoding` for compression support

### Step 7: Error Handling
1. Return 404 if organization not found
2. Return 500 if SASS compilation fails (with error logging)
3. Return default theme CSS as fallback if config is empty
4. Log compilation errors to Laravel log

### Step 8: Testing
1. Unit test SASS compilation with sample variables
2. Unit test CSS variable generation
3. Integration test full controller response
4. Test caching behavior (ETag, 304 responses)

## Test Strategy

### Unit Tests

**File:** `tests/Unit/Enterprise/DynamicAssetControllerTest.php`

```php
<?php

use App\Http\Controllers\Enterprise\DynamicAssetController;
use App\Services\Enterprise\WhiteLabelService;
use Tests\TestCase;

it('compiles SASS with organization variables', function () {
    $controller = new DynamicAssetController(app(WhiteLabelService::class));

    $config = [
        'primary_color' => '#3b82f6',
        'secondary_color' => '#8b5cf6',
        'font_family' => 'Inter, sans-serif',
    ];

    $css = invade($controller)->compileSass($config);

    expect($css)
        ->toContain('--color-primary: #3b82f6')
        ->toContain('--font-family-primary: Inter');
});

it('generates CSS custom properties correctly', function () {
    $controller = new DynamicAssetController(app(WhiteLabelService::class));

    $config = [
        'primary_color' => '#ff0000',
        'secondary_color' => '#00ff00',
    ];

    $variables = invade($controller)->generateCssVariables($config);

    expect($variables)
        ->toContain(':root {')
        ->toContain('--color-primary: #ff0000')
        ->toContain('--color-secondary: #00ff00');
});

it('returns valid CSS content type', function () {
    // Test response headers
});
```

### Integration Tests

**File:** `tests/Feature/Enterprise/WhiteLabelBrandingTest.php`

```php
<?php

use App\Models\Organization;
use App\Models\WhiteLabelConfig;

it('serves custom CSS for organization', function () {
    $org = Organization::factory()->create(['slug' => 'acme-corp']);

    WhiteLabelConfig::factory()->create([
        'organization_id' => $org->id,
        'primary_color' => '#ff0000',
        'platform_name' => 'Acme Platform',
    ]);

    $response = $this->get("/branding/acme-corp/styles.css");

    $response->assertOk()
        ->assertHeader('Content-Type', 'text/css; charset=UTF-8')
        ->assertSee('--color-primary: #ff0000');
});

it('returns 404 for non-existent organization', function () {
    $response = $this->get("/branding/non-existent/styles.css");

    $response->assertNotFound();
});

it('supports ETag caching', function () {
    $org = Organization::factory()->create(['slug' => 'test-org']);
    WhiteLabelConfig::factory()->create(['organization_id' => $org->id]);

    $response = $this->get("/branding/test-org/styles.css");
    $etag = $response->headers->get('ETag');

    $cachedResponse = $this->get("/branding/test-org/styles.css", [
        'If-None-Match' => $etag
    ]);

    $cachedResponse->assertStatus(304);
});
```

### Browser Tests (if needed)

**File:** `tests/Browser/Enterprise/BrandingApplicationTest.php`

```php
use Laravel\Dusk\Browser;

it('applies custom branding to UI', function () {
    $this->browse(function (Browser $browser) {
        $browser->visit('/acme-corp')
            ->assertPresent('link[href*="branding/acme-corp/styles.css"]')
            ->waitFor('.btn-primary')
            ->assertCssPropertyValue('.btn-primary', 'background-color', 'rgb(255, 0, 0)');
    });
});
```

### Performance Benchmarks

- **Cached CSS retrieval:** < 50ms (target: < 100ms)
- **Initial SASS compilation:** < 500ms (target: < 1000ms)
- **CSS file size:** < 50KB (target: < 100KB)
- **Cache invalidation:** Immediate (on config update)

## Definition of Done

- [ ] DynamicAssetController created in `app/Http/Controllers/Enterprise/`
- [ ] SASS templates created in `resources/sass/enterprise/`
- [ ] scssphp/scssphp library installed and configured
- [ ] Route registered in `routes/web.php` for CSS generation
- [ ] SASS compilation method implemented with error handling
- [ ] CSS custom properties generation method implemented
- [ ] Controller returns valid CSS with proper Content-Type header
- [ ] Controller implements ETag caching with 304 response support
- [ ] Controller integrates with WhiteLabelService for config retrieval
- [ ] Error handling implemented (404, 500) with appropriate logging
- [ ] Default theme fallback implemented for organizations without configuration
- [ ] Unit tests written for SASS compilation (> 90% coverage)
- [ ] Integration tests written for controller endpoints (all scenarios)
- [ ] Performance benchmarks met (< 100ms cached, < 500ms compilation)
- [ ] Code follows Laravel 12 and Coolify coding standards
- [ ] Laravel Pint formatting applied (`./vendor/bin/pint`)
- [ ] PHPStan analysis passes with no errors (`./vendor/bin/phpstan`)
- [ ] Documentation added to controller methods (PHPDoc blocks)
- [ ] Manual testing completed with sample organization
- [ ] Code reviewed by team member
- [ ] All tests passing (`php artisan test --filter=DynamicAsset`)
