---
name: Build CloudProviderCredentials.vue and DeploymentMonitoring.vue components
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:38:41Z
github: https://github.com/johnproblems/topgun/issues/131
depends_on: [14]
parallel: true
conflicts_with: []
---

# Task: Build CloudProviderCredentials.vue and DeploymentMonitoring.vue components

## Description

Create two essential Vue.js 3 components for the Terraform infrastructure provisioning workflow: **CloudProviderCredentials.vue** for managing encrypted cloud provider API credentials, and **DeploymentMonitoring.vue** for real-time tracking of Terraform infrastructure provisioning status. These components work together to provide a complete infrastructure management experience within the Coolify Enterprise platform.

### CloudProviderCredentials.vue

A comprehensive CRUD interface for managing cloud provider API keys with encryption, validation, and testing capabilities. This component allows organization administrators to securely store credentials for AWS, DigitalOcean, Hetzner, GCP, and Azure, which are then used by the TerraformManager wizard for automated infrastructure provisioning.

**Key Features:**
- List all cloud provider credentials for the organization
- Add new credentials with provider-specific field validation
- Edit existing credentials (name and metadata only, not keys for security)
- Delete credentials with confirmation (prevents deletion if in use)
- Test credential validity against provider APIs
- Visual provider icons and status indicators
- Encrypted storage of sensitive data
- Last used timestamp tracking

### DeploymentMonitoring.vue

A real-time monitoring dashboard that displays live Terraform provisioning progress using WebSocket connections. When users provision infrastructure via TerraformManager, they're redirected here to watch the deployment unfold with live log streaming, progress indicators, and automatic server registration upon completion.

**Key Features:**
- Real-time Terraform execution status (pending → planning → applying → completed/failed)
- Live log streaming from Terraform subprocess via WebSockets
- Visual progress bar with percentage completion
- Step-by-step status indicators (init → plan → apply)
- Terraform output parsing and display (IP addresses, instance IDs)
- Error handling with detailed error messages
- Auto-refresh deployment status polling
- Automatic redirect to server dashboard when complete
- Cancel deployment functionality

**User Workflows:**

**Credential Management:**
1. Navigate to Organization Settings → Cloud Providers
2. Click "Add Credential" button
3. Select provider (AWS/DigitalOcean/Hetzner/GCP/Azure)
4. Enter provider-specific credentials (API key, secret, etc.)
5. Test credentials to verify they work
6. Save credential (encrypted in database)
7. Credential now available in TerraformManager wizard

**Deployment Monitoring:**
1. User completes TerraformManager wizard and clicks "Provision"
2. Backend creates TerraformDeployment record and dispatches job
3. User redirected to DeploymentMonitoring.vue with deployment ID
4. WebSocket connection established to `terraform.{deploymentId}` channel
5. Component displays "Initializing Terraform..." status
6. Live logs stream as Terraform executes (init → plan → apply)
7. Progress bar updates based on Terraform output parsing
8. Upon completion, displays "Deployment complete! Server registered."
9. Auto-redirect to server dashboard after 3 seconds

**Integration Points:**
- Backend Controllers: `CloudProviderCredentialController`, `TerraformController`
- Services: `TerraformService`, `CloudProviderValidationService`
- Models: `CloudProviderCredential`, `TerraformDeployment`
- Jobs: `TerraformDeploymentJob`, `ValidateCloudCredentialJob`
- WebSocket: Laravel Reverb channels for real-time updates
- Parent Components: TerraformManager.vue uses credentials, redirects to monitoring

## Acceptance Criteria

### CloudProviderCredentials.vue
- [ ] Component displays table of all cloud provider credentials for organization
- [ ] Provider icons displayed with credential names
- [ ] "Add Credential" button opens modal form
- [ ] Provider selection dropdown in add/edit modal
- [ ] Provider-specific form fields displayed based on selection
- [ ] Form validation for required fields per provider
- [ ] "Test Credential" button validates against provider API
- [ ] Visual feedback for test success/failure
- [ ] Edit functionality for credential name and metadata only
- [ ] Delete confirmation dialog preventing deletion if credential in use
- [ ] Last used timestamp displayed for each credential
- [ ] Status indicator showing if credential is valid/expired
- [ ] Encrypted storage using Laravel encryption
- [ ] Error handling for API validation failures
- [ ] Mobile-responsive table design

### DeploymentMonitoring.vue
- [ ] Component accepts deploymentId prop
- [ ] WebSocket connection established on mount
- [ ] Real-time status updates displayed (pending/planning/applying/completed/failed)
- [ ] Visual progress indicator (progress bar with percentage)
- [ ] Step indicators for init/plan/apply phases
- [ ] Live log streaming in scrollable terminal-style container
- [ ] Auto-scroll to latest log entry
- [ ] Terraform output parsing for key information (IP, instance ID)
- [ ] Display parsed outputs in summary panel
- [ ] Error messages displayed prominently on failure
- [ ] Retry deployment button on failure
- [ ] Cancel deployment button during execution
- [ ] Auto-refresh status polling (fallback if WebSocket disconnects)
- [ ] Auto-redirect to server dashboard on success
- [ ] Countdown timer before redirect
- [ ] Mobile-responsive design
- [ ] Accessibility compliance

## Technical Details

### Component Locations
- **CloudProviderCredentials:** `resources/js/Components/Enterprise/Infrastructure/CloudProviderCredentials.vue`
- **DeploymentMonitoring:** `resources/js/Components/Enterprise/Infrastructure/DeploymentMonitoring.vue`

### CloudProviderCredentials.vue Structure

```vue
<script setup>
import { ref, computed, onMounted } from 'vue'
import { useForm } from '@inertiajs/vue3'
import axios from 'axios'

const props = defineProps({
  organization: Object,
  credentials: Array,
})

const emit = defineEmits(['credential-added', 'credential-updated', 'credential-deleted'])

// Modal state
const showModal = ref(false)
const editingCredential = ref(null)
const isTestingCredential = ref(false)
const testResult = ref(null)

// Provider configurations
const providers = {
  aws: {
    name: 'Amazon Web Services',
    icon: '/images/providers/aws.svg',
    fields: [
      { name: 'access_key_id', label: 'Access Key ID', type: 'text', required: true },
      { name: 'secret_access_key', label: 'Secret Access Key', type: 'password', required: true },
      { name: 'region', label: 'Default Region', type: 'text', required: false },
    ],
  },
  digitalocean: {
    name: 'DigitalOcean',
    icon: '/images/providers/digitalocean.svg',
    fields: [
      { name: 'api_token', label: 'API Token', type: 'password', required: true },
    ],
  },
  hetzner: {
    name: 'Hetzner Cloud',
    icon: '/images/providers/hetzner.svg',
    fields: [
      { name: 'api_token', label: 'API Token', type: 'password', required: true },
    ],
  },
  gcp: {
    name: 'Google Cloud Platform',
    icon: '/images/providers/gcp.svg',
    fields: [
      { name: 'project_id', label: 'Project ID', type: 'text', required: true },
      { name: 'service_account_json', label: 'Service Account JSON', type: 'textarea', required: true },
    ],
  },
  azure: {
    name: 'Microsoft Azure',
    icon: '/images/providers/azure.svg',
    fields: [
      { name: 'subscription_id', label: 'Subscription ID', type: 'text', required: true },
      { name: 'client_id', label: 'Client ID', type: 'text', required: true },
      { name: 'client_secret', label: 'Client Secret', type: 'password', required: true },
      { name: 'tenant_id', label: 'Tenant ID', type: 'text', required: true },
    ],
  },
}

// Form state
const form = useForm({
  name: '',
  provider: null,
  credentials: {},
})

// Computed
const selectedProviderConfig = computed(() => {
  return form.provider ? providers[form.provider] : null
})

// Methods
const openAddModal = () => {
  form.reset()
  editingCredential.value = null
  showModal.value = true
}

const openEditModal = (credential) => {
  editingCredential.value = credential
  form.name = credential.name
  form.provider = credential.provider
  form.credentials = {} // Don't pre-fill credentials for security
  showModal.value = true
}

const closeModal = () => {
  showModal.value = false
  form.reset()
  testResult.value = null
}

const saveCredential = () => {
  if (editingCredential.value) {
    // Update existing
    form.put(route('enterprise.cloud-credentials.update', {
      organization: props.organization,
      credential: editingCredential.value
    }), {
      onSuccess: () => {
        closeModal()
        emit('credential-updated')
      },
    })
  } else {
    // Create new
    form.post(route('enterprise.cloud-credentials.store', props.organization), {
      onSuccess: () => {
        closeModal()
        emit('credential-added')
      },
    })
  }
}

const deleteCredential = async (credential) => {
  if (!confirm(`Delete credential "${credential.name}"? This cannot be undone.`)) {
    return
  }

  form.delete(route('enterprise.cloud-credentials.destroy', {
    organization: props.organization,
    credential: credential
  }), {
    onSuccess: () => {
      emit('credential-deleted')
    },
  })
}

const testCredential = async () => {
  isTestingCredential.value = true
  testResult.value = null

  try {
    const response = await axios.post(
      route('enterprise.cloud-credentials.test'),
      {
        provider: form.provider,
        credentials: form.credentials,
      }
    )

    testResult.value = {
      success: true,
      message: response.data.message,
    }
  } catch (error) {
    testResult.value = {
      success: false,
      message: error.response?.data?.message || 'Credential validation failed',
    }
  } finally {
    isTestingCredential.value = false
  }
}
</script>

<template>
  <div class="cloud-provider-credentials">
    <!-- Header -->
    <div class="header">
      <div>
        <h2 class="text-2xl font-bold">Cloud Provider Credentials</h2>
        <p class="text-gray-600 dark:text-gray-400">
          Manage API credentials for infrastructure provisioning
        </p>
      </div>

      <button type="button" class="btn btn-primary" @click="openAddModal">
        Add Credential
      </button>
    </div>

    <!-- Credentials Table -->
    <div class="credentials-table">
      <table class="table">
        <thead>
          <tr>
            <th>Provider</th>
            <th>Name</th>
            <th>Status</th>
            <th>Last Used</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="credential in credentials" :key="credential.id">
            <td>
              <div class="provider-cell">
                <img
                  :src="providers[credential.provider]?.icon"
                  :alt="credential.provider"
                  class="provider-icon-small"
                />
                <span>{{ providers[credential.provider]?.name }}</span>
              </div>
            </td>
            <td>{{ credential.name }}</td>
            <td>
              <span
                class="status-badge"
                :class="{
                  'status-badge--success': credential.is_valid,
                  'status-badge--error': !credential.is_valid,
                }"
              >
                {{ credential.is_valid ? 'Valid' : 'Invalid' }}
              </span>
            </td>
            <td>
              <span v-if="credential.last_used_at">
                {{ formatDate(credential.last_used_at) }}
              </span>
              <span v-else class="text-gray-400">Never</span>
            </td>
            <td>
              <div class="action-buttons">
                <button
                  type="button"
                  class="btn btn-sm btn-secondary"
                  @click="openEditModal(credential)"
                >
                  Edit
                </button>
                <button
                  type="button"
                  class="btn btn-sm btn-danger"
                  @click="deleteCredential(credential)"
                >
                  Delete
                </button>
              </div>
            </td>
          </tr>

          <tr v-if="credentials.length === 0">
            <td colspan="5" class="text-center text-gray-500">
              No cloud provider credentials configured.
              <button type="button" class="link" @click="openAddModal">
                Add your first credential
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Add/Edit Modal -->
    <teleport to="body">
      <div v-if="showModal" class="modal-overlay" @click.self="closeModal">
        <div class="modal">
          <div class="modal-header">
            <h3>{{ editingCredential ? 'Edit' : 'Add' }} Cloud Provider Credential</h3>
            <button type="button" class="close-button" @click="closeModal">×</button>
          </div>

          <div class="modal-body">
            <!-- Credential Name -->
            <div class="form-group">
              <label>Name</label>
              <input
                v-model="form.name"
                type="text"
                class="input"
                placeholder="My AWS Credentials"
                required
              />
              <p v-if="form.errors.name" class="error-text">{{ form.errors.name }}</p>
            </div>

            <!-- Provider Selection (only for new credentials) -->
            <div v-if="!editingCredential" class="form-group">
              <label>Provider</label>
              <select v-model="form.provider" class="select" required>
                <option value="">Select provider...</option>
                <option v-for="(config, key) in providers" :key="key" :value="key">
                  {{ config.name }}
                </option>
              </select>
              <p v-if="form.errors.provider" class="error-text">{{ form.errors.provider }}</p>
            </div>

            <!-- Provider-Specific Fields -->
            <div v-if="selectedProviderConfig">
              <h4 class="mt-4 mb-2 font-semibold">API Credentials</h4>

              <div
                v-for="field in selectedProviderConfig.fields"
                :key="field.name"
                class="form-group"
              >
                <label>{{ field.label }}</label>

                <textarea
                  v-if="field.type === 'textarea'"
                  v-model="form.credentials[field.name]"
                  class="textarea"
                  rows="4"
                  :required="field.required"
                  :placeholder="field.label"
                />

                <input
                  v-else
                  v-model="form.credentials[field.name]"
                  :type="field.type"
                  class="input"
                  :required="field.required"
                  :placeholder="field.label"
                />

                <p v-if="form.errors[`credentials.${field.name}`]" class="error-text">
                  {{ form.errors[`credentials.${field.name}`] }}
                </p>
              </div>

              <!-- Test Credential Button -->
              <button
                type="button"
                class="btn btn-secondary mt-4"
                :disabled="isTestingCredential"
                @click="testCredential"
              >
                <svg v-if="isTestingCredential" class="animate-spin" />
                {{ isTestingCredential ? 'Testing...' : 'Test Credential' }}
              </button>

              <!-- Test Result -->
              <div v-if="testResult" class="test-result mt-4" :class="{
                'test-result--success': testResult.success,
                'test-result--error': !testResult.success,
              }">
                <svg class="icon" />
                <span>{{ testResult.message }}</span>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" @click="closeModal">
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              :disabled="form.processing"
              @click="saveCredential"
            >
              {{ form.processing ? 'Saving...' : 'Save Credential' }}
            </button>
          </div>
        </div>
      </div>
    </teleport>
  </div>
</template>

<style scoped>
.cloud-provider-credentials {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
}

.credentials-table {
  background: white;
  border-radius: 0.5rem;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.provider-cell {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.provider-icon-small {
  width: 24px;
  height: 24px;
}

.status-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.875rem;
  font-weight: 500;
}

.status-badge--success {
  background: #d1fae5;
  color: #065f46;
}

.status-badge--error {
  background: #fee2e2;
  color: #991b1b;
}

.action-buttons {
  display: flex;
  gap: 0.5rem;
}

.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 50;
}

.modal {
  background: white;
  border-radius: 0.5rem;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 1px solid #e5e7eb;
}

.modal-body {
  padding: 1.5rem;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
  padding: 1.5rem;
  border-top: 1px solid #e5e7eb;
}

.test-result {
  padding: 1rem;
  border-radius: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.test-result--success {
  background: #d1fae5;
  color: #065f46;
}

.test-result--error {
  background: #fee2e2;
  color: #991b1b;
}
</style>
```

### DeploymentMonitoring.vue Structure

```vue
<script setup>
import { ref, computed, onMounted, onBeforeUnmount } from 'vue'
import { router } from '@inertiajs/vue3'
import Echo from 'laravel-echo'

const props = defineProps({
  deployment: Object,
  organization: Object,
})

// State
const status = ref(props.deployment.status)
const logs = ref([])
const outputs = ref({})
const progress = ref(0)
const currentStep = ref('init')
const error = ref(null)
const redirectCountdown = ref(5)

// WebSocket connection
let echoConnection = null
const isConnected = ref(false)

// Computed
const isComplete = computed(() => status.value === 'completed')
const isFailed = computed(() => status.value === 'failed')
const isRunning = computed(() => ['pending', 'planning', 'applying'].includes(status.value))

const statusColor = computed(() => {
  switch (status.value) {
    case 'completed': return 'green'
    case 'failed': return 'red'
    case 'applying': return 'blue'
    case 'planning': return 'yellow'
    default: return 'gray'
  }
})

const stepStatuses = computed(() => {
  const steps = {
    init: 'pending',
    plan: 'pending',
    apply: 'pending',
  }

  if (status.value === 'failed') {
    steps[currentStep.value] = 'failed'
    return steps
  }

  if (status.value === 'completed') {
    steps.init = 'completed'
    steps.plan = 'completed'
    steps.apply = 'completed'
    return steps
  }

  // Mark completed steps
  if (['planning', 'applying', 'completed'].includes(status.value)) {
    steps.init = 'completed'
  }

  if (['applying', 'completed'].includes(status.value)) {
    steps.plan = 'completed'
  }

  // Mark current step
  if (status.value === 'planning') {
    steps.plan = 'in-progress'
  } else if (status.value === 'applying') {
    steps.apply = 'in-progress'
  }

  return steps
})

// Methods
const connectWebSocket = () => {
  echoConnection = new Echo({
    broadcaster: 'reverb',
    key: import.meta.env.VITE_REVERB_APP_KEY,
    wsHost: import.meta.env.VITE_REVERB_HOST,
    wsPort: import.meta.env.VITE_REVERB_PORT,
    forceTLS: import.meta.env.VITE_REVERB_SCHEME === 'https',
  })

  echoConnection
    .channel(`terraform.${props.deployment.id}`)
    .listen('TerraformStatusUpdated', (event) => {
      status.value = event.status
      progress.value = event.progress || 0
      currentStep.value = event.step || 'init'

      if (event.error) {
        error.value = event.error
      }
    })
    .listen('TerraformLogReceived', (event) => {
      logs.value.push({
        timestamp: new Date(),
        message: event.message,
        level: event.level || 'info',
      })

      // Auto-scroll to bottom
      setTimeout(() => {
        const logContainer = document.querySelector('.log-container')
        if (logContainer) {
          logContainer.scrollTop = logContainer.scrollHeight
        }
      }, 100)
    })
    .listen('TerraformOutputReceived', (event) => {
      outputs.value = event.outputs
    })

  isConnected.value = true
}

const disconnectWebSocket = () => {
  if (echoConnection) {
    echoConnection.leave(`terraform.${props.deployment.id}`)
    isConnected.value = false
  }
}

const pollStatus = async () => {
  try {
    const response = await axios.get(
      route('enterprise.terraform.status', {
        organization: props.organization,
        deployment: props.deployment,
      })
    )

    status.value = response.data.status
    progress.value = response.data.progress || 0
    logs.value = response.data.logs || []
    outputs.value = response.data.outputs || {}
    error.value = response.data.error || null
  } catch (err) {
    console.error('Failed to poll deployment status:', err)
  }
}

const retryDeployment = () => {
  router.post(route('enterprise.terraform.retry', {
    organization: props.organization,
    deployment: props.deployment,
  }))
}

const cancelDeployment = () => {
  if (!confirm('Cancel this deployment? This cannot be undone.')) {
    return
  }

  router.post(route('enterprise.terraform.cancel', {
    organization: props.organization,
    deployment: props.deployment,
  }))
}

const startRedirectCountdown = () => {
  const interval = setInterval(() => {
    redirectCountdown.value--

    if (redirectCountdown.value <= 0) {
      clearInterval(interval)
      router.visit(route('enterprise.servers.show', {
        organization: props.organization,
        server: outputs.value.server_id,
      }))
    }
  }, 1000)
}

// Lifecycle
onMounted(() => {
  connectWebSocket()

  // Fallback polling every 5 seconds
  const pollingInterval = setInterval(pollStatus, 5000)

  // Watch for completion
  const completionWatcher = setInterval(() => {
    if (isComplete.value) {
      clearInterval(completionWatcher)
      startRedirectCountdown()
    }
  }, 1000)

  onBeforeUnmount(() => {
    disconnectWebSocket()
    clearInterval(pollingInterval)
    clearInterval(completionWatcher)
  })
})
</script>

<template>
  <div class="deployment-monitoring">
    <!-- Header -->
    <div class="header">
      <div>
        <h2 class="text-2xl font-bold">Infrastructure Deployment</h2>
        <p class="text-gray-600 dark:text-gray-400">
          {{ deployment.provider }} - {{ deployment.configuration.server_name }}
        </p>
      </div>

      <div class="status-badge" :class="`status-badge--${statusColor}`">
        {{ status }}
      </div>
    </div>

    <!-- Progress Indicator -->
    <div class="progress-section">
      <div class="progress-bar-container">
        <div class="progress-bar-fill" :style="{ width: `${progress}%` }" />
      </div>
      <span class="progress-text">{{ progress }}% complete</span>
    </div>

    <!-- Step Indicators -->
    <div class="steps">
      <div
        v-for="(step, key) in stepStatuses"
        :key="key"
        class="step"
        :class="`step--${step}`"
      >
        <div class="step-icon">
          <svg v-if="step === 'completed'" class="checkmark" />
          <svg v-else-if="step === 'failed'" class="x-mark" />
          <svg v-else-if="step === 'in-progress'" class="spinner animate-spin" />
          <span v-else class="step-number">{{ Object.keys(stepStatuses).indexOf(key) + 1 }}</span>
        </div>
        <span class="step-label">{{ key }}</span>
      </div>
    </div>

    <!-- Log Output -->
    <div class="log-section">
      <div class="log-header">
        <h3>Terraform Output</h3>
        <span v-if="isConnected" class="connection-status">
          <svg class="pulse-icon" /> Live
        </span>
      </div>

      <div class="log-container">
        <div v-for="(log, index) in logs" :key="index" class="log-entry" :class="`log-${log.level}`">
          <span class="log-timestamp">{{ formatTime(log.timestamp) }}</span>
          <span class="log-message">{{ log.message }}</span>
        </div>

        <div v-if="logs.length === 0" class="log-empty">
          Waiting for Terraform output...
        </div>
      </div>
    </div>

    <!-- Outputs -->
    <div v-if="Object.keys(outputs).length > 0" class="outputs-section">
      <h3>Deployment Outputs</h3>
      <div class="outputs-grid">
        <div v-for="(value, key) in outputs" :key="key" class="output-item">
          <span class="output-label">{{ key }}</span>
          <span class="output-value">{{ value }}</span>
        </div>
      </div>
    </div>

    <!-- Error Display -->
    <div v-if="error" class="error-section">
      <svg class="error-icon" />
      <div>
        <h4>Deployment Failed</h4>
        <p>{{ error }}</p>
      </div>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button
        v-if="isRunning"
        type="button"
        class="btn btn-danger"
        @click="cancelDeployment"
      >
        Cancel Deployment
      </button>

      <button
        v-if="isFailed"
        type="button"
        class="btn btn-primary"
        @click="retryDeployment"
      >
        Retry Deployment
      </button>

      <div v-if="isComplete" class="success-message">
        <svg class="checkmark-icon" />
        <span>Deployment complete! Redirecting in {{ redirectCountdown }}s...</span>
      </div>
    </div>
  </div>
</template>

<style scoped>
.deployment-monitoring {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
}

.status-badge {
  padding: 0.5rem 1rem;
  border-radius: 9999px;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.875rem;
}

.status-badge--green {
  background: #d1fae5;
  color: #065f46;
}

.status-badge--red {
  background: #fee2e2;
  color: #991b1b;
}

.status-badge--blue {
  background: #dbeafe;
  color: #1e40af;
}

.status-badge--yellow {
  background: #fef3c7;
  color: #92400e;
}

.progress-bar-container {
  height: 8px;
  background: #e5e7eb;
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 0.5rem;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #3b82f6, #10b981);
  transition: width 0.5s ease;
}

.steps {
  display: flex;
  justify-content: space-between;
  gap: 1rem;
  margin: 2rem 0;
}

.step {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
}

.step-icon {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #e5e7eb;
}

.step--completed .step-icon {
  background: #10b981;
  color: white;
}

.step--failed .step-icon {
  background: #ef4444;
  color: white;
}

.step--in-progress .step-icon {
  background: #3b82f6;
  color: white;
}

.log-section {
  margin: 2rem 0;
  background: #1f2937;
  border-radius: 0.5rem;
  overflow: hidden;
}

.log-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  background: #111827;
  color: white;
}

.connection-status {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: #10b981;
}

.log-container {
  height: 400px;
  overflow-y: auto;
  padding: 1rem;
  font-family: 'Courier New', monospace;
  font-size: 0.875rem;
  color: #f3f4f6;
}

.log-entry {
  margin-bottom: 0.5rem;
  display: flex;
  gap: 1rem;
}

.log-timestamp {
  color: #9ca3af;
  flex-shrink: 0;
}

.log-info {
  color: #60a5fa;
}

.log-error {
  color: #f87171;
}

.log-warning {
  color: #fbbf24;
}

.outputs-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.output-item {
  background: #f9fafb;
  padding: 1rem;
  border-radius: 0.5rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.output-label {
  font-weight: 600;
  color: #6b7280;
  font-size: 0.875rem;
}

.output-value {
  font-family: 'Courier New', monospace;
  color: #1f2937;
}

.error-section {
  background: #fee2e2;
  border: 2px solid #ef4444;
  border-radius: 0.5rem;
  padding: 1.5rem;
  margin: 2rem 0;
  display: flex;
  gap: 1rem;
  align-items: start;
}

.error-icon {
  width: 24px;
  height: 24px;
  color: #ef4444;
  flex-shrink: 0;
}

.actions {
  margin-top: 2rem;
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
}

.success-message {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 1rem 1.5rem;
  background: #d1fae5;
  border-radius: 0.5rem;
  color: #065f46;
  font-weight: 600;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.pulse-icon {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
</style>
```

### Backend Controllers

**File:** `app/Http/Controllers/Enterprise/CloudProviderCredentialController.php`

```php
public function store(Request $request, Organization $organization)
{
    $this->authorize('manageInfrastructure', $organization);

    $validated = $request->validate([
        'name' => 'required|string|max:255',
        'provider' => 'required|in:aws,digitalocean,hetzner,gcp,azure',
        'credentials' => 'required|array',
    ]);

    $credential = CloudProviderCredential::create([
        'organization_id' => $organization->id,
        'name' => $validated['name'],
        'provider' => $validated['provider'],
        'credentials' => encrypt($validated['credentials']),
    ]);

    // Validate credential in background
    ValidateCloudCredentialJob::dispatch($credential);

    return back()->with('success', 'Credential added successfully');
}

public function test(Request $request)
{
    $validated = $request->validate([
        'provider' => 'required|in:aws,digitalocean,hetzner,gcp,azure',
        'credentials' => 'required|array',
    ]);

    $validationService = app(CloudProviderValidationService::class);
    $result = $validationService->validate($validated['provider'], $validated['credentials']);

    if ($result['valid']) {
        return response()->json(['message' => 'Credentials are valid']);
    }

    return response()->json(['message' => $result['error']], 422);
}
```

**File:** `app/Http/Controllers/Enterprise/TerraformController.php`

```php
public function monitor(Organization $organization, TerraformDeployment $deployment)
{
    $this->authorize('view', $deployment);

    return Inertia::render('Enterprise/Infrastructure/Monitor', [
        'deployment' => $deployment,
        'organization' => $organization,
    ]);
}

public function status(Organization $organization, TerraformDeployment $deployment)
{
    $this->authorize('view', $deployment);

    return response()->json([
        'status' => $deployment->status,
        'progress' => $deployment->progress,
        'logs' => $deployment->logs,
        'outputs' => $deployment->outputs,
        'error' => $deployment->error_message,
    ]);
}

public function cancel(Organization $organization, TerraformDeployment $deployment)
{
    $this->authorize('update', $deployment);

    $deployment->update(['status' => 'cancelled']);

    // Kill Terraform process
    $terraformService = app(TerraformService::class);
    $terraformService->cancelDeployment($deployment);

    return back()->with('success', 'Deployment cancelled');
}

public function retry(Organization $organization, TerraformDeployment $deployment)
{
    $this->authorize('update', $deployment);

    $deployment->update(['status' => 'pending', 'error_message' => null]);

    TerraformDeploymentJob::dispatch($deployment);

    return back()->with('success', 'Deployment retrying');
}
```

## Implementation Approach

### Step 1: Create CloudProviderCredentials Component
1. Create component file structure
2. Define provider configurations with field mappings
3. Build credentials table with provider icons
4. Implement add/edit modal with dynamic forms
5. Add test credential functionality

### Step 2: Credential CRUD Operations
1. Create backend controller and routes
2. Implement encrypted storage
3. Add validation service for credential testing
4. Build delete with usage checking
5. Add last_used_at tracking

### Step 3: Create DeploymentMonitoring Component
1. Create component file structure
2. Set up WebSocket connection to Laravel Reverb
3. Build progress indicator and step display
4. Implement log streaming container
5. Add outputs display panel

### Step 4: WebSocket Integration
1. Configure Laravel Reverb channels
2. Create TerraformStatusUpdated event
3. Create TerraformLogReceived event
4. Implement broadcasting in TerraformDeploymentJob
5. Add fallback polling for reliability

### Step 5: Real-Time Status Updates
1. Parse Terraform output for progress percentage
2. Detect current step (init/plan/apply)
3. Extract outputs (IP, instance ID)
4. Handle errors and display prominently
5. Implement auto-scroll for logs

### Step 6: Deployment Actions
1. Add cancel deployment functionality
2. Implement retry on failure
3. Build success redirect with countdown
4. Add confirmation dialogs
5. Handle edge cases (disconnection, timeout)

### Step 7: Styling and Polish
1. Terminal-style log container
2. Step indicators with animations
3. Status badges with color coding
4. Mobile responsive layouts
5. Dark mode support

### Step 8: Testing and Integration
1. Unit tests for both components
2. Integration tests for CRUD operations
3. WebSocket connection tests
4. Browser tests for full workflows
5. End-to-end provisioning test

## Test Strategy

### Unit Tests (Vitest)

```javascript
describe('CloudProviderCredentials.vue', () => {
  it('displays all credentials', () => {
    const credentials = [
      { id: 1, provider: 'aws', name: 'AWS Prod', is_valid: true },
      { id: 2, provider: 'digitalocean', name: 'DO Staging', is_valid: false },
    ]

    const wrapper = mount(CloudProviderCredentials, {
      props: { organization: {}, credentials }
    })

    expect(wrapper.text()).toContain('AWS Prod')
    expect(wrapper.text()).toContain('DO Staging')
  })

  it('validates credential on test', async () => {
    const wrapper = mount(CloudProviderCredentials, {
      props: { organization: {}, credentials: [] }
    })

    wrapper.vm.form.provider = 'digitalocean'
    wrapper.vm.form.credentials = { api_token: 'test-token' }

    await wrapper.vm.testCredential()

    expect(wrapper.vm.testResult).toBeTruthy()
  })
})

describe('DeploymentMonitoring.vue', () => {
  it('connects to WebSocket on mount', async () => {
    const deployment = { id: 1, status: 'pending' }

    const wrapper = mount(DeploymentMonitoring, {
      props: { deployment, organization: {} }
    })

    await wrapper.vm.$nextTick()

    expect(wrapper.vm.isConnected).toBe(true)
  })

  it('updates status from WebSocket events', async () => {
    const wrapper = mount(DeploymentMonitoring, {
      props: { deployment: { id: 1, status: 'pending' }, organization: {} }
    })

    wrapper.vm.status = 'applying'
    wrapper.vm.progress = 50

    await wrapper.vm.$nextTick()

    expect(wrapper.vm.stepStatuses.plan).toBe('completed')
    expect(wrapper.vm.stepStatuses.apply).toBe('in-progress')
  })
})
```

### Integration Tests (Pest)

```php
it('creates cloud provider credential', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'admin']);

    Queue::fake();

    $this->actingAs($user)
        ->post(route('enterprise.cloud-credentials.store', $organization), [
            'name' => 'My AWS Credentials',
            'provider' => 'aws',
            'credentials' => [
                'access_key_id' => 'AKIAIOSFODNN7EXAMPLE',
                'secret_access_key' => 'wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY',
            ],
        ])
        ->assertRedirect();

    $this->assertDatabaseHas('cloud_provider_credentials', [
        'organization_id' => $organization->id,
        'name' => 'My AWS Credentials',
        'provider' => 'aws',
    ]);

    Queue::assertPushed(ValidateCloudCredentialJob::class);
});

it('tests credential validity', function () {
    $this->postJson(route('enterprise.cloud-credentials.test'), [
        'provider' => 'digitalocean',
        'credentials' => [
            'api_token' => 'valid-token',
        ],
    ])
        ->assertSuccessful()
        ->assertJson(['message' => 'Credentials are valid']);
});

it('prevents deleting credential in use', function () {
    $credential = CloudProviderCredential::factory()->create();
    $deployment = TerraformDeployment::factory()->create([
        'cloud_provider_credential_id' => $credential->id,
        'status' => 'applying',
    ]);

    $this->delete(route('enterprise.cloud-credentials.destroy', [
        'organization' => $credential->organization,
        'credential' => $credential
    ]))
        ->assertSessionHasErrors();
});

it('monitors deployment status', function () {
    $deployment = TerraformDeployment::factory()->create([
        'status' => 'applying',
        'progress' => 50,
    ]);

    $this->getJson(route('enterprise.terraform.status', [
        'organization' => $deployment->organization,
        'deployment' => $deployment,
    ]))
        ->assertSuccessful()
        ->assertJson([
            'status' => 'applying',
            'progress' => 50,
        ]);
});

it('cancels active deployment', function () {
    $deployment = TerraformDeployment::factory()->create(['status' => 'applying']);
    $user = User::factory()->create();
    $deployment->organization->users()->attach($user, ['role' => 'admin']);

    $this->actingAs($user)
        ->post(route('enterprise.terraform.cancel', [
            'organization' => $deployment->organization,
            'deployment' => $deployment,
        ]))
        ->assertRedirect();

    $deployment->refresh();
    expect($deployment->status)->toBe('cancelled');
});
```

### Browser Tests (Dusk)

```php
it('adds and tests cloud credential via UI', function () {
    $this->browse(function (Browser $browser) use ($user, $organization) {
        $browser->loginAs($user)
            ->visit('/enterprise/organizations/1/cloud-credentials')
            ->click('@add-credential-button')
            ->waitFor('@credential-modal')
            ->type('@credential-name', 'My DigitalOcean Token')
            ->select('@provider-select', 'digitalocean')
            ->type('@api-token', 'test-token-123')
            ->click('@test-credential-button')
            ->waitForText('Credentials are valid')
            ->click('@save-button')
            ->waitForText('Credential added successfully')
            ->assertSee('My DigitalOcean Token');
    });
});

it('monitors deployment in real-time', function () {
    $this->browse(function (Browser $browser) use ($user, $deployment) {
        $browser->loginAs($user)
            ->visit("/enterprise/organizations/1/infrastructure/monitor/{$deployment->id}")
            ->assertSee('Infrastructure Deployment')
            ->assertSee('pending')
            ->waitForText('applying', 10)
            ->assertSee('50%')
            ->waitForText('completed', 60)
            ->assertSee('Deployment complete!')
            ->waitForLocation('/enterprise/servers/1', 10);
    });
});
```

## Definition of Done

### CloudProviderCredentials.vue
- [ ] Component created with Composition API
- [ ] Credentials table displaying all organization credentials
- [ ] Provider icons and names displayed correctly
- [ ] Add credential modal with provider selection
- [ ] Provider-specific forms with dynamic fields
- [ ] Form validation for required fields
- [ ] Test credential button integrated
- [ ] API test endpoint validating credentials
- [ ] Visual feedback for test success/failure
- [ ] Edit modal for updating credential name
- [ ] Delete confirmation preventing deletion if in use
- [ ] Last used timestamp displayed
- [ ] Status indicator (valid/invalid/expired)
- [ ] Encrypted storage using Laravel encryption
- [ ] Mobile responsive design
- [ ] Unit tests written and passing (5+ tests)
- [ ] Integration tests written and passing (5+ tests)
- [ ] Browser test for full CRUD workflow

### DeploymentMonitoring.vue
- [ ] Component created with Composition API
- [ ] WebSocket connection to Laravel Reverb
- [ ] Real-time status updates working
- [ ] Progress bar with percentage display
- [ ] Step indicators (init/plan/apply) working
- [ ] Live log streaming in terminal container
- [ ] Auto-scroll to latest log entry
- [ ] Terraform output parsing implemented
- [ ] Outputs display panel showing IP, instance ID
- [ ] Error messages displayed prominently
- [ ] Retry button on failure
- [ ] Cancel button during execution
- [ ] Status polling fallback if WebSocket fails
- [ ] Auto-redirect on success with countdown
- [ ] Mobile responsive design
- [ ] Accessibility compliance
- [ ] Unit tests written and passing (6+ tests)
- [ ] Integration tests written and passing (6+ tests)
- [ ] Browser test for full monitoring workflow

### General
- [ ] Backend controllers created and tested
- [ ] Routes configured
- [ ] Events created for WebSocket broadcasting
- [ ] Jobs dispatching events correctly
- [ ] Documentation updated
- [ ] Code reviewed and approved
- [ ] PHPStan level 5 passing
- [ ] Laravel Pint formatting applied
- [ ] Dark mode support implemented

## Related Tasks

- **Depends on:** Task 14 (TerraformService implementation)
- **Integrates with:** Task 20 (TerraformManager.vue uses credentials, redirects to monitoring)
- **Integrates with:** Task 18 (TerraformDeploymentJob broadcasts events)
- **Integrates with:** Task 13 (CloudProviderCredential model)
- **Used by:** Organization administrators for infrastructure management
