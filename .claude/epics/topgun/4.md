---
name: Build LogoUploader.vue component with drag-drop, image optimization, and multi-format support
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:38:22Z
github: https://github.com/johnproblems/topgun/issues/114
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Build LogoUploader.vue component with drag-drop, image optimization, and multi-format support

## Description

Create a Vue.js 3 component for uploading organization logos as part of the white-label branding system. This component provides an intuitive drag-and-drop interface with automatic image optimization, format validation, and multi-size preview. The component integrates with Laravel's file upload system and stores logos in organization-specific directories.

**Key Features:**
- Drag-and-drop file upload with visual feedback
- Support for PNG, JPG, SVG formats
- Client-side image preview before upload
- Automatic image optimization (compression, resizing)
- Multiple logo types: primary logo, favicon, email logo
- Integration with WhiteLabelConfig model
- Real-time upload progress indicator

**Integration Points:**
- Backend: `app/Http/Controllers/Enterprise/WhiteLabelController.php`
- Storage: `storage/app/public/branding/{organization_id}/logos/`
- Model: `app/Models/Enterprise/WhiteLabelConfig.php`
- Parent Component: `BrandingManager.vue` (Task 5)

## Acceptance Criteria

- [ ] Drag-and-drop interface implemented with visual drop zone
- [ ] File type validation (PNG, JPG, JPEG, SVG only)
- [ ] File size validation (max 5MB for images, 500KB for SVG)
- [ ] Client-side image preview with dimensions displayed
- [ ] Automatic image optimization before upload (resize to max 2000x2000, compress to 80% quality)
- [ ] Upload progress indicator with percentage
- [ ] Support for multiple logo types (primary, favicon source, email header)
- [ ] Error handling for invalid files, upload failures, network errors
- [ ] Integration with Laravel Inertia.js for form submission
- [ ] Responsive design working on mobile, tablet, desktop
- [ ] Accessibility compliance (ARIA labels, keyboard navigation)
- [ ] Existing logo display with option to replace or delete

## Technical Details

### Component Location
- **File:** `resources/js/Components/Enterprise/WhiteLabel/LogoUploader.vue`

### Component Structure

```vue
<script setup>
import { ref, computed } from 'vue'
import { useForm } from '@inertiajs/vue3'

const props = defineProps({
  organizationId: Number,
  logoType: {
    type: String,
    default: 'primary', // primary, favicon, email
  },
  existingLogo: String, // URL to existing logo
  maxFileSize: {
    type: Number,
    default: 5 * 1024 * 1024, // 5MB
  },
})

const emit = defineEmits(['uploaded', 'deleted'])

const isDragging = ref(false)
const previewUrl = ref(props.existingLogo)
const selectedFile = ref(null)
const uploadProgress = ref(0)
const errorMessage = ref('')

const form = useForm({
  logo: null,
  logo_type: props.logoType,
})

// File validation
const validateFile = (file) => {
  const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml']

  if (!validTypes.includes(file.type)) {
    return 'Invalid file type. Please upload PNG, JPG, or SVG.'
  }

  if (file.size > props.maxFileSize) {
    const maxMB = props.maxFileSize / (1024 * 1024)
    return `File too large. Maximum size is ${maxMB}MB.`
  }

  return null
}

// Image optimization using canvas
const optimizeImage = async (file) => {
  if (file.type === 'image/svg+xml') {
    return file // Don't optimize SVG
  }

  return new Promise((resolve) => {
    const reader = new FileReader()

    reader.onload = (e) => {
      const img = new Image()

      img.onload = () => {
        const canvas = document.createElement('canvas')
        const ctx = canvas.getContext('2d')

        // Calculate new dimensions (max 2000x2000, maintain aspect ratio)
        let width = img.width
        let height = img.height
        const maxDimension = 2000

        if (width > maxDimension || height > maxDimension) {
          if (width > height) {
            height = (height / width) * maxDimension
            width = maxDimension
          } else {
            width = (width / height) * maxDimension
            height = maxDimension
          }
        }

        canvas.width = width
        canvas.height = height

        // Draw and compress
        ctx.drawImage(img, 0, 0, width, height)

        canvas.toBlob(
          (blob) => {
            const optimizedFile = new File([blob], file.name, {
              type: 'image/jpeg',
              lastModified: Date.now(),
            })
            resolve(optimizedFile)
          },
          'image/jpeg',
          0.8 // 80% quality
        )
      }

      img.src = e.target.result
    }

    reader.readAsDataURL(file)
  })
}

// Handle file selection
const handleFileSelect = async (event) => {
  const file = event.target.files[0]
  if (!file) return

  await processFile(file)
}

// Handle drag and drop
const handleDrop = async (event) => {
  isDragging.value = false
  const file = event.dataTransfer.files[0]
  if (!file) return

  await processFile(file)
}

const processFile = async (file) => {
  errorMessage.value = ''

  // Validate
  const error = validateFile(file)
  if (error) {
    errorMessage.value = error
    return
  }

  // Optimize
  const optimizedFile = await optimizeImage(file)
  selectedFile.value = optimizedFile

  // Create preview
  const reader = new FileReader()
  reader.onload = (e) => {
    previewUrl.value = e.target.result
  }
  reader.readAsDataURL(optimizedFile)

  // Auto-upload
  uploadLogo(optimizedFile)
}

// Upload to server
const uploadLogo = (file) => {
  form.logo = file

  form.post(route('enterprise.whitelabel.logo.upload', {
    organization: props.organizationId
  }), {
    onProgress: (progress) => {
      uploadProgress.value = Math.round(progress.percentage)
    },
    onSuccess: (response) => {
      emit('uploaded', response.logo_url)
      uploadProgress.value = 0
    },
    onError: (errors) => {
      errorMessage.value = errors.logo || 'Upload failed'
      uploadProgress.value = 0
    },
  })
}

// Delete existing logo
const deleteLogo = () => {
  form.delete(route('enterprise.whitelabel.logo.delete', {
    organization: props.organizationId,
    type: props.logoType
  }), {
    onSuccess: () => {
      previewUrl.value = null
      selectedFile.value = null
      emit('deleted')
    },
  })
}
</script>

<template>
  <div class="logo-uploader">
    <!-- Drop Zone -->
    <div
      class="drop-zone"
      :class="{
        'drop-zone--dragging': isDragging,
        'drop-zone--has-image': previewUrl
      }"
      @dragover.prevent="isDragging = true"
      @dragleave="isDragging = false"
      @drop.prevent="handleDrop"
    >
      <!-- Preview -->
      <div v-if="previewUrl" class="preview">
        <img :src="previewUrl" :alt="`${logoType} logo preview`" />

        <div class="preview-actions">
          <button
            type="button"
            class="btn btn-secondary"
            @click="$refs.fileInput.click()"
          >
            Replace
          </button>
          <button
            type="button"
            class="btn btn-danger"
            @click="deleteLogo"
          >
            Delete
          </button>
        </div>
      </div>

      <!-- Upload Prompt -->
      <div v-else class="upload-prompt">
        <svg class="upload-icon" /* ... */ />
        <p class="upload-text">
          <span class="font-semibold">Click to upload</span> or drag and drop
        </p>
        <p class="upload-hint">
          PNG, JPG or SVG (max {{ maxFileSize / (1024 * 1024) }}MB)
        </p>
      </div>

      <!-- Progress Bar -->
      <div v-if="uploadProgress > 0" class="progress-bar">
        <div
          class="progress-bar-fill"
          :style="{ width: `${uploadProgress}%` }"
        />
        <span class="progress-text">{{ uploadProgress }}%</span>
      </div>

      <!-- Hidden File Input -->
      <input
        ref="fileInput"
        type="file"
        accept="image/png,image/jpeg,image/jpg,image/svg+xml"
        class="hidden"
        @change="handleFileSelect"
      />
    </div>

    <!-- Error Message -->
    <p v-if="errorMessage" class="error-message">
      {{ errorMessage }}
    </p>
  </div>
</template>

<style scoped>
.drop-zone {
  border: 2px dashed #cbd5e0;
  border-radius: 0.5rem;
  padding: 2rem;
  text-align: center;
  transition: all 0.2s;
  cursor: pointer;
}

.drop-zone--dragging {
  border-color: #4299e1;
  background-color: #ebf8ff;
}

.preview img {
  max-width: 300px;
  max-height: 200px;
  margin: 0 auto 1rem;
}

.progress-bar {
  margin-top: 1rem;
  height: 0.5rem;
  background: #e2e8f0;
  border-radius: 0.25rem;
  overflow: hidden;
}

.progress-bar-fill {
  height: 100%;
  background: #4299e1;
  transition: width 0.3s;
}

.error-message {
  color: #e53e3e;
  margin-top: 0.5rem;
}
</style>
```

### Backend Controller

**File:** `app/Http/Controllers/Enterprise/WhiteLabelController.php`

```php
public function uploadLogo(Request $request, Organization $organization)
{
    $this->authorize('update', $organization);

    $request->validate([
        'logo' => 'required|image|mimes:png,jpg,jpeg,svg|max:5120',
        'logo_type' => 'required|in:primary,favicon,email',
    ]);

    $logoType = $request->input('logo_type');
    $file = $request->file('logo');

    // Store in organization-specific directory
    $path = $file->store("branding/{$organization->id}/logos", 'public');

    // Update WhiteLabelConfig
    $config = $organization->whiteLabelConfig()->firstOrCreate([]);

    $config->update([
        "{$logoType}_logo_path" => $path,
        "{$logoType}_logo_url" => Storage::url($path),
    ]);

    // Clear branding cache
    Cache::forget("branding:{$organization->id}:css");

    return back()->with('success', 'Logo uploaded successfully');
}

public function deleteLogo(Organization $organization, string $type)
{
    $this->authorize('update', $organization);

    $config = $organization->whiteLabelConfig;

    if ($config && $config->{"{$type}_logo_path"}) {
        Storage::disk('public')->delete($config->{"{$type}_logo_path"});

        $config->update([
            "{$type}_logo_path" => null,
            "{$type}_logo_url" => null,
        ]);

        Cache::forget("branding:{$organization->id}:css");
    }

    return back()->with('success', 'Logo deleted successfully');
}
```

### Routes

```php
// routes/web.php
Route::middleware(['auth', 'organization'])->group(function () {
    Route::post('/enterprise/organizations/{organization}/branding/logo',
        [WhiteLabelController::class, 'uploadLogo'])
        ->name('enterprise.whitelabel.logo.upload');

    Route::delete('/enterprise/organizations/{organization}/branding/logo/{type}',
        [WhiteLabelController::class, 'deleteLogo'])
        ->name('enterprise.whitelabel.logo.delete');
});
```

## Implementation Approach

### Step 1: Create Component Structure
- Create `LogoUploader.vue` in `resources/js/Components/Enterprise/WhiteLabel/`
- Set up Vue 3 Composition API with props and emits
- Define reactive refs for state management

### Step 2: Implement Drag-and-Drop
- Add drag event listeners (dragover, dragleave, drop)
- Create visual feedback for drag state
- Prevent default browser behavior

### Step 3: Add File Validation
- Validate file type (PNG, JPG, SVG)
- Validate file size (max 5MB)
- Display clear error messages

### Step 4: Implement Image Optimization
- Use HTML5 Canvas API for resizing
- Compress JPEG/PNG to 80% quality
- Maintain aspect ratio when resizing
- Skip optimization for SVG files

### Step 5: Create Preview System
- Use FileReader API for client-side preview
- Display image dimensions
- Show file size information

### Step 6: Integrate with Inertia.js
- Use `useForm()` composable for form handling
- Implement upload progress tracking
- Handle success and error callbacks

### Step 7: Add Backend Routes and Controller
- Create upload and delete endpoints
- Store files in organization-specific directories
- Update WhiteLabelConfig model
- Clear branding cache on logo changes

### Step 8: Style and Polish
- Add Tailwind CSS classes
- Implement dark mode support
- Ensure responsive design
- Add loading states and animations

## Test Strategy

### Unit Tests (Vitest/Vue Test Utils)

**File:** `resources/js/Components/Enterprise/WhiteLabel/__tests__/LogoUploader.spec.js`

```javascript
import { mount } from '@vue/test-utils'
import LogoUploader from '../LogoUploader.vue'

describe('LogoUploader.vue', () => {
  it('renders upload prompt when no logo exists', () => {
    const wrapper = mount(LogoUploader, {
      props: { organizationId: 1 }
    })

    expect(wrapper.text()).toContain('Click to upload')
  })

  it('validates file type', async () => {
    const wrapper = mount(LogoUploader)
    const invalidFile = new File([''], 'test.pdf', { type: 'application/pdf' })

    await wrapper.vm.processFile(invalidFile)

    expect(wrapper.vm.errorMessage).toContain('Invalid file type')
  })

  it('validates file size', async () => {
    const wrapper = mount(LogoUploader, {
      props: { maxFileSize: 1024 } // 1KB limit
    })

    const largeFile = new File(['x'.repeat(2000)], 'large.png', {
      type: 'image/png'
    })

    await wrapper.vm.processFile(largeFile)

    expect(wrapper.vm.errorMessage).toContain('File too large')
  })

  it('emits uploaded event on successful upload', async () => {
    const wrapper = mount(LogoUploader)
    // Mock successful upload...

    await wrapper.vm.uploadLogo(mockFile)

    expect(wrapper.emitted('uploaded')).toBeTruthy()
  })
})
```

### Integration Tests (Pest)

**File:** `tests/Feature/Enterprise/LogoUploadTest.php`

```php
it('uploads logo successfully', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'admin']);

    Storage::fake('public');

    $file = UploadedFile::fake()->image('logo.png', 800, 600)->size(1024);

    $this->actingAs($user)
        ->post(route('enterprise.whitelabel.logo.upload', $organization), [
            'logo' => $file,
            'logo_type' => 'primary',
        ])
        ->assertRedirect()
        ->assertSessionHas('success');

    $this->assertDatabaseHas('white_label_configs', [
        'organization_id' => $organization->id,
    ]);

    Storage::disk('public')->assertExists("branding/{$organization->id}/logos/logo.png");
});

it('validates file type on upload', function () {
    $organization = Organization::factory()->create();
    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'admin']);

    $file = UploadedFile::fake()->create('document.pdf', 100, 'application/pdf');

    $this->actingAs($user)
        ->post(route('enterprise.whitelabel.logo.upload', $organization), [
            'logo' => $file,
            'logo_type' => 'primary',
        ])
        ->assertSessionHasErrors('logo');
});

it('deletes logo successfully', function () {
    Storage::fake('public');

    $organization = Organization::factory()->create();
    $config = WhiteLabelConfig::factory()->create([
        'organization_id' => $organization->id,
        'primary_logo_path' => 'branding/1/logos/test.png',
    ]);

    Storage::disk('public')->put('branding/1/logos/test.png', 'content');

    $user = User::factory()->create();
    $organization->users()->attach($user, ['role' => 'admin']);

    $this->actingAs($user)
        ->delete(route('enterprise.whitelabel.logo.delete', [
            'organization' => $organization,
            'type' => 'primary'
        ]))
        ->assertRedirect();

    Storage::disk('public')->assertMissing('branding/1/logos/test.png');

    $config->refresh();
    expect($config->primary_logo_path)->toBeNull();
});
```

### Browser Tests (Dusk)

```php
it('uploads logo via drag and drop', function () {
    // Browser test for drag-drop functionality
    $this->browse(function (Browser $browser) {
        $browser->loginAs($user)
            ->visit('/enterprise/branding')
            ->attach('logo', __DIR__.'/fixtures/test-logo.png')
            ->waitForText('Logo uploaded successfully')
            ->assertSee('test-logo.png');
    });
});
```

## Definition of Done

- [ ] LogoUploader.vue component created with Composition API
- [ ] Drag-and-drop functionality implemented and working
- [ ] File validation (type and size) implemented
- [ ] Client-side image optimization implemented
- [ ] Preview system working for all image types
- [ ] Upload progress indicator displaying correctly
- [ ] Backend upload endpoint created and tested
- [ ] Backend delete endpoint created and tested
- [ ] Files stored in organization-specific directories
- [ ] WhiteLabelConfig model updated on upload/delete
- [ ] Branding cache invalidated on logo changes
- [ ] Unit tests written and passing (8+ tests)
- [ ] Integration tests written and passing (5+ tests)
- [ ] Browser test for drag-drop written and passing
- [ ] Responsive design working on all screen sizes
- [ ] Dark mode support implemented
- [ ] Accessibility compliance verified (ARIA labels, keyboard nav)
- [ ] Documentation updated (component props, events, usage)
- [ ] Code reviewed and approved
- [ ] PHPStan level 5 passing
- [ ] No console errors or warnings

## Related Tasks

- **Depends on:** None (can be built independently)
- **Integrates with:** Task 5 (BrandingManager.vue uses this component)
- **Integrates with:** Task 7 (Favicon generation uses uploaded logos)
- **Used by:** Task 8 (BrandingPreview.vue displays uploaded logos)
