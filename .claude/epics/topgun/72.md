---
name: Create OrganizationTestingTrait with hierarchy helpers
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:39:24Z
github: https://github.com/johnproblems/topgun/issues/179
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Create OrganizationTestingTrait with hierarchy helpers

## Description

Create a comprehensive testing trait that simplifies test creation for Coolify's enterprise multi-tenant organization hierarchy. This trait provides helper methods for creating complex organization structures, switching organizational contexts, asserting hierarchy relationships, and managing organization-scoped test data. It's the foundational testing utility that makes writing multi-tenant tests dramatically easier and more maintainable.

**The Multi-Tenant Testing Challenge:**

Coolify's enterprise transformation introduces hierarchical organizations (Top Branch → Master Branch → Sub-Users → End Users) with complex relationships, permissions, and data scoping. Testing this architecture without helper utilities requires verbose, repetitive setup code:

```php
// Without OrganizationTestingTrait (painful, error-prone)
it('tests organization hierarchy access', function () {
    // Create top branch
    $topBranch = Organization::factory()->create([
        'type' => 'top_branch',
        'parent_id' => null,
    ]);

    // Create master branch under top branch
    $masterBranch = Organization::factory()->create([
        'type' => 'master_branch',
        'parent_id' => $topBranch->id,
    ]);

    // Create sub-user under master branch
    $subUser = Organization::factory()->create([
        'type' => 'sub_user',
        'parent_id' => $masterBranch->id,
    ]);

    // Create users and attach with roles
    $topBranchAdmin = User::factory()->create();
    $topBranch->users()->attach($topBranchAdmin, ['role' => 'admin']);

    $masterBranchUser = User::factory()->create();
    $masterBranch->users()->attach($masterBranchUser, ['role' => 'member']);

    // Create organization-scoped resources
    $server = Server::factory()->create(['organization_id' => $masterBranch->id]);
    $application = Application::factory()->create(['organization_id' => $subUser->id]);

    // Test access control...
    // 30+ lines of setup before actual test logic!
});
```

**The Solution: OrganizationTestingTrait**

This trait provides fluent, expressive helpers that reduce setup code by 70-90%:

```php
// With OrganizationTestingTrait (clean, readable, maintainable)
use Tests\Traits\OrganizationTestingTrait;

it('tests organization hierarchy access', function () {
    $this->createOrganizationHierarchy([
        'top_branch' => [
            'users' => ['admin'],
            'master_branches' => [
                'company_a' => [
                    'users' => ['member'],
                    'resources' => ['servers' => 3],
                    'sub_users' => [
                        'team_1' => ['resources' => ['applications' => 2]],
                    ],
                ],
            ],
        ],
    ]);

    // Test with 5 lines of setup instead of 30!
    $this->actingAsOrganizationUser('company_a', 'member')
        ->get('/servers')
        ->assertSee('3 servers');
});
```

**Key Features:**

1. **Hierarchical Organization Creation** - Nested array syntax creates complex hierarchies
2. **User Management** - Automatic user creation and role assignment
3. **Resource Creation** - Servers, applications, databases scoped to organizations
4. **Context Switching** - Fluent methods to switch acting user and organization context
5. **Assertion Helpers** - Verify hierarchy relationships and access control
6. **License Integration** - Automatic license assignment with feature flags
7. **Cleanup Management** - Automatic teardown of test organizations

**Use Cases:**

- **Access Control Testing**: Verify users can only access their organization's resources
- **Hierarchy Navigation**: Test parent/child relationship queries
- **License Feature Testing**: Verify feature flags work across organization types
- **Resource Isolation**: Ensure data leakage between organizations is impossible
- **Multi-Tenant Workflows**: Test complete workflows across organization boundaries
- **API Testing**: Verify organization-scoped API endpoints and token authentication

This trait is used by **every enterprise feature test** in the codebase, making it critical infrastructure for maintaining test quality and velocity as the platform grows.

## Acceptance Criteria

- [ ] OrganizationTestingTrait created in tests/Traits/ directory
- [ ] Trait provides createOrganizationHierarchy() method with nested array support
- [ ] Trait provides createOrganization() method with role and resource options
- [ ] Trait provides actingAsOrganizationUser() for context switching
- [ ] Trait provides switchOrganizationContext() for switching current organization
- [ ] Trait provides assertOrganizationHierarchy() for relationship assertions
- [ ] Trait provides assertOrganizationAccess() for permission testing
- [ ] Trait provides createOrganizationResources() for scoped resource creation
- [ ] Trait provides cleanupOrganizations() for automatic teardown
- [ ] Trait integrates with existing User and Organization factories
- [ ] Trait supports all organization types (top_branch, master_branch, sub_user, end_user)
- [ ] Trait creates organization users with configurable roles (owner, admin, member, viewer)
- [ ] Trait automatically creates enterprise licenses when creating organizations
- [ ] Trait provides fluent API for chaining operations
- [ ] Documentation includes comprehensive usage examples
- [ ] All helper methods have PHPDoc blocks with parameter descriptions
- [ ] Unit tests validate all trait methods work correctly
- [ ] Integration tests demonstrate real-world usage patterns

## Technical Details

### File Paths

**Trait:**
- `/home/topgun/topgun/tests/Traits/OrganizationTestingTrait.php` (new)

**Usage Examples:**
- `/home/topgun/topgun/tests/Feature/Enterprise/ExampleOrganizationTest.php` (example test)

**Documentation:**
- `/home/topgun/topgun/tests/Traits/README.md` (trait documentation)

### OrganizationTestingTrait Implementation

**File:** `tests/Traits/OrganizationTestingTrait.php`

```php
<?php

namespace Tests\Traits;

use App\Models\Application;
use App\Models\Database;
use App\Models\EnterpriseLicense;
use App\Models\Organization;
use App\Models\Server;
use App\Models\User;
use App\Models\WhiteLabelConfig;
use Illuminate\Support\Collection;

trait OrganizationTestingTrait
{
    /**
     * Current organization context for tests
     *
     * @var Organization|null
     */
    protected ?Organization $currentOrganization = null;

    /**
     * Cache of created organizations for easy reference
     *
     * @var Collection
     */
    protected Collection $organizations;

    /**
     * Cache of created users for easy reference
     *
     * @var Collection
     */
    protected Collection $organizationUsers;

    /**
     * Initialize trait state
     *
     * @return void
     */
    protected function setUpOrganizationTesting(): void
    {
        $this->organizations = collect();
        $this->organizationUsers = collect();
    }

    /**
     * Create a complete organization hierarchy from nested array structure
     *
     * Example:
     * ```php
     * $this->createOrganizationHierarchy([
     *     'acme_corp' => [
     *         'type' => 'top_branch',
     *         'users' => ['admin', 'member'],
     *         'resources' => ['servers' => 2, 'applications' => 3],
     *         'license' => ['tier' => 'enterprise', 'features' => ['white_label', 'terraform']],
     *         'master_branches' => [
     *             'acme_europe' => [
     *                 'users' => ['admin'],
     *                 'resources' => ['servers' => 1],
     *                 'sub_users' => [
     *                     'team_frontend' => ['resources' => ['applications' => 2]],
     *                     'team_backend' => ['resources' => ['applications' => 3]],
     *                 ],
     *             ],
     *         ],
     *     ],
     * ]);
     * ```
     *
     * @param array $structure Nested array defining hierarchy
     * @return Collection Created organizations keyed by name
     */
    public function createOrganizationHierarchy(array $structure): Collection
    {
        foreach ($structure as $name => $config) {
            $this->createOrganizationRecursive($name, $config, null);
        }

        return $this->organizations;
    }

    /**
     * Recursively create organizations with children
     *
     * @param string $name Organization name/key
     * @param array $config Organization configuration
     * @param Organization|null $parent Parent organization
     * @return Organization
     */
    protected function createOrganizationRecursive(string $name, array $config, ?Organization $parent): Organization
    {
        // Create organization
        $organization = $this->createOrganization($name, array_merge($config, [
            'parent_id' => $parent?->id,
        ]));

        // Create users if specified
        if (isset($config['users'])) {
            foreach ($config['users'] as $roleOrConfig) {
                if (is_string($roleOrConfig)) {
                    // Simple role string: 'admin'
                    $this->createOrganizationUser($organization, ['role' => $roleOrConfig]);
                } elseif (is_array($roleOrConfig)) {
                    // Full config: ['role' => 'admin', 'email' => 'admin@example.com']
                    $this->createOrganizationUser($organization, $roleOrConfig);
                }
            }
        }

        // Create resources if specified
        if (isset($config['resources'])) {
            $this->createOrganizationResources($organization, $config['resources']);
        }

        // Create license if specified
        if (isset($config['license'])) {
            $this->createOrganizationLicense($organization, $config['license']);
        }

        // Create white-label config if specified
        if (isset($config['branding'])) {
            $this->createOrganizationBranding($organization, $config['branding']);
        }

        // Recursively create master branches
        if (isset($config['master_branches'])) {
            foreach ($config['master_branches'] as $childName => $childConfig) {
                $childConfig['type'] = 'master_branch';
                $this->createOrganizationRecursive($childName, $childConfig, $organization);
            }
        }

        // Recursively create sub-users
        if (isset($config['sub_users'])) {
            foreach ($config['sub_users'] as $childName => $childConfig) {
                $childConfig['type'] = 'sub_user';
                $this->createOrganizationRecursive($childName, $childConfig, $organization);
            }
        }

        // Recursively create end-users
        if (isset($config['end_users'])) {
            foreach ($config['end_users'] as $childName => $childConfig) {
                $childConfig['type'] = 'end_user';
                $this->createOrganizationRecursive($childName, $childConfig, $organization);
            }
        }

        return $organization;
    }

    /**
     * Create a single organization with specified configuration
     *
     * @param string $name Organization name
     * @param array $config Configuration options
     * @return Organization
     */
    public function createOrganization(string $name, array $config = []): Organization
    {
        $type = $config['type'] ?? 'master_branch';
        $parentId = $config['parent_id'] ?? null;

        $organization = Organization::factory()->create([
            'name' => $name,
            'slug' => \Str::slug($name),
            'type' => $type,
            'parent_id' => $parentId,
            'description' => $config['description'] ?? "Test organization: {$name}",
        ]);

        // Cache for easy retrieval
        $this->organizations->put($name, $organization);

        // Set as current context if first organization or explicitly requested
        if ($this->currentOrganization === null || ($config['set_current'] ?? false)) {
            $this->currentOrganization = $organization;
        }

        return $organization;
    }

    /**
     * Create a user and attach to organization with role
     *
     * @param Organization $organization
     * @param array $config User configuration
     * @return User
     */
    public function createOrganizationUser(Organization $organization, array $config = []): User
    {
        $role = $config['role'] ?? 'member';
        $email = $config['email'] ?? null;

        $user = User::factory()->create([
            'name' => $config['name'] ?? "Test {$role}",
            'email' => $email ?? "{$role}.{$organization->slug}@test.com",
        ]);

        $organization->users()->attach($user, [
            'role' => $role,
            'is_owner' => $role === 'owner',
        ]);

        // Cache user with organization-specific key
        $this->organizationUsers->put("{$organization->slug}.{$role}", $user);

        return $user;
    }

    /**
     * Create organization-scoped resources (servers, applications, databases)
     *
     * @param Organization $organization
     * @param array $resources Resource counts by type
     * @return array Created resources
     */
    public function createOrganizationResources(Organization $organization, array $resources): array
    {
        $created = [];

        // Create servers
        if (isset($resources['servers'])) {
            $count = is_int($resources['servers']) ? $resources['servers'] : 1;
            $created['servers'] = Server::factory($count)->create([
                'organization_id' => $organization->id,
            ]);
        }

        // Create applications
        if (isset($resources['applications'])) {
            $count = is_int($resources['applications']) ? $resources['applications'] : 1;
            $created['applications'] = Application::factory($count)->create([
                'organization_id' => $organization->id,
            ]);
        }

        // Create databases
        if (isset($resources['databases'])) {
            $count = is_int($resources['databases']) ? $resources['databases'] : 1;
            $created['databases'] = Database::factory($count)->create([
                'organization_id' => $organization->id,
            ]);
        }

        return $created;
    }

    /**
     * Create enterprise license for organization
     *
     * @param Organization $organization
     * @param array $config License configuration
     * @return EnterpriseLicense
     */
    public function createOrganizationLicense(Organization $organization, array $config = []): EnterpriseLicense
    {
        $tier = $config['tier'] ?? 'pro';
        $features = $config['features'] ?? [];

        return EnterpriseLicense::factory()->create([
            'organization_id' => $organization->id,
            'license_key' => $config['license_key'] ?? 'TEST-' . strtoupper(\Str::random(16)),
            'tier' => $tier,
            'features' => $features,
            'limits' => $config['limits'] ?? $this->getDefaultLimitsForTier($tier),
            'expires_at' => $config['expires_at'] ?? now()->addYear(),
            'is_active' => $config['is_active'] ?? true,
        ]);
    }

    /**
     * Create white-label branding configuration
     *
     * @param Organization $organization
     * @param array $config Branding configuration
     * @return WhiteLabelConfig
     */
    public function createOrganizationBranding(Organization $organization, array $config = []): WhiteLabelConfig
    {
        return WhiteLabelConfig::factory()->create(array_merge([
            'organization_id' => $organization->id,
        ], $config));
    }

    /**
     * Get default resource limits for license tier
     *
     * @param string $tier
     * @return array
     */
    protected function getDefaultLimitsForTier(string $tier): array
    {
        return match ($tier) {
            'starter' => [
                'max_servers' => 3,
                'max_applications' => 10,
                'max_databases' => 5,
                'max_users' => 5,
            ],
            'pro' => [
                'max_servers' => 10,
                'max_applications' => 50,
                'max_databases' => 25,
                'max_users' => 20,
            ],
            'enterprise' => [
                'max_servers' => 100,
                'max_applications' => 500,
                'max_databases' => 250,
                'max_users' => 100,
            ],
            default => [],
        };
    }

    /**
     * Act as a user from a specific organization
     *
     * @param string $organizationName Organization name or slug
     * @param string $role User role
     * @return $this
     */
    public function actingAsOrganizationUser(string $organizationName, string $role = 'admin'): static
    {
        $organization = $this->organizations->get($organizationName);

        if (!$organization) {
            throw new \RuntimeException("Organization '{$organizationName}' not found in test context");
        }

        $userKey = "{$organization->slug}.{$role}";
        $user = $this->organizationUsers->get($userKey);

        if (!$user) {
            // Create user if not exists
            $user = $this->createOrganizationUser($organization, ['role' => $role]);
        }

        $this->actingAs($user);
        $this->currentOrganization = $organization;

        return $this;
    }

    /**
     * Switch current organization context
     *
     * @param string $organizationName
     * @return $this
     */
    public function switchOrganizationContext(string $organizationName): static
    {
        $organization = $this->organizations->get($organizationName);

        if (!$organization) {
            throw new \RuntimeException("Organization '{$organizationName}' not found");
        }

        $this->currentOrganization = $organization;

        return $this;
    }

    /**
     * Get organization by name from test cache
     *
     * @param string $name
     * @return Organization|null
     */
    public function getOrganization(string $name): ?Organization
    {
        return $this->organizations->get($name);
    }

    /**
     * Get user by organization and role
     *
     * @param string $organizationName
     * @param string $role
     * @return User|null
     */
    public function getOrganizationUser(string $organizationName, string $role): ?User
    {
        $organization = $this->getOrganization($organizationName);

        if (!$organization) {
            return null;
        }

        return $this->organizationUsers->get("{$organization->slug}.{$role}");
    }

    /**
     * Assert organization hierarchy relationships
     *
     * @param string $childName Child organization name
     * @param string $parentName Parent organization name
     * @return void
     */
    public function assertOrganizationHierarchy(string $childName, string $parentName): void
    {
        $child = $this->getOrganization($childName);
        $parent = $this->getOrganization($parentName);

        $this->assertNotNull($child, "Child organization '{$childName}' not found");
        $this->assertNotNull($parent, "Parent organization '{$parentName}' not found");

        $this->assertEquals(
            $parent->id,
            $child->parent_id,
            "Organization '{$childName}' is not a child of '{$parentName}'"
        );
    }

    /**
     * Assert user has access to organization resource
     *
     * @param User $user
     * @param mixed $resource Model with organization_id
     * @return void
     */
    public function assertOrganizationAccess(User $user, $resource): void
    {
        $userOrganizationIds = $user->organizations->pluck('id')->toArray();

        $this->assertContains(
            $resource->organization_id,
            $userOrganizationIds,
            "User does not have access to resource's organization"
        );
    }

    /**
     * Assert user does NOT have access to organization resource
     *
     * @param User $user
     * @param mixed $resource
     * @return void
     */
    public function assertNoOrganizationAccess(User $user, $resource): void
    {
        $userOrganizationIds = $user->organizations->pluck('id')->toArray();

        $this->assertNotContains(
            $resource->organization_id,
            $userOrganizationIds,
            "User should not have access to resource's organization"
        );
    }

    /**
     * Assert organization has specific feature enabled in license
     *
     * @param string $organizationName
     * @param string $feature
     * @return void
     */
    public function assertOrganizationHasFeature(string $organizationName, string $feature): void
    {
        $organization = $this->getOrganization($organizationName);

        $this->assertNotNull($organization, "Organization '{$organizationName}' not found");

        $license = $organization->license;

        $this->assertNotNull($license, "Organization '{$organizationName}' has no license");

        $this->assertTrue(
            in_array($feature, $license->features ?? []),
            "Organization '{$organizationName}' does not have feature '{$feature}'"
        );
    }

    /**
     * Clean up all created organizations and users
     *
     * @return void
     */
    public function cleanupOrganizations(): void
    {
        // Delete in reverse order to respect foreign key constraints
        foreach ($this->organizations->reverse() as $organization) {
            $organization->delete();
        }

        foreach ($this->organizationUsers as $user) {
            $user->delete();
        }

        $this->organizations = collect();
        $this->organizationUsers = collect();
        $this->currentOrganization = null;
    }

    /**
     * Get all organizations created in test
     *
     * @return Collection
     */
    public function getAllOrganizations(): Collection
    {
        return $this->organizations;
    }

    /**
     * Get all users created in test
     *
     * @return Collection
     */
    public function getAllOrganizationUsers(): Collection
    {
        return $this->organizationUsers;
    }
}
```

### Example Test Usage

**File:** `tests/Feature/Enterprise/ExampleOrganizationTest.php`

```php
<?php

use Tests\Traits\OrganizationTestingTrait;

uses(OrganizationTestingTrait::class);

beforeEach(function () {
    $this->setUpOrganizationTesting();
});

afterEach(function () {
    $this->cleanupOrganizations();
});

it('creates simple organization hierarchy', function () {
    $this->createOrganizationHierarchy([
        'acme_corp' => [
            'type' => 'top_branch',
            'users' => ['admin', 'member'],
            'resources' => ['servers' => 2],
        ],
    ]);

    $organization = $this->getOrganization('acme_corp');

    expect($organization)->not->toBeNull()
        ->and($organization->type)->toBe('top_branch')
        ->and($organization->users)->toHaveCount(2)
        ->and($organization->servers)->toHaveCount(2);
});

it('creates nested organization hierarchy', function () {
    $this->createOrganizationHierarchy([
        'parent_org' => [
            'type' => 'top_branch',
            'master_branches' => [
                'child_org' => [
                    'users' => ['admin'],
                    'sub_users' => [
                        'team_a' => ['resources' => ['applications' => 3]],
                    ],
                ],
            ],
        ],
    ]);

    $this->assertOrganizationHierarchy('child_org', 'parent_org');
    $this->assertOrganizationHierarchy('team_a', 'child_org');

    $teamA = $this->getOrganization('team_a');
    expect($teamA->applications)->toHaveCount(3);
});

it('switches organization context for testing', function () {
    $this->createOrganizationHierarchy([
        'org_a' => ['resources' => ['servers' => 1]],
        'org_b' => ['resources' => ['servers' => 2]],
    ]);

    $this->switchOrganizationContext('org_a')
        ->actingAsOrganizationUser('org_a', 'admin');

    $response = $this->get('/servers');
    $response->assertOk();
    // Should only see org_a's 1 server

    $this->switchOrganizationContext('org_b')
        ->actingAsOrganizationUser('org_b', 'admin');

    $response = $this->get('/servers');
    $response->assertOk();
    // Should see org_b's 2 servers
});

it('verifies access control between organizations', function () {
    $this->createOrganizationHierarchy([
        'org_a' => [
            'users' => ['admin'],
            'resources' => ['servers' => 1],
        ],
        'org_b' => [
            'users' => ['member'],
            'resources' => ['servers' => 1],
        ],
    ]);

    $userA = $this->getOrganizationUser('org_a', 'admin');
    $userB = $this->getOrganizationUser('org_b', 'member');

    $serverA = $this->getOrganization('org_a')->servers->first();
    $serverB = $this->getOrganization('org_b')->servers->first();

    // User A can access Server A
    $this->assertOrganizationAccess($userA, $serverA);

    // User A cannot access Server B
    $this->assertNoOrganizationAccess($userA, $serverB);

    // User B can access Server B
    $this->assertOrganizationAccess($userB, $serverB);

    // User B cannot access Server A
    $this->assertNoOrganizationAccess($userB, $serverA);
});

it('creates organizations with licenses and features', function () {
    $this->createOrganizationHierarchy([
        'enterprise_org' => [
            'license' => [
                'tier' => 'enterprise',
                'features' => ['white_label', 'terraform', 'advanced_deployment'],
            ],
        ],
    ]);

    $this->assertOrganizationHasFeature('enterprise_org', 'white_label');
    $this->assertOrganizationHasFeature('enterprise_org', 'terraform');

    $organization = $this->getOrganization('enterprise_org');
    expect($organization->license->tier)->toBe('enterprise');
});

it('creates organizations with branding configuration', function () {
    $this->createOrganizationHierarchy([
        'branded_org' => [
            'branding' => [
                'platform_name' => 'Acme Cloud',
                'primary_color' => '#ff0000',
                'logo_url' => 'https://example.com/logo.png',
            ],
        ],
    ]);

    $organization = $this->getOrganization('branded_org');
    expect($organization->whiteLabelConfig)->not->toBeNull()
        ->and($organization->whiteLabelConfig->platform_name)->toBe('Acme Cloud')
        ->and($organization->whiteLabelConfig->primary_color)->toBe('#ff0000');
});
```

### Trait Documentation

**File:** `tests/Traits/README.md`

```markdown
# Testing Traits

## OrganizationTestingTrait

Helper trait for creating and managing organization hierarchies in tests.

### Setup

```php
use Tests\Traits\OrganizationTestingTrait;

uses(OrganizationTestingTrait::class);

beforeEach(function () {
    $this->setUpOrganizationTesting();
});

afterEach(function () {
    $this->cleanupOrganizations();
});
```

### Creating Organizations

#### Simple Organization

```php
$this->createOrganization('acme_corp', [
    'type' => 'top_branch',
]);
```

#### Organization with Users

```php
$this->createOrganization('acme_corp', [
    'users' => ['admin', 'member', 'viewer'],
]);
```

#### Organization with Resources

```php
$this->createOrganization('acme_corp', [
    'resources' => [
        'servers' => 5,
        'applications' => 10,
        'databases' => 3,
    ],
]);
```

#### Organization Hierarchy

```php
$this->createOrganizationHierarchy([
    'top_branch' => [
        'master_branches' => [
            'company_a' => [
                'sub_users' => [
                    'team_1' => [],
                    'team_2' => [],
                ],
            ],
        ],
    ],
]);
```

### Context Switching

```php
// Act as specific user
$this->actingAsOrganizationUser('acme_corp', 'admin');

// Switch organization context
$this->switchOrganizationContext('another_org');
```

### Assertions

```php
// Assert hierarchy
$this->assertOrganizationHierarchy('child_org', 'parent_org');

// Assert access control
$this->assertOrganizationAccess($user, $resource);
$this->assertNoOrganizationAccess($user, $resource);

// Assert license features
$this->assertOrganizationHasFeature('org_name', 'white_label');
```

### Retrieval

```php
// Get organization
$organization = $this->getOrganization('acme_corp');

// Get user
$user = $this->getOrganizationUser('acme_corp', 'admin');

// Get all organizations
$organizations = $this->getAllOrganizations();
```
```

## Implementation Approach

### Step 1: Create Trait File
1. Create `tests/Traits/OrganizationTestingTrait.php`
2. Add namespace and basic trait structure
3. Define protected properties for caching

### Step 2: Implement Core Methods
1. `setUpOrganizationTesting()` - Initialize trait state
2. `createOrganization()` - Create single organization
3. `createOrganizationUser()` - Create and attach user
4. `createOrganizationResources()` - Create scoped resources

### Step 3: Implement Hierarchy Creation
1. `createOrganizationHierarchy()` - Entry point for nested structure
2. `createOrganizationRecursive()` - Recursive tree builder
3. Support for master_branches, sub_users, end_users

### Step 4: Implement Context Switching
1. `actingAsOrganizationUser()` - Switch user context
2. `switchOrganizationContext()` - Switch organization context
3. Integrate with Laravel's `actingAs()` method

### Step 5: Implement Retrieval Methods
1. `getOrganization()` - Retrieve by name
2. `getOrganizationUser()` - Retrieve user by org and role
3. `getAllOrganizations()` - Get all test organizations

### Step 6: Implement Assertion Helpers
1. `assertOrganizationHierarchy()` - Verify parent-child relationship
2. `assertOrganizationAccess()` - Verify user can access resource
3. `assertNoOrganizationAccess()` - Verify user cannot access resource
4. `assertOrganizationHasFeature()` - Verify license features

### Step 7: Implement License Integration
1. `createOrganizationLicense()` - Create license for organization
2. `getDefaultLimitsForTier()` - Tier-specific resource limits
3. Integration with EnterpriseLicense factory

### Step 8: Implement Branding Integration
1. `createOrganizationBranding()` - Create white-label config
2. Integration with WhiteLabelConfig factory

### Step 9: Implement Cleanup
1. `cleanupOrganizations()` - Delete all test data
2. Handle foreign key constraints with proper deletion order
3. Reset trait state

### Step 10: Documentation and Examples
1. Create comprehensive README.md
2. Write example test demonstrating all features
3. Add PHPDoc blocks to all public methods

## Test Strategy

### Unit Tests

**File:** `tests/Unit/Traits/OrganizationTestingTraitTest.php`

```php
<?php

use Tests\Traits\OrganizationTestingTrait;
use Tests\TestCase;

class OrganizationTestingTraitTest extends TestCase
{
    use OrganizationTestingTrait;

    protected function setUp(): void
    {
        parent::setUp();
        $this->setUpOrganizationTesting();
    }

    protected function tearDown(): void
    {
        $this->cleanupOrganizations();
        parent::tearDown();
    }

    public function test_creates_single_organization()
    {
        $organization = $this->createOrganization('test_org');

        $this->assertNotNull($organization);
        $this->assertEquals('test_org', $organization->name);
        $this->assertEquals('test-org', $organization->slug);
    }

    public function test_creates_organization_with_users()
    {
        $organization = $this->createOrganization('test_org');
        $user = $this->createOrganizationUser($organization, ['role' => 'admin']);

        $this->assertNotNull($user);
        $this->assertTrue($organization->users->contains($user));
    }

    public function test_creates_organization_hierarchy()
    {
        $this->createOrganizationHierarchy([
            'parent' => [
                'master_branches' => [
                    'child' => [],
                ],
            ],
        ]);

        $parent = $this->getOrganization('parent');
        $child = $this->getOrganization('child');

        $this->assertNotNull($parent);
        $this->assertNotNull($child);
        $this->assertEquals($parent->id, $child->parent_id);
    }

    public function test_creates_organization_resources()
    {
        $organization = $this->createOrganization('test_org');
        $this->createOrganizationResources($organization, [
            'servers' => 2,
            'applications' => 3,
        ]);

        $organization->refresh();

        $this->assertCount(2, $organization->servers);
        $this->assertCount(3, $organization->applications);
    }

    public function test_switches_organization_context()
    {
        $this->createOrganizationHierarchy([
            'org_a' => [],
            'org_b' => [],
        ]);

        $this->switchOrganizationContext('org_a');
        $this->assertEquals('org_a', $this->currentOrganization->name);

        $this->switchOrganizationContext('org_b');
        $this->assertEquals('org_b', $this->currentOrganization->name);
    }

    public function test_acts_as_organization_user()
    {
        $this->createOrganizationHierarchy([
            'test_org' => [
                'users' => ['admin'],
            ],
        ]);

        $this->actingAsOrganizationUser('test_org', 'admin');

        $this->assertAuthenticated();
        $this->assertEquals('test_org', $this->currentOrganization->name);
    }

    public function test_asserts_organization_hierarchy()
    {
        $this->createOrganizationHierarchy([
            'parent' => [
                'master_branches' => [
                    'child' => [],
                ],
            ],
        ]);

        $this->assertOrganizationHierarchy('child', 'parent');
    }

    public function test_asserts_organization_access()
    {
        $organization = $this->createOrganization('test_org');
        $user = $this->createOrganizationUser($organization, ['role' => 'admin']);
        $server = Server::factory()->create(['organization_id' => $organization->id]);

        $this->assertOrganizationAccess($user, $server);
    }

    public function test_creates_organization_license()
    {
        $organization = $this->createOrganization('test_org');
        $license = $this->createOrganizationLicense($organization, [
            'tier' => 'enterprise',
            'features' => ['white_label'],
        ]);

        $this->assertNotNull($license);
        $this->assertEquals('enterprise', $license->tier);
        $this->assertContains('white_label', $license->features);
    }

    public function test_cleanup_removes_all_organizations()
    {
        $this->createOrganizationHierarchy([
            'org_a' => [],
            'org_b' => [],
        ]);

        $initialCount = Organization::count();

        $this->cleanupOrganizations();

        $finalCount = Organization::count();

        $this->assertEquals($initialCount - 2, $finalCount);
    }
}
```

### Integration Tests

**File:** `tests/Feature/Traits/OrganizationTestingTraitIntegrationTest.php`

```php
<?php

use Tests\Traits\OrganizationTestingTrait;

uses(OrganizationTestingTrait::class);

beforeEach(function () {
    $this->setUpOrganizationTesting();
});

afterEach(function () {
    $this->cleanupOrganizations();
});

it('creates complex hierarchy with all features', function () {
    $this->createOrganizationHierarchy([
        'acme_corp' => [
            'type' => 'top_branch',
            'users' => ['owner', 'admin'],
            'resources' => ['servers' => 3, 'applications' => 5],
            'license' => [
                'tier' => 'enterprise',
                'features' => ['white_label', 'terraform', 'advanced_deployment'],
            ],
            'branding' => [
                'platform_name' => 'Acme Cloud Platform',
                'primary_color' => '#ff6600',
            ],
            'master_branches' => [
                'acme_europe' => [
                    'users' => ['admin', 'member'],
                    'resources' => ['servers' => 2],
                    'sub_users' => [
                        'team_frontend' => [
                            'users' => ['member'],
                            'resources' => ['applications' => 3],
                        ],
                    ],
                ],
            ],
        ],
    ]);

    // Verify top branch
    $topBranch = $this->getOrganization('acme_corp');
    expect($topBranch->type)->toBe('top_branch')
        ->and($topBranch->users)->toHaveCount(2)
        ->and($topBranch->servers)->toHaveCount(3)
        ->and($topBranch->license)->not->toBeNull()
        ->and($topBranch->whiteLabelConfig)->not->toBeNull();

    // Verify hierarchy
    $this->assertOrganizationHierarchy('acme_europe', 'acme_corp');
    $this->assertOrganizationHierarchy('team_frontend', 'acme_europe');

    // Verify access control
    $adminUser = $this->getOrganizationUser('acme_corp', 'admin');
    $server = $topBranch->servers->first();
    $this->assertOrganizationAccess($adminUser, $server);

    // Verify license features
    $this->assertOrganizationHasFeature('acme_corp', 'white_label');
    $this->assertOrganizationHasFeature('acme_corp', 'terraform');
});

it('supports testing cross-organization isolation', function () {
    $this->createOrganizationHierarchy([
        'company_a' => [
            'users' => ['admin'],
            'resources' => ['servers' => 2],
        ],
        'company_b' => [
            'users' => ['admin'],
            'resources' => ['servers' => 3],
        ],
    ]);

    $adminA = $this->getOrganizationUser('company_a', 'admin');
    $adminB = $this->getOrganizationUser('company_b', 'admin');

    $serverA = $this->getOrganization('company_a')->servers->first();
    $serverB = $this->getOrganization('company_b')->servers->first();

    // Admin A can access Company A resources
    $this->assertOrganizationAccess($adminA, $serverA);

    // Admin A cannot access Company B resources
    $this->assertNoOrganizationAccess($adminA, $serverB);

    // Admin B can access Company B resources
    $this->assertOrganizationAccess($adminB, $serverB);

    // Admin B cannot access Company A resources
    $this->assertNoOrganizationAccess($adminB, $serverA);
});
```

## Definition of Done

- [ ] OrganizationTestingTrait created in tests/Traits/
- [ ] Trait provides createOrganizationHierarchy() with nested array support
- [ ] Trait provides createOrganization() with configuration options
- [ ] Trait provides createOrganizationUser() with role assignment
- [ ] Trait provides createOrganizationResources() for scoped resources
- [ ] Trait provides actingAsOrganizationUser() for context switching
- [ ] Trait provides switchOrganizationContext() for organization switching
- [ ] Trait provides assertOrganizationHierarchy() for relationship tests
- [ ] Trait provides assertOrganizationAccess() for permission tests
- [ ] Trait provides createOrganizationLicense() for license testing
- [ ] Trait provides createOrganizationBranding() for white-label testing
- [ ] Trait provides cleanupOrganizations() for automatic teardown
- [ ] All public methods have comprehensive PHPDoc blocks
- [ ] README.md documentation created with usage examples
- [ ] Example test file created demonstrating all features
- [ ] Unit tests written (10+ tests, >90% coverage)
- [ ] Integration tests written (5+ tests)
- [ ] Tests pass with all trait methods working correctly
- [ ] Code follows Laravel and Coolify coding standards
- [ ] Laravel Pint formatting applied
- [ ] Code reviewed and approved
- [ ] Documentation reviewed for clarity and completeness

## Related Tasks

- **Used by:** All enterprise feature tests (Tasks 11, 21, 31, 41, 51, 61, 71)
- **Complements:** Task 73 (LicenseTestingTrait)
- **Complements:** Task 74 (TerraformTestingTrait)
- **Complements:** Task 75 (PaymentTestingTrait)
- **Foundation for:** Task 76 (Unit tests for services)
- **Foundation for:** Task 77 (Integration tests for workflows)
