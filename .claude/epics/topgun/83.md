---
name: Write Terraform infrastructure provisioning documentation
status: open
created: 2025-10-06T15:23:47Z
updated: 2025-10-06T20:39:34Z
github: https://github.com/johnproblems/topgun/issues/190
depends_on: [21]
parallel: true
conflicts_with: []
---

# Task: Write Terraform infrastructure provisioning documentation

## Description

Create comprehensive end-user and administrator documentation for the Terraform infrastructure provisioning system. This documentation enables organizations to provision cloud infrastructure directly through the Coolify UI, eliminating manual server setup and configuration. The documentation must cover cloud provider credential management, infrastructure provisioning workflows, Terraform state management, server auto-registration, troubleshooting common issues, and best practices for multi-cloud deployments.

**Why This Task Is Critical:**

Infrastructure provisioning is a complex, high-stakes operation that can cost organizations significant money if done incorrectly. Poor documentation leads to:
- **Misconfigured cloud resources** resulting in security vulnerabilities
- **Runaway cloud costs** from orphaned resources or improper instance sizing
- **Production outages** from accidental infrastructure destruction
- **Support overhead** from users struggling with credential configuration
- **Abandoned features** when users can't understand how to use advanced capabilities

High-quality documentation transforms infrastructure provisioning from a dangerous, expert-only feature into a reliable, accessible capability that non-DevOps users can confidently use. This documentation must be **comprehensive enough for beginners** while providing **advanced guidance for power users**.

**Documentation Scope:**

1. **Getting Started Guide**: Step-by-step walkthrough for first-time infrastructure provisioning
2. **Cloud Provider Setup**: Credential creation, permission configuration, and validation for each supported provider
3. **Provisioning Workflows**: UI-driven provisioning, Terraform template customization, multi-server deployments
4. **Server Auto-Registration**: Understanding the automatic server onboarding process
5. **State Management**: Terraform state backup, recovery, and troubleshooting
6. **Multi-Cloud Strategies**: When to use AWS vs. DigitalOcean vs. Hetzner, cost optimization
7. **Troubleshooting Guide**: Common errors, diagnostic steps, rollback procedures
8. **Security Best Practices**: Credential rotation, least-privilege IAM policies, network security
9. **API Reference**: Programmatic infrastructure provisioning for advanced automation
10. **Administrator Guide**: Organization-wide infrastructure policies, quota management, audit logging

**Integration with Existing Coolify Documentation:**

This documentation builds upon Coolify's existing server management documentation but focuses specifically on **automated provisioning** rather than manual server addition. It cross-references:
- Existing server management guides (SSH key setup, Docker installation)
- Application deployment workflows (how provisioned servers integrate with deployments)
- Organization and licensing documentation (infrastructure quota enforcement)

**Target Audience:**

- **Primary**: Organization administrators provisioning infrastructure for their teams
- **Secondary**: Developers setting up personal development/staging environments
- **Tertiary**: Enterprise administrators managing multi-cloud strategies across sub-organizations

**Documentation Format:**

- **Markdown files** in `.claude/docs/features/infrastructure-provisioning/`
- **Screenshots and diagrams** for UI workflows (Figma exports or Excalidraw)
- **Code examples** for Terraform customization and API usage
- **Video tutorials** (optional, but highly valuable for complex workflows)

## Acceptance Criteria

- [ ] Getting started guide written with step-by-step first-time provisioning walkthrough
- [ ] Cloud provider credential setup documented for AWS, DigitalOcean, and Hetzner
- [ ] IAM policy examples provided for each cloud provider with least-privilege configurations
- [ ] Provisioning workflow documentation includes UI screenshots and detailed steps
- [ ] Terraform template customization guide with 5+ practical examples
- [ ] Server auto-registration process explained with architecture diagrams
- [ ] State management documentation covers backup, recovery, and migration scenarios
- [ ] Troubleshooting guide includes 15+ common errors with solutions
- [ ] Security best practices section covers credential rotation, network security, and compliance
- [ ] Multi-cloud cost comparison table with recommendations
- [ ] API documentation with complete cURL and code examples for all endpoints
- [ ] Administrator guide covers organization policies, quotas, and audit logging
- [ ] Documentation reviewed for technical accuracy by infrastructure team
- [ ] Documentation reviewed for clarity by non-DevOps users
- [ ] All code examples tested and verified working

## Technical Details

### File Structure

**Documentation Directory:**
```
.claude/docs/features/infrastructure-provisioning/
├── README.md                                    # Table of contents and overview
├── getting-started.md                          # First-time user guide
├── cloud-providers/
│   ├── aws-setup.md                           # AWS credential and IAM configuration
│   ├── digitalocean-setup.md                  # DigitalOcean API token setup
│   ├── hetzner-setup.md                       # Hetzner cloud API setup
│   └── credential-management.md               # Credential rotation and security
├── provisioning-workflows/
│   ├── single-server-provisioning.md         # Basic provisioning workflow
│   ├── multi-server-deployment.md            # Provisioning multiple servers
│   ├── terraform-customization.md            # Customizing Terraform templates
│   └── advanced-configurations.md            # VPC, networking, storage options
├── server-registration/
│   ├── auto-registration-overview.md         # How auto-registration works
│   ├── ssh-key-management.md                 # SSH key injection and rotation
│   └── docker-verification.md                # Post-provisioning health checks
├── state-management/
│   ├── terraform-state-overview.md           # Understanding Terraform state
│   ├── state-backup-recovery.md              # Backup and disaster recovery
│   └── state-migration.md                    # Migrating state between backends
├── troubleshooting/
│   ├── common-errors.md                      # Error codes and solutions
│   ├── diagnostic-tools.md                   # Debugging provisioning failures
│   └── rollback-procedures.md                # Infrastructure rollback and cleanup
├── security/
│   ├── credential-security.md                # Encryption and secret management
│   ├── iam-policies.md                       # Least-privilege policy templates
│   └── network-security.md                   # Security groups and firewall rules
├── multi-cloud/
│   ├── provider-comparison.md                # AWS vs. DO vs. Hetzner comparison
│   ├── cost-optimization.md                  # Cost-saving strategies
│   └── hybrid-deployments.md                 # Multi-cloud architecture patterns
├── api-reference/
│   ├── authentication.md                     # API authentication for provisioning
│   ├── provisioning-endpoints.md             # API endpoint documentation
│   └── webhook-integration.md                # Provisioning status webhooks
└── administrator-guide/
    ├── organization-policies.md              # Infrastructure governance
    ├── quota-management.md                   # Enforcing infrastructure limits
    └── audit-logging.md                      # Tracking infrastructure changes
```

### Documentation Content Examples

#### Getting Started Guide

**File:** `.claude/docs/features/infrastructure-provisioning/getting-started.md`

```markdown
# Getting Started with Infrastructure Provisioning

Provision cloud infrastructure directly from Coolify without manual server setup.

## Prerequisites

- Organization with an active Enterprise license
- Cloud provider account (AWS, DigitalOcean, or Hetzner)
- API credentials from your cloud provider
- Sufficient infrastructure quota in your license

## Your First Provisioning (5 minutes)

This walkthrough provisions a single DigitalOcean droplet and registers it as a Coolify server.

### Step 1: Add Cloud Provider Credentials

1. Navigate to **Organization Settings** → **Infrastructure** → **Cloud Providers**
2. Click **"Add Cloud Provider"**
3. Select **"DigitalOcean"** from the provider dropdown
4. Enter your DigitalOcean API token:
   - Go to https://cloud.digitalocean.com/account/api/tokens
   - Click **"Generate New Token"**
   - Name: `coolify-provisioning`, Scope: **Read & Write**
   - Copy the token (you'll only see it once)
   - Paste into Coolify's "API Token" field
5. Click **"Validate Credentials"** to verify connectivity
6. Click **"Save"** when validation succeeds

**Screenshot:** [Add Cloud Provider Credentials UI]

### Step 2: Configure Infrastructure Template

1. Navigate to **Infrastructure** → **Provision New Server**
2. Choose **"DigitalOcean"** as the provider
3. Configure basic settings:
   - **Region:** `nyc3` (New York 3)
   - **Instance Size:** `s-1vcpu-1gb` ($6/month, suitable for small apps)
   - **Image:** `ubuntu-22-04-x64` (Ubuntu 22.04 LTS)
   - **Server Name:** `coolify-production-1`
4. Review the Terraform preview (auto-generated)
5. Click **"Provision Infrastructure"**

**Screenshot:** [Infrastructure Configuration UI]

### Step 3: Monitor Provisioning Progress

1. You'll be redirected to the **Deployment Monitoring** page
2. Watch real-time Terraform output:
   - `Initializing Terraform...` (15-30 seconds)
   - `Planning infrastructure changes...` (10-20 seconds)
   - `Creating droplet...` (60-90 seconds)
   - `Configuring SSH access...` (10-15 seconds)
   - `Installing Docker...` (30-45 seconds)
3. Total provisioning time: **~3-5 minutes**

**Screenshot:** [Deployment Monitoring UI with progress]

### Step 4: Verify Server Registration

1. When provisioning completes, navigate to **Servers**
2. You should see **`coolify-production-1`** with status: **✓ Online**
3. Server details:
   - IP Address: Auto-populated from Terraform
   - Docker Version: Auto-detected
   - Resources: CPU, Memory, Disk displayed
4. Click **"View Server"** to see full details

**Screenshot:** [Server list showing newly provisioned server]

### Step 5: Deploy Your First Application

Your server is now ready! Follow the [Application Deployment Guide](../application-deployment/) to deploy apps.

---

## Next Steps

- [Customize Terraform templates](./provisioning-workflows/terraform-customization.md) for advanced configurations
- [Provision multiple servers](./provisioning-workflows/multi-server-deployment.md) for production environments
- [Set up auto-scaling](./advanced/auto-scaling.md) for dynamic workloads

## Need Help?

- **Troubleshooting:** See [Common Errors](./troubleshooting/common-errors.md)
- **Support:** Contact support@coolify.io
- **Community:** Join our Discord for real-time help
```

---

#### AWS Setup Guide

**File:** `.claude/docs/features/infrastructure-provisioning/cloud-providers/aws-setup.md`

```markdown
# AWS Infrastructure Provisioning Setup

Configure AWS credentials and IAM policies for secure infrastructure provisioning.

## Prerequisites

- AWS account with administrative access
- Basic understanding of IAM policies and roles
- Organization with Enterprise license in Coolify

## Overview

Coolify uses **Terraform** to provision AWS EC2 instances, VPCs, security groups, and related resources. This requires AWS API credentials with specific permissions.

**Security Best Practice:** Use a dedicated IAM user with **least-privilege permissions** rather than root credentials.

---

## Step 1: Create IAM Policy

Create a custom IAM policy that grants only the necessary permissions for Coolify to provision infrastructure.

### Recommended IAM Policy (Least-Privilege)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "CoolifyEC2Provisioning",
      "Effect": "Allow",
      "Action": [
        "ec2:RunInstances",
        "ec2:TerminateInstances",
        "ec2:DescribeInstances",
        "ec2:DescribeInstanceStatus",
        "ec2:DescribeImages",
        "ec2:DescribeKeyPairs",
        "ec2:CreateKeyPair",
        "ec2:DeleteKeyPair",
        "ec2:ImportKeyPair",
        "ec2:DescribeSecurityGroups",
        "ec2:CreateSecurityGroup",
        "ec2:DeleteSecurityGroup",
        "ec2:AuthorizeSecurityGroupIngress",
        "ec2:AuthorizeSecurityGroupEgress",
        "ec2:RevokeSecurityGroupIngress",
        "ec2:RevokeSecurityGroupEgress",
        "ec2:CreateTags",
        "ec2:DescribeTags"
      ],
      "Resource": "*",
      "Condition": {
        "StringEquals": {
          "ec2:Region": ["us-east-1", "us-west-2", "eu-west-1"]
        }
      }
    },
    {
      "Sid": "CoolifyVPCManagement",
      "Effect": "Allow",
      "Action": [
        "ec2:DescribeVpcs",
        "ec2:CreateVpc",
        "ec2:DeleteVpc",
        "ec2:DescribeSubnets",
        "ec2:CreateSubnet",
        "ec2:DeleteSubnet",
        "ec2:DescribeInternetGateways",
        "ec2:CreateInternetGateway",
        "ec2:AttachInternetGateway",
        "ec2:DetachInternetGateway",
        "ec2:DeleteInternetGateway",
        "ec2:DescribeRouteTables",
        "ec2:CreateRouteTable",
        "ec2:DeleteRouteTable",
        "ec2:CreateRoute",
        "ec2:DeleteRoute",
        "ec2:AssociateRouteTable",
        "ec2:DisassociateRouteTable"
      ],
      "Resource": "*"
    }
  ]
}
```

**How to create this policy:**

1. Sign in to AWS Console → **IAM** → **Policies**
2. Click **"Create policy"** → Switch to **JSON** tab
3. Paste the JSON above
4. Click **"Next: Tags"** → **"Next: Review"**
5. Name: `CoolifyInfrastructureProvisioning`
6. Description: `Allows Coolify to provision EC2 infrastructure`
7. Click **"Create policy"**

---

## Step 2: Create IAM User

Create a dedicated IAM user for Coolify to use.

1. Go to **IAM** → **Users** → **Add users**
2. User name: `coolify-provisioning`
3. Access type: **Programmatic access** (API key)
4. Click **"Next: Permissions"**
5. Select **"Attach existing policies directly"**
6. Search for and select **`CoolifyInfrastructureProvisioning`** (the policy you created)
7. Click **"Next: Tags"** → **"Next: Review"** → **"Create user"**
8. **Important:** Download the CSV with Access Key ID and Secret Access Key (you won't see the secret again!)

---

## Step 3: Add Credentials to Coolify

1. Navigate to **Organization Settings** → **Infrastructure** → **Cloud Providers**
2. Click **"Add Cloud Provider"**
3. Provider: **AWS**
4. Fill in the form:
   - **AWS Access Key ID:** `AKIA...` (from CSV)
   - **AWS Secret Access Key:** `wJalrXU...` (from CSV)
   - **Default Region:** `us-east-1` (or your preferred region)
   - **Credential Name:** `AWS Production Account`
5. Click **"Validate Credentials"**
   - Coolify will test `ec2:DescribeInstances` to verify access
   - If validation fails, check IAM policy attachment
6. Click **"Save"** when validation succeeds

**Screenshot:** [AWS Credential Configuration UI]

---

## Step 4: Test Provisioning

Provision a small test instance to verify everything works:

1. Go to **Infrastructure** → **Provision New Server**
2. Provider: **AWS**
3. Configuration:
   - **Region:** `us-east-1`
   - **Instance Type:** `t3.micro` (free tier eligible, $0.01/hour)
   - **AMI:** `ubuntu-22.04` (auto-selected)
   - **Server Name:** `coolify-test-1`
4. Click **"Provision Infrastructure"**
5. Monitor the deployment (should complete in ~4-5 minutes)

**Expected Terraform Output:**

```
Initializing Terraform...
Terraform initialized successfully.

Planning infrastructure changes...
Plan: 5 to add, 0 to change, 0 to destroy.

Creating VPC...
aws_vpc.coolify: Creating...
aws_vpc.coolify: Creation complete after 2s

Creating security group...
aws_security_group.coolify: Creating...
aws_security_group.coolify: Creation complete after 3s

Creating EC2 instance...
aws_instance.coolify_server: Creating...
aws_instance.coolify_server: Still creating... [10s elapsed]
aws_instance.coolify_server: Still creating... [20s elapsed]
aws_instance.coolify_server: Creation complete after 35s

Apply complete! Resources: 5 added, 0 changed, 0 destroyed.

Outputs:
instance_ip = "3.85.123.45"
instance_id = "i-0abcd1234efgh5678"
```

---

## Step 5: Verify Auto-Registration

1. Go to **Servers** in Coolify
2. Verify **`coolify-test-1`** appears with:
   - ✓ **Online** status
   - IP: `3.85.123.45` (matches Terraform output)
   - Docker installed and running
3. Click **"View Server"** → **"Run Health Check"**
4. All checks should pass:
   - ✓ SSH connectivity
   - ✓ Docker daemon running
   - ✓ Disk space available
   - ✓ Network connectivity

**Screenshot:** [Server details showing successful auto-registration]

---

## Security Best Practices

### 1. Credential Rotation

Rotate AWS access keys every 90 days:

1. Create a new access key in IAM
2. Update credentials in Coolify
3. Validate new credentials
4. Deactivate old access key
5. Monitor for errors, then delete old key after 7 days

### 2. Enable AWS CloudTrail

Track all API calls made by Coolify:

```bash
aws cloudtrail create-trail \
  --name coolify-infrastructure-audit \
  --s3-bucket-name my-cloudtrail-bucket \
  --is-multi-region-trail
```

### 3. Use MFA for IAM User (Optional but Recommended)

Require MFA for sensitive operations:

1. Go to IAM → Users → `coolify-provisioning`
2. **Security credentials** tab → **Assign MFA device**
3. Follow the setup wizard

**Note:** Terraform doesn't support MFA directly, so this is for console access only.

### 4. Restrict by IP (Advanced)

Limit API access to Coolify's IP addresses:

```json
{
  "Condition": {
    "IpAddress": {
      "aws:SourceIp": ["203.0.113.10/32", "203.0.113.20/32"]
    }
  }
}
```

---

## Troubleshooting

### Error: "UnauthorizedOperation: You are not authorized to perform this operation"

**Cause:** IAM policy missing required permissions.

**Solution:**
1. Check the IAM policy attached to `coolify-provisioning` user
2. Verify the policy includes the action mentioned in the error
3. Example: Missing `ec2:CreateSecurityGroup` → Add to policy

### Error: "InvalidKeyPair.NotFound"

**Cause:** Coolify trying to use a deleted SSH key pair.

**Solution:**
1. Go to AWS Console → EC2 → Key Pairs
2. Delete any orphaned `coolify-*` key pairs
3. Retry provisioning (Coolify will create a new key pair)

### Error: "VcpuLimitExceeded: You have requested more vCPU capacity than your current vCPU limit"

**Cause:** AWS account vCPU limit reached.

**Solution:**
1. Go to AWS Console → EC2 → Limits
2. Request a limit increase for **Running On-Demand Standard instances**
3. Or provision smaller instances (e.g., `t3.micro` instead of `t3.large`)

---

## Cost Optimization Tips

### Use Spot Instances for Non-Production

Modify Terraform template to use EC2 Spot Instances (up to 90% cheaper):

```hcl
resource "aws_spot_instance_request" "coolify_server" {
  spot_price           = "0.03"  # Max price per hour
  instance_type        = "t3.medium"
  ami                  = var.ami_id
  wait_for_fulfillment = true
}
```

See [Terraform Customization Guide](../provisioning-workflows/terraform-customization.md) for details.

### Schedule Instance Shutdowns

Use AWS Instance Scheduler to stop instances overnight:

- Development servers: Run 9 AM - 6 PM weekdays only
- Staging servers: Run on-demand only
- Production servers: Run 24/7

Potential savings: **50-70%** for non-production environments.

### Use Reserved Instances for Production

For stable production workloads, commit to Reserved Instances:

- 1-year commitment: ~30% discount
- 3-year commitment: ~60% discount

---

## Next Steps

- [Provision your first server](../provisioning-workflows/single-server-provisioning.md)
- [Customize Terraform templates](../provisioning-workflows/terraform-customization.md)
- [Multi-cloud deployment strategies](../multi-cloud/provider-comparison.md)

## Need Help?

- **AWS-specific issues:** Check [AWS Troubleshooting](../troubleshooting/aws-errors.md)
- **General Terraform issues:** See [Terraform Troubleshooting](../troubleshooting/terraform-errors.md)
- **Support:** support@coolify.io
```

---

#### Troubleshooting Guide

**File:** `.claude/docs/features/infrastructure-provisioning/troubleshooting/common-errors.md`

```markdown
# Common Infrastructure Provisioning Errors

Comprehensive troubleshooting guide for Terraform infrastructure provisioning.

---

## Cloud Provider Credential Errors

### Error: "Invalid AWS credentials"

**Full Error:**
```
Error: Error configuring Terraform AWS Provider: error validating provider credentials: error calling sts:GetCallerIdentity: InvalidClientTokenId: The security token included in the request is invalid
```

**Cause:** AWS Access Key ID or Secret Access Key is incorrect or has been rotated.

**Solution:**
1. Verify credentials in AWS Console → IAM → Users → Security credentials
2. If key was rotated, update in Coolify:
   - **Organization Settings** → **Infrastructure** → **Cloud Providers**
   - Edit AWS provider → Update credentials → **Validate**
3. If validation still fails, regenerate access key and update immediately

---

### Error: "DigitalOcean API token expired"

**Full Error:**
```
Error: Error creating droplet: POST https://api.digitalocean.com/v2/droplets: 401 Unable to authenticate you
```

**Cause:** DigitalOcean API token was deleted or expired.

**Solution:**
1. Generate new token: https://cloud.digitalocean.com/account/api/tokens
2. Update in Coolify → **Cloud Providers** → Edit DigitalOcean → Paste new token
3. Validate credentials before saving

---

## Terraform Execution Errors

### Error: "Terraform binary not found"

**Full Error:**
```
Error: Terraform binary not found at path: /usr/local/bin/terraform
System tried to execute terraform but the command was not found
```

**Cause:** Terraform is not installed on the Coolify server.

**Solution (Administrator):**
```bash
# SSH into Coolify server
cd /tmp
wget https://releases.hashicorp.com/terraform/1.6.4/terraform_1.6.4_linux_amd64.zip
unzip terraform_1.6.4_linux_amd64.zip
sudo mv terraform /usr/local/bin/
terraform --version  # Should output: Terraform v1.6.4
```

Then retry provisioning.

---

### Error: "Terraform state lock failed"

**Full Error:**
```
Error: Error acquiring the state lock

Terraform acquires a lock when accessing your state to prevent concurrent modifications.
Lock Info:
  ID:        a1b2c3d4-1234-5678-90ab-cdef12345678
  Path:      terraform.tfstate
  Operation: OperationTypeApply
  Who:       user@coolify-server
  Created:   2024-01-15 14:30:22.123456789 +0000 UTC
```

**Cause:** Another Terraform operation is running for this deployment, or a previous operation crashed without releasing the lock.

**Solution (Automatic - Wait 5 Minutes):**
Coolify automatically retries after the lock timeout expires.

**Solution (Manual - Force Unlock):**

⚠️ **DANGER:** Only use if you're certain no other Terraform process is running!

1. Go to **Infrastructure** → **Terraform Deployments**
2. Find the locked deployment
3. Click **"Force Unlock"** → Confirm with deployment ID
4. Retry provisioning

---

## Resource Provisioning Errors

### Error: "Insufficient capacity in availability zone"

**Full Error (AWS):**
```
Error: Error launching instance: InsufficientInstanceCapacity: We currently do not have sufficient t3.large capacity in the Availability Zone you requested (us-east-1a).
```

**Cause:** AWS temporarily out of capacity for that instance type in that AZ.

**Solution (Option 1 - Retry in Different AZ):**
1. Edit provisioning configuration
2. Change **Availability Zone** from `us-east-1a` to `us-east-1b`
3. Retry provisioning

**Solution (Option 2 - Use Different Instance Type):**
1. Change **Instance Type** from `t3.large` to `t3.xlarge` or `m5.large`
2. Retry provisioning

---

### Error: "Quota exceeded for resource"

**Full Error (DigitalOcean):**
```
Error: Error creating droplet: POST https://api.digitalocean.com/v2/droplets: 422 You have reached the droplet limit for your account. Please contact support to increase your limit.
```

**Cause:** Cloud provider account quota limit reached.

**Solution:**
1. Check current usage in cloud provider dashboard
2. **Option A:** Delete unused resources to free up quota
3. **Option B:** Request quota increase from cloud provider support
4. **Option C:** Use a different cloud provider account

---

### Error: "Invalid AMI ID"

**Full Error (AWS):**
```
Error: Error launching instance: InvalidAMIID.NotFound: The image id '[ami-abc123]' does not exist
```

**Cause:** AMI ID doesn't exist in the selected region.

**Solution:**
AMIs are region-specific. Coolify auto-selects AMIs, but if you customized the template:

1. Go to AWS Console → EC2 → AMIs
2. Filter by **Public images** → Search: `ubuntu-22.04`
3. Copy the correct AMI ID for your region (e.g., `ami-0c55b159cbfafe1f0`)
4. Update Terraform template with correct AMI ID
5. Retry provisioning

---

## Network and Connectivity Errors

### Error: "SSH connection timeout after provisioning"

**Full Error:**
```
Error: Server provisioned successfully but SSH connection timed out during auto-registration.
Server IP: 203.0.113.45
Waited: 5 minutes
```

**Cause:** Security group doesn't allow SSH (port 22) from Coolify server.

**Solution (Automatic):**
Coolify's Terraform templates include SSH access rules, but if customized:

1. Go to cloud provider → Security Groups/Firewall
2. Find the security group for this server (tagged: `coolify-server`)
3. Add inbound rule:
   - **Protocol:** TCP
   - **Port:** 22
   - **Source:** Your Coolify server's IP (check Organization Settings → Infrastructure → Coolify Server IP)
4. Click **"Retry Auto-Registration"** in Coolify

---

### Error: "Docker daemon not responding"

**Full Error:**
```
Error: Server registered but Docker health check failed.
Error: Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?
```

**Cause:** Docker installation failed or didn't start automatically.

**Solution (SSH Troubleshooting):**

```bash
# SSH into the server
ssh root@203.0.113.45

# Check Docker status
systemctl status docker

# If inactive, start Docker
systemctl start docker
systemctl enable docker

# Verify Docker works
docker ps
```

If Docker isn't installed, the provisioning script may have failed. Check `/var/log/cloud-init-output.log` for errors.

Then click **"Retry Health Check"** in Coolify.

---

## Terraform State Errors

### Error: "State file corrupted"

**Full Error:**
```
Error: Failed to load state: state snapshot was created by Terraform v1.6.4, but this is v1.5.7
```

**Cause:** Terraform version mismatch between provisioning and current environment.

**Solution (Restore from Backup):**
1. Go to **Infrastructure** → **Terraform Deployments** → Select deployment
2. Click **"State Management"** → **"Restore from Backup"**
3. Select the most recent backup before the error
4. Click **"Restore State"**
5. Retry operation

---

### Error: "State file not found"

**Full Error:**
```
Error: Failed to load state: stat terraform.tfstate: no such file or directory
```

**Cause:** State file was accidentally deleted or never created.

**Solution (If Infrastructure Exists):**

**Import existing infrastructure into Terraform state:**

```bash
# Find resource IDs from cloud provider
# AWS example:
aws ec2 describe-instances --filters "Name=tag:Name,Values=coolify-server-123"

# Import into Terraform
terraform import aws_instance.coolify_server i-0abcd1234efgh5678
```

**Solution (If Infrastructure Doesn't Exist):**

The deployment record is stale. Delete it from Coolify:

1. **Infrastructure** → **Terraform Deployments**
2. Find the broken deployment
3. Click **"Delete Deployment Record"** (this only deletes Coolify's record, not cloud resources)

---

## Performance Issues

### Issue: "Provisioning takes longer than 10 minutes"

**Expected Duration:**
- AWS: 4-6 minutes
- DigitalOcean: 3-5 minutes
- Hetzner: 3-4 minutes

**Diagnosis Steps:**

1. Check Terraform output for stuck operations:
   - If stuck on `Creating instance...` for > 5 minutes → Cloud provider issue
   - If stuck on `Installing Docker...` for > 3 minutes → Network/package repository issue

2. Check cloud provider status page:
   - AWS: https://status.aws.amazon.com
   - DigitalOcean: https://status.digitalocean.com
   - Hetzner: https://status.hetzner.com

3. If provider has outage → Wait and retry later

4. If no outage → Check Terraform debug logs:
   - **Infrastructure** → **Terraform Deployments** → **View Full Logs**
   - Look for errors or warnings

---

## Cleanup and Rollback Errors

### Error: "Cannot destroy resources - dependent resources exist"

**Full Error:**
```
Error: Error deleting security group: DependencyViolation: resource sg-0abc123 has a dependent object
```

**Cause:** Terraform trying to delete resources in wrong order due to dependency graph corruption.

**Solution (Force Cleanup):**

1. Go to cloud provider console
2. Manually delete dependent resources first:
   - AWS: Delete EC2 instances → Then security groups → Then VPC
   - DigitalOcean: Delete droplets → Then firewall rules
3. Return to Coolify → Click **"Sync State with Cloud Provider"**
4. Retry destroy operation

---

### Error: "Rollback failed - infrastructure partially created"

**Full Error:**
```
Error: Provisioning failed at step 3/5. Rollback failed with error: Error deleting vpc: VpcNotEmpty
Resources Created:
- VPC: vpc-abc123
- Subnet: subnet-def456
Resources Not Created:
- Instance, Security Group, Route Table
```

**Cause:** Provisioning failed midway, rollback couldn't fully cleanup.

**Solution (Manual Cleanup Required):**

1. Note the resource IDs from error message
2. Go to cloud provider console
3. Delete resources manually (in reverse order):
   - AWS: Instances → Security Groups → Subnets → VPC
4. Verify all resources deleted
5. In Coolify → **Mark Deployment as Failed** → **Delete Deployment Record**
6. Retry provisioning with fresh deployment

---

## License and Quota Errors

### Error: "Organization infrastructure quota exceeded"

**Full Error:**
```
Error: Organization 'Acme Corp' has reached infrastructure quota limit.
Current: 15 servers
License Limit: 15 servers
Upgrade your license or delete unused servers.
```

**Cause:** Organization's enterprise license limits infrastructure capacity.

**Solution (Option A - Upgrade License):**
1. **Organization Settings** → **License** → **Upgrade Plan**
2. Select plan with higher server limit
3. Complete payment
4. Retry provisioning

**Solution (Option B - Delete Unused Servers):**
1. **Servers** → Identify unused/old servers
2. **Delete Server** → Confirm deletion
3. Retry provisioning when quota available

---

## Getting Additional Help

If your issue isn't covered here:

1. **Check Terraform Logs:**
   - **Infrastructure** → **Terraform Deployments** → Select deployment → **Full Logs**
   - Look for `Error:` lines and copy the full error message

2. **Run Diagnostic Tool:**
   - **Infrastructure** → **Diagnostics** → **Run Infrastructure Health Check**
   - This checks: Terraform installation, cloud provider connectivity, state file integrity

3. **Contact Support:**
   - Email: support@coolify.io
   - Include:
     - Full error message
     - Deployment ID
     - Cloud provider (AWS/DigitalOcean/Hetzner)
     - Terraform logs (if available)

4. **Community Support:**
   - Discord: https://discord.gg/coolify
   - Forum: https://community.coolify.io
   - GitHub Issues: https://github.com/coollabsio/coolify/issues

---

## Preventive Measures

### Best Practices to Avoid Errors

1. **Validate credentials before provisioning**
   - Always click "Validate Credentials" after adding/updating cloud providers

2. **Test with small instances first**
   - Use `t3.micro` (AWS) or `s-1vcpu-1gb` (DigitalOcean) for testing

3. **Monitor cloud provider quotas**
   - Set up billing alerts to avoid unexpected quota limits

4. **Keep Terraform up to date**
   - Administrators: Regularly update Terraform binary to latest stable version

5. **Enable state backups**
   - **Organization Settings** → **Infrastructure** → **State Backup** → Enable S3 backup

6. **Review infrastructure before destroying**
   - Always check what resources will be deleted before confirming destruction

---

## Error Reporting

Help improve this documentation by reporting new errors:

1. Go to **Infrastructure** → **Report Issue**
2. Fill in:
   - Error message
   - Steps to reproduce
   - Expected vs. actual behavior
3. Our team will investigate and update documentation

---

## Related Documentation

- [AWS Setup Guide](../cloud-providers/aws-setup.md)
- [DigitalOcean Setup Guide](../cloud-providers/digitalocean-setup.md)
- [Terraform State Management](../state-management/terraform-state-overview.md)
- [Diagnostic Tools](./diagnostic-tools.md)
```

---

### Administrator Guide

**File:** `.claude/docs/features/infrastructure-provisioning/administrator-guide/organization-policies.md`

```markdown
# Infrastructure Governance and Organization Policies

Set up infrastructure policies, quotas, and governance controls for multi-tenant environments.

---

## Overview

As a Coolify Enterprise administrator managing multiple organizations, you need centralized control over:
- **Infrastructure quotas** - Limit servers per organization
- **Cloud provider restrictions** - Allow/deny specific providers
- **Cost controls** - Set spending limits and alerts
- **Audit logging** - Track all infrastructure changes
- **Security policies** - Enforce encryption, network rules, compliance requirements

This guide covers setting up organization-level infrastructure governance.

---

## Organization Hierarchy and Quotas

### Understanding the Hierarchy

```
Top Branch Organization
├── Master Branch Organization 1
│   ├── Sub-User Organization A
│   └── Sub-User Organization B
└── Master Branch Organization 2
    ├── Sub-User Organization C
    └── End User Organization D
```

**Quota Inheritance:**
- **Top Branch** sets maximum infrastructure quota for all descendants
- **Master Branch** can subdivide quota among sub-organizations
- **Sub-User** organizations consume quota from parent Master Branch

**Example:**
- Top Branch license: 100 servers
- Master Branch 1 allocated: 60 servers
  - Sub-User Org A: 40 servers (consumes from Master Branch 1's 60)
  - Sub-User Org B: 20 servers
- Master Branch 2 allocated: 40 servers

---

## Setting Infrastructure Quotas

### Define License-Based Quotas

1. Navigate to **Admin** → **Organizations** → Select organization
2. Go to **Enterprise License** tab
3. Configure infrastructure limits:

```yaml
Infrastructure Quotas:
  max_servers: 50
  max_cpu_cores: 200
  max_memory_gb: 512
  max_disk_gb: 5000
  max_monthly_spend_usd: 1000
```

4. Click **"Update License"**

### Enforce Quota Checks

Coolify automatically enforces quotas during:
- **Server provisioning** - Blocks new servers if quota exceeded
- **Instance resizing** - Prevents upgrades that exceed CPU/memory quota
- **Application deployments** - Warns if approaching limits

**Real-time Quota Dashboard:**

Navigate to **Admin** → **Resource Usage** to see:
- Current usage vs. quota for each organization
- Trends (daily/weekly/monthly growth)
- Forecast when quotas will be reached

---

## Cloud Provider Restrictions

### Allow/Deny Specific Providers

Restrict organizations to approved cloud providers for compliance or cost control.

**Scenario:** Only allow AWS and DigitalOcean for production organizations, but allow all providers for development organizations.

**Implementation:**

1. **Admin** → **Organizations** → Select organization → **Cloud Providers** tab
2. Configure allowed providers:

```yaml
Allowed Cloud Providers:
  - aws          # Amazon Web Services
  - digitalocean # DigitalOcean
Denied Providers:
  - hetzner      # Not approved for production
  - linode       # Not approved
```

3. Click **"Save Restrictions"**

**Effect:**
- Users in this organization can only add AWS and DigitalOcean credentials
- Provisioning UI only shows allowed providers in dropdowns
- API requests for denied providers return `403 Forbidden`

---

## Cost Controls and Spending Limits

### Set Monthly Spending Limits

Prevent runaway cloud costs with automatic spending limits.

**Configuration:**

1. **Admin** → **Organizations** → **Billing & Limits** tab
2. Set limits:

```yaml
Cost Controls:
  monthly_limit_usd: 1000
  daily_limit_usd: 50
  alert_threshold_percent: 80  # Alert at 80% of limit
  action_on_limit_exceeded: pause_provisioning  # Options: pause_provisioning, alert_only, force_destroy
```

3. Configure alert recipients:
   - Organization admins (default)
   - Custom email addresses
   - Slack webhook

**Behavior:**
- **80% threshold reached** → Email/Slack alert sent
- **100% limit reached** → New provisioning blocked (existing servers continue running)
- **Manual override** → Admins can temporarily increase limit

### Cost Tracking Dashboard

**Admin** → **Cost Analytics** shows:
- **Per-organization breakdown** - Which organizations are spending the most
- **Per-provider breakdown** - AWS vs. DigitalOcean vs. Hetzner costs
- **Trend analysis** - Cost growth over time
- **Forecast** - Projected monthly costs based on current usage

**Export Options:**
- CSV export for accounting
- API endpoint for integration with finance systems

---

## Security Policies

### Enforce Encryption Standards

Require all infrastructure to use encrypted storage and transit.

**Policy Configuration:**

```yaml
Security Policies:
  require_encrypted_storage: true
  require_encrypted_networking: true  # VPC encryption, TLS
  minimum_tls_version: "1.2"
  allowed_ssh_key_types: ["rsa-4096", "ed25519"]
  deny_ssh_password_auth: true
```

**Enforcement:**
- Terraform templates automatically modified to include encryption settings
- Provisioning fails if encryption requirements can't be met
- Audit logs track encryption policy compliance

### Network Security Requirements

**Firewall Rules Template:**

Coolify can enforce baseline firewall rules for all provisioned servers:

```yaml
Required Firewall Rules:
  inbound:
    - port: 22
      source: "10.0.0.0/8"  # Only allow SSH from internal network
      protocol: tcp
    - port: 443
      source: "0.0.0.0/0"   # HTTPS from anywhere
      protocol: tcp
  outbound:
    - port: 443
      destination: "0.0.0.0/0"
      protocol: tcp
    - port: 80
      destination: "0.0.0.0/0"
      protocol: tcp
  deny_all_other: true  # Default deny
```

**Application:**
- Applied automatically during provisioning
- Enforced across all cloud providers (AWS security groups, DO firewalls, Hetzner cloud firewalls)

---

## Audit Logging and Compliance

### Infrastructure Change Tracking

All infrastructure operations are automatically logged:

**Logged Events:**
- Server provisioning (initiated by, timestamp, cost, cloud provider)
- Server destruction (reason, initiated by)
- Credential additions/updates/deletions
- Terraform template modifications
- Quota limit changes
- Policy updates

**Access Audit Logs:**

1. **Admin** → **Audit Logs** → **Infrastructure**
2. Filter by:
   - Date range
   - Organization
   - Event type (provision/destroy/modify)
   - User who initiated action

**Sample Log Entry:**

```json
{
  "event_id": "evt_abc123",
  "timestamp": "2024-01-15T14:30:45Z",
  "event_type": "server_provisioned",
  "organization_id": 42,
  "organization_name": "Acme Corp",
  "user_id": 123,
  "user_email": "admin@acmecorp.com",
  "details": {
    "cloud_provider": "aws",
    "region": "us-east-1",
    "instance_type": "t3.large",
    "estimated_monthly_cost_usd": 75.00,
    "server_name": "production-web-1",
    "terraform_deployment_id": "tf-deploy-456"
  },
  "ip_address": "203.0.113.10",
  "user_agent": "Mozilla/5.0..."
}
```

### Compliance Reporting

Generate compliance reports for audits:

1. **Admin** → **Compliance** → **Generate Report**
2. Select compliance framework:
   - SOC 2 Type II
   - ISO 27001
   - HIPAA
   - Custom
3. Date range: Last 30 days / Last quarter / Last year
4. Click **"Generate PDF Report"**

**Report Includes:**
- All infrastructure changes with timestamps
- User access logs
- Security policy compliance status
- Encryption verification
- Network security configurations

---

## Infrastructure Templates and Standardization

### Create Organization-Wide Terraform Templates

Enforce standardized infrastructure configurations across all organizations.

**Scenario:** All production servers must use a specific VPC configuration with private subnets and NAT gateways.

**Implementation:**

1. **Admin** → **Infrastructure Templates**
2. Click **"Create Template"**
3. Name: `Production VPC Standard`
4. Configure template:

```hcl
# templates/production-vpc.tf
variable "organization_id" {
  type = string
}

variable "environment" {
  type    = string
  default = "production"
}

resource "aws_vpc" "main" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_hostnames = true
  enable_dns_support   = true

  tags = {
    Name         = "coolify-${var.organization_id}-vpc"
    Environment  = var.environment
    ManagedBy    = "Coolify"
  }
}

resource "aws_subnet" "private" {
  count             = 2
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.${count.index + 1}.0/24"
  availability_zone = data.aws_availability_zones.available.names[count.index]

  tags = {
    Name = "coolify-private-${count.index + 1}"
    Type = "private"
  }
}

resource "aws_nat_gateway" "main" {
  allocation_id = aws_eip.nat.id
  subnet_id     = aws_subnet.public[0].id
}

# ... (full template)
```

5. **Assign to Organizations:**
   - Select organizations: `Production Tier Organizations`
   - Enforcement level: **Required** (cannot be overridden) or **Recommended**

6. Click **"Save Template"**

**Effect:**
- When users provision infrastructure, they select from approved templates
- Custom Terraform code requires admin approval
- Ensures consistency and compliance

---

## API Access Control

### Rate Limiting for Infrastructure Operations

Prevent abuse and ensure fair resource usage with API rate limiting.

**Configuration:**

1. **Admin** → **API** → **Rate Limits**
2. Configure limits per organization tier:

```yaml
Rate Limits (per organization):
  Free Tier:
    infrastructure_provisioning: 5 per day
    infrastructure_status_checks: 100 per hour
  Starter Tier:
    infrastructure_provisioning: 20 per day
    infrastructure_status_checks: 500 per hour
  Enterprise Tier:
    infrastructure_provisioning: 100 per day
    infrastructure_status_checks: 2000 per hour
```

3. Click **"Update Rate Limits"**

**API Response Headers:**

```http
HTTP/1.1 200 OK
X-RateLimit-Limit: 20
X-RateLimit-Remaining: 12
X-RateLimit-Reset: 1642262400
```

When limit exceeded:

```http
HTTP/1.1 429 Too Many Requests
Retry-After: 3600
X-RateLimit-Limit: 20
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1642262400
```

---

## Multi-Cloud Strategy Governance

### Define Preferred Cloud Providers

Set organization-wide preferences for cloud provider selection.

**Scenario:** AWS for production, DigitalOcean for development/staging to optimize costs.

**Policy:**

```yaml
Cloud Provider Strategy:
  production:
    preferred_provider: aws
    allowed_regions: ["us-east-1", "us-west-2", "eu-west-1"]
    fallback_provider: digitalocean
  staging:
    preferred_provider: digitalocean
    allowed_regions: ["nyc3", "sfo3"]
  development:
    preferred_provider: hetzner
    allowed_regions: ["nbg1", "fsn1"]
```

**UI Behavior:**
- Provisioning wizard pre-selects preferred provider based on environment
- Shows cost comparison between providers
- Highlights savings from using preferred provider

---

## Monitoring and Alerting

### Infrastructure Health Monitoring

Set up automated monitoring for all provisioned infrastructure.

**Configured Checks:**
- Server uptime and reachability
- Docker daemon health
- Disk space utilization (alert at 80% full)
- CPU and memory usage trends
- Security group/firewall rule changes (alert on unexpected modifications)

**Alert Channels:**
- Email notifications
- Slack integration
- PagerDuty for critical alerts
- Webhook for custom integrations

**Alert Configuration:**

1. **Admin** → **Monitoring** → **Infrastructure Alerts**
2. Create alert rule:

```yaml
Alert Rule: "Production Server Disk Full"
  condition: disk_usage_percent > 80
  severity: warning
  notification_channels: ["email", "slack"]
  cooldown_period: 1 hour
  auto_remediation: expand_disk  # Optional
```

---

## Disaster Recovery and Backups

### Automated State Backups

Ensure Terraform state files are backed up and recoverable.

**Configuration:**

1. **Admin** → **Infrastructure** → **State Backup Settings**
2. Enable S3-compatible backup:

```yaml
Backup Configuration:
  enabled: true
  storage_backend: s3
  s3_bucket: coolify-terraform-state-backups
  s3_region: us-east-1
  backup_frequency: hourly
  retention_days: 90
  encryption: AES-256
```

3. Test restore process:
   - **Test Restore** → Select recent backup → **Restore to Staging**
   - Verify infrastructure state matches

---

## Best Practices Summary

### For Administrators

1. **Start with restrictive quotas, increase as needed** - Easier to grant more capacity than revoke it
2. **Use infrastructure templates** - Standardize configurations across organizations
3. **Enable audit logging immediately** - Can't retroactively log past events
4. **Set up spending alerts early** - Prevent surprise cloud bills
5. **Test disaster recovery regularly** - Quarterly state file restore drills
6. **Review access logs monthly** - Look for anomalous provisioning patterns
7. **Document custom policies** - Create internal runbooks for your specific governance rules

### For Organizations

1. **Request quota increases proactively** - Don't wait until you hit limits in production
2. **Use cost tracking dashboards** - Monitor spending trends before alerts fire
3. **Leverage templates when available** - Pre-approved templates provision faster
4. **Test in development first** - Validate new cloud providers in dev before production use
5. **Report policy conflicts** - If governance rules block legitimate work, escalate to admins

---

## Related Documentation

- [Quota Management Guide](./quota-management.md)
- [Audit Logging Reference](./audit-logging.md)
- [Cost Optimization Strategies](../multi-cloud/cost-optimization.md)
- [Security Best Practices](../security/credential-security.md)

---

## Support

**Administrator Support:**
- Email: enterprise-support@coolify.io
- Dedicated Slack channel for Enterprise customers
- Priority response SLA: 4 hours

**Documentation Feedback:**
- Suggest improvements: docs@coolify.io
- Report errors: https://github.com/coollabsio/coolify-docs/issues
```

---

### API Reference Example

**File:** `.claude/docs/features/infrastructure-provisioning/api-reference/provisioning-endpoints.md`

```markdown
# Infrastructure Provisioning API Reference

Programmatic infrastructure provisioning for automation and CI/CD integration.

---

## Authentication

All API requests require organization-scoped Sanctum API tokens.

**Generate API Token:**

1. **Organization Settings** → **API Keys** → **Create New Key**
2. Name: `CI/CD Infrastructure Automation`
3. Scopes: `infrastructure:provision`, `infrastructure:read`, `infrastructure:destroy`
4. Copy token (shown only once)

**Request Headers:**

```http
Authorization: Bearer YOUR_API_TOKEN_HERE
Content-Type: application/json
Accept: application/json
```

---

## Endpoints

### 1. Provision New Infrastructure

**Endpoint:** `POST /api/v1/infrastructure/provision`

**Description:** Provision cloud infrastructure with Terraform and auto-register as Coolify server.

**Request Body:**

```json
{
  "cloud_provider_credential_id": 42,
  "provider": "aws",
  "region": "us-east-1",
  "instance_type": "t3.large",
  "server_name": "production-api-1",
  "tags": {
    "environment": "production",
    "team": "backend",
    "cost_center": "engineering"
  },
  "terraform_variables": {
    "enable_monitoring": true,
    "backup_enabled": true,
    "disk_size_gb": 100
  }
}
```

**Parameters:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `cloud_provider_credential_id` | integer | Yes | ID of cloud provider credentials (from GET /api/v1/cloud-providers) |
| `provider` | string | Yes | Cloud provider: `aws`, `digitalocean`, `hetzner` |
| `region` | string | Yes | Provider-specific region code |
| `instance_type` | string | Yes | Instance size (e.g., `t3.large`, `s-2vcpu-4gb`) |
| `server_name` | string | Yes | Human-readable server name (must be unique) |
| `tags` | object | No | Custom tags for cloud resources |
| `terraform_variables` | object | No | Override default Terraform variables |

**Response (202 Accepted):**

```json
{
  "message": "Infrastructure provisioning started",
  "deployment_id": "tf-deploy-abc123",
  "status": "provisioning",
  "estimated_duration_seconds": 240,
  "monitor_url": "https://coolify.example.com/infrastructure/deployments/tf-deploy-abc123",
  "webhook_url": "https://coolify.example.com/webhooks/infrastructure/tf-deploy-abc123"
}
```

**Error Responses:**

```json
// 403 Forbidden - Quota exceeded
{
  "error": "Organization infrastructure quota exceeded",
  "current_servers": 50,
  "max_servers": 50,
  "message": "Upgrade your license or delete unused servers"
}

// 422 Unprocessable Entity - Invalid configuration
{
  "error": "Invalid instance type for region",
  "details": "Instance type 't3.large' is not available in region 'eu-central-1'"
}
```

**Example cURL:**

```bash
curl -X POST https://coolify.example.com/api/v1/infrastructure/provision \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "cloud_provider_credential_id": 42,
    "provider": "digitalocean",
    "region": "nyc3",
    "instance_type": "s-2vcpu-4gb",
    "server_name": "staging-web-1"
  }'
```

---

### 2. Get Provisioning Status

**Endpoint:** `GET /api/v1/infrastructure/deployments/{deployment_id}`

**Description:** Get real-time status of infrastructure provisioning.

**Response (200 OK):**

```json
{
  "deployment_id": "tf-deploy-abc123",
  "status": "provisioning",
  "progress_percent": 65,
  "current_step": "Installing Docker",
  "steps": [
    {
      "name": "Initialize Terraform",
      "status": "completed",
      "duration_seconds": 15
    },
    {
      "name": "Plan Infrastructure",
      "status": "completed",
      "duration_seconds": 8
    },
    {
      "name": "Create VPC",
      "status": "completed",
      "duration_seconds": 12
    },
    {
      "name": "Create Security Group",
      "status": "completed",
      "duration_seconds": 5
    },
    {
      "name": "Launch Instance",
      "status": "completed",
      "duration_seconds": 45
    },
    {
      "name": "Configure SSH",
      "status": "completed",
      "duration_seconds": 8
    },
    {
      "name": "Install Docker",
      "status": "in_progress",
      "duration_seconds": 23
    },
    {
      "name": "Register Server",
      "status": "pending",
      "duration_seconds": null
    }
  ],
  "server_id": null,
  "server_ip": "3.85.142.67",
  "terraform_output": {
    "instance_id": "i-0abc123def456",
    "instance_ip": "3.85.142.67",
    "vpc_id": "vpc-0xyz789"
  },
  "created_at": "2024-01-15T14:30:00Z",
  "started_at": "2024-01-15T14:30:05Z",
  "updated_at": "2024-01-15T14:32:11Z"
}
```

**Status Values:**
- `pending` - Queued, not yet started
- `provisioning` - Terraform execution in progress
- `registering` - Server created, registering with Coolify
- `completed` - Successfully provisioned and registered
- `failed` - Provisioning failed (check `error_message`)
- `rolling_back` - Failure detected, destroying resources

**Completed Response:**

```json
{
  "deployment_id": "tf-deploy-abc123",
  "status": "completed",
  "progress_percent": 100,
  "server_id": 789,
  "server_ip": "3.85.142.67",
  "server_name": "production-api-1",
  "total_duration_seconds": 287,
  "completed_at": "2024-01-15T14:35:12Z"
}
```

---

### 3. List Cloud Provider Credentials

**Endpoint:** `GET /api/v1/cloud-providers`

**Description:** List available cloud provider credentials for the organization.

**Response (200 OK):**

```json
{
  "data": [
    {
      "id": 42,
      "name": "AWS Production Account",
      "provider": "aws",
      "default_region": "us-east-1",
      "is_validated": true,
      "created_at": "2024-01-10T10:00:00Z",
      "last_used_at": "2024-01-15T14:30:00Z"
    },
    {
      "id": 43,
      "name": "DigitalOcean Staging",
      "provider": "digitalocean",
      "default_region": "nyc3",
      "is_validated": true,
      "created_at": "2024-01-12T11:00:00Z",
      "last_used_at": null
    }
  ]
}
```

---

### 4. Destroy Infrastructure

**Endpoint:** `DELETE /api/v1/infrastructure/deployments/{deployment_id}`

**Description:** Destroy cloud infrastructure and unregister server from Coolify.

**Request Body (Optional):**

```json
{
  "force": false,
  "delete_server_data": false
}
```

**Parameters:**

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `force` | boolean | false | Force destroy even if applications are running |
| `delete_server_data` | boolean | false | Delete all application data (dangerous!) |

**Response (202 Accepted):**

```json
{
  "message": "Infrastructure destruction started",
  "deployment_id": "tf-deploy-abc123",
  "status": "destroying",
  "estimated_duration_seconds": 120
}
```

**Error Response:**

```json
// 409 Conflict - Applications still running
{
  "error": "Cannot destroy server with running applications",
  "running_applications": [
    {"id": 123, "name": "api-backend"},
    {"id": 124, "name": "web-frontend"}
  ],
  "message": "Stop all applications or use 'force: true' to destroy anyway"
}
```

---

## Webhooks

Subscribe to infrastructure provisioning events.

**Configure Webhook:**

1. **Organization Settings** → **Webhooks** → **Create Webhook**
2. URL: `https://your-app.com/webhooks/infrastructure`
3. Events: `infrastructure.provisioning.*`
4. Secret: Auto-generated HMAC secret for validation

**Webhook Payload:**

```json
{
  "event": "infrastructure.provisioning.completed",
  "timestamp": "2024-01-15T14:35:12Z",
  "organization_id": 42,
  "data": {
    "deployment_id": "tf-deploy-abc123",
    "server_id": 789,
    "server_ip": "3.85.142.67",
    "server_name": "production-api-1",
    "cloud_provider": "digitalocean",
    "region": "nyc3",
    "total_duration_seconds": 287
  }
}
```

**Event Types:**
- `infrastructure.provisioning.started`
- `infrastructure.provisioning.completed`
- `infrastructure.provisioning.failed`
- `infrastructure.destroying.started`
- `infrastructure.destroying.completed`

**Webhook Signature Verification:**

```python
import hmac
import hashlib

def verify_webhook(request):
    signature = request.headers.get('X-Coolify-Signature')
    secret = 'YOUR_WEBHOOK_SECRET'

    expected_signature = hmac.new(
        secret.encode(),
        request.body,
        hashlib.sha256
    ).hexdigest()

    return hmac.compare_digest(signature, expected_signature)
```

---

## Rate Limits

API rate limits are enforced per organization tier:

| Tier | Provisioning API | Status Checks | Credential Management |
|------|-----------------|---------------|----------------------|
| Free | 5 per day | 100 per hour | 10 per hour |
| Starter | 20 per day | 500 per hour | 50 per hour |
| Enterprise | 100 per day | 2000 per hour | 200 per hour |

**Rate Limit Headers:**

```http
X-RateLimit-Limit: 20
X-RateLimit-Remaining: 12
X-RateLimit-Reset: 1642262400
```

---

## Error Codes

| HTTP Status | Error Code | Description |
|-------------|-----------|-------------|
| 400 | `invalid_request` | Malformed JSON or missing required fields |
| 401 | `unauthorized` | Invalid or missing API token |
| 403 | `quota_exceeded` | Organization infrastructure quota limit reached |
| 404 | `not_found` | Deployment ID not found |
| 409 | `conflict` | Cannot destroy server with running applications |
| 422 | `validation_error` | Invalid configuration (e.g., unsupported region) |
| 429 | `rate_limit_exceeded` | API rate limit reached |
| 500 | `internal_error` | Terraform execution failed (check logs) |

---

## Example: CI/CD Integration

**GitHub Actions Workflow:**

```yaml
name: Provision Staging Infrastructure

on:
  push:
    branches: [main]

jobs:
  provision:
    runs-on: ubuntu-latest
    steps:
      - name: Provision staging server
        run: |
          RESPONSE=$(curl -X POST https://coolify.example.com/api/v1/infrastructure/provision \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "cloud_provider_credential_id": 42,
              "provider": "digitalocean",
              "region": "nyc3",
              "instance_type": "s-2vcpu-4gb",
              "server_name": "staging-${{ github.sha }}"
            }')

          DEPLOYMENT_ID=$(echo $RESPONSE | jq -r '.deployment_id')
          echo "DEPLOYMENT_ID=$DEPLOYMENT_ID" >> $GITHUB_ENV

      - name: Wait for provisioning
        run: |
          while true; do
            STATUS=$(curl -s https://coolify.example.com/api/v1/infrastructure/deployments/${{ env.DEPLOYMENT_ID }} \
              -H "Authorization: Bearer ${{ secrets.COOLIFY_API_TOKEN }}" \
              | jq -r '.status')

            if [ "$STATUS" = "completed" ]; then
              echo "Provisioning completed!"
              break
            elif [ "$STATUS" = "failed" ]; then
              echo "Provisioning failed!"
              exit 1
            fi

            echo "Status: $STATUS, waiting 30 seconds..."
            sleep 30
          done

      - name: Deploy application
        run: |
          SERVER_IP=$(curl -s https://coolify.example.com/api/v1/infrastructure/deployments/${{ env.DEPLOYMENT_ID }} \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_API_TOKEN }}" \
            | jq -r '.server_ip')

          # Deploy your application to $SERVER_IP
```

---

## Related Documentation

- [Authentication Guide](./authentication.md)
- [Webhook Integration](./webhook-integration.md)
- [Error Handling Best Practices](../troubleshooting/api-errors.md)
```

---

## Implementation Approach

### Step 1: Gather Content Requirements (2 hours)
1. Review completed tasks 12-21 (Terraform implementation)
2. Interview engineering team about common user issues
3. Collect screenshots of provisioning UI workflows
4. Identify frequently asked questions from support tickets

### Step 2: Create Documentation Structure (1 hour)
1. Set up directory structure in `.claude/docs/features/infrastructure-provisioning/`
2. Create placeholder files for all documentation sections
3. Set up navigation and cross-references
4. Configure documentation build system (if using generators like VuePress)

### Step 3: Write Core Documentation (20 hours)
1. **Getting Started Guide** (3 hours)
   - First-time provisioning walkthrough
   - Screenshots with annotations
   - Common pitfalls and warnings

2. **Cloud Provider Setup** (5 hours)
   - AWS: IAM policies, credential setup, regions (2 hours)
   - DigitalOcean: API token generation, SSH keys (1.5 hours)
   - Hetzner: Cloud API setup, project configuration (1.5 hours)

3. **Provisioning Workflows** (4 hours)
   - Single-server provisioning with UI walkthrough
   - Multi-server deployment strategies
   - Terraform template customization examples

4. **Troubleshooting Guide** (4 hours)
   - Collect 20+ common errors from logs
   - Write solutions with step-by-step fixes
   - Create diagnostic decision trees

5. **Security Best Practices** (2 hours)
   - Credential rotation procedures
   - Least-privilege IAM policies
   - Network security configurations

6. **API Reference** (2 hours)
   - Document all provisioning endpoints
   - Provide cURL and code examples
   - Webhook integration guide

### Step 4: Create Visual Assets (3 hours)
1. Take screenshots of each UI workflow step
2. Annotate screenshots with callouts (Figma/Excalidraw)
3. Create architecture diagrams for auto-registration
4. Create flowcharts for troubleshooting decision trees

### Step 5: Technical Review (2 hours)
1. Infrastructure team reviews for technical accuracy
2. Test all code examples and cURL commands
3. Verify API endpoint documentation matches implementation
4. Validate Terraform template examples

### Step 6: User Testing (2 hours)
1. Have 3-5 non-DevOps users follow documentation
2. Observe pain points and unclear sections
3. Collect feedback on missing information
4. Identify areas needing more detail

### Step 7: Revisions and Polish (2 hours)
1. Incorporate feedback from technical review
2. Clarify sections identified in user testing
3. Add missing examples and edge cases
4. Proofread for grammar and consistency

### Step 8: Publication and Integration (1 hour)
1. Publish documentation to Coolify docs site
2. Add in-app links to relevant documentation sections
3. Update README and main docs navigation
4. Announce new documentation in release notes

## Test Strategy

### Documentation Quality Tests

**Manual Review Checklist:**

- [ ] All code examples tested and verified working
- [ ] All cURL commands tested against live API
- [ ] Screenshots match current UI (no outdated images)
- [ ] Cross-references link to correct pages
- [ ] No broken internal or external links
- [ ] Consistent formatting (headings, code blocks, lists)
- [ ] No typos or grammatical errors
- [ ] API endpoint documentation matches OpenAPI spec

**Automated Tests:**

**File:** `tests/Feature/Documentation/InfrastructureDocsTest.php`

```php
<?php

use Illuminate\Support\Facades\File;

it('verifies infrastructure documentation files exist', function () {
    $requiredFiles = [
        '.claude/docs/features/infrastructure-provisioning/README.md',
        '.claude/docs/features/infrastructure-provisioning/getting-started.md',
        '.claude/docs/features/infrastructure-provisioning/cloud-providers/aws-setup.md',
        '.claude/docs/features/infrastructure-provisioning/cloud-providers/digitalocean-setup.md',
        '.claude/docs/features/infrastructure-provisioning/cloud-providers/hetzner-setup.md',
        '.claude/docs/features/infrastructure-provisioning/troubleshooting/common-errors.md',
        '.claude/docs/features/infrastructure-provisioning/api-reference/provisioning-endpoints.md',
    ];

    foreach ($requiredFiles as $file) {
        expect(File::exists(base_path($file)))->toBeTrue("Missing documentation file: {$file}");
    }
});

it('verifies all API endpoints are documented', function () {
    $apiRoutes = [
        'POST /api/v1/infrastructure/provision',
        'GET /api/v1/infrastructure/deployments/{id}',
        'DELETE /api/v1/infrastructure/deployments/{id}',
        'GET /api/v1/cloud-providers',
    ];

    $apiDocsContent = File::get(base_path('.claude/docs/features/infrastructure-provisioning/api-reference/provisioning-endpoints.md'));

    foreach ($apiRoutes as $route) {
        expect($apiDocsContent)->toContain($route, "API endpoint not documented: {$route}");
    }
});

it('verifies code examples are valid JSON', function () {
    $docsDir = base_path('.claude/docs/features/infrastructure-provisioning');
    $files = File::allFiles($docsDir);

    foreach ($files as $file) {
        $content = $file->getContents();

        // Extract JSON code blocks
        preg_match_all('/```json\n(.*?)\n```/s', $content, $matches);

        foreach ($matches[1] as $jsonBlock) {
            $decoded = json_decode($jsonBlock, true);
            expect($decoded)->not->toBeNull("Invalid JSON in {$file->getRelativePathname()}");
        }
    }
});

it('verifies no broken internal links', function () {
    $docsDir = base_path('.claude/docs/features/infrastructure-provisioning');
    $files = File::allFiles($docsDir);

    foreach ($files as $file) {
        $content = $file->getContents();

        // Extract markdown links
        preg_match_all('/\[.*?\]\((\.\.\/.*?)\)/', $content, $matches);

        foreach ($matches[1] as $link) {
            $absolutePath = $file->getPath() . '/' . $link;
            $resolvedPath = realpath($absolutePath);

            expect($resolvedPath)->not->toBeFalse("Broken link in {$file->getRelativePathname()}: {$link}");
        }
    }
});

it('verifies all screenshots referenced exist', function () {
    $docsDir = base_path('.claude/docs/features/infrastructure-provisioning');
    $files = File::allFiles($docsDir);

    foreach ($files as $file) {
        $content = $file->getContents();

        // Find screenshot references: **Screenshot:** [Description]
        preg_match_all('/\*\*Screenshot:\*\* \[(.*?)\]/', $content, $matches);

        if (!empty($matches[1])) {
            // At least one screenshot should be referenced
            expect(count($matches[1]))->toBeGreaterThan(0);
        }
    }
});
```

### User Acceptance Testing

**Test Plan:**

1. **Recruit 5 test users:**
   - 2 with DevOps experience
   - 3 without DevOps experience (developers, product managers)

2. **Provide tasks:**
   - Task 1: Set up AWS credentials following documentation
   - Task 2: Provision a DigitalOcean droplet
   - Task 3: Troubleshoot a simulated "credential invalid" error
   - Task 4: Use API to provision infrastructure via cURL

3. **Observe and record:**
   - Time to complete each task
   - Number of times they reference documentation
   - Questions asked or confusion points
   - Errors encountered

4. **Success criteria:**
   - 80%+ task completion rate without support
   - Average task time < 15 minutes
   - User satisfaction rating: 4/5 or higher

## Definition of Done

- [ ] Documentation directory structure created in `.claude/docs/features/infrastructure-provisioning/`
- [ ] Getting started guide written with complete first-time provisioning walkthrough
- [ ] Cloud provider setup guides written for AWS, DigitalOcean, and Hetzner
- [ ] IAM policy examples provided for each cloud provider
- [ ] Provisioning workflow documentation completed with screenshots
- [ ] Terraform template customization guide written with 5+ examples
- [ ] Server auto-registration process documented with architecture diagrams
- [ ] State management documentation covers backup, recovery, migration
- [ ] Troubleshooting guide includes 15+ common errors with solutions
- [ ] Security best practices section written (credential rotation, network security)
- [ ] Multi-cloud cost comparison table created
- [ ] API reference documentation complete for all provisioning endpoints
- [ ] API examples tested and verified (cURL, Python, JavaScript)
- [ ] Webhook integration guide written with signature verification examples
- [ ] Administrator guide covers organization policies, quotas, audit logging
- [ ] All screenshots captured and annotated
- [ ] Architecture diagrams created for auto-registration and state management
- [ ] Automated documentation tests written and passing
- [ ] Technical review completed by infrastructure team
- [ ] User acceptance testing completed with 5 users
- [ ] Feedback incorporated and revisions made
- [ ] No broken links or missing cross-references
- [ ] All code examples tested and working
- [ ] Documentation published to Coolify docs site
- [ ] In-app links added to relevant UI sections
- [ ] Main documentation navigation updated
- [ ] Release notes mention new documentation

## Related Tasks

- **Depends on:** Task 21 (CloudProviderCredentials.vue and DeploymentMonitoring.vue components)
- **Integrates with:** Task 14 (TerraformService implementation details)
- **Integrates with:** Task 18 (TerraformDeploymentJob workflow)
- **Integrates with:** Task 19 (Server auto-registration process)
- **References:** Task 82 (White-label documentation for branding context)
- **References:** Task 85 (Administrator guide for license and organization management)

## Notes

**Documentation Maintenance:**

Infrastructure provisioning documentation must be updated when:
- New cloud providers are added (e.g., Linode, Vultr)
- Terraform templates are modified
- API endpoints change or new endpoints are added
- Common errors change (new cloud provider error messages)
- UI workflows are redesigned

**Suggested Update Schedule:**
- Minor updates: Monthly (new errors, clarifications)
- Major updates: With each feature release
- Screenshot refresh: Quarterly or when UI changes significantly

**Community Contributions:**

Consider opening documentation to community contributions:
- Users can suggest error solutions they discovered
- Cloud provider experts can contribute provider-specific tips
- Community can translate documentation to other languages
